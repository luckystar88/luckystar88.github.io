<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="springcloud系列16——Hystrix Health Indicator及Metrics Stream"><meta name="keywords" content="springcloud"><meta name="author" content="Donny"><meta name="copyright" content="Donny"><title>springcloud系列16——Hystrix Health Indicator及Metrics Stream | Donny的技术博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cd5c94069361da06af29cd21555dc451";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112010940-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#传播安全上下文或使用Spring-Scopes"><span class="toc-number">1.</span> <span class="toc-text">传播安全上下文或使用Spring Scopes</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#健康指标"><span class="toc-number">2.</span> <span class="toc-text">健康指标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix监控"><span class="toc-number">3.</span> <span class="toc-text">Hystrix监控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hystrix-Dashboard"><span class="toc-number">4.</span> <span class="toc-text">Hystrix Dashboard</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">Donny</div><div class="author-info__description text-center">记录工作，感悟生活</div><div class="follow-button"><a href="https://gitee.com/tommy88">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">274</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">51</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">4</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Donny的技术博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">springcloud系列16——Hystrix Health Indicator及Metrics Stream</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-06-25</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/tech/">技术</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="传播安全上下文或使用Spring-Scopes"><a href="#传播安全上下文或使用Spring-Scopes" class="headerlink" title="传播安全上下文或使用Spring Scopes"></a>传播安全上下文或使用Spring Scopes</h2><p>参考springcloud官方文档：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_propagating_the_security_context_or_using_spring_scopes">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_propagating_the_security_context_or_using_spring_scopes</a>。</p>
<p>springcloud原文：</p>
<blockquote>
<p>If you want some thread local context to propagate into a @HystrixCommand the default declaration will not work because it executes the command in a thread pool (in case of timeouts). You can switch Hystrix to use the same thread as the caller using some configuration, or directly in the annotation, by asking it to use a different “Isolation Strategy”. </p>
</blockquote>
<p>翻译：</p>
<blockquote>
<p>如果你想要一些线程本地上下文传播到@HystrixCommand，默认声明将不起作用，因为它在线程池中执行命令（在超时的情况下）。 您可以使用某种配置将Hystrix切换为与调用方使用相同的线程，或者直接在注释中请求它使用不同的“隔离策略”。<br><a id="more"></a><br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"stubMyService"</span>,</span><br><span class="line">    commandProperties = &#123;</span><br><span class="line">      <span class="meta">@HystrixProperty</span>(name=<span class="string">"execution.isolation.strategy"</span>, value=<span class="string">"SEMAPHORE"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>springcloud原文：</p>
<blockquote>
<p>The same thing applies if you are using @SessionScope or @RequestScope. You will know when you need to do this because of a runtime exception that says it can’t find the scoped context.  </p>
</blockquote>
<blockquote>
<p>You also have the option to set the hystrix.shareSecurityContext property to true. Doing so will auto configure an Hystrix concurrency strategy plugin hook who will transfer the SecurityContext from your main thread to the one used by the Hystrix command. Hystrix does not allow multiple hystrix concurrency strategy to be registered so an extension mechanism is available by declaring your own HystrixConcurrencyStrategy as a Spring bean. Spring Cloud will lookup for your implementation within the Spring context and wrap it inside its own plugin.</p>
</blockquote>
<p>翻译：</p>
<blockquote>
<p>如果使用@SessionScope或@RequestScope，则同样适用。 你需要知道，只有在产生一个运行时异常，并且它告诉你无法找到范围内的上下文时，你才应该这样做。</p>
</blockquote>
<blockquote>
<p>您也可以选择将hystrix.shareSecurityContext属性设置为true。 这样做会自动配置一个Hystrix并发策略插件钩子，他可以将SecurityContext从主线程传输到Hystrix命令使用的钩子。 Hystrix不允许注册多个hystrix并发策略，因此通过将自己的HystrixConcurrencyStrategy声明为Spring bean，可以使用扩展机制。 Spring Cloud将在Spring上下文中查找您的实现，并将其包装在自己的插件中。</p>
</blockquote>
<h2 id="健康指标"><a href="#健康指标" class="headerlink" title="健康指标"></a>健康指标</h2><p>spring-boot的actuator提供了/health端点来查看Hystrix状态。使用也很简单，在pom.xml增加依赖即可：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>因为在公网环境，有些敏感数据不适合直接查看。所以，默认情况下，访问类似<a href="http://localhost:8081/metrics">http://localhost:8081/metrics</a>会看到下面的错误：<br><img src="https://images2015.cnblogs.com/blog/27612/201704/27612-20170415132808330-923470429.png" alt></p>
<p>所以，建议对这些查看敏感数据的使用跟应用不同的端口。<br>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  security:</span><br><span class="line">    enabled: false # 关闭安全检查</span><br><span class="line">  port: 1101 # 管理端口</span><br><span class="line">  context-path: /admin # 管理上线文路径</span><br></pre></td></tr></table></figure></p>
<p>如果在公网环境，建议在防火墙上做下限制，仅允许8081进来，1101用于内网访问即可，这样相对比较安全，也不用繁琐的输入密码。</p>
<p>在应用启动时的控制台日志，我们可以看到，spring-boot-acturator提供了非常多的指标。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/44126544.jpg" alt></p>
<p>springboot-acturator的相关内容参考：<a href="http://www.cnblogs.com/yjmyzz/p/spring-boot-actuator-tutorial.html">http://www.cnblogs.com/yjmyzz/p/spring-boot-actuator-tutorial.html</a>。</p>
<p>配置了springboot-actuator后，我们可以通过/health来查看Hystrix的健康状态。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/3818400.jpg" alt></p>
<p>这个表示hystrix的断路器未打开。</p>
<p>我们将user服务关闭，然后疯狂刷新/user/1多次（20次）以上，再次访问/admin/health。</p>
<p>会看到：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/87582324.jpg" alt><br>可以看到，hystrix的状态是CIRCUIT_OPEN，标识断路器打开了。</p>
<h2 id="Hystrix监控"><a href="#Hystrix监控" class="headerlink" title="Hystrix监控"></a>Hystrix监控</h2><p>/health端点只能看到断路器的整体状态，但对细节展示不详细。从上面我们会看到一个/hystrix.stream的端点，访问该端点可以看到详细的数据。页面会一直持续刷新，可以看到最新数据。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/6115834.jpg" alt></p>
<h2 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h2><p>通过/hystrix.stream可以实时看到最新的监控数据，但密密麻麻的文字，看起来不太方便。spring cloud提供了一个hystrix-dashboard的功能，可以以图形化界面展示这些数据。</p>
<p>使用步骤如下：<br>a.添加spring-cloud-starter-hystrix-dashboard的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>b.在启动类上增加<code>@EnableHystrixDashboard</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieHystrixApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(MovieHystrixApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>c.重新启动movie-hystrix模块<br>d.浏览器输入movie-hystrix应用端口/hystrix，可以看到下面的页面<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/92464637.jpg" alt></p>
<p>输入下面的信息：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/44749494.jpg" alt><br>其实就是制定/hystrix.stream的地址，刷新的间隔。</p>
<p>然后就可以看到下面的界面：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/49130183.jpg" alt><br>可以看到，此时断路器开关是关闭的。</p>
<p>我们停止user模块的服务，并且狂刷页面一会儿。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/68194655.jpg" alt><br>可以看到，此时断路器打开了。</p>
<p>这显然比纯文字友好多了。还有一个问题，如果有多个hystrix.stream地址同时监控，或者把多个地址的数据汇总起来，该怎么弄？github上有一个turbine ,就是专门为解决这个问题的，大家可以自行研究下。</p>
<p>参考：<a href="https://www.cnblogs.com/yjmyzz/p/spring-cloud-hystrix-tutorial.html">https://www.cnblogs.com/yjmyzz/p/spring-cloud-hystrix-tutorial.html</a>。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Donny</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://tommy88.top/2018/06/25/springcloud系列16——Hystrix Health Indicator及Metrics Stream/">https://tommy88.top/2018/06/25/springcloud系列16——Hystrix Health Indicator及Metrics Stream/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/springcloud/">springcloud</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechatpay.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/06/25/springcloud官方文档中文翻译版/"><i class="fa fa-chevron-left">  </i><span>springcloud官方文档中文翻译版</span></a></div><div class="next-post pull-right"><a href="/2018/06/25/springcloud系列15——hystrix简介及简单代码示例/"><span>springcloud系列15——hystrix简介及简单代码示例</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitment-container"></div><script>var gitment = new Gitment({
  id: md5(decodeURI(location.pathname)),
  owner: 'luckystar88',
  repo: 'comments',
  oauth: {
    client_id: 'd49ebe4f95abcd6163f4',
    client_secret: 'edd2748d6271072a6970d5cec8751f388dac8116'
  }
})
gitment.render('gitment-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/top_img.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Donny</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>