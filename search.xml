<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Kettle8.2循环</title>
      <link href="/2019/09/29/Kettle8.2%E5%BE%AA%E7%8E%AF/"/>
      <url>/2019/09/29/Kettle8.2%E5%BE%AA%E7%8E%AF/</url>
      
        <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>现有多个订单子表，希望将数据抽取到历史表。</p><p>表结构如下：</p><p><img src="/img/1569747947596.png" alt="1569747947596"></p><p>这里有2个子表（t_order_0和t_order_1），数据分别如下</p><p>t_order_0数据：</p><p><img src="/img/1569747980188.png" alt="1569747980188"></p><p>t_order_1数据：</p><p><img src="/img/1569748112924.png" alt="1569748112924"></p><p>备份表为t_order_history。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>实现步骤如下：获取所有订单子表–&gt;循环每个子表–&gt;查询订单数据–&gt;导入备份表。</p><p>作业结构如图：</p><p><img src="/img/1569748217589.png" alt="1569748217589"></p><h3 id="获取表数量"><a href="#获取表数量" class="headerlink" title="获取表数量"></a>获取表数量</h3><p><img src="/img/1569748252932.png" alt="1569748252932"></p><p><img src="/img/1569748273350.png" alt="1569748273350"></p><p>这里使用模拟匹配查询所有订单子表，因为备份表也会查出来，所以使用“过滤纪录”进行过滤。</p><p><img src="/img/1569748335645.png" alt="1569748335645"></p><p><img src="/img/1569748351845.png" alt="1569748351845"></p><h3 id="执行表数量判断并设置变量"><a href="#执行表数量判断并设置变量" class="headerlink" title="执行表数量判断并设置变量"></a>执行表数量判断并设置变量</h3><p><img src="/img/1569748398532.png" alt="1569748398532"></p><p>下一步通过“检验字段值”和箭头指向来实现循环</p><h3 id="循环控制器"><a href="#循环控制器" class="headerlink" title="循环控制器"></a>循环控制器</h3><p><img src="/img/1569748498053.png" alt="1569748498053"></p><p>通过“检验字段的值”+箭头指向实现循环。</p><p><img src="/img/1569748529444.png" alt="1569748529444"></p><h3 id="抽取数据"><a href="#抽取数据" class="headerlink" title="抽取数据"></a>抽取数据</h3><p><img src="/img/1569748547020.png" alt="1569748547020"></p><p><img src="/img/1569748564328.png" alt="1569748564328"></p><p><img src="/img/1569748576752.png" alt="1569748576752"></p><h3 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h3><p><img src="/img/1569748596311.png" alt="1569748596311"></p><p>PRINT_TABLES这个转换可以不要，这里是打印表名。</p><h3 id="PRINT-TABLES"><a href="#PRINT-TABLES" class="headerlink" title="PRINT_TABLES"></a>PRINT_TABLES</h3><p><img src="/img/1569748640360.png" alt="1569748640360"></p><p><img src="/img/1569748654838.png" alt="1569748654838"></p><p>执行一下作业，发现数据已经抽取到备份表了。</p><p><img src="/img/1569749299862.png" alt="1569749299862"></p><p>参考：<a href="https://blog.csdn.net/qq_41704358/article/details/79519133">https://blog.csdn.net/qq_41704358/article/details/79519133</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kettle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>自定义线程池拆分任务列表</title>
      <link href="/2019/08/19/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%8B%86%E5%88%86%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8/"/>
      <url>/2019/08/19/%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BA%BF%E7%A8%8B%E6%B1%A0%E6%8B%86%E5%88%86%E4%BB%BB%E5%8A%A1%E5%88%97%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>为了减少网络开销，会将数据打包（一个大的List）发送到接收方处理。如果直接使用ThreadPoolExecutor则只会有一个线程处理整个任务List，会导致耗时很久。所以需要将任务进行分割，然后分配给多个线程处理。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>这里通过继承ThreadPoolExecutor，来实现任务的拆分，并且一个线程池提供了1个任务分发线程和一个线程池空闲检测线程。任务分发线程会从阻塞队列获取任务，然后进行拆分，分配给线程池执行，在线程池忙时会阻塞。空闲线程池检测线程会在线程池有空闲线程时通知任务分发线程分发任务。</p><p>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataProcessThreadPoolManager</span> <span class="keyword">extends</span> <span class="title">ThreadPoolExecutor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingQueue&lt;Runnable&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition notFull = lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> splitSize = <span class="number">100</span>; <span class="comment">// list多少个元素拆分为一组</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> workQueueCapacity = <span class="number">0</span>; <span class="comment">// 线程池工作队列的容量</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataProcessThreadPoolManager</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, BlockingQueue&lt;Runnable&gt; queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue);</span><br><span class="line">        workQueueCapacity = workQueue.remainingCapacity();</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataProcessThreadPoolManager</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, BlockingQueue&lt;Runnable&gt; queue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory);</span><br><span class="line">        workQueueCapacity = workQueue.remainingCapacity();</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataProcessThreadPoolManager</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, RejectedExecutionHandler handler,<span class="keyword">int</span> splitSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, handler);</span><br><span class="line">        workQueueCapacity = workQueue.remainingCapacity();</span><br><span class="line">        <span class="keyword">this</span>.splitSize = splitSize;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataProcessThreadPoolManager</span><span class="params">(<span class="keyword">int</span> corePoolSize, <span class="keyword">int</span> maximumPoolSize, <span class="keyword">long</span> keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler);</span><br><span class="line">        workQueueCapacity = workQueue.remainingCapacity();</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 任务分发线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    allocateTask();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"任务分发线程异常"</span>,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 线程池空闲线程检测</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.lockInterruptibly();</span><br><span class="line">                    <span class="keyword">if</span> (getQueue().size() &lt; workQueueCapacity)</span><br><span class="line">                        notFull.signal();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    log.error(<span class="string">"线程池空闲线程检测线程异常"</span>,e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    lock.unlock();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addTask</span><span class="params">(List&lt;T&gt; list, Consumer&lt;List&lt;T&gt;&gt; consumer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtil.isNotEmpty(list) &amp;&amp; list.size() &gt; splitSize) &#123;</span><br><span class="line">                <span class="comment">// 拆分List</span></span><br><span class="line">                splitData(list,consumer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                Runnable task = () -&gt; consumer.accept(list); <span class="comment">// 将list包装成Runnable，后续给线程池执行</span></span><br><span class="line">                queue.put(task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.error(<span class="string">"添加任务到线程池异常"</span>,e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">allocateTask</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        lock.lockInterruptibly();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (getQueue().size() == workQueueCapacity) <span class="comment">// 线程池工作队列已满 暂停加入任务到队列</span></span><br><span class="line">                notFull.await();</span><br><span class="line"></span><br><span class="line">            Runnable task = queue.take();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != task)</span><br><span class="line">                execute(task);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任务分解 将一个大的List拆分为多个小List</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> consumer</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">splitData</span><span class="params">(List list, Consumer consumer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> size = list.size();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> totalPages = size / splitSize;</span><br><span class="line">        <span class="keyword">if</span> (totalPages * splitSize &lt; size)</span><br><span class="line">            totalPages += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=totalPages;i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> end = i*splitSize;</span><br><span class="line">            <span class="keyword">if</span> (end &gt; size) end = size;</span><br><span class="line">            addTask(list.subList(start,end),consumer);</span><br><span class="line">            start = end;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例化自定义线程池</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> DataProcessThreadPoolManager BASE_DATA_THREAD_POOL = <span class="keyword">new</span> DataProcessThreadPoolManager(<span class="number">100</span>, <span class="number">100</span>, <span class="number">60</span>, TimeUnit.SECONDS,</span><br><span class="line"><span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(<span class="number">100</span>), <span class="keyword">new</span> ThreadPoolExecutor.DiscardPolicy(),<span class="number">100</span>);</span><br><span class="line"><span class="comment">// 通过addTask方法添加待执行的任务List（这里不是Runnable，是你实际要处理的数据类型）</span></span><br><span class="line">BASE_DATA_THREAD_POOL.addTask(tournamentBaseData.getData(),list -&gt; tournamentService.handle(list));</span><br></pre></td></tr></table></figure><p>上面的自定义线程池实现了下面几个功能：</p><p>1.任务列表拆分，将一个大的List拆分为多个小的List，每个线程执行拆分后的小的List。</p><p>2.在线程池忙时会进行阻塞，不会导致线程池执行拒绝策略，导致任务不执行。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot使用logback记录日志到kafka</title>
      <link href="/2019/07/25/springboot%E4%BD%BF%E7%94%A8Logback%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%E5%88%B0kafka/"/>
      <url>/2019/07/25/springboot%E4%BD%BF%E7%94%A8Logback%E8%AE%B0%E5%BD%95%E6%97%A5%E5%BF%97%E5%88%B0kafka/</url>
      
        <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>本文是ELK整合的一部分。流程为：应用程序日志–&gt;kafka–&gt;logstash–&gt;es–&gt;kibana。</p><p>这里使用springboot+logback将日志写入到kafka。</p><h2 id="使用logback记录日志到kafka"><a href="#使用logback记录日志到kafka" class="headerlink" title="使用logback记录日志到kafka"></a>使用logback记录日志到kafka</h2><p>由于springboot自带有logback的依赖，所以我们准备一个logback-spring.xml的配置文件即可，application.yml也无需任何配置。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>  <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"60 seconds"</span> <span class="attr">debug</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>springboot-demo<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义日志文件的存储地址,勿在 LogBack 的配置中使用相对路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"LOG_PATH"</span> <span class="attr">value</span>=<span class="string">"d:/logs/"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--输出到控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 滚动日志 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"ROLLING_FILE"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志文件输出的文件名 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>$&#123;LOG_PATH&#125;/springboot-demo.%d.%i.log</span><br><span class="line">            <span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">MaxHistory</span>&gt;</span>100<span class="tag">&lt;/<span class="name">MaxHistory</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">TimeBasedFileNamingAndTriggeringPolicy</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">MaxFileSize</span>&gt;</span>50MB<span class="tag">&lt;/<span class="name">MaxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">TimeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125;-%msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- This is the kafkaAppender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"kafkaAppender"</span> <span class="attr">class</span>=<span class="string">"com.github.danielwegener.logback.kafka.KafkaAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.encoder.PatternLayoutEncoder"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;36&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">topic</span>&gt;</span>app-log<span class="tag">&lt;/<span class="name">topic</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- we don't care how the log messages will be partitioned  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">keyingStrategy</span> <span class="attr">class</span>=<span class="string">"com.github.danielwegener.logback.kafka.keying.NoKeyKeyingStrategy"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- use async delivery. the application threads are not blocked by logging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">deliveryStrategy</span> <span class="attr">class</span>=<span class="string">"com.github.danielwegener.logback.kafka.delivery.AsynchronousDeliveryStrategy"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- each &lt;producerConfig&gt; translates to regular kafka-client config (format: key=value) --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- producer configs are documented here: https://kafka.apache.org/documentation.html#newproducerconfigs --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- bootstrap.servers is the only mandatory producerConfig --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">producerConfig</span>&gt;</span>bootstrap.servers=192.168.193.100:9092<span class="tag">&lt;/<span class="name">producerConfig</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- don't wait for a broker to ack the reception of a batch.  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">producerConfig</span>&gt;</span>acks=0<span class="tag">&lt;/<span class="name">producerConfig</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- wait up to 1000ms and collect log messages before sending them as a batch --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">producerConfig</span>&gt;</span>linger.ms=1000<span class="tag">&lt;/<span class="name">producerConfig</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- even if the producer buffer runs full, do not block the application but start to drop messages --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">producerConfig</span>&gt;</span>max.block.ms=0<span class="tag">&lt;/<span class="name">producerConfig</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- define a client-id that you use to identify yourself against the kafka broker --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">producerConfig</span>&gt;</span>client.id=$&#123;HOSTNAME&#125;-$&#123;CONTEXT_NAME&#125;-logback-relaxed<span class="tag">&lt;/<span class="name">producerConfig</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志输出级别 ERROR,WARN,INFO,DEBUG --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"INFO"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"ROLLING_FILE"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"kafkaAppender"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里主要关注kafkaAppender这一部分，这里使用了<code>logback-kafka-appender</code>这个依赖。</p><p>maven依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.kafka/spring-kafka --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.kafka<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-kafka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--logback-kafka-appender依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.danielwegener<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-kafka-appender<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.0-RC2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>kafka的配置（application.properties)：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#============== kafka ===================</span><br><span class="line"># 指定kafka 代理地址，可以多个</span><br><span class="line">spring.kafka.bootstrap-servers=192.168.193.100:9092</span><br><span class="line"></span><br><span class="line">#=============== provider  =======================</span><br><span class="line"></span><br><span class="line">spring.kafka.producer.retries=0</span><br><span class="line"># 每次批量发送消息的数量</span><br><span class="line">spring.kafka.producer.batch-size=16384</span><br><span class="line">spring.kafka.producer.buffer-memory=33554432</span><br><span class="line"></span><br><span class="line"># 指定消息key和消息体的编解码方式</span><br><span class="line">spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line">spring.kafka.producer.value-serializer=org.apache.kafka.common.serialization.StringSerializer</span><br><span class="line"></span><br><span class="line">#=============== consumer  =======================</span><br><span class="line"># 指定默认消费者group id</span><br><span class="line">spring.kafka.consumer.group-id=test-consumer-group</span><br><span class="line"></span><br><span class="line">spring.kafka.consumer.auto-offset-reset=earliest</span><br><span class="line">spring.kafka.consumer.enable-auto-commit=true</span><br><span class="line">spring.kafka.consumer.auto-commit-interval=100</span><br><span class="line"></span><br><span class="line"># 指定消息key和消息体的编解码方式</span><br><span class="line">spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer</span><br><span class="line">spring.kafka.consumer.value-deserializer=org.apache.kafka.common.serialization.StringDeserializer</span><br></pre></td></tr></table></figure><p>记录10条日志，看是否发送到了kafka</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过logback appender来讲日志发送到kafka</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendKafkaLogByLogbackAppender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Gson gson = <span class="keyword">new</span> GsonBuilder().create();</span><br><span class="line">    IntStream.rangeClosed(<span class="number">1</span>,<span class="number">10</span>).forEach(i-&gt;&#123;</span><br><span class="line">        Message message = <span class="keyword">new</span> Message();</span><br><span class="line">        message.setId(System.currentTimeMillis());</span><br><span class="line">        String name = Math.random() &lt; <span class="number">0.5</span> ? <span class="string">"zhangsan "</span>+i:<span class="string">"李四 "</span>+i;</span><br><span class="line">        User user = User.builder().id(i).name(name).birthday(<span class="keyword">new</span> Date()).build();</span><br><span class="line">        message.setMsg(user);</span><br><span class="line">        message.setSendTime(<span class="keyword">new</span> Date());</span><br><span class="line">        String msg = gson.toJson(message);</span><br><span class="line">        log.info(msg);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于我们使用了kibana，所以直接在kibana查看即可（注意在logstash配置从kafka接受数据）。</p><p><img src="/img/1564020034801.png" alt="1564020034801"></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Typora图片设置</title>
      <link href="/2019/07/25/Typora%E5%9B%BE%E7%89%87%E8%AE%BE%E7%BD%AE/"/>
      <url>/2019/07/25/Typora%E5%9B%BE%E7%89%87%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>用Typora写markdown很方便，所见即所得。而且图片也可以直接粘贴即可，但默认是觉得路径，导致发布到hexo无法显示。</p><p>这里可以通过2个设置解决这个问题，保证在Typora中可以显示图片，同时发布到hexo后也可以正常显示。</p><p>1.文件-&gt;偏好设置-&gt;图片插入，复制到指定路径（这里的路径就是hexo的source下新建一个文件夹存储图片），这里是img。这样当你粘贴图片到Typora的时候会自动复制到你指定的目录，而且Typora中显示的路径也是这里指定的路径，注意勾选“优先使用相对路径”，这样显示的就是相对路径了，即<code>/img/xxx.png</code>类似这种。</p><p><img src="/img/1564023237084.png" alt="1564023237084"></p><p>2.编辑-&gt;图片工具-&gt;设置图片跟目录（这里设置到hexo的source这一层）</p><p><img src="/img/1564023410223.png" alt="1564023410223"></p><p><img src="/img/1564023504984.png" alt="1564023504984"></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Typrora </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vmware安装centos7系统</title>
      <link href="/2019/07/24/windows%E4%BD%BF%E7%94%A8wmware%E5%AE%89%E8%A3%85centos7%E7%B3%BB%E7%BB%9F/"/>
      <url>/2019/07/24/windows%E4%BD%BF%E7%94%A8wmware%E5%AE%89%E8%A3%85centos7%E7%B3%BB%E7%BB%9F/</url>
      
        <content type="html"><![CDATA[<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>我是从阿里云镜像下载的。地址：<a href="http://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/">http://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/</a></p><p><img src="/img/1563860623386.png" alt="1563860623386"></p><p>选择Minimal.iso下载最小化的安装包（900多M），完整版的有4个多G，自己学习研究使用就没必要了。</p><h2 id="安装"><a href="#安装" class="headerlink" title="## 安装"></a>## 安装</h2><p>略，新建虚拟机，选择centos7安装包即可。</p><h2 id="网络配置"><a href="#网络配置" class="headerlink" title="网络配置"></a>网络配置</h2><p>使用NAT模式，在VMware-》编辑-》虚拟网络编辑器中，选择VMnet8，可以看到子网IP和子网掩码。取消勾选“使用本地DHCP服务将IP地址分配给虚拟机”。点“NAT设置”可以看到网关IP。</p><p><img src="/img/1563853847580.png" alt="1563853847580"></p><p><img src="/img/1563853889560.png" alt="1563853889560"></p><p><strong>网卡信息修改</strong><br>vi /etc/sysconfig/network-scripts/ifcfg-ens33（有的叫ifcfg-eth0）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=f9c77ab3-bc8c-4cc5-ba91-04835e191aeb</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.193.100</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.193.2</span><br><span class="line">ZONE=public</span><br></pre></td></tr></table></figure><p>这里的IPADDR随意设置跟网关一个网段即可。<br>ONBOOT：开机启动。<br>NM_CONTROLLED：网络管理组件是否启用，精简版的是没有这个组件的。所以就不需要开启。<br>BOOTPROTO：网络分配方式，静态。<br>IPPADDR：手动指定ip地址。<br>NETMASK：子网掩码。<br>GATEWAY：网关ip。编辑好以后保存退出。</p><p><strong>DNS配置</strong><br>vi /etc/resolv.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nameserver 192.168.193.2</span><br></pre></td></tr></table></figure><p>这里填网关IP即可。</p><p><strong>windows中虚拟机网络适配器配置</strong></p><p><img src="/img/1563853566589.png" alt="1563853566589"></p><p>网关需要与上面网络编辑器中的网关一致，IP随意。</p><p>然后重启网卡</p><p><code>service network restart</code></p><p>用主机ping一下虚拟机<br>然后用虚拟机ping一下<a href="www.baidu.com">www.baidu.com</a><br>看主机–》虚拟机，虚拟机–》主机，虚拟机–》外网是否通。</p><p>如果通，用sxhell连接虚拟机即可（端口22）。</p><h2 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h2><p>centos7里面除了默认的firewall还有一个会对开放端口有影响，这个就是selinux，我把他关闭，然后firewall开放我想要的端口就行了，关闭selinux可以参考<a href="https://www.linuxidc.com/Linux/2016-11/137723.htm">https://www.linuxidc.com/Linux/2016-11/137723.htm</a>。</p><p>firewall开放端口<code>firewall-cmd --zone=public  --permanent --add-port=111/tcp</code>添加需要的端口，然后再重新加载下<code>firewall-cmd --reload</code>，最后查看下端口是否真的打开<code>firewall-cmd --list-port</code>。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos7系统搭建ELK环境</title>
      <link href="/2019/07/24/Centos7%E7%B3%BB%E7%BB%9FES%E5%AE%89%E8%A3%85/"/>
      <url>/2019/07/24/Centos7%E7%B3%BB%E7%BB%9FES%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="部署架构"><a href="#部署架构" class="headerlink" title="部署架构"></a>部署架构</h2><p>应用程序日志–&gt;kafka–&gt;logstash–&gt;es–&gt;kibana。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>Elasticsearch</strong> 需要的 <strong>Java</strong> 最低版本为 <strong>Java 8</strong>。所以第一步需要确保安装了正确版本的jdk。</p><p>我们假定elk的目录为/data/soft/elk。通过下面的命令下载es</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -L -O https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.4.0.tar.gz</span><br></pre></td></tr></table></figure><p>然后解压缩</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf elasticsearch-5.4.0.tar.gz</span><br></pre></td></tr></table></figure><p>然后使用下面的命令启动es。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/elasticsearch.sh</span><br></pre></td></tr></table></figure><p>启动正常的话，可以看到下面的日志。</p><p><img src="/img/1563861865798.png" alt="1563861865798"></p><p>然后我们通过&lt;192.168.193.100:9200&gt;可以看到下面的数据</p><p><img src="/img/1563861906696.png" alt="1563861906696"></p><p>如果想后台运行ES，加上-d参数即可。<code>./bin/elasticsearch -d</code>。</p><h2 id="安装Head插件"><a href="#安装Head插件" class="headerlink" title="安装Head插件"></a>安装Head插件</h2><p>安装head插件，需要先安装nodejs。</p><p>使用<code>node -v</code>确认已安装nodejs。如果没有安装执行<code>yum install nodejs</code>来安装。</p><p>可能遇到的问题：<strong>没有可用软件包 nodejs。</strong></p><p>解决：执行<code>yum install epel-release;</code>然后再安装nodejs。</p><p><strong>使用淘宝的npm镜像cnpm</strong></p><p>使用npm安装依赖有时会比较慢，我们可以使用淘宝的cnpm镜像。</p><p>执行下面的命令来安装：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><p>安装后，原来使用npm，现在使用cnpm即可。</p><p><strong>安装grunt</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install -g grunt-cli</span><br></pre></td></tr></table></figure><p>确认一下版本,<code>grunt --version</code>。</p><p><strong>修改HEAD监听的地址</strong></p><p>默认HEAD监听 localhost，修改Gruntfile.js，添加hostname</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">connect: &#123;</span><br><span class="line">    server: &#123;</span><br><span class="line">        options: &#123;</span><br><span class="line">            hostname: &apos;*&apos;,</span><br><span class="line">            port: 9100,</span><br><span class="line">            base: &apos;.&apos;,</span><br><span class="line">            keepalive: true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>既然是跨源访问ES，那么就要在HEAD里面指定ES服务器了，修改_site/app.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">init: function(parent) &#123;</span><br><span class="line">    this._super();</span><br><span class="line">    this.prefs = services.Preferences.instance();</span><br><span class="line">    this.base_uri = this.config.base_uri || this.prefs.get(&quot;app-base_uri&quot;) || &quot;http://192.168.193.100:9200&quot;;</span><br><span class="line">    if( this.base_uri.charAt( this.base_uri.length - 1 ) !== &quot;/&quot; ) &#123;</span><br><span class="line">        // XHR request fails if the URL is not ending with a &quot;/&quot;</span><br><span class="line">        this.base_uri += &quot;/&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>进入HEAD目录，安装HEAD依赖包，执行<code>cnpm install</code>。</p><p><strong>启动head插件</strong></p><p>使用<code>grunt server</code>来启动head插件，看到下面的内容就说明启动成功了。</p><p><img src="/img/1563931401940.png" alt="1563931401940"></p><p>head插件使用的端口是9100，记得在防火墙中添加进去。</p><p>然后我们浏览器访问<a href="http://192.168.193.100:9100/">http://192.168.193.100:9100/</a></p><p><img src="/img/1563932853421.png" alt="1563932853421"></p><p>ps:也可以通过<code>npm run start</code> 来启动，<code>npm run start &amp;</code>后台启动。</p><p><strong>停止head插件</strong></p><p>查看 9100 （head 端口）端口：<code>lsof -i:9100</code></p><p>杀死进程：<code>kill -9 pid</code></p><p><strong>es集群状态的说明</strong></p><p>green：每个索引的primary shard和replica shard都是active状态的。</p><p>yellow：每个索引的primary shard都是active状态的，但是部分replica shard不是active状态，处于不可用的状态。</p><p>red：不是所有索引的primary shard都是active状态的，部分索引有数据丢失了。</p><h2 id="安装kafka"><a href="#安装kafka" class="headerlink" title="安装kafka"></a>安装kafka</h2><p>这里使用的目前最新的版本，从<a href="http://kafka.apache.org/downloads">http://kafka.apache.org/downloads</a>下载。</p><p>解压缩，得到目录kafka_2.11-2.3.0。</p><p>修改配置文件/config/server.properties</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listeners=PLAINTEXT://192.168.193.100:9092</span><br></pre></td></tr></table></figure><p>启动kafka：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-server-start.sh ../config/server.properties</span><br></pre></td></tr></table></figure><p>后台启动kafka:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-server-start.sh ../config/server.properties 1&gt;/dev/null 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><h2 id="安装logstash"><a href="#安装logstash" class="headerlink" title="安装logstash"></a>安装logstash</h2><p>这里的logstash版本是5.4.0与es一致，从<a href="https://www.elastic.co/downloads/logstash">https://www.elastic.co/downloads/logstash</a>下载相应的版本。</p><p>然后解压缩，进入config目录。</p><p>新建一个配置文件，名字随意，这里命名为test.conf。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;192.168.193.100:9092&quot;</span><br><span class="line">    topics =&gt; [&quot;app-log&quot;]</span><br><span class="line">    group_id =&gt; &quot;test-consumer-group&quot;</span><br><span class="line">    codec =&gt; &quot;json&quot;</span><br><span class="line">    consumer_threads =&gt; 1</span><br><span class="line">    decorate_events =&gt; true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;127.0.0.1:9200&quot;]</span><br><span class="line">    index =&gt; &quot;test&quot;</span><br><span class="line">    workers =&gt; 1</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动logstash</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/logstash -f config/test.conf</span><br></pre></td></tr></table></figure><h2 id="使用程序写入100条测试数据到Kafka"><a href="#使用程序写入100条测试数据到Kafka" class="headerlink" title="使用程序写入100条测试数据到Kafka"></a>使用程序写入100条测试数据到Kafka</h2><p>注意topic要与logstash中配置的一致。</p><p>这里使用logback的appender来将日志写入kafka，logstash从kafka接受，然后发送给es。</p><p>使用的github上的一个<code>logback-kafka-appender</code>依赖。</p><h2 id="安装Kibana"><a href="#安装Kibana" class="headerlink" title="安装Kibana"></a>安装Kibana</h2><p>从<a href="https://www.elastic.co/downloads/kibana">https://www.elastic.co/downloads/kibana</a>下载kibana，kibana要与es的版本一致，所以这里也下载5.4.0版本。</p><p>然后解压缩</p><p>最后使用<code>./bin/kibana</code>启动。kibana使用的端口号为5601，记得加入防火墙。</p><p>浏览器访问<a href="http://192.168.193.100:5601/">http://192.168.193.100:5601</a></p><p><img src="/img/1563935610542.png" alt="1563935610542"></p><p>在上面的logstash配置中，我们指定了es中的索引为test。所以在Kibana的<code>Index name or pattern</code>中输入test。然后点下面的Create。</p><p>然后再左侧可以看到刚刚配置的索引</p><p><img src="/img/1563951123917.png" alt="1563951123917"></p><p>点左侧的Discover菜单，然后就将右侧的时间选择为Today，可以看到日志了</p><p><img src="/img/1563951174193.png" alt="1563951174193"></p><h3 id="kibana常用搜索"><a href="#kibana常用搜索" class="headerlink" title="kibana常用搜索"></a>kibana常用搜索</h3><p><strong>全文搜索</strong></p><p>在搜索栏输入<code>测试</code>，返回所有字段中包含”测试”的文档（document）。</p><p><strong>根据字段搜索</strong></p><p>根据kibana左侧显示的field搜索。field:value</p><p>精确搜索：field:”value”</p><p>参考：<a href="https://blog.csdn.net/zhengchaooo/article/details/79500130">https://blog.csdn.net/zhengchaooo/article/details/79500130</a></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>可能会遇到下面的问题：</p><p>1.max file descriptors [4096] for elasticsearch process is too low, increase to at least [65536]</p><p><strong>解决</strong>：修改切换到root用户修改配置limits.conf 添加下面两行</p><p><strong>命令</strong>:vi /etc/security/limits.conf</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*        hard    nofile           65536</span><br><span class="line">*        soft    nofile           65536</span><br></pre></td></tr></table></figure><p>2.max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p><p><strong>解决</strong>：切换到root用户修改配置sysctl.conf</p><p>vi /etc/sysctl.conf </p><p>添加下面配置：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.max_map_count=655360</span><br></pre></td></tr></table></figure><p>并执行命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -p</span><br></pre></td></tr></table></figure><p>3.es启动成功，虚拟机中可以访问9200，但windows中无法访问。</p><p>首先确保防火墙关闭或添加了9200端口。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --zone=public  --permanent --add-port=9200/tcp</span><br></pre></td></tr></table></figure><p>另外， 修改es配置文件elasticsearch.yml，修改network.host和http.port</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure><p>然后重启es。</p><p>4.安装head插件遇到的问题</p><p>4.1 <code>RunScriptError: post install error, please remove node_modules before retry!</code></p><p>重新执行安装命令，遇到<code>npm WARN elasticsearch-head@0.0.0 license should be a valid SPDX license expression</code>问题。</p><p>解决：参考<a href="https://www.cnblogs.com/shengulong/p/6224908.html">https://www.cnblogs.com/shengulong/p/6224908.html</a>，将package.json中的license值修改为Apache-2.0即可。</p><p>4.2 <code>_Loading &quot;Gruntfile.js&quot; tasks...ERROR</code>错误</p><p>解决：参考<a href="https://blog.csdn.net/wang_zhenwei/article/details/78389253">https://blog.csdn.net/wang_zhenwei/article/details/78389253</a></p><p>4.3 head插件启动成功后访问9100，没有列出ES的节点，F12打开Console，发现有跨域问题</p><p>解决：修改/ES_HOME/config/elasticsearch.yml，增加下面的配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure><p>然后重启ES和head即可。</p><p>参考：<a href="https://blog.csdn.net/u012832088/article/details/80662241">https://blog.csdn.net/u012832088/article/details/80662241</a></p><p>5.kafka Connection to node -1 could not be established. Broker may not be available.</p><p>解决：参考<a href="https://blog.csdn.net/qq_40633152/article/details/81090306">https://blog.csdn.net/qq_40633152/article/details/81090306</a></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>kibana中文文档：<a href="https://www.elastic.co/guide/cn/kibana/current/index.html">https://www.elastic.co/guide/cn/kibana/current/index.html</a></p><p>elasticsearch指南：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/index.html">https://www.elastic.co/guide/en/elasticsearch/reference/index.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> elk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring事件发布与监听</title>
      <link href="/2019/07/22/Spring%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E4%B8%8E%E7%9B%91%E5%90%AC/"/>
      <url>/2019/07/22/Spring%E4%BA%8B%E4%BB%B6%E5%8F%91%E5%B8%83%E4%B8%8E%E7%9B%91%E5%90%AC/</url>
      
        <content type="html"><![CDATA[<p>Spring提供了事件发布、监听的功能，在ApplicationContext中提供了一个publishEvent(ApplicationEvent event)来实现事件的发布，通过实现ApplicationListener来定义监听者的逻辑。</p><p>下面我们通过一个例子来说明。</p><p>1.定义一个事件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogEvent</span><span class="params">(Object source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.定义事件监听者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEventListener</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">LogEvent</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(LogEvent logEvent)</span> </span>&#123;</span><br><span class="line">        LogEventModel model = (LogEventModel) logEvent.getSource();</span><br><span class="line">        System.out.println(<span class="string">"--LogEventListener:[device="</span>+model.getDevice() +<span class="string">",phone="</span>+model.getUserPhone()+<span class="string">",nickname="</span>+model.getNickname()+<span class="string">"]."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的LogEventModel定义如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEventModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String device;</span><br><span class="line">    <span class="keyword">private</span> String userPhone;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.写一个Spring的工具类，实现ApplicationContextAware，以便使用它来发布事件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        SpringUtil.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">publishEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        applicationContext.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4.测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = &#123;Application.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringEventTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@org</span>.junit.Test</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LogEventModel model = LogEventModel.builder().device(<span class="string">"ios"</span>).nickname(<span class="string">"jack"</span>).userPhone(<span class="string">"13888888888"</span>).build();</span><br><span class="line">        System.out.println(<span class="string">"开始发布Spring Event"</span>);</span><br><span class="line">        SpringUtil.publishEvent(<span class="keyword">new</span> LogEvent(model));</span><br><span class="line">        System.out.println(<span class="string">"Spring Event发布完成。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台日志：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">开始发布Spring Event</span><br><span class="line">--LogEventListener:[device=ios,phone=13888888888,nickname=jack].</span><br><span class="line">Spring Event发布完成。</span><br></pre></td></tr></table></figure><p>通过控制台日志，我们注意到事件监听处理逻辑跟主程序是同步执行的，如果想异步执行，可以在LogEventListener的onApplicationContext方法上加入@Async注解，另外在配置类中加入@EnableAsync来启用异步（如果使用Spring Boot，在启动类上加入即可）。</p><p>另外事件监听器也可以通过注解的方式来指定</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEventListener2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="meta">@EventListener</span>(&#123;LogEvent.class&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(LogEvent logEvent)</span> </span>&#123;</span><br><span class="line">        LogEventModel model = (LogEventModel) logEvent.getSource();</span><br><span class="line">        System.out.println(<span class="string">"--LogEventListener2:[device="</span>+model.getDevice() +<span class="string">",phone="</span>+model.getUserPhone()+<span class="string">",nickname="</span>+model.getNickname()+<span class="string">"]."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通常，一些不重要的功能，比如日志记录、邮件发送、数据上报等情形可以考虑使用Spring提供的事件发布监听来优化。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CentOS7安装RabbitMQ</title>
      <link href="/2019/07/20/centos7%E5%AE%89%E8%A3%85rabbitmq/"/>
      <url>/2019/07/20/centos7%E5%AE%89%E8%A3%85rabbitmq/</url>
      
        <content type="html"><![CDATA[<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>参考：<a href="https://www.cnblogs.com/liaojie970/p/6138278.html">https://www.cnblogs.com/liaojie970/p/6138278.html</a></p><h3 id="RabbitMQ-默认端口号"><a href="#RabbitMQ-默认端口号" class="headerlink" title="RabbitMQ 默认端口号"></a><a href="https://www.cnblogs.com/daryl/p/7403188.html">RabbitMQ 默认端口号</a></h3><ul><li>4369 (epmd), 25672 (Erlang distribution)</li><li>5672, 5671 (AMQP 0-9-1 without and with TLS)</li><li>15672 (if management plugin is enabled)</li><li>61613, 61614 (if STOMP is enabled)</li><li>1883, 8883 (if MQTT is enabled)c</li></ul><p>通过控制台访问<a href="http://ip:15672，如果无法访问，执行`rabbitmq-plugins">http://ip:15672，如果无法访问，执行`rabbitmq-plugins</a> enable rabbitmq_management`.</p><p>默认控制台的用户名密码为guest/guest，但是只能本地访问。如果是其他Ip访问，会提示<code>Not management user</code>，可以添加一个用户，然后设置权限。</p><p><code>rabbitmqctl set_user_tags admin administrator</code> ，将admin用户设置为管理员。</p><p>参考：<a href="https://blog.csdn.net/qq_24095055/article/details/97001679">https://blog.csdn.net/qq_24095055/article/details/97001679</a></p><h3 id="客户端程序报access-to-vhost-‘-‘-refused-for-user-xxx"><a href="#客户端程序报access-to-vhost-‘-‘-refused-for-user-xxx" class="headerlink" title="客户端程序报access to vhost ‘/‘ refused for user xxx"></a>客户端程序报access to vhost ‘/‘ refused for user xxx</h3><p>增加/目录的访问权限。<code>rabbitmqctl  set_permissions -p / admin &#39;.*&#39; &#39;.*&#39; &#39;.*&#39;</code></p><h2 id="开机自启"><a href="#开机自启" class="headerlink" title="开机自启"></a>开机自启</h2><p><em>chkconfig rabbitmq-server on</em></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> centos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatis批量操作汇总</title>
      <link href="/2019/07/15/mybatis%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B1%87%E6%80%BB/"/>
      <url>/2019/07/15/mybatis%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E6%B1%87%E6%80%BB/</url>
      
        <content type="html"><![CDATA[<p>1.批量insert或update<br>在mapper中使用foreach来实现</p><p>2.同时批量insert和update<br>a.mysql<br>在mapper中使用foreach结合on duplicate update来实现。</p><p>b.Oracle<br>在mapper中使用foreach结合merge into来实现。</p><p>c.如果使用了mybatisplus<br>它提供了批量save或update，根据id。</p><p>d.在代码中使用mybatis的BATCH模式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">batchSaveOrUpdate</span><span class="params">(List&lt;FPlayerSuspend&gt; list)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == list || list.isEmpty()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    SqlSession session = sqlSessionTemplate.getSqlSessionFactory().openSession(ExecutorType.BATCH, <span class="keyword">false</span>);</span><br><span class="line">    FPlayerSuspendMapper mapper = session.getMapper(FPlayerSuspendMapper.class);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> size = list.size();</span><br><span class="line">        UpdateWrapper&lt;FPlayerSuspend&gt; wrapper = <span class="keyword">new</span> UpdateWrapper&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            FPlayerSuspend item = list.get(i);</span><br><span class="line">            <span class="comment">// 如果缓存或数据库存在，则判断是否变化 变化则更新 缓存或数据库不存在则插入</span></span><br><span class="line">            FPlayerSuspend cache = getFromDbIfCacheNotExist(item.getMatchId(),item.getPlayerId());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == cache)</span><br><span class="line">                mapper.insert(item);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 数据变化则更新</span></span><br><span class="line">                <span class="keyword">if</span> (isDataChange(item,cache)) &#123;</span><br><span class="line">                    wrapper.eq(<span class="string">"schedule_id"</span>, item.getMatchId())</span><br><span class="line">                            .eq(<span class="string">"player_id"</span>, item.getPlayerId());</span><br><span class="line">                    mapper.update(item, wrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">999</span> || i == size - <span class="number">1</span>) &#123;</span><br><span class="line">                session.commit();</span><br><span class="line">                session.clearCache();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">"批量插入或更新球探球员伤停数据出错"</span>, e);</span><br><span class="line">        session.rollback();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        session.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>上面的代码执行的是如果数据库有则更新，没有则插入的逻辑。实际上是有list.size()次数的数据库查询。可以将上面逻辑改为saveOrUpdate(在mapper中实现)。这样就避免了数据库查询，而是在提交到数据库之后才会去查询数据然后做相应处理。</p><p>如果使用java8，那么可以调整为下面的形式：<br>首先定义一个函数式接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Donny</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@createTime</span> 2019-07-10 15:05</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 批量操作数据库的函数式接口定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BatchDbOperationInterface</span>&lt;<span class="title">A</span>,<span class="title">B</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// A为要操作的javabean类型，B为相应的Mybatis Mapper</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(A type,B mapper)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>下面封装JDBC的批量操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchDBOperationImpl</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SqlSessionTemplate sqlSessionTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;A,B&gt; <span class="function"><span class="keyword">int</span> <span class="title">batchStatment</span><span class="params">(List&lt;A&gt; list, Class&lt;B&gt; mapperClass, BatchDbOperationInterface&lt;A,B&gt; function)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == list || list.isEmpty()) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        SqlSession session = sqlSessionTemplate.getSqlSessionFactory().openSession(ExecutorType.BATCH, <span class="keyword">false</span>);</span><br><span class="line">        B mapper = session.getMapper(mapperClass);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> size = list.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                A item = list.get(i);</span><br><span class="line">                function.apply(item,mapper);</span><br><span class="line">                <span class="keyword">if</span> (i % <span class="number">1000</span> == <span class="number">999</span> || i == size - <span class="number">1</span>) &#123;</span><br><span class="line">                    session.commit();</span><br><span class="line">                    session.clearCache();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"批量插入或更新数据出错"</span>, e);</span><br><span class="line">            session.rollback();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            session.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> BatchDBOperationImpl batchDBOperation;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">batchSaveIfNotExist</span><span class="params">(List&lt;BEuropeOddsDetail&gt; details)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> batchDBOperation.batchStatment(details, BEuropeOddsDetailMapper.class,(item,mapper)-&gt;mapper.insertIfNotExist(item));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hello World</title>
      <link href="/2019/07/03/hello-world/"/>
      <url>/2019/07/03/hello-world/</url>
      
        <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><a id="more"></a><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Kettle分表</title>
      <link href="/2019/07/02/%E4%BD%BF%E7%94%A8Kettle%E5%88%86%E8%A1%A8/"/>
      <url>/2019/07/02/%E4%BD%BF%E7%94%A8Kettle%E5%88%86%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<p>当表数据量比较大的时候（1000w），要考虑分表。这里记录使用Kettle（一个ETL工具）进行分表的操作。</p><h2 id="1-预估数据量"><a href="#1-预估数据量" class="headerlink" title="1.预估数据量"></a>1.预估数据量</h2><p>假定某个表的的数据量是2500万，那就需要分3个表存储。</p><h2 id="2-创建表"><a href="#2-创建表" class="headerlink" title="2.创建表"></a>2.创建表</h2><p>这里假定表名为b_company，需要分3个表。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> b_company_0 <span class="keyword">like</span> b_company;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> b_company_1 <span class="keyword">like</span> b_company;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> b_company_2 <span class="keyword">like</span> b_company;</span><br></pre></td></tr></table></figure></p><p>执行上面的脚本。</p><h2 id="打开Kettle，根据一定的规则（这里以ID划分，根据实际业务），将hash-id-0的insert到b-company-0，其他的以此类推。"><a href="#打开Kettle，根据一定的规则（这里以ID划分，根据实际业务），将hash-id-0的insert到b-company-0，其他的以此类推。" class="headerlink" title="打开Kettle，根据一定的规则（这里以ID划分，根据实际业务），将hash(id)=0的insert到b_company_0，其他的以此类推。"></a>打开Kettle，根据一定的规则（这里以ID划分，根据实际业务），将hash(id)=0的insert到b_company_0，其他的以此类推。</h2><p>a.新建转换–&gt;DB连接–&gt;新建（新建数据库）；<br>b.切换到“核心对象”Tab，选择输入、转换和输出的控件；<br>如图：<br><img src="/img/kettle_0.png" alt=""></p><p>表输入用来制定数据来源，内容如下：<br><img src="/img/kettle_1.png" alt=""></p><p>这里用了java脚本来实现根据ID生成一列table_name<br><img src="/img/kettle_2.png" alt=""></p><p>表输出这里使用了动态表名（根据一行数据的table_name字段）<br><img src="/img/kettle_3.png" alt=""></p><p>然后在数据库字段这里，点击“获取字段”，然后去掉table_name，因为我们是用它来确定某行数据应该存储到哪个表的。<br><img src="/img/kettle_4.png" alt=""></p><h2 id="kttle-新建作业执行多个转换job按并行和顺序执行"><a href="#kttle-新建作业执行多个转换job按并行和顺序执行" class="headerlink" title="kttle 新建作业执行多个转换job按并行和顺序执行"></a>kttle 新建作业执行多个转换job按并行和顺序执行</h2><p>参考：<a href="https://blog.csdn.net/saga_gallon/article/details/78410902">https://blog.csdn.net/saga_gallon/article/details/78410902</a></p><p><strong>特别注意</strong><br>如果表数据量大，用的windows10系统，默认情况下锁屏后网络会中断，会导致Kettle执行不成功。<br>到网络和共享中心–&gt;以太网–&gt;Microsoft网络客户端（选中）–&gt;配置–&gt;电源管理–&gt;运行计算机关闭此设备以节省电源（不要勾选）。</p><p>或者，直接到控制面板建电源管理中不然计算机进入休眠。位置：控制面板\硬件和声音\电源选项\编辑计划设置。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kettle </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ配置访问密码</title>
      <link href="/2019/05/22/ActiveMQ%E9%85%8D%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81/"/>
      <url>/2019/05/22/ActiveMQ%E9%85%8D%E7%BD%AE%E8%AE%BF%E9%97%AE%E5%AF%86%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h2 id="控制台密码配置"><a href="#控制台密码配置" class="headerlink" title="控制台密码配置"></a>控制台密码配置</h2><p>控制台的访问密码可以在jetty-realm.properties中进行配置，默认的配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># Defines users that can access the web (console, demo, etc.)</span><br><span class="line"># username: password [,rolename ...]</span><br><span class="line">admin: admin, admin</span><br><span class="line">user: user, user</span><br></pre></td></tr></table></figure></p><p>依次为用户名: 密码, 角色。</p><h2 id="JMS客户端访问密码配置"><a href="#JMS客户端访问密码配置" class="headerlink" title="JMS客户端访问密码配置"></a>JMS客户端访问密码配置</h2><p>默认ActiveMQ并没有指定密码，JMS客户端不指定密码就可以连接。这样就比较不安全了。<br>可以通过下面的方式添加账号和密码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"admin"</span> <span class="attr">password</span>=<span class="string">"123"</span> <span class="attr">groups</span>=<span class="string">"users,admins"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：如果使用了networkConnectors，也需要指定用户名密码。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">name</span>=<span class="string">"bridge"</span> <span class="attr">uri</span>=<span class="string">"static:(tcp://localhost:61616)"</span> <span class="attr">duplex</span>=<span class="string">"true"</span> <span class="attr">conduitSubscriptions</span>=<span class="string">"false"</span> <span class="attr">userName</span>=<span class="string">"admin"</span> <span class="attr">password</span>=<span class="string">"123"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>配置了上面的用户名和密码后，JMS客户端就需要相应的配置了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"admin"</span>,<span class="string">"123"</span>,<span class="string">"tcp://localhost:61626"</span>);</span><br></pre></td></tr></table></figure></p><p>上面只是一个基础的配置，如果需要更复杂的配置，可以参考：<a href="http://activemq.apache.org/security">http://activemq.apache.org/security</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ Channel was inactive for too (&gt;30000) long</title>
      <link href="/2019/05/18/ActiveMQ-Channel-was-inactive-for-too-long/"/>
      <url>/2019/05/18/ActiveMQ-Channel-was-inactive-for-too-long/</url>
      
        <content type="html"><![CDATA[<p>发现MQ周期性的报Channel was inactive for too (&gt;30000) long问题。ActiveMQ有一个InactiveMonitor线程，用来检查连接是否活跃，如果不活跃则会关闭它。<br>默认的检查周期是30s。</p><p>具体可以参考ActiveMQ的官方文档：<a href="http://activemq.apache.org/activemq-inactivitymonitor.html">http://activemq.apache.org/activemq-inactivitymonitor.html</a></p><p>解决办法：<br>1.在transport上配置<code>wireFormat.maxInactivityDuration=0</code>；<br>2.设置<code>transport.useInactivityMonitor=false</code>。</p><p>这里用的是第二种，第一种没用，不知道什么原因。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">"openwire"</span> <span class="attr">uri</span>=<span class="string">"tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600&amp;amp;transport.useInactivityMonitor=false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ静态网络连接</title>
      <link href="/2019/05/17/ActiveMQ%E9%9D%99%E6%80%81%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5/"/>
      <url>/2019/05/17/ActiveMQ%E9%9D%99%E6%80%81%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>使用静态网络连接（static networkConnector）可以将多个broker连接起来，作为一个集群对外提供服务。<br>我们假定有amq1和amq2配置了静态网络连接，那么当一个消费者连接到amq2，当生产者发送消息到amq1时，amq2将会作为amq1的一个消费者，将消息转移到amq2，然后投递给连接到amq2的消费者；反之亦然。对于queue，由于一条消息只能被一个消费者消费，所以在上面的情形下，消息将被转移到amq2，然后投递给连接到amq2的消费者；对于topic，amq2从amq1复制消息，然后投递给消费者。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>这里准备2台activemq，这里分别以activemq1和activemq2称之。</p><h3 id="activemq1修改"><a href="#activemq1修改" class="headerlink" title="activemq1修改"></a>activemq1修改</h3><p>1.修改brokerName为amq1;<br>2.修改openwire端口为61616，其他的transportConnector删除；<br>3.在destinationPolicy增加下面的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span> <span class="attr">enableAudit</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">networkBridgeFilterFactory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionalNetworkBridgeFilterFactory</span> <span class="attr">replayWhenNoConsumers</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">networkBridgeFilterFactory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这是针对queue的配置。该配置是为了解决消息回流的问题。replayWhenNoConsumers=true表示没有消费者时将消息回流到原始的broker。enableAudit=false为了防止消息回流后被当做重复消息而不被分发。</p><h3 id="activemq2修改"><a href="#activemq2修改" class="headerlink" title="activemq2修改"></a>activemq2修改</h3><p>1.修改brokerName为amq2，2个不要冲突。<br>2.修改openwire端口为61617，其他的transportConnector删除；<br>3.修改netty端口为8162；<br>4.增加下面的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">name</span>=<span class="string">"bridge"</span> <span class="attr">uri</span>=<span class="string">"static:(tcp://localhost:61616)"</span> <span class="attr">duplex</span>=<span class="string">"true"</span> <span class="attr">conduitSubscriptions</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>duplex默认为false，单向连接。如果配置为false，那么发送到amq2的消息可以从amq1消费，反之则不行。<br>conduitSubscriptions默认true，是否把同一个broker的多个consumer当做一个来处理。如果配置为true，假定有1个消费者连接amq1，3个消费者连接amq2，那么amq1的那个消费者将接收到50%的消息，amq2的3个消费者一共接收到50%的消息。所以这里设置为false，这样假定发送100条消息，那么每个消费者消费25条消息。</p><p>5.在destinationPolicy增加下面的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span> <span class="attr">enableAudit</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">networkBridgeFilterFactory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">conditionalNetworkBridgeFilterFactory</span> <span class="attr">replayWhenNoConsumers</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">networkBridgeFilterFactory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>客户端使用failover协议来连接mq。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failover:(tcp:<span class="comment">//127.0.0.1:61616,tcp://127.0.0.1:61626)?randomize=false</span></span><br></pre></td></tr></table></figure></p><p>指定randomize为false，这样会先连接127.0.0.1:61616，连接不上才会连接后面的地址。</p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>配置duplex=false，测试结果。<br>a.连接amq1发送消息；<br><img src="/img/activemq-broker-duplex-false-producer.png" alt=""><br>b.消费者连接amq2接收消息<br><img src="/img/activemq-broker-duplex-false-consumer.png" alt=""><br>可以发现发送到amq1的消息amq2没法消费。</p><p>将duplex改为true，amq2就可以消费amq1的消息了。</p><p>其他的就不一一测试了。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>这里使用2个broker，实际可以根据需要配置多个。多个地址用逗号分隔即可。比如uri=”static:(tcp://localhost:61616,tcp://localhost:61636)”。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之虚拟主题</title>
      <link href="/2019/04/03/ActiveMQ%E4%B9%8B%E8%99%9A%E6%8B%9F%E4%B8%BB%E9%A2%98/"/>
      <url>/2019/04/03/ActiveMQ%E4%B9%8B%E8%99%9A%E6%8B%9F%E4%B8%BB%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>虚拟目的地运允许我们创建一个映射到一个或多个实际物理目的地的逻辑目的地，客户端可以使用逻辑目的地来发送和消费消息。</p><p>ActiveMQ支持的虚拟Destinations分为有两种，分别是</p><ol><li>虚拟主题（Virtual Topics）</li><li>组合 Destinations（CompositeDestinations）</li></ol><h2 id="虚拟主题"><a href="#虚拟主题" class="headerlink" title="虚拟主题"></a>虚拟主题</h2><p>发布订阅背后的想法非常棒。允许生产者与消费者分离，这样他们甚至不知道有多少消费者对他们发布的消息感兴趣。JMS规范定义了对持久主题的支持，但是正如我们将描述的，它们有一些限制……</p><h3 id="JMS持久主题的限制"><a href="#JMS持久主题的限制" class="headerlink" title="JMS持久主题的限制"></a>JMS持久主题的限制</h3><ol><li>一个topic虽然可以有多个订阅者，但每个订阅者都是获取全量的消息，没法实现负载均衡。queue可以实现消费者端消息的负载均衡，但是broker不能讲消息发送给多个应用。所以没法实现发布订阅+消费者分组的功能。</li><li>由于只能使用单个的持久订阅在，如果该订阅者出错，应用就无法处理消息了，系统的健壮性不高。</li></ol><p>为了解决上面的2个问题，ActiveMQ实现了虚拟topic的功能。<br>虚拟topic以VirtualTopic.开头，比如VirtualTopic.ORDER。</p><p>虚拟主题背后的想法是生产者以通常的JMS方式发送给主题。消费者可以继续使用JMS规范中的主题语义。但是，如果主题是虚拟的，则使用者可以从物理队列中使用逻辑主题订阅，从而允许许多使用者在许多计算机和线程上运行以对负载进行负载平衡。</p><p>为了解决这两个问题，ActiveMQ中实现了虚拟Topic的功能。使用起来非常简单。<br>对于消息发布者来说，就是一个正常的Topic，名称以VirtualTopic.开头。例如VirtualTopic.TEST。<br>对于消息接收端来说，是个队列，不同应用里使用不同的前缀作为队列的名称，即可表明自己的身份即可实现消费端应用分组。例如Consumer.A.VirtualTopic.TEST，说明它是名称为A的消费端，同理Consumer.B.VirtualTopic.TEST说明是一个名称为B的客户端。可以在同一个应用里使用多个consumer消费此queue，则可以实现上面两个功能。又因为不同应用使用的queue名称不同（前缀不同），所以不同的应用中都可以接收到全部的消息。每个客户端相当于一个持久订阅者，而且这个客户端可以使用多个消费者共同来承担消费任务。</p><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><p><strong>生产者</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String topicName = <span class="string">"VirtualTopic.TEST"</span>;</span><br><span class="line">        List&lt;String&gt; msgList = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">int</span> msgSize = <span class="number">10</span>;</span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>,msgSize).forEach(i-&gt; &#123;</span><br><span class="line">            msgList.add(<span class="string">"hello "</span> + i);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        String[] msgs = <span class="keyword">new</span> String[msgSize];</span><br><span class="line">        msgs = msgList.toArray(msgs);</span><br><span class="line">        MqUtil.sendTopicMsg(topicName,msgs ,<span class="keyword">false</span>,<span class="keyword">true</span>,<span class="number">60000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>消费者</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String queueNameA = <span class="string">"Consumer.A.VirtualTopic.TEST"</span>;</span><br><span class="line">        String queueNameB = <span class="string">"Consumer.B.VirtualTopic.TEST"</span>;</span><br><span class="line">        MqUtil.addMessageListener(queueNameA,<span class="keyword">false</span>,msg-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer A1 received:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">false</span>);</span><br><span class="line">        MqUtil.addMessageListener(queueNameA,<span class="keyword">false</span>,msg-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer A2 received:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        MqUtil.addMessageListener(queueNameB,<span class="keyword">false</span>,msg-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer B1 received:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">false</span>);</span><br><span class="line">        MqUtil.addMessageListener(queueNameB,<span class="keyword">false</span>,msg-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"Consumer B2 received:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>MQ工具类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MqUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> PooledConnectionFactory FACTORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        FACTORY = <span class="keyword">new</span> org.apache.activemq.jms.pool.PooledConnectionFactory();</span><br><span class="line">        ConnectionFactory _factory = <span class="keyword">new</span> ActiveMQConnectionFactory(Constant.MQ_USERNAME, Constant.MQ_PASSWORD, Constant</span><br><span class="line">                .uris);</span><br><span class="line">        FACTORY.setConnectionFactory(_factory);</span><br><span class="line">        FACTORY.setMaxConnections(<span class="number">100</span>);</span><br><span class="line">        FACTORY.start();</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(FACTORY::stop));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String DestinationName, String[] msgs, <span class="keyword">boolean</span> isTopic, <span class="keyword">boolean</span> isTransaction, <span class="keyword">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params">            isPersistent,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">long</span></span></span></span><br><span class="line"><span class="function"><span class="params">                                       expiration)</span> </span>&#123;</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Session session = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = isTopic ? FACTORY.createTopicConnection() : FACTORY.createQueueConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            session = connection.createSession(isTransaction, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            Destination destination = isTopic ? session.createTopic(DestinationName) : session.createQueue(DestinationName);</span><br><span class="line">            MessageProducer producer = session.createProducer(destination);</span><br><span class="line">            <span class="keyword">for</span> (String msg : msgs) &#123;</span><br><span class="line">                Message message = session.createTextMessage(msg);</span><br><span class="line">                <span class="keyword">if</span> (expiration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    message.setJMSExpiration(expiration);</span><br><span class="line">                &#125;</span><br><span class="line">                message.setJMSDeliveryMode(isPersistent ? DeliveryMode.PERSISTENT : DeliveryMode.NON_PERSISTENT);</span><br><span class="line">                producer.send(message);</span><br><span class="line">                System.out.println(<span class="string">"消息"</span> + msg + <span class="string">"]发送成功."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (isTransaction) &#123;</span><br><span class="line">                session.commit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isTransaction &amp;&amp; session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.rollback();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e1) &#123;</span><br><span class="line">                    e1.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            closeResource(connection, session);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">closeResource</span><span class="params">(Connection connection, Session session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != session) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                session.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendQueueMsg</span><span class="params">(String queueName, String msg, <span class="keyword">boolean</span> isTransction, <span class="keyword">boolean</span> isPersistent, <span class="keyword">long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            expiration)</span> </span>&#123;</span><br><span class="line">        sendMsg(queueName, <span class="keyword">new</span> String[]&#123;msg&#125;, <span class="keyword">false</span>, isTransction, isPersistent, expiration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendTopicMsg</span><span class="params">(String topicName, String msg, <span class="keyword">boolean</span> isTransction, <span class="keyword">boolean</span> isPersistent, <span class="keyword">long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            expiration)</span> </span>&#123;</span><br><span class="line">        sendMsg(topicName, <span class="keyword">new</span> String[]&#123;msg&#125;, <span class="keyword">true</span>, isTransction, isPersistent, expiration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendTopicMsg</span><span class="params">(String topicName, String[] msgs, <span class="keyword">boolean</span> isTransction, <span class="keyword">boolean</span> isPersistent, <span class="keyword">long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            expiration)</span> </span>&#123;</span><br><span class="line">        sendMsg(topicName, msgs, <span class="keyword">true</span>, isTransction, isPersistent, expiration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addMessageListener</span><span class="params">(String DestinationName, <span class="keyword">boolean</span> isTopic, MessageListener listener, <span class="keyword">boolean</span></span></span></span><br><span class="line"><span class="function"><span class="params">            isTransaction)</span> </span>&#123;</span><br><span class="line">        Connection connection;</span><br><span class="line">        Session session;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = isTopic ? FACTORY.createTopicConnection() : FACTORY.createQueueConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            session = connection.createSession(isTransaction, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            Destination destination = isTopic ? session.createTopic(DestinationName) : session.createQueue(DestinationName);</span><br><span class="line">            MessageConsumer consumer = session.createConsumer(destination);</span><br><span class="line">            consumer.setMessageListener(listener);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>消费者控制台输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Consumer A1 received:hello 1</span><br><span class="line">Consumer B1 received:hello 1</span><br><span class="line">Consumer A2 received:hello 2</span><br><span class="line">Consumer B2 received:hello 2</span><br><span class="line">Consumer A1 received:hello 3</span><br><span class="line">Consumer B1 received:hello 3</span><br><span class="line">Consumer A2 received:hello 4</span><br><span class="line">Consumer B2 received:hello 4</span><br><span class="line">Consumer A1 received:hello 5</span><br><span class="line">Consumer B1 received:hello 5</span><br><span class="line">Consumer A2 received:hello 6</span><br><span class="line">Consumer B2 received:hello 6</span><br><span class="line">Consumer A1 received:hello 7</span><br><span class="line">Consumer B1 received:hello 7</span><br><span class="line">Consumer A2 received:hello 8</span><br><span class="line">Consumer B2 received:hello 8</span><br><span class="line">Consumer A1 received:hello 9</span><br><span class="line">Consumer B1 received:hello 9</span><br><span class="line">Consumer A2 received:hello 10</span><br><span class="line">Consumer B2 received:hello 10</span><br></pre></td></tr></table></figure></p><p>可以看到，A1和A2是一组，共同消费VirtualTopic.TEST的数据，B1和B2是一组，同时A1和A2，B1和B2依次消费。即达到了topic的功能又达到了负载均衡和failover的能力，在一组消费者中任何一个挂掉也不会影响消费。</p><p>需要注意的是：即使Queue消费了消息，VirtualTopic中的消息仍然不会删除，只有真正的topic订阅者消费消息后，VirtualTopic中的消息才会删除。当然，VirtualTopic中的消息删除，不会影响Queue中的消息，因为Queue中的消息是Copy过去的。</p><h3 id="虚拟主题的默认配置"><a href="#虚拟主题的默认配置" class="headerlink" title="虚拟主题的默认配置"></a>虚拟主题的默认配置</h3><p>默认情况下，虚拟主题名称必须是<code>VirtualTopic.&gt;</code>，消费者队列名称必须为<code>Consumer.*.VirtualTopic.&gt;</code>，当日这个你是可以修改的。下面的示例显示如何使所有主题都成为虚拟主题。下面的示例使用名称&gt;表示“匹配所有主题”。您可以使用此通配符在不同层级应用不同的虚拟主题策略。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">destinationInterceptors</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualDestinationInterceptor</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualDestinations</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualTopic</span> <span class="attr">name</span>=<span class="string">"&gt;"</span> <span class="attr">prefix</span>=<span class="string">"VirtualTopicConsumers.*."</span> <span class="attr">selectorAware</span>=<span class="string">"false"</span>/&gt;</span>    </span><br><span class="line">   <span class="tag">&lt;/<span class="name">virtualDestinations</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">virtualDestinationInterceptor</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">destinationInterceptors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><strong>配置选项</strong></p><table><thead><tr><th>选项</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>selectorAware</td><td>false</td><td>如果consumer端有selector，则只有匹配selector的消息才会分派到对应的queue中去。使用此选项可防止在独占使用者使用选择器时构建不匹配的消息</td></tr><tr><td>local</td><td>false</td><td>when true, don’t fan out messages that were received over a network</td></tr><tr><td>concurrentSend</td><td>false</td><td>如果为true，则消息将并行发送，同时允许日志批量写入以减少磁盘IO。</td></tr><tr><td>transactedSend</td><td>false</td><td>when true, use a transaction for fanout sends such that there is a single disk sync. A local broker transaction will be created if there is no client transaction (5.13)</td></tr><tr><td>dropOnResourceLimit</td><td>false</td><td>如果为true，将忽略发送期间跑出的ResourceAllocationException</td></tr><tr><td>setOriginalDestination</td><td>true</td><td>如果为true，则转发消息上的目标设置为使用者队列，而originalDestination消息属性将跟踪虚拟主题（5.16）</td></tr></tbody></table><h3 id="VirtualSelectorCacheBrokerPlugin"><a href="#VirtualSelectorCacheBrokerPlugin" class="headerlink" title="VirtualSelectorCacheBrokerPlugin"></a>VirtualSelectorCacheBrokerPlugin</h3><p>当selectorAware=true时，只有活动的消费者才被限定为选择器匹配的条件。如果消费者断开并重新连接，他们将错过消息。selectorAware=true的目的是不构建消息。virtualSelectorCacheBrokerPlugin提供了一个缓存，它可以跟踪与某个消费者的目的地相关联的选择器，这样它们就可以应用于该消费者。这样，所选的消息就会累积起来。现有的选择器集可以被持久化，以便在重启时可以恢复。插件以正常的方式应用于plugins部分。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualSelectorCacheBrokerPlugin</span> <span class="attr">persistFile</span>=<span class="string">"&lt;some path&gt;/selectorcache.data"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="组合目的地"><a href="#组合目的地" class="headerlink" title="组合目的地"></a>组合目的地</h2><p>组合目的地允许在各个目的地上建立一对多的关系; 主要用于组合队列。 例如，当消息发送到队列A时，您可能还希望将其转发到队列B和C以及主题D.然后，组合目的地是从虚拟目的地到其他物理目的地集合的映射。 在这种情况下，映射是在broker端，客户端不知道目的地之间的映射。 这与客户端组合目的地不同，客户端使用URL表示法指定必须将消息发送到的实际物理目标。</p><p>以下示例显示如何在XML配置中设置<compositeQueue />元素，以便在将消息发送到MY.QUEUE时，它实际上会转发到物理队列FOO和主题BAR。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">destinationInterceptors</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualDestinationInterceptor</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">virtualDestinations</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">compositeQueue</span> <span class="attr">name</span>=<span class="string">"MY.QUEUE"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">forwardTo</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">queue</span> <span class="attr">physicalName</span>=<span class="string">"FOO"</span> /&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">topic</span> <span class="attr">physicalName</span>=<span class="string">"BAR"</span> /&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">forwardTo</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">compositeQueue</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">virtualDestinations</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">virtualDestinationInterceptor</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">destinationInterceptors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>默认情况下，订阅者不能直接从组合队列或主题消费消息 - 它只是一个逻辑构造。 比如上述配置，订阅者只能消费来自FOO和BAR的消息; 而不是MY.QUEUE。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">compositeQueue</span> <span class="attr">name</span>=<span class="string">"IncomingOrders"</span> <span class="attr">forwardOnly</span>=<span class="string">"false"</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">forwardTo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">topic</span> <span class="attr">physicalName</span>=<span class="string">"Notifications"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">forwardTo</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">compositeQueue</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>发送到IncomingOrders的消息将全部复制并转发到Notifications，然后再放入物理IncomingOrders队列供订阅者使用。</p><p>如果未定义forwardOnly属性或将其设置为true，则compositeQueue和compositeTopic之间没有逻辑差异 - 它们可以互换使用。 只有当通过使用forwardOnly使组合目的地成为物理目的地时，compositeTopic / compositeQueue的选择才会对行为产生影响。</p><h3 id="使用过滤的目的地"><a href="#使用过滤的目的地" class="headerlink" title="使用过滤的目的地"></a>使用过滤的目的地</h3><p>从Apache ActiveMQ 4.2开始，您现在可以使用选择器来定义虚拟目的地。</p><p>您可能希望创建一个虚拟目的地，该目的地将消息转发到多个目的地，但首先使用选择器来确定消息是否确实必须转到特定目的地。</p><p>以下示例显示如果消息匹配指定的选择器，发送到虚拟目的地MY.QUEUE的消息将转发到FOO和BAR。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">destinationInterceptors</span>&gt;</span> <span class="tag">&lt;<span class="name">virtualDestinationInterceptor</span>&gt;</span> <span class="tag">&lt;<span class="name">virtualDestinations</span>&gt;</span> </span><br><span class="line">   <span class="tag">&lt;<span class="name">compositeQueue</span> <span class="attr">name</span>=<span class="string">"MY.QUEUE"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">forwardTo</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">filteredDestination</span> <span class="attr">selector</span>=<span class="string">"odd = 'yes'"</span> <span class="attr">queue</span>=<span class="string">"FOO"</span>/&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">filteredDestination</span> <span class="attr">selector</span>=<span class="string">"i = 5"</span> <span class="attr">topic</span>=<span class="string">"BAR"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">forwardTo</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">compositeQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">virtualDestinations</span>&gt;</span> <span class="tag">&lt;/<span class="name">virtualDestinationInterceptor</span>&gt;</span> <span class="tag">&lt;/<span class="name">destinationInterceptors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="避免broker网络中的重复消息"><a href="#避免broker网络中的重复消息" class="headerlink" title="避免broker网络中的重复消息"></a>避免broker网络中的重复消息</h2><p>当真正的subscriber和Queue都同时存在VirtualTopic中的时候，而且你的broker架构采用了“forward-brige”结构，那么你需要增加如下配置来避免消息的重复转发问题。在forward-brige架构中，任何通道中的消息都会forward到其他network node中(其他broker上)，当然这个虚拟的Queue的消息也不例外。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span> <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">uri</span>=<span class="string">"static://(tcp://localhost:61617)"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">excludedDestinations</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;<span class="name">queue</span> <span class="attr">physicalName</span>=<span class="string">"Consumer.*.VirtualTopic.&gt;"</span>/&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">excludedDestinations</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">networkConnector</span>&gt;</span> <span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://activemq.apache.org/virtual-destinations.html">http://activemq.apache.org/virtual-destinations.html</a><br>参考：<a href="https://shift-alt-ctrl.iteye.com/blog/2065436">https://shift-alt-ctrl.iteye.com/blog/2065436</a><br>参考：<a href="https://blog.csdn.net/zhu_tianwei/article/details/46303419">https://blog.csdn.net/zhu_tianwei/article/details/46303419</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ目的地特性之组合目的地</title>
      <link href="/2019/03/27/ActiveMQ%E7%9B%AE%E7%9A%84%E5%9C%B0%E7%89%B9%E6%80%A7%E4%B9%8B%E7%BB%84%E5%90%88%E7%9B%AE%E7%9A%84%E5%9C%B0/"/>
      <url>/2019/03/27/ActiveMQ%E7%9B%AE%E7%9A%84%E5%9C%B0%E7%89%B9%E6%80%A7%E4%B9%8B%E7%BB%84%E5%90%88%E7%9B%AE%E7%9A%84%E5%9C%B0/</url>
      
        <content type="html"><![CDATA[<p>从ActiveMQ1.1开始，支持一种被称为组合目标的技术。这允许使用单个虚拟的JMS目的地来表示一个JMS目的地的集合。</p><p>例如，你可以使用组合目的地在一个操作中将消息发送到12个物理队列。或再一次操作中将消息发送到一个主题和一个队列。</p><p>可以在创建目的地或将目的地注册到JNDI时，使用逗号分隔将多个目的地组合起来。<br>比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FOO.A,FOO.B,FOO.C</span><br></pre></td></tr></table></figure></p><p>表示3个不同的目的地。这可以与队列或主题一起使用，以表示一组3个目的地。如。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send to 3 queues as one logical operation</span></span><br><span class="line">Queue queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"FOO.A,FOO.B,FOO.C"</span>);</span><br><span class="line">producer.send(queue, someMessage);</span><br></pre></td></tr></table></figure></p><p>如果希望混合和匹配目的地的类型，可以使用queue://或topic://前缀来区分目的地的类型。例如，在队列中发布消息，同时也可以对某个主题发出通知<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send to queues and topic one logical operation</span></span><br><span class="line">Queue queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"FOO.A,topic://NOTIFY.FOO.A"</span>);</span><br><span class="line">producer.send(queue, someMessage);</span><br></pre></td></tr></table></figure></p><p>还可以在broker配置组合目的地，这样客户端发送到单个目的地的消息将透明地复制到多个物理目的地。</p><p>参考：<a href="http://activemq.apache.org/composite-destinations.html">http://activemq.apache.org/composite-destinations.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ目的地之目的地选项</title>
      <link href="/2019/03/27/ActiveMQ%E7%9B%AE%E7%9A%84%E5%9C%B0%E4%B9%8B%E7%9B%AE%E7%9A%84%E5%9C%B0%E9%80%89%E9%A1%B9/"/>
      <url>/2019/03/27/ActiveMQ%E7%9B%AE%E7%9A%84%E5%9C%B0%E4%B9%8B%E7%9B%AE%E7%9A%84%E5%9C%B0%E9%80%89%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>目的地选项（Destination Options）是一种向JMS使用者提供扩展配置选项的方法，而无需扩展JMS API。 使用创建使用者的目标名称中的URL查询语法对选项进行编码。</p><h2 id="Consumer-Options"><a href="#Consumer-Options" class="headerlink" title="Consumer Options"></a>Consumer Options</h2><table><thead><tr><th>选项名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>consumer.dispatchAsync</td><td>true</td><td>broker是否应该<a href="http://activemq.apache.org/consumer-dispatch-async.html">异步的向Consumer发送消息</a></td></tr><tr><td>consumer.exclusive</td><td>false</td><td>是否是一个<a href="http://activemq.apache.org/exclusive-consumer.html">独占消费者</a></td></tr><tr><td>consumer.maximumPendingMessageLimit</td><td>0</td><td>配置如果存在<a href="http://activemq.apache.org/slow-consumer-handling.html">缓慢消费者</a>，则用于控制是否删除费持久topic的消息</td></tr><tr><td>consumer.noLocal</td><td>false</td><td>与Topic使用者中的noLocal标志相同。 暴露在这里，以便它可以与队列一起使用。</td></tr><tr><td>consumer.prefetchSize</td><td>N/A</td><td>消费者预取的消息数，参考<a href="http://activemq.apache.org/what-is-the-prefetch-limit-for.html">prefetch</a></td></tr><tr><td>consumer.priority</td><td>0</td><td>配置消费者优先级，参考<a href="http://activemq.apache.org/consumer-priority.html">Consumer Priority</a></td></tr><tr><td>consumer.retroactive</td><td>false</td><td>是否为回溯消费者，参考<a href="http://activemq.apache.org/retroactive-consumer.html">Retroactive Consumer</a></td></tr><tr><td>consumer.selector</td><td>null</td><td>配置JMS选择器</td></tr></tbody></table><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"TEST.QUEUE?consumer.dispatchAsync=false&amp;consumer.prefetchSize=10"</span>);</span><br><span class="line">consumer = session.createConsumer(queue);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之消息持久化</title>
      <link href="/2019/03/27/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96/"/>
      <url>/2019/03/27/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="持久化方式"><a href="#持久化方式" class="headerlink" title="持久化方式"></a>持久化方式</h2><p>目前ActiveMQ包含以下几种存储方式：</p><ul><li>AMQ消息存储<br>基于文件的存储方式，是以前的默认消息存储</li><li>JDBC消息存储<br>使用数据库作为消息存储</li><li>KahaDB消息存储<br>提供了容量的提升和恢复能力，是现在的默认存储方式</li><li>LevelDB消息存储<br>基于Google的LevelDB库</li><li>Replicated LevelDB消息存储<br>复制的LevelDB存储，需要ZK来选择master节点。</li></ul><p>如果你不想使用activeMQ的持久存储，可以在activemq.xml中设置<code>persistent=false</code>来禁用它。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">persistent</span>=<span class="string">"false"</span>&gt;</span> <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这样broker会使用<code>&lt;memoryPersistenceAdapter&gt;</code></p><h2 id="各种存储方式介绍"><a href="#各种存储方式介绍" class="headerlink" title="各种存储方式介绍"></a>各种存储方式介绍</h2><h3 id="AMQ消息存储"><a href="#AMQ消息存储" class="headerlink" title="AMQ消息存储"></a>AMQ消息存储</h3><h4 id="AMQ介绍"><a href="#AMQ介绍" class="headerlink" title="AMQ介绍"></a>AMQ介绍</h4><blockquote><p>官方文档说ActiveMQ5.0及以上版本，AMQ消息存储是默认的存储方式，这个是不对的。在早期版本的ActiveMQ中默认使用的是AMQ，在5.0以后使用的是KahaDB。</p></blockquote><p> AMQ消息存储是一种可嵌入的事务性消息存储解决方案，非常快速和可靠。消息以日志的形式存储在data log中，以实现持久化。同时被reference store进行索引以提高存取速度。消息索引存储在内存（cache）中，ActiveMQ会定期将索引持久化到Reference store以提高性能。data log文件是有容量限制的，默认为32MB，可以自行配置。当该data log文件中所有消息都被消费完毕的时候，data log文件会被标记为可删除或存档，在下一次消息清理时可以被删除或归档。<br> <img src="/img/amqstore.png" alt="AMQ Store"></p><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p> AMQ消息存储配置示例：<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span> <span class="attr">persistent</span>=<span class="string">"true"</span> <span class="attr">useShutdownHook</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">amqPersistenceAdapter</span> <span class="attr">directory</span>=<span class="string">"$&#123;activemq.base&#125;/activemq-data"</span> <span class="attr">maxFileLength</span>=<span class="string">"32mb"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">uri</span>=<span class="string">"tcp://localhost:61616"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="AMQ存储配置选项"><a href="#AMQ存储配置选项" class="headerlink" title="AMQ存储配置选项"></a>AMQ存储配置选项</h4><table><thead><tr><th>属性名</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>directory</td><td>activemq-data</td><td>存储消息文件和日志的目录</td></tr><tr><td>useNIO</td><td>true</td><td>使用 NIO 特性</td></tr><tr><td>syncOnWrite</td><td>false</td><td>同步写文件到磁盘</td></tr><tr><td>maxFileLength</td><td>32mb</td><td>Message Data日志文件的最大 Size</td></tr><tr><td>persistentIndex</td><td>false</td><td>持久化日志索引，如果设为 false ，则在内存中保存</td></tr><tr><td>maxCheckpointMessageAddSize</td><td>4kb</td><td>在自动提交前在事务中能保持的最大消息数</td></tr><tr><td>cleanupInterval</td><td>30000</td><td>每隔多少时间清理不再使用的消息日志（毫秒）</td></tr><tr><td>indexBinSize</td><td>1024</td><td>这个值是用来提升索引的性能的，值越大，索引相对性能越好</td></tr><tr><td>indexKeySize</td><td>96</td><td>index key的size，index key基于message id</td></tr><tr><td>indexPageSize</td><td>16kb</td><td>索引页的size</td></tr><tr><td>directoryArchive</td><td>archive</td><td>消费完的Data Log存放的目录</td></tr><tr><td>archiveDataLogs</td><td>false</td><td>设置为true的话，消费完的Data Log就放到Archive目录，而不是删除。</td></tr></tbody></table><h4 id="AMQ存储数据结构"><a href="#AMQ存储数据结构" class="headerlink" title="AMQ存储数据结构"></a>AMQ存储数据结构</h4><p>在AMQ消息存储中有如下目录结构：<br><img src="/img/amqdir.png" alt="AMQ Dir"></p><p><strong>broker name</strong><br>broker name用来区分消息数据的目录。默认目录是localhost。下面是它的子目录：</p><p><strong>archive</strong><br>丢弃的Data Log就放到这里，当archiveDataLogs 属性配置为true时才会存在</p><p><strong>journal</strong><br>用来保存消息数据日志</p><p><strong>kr-store</strong><br>reference store目录。</p><p><strong>data</strong><br>引用索引所在目录</p><p><strong>state</strong><br>存储的状态。如果broker没有正确关闭，那么将清理reference store indexes，并回放消息数据文件（包括消息/ack和事物边界），以重建消息存储状态。如果使用Kaha reference store（缺省值），通过删除/krstore/state目录可以强制恢复。</p><p><strong>tmp-storage</strong><br>用于保存可能存储在磁盘上的临时消息的数据文件，以减少内存消耗——例如，非持久性主题消息等待交付给活动但速度较慢的订阅者。</p><h3 id="KahaDB消息存储"><a href="#KahaDB消息存储" class="headerlink" title="KahaDB消息存储"></a>KahaDB消息存储</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>KahaDB是一个基于文件的持久性数据库，并对快速持久化做了优化。它是ActiveMQ5.4及后续版本的默认存储机制。KahaDB使用较少的文件描述符，并提供了比它的前身<a href="http://activemq.apache.org/amq-message-store.html">AMQ</a>更快的恢复能力。</p><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><p>要使用KahaDB作为broker的持久性适配器，你可以按如下方式配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">directory</span>=<span class="string">"activemq-data"</span> <span class="attr">journalMaxFileLength</span>=<span class="string">"32mb"</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="配置选项"><a href="#配置选项" class="headerlink" title="配置选项"></a>配置选项</h4><table><thead><tr><th>属性</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>archiveCorruptedIndex</td><td>false</td><td>是否归档错误的索引</td></tr><tr><td>archiveDataLogs</td><td>false</td><td>当为true时，归档的消息文件被移到directoryArchive,而不是直接删除</td></tr><tr><td>checkForCorruptJournalFiles</td><td>false</td><td>检查消息文件是否损坏，true，检查发现损坏会尝试修复</td></tr><tr><td>checkpointInterval</td><td>5000</td><td>索引写入到消息文件的周期，单位ms</td></tr><tr><td>checksumJournalFiles</td><td>false</td><td>产生一个checksum，以便能够检测journal文件是否损坏。</td></tr><tr><td>cleanupInterval</td><td>30000</td><td>清除操作周期，单位ms</td></tr><tr><td>compactAcksAfterNoGC</td><td>10</td><td>从ActiveMQ5.14.0开始：当确认压缩特性启用时，此值控制必须完成多少存储GC周期，并且在触发压缩逻辑之前不清理任何其他文件，从而可能将跨越日志文件的旧确认压缩到新的日志文件中。值设置得越低，压缩可能发生得越快，如果压缩经常运行，则会影响性能。</td></tr><tr><td>compactAcksIgnoresStoreGrowth</td><td>false</td><td>从ActiveMQ 5.14.0开始:当确认压缩特性启用时，该值控制是否在存储仍在增长时运行压缩，或者是否应该只在存储停止增长时运行压缩(由于空闲或达到存储限制)。如果启用了压缩，则无论存储是否仍然有空间或是否处于活动状态都可以运行压缩，这可能会降低总体性能，但会更快地回收空间。</td></tr><tr><td>concurrentStoreAndDispatchQueues</td><td>true</td><td>当写入消息的时候，是否转发队列消息</td></tr><tr><td>concurrentStoreAndDispatchTopics</td><td>false</td><td>当写入消息的时候，是否转发主题消息（不推荐启用该属性）</td></tr><tr><td>directory</td><td>activemq-data</td><td>消息文件和日志的存储目录</td></tr><tr><td>directoryArchive</td><td>null</td><td>存储被归档的消息文件目录</td></tr><tr><td>enableAckCompaction</td><td>true</td><td>From ActiveMQ 5.14.0:此设置控制存储是否将定期压缩只包含消息确认的旧日志文件。通过将这些较早的确认压缩到新的日志文件中，可以删除较早的文件，从而释放空间，并允许消息存储在不触及存储大小限制的情况下继续运行。</td></tr><tr><td>enableIndexWriteAsync</td><td>false</td><td>true表示异步更新索引</td></tr><tr><td>enableJournalDiskSyncs</td><td>true</td><td>从ActiveMQ5.14.0已废弃，请参考journalDiskSyncStrategy</td></tr><tr><td>ignoreMissingJournalfiles</td><td>false</td><td>忽略丢失的消息文件，false，当丢失了消息文件，启动异常</td></tr><tr><td>indexCacheSize</td><td>10000</td><td>内存中，索引的页大小</td></tr><tr><td>indexDirectory</td><td></td><td>从ActiveMQ 5.10.0开始：如果设置，则配置将存储KahaDB索引文件（db.data和db.redo）的位置。 如果未设置，索引文件将存储在directory属性指定的目录中。</td></tr><tr><td>indexWriteBatchSize</td><td>1000</td><td>批量写入的索引数量</td></tr><tr><td>journalDiskSyncInterval</td><td>1000</td><td>同步磁盘时间间隔（单位毫秒）</td></tr><tr><td>journalDiskSyncStrategy</td><td>always</td><td>从ActiveMQ 5.14.0:该设置配置磁盘同步策略。可用的同步策略列表如下(按安全性递减，性能递增的顺序）：<strong>always</strong> 始终确保每次写日志之后都有磁盘同步(JMS持久性要求)。这是最安全的选择，但也是最慢的选择，因为它需要在每个消息写入之后进行同步。这相当于废弃的enableJournalDiskSyncs=true属性。<strong>periodic</strong>磁盘将以设定的时间间隔（如果发生写入）而不是在每次日志写入之后同步，这将减少磁盘上的负载并且应该提高吞吐量。滚动到新的日志文件时，磁盘也将同步。默认间隔为1秒。默认间隔提供非常好的性能，同时比从不磁盘同步更安全，因为数据丢失限制为最多1秒的值。请参阅journalDiskSyncInterval以更改磁盘同步的频率。<strong>nevel</strong> 永远不会被显式调用，它将由操作系统刷新到磁盘。这相当于设置废弃的属性enableJournalDiskSyncs=false。这是最快的选择，但也是最不安全的，因为无法保证何时将数据刷新到磁盘。因此，broker失败时可能发生消息丢失。</td></tr><tr><td>journalMaxFileLength</td><td>32mb</td><td>一个消息文件的大小</td></tr><tr><td>maxAsyncJobs</td><td>10000</td><td>排队等待存储的异步消息的最大数量(应该与MessageProducer的数量一样）</td></tr><tr><td>preallocationScope</td><td>entire_journal</td><td>从ActiveMQ 5.14.0:该设置配置如何预先分配日志数据文件。默认策略在第一次使用appender线程时预先分配日志文件。<strong>entire_journal</strong>：将在首次使用时使用appender线程预分配日志文件。<strong>entire_journal_async</strong>：将在单独的线程中提前使用预分配。<strong>none</strong>：禁用预分配。在SSD上，使用entire_journal_async可以避免在首次使用时延迟写入等待预分配。注意：在HDD上，磁盘的额外线程争用会产生负面影响。 因此使用默认值。</td></tr><tr><td>preallocationStrategy</td><td>sparse_file</td><td>从ActiveMQ 5.12.0：此设置配置broker在需要新日志文件时尝试预分配日志文件的方式。<strong>sparse_file</strong>:设置文件长度，<strong>os_kernel_copy</strong>:委托给操作系统，<strong>zeros</strong>:不设置文件长度</td></tr><tr><td>purgeRecoveredXATransactionStrategy</td><td>never</td><td>从ActiveMQ 5.15.5开始：此设置将在恢复期间提交或回滚所有准备好的XA事务。<strong>never</strong>：在恢复期间对准备好的XA事务不做任何操作；<strong>commit</strong>：在恢复期间提交准备好的XA事务；<strong>rollback</strong>：在恢复期间回滚准备好的XA事务。此功能将对所有准备好的XA事务执行提交或回滚，请考虑使用RecoverXATransaction MBean手动检查特定事务的提交或回滚。</td></tr><tr><td>storeOpenWireVersion</td><td>11</td><td>确定KahaDB日志的OpenWire命令的版本。在ActiveMQ 5.12.0之前：默认值为6。broker的某些功能取决于较新协议修订版中存储在OpenWire命令中的信息，如果将存储版本设置为较低值，这些功能可能无法正常工作。 在许多情况下，broker版本大于5.9.0的KahaDB存储仍然可以被broker读取，但会导致broker继续使用较旧的存储版本，这意味着较新的功能可能无法按预期工作。对于在ActiveMQ 5.9.0之前的版本中创建的KahaDB存储，需要手动设置storeOpenWireVersion =“6”以便启动broker而不会出现错误。</td></tr><tr><td>cleanupOnStop</td><td>true</td><td>是否在broker关闭时执行gc/cleanup操作。</td></tr></tbody></table><h4 id="慢速文件系统访问诊断日志记录"><a href="#慢速文件系统访问诊断日志记录" class="headerlink" title="慢速文件系统访问诊断日志记录"></a>慢速文件系统访问诊断日志记录</h4><p>您可以为数据库更新配置一个以毫秒为单位的非零阈值。如果数据库操作比该阈值慢(例如，如果将其设置为500)，您可能会看到如下消息:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Slow KahaDB access: cleanup took 1277 | org.apache.activemq.store.kahadb.MessageDatabase | ActiveMQ Journal Checkpoint Worker</span><br></pre></td></tr></table></figure></p><p>您可以使用系统属性配置用于记录这些消息的阈值，并将其调整为磁盘速度，以便您可以轻松获取运行时异常。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Dorg.apache.activemq.store.kahadb.LOG_SLOW_ACCESS_TIME=1500</span><br></pre></td></tr></table></figure></p><h3 id="jdbc消息存储"><a href="#jdbc消息存储" class="headerlink" title="jdbc消息存储"></a>jdbc消息存储</h3><p>ActiveMQ支持一系列的SQL数据库作为消息存储。比如：</p><ul><li>Apache Derby</li><li>Axion</li><li>DB2</li><li>HSQL</li><li>Informix</li><li>MaxDB</li><li>MySQL</li><li>Oracle</li><li>Postgresql</li><li>SQLServer</li><li>Sybase<br>以及一些通用JDBC provider。</li></ul><h4 id="自动发现JDBC-provider"><a href="#自动发现JDBC-provider" class="headerlink" title="自动发现JDBC provider"></a>自动发现JDBC provider</h4><p>ActiveMQ会尝试通过这些配置文件和JDBC驱动程序的返回字符串从JDBC驱动程序自动检测要使用的JDBCAdapter。</p><p>你可以在activemq.xml中使用其xbean标识符显式指定JDBC适配器…<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span> <span class="attr">adapter</span>=<span class="string">"postgresql-jdbc-adapter"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="自定义-SQL-DDL"><a href="#自定义-SQL-DDL" class="headerlink" title="自定义 SQL DDL"></a>自定义 SQL DDL</h4><p>您可以使用statements元素配置各种SQL数据类型 - 例如列大小等<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">useJmx</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">journaledJDBC</span> <span class="attr">useJournal</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">statements</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">statements</span> <span class="attr">stringIdDataType</span> =<span class="string">"VARCHAR(128)"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">statements</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">journaledJDBC</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>有关可以在statements元素上设置哪些属性的更多信息，请参阅<a href="http://activemq.apache.org/maven/apidocs/org/apache/activemq/store/jdbc/Statements.html">Statements</a>类。 所有可设置的bean属性都可以用作<statements>元素的属性。</p><h4 id="使用MySQL"><a href="#使用MySQL" class="headerlink" title="使用MySQL"></a>使用MySQL</h4><p>如果您使用的是MySQL，则应将relaxAutoCommit标志设置为true。 例如<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mysql-ds"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://localhost/activemq?relaxAutoCommit=true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"amq"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"amqPass"</span>/&gt;</span> <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolPreparedStatements"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span> <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">broker</span> <span class="attr">...</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span> <span class="attr">dataSource</span>=<span class="string">"#mysql-ds"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="使用Oracle"><a href="#使用Oracle" class="headerlink" title="使用Oracle"></a>使用Oracle</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.apache.org/schema/core"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">brokerName</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">jdbcPersistenceAdapter</span></span></span><br><span class="line"><span class="tag">            <span class="attr">dataDirectory</span>=<span class="string">"$&#123;activemq.base&#125;/data"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">dataSource</span>=<span class="string">"#oracle-ds"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment">&lt;!-- Oracle DataSource Sample Setup --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"oracle-ds"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp.BasicDataSource"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"oracle.jdbc.driver.OracleDriver"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:oracle:thin:@localhost:1521:AMQDB"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"scott"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"tiger"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"200"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolPreparedStatements"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用Spring bean元素配置JDBC驱动程序。 id属性指定配置JDBC持久性适配器时引用驱动程序的名称。 class属性指定实现用于与JDBC驱动程序接口的数据源的类。 destroy-method属性指定JDBC驱动程序关闭时要调用的方法的名称。</p><h3 id="LevelDB消息存储"><a href="#LevelDB消息存储" class="headerlink" title="LevelDB消息存储"></a>LevelDB消息存储</h3><blockquote><p>注意：LevelDB存储已被废弃，并不再推荐使用。推荐的存储是：KahaDB。</p></blockquote><p>LevelDB持久性适配器使用LevelDB作为高性能的消息存储。它是一个基于文件的存储库，它使用了Google的LevelDB，将索引保存到包含消息的日志文件中。它经过优化，提供了比KahaDB更快的持久性。它类似于KahahDB，但是它没有使用自定义的b树实现来索引写前日志，而是使用基于LevelDB的索引，由于“append only”文件访问模式，这些索引具有一些很好的属性：</p><ul><li>快速更新(不需要进行随机磁盘更新)</li><li>并发读取</li><li>使用硬链接的快速索引快照</li></ul><p>KahaDB和LevelDB存储都必须进行周期性的垃圾收集，以确定可以删除哪些日志文件。在KahaDB的情况下，这可能非常昂贵，因为您增加了存储的数据量，并且在收集发生时可能导致读/写停止。LevelDB存储使用一种便宜得多的算法来确定何时可以收集日志文件并避免这些停顿。</p><p>LevelDB的主要优势有：</p><ul><li>更高的持久吞吐量</li><li>broker重启时恢复时间更快</li><li>支持并发的读访问</li><li>在垃圾回收周期中不会暂停</li><li>使用较少的读取IO操作来加载存储的消息</li><li>支持XA事务</li><li>检查重复的消息</li><li>通过JMX暴露公开状态以进行监控</li><li>支持复制</li></ul><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><p>通过在broker中的<code>persistenceAdapter</code>中加入<code>levelDB</code>元素来配置LevelDB存储。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span> <span class="attr">persistent</span>=<span class="string">"true"</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">levelDB</span> <span class="attr">directory</span>=<span class="string">"activemq-data"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="配置属性"><a href="#配置属性" class="headerlink" title="配置属性"></a>配置属性</h4><table><thead><tr><th>属性名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>directory</td><td>activemq-data</td><td>数据文件的存储目录</td></tr><tr><td>readThreads</td><td>10</td><td>指定允许的并发IO读取数</td></tr><tr><td>sync</td><td>true</td><td>是否进行磁盘的同步写操作</td></tr><tr><td>logSize</td><td>104857600（100mb）</td><td>log日志文件的最大值（以字节为单位）</td></tr><tr><td>verifyChecksums</td><td>false</td><td>是否对从文件系统读取的数据进行强制校验</td></tr><tr><td>paranoidChecks</td><td>false</td><td>指定LevelDB在检测到内部错误时是否尽快出错。</td></tr><tr><td>indexFactory</td><td>org.fusesource.leveldbjni.JniDBFactory, org.iq80.leveldb.impl.Iq80DBFactory</td><td>指定broker尝试加载的LevelDB API工厂实现类的列表（用逗号分隔）。broker将使用第一个成功加载的工厂类。<strong>org.fusesource.leveldbjni.JniDBFactory</strong>：启用JNI的基本实现。<strong>org.iq80.leveldb.impl.Iq80DBFactory</strong>：启用纯Java的实现。</td></tr><tr><td>indexMaxOpenFiles</td><td>1000</td><td>指定索引可以使用的打开文件数。LevelDB内部使用多线程进行文件读写操作</td></tr><tr><td>indexBlockRestartInterval</td><td>16</td><td>Specifies the number of keys between restart points for delta encoding of keys.</td></tr><tr><td>indexWriteBufferSize</td><td>4194304</td><td>指定在转换为已排序的磁盘文件之前要在内存中构建的索引数据的数量(以字节为单位)。</td></tr><tr><td>indexBlockSize</td><td>4096</td><td>指定每个块的索引数据的大小(以字节为单位)。</td></tr><tr><td>indexCacheSize</td><td>268435456（256MB）</td><td>指定用于缓存索引块的内存的最大量（以字节为单位）</td></tr><tr><td>indexCompression</td><td>snappy</td><td>指定要应用于索引块的压缩类型。<strong>snappy</strong>或<strong>none</strong>。</td></tr><tr><td>logCompression</td><td>snappy</td><td>指定要应用于日志记录的压缩类型。<strong>snappy</strong>或<strong>none</strong>。</td></tr></tbody></table><h3 id="Replicated-LevelDB消息存储"><a href="#Replicated-LevelDB消息存储" class="headerlink" title="Replicated LevelDB消息存储"></a>Replicated LevelDB消息存储</h3><h4 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h4><p>Replicated LevelDB使用Apache Zookeeper从一组配置为Replicated LevelDB存储的broker节点选择一个作为master。然后，通过复制master的所有更新来同步所有的slave的LevelDB存储，从而使slave保持最新。</p><p>Replicated LevelDB存储使用预LevelDB存储相同的数据文件，因此broker可以随时在Replicated LevelDB和LevelDB之间随时切换。</p><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p><img src="/img/replicated-leveldb-store.png" alt="replicated-leveldb-store.png"></p><p>它使用Apache Zookeeper来协调集群中的哪个节点作为master节点。选定的master节点启动并接受客户端连接。其他节点成为slave节点，并连接master，与master保持同步。从节点不接受客户端连接。所有持久化操作都将复制到slave节点。如果master挂掉，则具有最新更新的slave节点被提升为master。然后，故障节点可以重新连接，并作为slave节点。</p><p>所有的需要同步到磁盘的消息操作都将等待法定数量的slave节点复制数据完成。因此，如果你配置了<code>replicas=3</code>，那么法定的节点数量为3/2+1=2个。master会在本地存储更新，并等待另外一个slave节点存储更新后才会报告成功。换一种说法，Replicated LevelDB存储将会同步复制到法定数量的slave节点，并将异步复制到任何其他节点。</p><p>当选择新的master节点时，你还需要至少一个在线的法定数量的节点才能找到具有最新更新的节点。具有最新更新的节点将成为master节点。因此，建议至少使用3个节点，以便在服务不中断的情况下关闭其中一个节点。</p><h4 id="部署建议"><a href="#部署建议" class="headerlink" title="部署建议"></a>部署建议</h4><p>客户端应该使用failover连接集群中的节点，比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failover:(tcp:<span class="comment">//broker1:61616,tcp://broker2:61616,tcp://broker3:61616)</span></span><br></pre></td></tr></table></figure></p><p>同时为了Zookeeper的高可用，你需要至少运行3个Zookeeperjieidan。不要过渡时会用Zookeeper，过度的Zookeeper可能会认为复制的节点由于处理心跳消息的延迟而离线了。</p><p>为了获得最佳结果，确保将hostname属性配置为了集群中其他节点的主机名或ip地址。其他集群成员无法始终访问自动确定的主机名，从而导致slave节点无法与master建立复制会话。</p><h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><p>您可以配置ActiveMQ使用LevelDB作为它的持久性适配器，如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replicatedLevelDB</span></span></span><br><span class="line"><span class="tag">      <span class="attr">directory</span>=<span class="string">"activemq-data"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">replicas</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">bind</span>=<span class="string">"tcp://0.0.0.0:0"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">zkAddress</span>=<span class="string">"zoo1.example.org:2181,zoo2.example.org:2181,zoo3.example.org:2181"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">zkPassword</span>=<span class="string">"password"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">zkPath</span>=<span class="string">"/activemq/leveldb-stores"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">hostname</span>=<span class="string">"broker1.example.org"</span></span></span><br><span class="line"><span class="tag">      /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="Replicated-LevelDB存储属性"><a href="#Replicated-LevelDB存储属性" class="headerlink" title="Replicated LevelDB存储属性"></a>Replicated LevelDB存储属性</h4><p>相同复制集中的的broker节点应该有相同的broker name，相同的复制集中的下面的属性也应该相同。</p><table><thead><tr><th>属性名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>replicas</td><td>3</td><td>集群节点的数量，至少(replicas/2)+1个，以避免服务中断。 </td></tr><tr><td>securityToken</td><td></td><td>一个安全令牌，必须在所有复制节点上匹配，才能接受彼此的复制请求。</td></tr><tr><td>zkAddress</td><td>127.0.0.1:2181</td><td>逗号分隔的ZooKeeper服务器列表。</td></tr><tr><td>zkPassword</td><td></td><td>连接到Zookeeper时使用的密码</td></tr><tr><td>zkPath</td><td>/default</td><td>Zookeeper主从选举使用的Zookeeper的目录路径</td></tr><tr><td>zkSessionTimeout</td><td>2s</td><td>Zookeeper多久检测一个节点失败。（5.11以前，有一个错字zkSessionTmeout）</td></tr><tr><td>sync</td><td>quorum_mem</td><td>用于控制同步的区域，以“，”分割多个区域。可选项有：local_mem, local_disk, remote_mem, remote_disk, quorum_mem, quorum_disk.如果你配置多个区域，将更强的保证机制将被触发。例如：local_mem, local_disk 与 local_disk 等同quorum_mem 与local_mem, remote_mem 等同quorum_disk  与local_disk, remote_disk等同</td></tr></tbody></table><p>不同的复制集可以共享相同的zkPath只要他们有不同的brokerName.</p><p>下面的配置属性每个节点特殊的配置：</p><table><thead><tr><th>属性名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>bind</td><td>tcp://0.0.0.0:61619</td><td>当该节点成为主节点时，绑定的地址和端口，用于服务复制协议还支持使用动态端口，只需配置tcp:/ / 0.0.0.0:0</td></tr><tr><td>hostname</td><td></td><td>用于在此节点成为主节点时通告复制服务的主机名。 如果未设置，将自动确定。</td></tr><tr><td>weight</td><td>1</td><td>具有最高权重的最新更新的复制节点将成为主节点。 用于优先选择某些节点成为主节点。</td></tr></tbody></table><p>该存储还支持与标准LevelDB存储相同的配置属性，但它不支持可插拔的存储锁。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>参考：<a href="http://activemq.apache.org/persistence.html">http://activemq.apache.org/persistence.html</a><br>AMQ消息存储参考：<a href="http://activemq.apache.org/amq-message-store.html">http://activemq.apache.org/amq-message-store.html</a><br>KahaDB消息存储参考：<a href="http://activemq.apache.org/kahadb.html">http://activemq.apache.org/kahadb.html</a><br>JDBC消息存储参考：<a href="http://activemq.apache.org/jdbc-support.html">http://activemq.apache.org/jdbc-support.html</a>、<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/fusembpersistjdbcstore">USING JDBC TO CONNECT TO A DATABASE STORE</a><br>LevelDB消息存储参考：<a href="http://activemq.apache.org/leveldb-store.html">http://activemq.apache.org/leveldb-store.html</a>、<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/leveldbconfiguration">https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/leveldbconfiguration</a><br>Replicated LevelDB消息存储参考：<a href="http://activemq.apache.org/replicated-leveldb-store.html">http://activemq.apache.org/replicated-leveldb-store.html</a>、<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/repleveldbconfig">USING THE REPLICATED LEVELDB PERSISTENCE ADAPTER</a><br>多KahaDB存储：<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/fusembmultikahadb">https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/fusembmultikahadb</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之配置多KahaDB持久性适配器</title>
      <link href="/2019/03/26/ActiveMQ%E4%B9%8B%E9%85%8D%E7%BD%AE%E5%A4%9AKahaDB%E6%8C%81%E4%B9%85%E6%80%A7%E9%80%82%E9%85%8D%E5%99%A8/"/>
      <url>/2019/03/26/ActiveMQ%E4%B9%8B%E9%85%8D%E7%BD%AE%E5%A4%9AKahaDB%E6%8C%81%E4%B9%85%E6%80%A7%E9%80%82%E9%85%8D%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>从ActiveMQ5.6开始，可以跨多个kahdb持久性适配器分发目标存储。当您的目的地具有不同的性能概要文件或不同的持久性需求时，您可以将它们分布在多个KahaDB消息存储中。</p><p>当broker管理的所有Destination有相似的性能和可靠性时，默认的KahaDB持久性存储适配器工作良好。当一个Destination有完全不同的性能配置文件时，例如，与其他Destination上的消费者相比，该Destination上的消费者异常缓慢，存储消息的磁盘使用量将会快速增长。当一个或多个Destination不需要 磁盘同步，而其他的Destination需要磁盘同步时，所有的Destination都将受到性能影响。</p><p>多KahaDB持久性适配器允许您跨多个KahaDB消息存储分发broker的Destination。使用多个消息存储允许您使用它更精确地定制消息存储以满足Destination的需要。 使用采用标准通配符语法的过滤器匹配Destination和存储。</p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>多KahaDB持久性适配器配置包含多个KahaDB消息存储配置。使用mKahaDB元素指定多KahaDB持久性适配器配置。 mKahaDB元素具有单个属性directory，用于指定适配器写入其数据存储的位置。 此设置是内嵌的KahaDB消息存储库实例的目录属性的默认值。 各个消息存储库可以覆盖此默认设置。</p><p>mKahaDB元素有一个子元素filteredPersistenceAdapters。filteredPersistenceAdapters元素包含多个filteredKahaDB元素，用于配置持久性适配器使用的KahaDB消息存储。</p><p>每个filteredKahaDB元素配置一个KahaDB消息存储（除了perDestination属性设置为true的情况）。 使用filteredKahaDB元素上的属性指定与消息存储库匹配的Destination：</p><ul><li>queue——指定queue的名称</li><li>topic——指定topic的名称</li></ul><p>可以使用显式目标名称或使用通配符指定目标。如果未指定目标，则消息存储将匹配其他筛选器未匹配的任何Destination。</p><p>在filteredKahaDB元素中配置的KahaDB消息存储使用标准的KahaDB持久性适配器配置进行配置。<br>它由一个包含在persistenceAdapter元素中的kahaDB元素组成。</p><h2 id="通配符语法"><a href="#通配符语法" class="headerlink" title="通配符语法"></a>通配符语法</h2><p>您可以使用通配符指定一组Destination名称。 这对于在联合层次结构中设置目标的情况很有用。</p><ul><li><code>.</code>分离路径名称</li><li><code>*</code> 匹配路径中的任意名称</li><li><code>&gt;</code> 匹配任意以该名称开头的Destination</li></ul><h2 id="配置示例"><a href="#配置示例" class="headerlink" title="配置示例"></a>配置示例</h2><p>从ActiveMQ 5.15开始，filteredKahaDB支持名为usage的StoreUsage属性。 这允许对匹配的队列施加单独的磁盘限制。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mKahaDB</span> <span class="attr">directory</span>=<span class="string">"$&#123;activemq.base&#125;/data/kahadb"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filteredPersistenceAdapters</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- match all queues --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filteredKahaDB</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">usage</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">storeUsage</span> <span class="attr">limit</span>=<span class="string">"1g"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">usage</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">journalMaxFileLength</span>=<span class="string">"32mb"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">filteredKahaDB</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">      <span class="comment">&lt;!-- match all destinations --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filteredKahaDB</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">enableJournalDiskSyncs</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">filteredKahaDB</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filteredPersistenceAdapters</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mKahaDB</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>上面的配置表示：所有的queue使用第一个消息存储适配器，其他的目的地（这里就是所有的topic）使用第二个消息存储适配器。</p><h3 id="为每个Destination指定一个持久性适配器"><a href="#为每个Destination指定一个持久性适配器" class="headerlink" title="为每个Destination指定一个持久性适配器"></a>为每个Destination指定一个持久性适配器</h3><p>如果<code>filteredKahaDB</code>元素的<code>perDestination</code>设置为true，且没有指定任何的queue和topic，那么每个Destination将有自己的KahaDB实例。</p><p>比如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">brokerName</span>=<span class="string">"broker"</span> <span class="attr">...</span> &gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mKahaDB</span> <span class="attr">directory</span>=<span class="string">"$&#123;activemq.base&#125;/data/kahadb"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filteredPersistenceAdapters</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- kahaDB per destinations --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">filteredKahaDB</span> <span class="attr">perDestination</span>=<span class="string">"true"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">journalMaxFileLength</span>=<span class="string">"32mb"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">filteredKahaDB</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filteredPersistenceAdapters</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mKahaDB</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line"> ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>注意：perDestination属性和queue或topic属性组合尚未经过验证，可能会抛出下面的异常：<br>Reason: java.io.IOException: File ‘/opt/java/apache-activemq-5.9.0/data/mKahaDB/lock’ could not be locked as lock is already held for this jvm</p></blockquote><h2 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h2><p>如果Destination是分布式的，事务可以跨越多个日志。这意味着需要完成两个阶段。这确实会导致记录提交结果的额外磁盘同步的性能损失。</p><p>如果事务中只涉及一个日志，则不使用额外的磁盘同步。 在这种情况下不会产生性能损失。</p><p>参考：<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/fusembmultikahadb">USING A MULTI KAHADB PERSISTENCE ADAPTER</a><br>参考：<a href="http://activemq.apache.org/kahadb.html">http://activemq.apache.org/kahadb.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之消息延迟与定时投递</title>
      <link href="/2019/03/23/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E5%BB%B6%E8%BF%9F%E4%B8%8E%E5%AE%9A%E6%97%B6%E6%8A%95%E9%80%92/"/>
      <url>/2019/03/23/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E5%BB%B6%E8%BF%9F%E4%B8%8E%E5%AE%9A%E6%97%B6%E6%8A%95%E9%80%92/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>从ActiveMQ5.4开始，内置了一个可选的持久性调度程序。在activemq.xml中设置broker的schedulerSupport=true来启用。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.apache.org/schema/core"</span> <span class="attr">brokerName</span>=<span class="string">"amq1"</span> <span class="attr">dataDirectory</span>=<span class="string">"$&#123;activemq.data&#125;"</span> <span class="attr">schedulerSupport</span>=<span class="string">"true"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>JMS客户端可以使用下面的属性之一来实现消息的延迟投递：</p><table><thead><tr><th>属性名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>AMQ_SCHEDULED_DELAY</td><td>long</td><td>broker在投递消息前等待的时间（单位毫秒）</td></tr><tr><td>AMQ_SCHEDULED_PERIOD</td><td>long</td><td>消息重复投递的间隔（单位毫秒）</td></tr><tr><td>AMQ_SCHEDULED_REPEAT</td><td>int</td><td>重复投递消息的次数</td></tr><tr><td>AMQ_SCHEDULED_CRON</td><td>String</td><td>使用Cron表达式</td></tr></tbody></table><p>ActiveMQ也提供了一个封装的消息类型：org.apache.activemq.ScheduledMessage，可以使用这个类来辅助设置。</p><p>例如，要让消息在60后投递，你需要设置AMQ_SCHEDULED_DELAY属性：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span><br><span class="line">TextMessage message = session.createTextMessage(<span class="string">"test msg"</span>);</span><br><span class="line"><span class="keyword">long</span> time = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, time);</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure></p><p>你还可以设置消息在一定延迟后，重复投递10次，每次重新投递等待10秒：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span><br><span class="line">TextMessage message = session.createTextMessage(<span class="string">"test msg"</span>);</span><br><span class="line"><span class="keyword">long</span> delay = <span class="number">30</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">long</span> period = <span class="number">10</span> * <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">int</span> repeat = <span class="number">9</span>;</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, delay);</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD, period);</span><br><span class="line">message.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT, repeat);</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure></p><p>如上，在30秒后开始投递消息，总共投递10次，两次消息投递间隔为10秒。</p><p>你还可以使用CRON表达式。比如，如果你希望每小时投递1条消息，可以将CRON设置为<code>0 * * * *</code>。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span><br><span class="line">TextMessage message = session.createTextMessage(<span class="string">"test msg"</span>);</span><br><span class="line">message.setStringProperty(ScheduledMessage.AMQ_SCHEDULED_CRON, <span class="string">"0 * * * *"</span>);</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure></p><p>CRON表达式的优先级高于另外的几个参数，如果在设置了CRON的同时，也有repeat和period参数，则会在每次CRON执行时，重复投递repeat次，每次的间隔为period。</p><p>比如每小时投递10次消息，延迟1秒后开始，每次间隔1秒：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span><br><span class="line">TextMessage message = session.createTextMessage(<span class="string">"test msg"</span>);</span><br><span class="line">message.setStringProperty(ScheduledMessage.AMQ_SCHEDULED_CRON, <span class="string">"0 * * * *"</span>);</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, <span class="number">1000</span>);</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD, <span class="number">1000</span>);</span><br><span class="line">message.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT, <span class="number">9</span>);</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://activemq.apache.org/delay-and-schedule-message-delivery.html">http://activemq.apache.org/delay-and-schedule-message-delivery.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之消息分发策略</title>
      <link href="/2019/03/21/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E7%AD%96%E7%95%A5/"/>
      <url>/2019/03/21/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E5%88%86%E5%8F%91%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="分发策略"><a href="#分发策略" class="headerlink" title="分发策略"></a>分发策略</h2><h3 id="queue的分发策略"><a href="#queue的分发策略" class="headerlink" title="queue的分发策略"></a>queue的分发策略</h3><p>可插拔的分发策略只适用于topic。queue的分发策略比较固定：轮询（默认）或按照严格顺序。同时我们也应该了解<a href="http://activemq.apache.org/what-is-the-prefetch-limit-for.html">prefect</a>的意义。</p><p>ActiveMQ的prefetch缺省参数是针对处理大量消息时的高性能和高吞吐量而设置的，因此默认的prefect值很大，默认的分发策略会尽快尝试将预取缓冲区填满（prefetch buffers）。</p><p>然而在有些情况下，例如只有少量的消息而且单个消息的处理时间比较长，那么在缺省的prefetch和dispatch policies下，这些少量的消息总是倾向于被分发到个别的consumer上。这样就会因为负载的不均衡分配而导致处理时间的增加。</p><p>对于队列，你可以选择使用轮询或按严格顺序（strictOrderDispatch）。<br>strictOrderDispatch表示在直到当前消费者的prefetch缓冲区满了之后才选择下一个消费者进行消息的分发。</p><p>通过下面的方式来启用按严格顺序分发的策略：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span> <span class="attr">strictOrderDispatch</span>=<span class="string">"false"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果你有几个优先级不同的消费者，消息会先发送给优先级最高的消费者，直到它的prefect缓冲区满，然后再下一个，等等。</p><p>从5.14.0版开始——strictOrderDispatch=true选项将确保只有一个消费者时重新发送消息的顺序是严格的。</p><h3 id="topic的分发策略"><a href="#topic的分发策略" class="headerlink" title="topic的分发策略"></a>topic的分发策略</h3><p>所有实现了<code>org.apache.activemq.broker.region.policy.DispatchPolicy</code>的都可以。默认实现是<code>org.apache.activemq.broker.region.policy.SimpleDispatchPolicy</code>，它将消息传递给所有的订阅者。一个更高级的实现示例是<code>org.apache.activemq.broker.region.policy.PriorityNetworkDispatchPolicy</code>，它只会分发给拥有最高优先级的网络消费者。这在循环网络拓扑结构中非常有用，因为在这种拓扑结构中，到消费者的路由不止一条。</p><p>下面是一个<a href="http://svn.apache.org/repos/asf/activemq/trunk/activemq-unit-tests/src/test/resources/org/apache/activemq/xbean/activemq-policy.xml">Destination策略配置示例</a>。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"FOO.&gt;"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">dispatchPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">roundRobinDispatchPolicy</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dispatchPolicy</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">lastImageSubscriptionRecoveryPolicy</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"ORDERS.&gt;"</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">dispatchPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">strictOrderDispatchPolicy</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dispatchPolicy</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 1 minutes worth --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">timedSubscriptionRecoveryPolicy</span> <span class="attr">recoverDuration</span>=<span class="string">"60000"</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"PRICES.&gt;"</span>&gt;</span> </span><br><span class="line">        <span class="comment">&lt;!-- lets force old messages to be discarded for slow consumers --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">pendingMessageLimitStrategy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">constantPendingMessageLimitStrategy</span> <span class="attr">limit</span>=<span class="string">"10"</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">pendingMessageLimitStrategy</span>&gt;</span>  </span><br><span class="line">        <span class="comment">&lt;!-- 10 seconds worth --&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">timedSubscriptionRecoveryPolicy</span> <span class="attr">recoverDuration</span>=<span class="string">"10000"</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">tempTopic</span>=<span class="string">"true"</span> <span class="attr">advisoryForConsumed</span>=<span class="string">"true"</span>/&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">tempQueue</span>=<span class="string">"true"</span> <span class="attr">advisoryForConsumed</span>=<span class="string">"true"</span>/&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://activemq.apache.org/dispatch-policies.html">http://activemq.apache.org/dispatch-policies.html</a><br>参考：<a href="https://blog.51cto.com/1754966750/1923299">https://blog.51cto.com/1754966750/1923299</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之订阅恢复策略</title>
      <link href="/2019/03/21/ActiveMQ%E4%B9%8B%E8%AE%A2%E9%98%85%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5/"/>
      <url>/2019/03/21/ActiveMQ%E4%B9%8B%E8%AE%A2%E9%98%85%E6%81%A2%E5%A4%8D%E7%AD%96%E7%95%A5/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>生产者在某个topic发送了多条消息后，这个时候非持久订阅者才订阅，那么它是不能获取之前生产者发送的信息的。或者，由于网络问题，非持久类型的消费者处于非活跃状态，无法接收到生产者发送的消息。使用消息恢复策略，可以解决上面的问题。ActiveMQ目前支持一个定时或固定大小的恢复缓冲区，在你连接到broker后，在一段时间内的消息会重新发送给订阅者。</p><h2 id="ActiveMQ提供的恢复策略"><a href="#ActiveMQ提供的恢复策略" class="headerlink" title="ActiveMQ提供的恢复策略"></a>ActiveMQ提供的恢复策略</h2><ul><li>FixedSizedSubscriptionRecoveryPolicy<br>保留固定字节的消息。</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fixedSizedSubscriptionRecoveryPolicy</span> <span class="attr">maximumSize</span>=<span class="string">"1024"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>FixedCountSubscriptionRecoveryPolicy<br>保留固定数量的消息</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fixedCountSubscriptionRecoveryPolicy</span> <span class="attr">maximumSize</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>LastImageSubscriptionRecoveryPolicy<br>保留最后一条记录</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">lastImageSubscriptionRecoveryPolicy</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>NoSubscriptionRecoveryPolicy<br>禁用回溯，这是默认配置。</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noSubscriptionRecoveryPolicy</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>QueryBasedSubscriptionRecoveryPolicy<br>根据查询机制使用回溯</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">queryBasedSubscriptionRecoveryPolicy</span> <span class="attr">query</span>=<span class="string">"Color='red' AND Name='tom'"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>TimedSubscriptionRecoveryPolicy<br>保留指定时间内的消息</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">timedSubscriptionRecoveryPolicy</span> <span class="attr">recoverDuration</span>=<span class="string">"60000"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li>RetainedMessageSubscriptionRecoveryPolicy<br>保留ActiveMQ.Retain属性值为true的最后1条消息</li></ul><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">retainedMessageSubscriptionRecoveryPolicy</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：需要设置retroactive属性为true。即：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Topic topic = session.createTopic(<span class="string">"TEST.TOPIC?consumer.retroactive=true"</span>);</span><br><span class="line">MessageConsumer consumer = session.createConsumer(topic);</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://activemq.apache.org/subscription-recovery-policy.html">http://activemq.apache.org/subscription-recovery-policy.html</a><br>也可以参考：<a href="https://www.cnblogs.com/hapjin/p/5649696.html">https://www.cnblogs.com/hapjin/p/5649696.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之Prefect机制</title>
      <link href="/2019/03/21/ActiveMQ%E4%B9%8BPrefect%E6%9C%BA%E5%88%B6/"/>
      <url>/2019/03/21/ActiveMQ%E4%B9%8BPrefect%E6%9C%BA%E5%88%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>ActiveMQ的设计目标是成为一个高性能的消息总线。这意味着使用SEDA架构可以异步执行尽可能多的工作。 为了有效利用网络资源，Broker利用“推送”模型向消费者发送消息。 这可确保消费者始终拥有准备处理的消息的本地缓冲区。 替代方案是让消费者明确地从Broker那里提取消息。 单独提取消息不是非常有效，并且会增加每个消息的延迟。</p><p>但是，在不限制推送给消费者的消息数量的情况下，客户端的资源可能会被耗尽。因为消息消费通常比消息发送慢的多。为了避免这种情况，ActiveMQ使用预取限制（Prefetch Limit）来限制可以一次发送给单个消费者的最大消息数。消费者依次使用预取限制来调整其预取消息缓冲区的大小。</p><p>一旦broker向消费者发送了预取数量的消息，它将不会再向该消费者发送任何消息，直到消费者至少确认了50%的预取消息，比如prefetch size / 2。当broker收到确认后，它将向消费者发送prefect size一半的消息，以填充消费者的本地缓冲区。注意，可以为每个消费者指定预取消息数量。</p><p>在数据量较大的情况下，建议使用较大的预取值。但是，对于数据量较小的情况，每个消息需要很长时间处理，预取值应该设置为1.这可以保证消费者一次只处理一条消息。但是，将预取值设置为0将导致消费者每次轮询一条消息，而不是将消息推送给消费者。</p><ul><li>何为慢速消费者？<blockquote><p>一个消费者当前待处理的消息数量达到配置的prefetch size的2倍以上，那么该消费者就是慢速消费者。</p></blockquote></li></ul><h2 id="指定Prefect策略"><a href="#指定Prefect策略" class="headerlink" title="指定Prefect策略"></a>指定Prefect策略</h2><p>你可以在ActiveMQConnectionFactory或ActiveMQConnection上指定ActiveMQPrefectPolicy。这允许你配置单独的预取值。<br>比如：<br><img src="/img/Snipaste_2019-03-21_14-40-13.png" alt=""></p><p>如果是在AciveMQConnectionFactory上配置PrefetchPolicy，那么就是所有的Connection都使用此策略；如果是在某个ActiveMQConnection上配置，则是对此Connection起作用。</p><ul><li>持久化的queue（默认值：1000）</li><li>非持久化的queue（默认值：1000）</li><li>持久化的topic（默认值：100）</li><li>非持久化的topic（默认值：Short.MAX_VALUE-1）</li></ul><p>还可以在用来和broker建立连接的URI上配置prefect限制。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp://localhost:61616?jms.prefetchPolicy.all=50</span><br></pre></td></tr></table></figure></p><p>上面的配置表示所有的Destination的预取值限制为50.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcp://localhost:61616?jms.prefetchPolicy.queuePrefetch=1</span><br></pre></td></tr></table></figure><p>上面的配置表示所有的queue的预取值为1，即每次只推送1条消息给queue的消费者。</p><p>也可以针对某个consumer配置，比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"TEST.QUEUE?consumer.prefetchSize=10"</span>);</span><br><span class="line">consumer = session.createConsumer(queue);</span><br></pre></td></tr></table></figure></p><h2 id="消费者池与预取"><a href="#消费者池与预取" class="headerlink" title="消费者池与预取"></a>消费者池与预取</h2><p>使用消费者池消费消息时，预取将会是一个问题。未被消费的预取消息只有在消费者关闭时才会释放，但是为了池中的消费者可以被重用，关闭会被延迟到消费者池关闭。这将导致预取的消息直到消费者被重用时才会被消费。从性能角度来看，这个特性是可以被接受的。但是，当池中有多个消费者存在时，这将导致消息投递顺序错乱。 因此，org.apache.activemq.pool.PooledConnectionFactory不会对消费者进行池化。</p><p>Springs CachingConnectionFactory支持池化消费者（默认情况下关闭）。如果您在Spring的 DefaultMessageListenerContainer（DMLC）中配置了一个包含多个Consumer线程一起使用的CachingConnectionFactory，那么您要么关闭CachingConnectionFactory中的消费者池（默认情况下是关闭的），要么在使用消费者池时将预取值设置为0.这与每次调用receive(timeout)方法，消费者将使用pool的方式来获取消息。通常建议关闭Spring的CachingConnectionFactory以及任何其他允许池化JMS消费者框架中的缓存。</p><p>需要注意的是，Spring的DefaultMessageListenerContainer（DMLC）及其CACHE_CONSUMER缓存级别不受此问题的影响！Spring的DMLC在某种意义上并不池化消费者（pool consumers），即其内部并不使用由多个消费者实例组成的消费者池。相反，它会缓存消费者，也就是说，在DMLC实例的整个生命周期中，都会重用同一个JMS 消费者对象来接收所有消息。其表现很像单纯的手写JMS代码-创建JMS连接，会话，消费者，然后用这个消费者实例接收所有消息。</p><p>因此在Spring的DMLC中使用CACHE_CONSUMER是没问题的，即使是使用多个消费者线程，除非你在使用XA事务。CACHE_CONSUMER对XA事务并不生效。然而本地JMS事务和非事务性消费者在Spring的DMLC中使用CACHE_CONSUMER是没问题的。</p><p>另请注意，Camel的JMS或ActiveMQ组件在内部使用Springs DMLC。 所以关于Springs DMLC和CACHE_CONSUMER的所有内容都适用于这两个Camel组件。</p><h2 id="内存与性能的权衡"><a href="#内存与性能的权衡" class="headerlink" title="内存与性能的权衡"></a>内存与性能的权衡</h2><p>设置相对较高的预取值可以提高性能。因此，默认值通常大于1000，并且对于对于topic会更高。预取值的大小决定了客户端RAM中保存的消息个数。因此如果RAM有限，你可能需要设置一个较低的值，比如1或10等。</p><p>参考：<a href="http://activemq.apache.org/what-is-the-prefetch-limit-for.html">http://activemq.apache.org/what-is-the-prefetch-limit-for.html</a><br>参考：<a href="https://blog.csdn.net/a19881029/article/details/85730150">https://blog.csdn.net/a19881029/article/details/85730150</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之慢消费者处理</title>
      <link href="/2019/03/21/ActiveMQ%E4%B9%8B%E6%85%A2%E6%B6%88%E8%B4%B9%E8%80%85%E5%A4%84%E7%90%86/"/>
      <url>/2019/03/21/ActiveMQ%E4%B9%8B%E6%85%A2%E6%B6%88%E8%B4%B9%E8%80%85%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>慢消费者在非持久性主题上会出现问题，因为它们会强制broker为它们在内存保留旧消息。一旦填满，就会导致broker放慢生产者的速度，导致快的消费者也会变慢。</p><p>目前，有一个策略可以让你配置broker除了prefect bufer之外还将为消费者保留的最大匹配的消息数。在达到此最大值后，当新消息进入时，旧消息将被丢弃。这将允许你在内存中保留当前消息并继续向慢消费者发送消息，但会丢弃旧消息。</p><h2 id="Pending-Message-Limit-Strategy"><a href="#Pending-Message-Limit-Strategy" class="headerlink" title="Pending Message Limit Strategy"></a>Pending Message Limit Strategy</h2><p>你可以在Destination map配置PendingMessageLimitStrategy的实现类，以便不同topic有不用的策略来处理慢速消费者。例如，你可能希望将此策略引用于价格非常高的，但对于交易和订单而言，你可能不希望丢弃旧的消息。</p><p>该策略计算消费者在内存中保留的最大待处理消息数（高于prefetch size）。值为0意味着除了prefect size外不保留任何消息。大于0的值将保留该数量的消息，在新消息进入时丢弃旧的消息。值为-1表示禁止丢弃消息。</p><p>目前有两种不同的策略实现：</p><ul><li>ConstantPendingMessageLimitStrategy</li><li>PrefetchRatePendingMessageLimitStrategy</li></ul><h3 id="ConstantPendingMessageLimitStrategy"><a href="#ConstantPendingMessageLimitStrategy" class="headerlink" title="ConstantPendingMessageLimitStrategy"></a>ConstantPendingMessageLimitStrategy</h3><p>此策略对所有使用者使用常量限制（高于其预取大小）。</p><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">constantPendingMessageLimitStrategy</span> <span class="attr">limit</span>=<span class="string">"50"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="PrefetchRatePendingMessageLimitStrategy"><a href="#PrefetchRatePendingMessageLimitStrategy" class="headerlink" title="PrefetchRatePendingMessageLimitStrategy"></a>PrefetchRatePendingMessageLimitStrategy</h3><p>此种策略是将prefect size 乘以一个你配置的数来计算待处理消息的最大数量。比如，你可以为每个消费者保留大约2.5倍的prefect size的消息。</p><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">prefetchRatePendingMessageLimitStrategy</span> <span class="attr">multiplier</span>=<span class="string">"2.5"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="使用Prefect策略来配置限制"><a href="#使用Prefect策略来配置限制" class="headerlink" title="使用Prefect策略来配置限制"></a>使用Prefect策略来配置限制</h3><p>在JMS客户端，您可以为持久性的和非持久性的queue和topic配置prefect策略。prefect策略还允许为每个连接/消费者指定最大的预处理消息的数量。</p><p>prefect 策略参考：<a href="http://activemq.apache.org/what-is-the-prefetch-limit-for.html">http://activemq.apache.org/what-is-the-prefetch-limit-for.html</a></p><h3 id="配置驱逐策略"><a href="#配置驱逐策略" class="headerlink" title="配置驱逐策略"></a>配置驱逐策略</h3><p>ActiveMQ有一个MessageEvictionStrategy，用于决定哪个消息应该在慢速消费者身上被驱逐。 默认实现是：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">oldestMessageEvictionStrategy</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>这表示丢弃最旧的消息。</p><p>你还可以根据JMS消息属性来丢弃给定属性的消息。</p><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uniquePropertyMessageEvictionStrategy</span> <span class="attr">propertyName</span>=<span class="string">"STOCK"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>propertyName是为特定的价格指定的JMS消息属性。上面的示例表示移除有STOCK属性且最旧的消息。</p><p>另外，还可以删除最低优先级且最旧的消息。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">oldestMessageWithLowestPriorityEvictionStrategy</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>下面的例子展示了ActiveMQ borker的配置文件。对于PRICES.&gt;通配符范围的topic，pendingMessageLimitStrategy属性设置为仅为每个消费者保留除Prefetch size外，再保留10条消息。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:amq</span>=<span class="string">"http://activemq.apache.org/schema/core"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://activemq.apache.org/schema/core  http://activemq.apache.org/schema/core/activemq-core.xsd"</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>/&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.apache.org/schema/core"</span> <span class="attr">persistent</span>=<span class="string">"false"</span> <span class="attr">brokerName</span>=<span class="string">"$&#123;brokername&#125;"</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- lets define the dispatch policy --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"FOO.&gt;"</span>&gt;</span> </span><br><span class="line">            <span class="comment">&lt;!--消息分发策略：使用轮询策略--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dispatchPolicy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">roundRobinDispatchPolicy</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">dispatchPolicy</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!--恢复策略：只恢复最后1个消息--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">lastImageSubscriptionRecoveryPolicy</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">          <span class="comment">&lt;!--对于ORDERS.开头的topic，消息分发策略为：按顺序分发--&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"ORDERS.&gt;"</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">dispatchPolicy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">strictOrderDispatchPolicy</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">dispatchPolicy</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!-- 恢复最近1分钟内的消息 --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">timedSubscriptionRecoveryPolicy</span> <span class="attr">recoverDuration</span>=<span class="string">"60000"</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"PRICES.&gt;"</span>&gt;</span> </span><br><span class="line">            <span class="comment">&lt;!-- lets force old messages to be discarded for slow consumers --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">pendingMessageLimitStrategy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">constantPendingMessageLimitStrategy</span> <span class="attr">limit</span>=<span class="string">"10"</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">pendingMessageLimitStrategy</span>&gt;</span>  </span><br><span class="line">            <span class="comment">&lt;!-- 10 seconds worth --&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">              <span class="tag">&lt;<span class="name">timedSubscriptionRecoveryPolicy</span> <span class="attr">recoverDuration</span>=<span class="string">"10000"</span>/&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">subscriptionRecoveryPolicy</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">tempTopic</span>=<span class="string">"true"</span> <span class="attr">advisoryForConsumed</span>=<span class="string">"true"</span>/&gt;</span>  </span><br><span class="line">          <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">tempQueue</span>=<span class="string">"true"</span> <span class="attr">advisoryForConsumed</span>=<span class="string">"true"</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span> </span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">broker</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="使用技巧"><a href="#使用技巧" class="headerlink" title="使用技巧"></a>使用技巧</h2><p>如果你知道某个特定的消费者会变慢，那么设置它的prefect size小于快速消费者的大小。</p><p>例如，如果您知道特定服务器速度很慢并且您的消息速率非常高并且您有一些非常快的消费者，那么您可能希望启用此功能并将慢速服务器上的预取设置为略低于 快速服务器。</p><h3 id="监测慢消费者的状况"><a href="#监测慢消费者的状况" class="headerlink" title="监测慢消费者的状况"></a>监测慢消费者的状况</h3><p>您还可以使用JMX控制台查看活动订阅的统计信息。 这允许您在TopicSubscriptionViewMBean上查看以下统计信息：</p><table><thead><tr><th>统计信息</th><th>说明 </th></tr></thead><tbody><tr><td>discarded</td><td>在成为慢速消费者后，在订阅的生命周期中丢弃了多少条消息 </td></tr><tr><td>matched</td><td>当前匹配的消息数量，只要预取缓冲区中有一些容量可用，就会立即发送到订阅。因此，非零值意味着此订阅的预取缓冲区已满</td></tr></tbody></table><p>参考：<a href="http://activemq.apache.org/slow-consumer-handling.html">http://activemq.apache.org/slow-consumer-handling.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之定期清理离线的持久订阅者</title>
      <link href="/2019/03/20/ActiveMQ%E4%B9%8B%E5%AE%9A%E6%9C%9F%E6%B8%85%E7%90%86%E7%A6%BB%E7%BA%BF%E7%9A%84%E6%8C%81%E4%B9%85%E8%AE%A2%E9%98%85%E8%80%85/"/>
      <url>/2019/03/20/ActiveMQ%E4%B9%8B%E5%AE%9A%E6%9C%9F%E6%B8%85%E7%90%86%E7%A6%BB%E7%BA%BF%E7%9A%84%E6%8C%81%E4%B9%85%E8%AE%A2%E9%98%85%E8%80%85/</url>
      
        <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>通常，我们不希望系统中存在长时间离线的持久订阅者，因为Broker需要为它们保留它们订阅的topic的所有消息。而且随着时间的推移，将会导致达到存储限制，从而导致系统变慢。</p><p>当然，你可以通过JConsole或Web Console等管理工具来手动取消不活跃的持久订阅者。但显然可以餐区更多措施来帮助管理。</p><h2 id="过期消息"><a href="#过期消息" class="headerlink" title="过期消息"></a>过期消息</h2><p>一些应用程序发送的消息有一定的过期时间。如果这些消息存储在Broker上供离线的持久订阅者使用，我们需要在它们到期时将其删除。就像我们的队列一样，现在默认是每30秒检查一次这些消息，可以使用适当的目标策略进行调整。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span> <span class="attr">expireMessagesPeriod</span>=<span class="string">"300000"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>如上配置，broker每5分钟检查一次过期的消息。</p><h2 id="移除不活跃的订阅者"><a href="#移除不活跃的订阅者" class="headerlink" title="移除不活跃的订阅者"></a>移除不活跃的订阅者</h2><p>我们可以自动取消在一段时间内不活跃的持久订阅者。</p><p>配置示例如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">name</span>=<span class="string">"localhost"</span> <span class="attr">offlineDurableSubscriberTimeout</span>=<span class="string">"86400000"</span> <span class="attr">offlineDurableSubscriberTaskSchedule</span>=<span class="string">"3600000"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><table><thead><tr><th>属性</th><th style="text-align:left">默认值</th><th style="text-align:left">描述  </th></tr></thead><tbody><tr><td>offlineDurableSubscriberTimeout</td><td style="text-align:left">-1</td><td style="text-align:left">我们删除非活动持久性订阅者的时间（以毫秒为单位）。 默认值-1，表示不删除它们</td></tr><tr><td>offlineDurableSubscriberTaskSchedule</td><td style="text-align:left">300000</td><td style="text-align:left">检查频率（以毫秒为单位） </td></tr></tbody></table><p>上面的配置示例，表明broker会每小时检查并删除已离线1天的订阅者。</p><p>参考：<a href="http://activemq.apache.org/manage-durable-subscribers.html">http://activemq.apache.org/manage-durable-subscribers.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ的消息重发与死信处理</title>
      <link href="/2019/03/20/ActiveMQ%E7%9A%84%E6%B6%88%E6%81%AF%E9%87%8D%E5%8F%91%E4%B8%8E%E6%AD%BB%E4%BF%A1%E5%A4%84%E7%90%86/"/>
      <url>/2019/03/20/ActiveMQ%E7%9A%84%E6%B6%88%E6%81%AF%E9%87%8D%E5%8F%91%E4%B8%8E%E6%AD%BB%E4%BF%A1%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>在发生以下情形时，消息会给重发给客户端：</p><ol><li>使用了一个事务性的会话且调用了rollback()方法。</li><li>在调用commit()方法前一个事务性的会话被关闭了。</li><li>一个会话使用<strong>CLIENT_ACKNOWLEDGE</strong>的ACK模式，且调用了Session.recover()方法。</li><li>一个客户端连接超时（可能正被执行的代码执行的时间超过配置的超时时间）。</li></ol><p>客户端可以通过<code>ActiveMQConnection.getRedeliveryPolicy()</code> 或 <code>ActiveMQConnectionFactory.getRedeliveryPolicyMap()</code>来覆盖策略设置。</p><p>方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">RedeliveryPolicy policy = connection.getRedeliveryPolicy();</span><br><span class="line">policy.setInitialRedeliveryDelay(<span class="number">500</span>);</span><br><span class="line">policy.setBackOffMultiplier(<span class="number">2</span>);</span><br><span class="line">policy.setUseExponentialBackOff(<span class="keyword">true</span>);</span><br><span class="line">policy.setMaximumRedeliveries(<span class="number">2</span>);</span><br></pre></td></tr></table></figure></p><p>当一个消息被redelivered超过maximumRedeliveries(缺省为6次，具体设置请参考后面的链接)次数时，会给broker发送一个”Poison ack”，这个消息被认为是a poison pill，这时broker会将这个消息发送到DLQ，以便后续处理。 </p><p>缺省的死信队列是ActiveMQ.DLQ，所有不能投递的消息都会被发送到这个队列，这将会导致难以管理。你可以在activemq.xml这个配置文件的<code>destinationPolicy</code>配置<code>individualDeadLetterStrategy</code> ，它可以让给为一个给定的queue或topic指定特定的死信队列前缀。如果你希望所有的queue都拥有自己的死信队列，你可以使用通配符。</p><p>示例：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 使用&gt;通配符为所有的queue设置下面的策略 你也可以指定具体的队列名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">              queuePrefix:指定死信队列的前缀为DLQ.</span></span><br><span class="line"><span class="comment">              useQueueForQueueMessages=true，表示使用队列来保存死信</span></span><br><span class="line"><span class="comment">            --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">individualDeadLetterStrategy</span> <span class="attr">queuePrefix</span>=<span class="string">"DLQ."</span> <span class="attr">useQueueForQueueMessages</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="自动丢弃过期消息"><a href="#自动丢弃过期消息" class="headerlink" title="自动丢弃过期消息"></a>自动丢弃过期消息</h2><p>如果你只想丢弃过期的消息，不想发送到死信队列，你可以在一个死信队列策略中配置<code>processExpired=false</code>。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- 使用&gt;通配符来使所有的队列使用下面的策略 --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">           Tell the dead letter strategy not to process expired messages</span></span><br><span class="line"><span class="comment">           so that they will just be discarded instead of being sent to</span></span><br><span class="line"><span class="comment">           the DLQ</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">sharedDeadLetterStrategy</span> <span class="attr">processExpired</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="非持久消息保存到死信队列"><a href="#非持久消息保存到死信队列" class="headerlink" title="非持久消息保存到死信队列"></a>非持久消息保存到死信队列</h2><p>默认情况下，ActiveMQ不会将不能投递的非持久消息放到死信队列。如果你希望将非持久消息存储到死信队列，你可以在死信队列的策略中设置<code>processNonPersistent=&quot;true&quot;</code>。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- Set the following policy on all queues using the '&gt;' wildcard --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span>&gt;</span></span><br><span class="line">         <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">           Tell the dead letter strategy to also place non-persisted messages</span></span><br><span class="line"><span class="comment">           onto the dead-letter queue if they can't be delivered.</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">sharedDeadLetterStrategy</span> <span class="attr">processNonPersistent</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="设置死信队列中消息的过期时间"><a href="#设置死信队列中消息的过期时间" class="headerlink" title="设置死信队列中消息的过期时间"></a>设置死信队列中消息的过期时间</h2><p>默认情况下，ActiveMQ永远不会使发送到DLQ的消息失效。 但是，在ActiveMQ 5.12中，deadLetterStrategy支持到期属性，其值以毫秒为单位。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">   </span><br><span class="line">  <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"QueueWhereItIsOkToExpireDLQEntries"</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">....</span> <span class="attr">expiration</span>=<span class="string">"300000"</span>/&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">   </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="DLQ丢弃插件"><a href="#DLQ丢弃插件" class="headerlink" title="DLQ丢弃插件"></a>DLQ丢弃插件</h2><p>从ActiveMQ5.9开始，一个Destination的<code>policyEntry</code>支持丢弃的deadLetterStrategy。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">discarding</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这个与丢弃插件的功能相同，但这个是基于每个Destination的。丢弃插件支持正则表达式匹配，这在某些情况下很有用。</p><p>此插件允许全部或基于Java SE的正则表达式匹配的queue和topic，丢弃发送到DLQ中的消息。这在使用ConstantPendingMessageLimit策略或其他逐出规则，但不想有一个其他的消费者来清理DLQ时很有用。</p><p>下面是一个丢弃所有内容的一个基本配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">discardingDLQBrokerPlugin</span> <span class="attr">dropAll</span>=<span class="string">"true"</span> <span class="attr">dropTemporaryTopics</span>=<span class="string">"true"</span>            <span class="attr">dropTemporaryQueues</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>下面是一个稍微复杂点的例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">discardingDLQBrokerPlugin</span> <span class="attr">dropOnly</span>=<span class="string">"MY.EXAMPLE.TOPIC.29 MY.EXAMPLE.QUEUE.87"</span> <span class="attr">reportInterval</span>=<span class="string">"1000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这个例子中，只针对指定的queue和topic有效。各个destination用空格隔开。<br>reportInterval属性用于表示我们输出丢弃的消息的频率 - 使用0来禁用。</p><p>下面是一个使用正则表达式的例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">broker</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">discardingDLQBrokerPlugin</span> <span class="attr">dropOnly</span>=<span class="string">"MY.EXAMPLE.TOPIC.[0-9]&#123;3&#125; MY.EXAMPLE.QUEUE.[0-9]&#123;3&#125;"</span> <span class="attr">reportInterval</span>=<span class="string">"3000"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这里匹配的是以000~999结尾的目的地。</p><h2 id="Broker消息重发插件"><a href="#Broker消息重发插件" class="headerlink" title="Broker消息重发插件"></a>Broker消息重发插件</h2><p>默认情况下，在消息重新投递次数达到配置的最大投递次数（或默认的6次），broker会将消息放入DLQ。我们可以使用broker消息重发插件来改变这一行为。即在一定延迟后，将消息重新投递给原始Destination，如果达到最大重试次数，则放入DLQ。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">schedulerSupport</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">         </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 重发策略，对于超过重发次数的消息将会被添加到DLQ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">redeliveryPlugin</span> <span class="attr">fallbackToDeadLetter</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">                              <span class="attr">sendToDlqIfMaxRetriesExceeded</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">redeliveryPolicyMap</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">redeliveryPolicyMap</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">redeliveryPolicyEntries</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                                重发机制，默认重发6，重发延迟基于backOff模式</span></span><br><span class="line"><span class="comment">                            --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">redeliveryPolicy</span> <span class="attr">queue</span>=<span class="string">"SpecialQueue"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">maximumRedeliveries</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">redeliveryDelay</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">redeliveryPolicyEntries</span>&gt;</span></span><br><span class="line">                         </span><br><span class="line">                        <span class="tag">&lt;<span class="name">defaultEntry</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 其他Destination的默认处理策略 --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">redeliveryPolicy</span> <span class="attr">maximumRedeliveries</span>=<span class="string">"4"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">initialRedeliveryDelay</span>=<span class="string">"5000"</span></span></span><br><span class="line"><span class="tag">                                              <span class="attr">redeliveryDelay</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">defaultEntry</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">redeliveryPolicyMap</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">redeliveryPolicyMap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">redeliveryPlugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">         </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure><p>sendToDlqIfMaxRetriesExceeded：如果为true，则在达到最大重试次数后，会发送到DLQ，否则会删除该消息。</p><p>参考：<a href="http://activemq.apache.org/message-redelivery-and-dlq-handling.html">http://activemq.apache.org/message-redelivery-and-dlq-handling.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ常见问题</title>
      <link href="/2019/03/19/ActiveMQ%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/"/>
      <url>/2019/03/19/ActiveMQ%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<h2 id="1-服务挂掉"><a href="#1-服务挂掉" class="headerlink" title="1.服务挂掉"></a>1.服务挂掉</h2><ol><li>设置mq的storeUsage为1M，生产者不断发送持久化消息，消费者每隔5秒接收1条消息。<br>在达到配置的使用限制后，broker会停止producer。此时生产者阻塞，但消费者可正常连接并消费消息，等消息消费掉一部分，文件删除又腾出空间之后，生产者又可继续发送消息，服务自动恢复正常。activeMQ控制台输出如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jvm 1    |  INFO | Usage(default:store:queue://myQueue:store) percentUsage=99%, usage=1054753, limit=1048576,</span><br><span class="line">percentUsageMinDelta=1%;Parent:Usage(default:store) percentUsage=100%, usage=1054753, limit=1048576, percentUs</span><br><span class="line">ageMinDelta=1%: Persistent store is Full, 100% of 1048576. Stopping producer (ID:QINCD125-D-11620-155298730527</span><br><span class="line">6-1:1:1:1) to prevent flooding queue://myQueue. See http://activemq.apache.org/producer-flow-control.html for</span><br><span class="line">more info (blocking for: 32s)</span><br></pre></td></tr></table></figure></li></ol><p>第一次是2s，第二次是32s，后面每次增加30s。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ之消息选择器（Message Selectors）</title>
      <link href="/2019/03/19/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E9%80%89%E6%8B%A9%E5%99%A8%EF%BC%88Message%20Selectors%EF%BC%89/"/>
      <url>/2019/03/19/ActiveMQ%E4%B9%8B%E6%B6%88%E6%81%AF%E9%80%89%E6%8B%A9%E5%99%A8%EF%BC%88Message%20Selectors%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<p>JMS Selectors用在获取消息的时候，可以基于消息属性和Xpath语法对消息进行过滤。JMS Selectors由SQL92语义定义。以下是个Selectors的例子：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer = session.createConsumer(destination, <span class="string">"JMSType = 'car' AND weight &gt; 2500"</span>);</span><br></pre></td></tr></table></figure></p><p>1：JMS Selectors表达式中，可以使用IN、NOT IN、LIKE等</p><p>2：需要注意的是，JMS Selectors表达式中的日期和时间需要使用标准的long型毫秒值</p><p>3：表达式中的属性不会自动进行类型转换，例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myMessage.setStringProperty(<span class="string">"NumberOfOrders"</span>, <span class="string">"2"</span>);</span><br></pre></td></tr></table></figure></p><p>  那么此时“NumberOfOrders &gt; 1” 求值结果会是false</p><p>4：Message Groups虽然可以保证具有相同message group的消息被唯一的consumer顺序处理，但是却不能确定被哪个consumer处理。在某些情况下，Message Groups可以和JMS Selector一起工作，</p><p>例如：</p><p> 设想有三个consumers分别是A、B和C。你可以在producer中为消息设置三个message groups分别是“A”、“B”和“C”。然后令consumer A使用“JMXGroupID = ‘A’”作为selector。B和C也同理。这样就可以保证message group A的消息只被consumer A处理。需要注意的是，这种做法有以下缺点：</p><p>（1）producer必须知道当前正在运行的consumers，也就是说producer和consumer被耦合到一起。</p><p>（2）如果某个consumer失效，那么应该被这个consumer消费的消息将会一直被积压在broker上。</p><p>下面我们使用JMS Selectors来实现消息分组功能</p><ul><li><p>消息生产者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">TextMessage msg = session.createTextMessage(<span class="string">"hello "</span> + i);</span><br><span class="line"><span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">msg.setStringProperty(<span class="string">"JMSXGroupID"</span>,<span class="string">"groupA"</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">msg.setStringProperty(<span class="string">"JMSXGroupID"</span>,<span class="string">"groupB"</span>);</span><br><span class="line">producer.send(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>消费者1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MessageConsumer consumer = session.createConsumer(destination,<span class="string">"JMSXGroupID='groupA'"</span>);</span><br><span class="line">consumer.setMessageListener(msg -&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">System.out.println(<span class="string">"Received msg:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">&#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li><li><p>消费者2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MessageConsumer consumer = session.createConsumer(destination,<span class="string">"JMSXGroupID='groupB'"</span>);</span><br><span class="line">consumer.setMessageListener(msg -&gt; &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">System.out.println(<span class="string">"Received msg:"</span> + ((TextMessage)msg).getText());</span><br><span class="line">&#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li></ul><p>消费者1控制台输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Received msg:hello 0</span><br><span class="line">Received msg:hello 2</span><br><span class="line">Received msg:hello 4</span><br><span class="line">Received msg:hello 6</span><br><span class="line">Received msg:hello 8</span><br></pre></td></tr></table></figure></p><p>消费者2控制台输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Received msg:hello 1</span><br><span class="line">Received msg:hello 3</span><br><span class="line">Received msg:hello 5</span><br><span class="line">Received msg:hello 7</span><br><span class="line">Received msg:hello 9</span><br></pre></td></tr></table></figure></p><p>参考：《ActiveMQ in Action》、<a href="https://blog.51cto.com/1754966750/1924922">ActiveMQ（23）：Consumer高级特性</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ请求回复</title>
      <link href="/2019/03/16/ActiveMQ%E8%AF%B7%E6%B1%82%E5%9B%9E%E5%A4%8D%E6%A8%A1%E5%BC%8F/"/>
      <url>/2019/03/16/ActiveMQ%E8%AF%B7%E6%B1%82%E5%9B%9E%E5%A4%8D%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<p>JMS支持Request/Reply模式，在消息生产者发送消息时设置回复消息的目的地，在Consumer接收到消息后，可以回复消息。</p><a id="more"></a><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* jms请求回复模式。producer发送消息到某个Destination，在发送时设置回复的目的地，consumer在接收到消息后可以在回复的目的地回复消息。</span></span><br><span class="line"><span class="comment">* @author Donny</span></span><br><span class="line"><span class="comment">* @email luckystar88@aliyun.com</span></span><br><span class="line"><span class="comment">* @date 2019/03/16 17:39</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReplyToMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String sendQueue = <span class="string">"testQueue"</span>;</span><br><span class="line">        <span class="keyword">final</span> String replyQueue = <span class="string">"replyQueue"</span>;</span><br><span class="line">        ActiveMQConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">        Connection connection = <span class="keyword">null</span>;</span><br><span class="line">        Session session = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = factory.createConnection();</span><br><span class="line">            connection.start();</span><br><span class="line">            session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">            <span class="comment">// 发送目的地</span></span><br><span class="line">            Queue sendQ = session.createQueue(sendQueue);</span><br><span class="line">            Queue replyQ = session.createQueue(replyQueue);</span><br><span class="line">            MessageProducer producer = session.createProducer(sendQ);</span><br><span class="line">            TextMessage msg = session.createTextMessage(<span class="string">"hello,this is a message."</span>);</span><br><span class="line">            <span class="comment">// 设置消息回复的目的地</span></span><br><span class="line">            msg.setJMSReplyTo(replyQ);</span><br><span class="line">            producer.send(msg);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 消息消费者，监听sendQ</span></span><br><span class="line">            MessageConsumer consumer = session.createConsumer(sendQ);</span><br><span class="line">            Session _session = session;</span><br><span class="line">            consumer.setMessageListener(message -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Consumer received msg:"</span> + ((TextMessage)(message)).getText());</span><br><span class="line">                    <span class="comment">// 回复消息</span></span><br><span class="line">                    MessageProducer mp = _session.createProducer(replyQ);</span><br><span class="line">                    TextMessage replyMsg = _session.createTextMessage(<span class="string">"hello,message is received."</span>);</span><br><span class="line">                    mp.send(replyMsg);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 监听回复的消息目的地</span></span><br><span class="line">            MessageConsumer replyMC = session.createConsumer(replyQ);</span><br><span class="line">            replyMC.setMessageListener(message -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">"Consumer2 received reply msg:"</span> +((TextMessage)(message)).getText());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JMSException | IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>控制打印如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Consumer received msg:hello,this is a message.</span><br><span class="line">Consumer2 received reply msg:hello,message is received.</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> jms </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ顺序消费消息+消息分组</title>
      <link href="/2019/03/16/ActiveMQ%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF+%E6%B6%88%E6%81%AF%E5%88%86%E7%BB%84/"/>
      <url>/2019/03/16/ActiveMQ%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E6%B6%88%E6%81%AF+%E6%B6%88%E6%81%AF%E5%88%86%E7%BB%84/</url>
      
        <content type="html"><![CDATA[<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>Queue中的消息是按照顺序发送给Consumers的。然而，当你有多个Consumer同时从相同的Queue提取消息时，顺序将不能得到保证。因为这些消息时被多个线程并发的处理。但是，有时候保证消息的顺序是很重要的。例如，你可能不希望插入订单操作结束之前执行更新订单的操作。那么我们可以通过Exclusive Consumer和Message Groups来实现这一目的。</p><h3 id="独有消费者"><a href="#独有消费者" class="headerlink" title="独有消费者"></a>独有消费者</h3><p>从ActiveMQ4.X版本开始支持ExclusiveConsumer（或者说是Exclusive Queues）。Broker会从多个Consumer中挑选一个Consumer来处理所有的消息，从而保证消息的有序处理。如果这个Consumer失效，那么Broker会自动切换到其他的Consumer。<br><a id="more"></a><br>可以通过Destination的Option来创建一个Exclusive Consumer，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"Test.Queue?consumer.exclusive=true"</span>);</span><br><span class="line">consumer = session.createConsumer(queue);</span><br></pre></td></tr></table></figure></p><p>另外，还可以给Consumer设置优先级，以便针对网络情况进行优化。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queue = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"Test.Queue?consumer.exclusive=true&amp;consumer.priority=10"</span>);</span><br></pre></td></tr></table></figure></p><h3 id="消息分组"><a href="#消息分组" class="headerlink" title="消息分组"></a>消息分组</h3><p>从Apache官方文档的话说，是Exclusive Consumer功能的增强。逻辑上，可以看成是一种并发的Exclusive Consumer。JMS消息属性JMXGroupID被用来区分Message Group。Message Groups特性保证所有具有相同JMSGroupID的消息会被分发到相同的Consumer（只要这个Consumer保持Active）。另一方面，Message Groups也是一种负载均衡的机制。</p><p>在一个消息被分发到Consumer前，Broker会检查消息的JMSGroupID属性。如果存在，那么broker会检查是否有某个Consumer拥有这个Message Group。如果没有，那么broker会选择一个Consumer，并将它关联到这个Message Group。此后，这个Consumer会接收这个Message Group的所有消息。直到：</p><ul><li>Consumer被关闭。</li><li>Message Group被关闭。通过发送一个消息，并设置这个消息的JMSXGroupSeq为-1.</li></ul><p>从4.1版本开始，ActiveMQ支持一个布尔字段JMSXGroupFirstForConsumer 。当某个message group的第一个消息被发送到consumer的时候，这个字段被设置。如果客户使用failover transport连接到broker。在由于网络问题等造成客户重新连接到broker的时候，相同message group的消息可能会被分发到不同与之前的consumer，因此JMSXGroupFirstForConsumer字段也会被重新设置。  </p><h4 id="创建一个Message-Groups"><a href="#创建一个Message-Groups" class="headerlink" title="创建一个Message Groups"></a>创建一个Message Groups</h4><p>创建一个Message Groups，只需要在Message对象上设置属性即可。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Message message = session.createTextMessage(<span class="string">"hello,world"</span>);</span><br><span class="line">message.setStringProperty(<span class="string">"JMSXGroupID"</span>,<span class="string">"GroupA"</span>);</span><br><span class="line">...</span><br><span class="line">producer.send(message);</span><br></pre></td></tr></table></figure></p><h4 id="关闭一个Message-Groups"><a href="#关闭一个Message-Groups" class="headerlink" title="关闭一个Message Groups"></a>关闭一个Message Groups</h4><p>关闭一个Message Group，也只需要在Message对象上设置相应的属性即可。如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">message.setStringProperty(<span class="string">"JMSXGroupID"</span>,<span class="string">"GroupA"</span>);</span><br><span class="line">message.setIntProperty(<span class="string">"JMSXGroupSeq"</span>, -<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ集群搭建</title>
      <link href="/2019/03/16/ActiveMQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
      <url>/2019/03/16/ActiveMQ%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>activemq提供了多种方式来保证activemq的可靠性。<br>包括：</p><ul><li>纯Master/Slave </li><li>Shared File System Master Slave</li><li>JDBC Master Slave</li><li>Broker clusters-静态</li><li>Broker clusters-动态（基于组播，动态发现brokers）</li></ul><p>但单纯的使用上面的一种没法既达到高可用，同时有具有负载均衡的能力。</p><h2 id="生产环境集群搭建建议"><a href="#生产环境集群搭建建议" class="headerlink" title="生产环境集群搭建建议"></a>生产环境集群搭建建议</h2><p>所以可以考虑Master/Slave+Broker clusters-静态来实现。Master/Slave保证了Slave复制master的数据，Broker clusters-静态实现了非消息生产者的broker拥有对外提供消费的能力。即在broker1上生产了消息，如果broker1与broker2配置了static network Connectors，那么客户端监听broker2也可以拿到broker1生产的消息。所以生产环境建议二者集合。<br><a id="more"></a><br>生产环境：</p><ul><li><p>如果数据量不大，可以考虑Zookeeper来搭建Master/Slave。<br>由于ZK选举至少需要2N+1个节点，所以mq至少要3个节点。如果生产消息的broker挂掉，ZK会从其他的节点选择一个作为Master。客户端使用failover会自动连接到提升为Master的节点，消费挂掉的broker的消息没有问题。</p></li><li><p>数据量比较大，考虑Zookeeper+静态网络连接来实现高可用与负载均衡能力。<br>比如2个ZK（假定分别为zk1和zk2），每个ZK分别管理1组（3台）MQ节点。这样启动全部的MQ节点，2组MQ节点中会分别有1台Master对外提供服务。然后2组MQ之间通过static network Connectors+duplex=true来实现failover功能。</p></li></ul><p>配置1：<br><img src="https://app.yinxiang.com/shard/s64/nl/13987728/a5337336-4489-482f-9cde-5531127a51a2/res/7ae0ffda-501f-40be-a4f1-19823127319b.png?resizeSmall&amp;width=832" alt=""><br>这种配置，一个缺点就是没有保障ZK的高可用。</p><p>如果希望ZK也高可用，则每组ZK至少配置3个ZK节点（ZN+1原则）。<br>比如下面的配置2组ZK+2组MQ。</p><table><thead><tr><th>作用</th><th style="text-align:left">openwire端口</th><th style="text-align:left">admin端口</th><th style="text-align:left">zk端口</th><th style="text-align:left">组 </th></tr></thead><tbody><tr><td>mq1</td><td style="text-align:left">61616</td><td style="text-align:left">8161</td><td style="text-align:left">zk1,2,3的2181,2182,2183</td><td style="text-align:left">Group1  </td></tr><tr><td>mq2</td><td style="text-align:left">61617</td><td style="text-align:left">8162</td><td style="text-align:left">zk1,2,3的2181,2182,2183</td><td style="text-align:left">Group1  </td></tr><tr><td>mq3</td><td style="text-align:left">61618</td><td style="text-align:left">8163</td><td style="text-align:left">zk1,2,3的2181,2182,2183</td><td style="text-align:left">Group1  </td></tr><tr><td>mq4</td><td style="text-align:left">61616</td><td style="text-align:left">8161</td><td style="text-align:left">zk4,5,6的2181,2182,2183</td><td style="text-align:left">Group2  </td></tr><tr><td>mq5</td><td style="text-align:left">61617</td><td style="text-align:left">8162</td><td style="text-align:left">zk4,5,6的2181,2182,2183</td><td style="text-align:left">Group2  </td></tr><tr><td>mq6</td><td style="text-align:left">61618</td><td style="text-align:left">8163</td><td style="text-align:left">zk4,5,6的2181,2182,2183</td><td style="text-align:left">Group2  </td></tr><tr><td>zk1</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2181</td><td style="text-align:left">Group1  </td></tr><tr><td>zk2</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2182</td><td style="text-align:left">Group1  </td></tr><tr><td>zk3</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2183</td><td style="text-align:left">Group1  </td></tr><tr><td>zk4</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2181</td><td style="text-align:left">Group2  </td></tr><tr><td>zk5</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2182</td><td style="text-align:left">Group2  </td></tr><tr><td>zk6</td><td style="text-align:left">/</td><td style="text-align:left">/</td><td style="text-align:left">2183</td><td style="text-align:left">Group2  </td></tr></tbody></table><p>这里假定Group1和Group2是2台机器，ZK1和ZK2为2台机器。其中，mq1-3为Group1，zkAddress=zk1:2181,zk2:2182,zk3:2183.mq4-6为Group2，zkAddress=zk4:2181,zk5:2182,zk6:2183.注意：6台MQ的brokerName必须全部一样。</p><p>当然了，你还可以继续扩展，比如3组ZK+3组MQ，这样同时对外提供服务的MQ就是3台。</p><h2 id="关键配置"><a href="#关键配置" class="headerlink" title="关键配置"></a>关键配置</h2><h3 id="1-ZK集群搭建"><a href="#1-ZK集群搭建" class="headerlink" title="1.ZK集群搭建"></a>1.ZK集群搭建</h3><p>那一组ZK来说<br>在该组ZK的根目录创建data目录，然后创建3个子目录，名字分别为1,2,3，在每个子目录下面创建myid文件，内容与目录名字相同（即如果属于目录1，则内容为1）。</p><p>在每个ZK节点的配置文件zoo.cfg中最后加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.1=127.0.0.1:2887:3887</span><br><span class="line">server.2=127.0.0.1:2888:3888</span><br><span class="line">server.3=127.0.0.1:2889:3889</span><br></pre></td></tr></table></figure></p><p>每个ZK节点的dataDir指向它所属的data目录。比如ZK1的dataDir=/usr/local/zookeeper/data/1。其中/usr/local/zookeeper是该组ZK集群的根目录。</p><h3 id="2-ActiveMQ集群配置"><a href="#2-ActiveMQ集群配置" class="headerlink" title="2.ActiveMQ集群配置"></a>2.ActiveMQ集群配置</h3><p>打开activemq.xml，修改或加入如下内容：</p><ol><li>修改brokerName；</li><li><persistenceAdapter>中的内容为：<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!-- &lt;kahaDB directory="$&#123;activemq.data&#125;/kahadb"/&gt;--&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">replicatedLevelDB</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">directory</span>=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span> </span></span><br><span class="line"><span class="tag">               <span class="attr">replicas</span>=<span class="string">"3"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">bind</span>=<span class="string">"tcp://0.0.0.0:0"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">zkAddress</span>=<span class="string">"127.0.0.1:2181,127.0.0.1:2181,127.0.0.1:2183"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">zkPassword</span>=<span class="string">""</span></span></span><br><span class="line"><span class="tag">               <span class="attr">zkPath</span>=<span class="string">"/activemq-cluster/leveldb-stores/group1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">hostname</span>=<span class="string">"vm1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">sync</span>=<span class="string">"local_disk"</span>/&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>此处需注意：replicas是MQ节点的数量，需要为2N+1.zkAddress指定ZK集群的地址，多个地址用逗号分隔，zkPath保证不与其他ZK组的path一样（如果2组ZK在不同的机器可以忽略），否则会导致选举Master出现问题，因为各个ZK组都查找到了相同的节点。</p><ol start="3"><li>修改transportConnector<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">"openwire"</span> <span class="attr">uri</span>=<span class="string">"tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>一个是修改openwrie的端口，然后把其他协议的注释掉。（这里根据需要，只保留使用的协议）。</p><ol start="4"><li>增加static network Connector配置<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">networkConnectors</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">networkConnector</span> <span class="attr">uri</span>=<span class="string">"static:(tcp://192.168.199.199:61619,tcp://192.168.199.199:61620,tcp://192.168.199.199:61621)"</span> <span class="attr">duplex</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">networkConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><p>这里的IP和端口是其他Group的IP和端口。因为你希望在Group1生产的数据在Group2的节点能够消费，反之亦然。所以这里配置的是其他组的IP和端口。另外，需要配置duplex=true。否则，比如Group1的mq1生产消息，然后停止mq1，此时消费者连接上Group2，是没法消费消息的。配置上duplex=true，就可以保证在Group2也能消费到Group1生产的消息。反之亦然。</p><ol start="5"><li><p>修改每个mq的管理端口<br>修改jetty.xml中的port即可。</p></li><li><p>应用程序配置<br>程序使用failover来连接broker。<br>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> String uris = </span><br><span class="line"><span class="string">"failover:(tcp://192.168.199.199:61616,tcp://192.168.199.199:61617,tcp://192.168.199.199:61618,"</span> +        </span><br><span class="line"><span class="string">"tcp://192.168.199.199:61619,tcp://192.168.199.199:61620,tcp://192.168.199.199:61621)"</span> +        </span><br><span class="line"><span class="string">"?randomize=true&amp;initialReconnectDelay=1000&amp;maxReconnectDelay=30000"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> String MQ_USERNAME = <span class="string">"admin"</span>;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> String MQ_PASSWORD = <span class="string">"admin"</span>;</span><br></pre></td></tr></table></figure></li></ol><p>上面配置完毕后，先启动各个ZK，没问题再启动各个MQ节点。观察日志输出，每组ZK只会有一个是Master，其他是Slave。每组MQ只会有一个是Master，其他是Slave。</p><p>配置完毕后，将MQ的openwire的端口对外开放，程序就可以访问了。</p><h2 id="集群测试"><a href="#集群测试" class="headerlink" title="集群测试"></a>集群测试</h2><ol><li>测试某组MQ节点之间数据是否正常（测试Master/Slave功能）；<br>生产者和消费者都使用failover连接所有MQ节点，生产者发送消息。消息发送完毕后，将发送消息的MQ节点停掉，然后消费者连接发送消息的MQ所在组的其他MQ节点，看是否正常消费消息。<br>比如Group1节点分别为mq1,mq2,mq3，假定发送消息的MQ节点是mq1，那么发送消息完毕后，停掉mq1.然后启动消费者，看消费者能否消费消息。这里生产者和消费者都使用failover连接mq1,mq2,mq3.</li></ol><ol start="2"><li>测试组间数据是否正常（测试Static NetWork Connector功能）。<br>生产者与#1一致，发送消息后关闭该mq节点。消费者使用failover连接另外一组MQ，看是否能够消费消息。</li></ol><p>各种MQ集群配置参考：<a href="https://blog.csdn.net/aa1215018028/article/details/82700872">ActiveMQ集群搭建详解</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Apache HttpClient进行https调用</title>
      <link href="/2019/02/16/%E4%BD%BF%E7%94%A8Apache%20HttpClient%E8%BF%9B%E8%A1%8Chttps%E8%B0%83%E7%94%A8/"/>
      <url>/2019/02/16/%E4%BD%BF%E7%94%A8Apache%20HttpClient%E8%BF%9B%E8%A1%8Chttps%E8%B0%83%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文使用的Apache HttpClient版本为4.5.6.</p><p>在使用Apache HttpClient执行https请求时，有时会遇到ssl相关的异常，这里介绍如何通过HttpClient执行https请求。</p><p>这里有2种方式：忽略ssl证书并信任任意连接 和 导入证书到秘钥库。</p><h2 id="忽略ssl证书并信任任意连接"><a href="#忽略ssl证书并信任任意连接" class="headerlink" title="忽略ssl证书并信任任意连接"></a>忽略ssl证书并信任任意连接</h2><p>ssl初始化时需要证书管理器(TrustManager)，我们这里使用了一个实现了X509TrustManager的证书管理器。它不做证书的验证，并信任任意的连接。<br>然后通过HttpClients的setSSLSocketFactory()设置SSLSocketFactory即可。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientFactory</span> </span>&#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CloseableHttpClient HTTP_CLIENT;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        ConnectionSocketFactory plainsf = PlainConnectionSocketFactory.getSocketFactory();</span><br><span class="line">        LayeredConnectionSocketFactory sslsf = sslConnectionSocketFactory();</span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; registry = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                .register(<span class="string">"http"</span>, plainsf)</span><br><span class="line">                .register(<span class="string">"https"</span>, sslsf)</span><br><span class="line">                .build();</span><br><span class="line">        connManager = <span class="keyword">new</span> PoolingHttpClientConnectionManager(registry);</span><br><span class="line">        <span class="comment">// 设置最大连接数</span></span><br><span class="line">        connManager.setMaxTotal(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">// 设置每个连接的路由数</span></span><br><span class="line">        connManager.setDefaultMaxPerRoute(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// 定时关闭无效的连接</span></span><br><span class="line">        <span class="keyword">new</span> IdleConnectionMonitorThread(connManager).start();</span><br><span class="line"></span><br><span class="line">        HTTP_CLIENT = HttpClients.custom()</span><br><span class="line">                .setUserAgent(userAgent)</span><br><span class="line">                .setSSLSocketFactory(sslsf)</span><br><span class="line">                .setConnectionManager(connManager)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Http客户端连接对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Http客户端连接对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> CloseableHttpClient <span class="title">getCloseableHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HTTP_CLIENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpsTrustManager</span> <span class="keyword">implements</span> <span class="title">X509TrustManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> X509Certificate[]&#123;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SSLConnectionSocketFactory <span class="title">sslConnectionSocketFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SSLConnectionSocketFactory(sslContext(),</span><br><span class="line">            SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SSLContext <span class="title">sslContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SSLContext ctx = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ctx = SSLContexts.custom().useSSL().build();</span><br><span class="line">        ctx.init(<span class="keyword">null</span>, <span class="keyword">new</span> TrustManager[] &#123; <span class="keyword">new</span> HttpsTrustManager() &#125;, <span class="keyword">new</span> SecureRandom());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeyManagementException | NoSuchAlgorithmException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后通过getCloseableHttpClient()拿到CloseableHttpClient，就可以执行https请求了（与http请求一样）。<br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getPageContent</span><span class="params">(String url,String charset)</span> </span>&#123;</span><br><span class="line">    HttpGet httpGet = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">    HttpResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        response = getCloseableHttpClient().execute(httpGet);</span><br><span class="line">        <span class="keyword">return</span> EntityUtils.toString(response.getEntity(), charset == <span class="keyword">null</span> ? <span class="string">"UTF-8"</span> : charset);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOGGER.error(<span class="string">"解析路径异常 url = "</span> + url,e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        close(httpGet, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="导入证书到秘钥库"><a href="#导入证书到秘钥库" class="headerlink" title="导入证书到秘钥库"></a>导入证书到秘钥库</h2><p>如果已经有证书，我们将证书导入秘钥库即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CloseableHttpClient client;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpClient <span class="title">getHttpsClient</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> client;</span><br><span class="line">        &#125;</span><br><span class="line">        SSLContext sslcontext = getSSLContext();</span><br><span class="line">        SSLConnectionSocketFactory factory = <span class="keyword">new</span> SSLConnectionSocketFactory(sslcontext,</span><br><span class="line">                SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);</span><br><span class="line">        client = HttpClients.custom().setSSLSocketFactory(factory).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">releaseInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        client = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SSLContext <span class="title">getSSLContext</span><span class="params">()</span> <span class="keyword">throws</span> KeyStoreException, </span></span><br><span class="line"><span class="function">    NoSuchAlgorithmException, CertificateException, IOException, KeyManagementException </span>&#123;</span><br><span class="line">        KeyStore trustStore  = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class="line">        FileInputStream instream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"my.keystore"</span>));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            trustStore.load(instream, <span class="string">"nopassword"</span>.toCharArray());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            instream.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SSLContexts.custom()</span><br><span class="line">                .loadTrustMaterial(trustStore)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>其实这2种方式也只有创建SSLContext不同。参考文章也说了生产环境还是建议使用第2种。</p><p>文章参考：<a href="https://prasans.info/2014/06/making-https-call-using-apache-httpclient/">https://prasans.info/2014/06/making-https-call-using-apache-httpclient/</a></p><p>如果是使用Java的HttpClientConnection，则可以参考：<a href="http://www.devsumo.com/technotes/2014/01/java-trusting-https-server-certificates/">http://www.devsumo.com/technotes/2014/01/java-trusting-https-server-certificates/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> httpclient </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git回退到某次提交</title>
      <link href="/2019/01/17/git%E5%9B%9E%E9%80%80%E5%88%B0%E6%9F%90%E6%AC%A1%E6%8F%90%E4%BA%A4/"/>
      <url>/2019/01/17/git%E5%9B%9E%E9%80%80%E5%88%B0%E6%9F%90%E6%AC%A1%E6%8F%90%E4%BA%A4/</url>
      
        <content type="html"><![CDATA[<p>在工作中难免会遇到把不该提交的代码提交的情况，不过好在我们可以回退。</p><h2 id="idea中的做法1"><a href="#idea中的做法1" class="headerlink" title="idea中的做法1"></a>idea中的做法1</h2><p>如果你使用idea，那么通过简单的几部操作就可以回退到任意一次提交。</p><p>1.右键-&gt;git-&gt;Show History，列出所有的提交记录。<br><a id="more"></a><br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-17_17-39-28.png" alt=""><br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-17_17-40-43.png" alt=""></p><p>2.选中一条记录，点“Select In Git Log”<br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-17_17-23-51.png" alt=""></p><p>3.选中要回退到的提交记录，然后右键点击“Reset Current Branch to Here”<br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-17_17-45-51.png" alt=""></p><p>4.在弹出框选中“Mixed”，然后点”Reset”<br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-17_17-48-34.png" alt=""><br>然后就会提示你success。然后代码就可以Revert或者在此基础上做修改了。</p><h2 id="idea中的做法2"><a href="#idea中的做法2" class="headerlink" title="idea中的做法2"></a>idea中的做法2</h2><p>1.右键-&gt;get-&gt;Show History，列出所有的提交记录。<br>2.选中要回退到的提交记录，右键“Copy Reversion Number”<br>3.Git-&gt;Repository-&gt;Rest HEAD<br>4.在弹出框中“To Commit”中填入刚刚复制的版本号，然后可以点下”Validate“来看下你是不是要回退到这个版本号。<br>5.Reset Type选择Mixed，然后点Reset<br>6.此时代码回退到了你复制的这个版本号执行git add 操作的状态，你可以修改或者提交。</p><h2 id="使用git命令"><a href="#使用git命令" class="headerlink" title="使用git命令"></a>使用git命令</h2><p>1.使用<code>git log</code>得到提交记录，然后复制你要回退到的版本号commit_id。<br>2.执行<code>git reset --mixed commit_id</code><br>3.然后代码此时的状态在暂存区，即刚刚执行git add操作。这样你就可以Revert或者在此基础上做修改了。</p><h2 id="关于git-回退几种模式的区别"><a href="#关于git-回退几种模式的区别" class="headerlink" title="关于git 回退几种模式的区别"></a>关于git 回退几种模式的区别</h2><h3 id="工作区-－-暂存区-－-本地仓库"><a href="#工作区-－-暂存区-－-本地仓库" class="headerlink" title="工作区 － 暂存区 － 本地仓库"></a>工作区 － 暂存区 － 本地仓库</h3><p>代码编写及修改是在工作区<br>git add 将本地修改添加到暂存区<br>git commit  将暂存区中的内容提交到本地仓库</p><h3 id="hard模式"><a href="#hard模式" class="headerlink" title="hard模式"></a>hard模式</h3><p>三者的改变全都丢失，即代码的修改内容丢失</p><h3 id="soft模式"><a href="#soft模式" class="headerlink" title="soft模式"></a>soft模式</h3><p>回退到git commit之前，此时处在暂存区。（即执行git add 命令后）</p><h3 id="mixed模式"><a href="#mixed模式" class="headerlink" title="mixed模式"></a>mixed模式</h3><p>就等于 git reset HEAD  回退到工作去，即git add 之前。默认是mixed模式。<br>参考：<a href="https://www.jianshu.com/p/2956652d32fa">https://www.jianshu.com/p/2956652d32fa</a></p><p>参考：<a href="https://blog.csdn.net/qq_22638399/article/details/80847205">https://blog.csdn.net/qq_22638399/article/details/80847205</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>推荐一个日志工具类</title>
      <link href="/2019/01/16/%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E6%97%A5%E5%BF%97%E5%B7%A5%E5%85%B7%E7%B1%BB/"/>
      <url>/2019/01/16/%E6%8E%A8%E8%8D%90%E4%B8%80%E4%B8%AA%E6%97%A5%E5%BF%97%E5%B7%A5%E5%85%B7%E7%B1%BB/</url>
      
        <content type="html"><![CDATA[<p>任何系统都少不了日志记录，方便了解系统运行情况，也为了方便排查问题。我们通常会在需要记录日志的类中定义一个Logger，如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Logger logger = Logger.getLogger(NodeService.class);</span><br></pre></td></tr></table></figure></p><p>但是在每个类中都这样定义一个Logger，工作量比较大，很繁琐。而且如果你用的Log4j，你后续想改成其他的日志实现，可能logger的定义都需要改，这就是一个很大的工作量了。<br>所以为了少写代码，也为了维护方便，有必要定义一个日志工具类。<br><a id="more"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/5/23.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否开启Debug</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> isDebug =  org.slf4j.LoggerFactory.getLogger(LoggerUtils.class).isDebugEnabled();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Debug 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message输出信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">debug</span><span class="params">(Class&lt;? extends Object&gt; clazz ,String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isDebug)<span class="keyword">return</span> ;</span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        logger.debug(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Debug 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString 输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtDebug</span><span class="params">(Class&lt;? extends Object&gt; clazz,String fmtString,Object...values)</span></span>&#123;</span><br><span class="line">        fmtDebug(clazz,<span class="keyword">null</span>,fmtString,values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Debug 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString 输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtDebug</span><span class="params">(Class&lt;? extends Object&gt; clazz,Exception e,String fmtString,Object...values)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!isDebug)<span class="keyword">return</span> ;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(fmtString))&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.debug(fmtString,values,e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(fmtString,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.debug(fmtString,values);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(fmtString);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Error 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message输出信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e异常类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;? extends Object&gt; clazz ,String message,Exception e)</span></span>&#123;</span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == e)&#123;</span><br><span class="line">            logger.error(message);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.error(message, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Error 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message输出信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(Class&lt;? extends Object&gt; clazz ,String message)</span></span>&#123;</span><br><span class="line">        error(clazz, message, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常填充值输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e异常类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtError</span><span class="params">(Class&lt;? extends Object&gt; clazz,Exception e,String fmtString,Object...values)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(fmtString))&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(fmtString,values,e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.error(fmtString,e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.error(fmtString,values);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.error(fmtString);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常填充值输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString 输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtError</span><span class="params">(Class&lt;? extends Object&gt; clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">                                String fmtString, Object...values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(fmtString))&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        fmtError(clazz, <span class="keyword">null</span>,fmtString,values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Error 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message输出信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e异常类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(Class&lt;? extends Object&gt; clazz ,String message,Exception e)</span></span>&#123;</span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == e)&#123;</span><br><span class="line">            logger.info(message);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        logger.info(message, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Error 输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz  目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message输出信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(Class&lt;? extends Object&gt; clazz ,String message)</span></span>&#123;</span><br><span class="line">        info(clazz, message, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常填充值输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e异常类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtInfo</span><span class="params">(Class&lt;? extends Object&gt; clazz,Exception e,String fmtString,Object...values)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(fmtString))&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Logger logger = LoggerFactory.getLogger(clazz);</span><br><span class="line">        <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(fmtString,values,e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(fmtString,values);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                logger.info(fmtString,e);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(fmtString);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常填充值输出</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz目标.Class</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fmtString 输出信息key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values输出信息value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fmtInfo</span><span class="params">(Class&lt;? extends Object&gt; clazz,</span></span></span><br><span class="line"><span class="function"><span class="params">                                String fmtString, Object...values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(fmtString))&#123;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        fmtInfo(clazz, <span class="keyword">null</span>,fmtString,values);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里使用的log4j，配置文件如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=info,stdout,ROLLING_FILE</span><br><span class="line"></span><br><span class="line"># SqlMap logging configuration...</span><br><span class="line">log4j.logger.com.ibatis=ERROR</span><br><span class="line">log4j.logger.com.ibatis.common.jdbc.SimpleDataSource=ERROR</span><br><span class="line">log4j.logger.com.ibatis.common.jdbc.ScriptRunner=ERROR</span><br><span class="line">log4j.logger.com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate=ERROR</span><br><span class="line">log4j.logger.java.sql.Connection=ERROR</span><br><span class="line">log4j.logger.org.apache=ERROR</span><br><span class="line">log4j.logger.org.springframework=info</span><br><span class="line"></span><br><span class="line"># Console output...</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%d [%-5p] %c %x - %m%n</span><br><span class="line">#log4j.appender.stdout.Encoding=GBK</span><br><span class="line"></span><br><span class="line"># RollingFile output...</span><br><span class="line">log4j.appender.ROLLING_FILE=org.apache.log4j.RollingFileAppender</span><br><span class="line">log4j.appender.ROLLING_FILE.File=/usr/log/snatchRolling.log</span><br><span class="line">log4j.appender.ROLLING_FILE.Append=true</span><br><span class="line">log4j.appender.ROLLING_FILE.MaxFileSize=100MB</span><br><span class="line">log4j.appender.ROLLING_FILE.MaxBackupIndex=10</span><br><span class="line">log4j.appender.ROLLING_FILE.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.ROLLING_FILE.layout.ConversionPattern=%d [%-5p] %c %x - %m%n</span><br></pre></td></tr></table></figure></p><p>使用就很简单了，在需要记录日志的类中使用LoggerUtils.info/debug/error即可，同时该日志工具类也是支持格式化的。即LoggerUtils中的fmtXXX方法.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LoggerUtils.info(LoggerUtils.class,<span class="string">"hello"</span>);</span><br><span class="line">LoggerUtils.info(LoggerUtils.class,<span class="string">"hello"</span>,<span class="keyword">new</span> NullPointerException(<span class="string">"null"</span>));</span><br><span class="line">LoggerUtils.fmtInfo(LoggerUtils.class,<span class="string">"hello &#123;&#125;"</span>,<span class="string">"world"</span>);</span><br><span class="line">LoggerUtils.error(LoggerUtils.class,<span class="string">"hello"</span>);</span><br><span class="line">LoggerUtils.error(LoggerUtils.class,<span class="string">"hello"</span>,<span class="keyword">new</span> NullPointerException(<span class="string">"null1"</span>));</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">int</span> i= <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">LoggerUtils.fmtError(LoggerUtils.class,e,<span class="string">"error &#123;&#125;,22"</span>,<span class="number">122</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2019-01-16_14-15-43.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用maven的mybatis-generator插件生成代码</title>
      <link href="/2018/12/13/%E4%BD%BF%E7%94%A8maven%E7%9A%84mybatis-generator%E6%8F%92%E4%BB%B6%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81/"/>
      <url>/2018/12/13/%E4%BD%BF%E7%94%A8maven%E7%9A%84mybatis-generator%E6%8F%92%E4%BB%B6%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<p>在有了数据库表结构后，我们可以使用maven的mybatis-generator插件来自动生成Mapper、实体类和DAO。</p><h2 id="1-配置mybatis-generator插件"><a href="#1-配置mybatis-generator插件" class="headerlink" title="1.配置mybatis-generator插件"></a>1.配置mybatis-generator插件</h2><p>打开项目的pom.xml文件，在<code>&lt;plugins&gt;</code>中增加mybatis-generator的plugin。<br><a id="more"></a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--指定mybatis-generator配置文件的位置--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>src/main/resources/mybatis-generator.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--允许移动生成的文件--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--允许覆盖文件--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>mybatis generator<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--依赖 如果这里不写 可以在mybatis-generator的配置文件指定 一般在这里指定--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.46<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="2-编写mybatis-generator的配置文件"><a href="#2-编写mybatis-generator的配置文件" class="headerlink" title="2.编写mybatis-generator的配置文件"></a>2.编写mybatis-generator的配置文件</h2><p>mybatis-generator.xml：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE generatorConfiguration PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN" "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库驱动包位置 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 由于在pom.xml中加入插件时已经配置数据库驱动包，所以此处不必配置了--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;classPathEntry location="D:\generator\mysql-connector-java-5.1.34.jar" /&gt; --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;classPathEntry location="E:\Database\Oracle\jdbc\lib\ojdbc14.jar" /&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"DB2Tables"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressAllComments"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据库链接URL、用户名、密码 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"com.mysql.jdbc.Driver"</span> <span class="attr">connectionURL</span>=<span class="string">"jdbc:mysql://localhost:3306/miaosha?characterEncoding=utf8"</span> <span class="attr">userId</span>=<span class="string">"root"</span> <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;jdbcConnection driverClass="oracle.jdbc.driver.OracleDriver" connectionURL="jdbc:oracle:thin:@localhost:orcl" userId="scott" password="tiger"&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成模型的包名和位置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.tommy.dataobject"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成的映射文件包名和位置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"mapper"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/resources/"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生成DAO的包名和位置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span> <span class="attr">targetPackage</span>=<span class="string">"com.tommy.dao"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 要生成那些表(更改tableName和domainObjectName就可以) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"user_info"</span> <span class="attr">domainObjectName</span>=<span class="string">"UserInfo"</span> <span class="attr">enableCountByExample</span>=<span class="string">"false"</span> <span class="attr">enableUpdateByExample</span>=<span class="string">"false"</span> <span class="attr">enableDeleteByExample</span>=<span class="string">"false"</span> <span class="attr">enableSelectByExample</span>=<span class="string">"false"</span> <span class="attr">selectByExampleQueryId</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"user_password"</span> <span class="attr">domainObjectName</span>=<span class="string">"UserPassword"</span> <span class="attr">enableCountByExample</span>=<span class="string">"false"</span> <span class="attr">enableUpdateByExample</span>=<span class="string">"false"</span> <span class="attr">enableDeleteByExample</span>=<span class="string">"false"</span> <span class="attr">enableSelectByExample</span>=<span class="string">"false"</span> <span class="attr">selectByExampleQueryId</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>mybatis-generator的详细配置说明，可以参考：<a href="https://www.jianshu.com/p/e09d2370b796">https://www.jianshu.com/p/e09d2370b796</a></p><h2 id="执行mybatis-generator的generate生成代码"><a href="#执行mybatis-generator的generate生成代码" class="headerlink" title="执行mybatis-generator的generate生成代码"></a>执行mybatis-generator的generate生成代码</h2><p>执行mybatis-generator的generate：<br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2018-12-13_18-00-37.png" alt=""></p><p>执行完毕后，工程中就多出了Mapper、实体类和DAO。<br><img src="https://raw.githubusercontent.com/luckystar88/blog_img/master/Snipaste_2018-12-13_18-02-34.png" alt=""></p><p>最后给一些小技巧：</p><p>a) 建表时，字段名称建议用”_”分隔多个单词，比如:AWB_NO、REC_ID…，这样生成的entity，属性名称就会变成漂亮的驼峰命名，即：awbNo、recId</p><p>b)oracle中，数值形的字段，如果指定精度，比如Number(12,2)，默认生成entity属性是BigDecimal型 ，如果不指定精度，比如:Number(9)，指默认生成的是Long型</p><p>c)oracle中的nvarchar/nvarchar2，mybatis-generator会识别成Object型，建议不要用nvarchar2，改用varchar2</p><p>参考：<a href="https://www.cnblogs.com/yjmyzz/p/4210554.html">https://www.cnblogs.com/yjmyzz/p/4210554.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
            <tag> maven </tag>
            
            <tag> mybatis-generator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maven私服（nexus）搭建</title>
      <link href="/2018/12/01/maven%E7%A7%81%E6%9C%8D%EF%BC%88nexus%EF%BC%89%E6%90%AD%E5%BB%BA/"/>
      <url>/2018/12/01/maven%E7%A7%81%E6%9C%8D%EF%BC%88nexus%EF%BC%89%E6%90%AD%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h2 id="一、为何要搭建maven私服"><a href="#一、为何要搭建maven私服" class="headerlink" title="一、为何要搭建maven私服"></a>一、为何要搭建maven私服</h2><p>1.有的公司开发电脑没法直接连外网，下载不了依赖；可以通过私服（私服服务器可以连接），开发电脑连接私服服务器下载依赖。<br>2.项目协作。某个项目包含多个模块，开发人员A将模块打包提交到私服，其他人从私服获取该模块的依赖。</p><h2 id="二、使用私服与不使用的区别"><a href="#二、使用私服与不使用的区别" class="headerlink" title="二、使用私服与不使用的区别"></a>二、使用私服与不使用的区别</h2><p>1.不使用私服<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd2sattsj30dr04qt8l.jpg" alt=""><br><a id="more"></a><br>2.使用私服.<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd3h9734j30fy0560sp.jpg" alt=""></p><h2 id="三、下载和安装nexus"><a href="#三、下载和安装nexus" class="headerlink" title="三、下载和安装nexus"></a>三、下载和安装nexus</h2><p>1.从<a href="https://www.sonatype.com/download-sonatype-trial选择给定系统下载。">https://www.sonatype.com/download-sonatype-trial选择给定系统下载。</a><br>2.将下载的压缩包解压，得到2个目录。如图：<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd47blzdj30g805ydgf.jpg" alt=""></p><p>3.【非必须】修改端口（默认端口是8081，根据需要修改）<br>打开nexus-2.5.1-bundle\nexus-2.5.1-01\conf\nexus.properties文件，修改端口<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd4r3xaij30bi030t8p.jpg" alt=""></p><p>4.安装nexus服务<br>进入到\nexus-2.5.1-bundle\nexus-2.5.1-01\bin\jsw\windows-x86-64（根据自己的系统选择）目录，执行install-nexus.bat来安装服务。<br>安装后，在服务中科院看到nexus服务<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd54n9kmj30hu08nada.jpg" alt=""></p><p>5.【非必须】如果有中央仓库的索引文件，可以丢到下面的目录（先清空原有内容）<br>索引文件位置：\nexus-2.5.1-bundle\sonatype-work\nexus\indexer\central-ctx，有了索引文件后，在nexus服务启动后，可以根据artifact id查找依赖。</p><p>6.启动nexus服务<br>进入到\nexus-2.5.1-bundle\nexus-2.5.1-01\bin\jsw\windows-x86-64（根据自己系统选择），双击start-nexus.bat，直到窗口消失即启动成功。</p><p>7.浏览器输入<a href="http://localhost:8081/nexus即进入nexus的管理页面。点击右上角的“Log">http://localhost:8081/nexus即进入nexus的管理页面。点击右上角的“Log</a> In”，输入用户名：admin，密码：admin123登录。</p><p>8.登录后，可以看到有如下的Repository<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd5ixowoj30tb084ta2.jpg" alt=""></p><p>其中Central是中央仓库，Releases是自己开发的项目的发布仓库（release版本），Snapshots是快照版本仓库（一般开发环境开发项目的版本，<br>比如我们新建的maven项目默认是0.0.1.SNAPSHOT），如果将它发布到仓库中，即是发布在Snapshots仓库。3rd parth是第三方的仓库。<br>Public Repositories是我们下载依赖需要使用的仓库，在它的Configuration可以看到它包含了其他所有的仓库。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd65c58jj30ea0cs3yy.jpg" alt=""></p><p>四、使用maven连接nexus私服<br>1.指定本地仓库的位置<br>打开%MAVEN_HOME%/conf/settings.xml文件，找到<localRepository>，修改本地仓库路径，默认是${user.home}/.m2/repository（在C盘，如果C盘空间紧张，可以指定其他位置）<br>1.打开%MAVEN_HOME%/conf/settings.xml文件，找到<mirrors>增加一个mirror。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>Nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>Team Nexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这里配置的url就是Public Repository的地址。因为它包含了其他的仓库。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd6q4m57j30r503fq39.jpg" alt=""></p><p>3.配置阿里云的仓库(可以在nexus新增一个阿里云的repository)<br>由于网络问题，可能有些依赖无法下载，或者下载速度很慢。我们可以使用阿里云的仓库来解决这个问题。我们在%MAVEN_HOME%/conf/settings.xml中增加一个阿里云的mirror，如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">id</span>&gt;</span>Aliyun-Nexus<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>Aliyun Nexus Repository<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：这里<mirrorOf>配置为central，不要配置为*。如果有网络，可以按照上面的配置，每个人在自己的maven的settings.xml中增加上面的镜像即可。<br>如果没有网络，可以在nexus中新增一个repository，repository type为：proxy。Url=<a href="http://maven.aliyun.com/nexus/content/groups/public/。">http://maven.aliyun.com/nexus/content/groups/public/。</a><br>2.IDE配置maven的路径和user settings file<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd7fuieqj30kb0c0756.jpg" alt=""><br>然后，在Public Repositories中，将阿里云的仓库移到central的前面，这样就会先从阿里云的仓库下载依赖，而不是maven中央仓库。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd7vmgrdj30f909kmxh.jpg" alt=""><br>不过，配置之后发现没法使用。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd84xawjj30mg050jrx.jpg" alt=""><br>访问阿里云的仓库url，提示<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd8jauldj30s103ygly.jpg" alt=""><br>然后访问<a href="https://maven.aliyun.com，里面有最新的仓库地址：">https://maven.aliyun.com，里面有最新的仓库地址：</a><br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd8tt47oj315q09ymxf.jpg" alt=""><br>不过，配置了仍然没有成功。不过配置到maven的settings.xml的<mirror>中是OK的。</p><p>4.新建一个测试项目mytest，它依赖了spring-jdbc，版本为5.1.3.RELEASE。我们在pom.xml增加此依赖保存后，可以看到是通过阿里云仓库下载的。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd9bbekvj30pz048q33.jpg" alt=""></p><h2 id="五、将项目上传到nexus"><a href="#五、将项目上传到nexus" class="headerlink" title="五、将项目上传到nexus"></a>五、将项目上传到nexus</h2><p>现在，假定需要将项目发布到nexus私服，该怎么做呢？</p><p>1.打开项目的pom.xml,增加下面的配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">distributionManagement</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">repository</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/nexus/content/repositories/releases<span class="tag">&lt;/<span class="name">url</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">repository</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">snapshotRepository</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://localhost:8081/nexus/content/repositories/snapshots<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">snapshotRepository</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">distributionManagement</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>配置的内容在nexus的releases和snapshots的Summary中可以看到<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrd9uy9rjj30ga08uq36.jpg" alt=""></p><p>2.配置<code>%MAVEN_HOME%/conf/settings.xml</code>，找到<code>&lt;servers&gt;</code>标签，增加nexus私服用户名和密码的配置。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>releases<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">id</span>&gt;</span>snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">password</span>&gt;</span>admin123<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：这里的id必须与<code>&lt;distributionManagement&gt;</code>中的repostory id一致。</p><p>3.在项目执行mvn:deploy命令即可。Eclipse：项目右键run as Maven Build，然后goal输入deploy，确定即可。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrdaa8zyej30z404qq4g.jpg" alt=""></p><p>我们可以看到，项目被上传到了snapshots中，因为我们的项目版本为0.0.1.SNAPSHOTS，所以上传到了snapshots。然后我们在nexus的Snapshots仓库的Brown Index可以看到刚刚发布的包<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrdasmgd2j30gu08hjrm.jpg" alt=""></p><p>我们将项目的版本号改为0.0.1，重新执行deploy，会发现发布到了nexus的releases仓库。</p><h2 id="六、问题记录"><a href="#六、问题记录" class="headerlink" title="六、问题记录"></a>六、问题记录</h2><p>1.启动nexus失败，提示“The nexus service was launched, but failed to start.”<br>我们可以在\nexus-2.5.1-bundle\nexus-2.5.1-01\logs\wrapper.log查看具体的错误信息。</p><p>我这里的问题是：我电脑安装了jdk7和jdk8，环境变量配置的是jdk8.我的nexus版本是2.5.1，它应该使用jdk7.<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxrdb8cj9nj30kx026wel.jpg" alt=""><br>找到\nexus-2.5.1-bundle\nexus-2.5.1-01\bin\jsw\conf\wrapper.conf，打开文件并搜索“wrapper.java.command=”，然后将wrapper.java.command设置为jdk7的执行路径。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UrlRewrite的配置与使用</title>
      <link href="/2018/11/21/UrlRewrite%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/11/21/UrlRewrite%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>UrlRewrite就是我们通常说的地址重写，用户得到的全部都是经过处理后的URL地址。</p><h2 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h2><p>一：提高安全性，可以有效的避免一些参数名、ID等完全暴露在用户面前，如果用户随便乱输的话，不符合规则的话直接会返回个404或错误页面，这比直接返回500或一大堆服务器错误信息要好的多</p><p>二：美化URL，去除了那些比如*.do之类的后缀名、长长的参数串等，可以自己组织精简更能反映访问模块内容的URL<br>三：更有利于搜索引擎的收入，通过对URL的一些优化，可以使搜索引擎更好的识别与收录网站的信息<br>     四：可以很方便的重用，提高网站的移植性。如果我们后台方法改动的话，可以保证前台的页面部分不用改。这样就提高了网站的移植性。<br><a id="more"></a><br>缺点： 因为它是通过过滤器原理来实现的，就意味着又多了一道访问，会多少影响点访问速度的，这个可以忽略不计的。</p><h2 id="使用范围"><a href="#使用范围" class="headerlink" title="使用范围"></a>使用范围</h2><p>地址重写一般是用于将动态地址伪静态。如果本身就是静态就没必要了。地址重写后网站制作者可以通过输入地址名直接访问。</p><h2 id="springboot集成UrlRewrite"><a href="#springboot集成UrlRewrite" class="headerlink" title="springboot集成UrlRewrite"></a>springboot集成UrlRewrite</h2><h3 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.tuckey<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>urlrewritefilter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="配置UrlRewrite过滤器"><a href="#配置UrlRewrite过滤器" class="headerlink" title="配置UrlRewrite过滤器"></a>配置UrlRewrite过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UrlRewriteFilterConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">urlRewriteFilterRegistration</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean filterRegistrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        filterRegistrationBean.setFilter(<span class="keyword">new</span> org.tuckey.web.filters.urlrewrite.UrlRewriteFilter());</span><br><span class="line">        filterRegistrationBean.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        filterRegistrationBean.addInitParameter(<span class="string">"confPath"</span>, <span class="string">"WEB-INF/urlrewrite.xml"</span>);</span><br><span class="line">        filterRegistrationBean.addInitParameter(<span class="string">"logLevel"</span>,<span class="string">"INFO"</span>);</span><br><span class="line">        <span class="keyword">return</span> filterRegistrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="编写规则文件"><a href="#编写规则文件" class="headerlink" title="编写规则文件"></a>编写规则文件</h3><p>/WEB-INF/urlrewrite.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE urlrewrite PUBLIC "-//tuckey.org//DTD UrlRewrite 2.6//EN" "http://tuckey.org/res/dtds/urlrewrite2.6.dtd"&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">Configuration file for UrlRewriteFilter    </span></span><br><span class="line"><span class="comment">http://tuckey.org/urlrewrite/    </span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">urlrewrite</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">note</span>&gt;</span>测试页面1<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">from</span>&gt;</span>/sk.html<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">to</span>&gt;</span>/urlrewritedemo/test1?tab=4<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">note</span>&gt;</span>测试页面2<span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">from</span>&gt;</span>/match_([-_A-Za-z0-9]+).html<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">to</span>&gt;</span>/urlrewritedemo/getMatchByDate?tab=1&amp;amp;date=$1<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">urlrewrite</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们配置了2条规则，from定义请求url，to定义对应的后台的请求url。可以结合正则表达式来实现复杂的url重写。</p><p>示例：<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fxfonhvvjzj30ht04wt8z.jpg" alt=""></p><p>常用的&amp;要用 <code>&amp;amp;</code>来表示。$1,$2代表与你配置正规表达式<code>/(\w+)/(\w+)/</code>相对应的参数。</p><p><code>&lt;to type=&quot;forward&quot;&gt;</code>中的type有两个值，默认的是 <code>type=&quot;forward&quot;</code>.连接外部的网站时用<code>type=&quot;redirect&quot;</code>。</p><p>参考：<a href="https://blog.csdn.net/weixin_41953007/article/details/80524536">UrlRewrite 的配置和使用总结</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UrlRewrite </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux更新或删除jar中的文件</title>
      <link href="/2018/11/21/Linux%E6%9B%B4%E6%96%B0%E6%88%96%E5%88%A0%E9%99%A4jar%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6/"/>
      <url>/2018/11/21/Linux%E6%9B%B4%E6%96%B0%E6%88%96%E5%88%A0%E9%99%A4jar%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<h2 id="增加-更新目录或文件"><a href="#增加-更新目录或文件" class="headerlink" title="增加/更新目录或文件"></a>增加/更新目录或文件</h2><p>如果用springboot将所有东西打成一个jar，要更新某个文件，再打包上传就很麻烦了。<br>所以这个时候就需要将某个文件打到jar中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar uvf demo-0.0.1-SNAPSHOT.jar BOOT-INF/</span><br></pre></td></tr></table></figure></p><p>上面的命令是将BOOT-INF/目录下的所有目录和文件覆盖到demo-0.0.1-SNAPSHOT.jar中。也就是，如果demo-0.0.1-SNAPSHOT.jar中有某个文件，那么该文件会被覆盖，如果没有则会添加进去。<br><a id="more"></a></p><h2 id="删除目录或文件"><a href="#删除目录或文件" class="headerlink" title="删除目录或文件"></a>删除目录或文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7za d demo-0.0.1-SNAPSHOT.jar BOOT-INF/classes/mapper/IndexMapper.xml</span><br></pre></td></tr></table></figure><p>上面的命令是从demo-0.0.1-SNAPSHOT.jar中删除IndexMapper.xml文件。该文件的位置是BOOT-INF/classes/mapper/IndexMapper.xml（jar包中的位置）。</p><p>注意：使用此命令，需要先安装7z。</p><p>安装方法：<code>sudo yum install p7zip</code></p><p>参考：<a href="https://www.cnblogs.com/yiwd/p/3649094.html">linux下安装7z命令及7z命令的使用</a>、<a href="https://blog.csdn.net/u013613428/article/details/51669882">Jar命令+7z：创建，替换，修改，删除Jar, war, ear包中的文件</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Boxcryptor加密你的云盘</title>
      <link href="/2018/11/15/%E4%BD%BF%E7%94%A8Boxcryptor%E5%8A%A0%E5%AF%86%E4%BD%A0%E7%9A%84%E4%BA%91%E7%9B%98/"/>
      <url>/2018/11/15/%E4%BD%BF%E7%94%A8Boxcryptor%E5%8A%A0%E5%AF%86%E4%BD%A0%E7%9A%84%E4%BA%91%E7%9B%98/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>现在云盘大家都不陌生，有的人手好几个。经过上一次云盘的事件，目前剩下的也不多了。目前百度云、腾讯微云、天翼云盘、坚果云是用的比较多的。国外的云盘咱们就不讨论了，毕竟要翻墙，速度没保障。</p><p>在这些云盘中，百度云有2T的免费空间，基本一些大的视频或文件会存储在百度云。腾讯微云、天翼云空间也只有几G到10多G，对上传下载有限制，所以用的不多。最后一个要提到的就是坚果云，<br>老实说因为不像其他3个云盘服务提供商都是大公司，所以心里没底。不过服务说实在的还是不错的。坚果云其实是一个同步工具，可以对指定的目录（可以随意指定多个）进行同步，同步的速度也很快，增量同步。<br>它没有空间的限制，不过免费用户每个月上传流量1G，下载流量3G。如果只是基于办公需求已经足够。<br><a id="more"></a><br>不过，使用云盘就不免担心个人隐私数据会不会被其他人看到。所以这里要介绍的就是如何加密你的云盘，上传到云盘上的数据都是经过加密的，只有你能解密。这里要介绍的是使用Boxcryptor加密存储在坚果云上的文件/目录。<br>为什么是坚果云？因为它是目前国内唯一支持WebDAV协议的。下面废话不多说，说一说怎么加密数据到云盘。</p><h2 id="PC客户端安装与配置"><a href="#PC客户端安装与配置" class="headerlink" title="PC客户端安装与配置"></a>PC客户端安装与配置</h2><p>从<a href="https://www.boxcryptor.com/en/download/">https://www.boxcryptor.com/en/download/</a>下载PC客户端软件，下载完成后安装，一步一步直到完成即可。</p><p>下一步，注册账号</p><p>下一步，设置你的需要加密的文件夹路径<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8rxe2zm9j30jg0g4wew.jpg" alt=""></p><p>注意：这个路径必须是你坚果云同步目录中，这样坚果云才会把这个目录同步。</p><p>BoxCryptor会生成一个虚拟磁盘，双击打开即进入到你设置的目录。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8s03bq01j30ba06vdg1.jpg" alt=""></p><p>打开这个虚拟磁盘，你就可以随意创建文件或目录，创建时会提示你是否加密，你可以选择加密也可以不加密。如果不加密那么你就可以直接在坚果云上查看该目录或文件。如果选择加密，对于文件Boxcryptor会自动在文件名后加.bc后缀。<br>如果你打开带.bc后缀的文件，其实它是乱码显示的。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8s5j45ojj30pi0233yu.jpg" alt=""></p><p>如果你要查看，在这台电脑，在Boxcryptor的虚拟磁盘，你打开就可以查看文件内容。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8s7mtts6j30i406yq35.jpg" alt=""></p><p>在其他机器上如何查看加密的内容？<br>安装和配置客户端，登录即可。</p><h2 id="移动端"><a href="#移动端" class="headerlink" title="移动端"></a>移动端</h2><p>Boxcryptor有手机客户端，这里以iPhone为例，在AppStore查找boxcryptor，然后下载（免费）。<br>PC端加密过的坚果云文件在其他设备查看都是需要安装Boxcryptor才可以访问，相当于Boxcryptor对这些文件上了一把锁，想要查看都是需要再通过Boxcryptor来进行解锁，移动端使用和电脑端有些区别，需要使用webDAV连接到坚果云，获取文件。</p><p>1、 打开你的坚果云网页端登录后查看账户信息-安全选项里，第三方应用管理处即可添加你的应用密码；或者坚果云手机端，iOS是在更多-第三方应用管理；安卓在设置-第三方应用管理。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8sbveioaj30ji07nq30.jpg" alt=""></p><p>2、在手机端安装登录后，在Files界面，选择最下方的WebDAV Advanced，与坚果云进行连接。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx8sckfg8fj307o0dqta5.jpg" alt=""></p><p>3、按照你的坚果云第三方应用管理里的信息，分别填写账号、应用密码、服务器地址，即可查看和访问坚果云里的加密文件。</p><h2 id="搭建私有云"><a href="#搭建私有云" class="headerlink" title="搭建私有云"></a>搭建私有云</h2><p>用公有云总觉得不安全，数据在别人的服务器上。如果有这个担心，除了上面对文件加密上传外，还可以搭建私有云。<br>参考：<a href="https://linux.cn/article-9418-1.html">搭建私有云：OwnCloud</a>、<a href="http://www.vpsdaquan.cn/vpsdajianowncloud.html">vps搭建owncloud</a></p><p>参考：<a href="http://blog.jianguoyun.com/?p=2568">如何使用Boxcryptor加密坚果云文件？</a></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Boxcryptor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用spring validation完成数据后端校验</title>
      <link href="/2018/11/10/%E4%BD%BF%E7%94%A8spring%20validation%E5%AE%8C%E6%88%90%E6%95%B0%E6%8D%AE%E5%90%8E%E7%AB%AF%E6%A0%A1%E9%AA%8C/"/>
      <url>/2018/11/10/%E4%BD%BF%E7%94%A8spring%20validation%E5%AE%8C%E6%88%90%E6%95%B0%E6%8D%AE%E5%90%8E%E7%AB%AF%E6%A0%A1%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据的校验是交互式网站一个不可或缺的功能，前端的js校验可以涵盖大部分的校验职责，如用户名唯一性，生日格式，邮箱格式校验等等常用的校验。但是为了避免用户绕过浏览器，使用http工具直接向后端请求一些违法数据，服务端的数据校验也是必要的，可以防止脏数据落到数据库中，如果数据库中出现一个非法的邮箱格式，也会让运维人员头疼不已。我在之前保险产品研发过程中，系统对数据校验要求比较严格且追求可变性及效率，曾使用drools作为规则引擎，兼任了校验的功能。而在一般的应用，可以使用本文将要介绍的validation来对数据进行校验。<br><a id="more"></a><br>简述JSR303/JSR-349，hibernate validation，spring validation之间的关系。JSR303是一项标准,JSR-349是其的升级版本，添加了一些新特性，他们规定一些校验规范即校验注解，如@Null，@NotNull，@Pattern，他们位于javax.validation.constraints包下，只提供规范不提供实现。而hibernate validation是对这个规范的实践（不要将hibernate和数据库orm框架联系在一起），他提供了相应的实现，并增加了一些其他校验注解，如@Email，@Length，@Range等等，他们位于org.hibernate.validator.constraints包下。而万能的spring为了给开发者提供便捷，对hibernate validation进行了二次封装，显示校验validated bean时，你可以使用spring validation或者hibernate validation，而spring validation另一个特性，便是其在springmvc模块中添加了自动校验，并将校验信息封装进了特定的类中。这无疑便捷了我们的web开发。本文主要介绍在springmvc中自动校验的机制。</p><h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><p>我们使用maven构建springboot应用来进行demo演示。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>我们只需要引入spring-boot-starter-web依赖即可，如果查看其子依赖，可以发现如下的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>验证了我之前的描述，web模块使用了hibernate-validation，并且databind模块也提供了相应的数据绑定功能。</p><h2 id="构建启动类"><a href="#构建启动类" class="headerlink" title="构建启动类"></a>构建启动类</h2><p>无需添加其他注解，一个典型的启动类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateApp</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ValidateApp.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="创建需要被校验的实体类"><a href="#创建需要被校验的实体类" class="headerlink" title="创建需要被校验的实体类"></a>创建需要被校验的实体类</h2><figure class="highlight plain"><figcaption><span>class Foo &#123;</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    @NotBlank</span><br><span class="line">    private String name;</span><br><span class="line"></span><br><span class="line">    @Min(18)</span><br><span class="line">    private Integer age;</span><br><span class="line"></span><br><span class="line">    @Pattern(regexp = &quot;^1(3|4|5|7|8)\\d&#123;9&#125;$&quot;,message = &quot;手机号码格式错误&quot;)</span><br><span class="line">    @NotBlank(message = &quot;手机号码不能为空&quot;)</span><br><span class="line">    private String phone;</span><br><span class="line"></span><br><span class="line">    @Email(message = &quot;邮箱格式错误&quot;)</span><br><span class="line">    private String email;</span><br><span class="line"></span><br><span class="line">    //... getter setter</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用一些比较常用的校验注解，还是比较浅显易懂的，字段上的注解名称即可推断出校验内容，每一个注解都包含了message字段，用于校验失败时作为提示信息，特殊的校验注解，如Pattern（正则校验），还可以自己添加正则表达式。</p><h2 id="在-Controller中校验数据"><a href="#在-Controller中校验数据" class="headerlink" title="在@Controller中校验数据"></a>在@Controller中校验数据</h2><p>springmvc为我们提供了自动封装表单参数的功能，一个添加了参数校验的典型controller如下所示。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/foo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">foo</span><span class="params">(@Validated Foo foo &lt;<span class="number">1</span>&gt;, BindingResult bindingResult &lt;<span class="number">2</span>&gt;)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">            <span class="keyword">for</span> (FieldError fieldError : bindingResult.getFieldErrors()) &#123;</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"fail"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>值得注意的地方：</p><p><1> 参数Foo前需要加上@Validated注解，表明需要spring对其进行校验，而校验的信息会存放到其后的BindingResult中。注意，必须相邻，如果有多个参数需要校验，形式可以如下。foo(@Validated Foo foo, BindingResult fooBindingResult ，@Validated Bar bar, BindingResult barBindingResult);即一个校验类对应一个校验结果。</p><p><2> 校验结果会被自动填充，在controller中可以根据业务逻辑来决定具体的操作，如跳转到错误页面。</p><p>一个最基本的校验就完成了，总结下框架已经提供了哪些校验：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">JSR提供的校验注解：         </span><br><span class="line">@Null   被注释的元素必须为 null    </span><br><span class="line">@NotNull    被注释的元素必须不为 null    </span><br><span class="line">@AssertTrue     被注释的元素必须为 true    </span><br><span class="line">@AssertFalse    被注释的元素必须为 false    </span><br><span class="line">@Min(value)     被注释的元素必须是一个数字，其值必须大于等于指定的最小值    </span><br><span class="line">@Max(value)     被注释的元素必须是一个数字，其值必须小于等于指定的最大值    </span><br><span class="line">@DecimalMin(value)  被注释的元素必须是一个数字，其值必须大于等于指定的最小值    </span><br><span class="line">@DecimalMax(value)  被注释的元素必须是一个数字，其值必须小于等于指定的最大值    </span><br><span class="line">@Size(max=, min=)   被注释的元素的大小必须在指定的范围内    </span><br><span class="line">@Digits (integer, fraction)     被注释的元素必须是一个数字，其值必须在可接受的范围内    </span><br><span class="line">@Past   被注释的元素必须是一个过去的日期    </span><br><span class="line">@Future     被注释的元素必须是一个将来的日期    </span><br><span class="line">@Pattern(regex=,flag=)  被注释的元素必须符合指定的正则表达式    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hibernate Validator提供的校验注解：  </span><br><span class="line">@NotBlank(message =)   验证字符串非null，且长度必须大于0    </span><br><span class="line">@Email  被注释的元素必须是电子邮箱地址    </span><br><span class="line">@Length(min=,max=)  被注释的字符串的大小必须在指定的范围内    </span><br><span class="line">@NotEmpty   被注释的字符串的必须非空    </span><br><span class="line">@Range(min=,max=,message=)  被注释的元素必须在合适的范围内</span><br></pre></td></tr></table></figure><h2 id="校验实验"><a href="#校验实验" class="headerlink" title="校验实验"></a>校验实验</h2><p>我们对上面实现的校验入口进行一次测试请求：<br>访问<a href="http://localhost:8080/foo?name=xujingfeng&amp;email=000&amp;age=19">http://localhost:8080/foo?name=xujingfeng&amp;email=000&amp;age=19</a>可以得到如下的debug信息：<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fx2s6vvv4pj30j10hjabw.jpg" alt=""></p><p>实验告诉我们，校验结果起了作用。并且，可以发现当发生多个错误，spring validation不会在第一个错误发生后立即停止，而是继续试错，告诉我们所有的错误。debug可以查看到更多丰富的错误信息，这些都是spring validation为我们提供的便捷特性，基本适用于大多数场景。</p><p>你可能不满足于简单的校验特性，下面进行一些补充。</p><h2 id="分组校验"><a href="#分组校验" class="headerlink" title="分组校验"></a>分组校验</h2><p>如果同一个类，在不同的使用场景下有不同的校验规则，那么可以使用分组校验。未成年人是不能喝酒的，而在其他场景下我们不做特殊的限制，这个需求如何体现同一个实体，不同的校验规则呢？</p><p>改写注解，添加分组：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Class Foo&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Min</span>(value = <span class="number">18</span>,groups = &#123;Adult.class&#125;)</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Adult</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Minor</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样表明，只有在Adult分组下，18岁的限制才会起作用。</p><p>Controller层改写：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/drink"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">drink</span><span class="params">(@Validated(&#123;Foo.Adult.class&#125;)</span> Foo foo, BindingResult bindingResult) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (FieldError fieldError : bindingResult.getFieldErrors()) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/live"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">live</span><span class="params">(@Validated Foo foo, BindingResult bindingResult)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(bindingResult.hasErrors())&#123;</span><br><span class="line">        <span class="keyword">for</span> (FieldError fieldError : bindingResult.getFieldErrors()) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fail"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>drink方法限定需要进行Adult校验，而live方法则不做限制。</p><p>自定义校验<br>业务需求总是比框架提供的这些简单校验要复杂的多，我们可以自定义校验来满足我们的需求。自定义spring validation非常简单，主要分为两步。</p><p>1 自定义校验注解<br>我们尝试添加一个“字符串不能包含空格”的限制。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Constraint</span>(validatedBy = &#123;CannotHaveBlankValidator.class&#125;)&lt;<span class="number">1</span>&gt;</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> CannotHaveBlank &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//默认错误消息</span></span><br><span class="line">    <span class="function">String <span class="title">message</span><span class="params">()</span> <span class="keyword">default</span> "不能包含空格"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分组</span></span><br><span class="line">    Class&lt;?&gt;[] groups() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//负载</span></span><br><span class="line">    Class&lt;? extends Payload&gt;[] payload() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//指定多个时使用</span></span><br><span class="line">    <span class="meta">@Target</span>(&#123;FIELD, METHOD, PARAMETER, ANNOTATION_TYPE&#125;)</span><br><span class="line">    <span class="meta">@Retention</span>(RUNTIME)</span><br><span class="line">    <span class="meta">@Documented</span></span><br><span class="line">    <span class="meta">@interface</span> List &#123;</span><br><span class="line">        CannotHaveBlank[] value();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们不需要关注太多东西，使用spring validation的原则便是便捷我们的开发，例如payload，List ，groups，都可以忽略。</p><p><1> 自定义注解中指定了这个注解真正的验证者类。</p><p>2 编写真正的校验者类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CannotHaveBlankValidator</span> <span class="keyword">implements</span> &lt;1&gt; <span class="title">ConstraintValidator</span>&lt;<span class="title">CannotHaveBlank</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(CannotHaveBlank constraintAnnotation)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(String value, ConstraintValidatorContext context &lt;<span class="number">2</span>&gt;)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//null时不进行校验</span></span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.contains(<span class="string">" "</span>)) &#123;</span><br><span class="line">            &lt;<span class="number">3</span>&gt;</span><br><span class="line">            <span class="comment">//获取默认提示信息</span></span><br><span class="line">            String defaultConstraintMessageTemplate = context.getDefaultConstraintMessageTemplate();</span><br><span class="line">            System.out.println(<span class="string">"default message :"</span> + defaultConstraintMessageTemplate);</span><br><span class="line">            <span class="comment">//禁用默认提示信息</span></span><br><span class="line">            context.disableDefaultConstraintViolation();</span><br><span class="line">            <span class="comment">//设置提示语</span></span><br><span class="line">            context.buildConstraintViolationWithTemplate(<span class="string">"can not contains blank"</span>).addConstraintViolation();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><1> 所有的验证者都需要实现ConstraintValidator接口，它的接口也很形象，包含一个初始化事件方法，和一个判断是否合法的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConstraintValidator</span>&lt;<span class="title">A</span> <span class="keyword">extends</span> <span class="title">Annotation</span>, <span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">initialize</span><span class="params">(A constraintAnnotation)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">(T value, ConstraintValidatorContext context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><2> ConstraintValidatorContext 这个上下文包含了认证中所有的信息，我们可以利用这个上下文实现获取默认错误提示信息，禁用错误提示信息，改写错误提示信息等操作。</p><p><3> 一些典型校验操作，或许可以对你产生启示作用。</p><p>值得注意的一点是，自定义注解可以用在METHOD, FIELD, ANNOTATION_TYPE, CONSTRUCTOR, PARAMETER之上，ConstraintValidator的第二个泛型参数T，是需要被校验的类型。</p><h2 id="手动校验"><a href="#手动校验" class="headerlink" title="手动校验"></a>手动校验</h2><p>可能在某些场景下需要我们手动校验，即使用校验器对需要被校验的实体发起validate，同步获得校验结果。理论上我们既可以使用Hibernate Validation提供Validator，也可以使用Spring对其的封装。在spring构建的项目中，提倡使用经过spring封装过后的方法，这里两种方法都介绍下：</p><p>Hibernate Validation：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">foo.setAge(<span class="number">22</span>);</span><br><span class="line">foo.setEmail(<span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line">ValidatorFactory vf = Validation.buildDefaultValidatorFactory();</span><br><span class="line">Validator validator = vf.getValidator();</span><br><span class="line"></span><br><span class="line">Set&lt;ConstraintViolation&lt;Foo&gt;&gt; set = validator.validate(foo);</span><br><span class="line"><span class="keyword">for</span> (ConstraintViolation&lt;Foo&gt; constraintViolation : set) &#123;</span><br><span class="line">    System.out.println(constraintViolation.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>由于依赖了Hibernate Validation框架，我们需要调用Hibernate相关的工厂方法来获取validator实例，从而校验。</p><p>在spring framework文档的Validation相关章节，可以看到如下的描述：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Spring provides full support for the Bean Validation API. This includes convenient support for bootstrapping a JSR-303/JSR-349 Bean Validation provider as a Spring bean. This allows for a javax.validation.ValidatorFactory or javax.validation.Validator to be injected wherever validation is needed in your application. Use the LocalValidatorFactoryBean to configure a default Validator as a Spring bean:</span><br><span class="line"></span><br><span class="line">bean id=”validator” class=”org.springframework.validation.beanvalidation.LocalValidatorFactoryBean”</span><br><span class="line"></span><br><span class="line">The basic configuration above will trigger Bean Validation to initialize using its default bootstrap mechanism. A JSR-303/JSR-349 provider, such as Hibernate Validator, is expected to be present in the classpath and will be detected automatically.</span><br></pre></td></tr></table></figure></p><p>上面这段话主要描述了spring对validation全面支持JSR-303、JSR-349的标准，并且封装了LocalValidatorFactoryBean作为validator的实现。值得一提的是，这个类的责任其实是非常重大的，他兼容了spring的validation体系和hibernate的validation体系，也可以被开发者直接调用，代替上述的从工厂方法中获取的hibernate validator。由于我们使用了springboot，会触发web模块的自动配置，LocalValidatorFactoryBean已经成为了Validator的默认实现，使用时只需要自动注入即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">Validator globalValidator; &lt;<span class="number">1</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/validate"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">validate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Foo foo = <span class="keyword">new</span> Foo();</span><br><span class="line">    foo.setAge(<span class="number">22</span>);</span><br><span class="line">    foo.setEmail(<span class="string">"000"</span>);</span><br><span class="line"></span><br><span class="line">    Set&lt;ConstraintViolation&lt;Foo&gt;&gt; set = globalValidator.validate(foo);&lt;<span class="number">2</span>&gt;</span><br><span class="line">    <span class="keyword">for</span> (ConstraintViolation&lt;Foo&gt; constraintViolation : set) &#123;</span><br><span class="line">        System.out.println(constraintViolation.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><1> 真正使用过Validator接口的读者会发现有两个接口，一个是位于javax.validation包下，另一个位于org.springframework.validation包下，注意我们这里使用的是前者javax.validation，后者是spring自己内置的校验接口，LocalValidatorFactoryBean同时实现了这两个接口。</p><p><2> 此处校验接口最终的实现类便是LocalValidatorFactoryBean。</p><h2 id="基于方法校验"><a href="#基于方法校验" class="headerlink" title="基于方法校验"></a>基于方法校验</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Validated</span> &lt;<span class="number">1</span>&gt;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BarController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/bar"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@NotBlank</span> &lt;<span class="number">2</span>&gt; <span class="function">String <span class="title">bar</span><span class="params">(@Min(<span class="number">18</span>)</span> Integer age &lt;3&gt;) </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"age : "</span> + age);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ConstraintViolationException.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">handleConstraintViolationException</span><span class="params">(ConstraintViolationException cve)</span></span>&#123;</span><br><span class="line">        Set&lt;ConstraintViolation&lt;?&gt;&gt; cves = cve.getConstraintViolations();&lt;<span class="number">4</span>&gt;</span><br><span class="line">        <span class="keyword">for</span> (ConstraintViolation&lt;?&gt; constraintViolation : cves) &#123;</span><br><span class="line">            System.out.println(constraintViolation.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">"errorCode"</span>,<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><1> 为类添加@Validated注解</p><p><2> <3> 校验方法的返回值和入参</p><p><4> 添加一个异常处理器，可以获得没有通过校验的属性相关信息</p><p>基于方法的校验，个人不推荐使用，感觉和项目结合的不是很好。</p><h2 id="使用校验框架的一些想法"><a href="#使用校验框架的一些想法" class="headerlink" title="使用校验框架的一些想法"></a>使用校验框架的一些想法</h2><p>理论上spring validation可以实现很多复杂的校验，你甚至可以使你的Validator获取ApplicationContext，获取spring容器中所有的资源，进行诸如数据库校验，注入其他校验工具，完成组合校验（如前后密码一致）等等操作，但是寻求一个易用性和封装复杂性之间的平衡点是我们作为工具使用者应该考虑的，我推崇的方式，是仅仅使用自带的注解和自定义注解，完成一些简单的，可复用的校验。而对于复杂的校验，则包含在业务代码之中，毕竟如用户名是否存在这样的校验，仅仅依靠数据库查询还不够，为了避免并发问题，还是得加上唯一索引之类的额外工作，不是吗？</p><p>原文地址：<a href="https://blog.csdn.net/u013815546/article/details/77248003">https://blog.csdn.net/u013815546/article/details/77248003</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot整合EHCache</title>
      <link href="/2018/11/07/SpringBoot%E6%95%B4%E5%90%88EHCache/"/>
      <url>/2018/11/07/SpringBoot%E6%95%B4%E5%90%88EHCache/</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Cache简介"><a href="#Spring-Cache简介" class="headerlink" title="Spring Cache简介"></a>Spring Cache简介</h2><p>Spring定义了CacheManager和Cache接口统一不同的缓存技术。其中CacheManager是Spring提供的各种缓存技术的抽象接口。而Cache接口包含缓存的各种操作，当然我们一般情况下不会直接操作Cache接口。</p><p>Spring针对不同的缓存技术，需要实现不同的cacheManager，Spring定义了如下的cacheManger实现：<br><a id="more"></a><br>|CacheManger|    描述|<br>|- |:—:|<br>|SimpleCacheManager    |使用简单的Collection来存储缓存，主要用于测试<br>|ConcurrentMapCacheManager|    使用ConcurrentMap作为缓存技术（默认）<br>|NoOpCacheManager    |测试用<br>|EhCacheCacheManager    |使用Ehcache作为缓存技术，以前在HIbernate的时候经常用<br>|GuavaCacheManager    |使用google guava的GuavaCache作为缓存技术<br>|HazelcastCacheManager    |使用Hazelcast作为缓存技术<br>|JCacheCacheManager    |使用JCache标准的实现作为缓存技术，如Apache Commons JCS<br>|RedisCacheManager    |使用Redis作为缓存技术</p><p>常规的SpringBoot已经为我们自动配置了EhCache、Collection、Guava、ConcurrentMap等缓存，默认使用SimpleCacheConfiguration，即使用ConcurrentMapCacheManager。</p><h2 id="SpringBoot整合EHCache"><a href="#SpringBoot整合EHCache" class="headerlink" title="SpringBoot整合EHCache"></a>SpringBoot整合EHCache</h2><h3 id="pom-xml引入spring-boot-starter-cache和ehcache"><a href="#pom-xml引入spring-boot-starter-cache和ehcache" class="headerlink" title="pom.xml引入spring-boot-starter-cache和ehcache"></a>pom.xml引入spring-boot-starter-cache和ehcache</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-cache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="配置ehcache-xml"><a href="#配置ehcache-xml" class="headerlink" title="配置ehcache.xml"></a>配置ehcache.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;ehcache xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:noNamespaceSchemaLocation=&quot;http://ehcache.org/ehcache.xsd&quot;</span><br><span class="line">         updateCheck=&quot;false&quot;&gt;</span><br><span class="line">    &lt;diskStore path=&quot;java.io.tmpdir/Tmp_EhCache&quot;/&gt;</span><br><span class="line">    &lt;defaultCache eternal=&quot;false&quot; maxElementsInMemory=&quot;1000&quot;</span><br><span class="line">                  overflowToDisk=&quot;false&quot; diskPersistent=&quot;false&quot; timeToIdleSeconds=&quot;0&quot;</span><br><span class="line">                  timeToLiveSeconds=&quot;600&quot; memoryStoreEvictionPolicy=&quot;LRU&quot;/&gt;</span><br><span class="line">    &lt;cache name=&quot;user&quot; eternal=&quot;false&quot; maxElementsInMemory=&quot;10000&quot;</span><br><span class="line">           overflowToDisk=&quot;false&quot; diskPersistent=&quot;false&quot; timeToIdleSeconds=&quot;0&quot;</span><br><span class="line">           timeToLiveSeconds=&quot;0&quot; memoryStoreEvictionPolicy=&quot;LFU&quot;/&gt;</span><br><span class="line">&lt;/ehcache&gt;</span><br></pre></td></tr></table></figure><p>需要说明的是，这里maxElementsInMemory属性是必须的。</p><h3 id="配置application-yml"><a href="#配置application-yml" class="headerlink" title="配置application.yml"></a>配置application.yml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  cache:</span><br><span class="line">type: ehcache</span><br><span class="line">    ehcache:</span><br><span class="line">      config: classpath:config/ehcache.xml</span><br></pre></td></tr></table></figure><p>如果ehcache.xml在/resources下，则不用配置<code>spring.cache.ehcache.config</code>。</p><h3 id="Spring-Boot启动类增加-EnableCaching开启缓存"><a href="#Spring-Boot启动类增加-EnableCaching开启缓存" class="headerlink" title="Spring Boot启动类增加@EnableCaching开启缓存"></a>Spring Boot启动类增加@EnableCaching开启缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="缓存注解说明"><a href="#缓存注解说明" class="headerlink" title="缓存注解说明"></a>缓存注解说明</h3><ul><li>@CacheConfig(cacheNames = {“lemonCache”})：设置了ehcache的名称，这个名称就是ehcache.xml内的名称； </li><li>@Cacheable：应用到读取数据的方法上，即可缓存的方法，如查找方法：先从缓存中读取，如果没有再调 用方法获取数据，然后把数据添加到缓存中，适用于查找； </li><li>@CachePut：主要针对方法配置，能够根据方法的请求参数对其结果进行缓存，和 @Cacheable 不同的是，它每次都会触发真实方法的调用。适用于更新和插入； </li><li>@CacheEvict：主要针对方法配置，能够根据一定的条件对缓存进行清空。适用于删除。</li></ul><h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(cacheNames = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"><span class="meta">@Cacheable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDO <span class="title">get</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashedMap(<span class="number">1</span>);</span><br><span class="line">        map.put(<span class="string">"username"</span>,username);</span><br><span class="line">        UserDO user = list(map).get(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="与Shiro结合导致缓存不生效的问题"><a href="#与Shiro结合导致缓存不生效的问题" class="headerlink" title="与Shiro结合导致缓存不生效的问题"></a>与Shiro结合导致缓存不生效的问题</h3><p>基本确定是shiro框架与spring框架的BeanFactory有所冲突，导致注入shiro框架的类不能被spring正确初始化。</p><p>在我们自定义的Shiro Realm中注入的Service增加@Lazy。</p><p>参考：<a href="https://www.cnblogs.com/yueshutong/p/9381558.html">https://www.cnblogs.com/yueshutong/p/9381558.html</a></p><p>参考：<a href="https://www.cnblogs.com/yueshutong/p/9381540.html">https://www.cnblogs.com/yueshutong/p/9381540.html</a></p><p>Spring Cache Key的生成使用Spring EL表达式，自定义生成策略参考：<a href="https://www.jianshu.com/p/2a584aaafad3">https://www.jianshu.com/p/2a584aaafad3</a></p><p>Spring Cache章节：<a href="https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/integration.html#cache">https://docs.spring.io/spring/docs/5.0.8.RELEASE/spring-framework-reference/integration.html#cache</a><br>Spring Boot Cache章节：<a href="https://docs.spring.io/spring-boot/docs/2.0.4.RELEASE/reference/html/boot-features-caching.html">https://docs.spring.io/spring-boot/docs/2.0.4.RELEASE/reference/html/boot-features-caching.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>谷歌浏览器优化</title>
      <link href="/2018/11/03/%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%98%E5%8C%96/"/>
      <url>/2018/11/03/%E8%B0%B7%E6%AD%8C%E6%B5%8F%E8%A7%88%E5%99%A8%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>谷歌浏览器简约、速度快，但唯一一点太耗内存了。下面就简单说下优化方法。</p><h2 id="停掉没用到插件扩展"><a href="#停掉没用到插件扩展" class="headerlink" title="停掉没用到插件扩展"></a>停掉没用到插件扩展</h2><p>相信很多人安装了一大堆Chrome扩展，但有些扩展并不是经常用到，但会占用内存。<br>我们打开谷歌的任务管理器可以看到：<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fwuyspf4v4j30i60c9gn2.jpg" alt=""></p><p>通过图片可以看到，就截图中的几个插件就占用了几百兆的内存。所以有些插件暂时不用他就把它关闭掉，需要使用时再打开即可。<br><a id="more"></a><br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fwuyuh9svij311n0d4goa.jpg" alt=""></p><p>当然，你也可以打开谷歌的任务管理器将你想关闭的进程关闭。</p><h2 id="关闭-Chrome-预读功能"><a href="#关闭-Chrome-预读功能" class="headerlink" title="关闭 Chrome 预读功能"></a>关闭 Chrome 预读功能</h2><p>Chrome 预读功能可以提高网页打开速度，原理是在用户还没有点击某个链接的时候就已经提前开始加载了。例如会预读下一篇文章的内容，从功能上来说是个不错的体验，但对于内存小的用户来说，是越用越卡。</p><p>设置方法：在Chrome浏览器「设置」 → 「高级」，找到「借助联想查询访问，帮你在地址栏中自动填充未输完的搜索字词和网址」和「使用联想查服务更快速加载网页」关闭就可以了。<br><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fwuyx760k1j30l009vdgx.jpg" alt=""></p><h2 id="关闭-Google-Chrome-后继续运行后台应用-和-硬件加速"><a href="#关闭-Google-Chrome-后继续运行后台应用-和-硬件加速" class="headerlink" title="关闭 Google Chrome 后继续运行后台应用 和 硬件加速"></a>关闭 Google Chrome 后继续运行后台应用 和 硬件加速</h2><p><img src="http://ww1.sinaimg.cn/large/007oxnVvgy1fwuz17c4l8j30lg06bglr.jpg" alt=""></p><h2 id="使用Chrome自带的Automatic-tab-discarding功能"><a href="#使用Chrome自带的Automatic-tab-discarding功能" class="headerlink" title="使用Chrome自带的Automatic tab discarding功能"></a>使用Chrome自带的Automatic tab discarding功能</h2><p>当系统可用内存不足时，Automatic tab discarding功能会自动舍弃用户最不关心的标签页。需要指出的是，这里的”舍弃”并不是关闭，而是始终保持开启状态，当用户点击时会重新加载。<br>在Chrome地址栏中输入：chrome://flags/#automatic-tab-discarding，回车后打开Automatic tab discarding功能设置，选择”Enabled”，重启Chrome浏览器就可以开启这个功能。<br>在Chrome地址栏中输入：chrome://discards，回车就可以看到哪些标签页已经被舍弃了。你也可以在这里手动舍弃标签页。</p><h2 id="使用The-Great-Suspender：让暂时不用的chrome标签页休眠节省内存！"><a href="#使用The-Great-Suspender：让暂时不用的chrome标签页休眠节省内存！" class="headerlink" title="使用The Great Suspender：让暂时不用的chrome标签页休眠节省内存！"></a>使用The Great Suspender：让暂时不用的chrome标签页休眠节省内存！</h2><p>使用 Chrome 浏览器时开上10几个标签是常有的事，如果再开上更多标签而电脑硬件又过时的话，这时候就会感觉到卡了。<br>The Great Suspender 这个 Chrome 扩展可以让你把不需要的标签进入睡眠模式以节省内存，保证流畅的浏览体验。<br>与另一款标签管理工具 OneTab不同，OneTab是将临时不用的标签页浓缩到保存到一个独立的页面里，这样也能节省资源，也是个不错的选择。<br>The Great Suspender 提供两种休眠方式： 手动休眠、或者一段时间不使用自动休眠。扩展还支持白名单，无论自动休眠还是手动休眠，白名单中的网站是不会休眠的。<br>参考：<a href="http://chromecj.com/accessibility/2017-05/749.html">http://chromecj.com/accessibility/2017-05/749.html</a></p><p>这个也是非常实用的，可以释放大量内存。</p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chrome浏览器截长图</title>
      <link href="/2018/11/01/Chrome%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E9%95%BF%E5%9B%BE/"/>
      <url>/2018/11/01/Chrome%E6%B5%8F%E8%A7%88%E5%99%A8%E6%88%AA%E9%95%BF%E5%9B%BE/</url>
      
        <content type="html"><![CDATA[<p>在要截图的页面，按F12，然后按CTRL+SHIFT+P，然后输入cfcs（Capture Full size screenshot），然后回车即可。<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwsh4qb26pj30ii05pwfa.jpg" alt=""></p><p>然后选择存储位置即可。</p><p>参考：<a href="https://sspai.com/post/42193">https://sspai.com/post/42193</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>极简图床+微博图床+github+外链访问</title>
      <link href="/2018/11/01/%E6%9E%81%E7%AE%80%E5%9B%BE%E5%BA%8A+%E5%BE%AE%E5%8D%9A%E5%9B%BE%E5%BA%8A+%E5%A4%96%E9%93%BE%E8%AE%BF%E9%97%AE/"/>
      <url>/2018/11/01/%E6%9E%81%E7%AE%80%E5%9B%BE%E5%BA%8A+%E5%BE%AE%E5%8D%9A%E5%9B%BE%E5%BA%8A+%E5%A4%96%E9%93%BE%E8%AE%BF%E9%97%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h2><p>现在都流行使用markdown写博客，写文章，难免会需要显示图片。以往我们都是将图片上传到网站服务器，然后网站返回一个图片地址。</p><p>但是，如果你想搭建自己的博客，没有服务器，还想使用markdown写文章，那么就需要借助一些图床。</p><p><a href="http://jiantuku.com/#/">极简图床</a>是一款非常方便好用的图床工具，可以绑定七牛云、阿里云OSS，还可以使用微博图床。</p><p>我在很早之前就申请了七牛云的测试域名，之前也一直绑定的七牛云，当时最近七牛云通知我测试域名要回收了。没辙只能考虑其他的存储方式了。</p><p>其实微博也是有图床功能，访问速度是没的说的，重要的是免费，这里就简单介绍下极简图床中怎么使用微博图床。<br><a id="more"></a></p><h2 id="极简图床使用微博图床存储图片"><a href="#极简图床使用微博图床存储图片" class="headerlink" title="极简图床使用微博图床存储图片"></a>极简图床使用微博图床存储图片</h2><p>在极简图床的首页，可以看到<code>Chrome插件</code>的链接<br><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwsc1no1gfj20ka04adg9.jpg" alt=""></p><p>点进去可以看到安装插件的方法以及插件的使用方法。不过这里需要说明的是你在安装好插件后刷新页面，然后在极简图床设置使用微博图床。<br><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwsc3i1dp2j20bs03zq2t.jpg" alt=""></p><p>使用微博图床，你需要登陆微博。否则上传会提示你登陆微博。<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwsf512hzvj30gu06qq2y.jpg" alt=""></p><blockquote><p>这里建议你使用自己的微博小号去登陆，然后将突图片上传到这个账号的图床。不过要说明的是，其实你登陆自己的账号，在你的微博，相册等等地方都是看不到你上传的图片的。<br>所以，如果就是一般的使用，用自己的微博账号也无所谓了。</p></blockquote><p>微博小号的注册方法：<br><a href="https://jingyan.baidu.com/article/36d6ed1f9484b81bce488342.html">https://jingyan.baidu.com/article/36d6ed1f9484b81bce488342.html</a></p><p>使用就非常简单了。</p><p>在首页，你可以截图然后粘贴，即会自动上传；也可以选择文件上传，上传完毕后，可以复制图片地址，也可以复制markdown格式。<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwsf3x2snzj30nz0k8ajs.jpg" alt=""></p><p>还可以采集网络上的图片，不过要绑定七牛云账号？</p><p>在安装好插件后，点一下插件可以看到<br><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwsc59ofp1j20ag056mxa.jpg" alt=""></p><p>打开你想采集图片的网站，按ALT+1，即会自动采集图片，然后选择要保存的图片，点<code>采集</code>即可。 然后在极简图床的<code>我的上传</code>可以看到。</p><h2 id="使用新浪微博图床"><a href="#使用新浪微博图床" class="headerlink" title="使用新浪微博图床"></a>使用新浪微博图床</h2><p>在chrome浏览器添加<code>新浪微博图床</code>的扩展，直接使用新浪微博图床的api。<br>扩展地址：<a href="https://chrome.google.com/webstore/detail/%E6%96%B0%E6%B5%AA%E5%BE%AE%E5%8D%9A%E5%9B%BE%E5%BA%8A/fdfdnfpdplfbbnemmmoklbfjbhecpnhf?utm_source=chrome-app-launcher-info-dialog">谷歌商店</a></p><p>添加扩展后打开扩展即可以上传图片了。同样支持选择上传或粘贴上传，还包括多种格式的复制。<br>参考：<a href="https://51.ruyo.net/2624.html">https://51.ruyo.net/2624.html</a></p><h2 id="使用GitHub来做图床"><a href="#使用GitHub来做图床" class="headerlink" title="使用GitHub来做图床"></a>使用GitHub来做图床</h2><h3 id="更新于2018-12-14-发现微博图床不能使用了，提示必须是新浪用户才能查看，即做了防盗链处理。"><a href="#更新于2018-12-14-发现微博图床不能使用了，提示必须是新浪用户才能查看，即做了防盗链处理。" class="headerlink" title="更新于2018.12.14 发现微博图床不能使用了，提示必须是新浪用户才能查看，即做了防盗链处理。"></a>更新于2018.12.14 发现微博图床不能使用了，提示必须是新浪用户才能查看，即做了防盗链处理。</h3><p>找了一通，感觉还可以的是这个：<a href="https://tu.aixinxi.net/index.php">https://tu.aixinxi.net/index.php</a>，不过担心哪一天又不能使用了。所以最后找到使用GitHub来托管图片。<br>大概就是在GitHub创建一个repository，然后本地clone仓库，将图片放到仓库，提交到GitHub。然后在GitHub查看图片，复制地址栏的url，将url中的blob替换为raw即可。比如图片：<a href="https://github.com/luckystar88/blog_img/blob/master/Snipaste_2018-12-14_11-57-45.png">https://github.com/luckystar88/blog_img/blob/master/Snipaste_2018-12-14_11-57-45.png</a>，替换blob为raw后为：<a href="https://github.com/luckystar88/blog_img/raw/master/Snipaste_2018-12-14_11-57-45.png">https://github.com/luckystar88/blog_img/raw/master/Snipaste_2018-12-14_11-57-45.png</a>，这个地址贴到你的博客即可。<br><img src="https://github.com/luckystar88/blog_img/raw/master/Snipaste_2018-12-14_11-57-45.png" alt=""></p><p>参考：<a href="http://jingpin.jikexueyuan.com/article/36279.html">迁移博客图片者的福音：使用GitHub做免费不限流量图床</a></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Eclipse Springboot热部署</title>
      <link href="/2018/10/27/Eclipse%20Springboot%E7%83%AD%E9%83%A8%E7%BD%B2/"/>
      <url>/2018/10/27/Eclipse%20Springboot%E7%83%AD%E9%83%A8%E7%BD%B2/</url>
      
        <content type="html"><![CDATA[<p>1.pom.xml增加spring-boot-devtools依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.spring-boot-maven-plugin插件配置fork=true<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>3.设置自动build<br>eclipse –&gt; Project –&gt; Build Automatically 要选中，不选中的话不起作用。<br><a id="more"></a><br>4.页面热部署<br>设置spring.thymeleaf.cache=false来实现</p><p>5.devtools的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#热部署生效</span><br><span class="line">spring.devtools.restart.enabled: true</span><br><span class="line">#设置重启的目录</span><br><span class="line">#spring.devtools.restart.additional-paths: src/main/java</span><br><span class="line">#classpath目录下的WEB-INF文件夹内容修改不重启</span><br><span class="line">spring.devtools.restart.exclude: WEB-INF/**</span><br></pre></td></tr></table></figure></p><p>6.解决js无法动态更新的问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;/js/appjs/system/sysDept/sysDept.js?ver=1&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>即增加?ver=1<br>参考：<a href="http://www.cnblogs.com/TBhome/archive/2017/09/08/7493473.html">http://www.cnblogs.com/TBhome/archive/2017/09/08/7493473.html</a></p><p>7.测试</p><ul><li>修改类–&gt;保存：应用会重启</li><li>修改配置文件–&gt;保存：应用会重启</li><li>修改页面–&gt;保存：应用不会重启，但会重新加载，页面会刷新（原理是将spring.thymeleaf.cache设为false，参考:Spring Boot配置模板引擎）</li></ul><p>参考：<a href="https://blog.csdn.net/liben0429/article/details/79011775">https://blog.csdn.net/liben0429/article/details/79011775</a>、<a href="https://www.cnblogs.com/cx-code/p/8686453.html">https://www.cnblogs.com/cx-code/p/8686453.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> eclipse </tag>
            
            <tag> STS </tag>
            
            <tag> 热部署 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用MapStruct在实体间转换</title>
      <link href="/2018/10/27/%E4%BD%BF%E7%94%A8MapStruct%E5%9C%A8%E5%AE%9E%E4%BD%93%E9%97%B4%E8%BD%AC%E6%8D%A2/"/>
      <url>/2018/10/27/%E4%BD%BF%E7%94%A8MapStruct%E5%9C%A8%E5%AE%9E%E4%BD%93%E9%97%B4%E8%BD%AC%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>MapStruct是一个代码生成器的工具类，简化了不同的Java Bean之间映射的处理，所以映射指的就是从一个实体变化成一个实体。在实际项目中，我们经常会将PO转DTO、DTO转PO等一些实体间的转换。在转换时大部分属性都是相同的，只有少部分的不同，这时我们可以通过mapStruct的一些注解来匹配不同属性，可以让不同实体之间的转换变的简单。<br>使用MapStruct在编译时会生成响应的转换实现类，所以没有性能损耗。<br>MapStruct官网地址： <a href="http://mapstruct.org/">http://mapstruct.org/</a><br><a id="more"></a></p><h2 id="搭建开发环境-–基于Maven"><a href="#搭建开发环境-–基于Maven" class="headerlink" title="搭建开发环境 –基于Maven"></a>搭建开发环境 –基于Maven</h2><p>这里需要在配置文件pom.xml中进行如下配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;org.mapstruct.version&gt;1.1.0.Beta1&lt;/org.mapstruct.version&gt;--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">org.mapstruct.version</span>&gt;</span>1.1.0.Final<span class="tag">&lt;/<span class="name">org.mapstruct.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-jdk8<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;junit&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">            &lt;version&gt;4.12&lt;/version&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mapstruct<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mapstruct-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;org.mapstruct.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">annotationProcessorPaths</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><h2 id="MapStruct实体间的转换"><a href="#MapStruct实体间的转换" class="headerlink" title="MapStruct实体间的转换"></a>MapStruct实体间的转换</h2><p>下面我们就来看看如何使用MapStruct实现实体之间的映射转换。下面两个类非常相似，有一个号码属性名不一样及在PeopleDTO中有个User对象，而在People中则是两个字符串属性。</p><p>PeopleEntity.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleEntity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String callNumber;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> String emile;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//constructor, getters, setters etc.</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PeopleDTO.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleDTO</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String phoneNumber;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> String emile;</span><br><span class="line">    <span class="keyword">private</span> User  user;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//constructor, getters, setters etc.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>User.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//constructor, getters, setters etc.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Mapper接口<br>要生成一个PeopleDTO与PeopleEntity对象相互转换的映射器，我们需要定义一个mapper接口。像这两个实体类有些属性不一样时，我们可以通过@Mapping注解来进行转换. </p><ul><li>@Mapper注解标记这个接口作为一个映射接口，并且是编译时MapStruct处理器的入口。<br>  只有在接口加上这个注解， MapStruct 才会去实现该接口。<br>  @Mapper 里有个 componentModel 属性，主要是指定实现类的类型，一般用到两个    default：默认，可以通过 Mappers.getMapper(Class) 方式获取实例对象<br>  spring：在接口的实现类上自动添加注解，@Component，可通过 @Autowired 方式注入。</li><li>@Mapping解决源对象和目标对象中，属性名字不同的情况。</li><li>Mappers.getMapper自动生成的接口的实现可以通过Mapper的class对象获取,从而让客户端可以访问Mapper接口的实现。</li><li>source：源属性</li><li>target：目标属性</li><li>dateFormat：String 到 Date 日期之间相互转换，通过 SimpleDateFormat，该值为SimpleDateFormat的日期格式</li><li>ignore: 忽略这个字段</li><li>@Mappings：配置多个@Mapping</li><li>@MappingTarget 用于更新已有对象</li><li>@InheritConfiguration 用于继承配置<br>这里只是列举了常用的字段和注解，详细的参考官方文档：<a href="http://mapstruct.org/documentation/stable/reference/html/">http://mapstruct.org/documentation/stable/reference/html/</a></li></ul><p>PeopleMapper.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PeopleMapper</span> </span>&#123;</span><br><span class="line">    PeopleMapper INSTANCE = Mappers.getMapper(PeopleMapper.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PO转DTO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity PO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> DTO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"phoneNumber"</span>, source = <span class="string">"callNumber"</span>)</span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"user.name"</span>, source = <span class="string">"name"</span>)</span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"user.age"</span>, source = <span class="string">"age"</span>)</span><br><span class="line">    <span class="function">PeopleDTO <span class="title">entityToDTO</span><span class="params">(PeopleEntity entity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DTO转PO</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> peopleDTO DTO</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity    PO</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"callNumber"</span>, source = <span class="string">"phoneNumber"</span>)</span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"name"</span>, source = <span class="string">"user.name"</span>)</span><br><span class="line">    <span class="meta">@Mapping</span>(target = <span class="string">"age"</span>, source = <span class="string">"user.age"</span>)</span><br><span class="line"><span class="comment">// @MappingTarget告诉MapStruct在现有对象（PeopleEntity）上进行更新，而不是new一个新对象。</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateEntityFromDto</span><span class="params">(PeopleDTO peopleDTO, @MappingTarget PeopleEntity entity)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>编译MapStruct </p><blockquote><p> MapStruct是以Java编译器插件的形式来处理注解，生成mapper接口的实现。因此在使用之前我们要手工编译或启动程序时IDEA也会帮我们编译了，这里最好还是手动编译。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mvn compile</span><br><span class="line">// 有的IDEA是  mvnw compile</span><br></pre></td></tr></table></figure><p>编译完后的实现类可以到target目录看到PeopleMapperImpl.Java,如下图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-27/88323331.jpg" alt=""></p><p>这时你也可以点进看里面代码的实现PeopleMapperImpl.Java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeopleMapperImpl</span> <span class="keyword">implements</span> <span class="title">PeopleMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PeopleMapperImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PeopleDTO <span class="title">entityToDTO</span><span class="params">(PeopleEntity entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(entity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PeopleDTO peopleDTO = <span class="keyword">new</span> PeopleDTO();</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            peopleDTO.setUser(user);</span><br><span class="line">            user.setAge(entity.getAge());</span><br><span class="line">            user.setName(entity.getName());</span><br><span class="line">            peopleDTO.setPhoneNumber(entity.getCallNumber());</span><br><span class="line">            peopleDTO.setAddress(entity.getAddress());</span><br><span class="line">            peopleDTO.setEmile(entity.getEmile());</span><br><span class="line">            <span class="keyword">return</span> peopleDTO;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateEntityFromDto</span><span class="params">(PeopleDTO peopleDTO, PeopleEntity entity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(peopleDTO != <span class="keyword">null</span>) &#123;</span><br><span class="line">            entity.setName(<span class="keyword">this</span>.peopleDTOUserName(peopleDTO));</span><br><span class="line">            entity.setCallNumber(peopleDTO.getPhoneNumber());</span><br><span class="line">            entity.setAge(<span class="keyword">this</span>.peopleDTOUserAge(peopleDTO));</span><br><span class="line">            entity.setAddress(peopleDTO.getAddress());</span><br><span class="line">            entity.setEmile(peopleDTO.getEmile());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">peopleDTOUserName</span><span class="params">(PeopleDTO peopleDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(peopleDTO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            User user = peopleDTO.getUser();</span><br><span class="line">            <span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String name = user.getName();</span><br><span class="line">                <span class="keyword">return</span> name == <span class="keyword">null</span>?<span class="keyword">null</span>:name;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Integer <span class="title">peopleDTOUserAge</span><span class="params">(PeopleDTO peopleDTO)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(peopleDTO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            User user = peopleDTO.getUser();</span><br><span class="line">            <span class="keyword">if</span>(user == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Integer age = user.getAge();</span><br><span class="line">                <span class="keyword">return</span> age == <span class="keyword">null</span>?<span class="keyword">null</span>:age;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="Mapper使用"><a href="#Mapper使用" class="headerlink" title="Mapper使用"></a>Mapper使用</h2><p>最后我们就来看看Mapper的使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapperTestApplication</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(MapperTestApplication.class);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//PO转DTO</span></span><br><span class="line">        PeopleEntity peopleEntity = <span class="keyword">new</span> PeopleEntity(<span class="number">18</span>, <span class="string">"yoyo"</span>, <span class="string">"13215849"</span>,</span><br><span class="line">                <span class="string">"shanghai "</span>, <span class="string">"fdhf@163.com"</span>);</span><br><span class="line">        PeopleDTO peopleDTO = PeopleMapper.INSTANCE.entityToDTO(peopleEntity);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//DTO转PO</span></span><br><span class="line">        User user = <span class="keyword">new</span> User(<span class="number">21</span>, <span class="string">"jack"</span>);</span><br><span class="line">        PeopleDTO newP = <span class="keyword">new</span> PeopleDTO(<span class="string">"000000"</span>,</span><br><span class="line">                <span class="string">"changsha "</span>, <span class="string">"jack@163.com"</span>, user);</span><br><span class="line">        PeopleEntity newEntity = <span class="keyword">new</span> PeopleEntity();</span><br><span class="line">        PeopleMapper.INSTANCE.updateEntityFromDto(newP, newEntity);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        LOGGER.info(<span class="string">"PO转DTO peopleEntity==&gt;"</span> + peopleEntity.toString() + <span class="string">"\n peopleDTO==&gt;"</span> + peopleDTO.toString());</span><br><span class="line">        LOGGER.info(<span class="string">"DTO转PO PeopleDTO==&gt;"</span> + newP.toString() + <span class="string">"\n peopleDTO==&gt;"</span> + newEntity.toString());</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(MapperTestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动之后你可以在后台看到如下的输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">11:12:28.602 [main] INFO com.example.demo.MapperTestApplication - PO转DTO peopleEntity==&gt;PeopleEntity&#123;age=18, name=&apos;yoyo&apos;, callNumber=&apos;13215849&apos;, address=&apos;shanghai &apos;, emile=&apos;fdhf@163.com&apos;&#125;</span><br><span class="line"> peopleDTO==&gt;PeopleDTO&#123;phoneNumber=&apos;13215849&apos;, address=&apos;shanghai &apos;, emile=&apos;fdhf@163.com&apos;, user=User&#123;age=18, name=&apos;yoyo&apos;&#125;&#125;</span><br><span class="line">11:12:28.604 [main] INFO com.example.demo.MapperTestApplication - DTO转PO PeopleDTO==&gt;PeopleDTO&#123;phoneNumber=&apos;000000&apos;, address=&apos;changsha &apos;, emile=&apos;jack@163.com&apos;, user=User&#123;age=21, name=&apos;jack&apos;&#125;&#125;</span><br><span class="line"> peopleDTO==&gt;PeopleEntity&#123;age=21, name=&apos;jack&apos;, callNumber=&apos;000000&apos;, address=&apos;changsha &apos;, emile=&apos;jack@163.com&apos;&#125;</span><br></pre></td></tr></table></figure></p><p>通过从上面后台输出的数据我们可以看出，对于属性名称不同的情况、以及属性类型不同都自动帮助我们转换了，是不是感觉很神奇，是不是感觉很强大.再也不用自己写大量的代码进行实体间的转换了。</p><p>本文转载于：<a href="https://blog.csdn.net/lx_yoyo/article/details/75061614">https://blog.csdn.net/lx_yoyo/article/details/75061614</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> MapStruct </tag>
            
            <tag> 对象转换 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatis foreach批量操作</title>
      <link href="/2018/10/26/mybatis%20foreach%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/"/>
      <url>/2018/10/26/mybatis%20foreach%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C/</url>
      
        <content type="html"><![CDATA[<h2 id="foreach属性"><a href="#foreach属性" class="headerlink" title="foreach属性"></a>foreach属性</h2><ul><li><p>item<br>循环体中的具体对象。支持属性的点路径访问，如item.age,item.info.details。<br>具体说明：在list和数组中是其中的对象，在map中是value。<br>该参数为必选。</p></li><li><p>collection<br>要做foreach的对象，作为入参时，List&lt;?&gt;对象默认用list代替作为键，数组对象有array代替作为键，Map对象用map代替作为键。<br>当然在作为入参时可以使用@Param(“keyName”)来设置键，设置keyName后，list,array,map将会失效。 除了入参这种情况外，还有一种作为参数对象的某个字段的时候。举个例子：<br>如果User有属性List ids。入参是User对象，那么这个collection = “ids”<br>如果User有属性Ids ids;其中Ids是个对象，Ids有个属性List id;入参是User对象，那么collection = “ids.id”<br>上面只是举例，具体collection等于什么，就看你想对那个元素做循环。<br>该参数为必选。</p><a id="more"></a></li><li><p>separator<br>元素之间的分隔符，例如在in()的时候，separator=”,”会自动在元素中间用“,“隔开，避免手动输入逗号导致sql错误，如in(1,2,)这样。该参数可选。</p></li><li><p>open<br>foreach代码的开始符号，一般是(和close=”)”合用。常用在in(),values()时。该参数可选。</p></li><li><p>close<br>foreach代码的关闭符号，一般是)和open=”(“合用。常用在in(),values()时。该参数可选。</p></li><li><p>index<br>在list和数组中,index是元素的序号，在map中，index是元素的key，该参数可选。</p></li></ul><h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><h3 id="实现-xx-in"><a href="#实现-xx-in" class="headerlink" title="实现 xx in ()"></a>实现 xx in ()</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"countByUserList"</span> <span class="attr">resultType</span>=<span class="string">"int"</span> <span class="attr">parameterType</span>=<span class="string">"list"</span>&gt;</span>  </span><br><span class="line">select * from t_user  </span><br><span class="line">  <span class="tag">&lt;<span class="name">where</span>&gt;</span>  </span><br><span class="line">    id in  </span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">index</span>=<span class="string">""</span>&gt;</span>  </span><br><span class="line">      #&#123;item.id, jdbcType=NUMERIC&#125;  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">where</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>sql效果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span> <span class="keyword">in</span> ( ? , ? )</span><br></pre></td></tr></table></figure></p><h3 id="批量插入数据（参数List）"><a href="#批量插入数据（参数List）" class="headerlink" title="批量插入数据（参数List）"></a>批量插入数据（参数List）</h3><p>SQL效果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_user <span class="keyword">select</span> ?,? <span class="keyword">from</span> dual <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> ?,? <span class="keyword">from</span> dual</span><br></pre></td></tr></table></figure></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"addUserList"</span>&gt;</span></span><br><span class="line">    INSERT INTO DELIVER</span><br><span class="line">        (</span><br><span class="line">            id,name</span><br><span class="line">         )</span><br><span class="line">      <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"userList"</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">separator</span>=<span class="string">"UNION ALL"</span>&gt;</span></span><br><span class="line">            SELECT </span><br><span class="line">                 #&#123;item.id, jdbcType=NUMERIC&#125;,</span><br><span class="line">                 #&#123;item.name, jdbcType=VARCHAR&#125;</span><br><span class="line">            FROM DUAL</span><br><span class="line">      <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="批量插入数据-参数Map"><a href="#批量插入数据-参数Map" class="headerlink" title="批量插入数据(参数Map)"></a>批量插入数据(参数Map)</h3><p>sql:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t_user (<span class="keyword">key</span>, <span class="keyword">value</span>) <span class="keyword">values</span> (?, ?) , (?, ?)</span><br></pre></td></tr></table></figure></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"batchSaveUser"</span>&gt;</span>  </span><br><span class="line">    insert into t_user (key, value) values  </span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">index</span>=<span class="string">"key"</span> <span class="attr">collection</span>=<span class="string">"map"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">open</span>=<span class="string">""</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">""</span>&gt;</span>(#&#123;key&#125;, #&#123;item&#125;)<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中Map的key是列名，value是字段值。</p><h3 id="动态查询数据（根据列名不同）"><a href="#动态查询数据（根据列名不同）" class="headerlink" title="动态查询数据（根据列名不同）"></a>动态查询数据（根据列名不同）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"dynamicQuery"</span> <span class="attr">resultType</span>=<span class="string">"int"</span>&gt;</span>  </span><br><span class="line">    select count(*) from t_user where  </span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">index</span>=<span class="string">"key"</span> <span class="attr">collection</span>=<span class="string">"map"</span>  </span></span><br><span class="line"><span class="tag">        <span class="attr">open</span>=<span class="string">""</span> <span class="attr">separator</span>=<span class="string">"AND"</span> <span class="attr">close</span>=<span class="string">""</span>&gt;</span>$&#123;key&#125; = #&#123;item&#125;<span class="tag">&lt;/<span class="name">foreach</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>一定要注意到$和#的区别，$的参数直接输出，#的参数会被替换为?，然后传入参数值执行。</p></blockquote><h3 id="批量插入数据（List参数）"><a href="#批量插入数据（List参数）" class="headerlink" title="批量插入数据（List参数）"></a>批量插入数据（List<Map>参数）</h3><p>示例参数：<code>List&lt;Map&lt;String,Object&gt;&gt;</code></p><p>这里想实现的功能是批量插入数据。生成的SQL如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sys_outpatient_his(sys_id,his_id,is_receive,gmt_create) <span class="keyword">values</span> (?,?,?),(?,?,?),(?,?,?)</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Map&lt;String, Object&gt;&gt; items = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">Long sysId = <span class="number">1L</span>;</span><br><span class="line">Long hisId = <span class="number">0L</span>;</span><br><span class="line"><span class="keyword">short</span> isReceive = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++) &#123;</span><br><span class="line">    isReceive = (<span class="keyword">short</span>) (i == <span class="number">1</span> ? <span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    hisId = (<span class="keyword">long</span>) (i+<span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, Object&gt; param = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">    param.put(<span class="string">"sysId"</span>, sysId);</span><br><span class="line">    param.put(<span class="string">"hisId"</span>, hisId);</span><br><span class="line">    param.put(<span class="string">"isReceive"</span>, isReceive);</span><br><span class="line">    items.add(param);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.dao.batchSaveSysAndHisRelation(items);</span><br></pre></td></tr></table></figure><p>Mapper类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">batchSaveSysAndHisRelation</span><span class="params">(@Param(<span class="string">"params"</span>)</span> List&lt;Map&lt;String,Object&gt;&gt; params)</span>;</span><br></pre></td></tr></table></figure></p><p>mybatis xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"batchSaveSysAndHisRelation"</span>&gt;</span></span><br><span class="line">    insert into sys_outpatient_his(sys_id,his_id,is_receive,gmt_create) values</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"his"</span> <span class="attr">index</span>=<span class="string">"i"</span> <span class="attr">collection</span>=<span class="string">"params"</span> <span class="attr">open</span>=<span class="string">""</span> <span class="attr">close</span>=<span class="string">""</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">    (#&#123;his.sysId&#125;,#&#123;his.hisId&#125;,#&#123;his.isReceive&#125;,now())</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="遍历Map参数"><a href="#遍历Map参数" class="headerlink" title="遍历Map参数"></a>遍历Map参数</h3><p>这里想实现的是根据sysId和hisIds删除数据，其中hisIds是要给数组。<br>SQL如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> sys_outpatient_his <span class="keyword">where</span> sys_id = ? <span class="keyword">and</span> his_id <span class="keyword">in</span> ( ? , ? , ? )</span><br></pre></td></tr></table></figure></p><p>调用代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; params = <span class="keyword">new</span> HashMap(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">params.put(<span class="string">"sysId"</span>, <span class="number">1L</span>);</span><br><span class="line">Long[] ids = &#123;<span class="number">1L</span>,<span class="number">2L</span>,<span class="number">3L</span>&#125;;</span><br><span class="line">params.put(<span class="string">"hisIds"</span>, ids);</span><br><span class="line"></span><br><span class="line"><span class="keyword">this</span>.dao.batchRemoveSysAndHisRelation(params);</span><br></pre></td></tr></table></figure></p><p>Mapper:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">batchRemoveSysAndHisRelation</span><span class="params">(@Param(<span class="string">"params"</span>)</span> Map&lt;String,Object&gt; params)</span>;</span><br></pre></td></tr></table></figure></p><p>mybatis xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"batchRemoveSysAndHisRelation"</span> <span class="attr">parameterType</span>=<span class="string">"map"</span>&gt;</span></span><br><span class="line">delete from sys_outpatient_his where sys_id = #&#123;params.sysId&#125;</span><br><span class="line">    and his_id in </span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"hisId"</span> <span class="attr">collection</span>=<span class="string">"params.hisIds"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">close</span>=<span class="string">")"</span> <span class="attr">separator</span>=<span class="string">","</span>&gt;</span></span><br><span class="line">    #&#123;hisId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="判断参数是否存在"><a href="#判断参数是否存在" class="headerlink" title="判断参数是否存在"></a>判断参数是否存在</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"params.containsKey('sysId')"</span>&gt;</span></span><br><span class="line">    AND sysId = #&#123;sysId,jdbcType=VARCHAR&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果不指定参数：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"_parameter.containsKey('sysId')"</span>&gt;</span></span><br><span class="line">    AND sysId = #&#123;sysId,jdbcType=VARCHAR&#125;)</span><br><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://blog.csdn.net/wangyangbto/article/details/18049131">https://blog.csdn.net/wangyangbto/article/details/18049131</a> 、<a href="https://blog.csdn.net/jason5186/article/details/40896043">https://blog.csdn.net/jason5186/article/details/40896043</a></p><h3 id="foreach嵌套"><a href="#foreach嵌套" class="headerlink" title="foreach嵌套"></a>foreach嵌套</h3><p>参考：<a href="https://blog.csdn.net/bidelinqi12/article/details/53121279">https://blog.csdn.net/bidelinqi12/article/details/53121279</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>centos7安装MariaDB数据库(mysql)</title>
      <link href="/2018/10/25/centos7%E5%AE%89%E8%A3%85MariaDB%E6%95%B0%E6%8D%AE%E5%BA%93(mysql)/"/>
      <url>/2018/10/25/centos7%E5%AE%89%E8%A3%85MariaDB%E6%95%B0%E6%8D%AE%E5%BA%93(mysql)/</url>
      
        <content type="html"><![CDATA[<h2 id="MariaDB数据安装"><a href="#MariaDB数据安装" class="headerlink" title="MariaDB数据安装"></a>MariaDB数据安装</h2><p>从最新版本的linux系统开始(CentOs7），默认的是 Mariadb而不是mysql！</p><p>Linux版本查看：<a href="http://baijiahao.baidu.com/s?id=1601324352730835989&amp;wfr=spider&amp;for=pc">http://baijiahao.baidu.com/s?id=1601324352730835989&amp;wfr=spider&amp;for=pc</a></p><p>使用系统自带的repos安装很简单：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum install mariadb mariadb-server</span><br><span class="line"></span><br><span class="line">systemctl start mariadb ==&gt; 启动mariadb</span><br><span class="line"></span><br><span class="line">systemctl enable mariadb ==&gt; 开机自启动</span><br><span class="line"></span><br><span class="line">mysql_secure_installation ==&gt; 设置 root密码等相关</span><br><span class="line"></span><br><span class="line">mysql -uroot -p123456 ==&gt; 测试登录！</span><br></pre></td></tr></table></figure></p><p>如果之前安装了mysql没成功，又安装的Mariadb，可能会不成功。<br>需要先将原来的mysql和MariaDB卸载。<br><a id="more"></a><br>参考：<a href="https://blog.csdn.net/sunny05296/article/details/56015884/">https://blog.csdn.net/sunny05296/article/details/56015884/</a></p><h2 id="数据库设置"><a href="#数据库设置" class="headerlink" title="数据库设置"></a>数据库设置</h2><p>安装完成后，默认数据库用户名为root，密码为空。</p><p>然后可以通过下面的命令修改密码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin  -uroot -p  password &apos;1q2w3e&apos;</span><br></pre></td></tr></table></figure></p><p>初始root密码为空，设置root密码为1q2w3e。然后就可以本地mysql -uroot -p1q2w3e登录了。</p><p>修改字符集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/my.conf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">datadir=/var/lib/mysql</span><br><span class="line">socket=/var/lib/mysql/mysql.sock</span><br><span class="line"></span><br><span class="line">character-set-server=utf8</span><br><span class="line">collation-server=utf8_bin</span><br></pre></td></tr></table></figure></p><h2 id="配置远程访问"><a href="#配置远程访问" class="headerlink" title="配置远程访问"></a>配置远程访问</h2><p>首先配置允许访问的用户，采用授权的方式给用户权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &apos;root&apos;@&apos;%&apos;IDENTIFIED BY &apos;123456&apos; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure></p><p> 说明：root是登陆数据库的用户，123456是登陆数据库的密码，*就是意味着任何来源任何主机反正就是权限很大的样子。</p><p>最后配置好权限之后不应该忘记刷新使之生效</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>再次访问就可以了吧。</p><p>注意关闭防火墙或允许mysql的端口对外访问。</p><h2 id="安装新版本MariaDB"><a href="#安装新版本MariaDB" class="headerlink" title="安装新版本MariaDB"></a>安装新版本MariaDB</h2><p>centos7默认自带的mariadb版本是5.5，如果要安装新版本，需要先下载旧版本。</p><h3 id="卸载旧版本"><a href="#卸载旧版本" class="headerlink" title="卸载旧版本"></a>卸载旧版本</h3><p>entos7下默认安装有mariadb数据库，但是是旧版本，在安装新版本前需要先把旧版本删除，有些系统还默认安装mysql，也必须删除，否则与mariadb会产生冲突，如下命令过程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep mariadb</span><br></pre></td></tr></table></figure></p><p>结果如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-25/49535543.jpg" alt=""></p><p>用命令yum删除以上三个：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum remove mariadb-server-5.5.60-1.el7_5.x86_64</span><br><span class="line">yum remove mariadb-libs-5.5.60-1.el7_5.x86_64</span><br><span class="line">yum remove mariadb-5.5.60-1.el7_5.x86_64</span><br></pre></td></tr></table></figure></p><p>###　创建 MariaDB.repo<br>在/etc/yum.repos.d目录（没有则创建）下新建mariadb.repo文件。<br>文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># MariaDB 10.2 CentOS repository list - created 2017-07-03 06:59 UTC</span><br><span class="line"></span><br><span class="line"># http://downloads.mariadb.org/mariadb/repositories/</span><br><span class="line"></span><br><span class="line">[mariadb]</span><br><span class="line"></span><br><span class="line">name = MariaDB</span><br><span class="line"></span><br><span class="line">baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.2/centos7-amd64</span><br><span class="line"></span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line"></span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure></p><h3 id="安装MariaDB"><a href="#安装MariaDB" class="headerlink" title="安装MariaDB"></a>安装MariaDB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install MariaDB-server MariaDB-client</span><br></pre></td></tr></table></figure><h3 id="安装完成MariaDB，首先启动MariaDB"><a href="#安装完成MariaDB，首先启动MariaDB" class="headerlink" title="安装完成MariaDB，首先启动MariaDB"></a>安装完成MariaDB，首先启动MariaDB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mariadb</span><br></pre></td></tr></table></figure><h3 id="设置开机启动"><a href="#设置开机启动" class="headerlink" title="设置开机启动"></a>设置开机启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure><h3 id="接下来进行MariaDB的相关简单配置"><a href="#接下来进行MariaDB的相关简单配置" class="headerlink" title="接下来进行MariaDB的相关简单配置"></a>接下来进行MariaDB的相关简单配置</h3><p>输入以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_secure_installation</span><br></pre></td></tr></table></figure></p><p>先是设置密码，会提示先输入密码</p><p>Enter current password for root (enter for none):&lt;–初次运行直接回车</p><p>设置密码</p><p>Set root password? [Y/n] &lt;– 是否设置root用户密码，输入y并回车或直接回车</p><p>New password: &lt;– 设置root用户的密码</p><p>Re-enter new password: &lt;– 再输入一次你设置的密码</p><p>其他配置</p><p>Remove anonymous users? [Y/n] &lt;– 是否删除匿名用户，Y，回车</p><p>Disallow root login remotely? [Y/n] &lt;–是否禁止root远程登录,N，回车,</p><p>Remove test database and access to it? [Y/n] &lt;– 是否删除test数据库，n,回车</p><p>Reload privilege tables now? [Y/n] &lt;– 是否重新加载权限表，回车</p><p>初始化MariaDB完成，接下来测试登录</p><h3 id="测试登录"><a href="#测试登录" class="headerlink" title="测试登录"></a>测试登录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br></pre></td></tr></table></figure><p>回车输入密码<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-25/38283760.jpg" alt=""></p><h3 id="修改默认端口"><a href="#修改默认端口" class="headerlink" title="修改默认端口"></a>修改默认端口</h3><p>vi /etc/my.conf.d/server.cnf<br>在<code>[mysqld]</code>下添加<code>port=13306</code>。保存后，重启mysql服务<code>service mysql restart</code>。</p><h2 id="为指定数据库设置某个用户的权限"><a href="#为指定数据库设置某个用户的权限" class="headerlink" title="为指定数据库设置某个用户的权限"></a>为指定数据库设置某个用户的权限</h2><p>创建用户testUser，数据库test2，将test2数据库的所有权限授权给testUser.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql -u xx -p;--登录mysql</span><br><span class="line">CREATE USER &apos;test_user&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos;;--创建test_user用户</span><br><span class="line">grant all privileges on test_user.* to test2@&quot;%&quot; identified by &apos;123456&apos;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><p>参考：<a href="http://blog.sina.com.cn/s/blog_e7fdbcf30102yq3b.html">http://blog.sina.com.cn/s/blog_e7fdbcf30102yq3b.html</a>、<a href="https://blog.csdn.net/lu8000/article/details/83148577">https://blog.csdn.net/lu8000/article/details/83148577</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot打包，分离依赖jar，配置文件</title>
      <link href="/2018/10/25/springboot%E6%89%93jar%E5%8C%85%E5%88%86%E7%A6%BBlib%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
      <url>/2018/10/25/springboot%E6%89%93jar%E5%8C%85%E5%88%86%E7%A6%BBlib%E5%92%8C%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>springboot工程，通常我们在pom.xml中配置了<code>spring-boot-maven-plugin</code>插件后，就可以将springboot工程打包为一个可执行Jar，然后通过<code>java -jar xx.jar</code>的方式就可以运行你，非常方便。</p><p>但是，该插件是件所有依赖的jar和资源文件都打到你要的jar包中，有时候我们可能想将资源文件和第三方依赖分开，不要打到jar中。比如在测试环境或线上更新某个class，如果要将整个包含第三方依赖和资源文件的jar上传，那是很大的，也是不必要的。<br><a id="more"></a><br>这里我们想实现的效果如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-25/30881584.jpg" alt=""></p><ul><li>doctors-2.0.0.jar是我们最终打的jar包，它只包含我们自己写的java文件编译后的class。</li><li>resource是我们项目的资源文件</li><li>lib是项目依赖的第三方jar</li></ul><p>现在我们借助4个maven插件来实现这一目的</p><p>完整pom如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&lt;plugins&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--打包jar--&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">            &lt;!--不打包资源文件,exclude的目录不是src下面的，是以编译结果classes为根目录计算--&gt;</span><br><span class="line">            &lt;excludes&gt;</span><br><span class="line">                &lt;exclude&gt;/config/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/META-INF/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/mybatis/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/public/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/schema/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/static/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;/templates/**&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;*.yml&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;*.xml&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;*.properties&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;*.json&lt;/exclude&gt;</span><br><span class="line">                &lt;exclude&gt;*.bpmn&lt;/exclude&gt;</span><br><span class="line">            &lt;/excludes&gt;</span><br><span class="line">            &lt;archive&gt;</span><br><span class="line">                &lt;manifest&gt;</span><br><span class="line">                    &lt;addClasspath&gt;true&lt;/addClasspath&gt;</span><br><span class="line">                    &lt;!--MANIFEST.MF 中 Class-Path 加入前缀--&gt;</span><br><span class="line">                    &lt;classpathPrefix&gt;lib/&lt;/classpathPrefix&gt;</span><br><span class="line">                    &lt;!--jar包不包含唯一版本标识--&gt;</span><br><span class="line">                    &lt;useUniqueVersions&gt;false&lt;/useUniqueVersions&gt;</span><br><span class="line">                    &lt;!--指定入口类--&gt;</span><br><span class="line">                    &lt;mainClass&gt;com.doctors.Application&lt;/mainClass&gt;</span><br><span class="line">                &lt;/manifest&gt;</span><br><span class="line">                &lt;manifestEntries&gt;</span><br><span class="line">                    &lt;!--MANIFEST.MF 中 Class-Path 加入资源文件目录--&gt;</span><br><span class="line">                    &lt;Class-Path&gt;./resources/&lt;/Class-Path&gt;</span><br><span class="line">                &lt;/manifestEntries&gt;</span><br><span class="line">            &lt;/archive&gt;</span><br><span class="line">            &lt;outputDirectory&gt;$&#123;project.build.directory&#125;&lt;/outputDirectory&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--拷贝依赖 copy-dependencies--&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">            &lt;execution&gt;</span><br><span class="line">                &lt;id&gt;copy-dependencies&lt;/id&gt;</span><br><span class="line">                &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                &lt;goals&gt;</span><br><span class="line">                    &lt;goal&gt;copy-dependencies&lt;/goal&gt;</span><br><span class="line">                &lt;/goals&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;outputDirectory&gt;</span><br><span class="line">                        $&#123;project.build.directory&#125;/lib/</span><br><span class="line">                    &lt;/outputDirectory&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--拷贝资源文件 copy-resources--&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">            &lt;execution&gt;</span><br><span class="line">                &lt;id&gt;copy-resources&lt;/id&gt;</span><br><span class="line">                &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">                &lt;goals&gt;</span><br><span class="line">                    &lt;goal&gt;copy-resources&lt;/goal&gt;</span><br><span class="line">                &lt;/goals&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;resources&gt;</span><br><span class="line">                        &lt;resource&gt;</span><br><span class="line">                            &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">                        &lt;/resource&gt;</span><br><span class="line">                    &lt;/resources&gt;</span><br><span class="line">                    &lt;outputDirectory&gt;$&#123;project.build.directory&#125;/resources&lt;/outputDirectory&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--spring boot repackage，依赖 maven-jar-plugin 打包的jar包 重新打包成 spring boot 的jar包--&gt;</span><br><span class="line">    &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;configuration&gt;</span><br><span class="line">            &lt;!--重写包含依赖，包含不存在的依赖，jar里没有pom里的依赖--&gt;</span><br><span class="line">            &lt;includes&gt;</span><br><span class="line">                &lt;include&gt;</span><br><span class="line">                    &lt;groupId&gt;null&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;null&lt;/artifactId&gt;</span><br><span class="line">                &lt;/include&gt;</span><br><span class="line">            &lt;/includes&gt;</span><br><span class="line">            &lt;layout&gt;ZIP&lt;/layout&gt;</span><br><span class="line">            &lt;!--使用外部配置文件，jar包里没有资源文件--&gt;</span><br><span class="line">            &lt;addResources&gt;true&lt;/addResources&gt;</span><br><span class="line">            &lt;outputDirectory&gt;$&#123;project.build.directory&#125;&lt;/outputDirectory&gt;</span><br><span class="line">        &lt;/configuration&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">            &lt;execution&gt;</span><br><span class="line">                &lt;goals&gt;</span><br><span class="line">                    &lt;goal&gt;repackage&lt;/goal&gt;</span><br><span class="line">                &lt;/goals&gt;</span><br><span class="line">                &lt;configuration&gt;</span><br><span class="line">                    &lt;!--配置jar包特殊标识 配置后，保留原文件，生成新文件 *-run.jar --&gt;</span><br><span class="line">                    &lt;!--配置jar包特殊标识 不配置，原文件命名为 *.jar.original，生成新文件 *.jar --&gt;</span><br><span class="line">                    &lt;!--&lt;classifier&gt;run&lt;/classifier&gt;--&gt;</span><br><span class="line">                &lt;/configuration&gt;</span><br><span class="line">            &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">    &lt;/plugin&gt;</span><br><span class="line">&lt;/plugins&gt;</span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://www.jianshu.com/p/dbdece9062b3">https://www.jianshu.com/p/dbdece9062b3</a></p><p>然后我们将生成的.jar文件、resources目录和lib目录拷贝到服务器上，使用<code>java -jar xx.jar</code>即可。<br>可以使用nohup后台运行程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup java -jar xx.jar &amp;</span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://www.cnblogs.com/zery/p/7799005.html">https://www.cnblogs.com/zery/p/7799005.html</a></p><blockquote><p>一个注意点：排除资源目录，是以编译后的class目录开始计算的，不是src开始。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>外网ip注册dubbo服务</title>
      <link href="/2018/10/12/%E5%A4%96%E7%BD%91ip%E6%B3%A8%E5%86%8Cdubbo%E6%9C%8D%E5%8A%A1/"/>
      <url>/2018/10/12/%E5%A4%96%E7%BD%91ip%E6%B3%A8%E5%86%8Cdubbo%E6%9C%8D%E5%8A%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>应用中使用了dubbo，在部署到服务器上时，如果服务提供方和消费方不在一个网段，发现消费方无法连接Provider，发现使用的Provider机器的内网IP地址。</p><p>有2种解决办法，下面依次说明。</p><h2 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h2><h3 id="1-修改hosts文件增加主机名与公网IP的映射"><a href="#1-修改hosts文件增加主机名与公网IP的映射" class="headerlink" title="1.修改hosts文件增加主机名与公网IP的映射"></a>1.修改hosts文件增加主机名与公网IP的映射</h3><p>dubbo在服务注册时默认使用的内网ip，如果需要在公网环境访问，需要让dubbo以公网ip注册服务。</p><p>1.通过<code>hostname</code>得到主机名；<br>2.修改hosts文件，将公网ip映射到主机名；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZj6cjcq027ejq3outzx5eZ logs]# vi /etc/hosts</span><br><span class="line">127.0.0.1       localhost       localhost.localdomain   localhost4      localhost4.localdomain4</span><br><span class="line">::1     localhost       localhost.localdomain   localhost6      localhost6.localdomain6</span><br><span class="line">172.31.190.219   iZj6cjcq027ejq3outzx5eZ #将IP改成公网ip</span><br></pre></td></tr></table></figure></p><p>改完后重启服务即可。</p><h3 id="2-在dubbo服务的提供方配置host为公网IP。"><a href="#2-在dubbo服务的提供方配置host为公网IP。" class="headerlink" title="2.在dubbo服务的提供方配置host为公网IP。"></a>2.在dubbo服务的提供方配置host为公网IP。</h3><p>![/img/dubbo-provider.png]</p><h2 id="如何服务同时能被内网和公网访问？"><a href="#如何服务同时能被内网和公网访问？" class="headerlink" title="如何服务同时能被内网和公网访问？"></a>如何服务同时能被内网和公网访问？</h2><p>在上面的解决方法中第2点，可以指定服务提供方的host，将该host指定为域名即可。这样内网的机器可以解析该域名为局域网地址 而外网机器可以解析域名为公网地址。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql innodb引擎count查询优化</title>
      <link href="/2018/10/08/mysql%20innodb%E5%BC%95%E6%93%8Ecount%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/"/>
      <url>/2018/10/08/mysql%20innodb%E5%BC%95%E6%93%8Ecount%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>使用mysql的innodb引擎执行count查询时发现速度很慢。一个将近800万条数据的表执行count(*)差不多40多秒时间。使用count(1)和count(主键)也基本差不多。<br>表结构如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-8/4405890.jpg" alt=""></p><ul><li>执行count(*)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> sds_third_match_info;</span><br></pre></td></tr></table></figure></li></ul><p>耗时：57.733sec</p><ul><li>执行count(1)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">FROM</span> sds_third_match_info;</span><br></pre></td></tr></table></figure></li></ul><p>耗时：55.428sec<br><a id="more"></a></p><ul><li>执行count(主键)<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(<span class="keyword">id</span>) <span class="keyword">FROM</span> sds_third_match_info;</span><br></pre></td></tr></table></figure></li></ul><p>耗时：56.209sec</p><p>原因分析：<br>InnoDB的索引是B+Tree。<br>对主键索引来说：它只有在叶子节点上存储数据，它的key是主键，并且value为整条数据。<br>对辅助索引来说：key为建索引的列，value为主键。</p><p>这给我们两个信息： </p><ol><li>根据主键会查到整条数据 </li><li>根据辅助索引只能查到主键，然后必须通过主键再查到剩余信息。</li></ol><p>所以如果要优化count(*)操作的话，我们需要找一个短小的列，为它建立辅助索引。</p><p>我们在sport_data_type上建立一个普通索引<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> sds_third_match_info <span class="keyword">ADD</span> <span class="keyword">INDEX</span> idx_sporttype_stmi(sport_data_type);</span><br></pre></td></tr></table></figure></p><p>然后根据索引列做count<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(sport_data_type) <span class="keyword">FROM</span> sds_third_match_info t;</span><br></pre></td></tr></table></figure></p><p>现在耗时：2.649sec</p><p>如果在where条件中根据索引列过滤：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(sport_data_type) <span class="keyword">FROM</span> sds_third_match_info t <span class="keyword">WHERE</span> sport_data_type=<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p><p>耗时：0.052sec</p><p>看看执行计划：<br><code>EXPLAIN SELECT COUNT(sport_data_type) FROM sds_third_match_info t WHERE sport_data_type=1;</code><br><img src="http://omh46px9n.bkt.clouddn.com/18-10-8/84901408.jpg" alt=""></p><p>如果是count(*)则执行计划是全表扫描。</p><p>参考：<a href="https://blog.csdn.net/vip_hitwu/article/details/77066688">高性能MySQL之Count统计查询</a>、<a href="https://blog.csdn.net/u012674931/article/details/52711137">MySQL 大表的count()优化</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Memcached缓存介绍</title>
      <link href="/2018/09/25/Memcached%E7%BC%93%E5%AD%98%E4%BB%8B%E7%BB%8D/"/>
      <url>/2018/09/25/Memcached%E7%BC%93%E5%AD%98%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="Memcached简介"><a href="#Memcached简介" class="headerlink" title="Memcached简介"></a>Memcached简介</h2><p>Memcached是一个高性能的服务器内存缓存软件。在早期版本的Memcached使用的是alloc来分配内存，存在内存碎片，在新版本的Memcached采用了Slab Allocator来分配内存。在MC启动时会要求制定一块内存区域，然后会划分为多个Slab，每个Slab默认大小为1M，可以指定。每个Slab又包含多个truck，每个Slab的truck大小不同，但同一个Slab的truck大小是一样的。在存入数据到MC时，MC会查找最合适的truck来存储数据。比如数据是100字节，现在有truck大小分别为64byte,128byte,144byte，那么会找到128byte的truck存储。不过仍然存在空间的浪费，比如这个例子中就浪费了28byte。所以保证合适大小的空间很重要，我们可以在MC启动时指定负载因子<code>-f</code>参数来指定，默认是1.25.通常情况下这都是一个比较合理的值，无需修改。另外避免空间浪费的一个处理方法是，将数据大小差不多的放入到相同的MC中。比如一个MC的truck大小为1M，另外一个为1K。那么将数据量在1M左右的都放入到1M的那个MC。<br><a id="more"></a></p><h2 id="与Redis比较"><a href="#与Redis比较" class="headerlink" title="与Redis比较"></a>与Redis比较</h2><p>与Redis相比：<br>1.MC只支持key/value，Redis支持key/value，list，set，map等6种数据结构；</p><p>2.都支持key的过期<br>MC不主动检查item是否过期，只有在get时检查，但是检查到过期也不会删除，只是做一个标记。在有数据要set时该空间可以被重试使用。MC在分配空间时优先使用已经过期的key/value对的空间，如果分配的空间占满时，会使用LRU算法，删除最近最少使用的key。可以使用<code>-M</code>参数来启动MC，这样但MC内存耗尽时，会返回一个报错信息（对于完整数据缓存有用）。</p><p>Redis是主动监测，在key过期时会主动删除。</p><p>3.MC没有持久化功能，无法恢复数据；Redis可以定时保存数据到磁盘，Redis重启可以重新加载到内存。</p><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>1.将变化频率低的数据事先就放入MC中；<br>比如商品分类、系统角色等等。</p><p>后续如有修改，修改数据库并同步到MC。<br>这样所有用户的请求全部请求的MC，不会请求数据库。</p><p>2.热点数据缓存</p><p>3.集群会话共享</p><h2 id="分布式缓存设计思想"><a href="#分布式缓存设计思想" class="headerlink" title="分布式缓存设计思想"></a>分布式缓存设计思想</h2><p>1.每台MC的内容不一样，所有的服务器内容加起来接近数据库的容量；<br>2.通过在客户端程序或在负载均衡器上使用Hash算法，让同一内容始终分配到同一台MC。<br>3.普通的HASH算法会导致MC节点宕机后数据发生流动，可能发生雪崩；<br>4.采用一致性HASH算法可以使节点宕机对数据的流动降到最低。<br>5.每个MC节点之间互不通信，数据独立存取。</p><h2 id="安装Memcache"><a href="#安装Memcache" class="headerlink" title="安装Memcache"></a>安装Memcache</h2><h3 id="安装libevent"><a href="#安装libevent" class="headerlink" title="安装libevent"></a>安装libevent</h3><p>由于Memcached使用了libevent库，所以要先安装libevent。<br>从<a href="https://github.com/libevent/libevent/releases">https://github.com/libevent/libevent/releases</a>获取最新稳定版本下载。这里下载的是libevent-2.1.8-stable.tar.gz。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf libevent-2.1.8-stable.tar.gz</span><br><span class="line">cd libevent-2.1.8-stable</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p><p>问题：<br>执行<code>./configure</code>时出错。错误信息：<code>libevent  error: no acceptable C compiler found in $PATH</code>。<br>解决办法：安装gcc，执行<code>yum install gcc</code>，然后再执行<code>./configure</code>。</p><h3 id="安装Memcached"><a href="#安装Memcached" class="headerlink" title="安装Memcached"></a>安装Memcached</h3><p>从<a href="http://memcached.org/downloads">http://memcached.org/downloads</a>下载最新稳定版本，这里下载的是memcached-1.5.10.tar.gz。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf memcached-1.5.10.tar.gz </span><br><span class="line">cd memcached-1.5.10</span><br><span class="line">./configure </span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure></p><p>验证是否安装成功<br><code>memcached -h</code><br>提示：<br><code>memcached: error while loading shared libraries: libevent-2.1.so.6: cannot open shared object file: No such file or directory</code>。<br>解决：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name &quot;libevent-2.1.so.6&quot;</span><br></pre></td></tr></table></figure></p><p>可以找到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/lib/libevent-2.1.so.6</span><br><span class="line">/data/tools/libevent-2.1.8-stable/.libs/libevent-2.1.so.6</span><br></pre></td></tr></table></figure></p><p>将<code>/usr/local/lib</code>加到/etc/ld.so.conf中<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-8/27301574.jpg" alt=""></p><p>然后执行<code>ldconfig</code>，然后再次执行<code>memcached -h</code>就正常了。</p><h3 id="启动Memcached"><a href="#启动Memcached" class="headerlink" title="启动Memcached"></a>启动Memcached</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcached -m 64 -p 11211 -d -c 8192 -u root</span><br></pre></td></tr></table></figure><p>相关参数可以使用<code>memcached -h</code>查看。本例中-m 64指定内存大小为64M，-p 11211指定端口，-d指定为守护进程，-c指定连接数，-u指定用户（在用root启动时需要指定）。<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-8/77633311.jpg" alt=""></p><p>增加实例，只需修改启动的端口即可。下面新增一个实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">memcached -m 64 -p 11212 -d -c 8192 -u root</span><br></pre></td></tr></table></figure></p><h2 id="命令行客户端操作MC数据"><a href="#命令行客户端操作MC数据" class="headerlink" title="命令行客户端操作MC数据"></a>命令行客户端操作MC数据</h2><h3 id="MC命令"><a href="#MC命令" class="headerlink" title="MC命令"></a>MC命令</h3><ul><li><p>添加数据(add)</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add key flag expiretime bytes</span><br><span class="line">value</span><br></pre></td></tr></table></figure><p>  key : 给这个值设置一个名字<br>  flag : 标志，是一个整数<br>  expiretime : 有效期，以秒为单位，0表示没有延迟<br>  bytes : 这是一个需要存储在memcached的数据的长度<br>  value : 是一个需要存储的数据。数据需要将通过在新的一行后输入<br>  注意：bytes要和value的长度一致，否则会出现CLIENT_ERROR bad data chunk错误</p></li><li><p>为一个新的或现有的键(key)设置一个值（set）</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set key flag expiretime bytes</span><br><span class="line">value</span><br></pre></td></tr></table></figure></li><li><p>替换已存在的 key(键) 的 value(数据值)(replace)</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">replace key flag expiretime bytes</span><br><span class="line">value</span><br></pre></td></tr></table></figure></li><li><p>向已存在 key(键) 的 value(数据值) 后面追加数据(append)    </p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">append key flag expiretime bytes</span><br><span class="line">value</span><br></pre></td></tr></table></figure></li><li><p>向已存在 key(键) 的 value(数据值) 前面追加数据(prepend)    </p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">prepend key flag expiretime bytes</span><br><span class="line">value</span><br></pre></td></tr></table></figure></li><li><p>获取存储在 key(键) 中的 value(数据值)(get)</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get key</span><br></pre></td></tr></table></figure></li><li><p>删除已存在的 key(键)(delete)</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete key</span><br></pre></td></tr></table></figure></li><li><p>incr 与 decr 命令用于对已存在的 key(键) 的数字值进行自增或自减操作</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incr key increment_value </span><br><span class="line">decr key increment_value</span><br></pre></td></tr></table></figure></li><li><p>清理缓存中的所有数据(flush_all)    </p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flush_all [time] </span><br><span class="line">- time : (可选) 在指定时间后执行清理缓存操作</span><br></pre></td></tr></table></figure></li><li><p>stats / stats slabs / stats sizes / stats items</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stats 显示统计信息例如 PID(进程号)、版本号、连接数等 </span><br><span class="line">stats slabs 显示各个slab的信息，包括chunk的大小、数目、使用情况等 </span><br><span class="line">stats sizes 显示所有item的大小和个数 </span><br><span class="line">stats items 显示各个 slab 中 item 的数目和存储时长</span><br><span class="line"></span><br><span class="line">命令格式：</span><br><span class="line">gets key</span><br><span class="line"></span><br><span class="line">命令格式：</span><br><span class="line">cas key flags exptime bytes unique_cas_token [noreply]</span><br><span class="line">value</span><br></pre></td></tr></table></figure></li><li><p>gets / cas</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gets 获取带有 CAS 令牌的 value(数据值) </span><br><span class="line">cas 执行一个”检查并设置”的操作</span><br></pre></td></tr></table></figure></li></ul><p>参考<a href="https://blog.csdn.net/kangvcar/article/details/78591899">MemCache 入门极简教程</a>    </p><h3 id="通过Telnet来测试"><a href="#通过Telnet来测试" class="headerlink" title="通过Telnet来测试"></a>通过Telnet来测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 添加数据</span><br><span class="line">add key001 0 10 5 // 回车</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line">// 获取数据</span><br><span class="line">get key001</span><br><span class="line"></span><br><span class="line">// 删除数据</span><br><span class="line">delete key001</span><br><span class="line"></span><br><span class="line">// 向value前追加数据</span><br><span class="line">prepend key001 0 0 3</span><br><span class="line">123</span><br><span class="line"></span><br><span class="line">// 向value后追加数据</span><br><span class="line">append key001 0 0 3</span><br><span class="line">123</span><br><span class="line"></span><br><span class="line">// 将key001的value替换为world</span><br><span class="line">replace key001 0 0 5</span><br><span class="line">world</span><br></pre></td></tr></table></figure><h3 id="通过nc测试"><a href="#通过nc测试" class="headerlink" title="通过nc测试"></a>通过nc测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">写入：</span><br><span class="line">printf &quot;set key001 0 0 5\r\nhello\r\n&quot; | nc 127.0.0.1 11211</span><br><span class="line">读取：</span><br><span class="line">printf &quot;get key001\r\n&quot; | nc 127.0.0.1 11211</span><br><span class="line">删除：</span><br><span class="line">printf &quot;delete key001\r\n&quot; | nc 127.0.0.1 11211</span><br><span class="line"></span><br><span class="line"># cas操作需要先根据gets key来获取CAS令牌</span><br><span class="line"># 1.获取令牌</span><br><span class="line">printf &quot;gets key001\r\n&quot; | nc 127.0.0.1 11211</span><br><span class="line"># 2.cas更新key的value</span><br><span class="line">printf &quot;cas key001 0 0 5 14 \r\nworld\r\n&quot; | nc 127.0.0.1 11211</span><br></pre></td></tr></table></figure><h3 id="Memcached客户端Xmemcached使用"><a href="#Memcached客户端Xmemcached使用" class="headerlink" title="Memcached客户端Xmemcached使用"></a>Memcached客户端Xmemcached使用</h3><p>1.引入xmemcached的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.googlecode.xmemcached<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmemcached<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：xmemcached依赖slf4j，默认会打印一堆的Debug日志，可以引入slf4j和相关的日志实现的依赖，然后配置xmemcached的日志级别为info。<br>比如log4j，可以配置<code>log4j.logger.com.google=info</code>。</p><p>2.基本使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">XMemcachedClientBuilder builder = <span class="keyword">new</span> XMemcachedClientBuilder(AddrUtil.getAddresses(<span class="string">"192.168.200.109:11211 192.168.200.109:11212"</span>));</span><br><span class="line">builder.setSessionLocator(<span class="keyword">new</span> KetamaMemcachedSessionLocator()); <span class="comment">// 一致性哈希，使得某个key存的时候存都某个节点，取的时候也会从该节点获取</span></span><br><span class="line">MemcachedClient mc = builder.build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空数据</span></span><br><span class="line">mc.flushAll();</span><br><span class="line"></span><br><span class="line">mc.add(<span class="string">"hello"</span>,<span class="number">30</span>,<span class="string">"你好，Memcached！"</span>);</span><br><span class="line">String value = mc.get(<span class="string">"hello"</span>);</span><br><span class="line">System.out.println(<span class="string">"hello="</span> + value);</span><br><span class="line"></span><br><span class="line">mc.delete(<span class="string">"hello"</span>);</span><br><span class="line">value = mc.get(<span class="string">"hello"</span>);</span><br><span class="line">System.out.println(<span class="string">"hello=="</span> + value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果不存在key则创建，存在则覆盖value</span></span><br><span class="line">mc.set(<span class="string">"key001"</span>,<span class="number">0</span>,<span class="string">"test key"</span>);</span><br><span class="line"><span class="comment">// 更新过期时间</span></span><br><span class="line">mc.touch(<span class="string">"key001"</span>,<span class="number">3</span>);</span><br><span class="line">Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">value = mc.get(<span class="string">"key001"</span>);</span><br><span class="line">System.out.println(<span class="string">"key001====="</span> + value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// cas操作，内部先通过gets命令拿到token，然后再执行cas操作。</span></span><br><span class="line">mc.set(<span class="string">"abc"</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">mc.cas(<span class="string">"abc"</span>, <span class="number">0</span>, <span class="keyword">new</span> CASOperation&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxTries</span><span class="params">()</span> </span>&#123; <span class="comment">// cas重试次数</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getNewValue</span><span class="params">(<span class="keyword">long</span> currentCAS, Integer currentValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">99</span>; <span class="comment">// 要设置的新值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> casValue = mc.get(<span class="string">"abc"</span>);</span><br><span class="line">System.out.println(<span class="string">"abc="</span> + casValue);</span><br><span class="line"></span><br><span class="line">mc.add(<span class="string">"hello"</span>,<span class="number">0</span>,<span class="string">"world"</span>);</span><br><span class="line"><span class="keyword">if</span> (mc.add(<span class="string">"hello"</span>,<span class="number">10</span>,<span class="string">"abcd"</span>)) &#123;</span><br><span class="line">    System.out.println(<span class="string">"key is exists"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数字原则更新，类似java中的AtomicInteger</span></span><br><span class="line">System.out.println(mc.incr(<span class="string">"aaa"</span>,<span class="number">5</span>,<span class="number">0</span>)); <span class="comment">// 对aaa加5，默认值为0（aaa不存在时）</span></span><br><span class="line">System.out.println(mc.decr(<span class="string">"aaa"</span>,<span class="number">2</span>)); <span class="comment">// 对aaa减2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用Counter</span></span><br><span class="line">Counter counter = mc.getCounter(<span class="string">"counter"</span>,<span class="number">0</span>);</span><br><span class="line">System.out.println(counter.addAndGet(<span class="number">5</span>));</span><br><span class="line">System.out.println(counter.decrementAndGet());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 命名空间</span></span><br><span class="line">String ns = <span class="string">"namespace"</span>;</span><br><span class="line">mc.withNamespace(ns, <span class="keyword">new</span> MemcachedClientCallable&lt;Boolean&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">call</span><span class="params">(MemcachedClient memcachedClient)</span> <span class="keyword">throws</span> MemcachedException, InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = memcachedClient.set(<span class="string">"key1"</span>,<span class="number">0</span>,<span class="string">"hello"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用</span></span><br><span class="line">mc.beginWithNamespace(ns);</span><br><span class="line">mc.add(<span class="string">"key2"</span>,<span class="number">20</span>,<span class="string">"world"</span>);</span><br><span class="line">mc.add(<span class="string">"key3"</span>,<span class="number">30</span>,<span class="string">"你好"</span>);</span><br><span class="line">System.out.println(<span class="string">"key3==&gt;"</span> + mc.get(<span class="string">"key3"</span>));</span><br><span class="line">mc.endWithNamespace();</span><br><span class="line"></span><br><span class="line">value = mc.withNamespace(ns, <span class="keyword">new</span> MemcachedClientCallable&lt;String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">(MemcachedClient client)</span> <span class="keyword">throws</span> MemcachedException, InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> client.get(<span class="string">"key2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(<span class="string">"with namespace key2="</span> + value);</span><br><span class="line"></span><br><span class="line">value = mc.get(<span class="string">"key1"</span>);</span><br><span class="line">System.out.println(<span class="string">"key1="</span> + value);</span><br><span class="line">value = mc.get(<span class="string">"key2"</span>);</span><br><span class="line">System.out.println(<span class="string">"key2="</span> + value);</span><br><span class="line">value = mc.get(<span class="string">"key3"</span>);</span><br><span class="line">System.out.println(<span class="string">"key3="</span> + value);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 让命名空间的所有key都失效</span></span><br><span class="line">mc.invalidateNamespace(ns);</span><br><span class="line">value = mc.get(<span class="string">"key1"</span>);</span><br><span class="line">System.out.println(<span class="string">"key1="</span> + value);</span><br><span class="line">value = mc.get(<span class="string">"key2"</span>);</span><br><span class="line">System.out.println(<span class="string">"key2="</span> + value);</span><br><span class="line">value = mc.get(<span class="string">"key3"</span>);</span><br><span class="line">System.out.println(<span class="string">"key3="</span> + value);</span><br><span class="line"></span><br><span class="line">mc.shutdown();</span><br></pre></td></tr></table></figure></p><p>这里只是基本使用，可以查看下面的参考链接查看全部用法。</p><p>参考：<a href="https://github.com/killme2008/xmemcached/wiki/Xmemcached%20%E4%B8%AD%E6%96%87%E7%94%A8%E6%88%B7%E6%8C%87%E5%8D%97">Xmemcached 中文用户指南</a>、<a href="https://www.cnblogs.com/EasonJim/p/7624822.html">Memcached的几种Java客户端（待实践）</a></p><p>参考：<a href="http://www.runoob.com/memcached/memcached-tutorial.html">Memcached 教程</a></p><h2 id="Memcached监控"><a href="#Memcached监控" class="headerlink" title="Memcached监控"></a>Memcached监控</h2><p>这里推荐使用MemAdmin，需要PHP环境。参考：<a href="https://www.cnblogs.com/joylee/archive/2013/01/07/memadmin.html">windows下memadmin安装</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Boot国际化</title>
      <link href="/2018/09/25/springboot%E5%9B%BD%E9%99%85%E5%8C%96/"/>
      <url>/2018/09/25/springboot%E5%9B%BD%E9%99%85%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>国际化（internationalization）是设计和制造容易适应不同区域要求的产品的一种方式。它要求从产品中抽离所有地域语言，国家/地区和文化相关的元素。换言之，应用程序的功能和代码设计考虑在不同地区运行的需要，其代码简化了不同本地版本的生产。开发这样的程序的过程，就称为国际化。</p><p>那么当我们使用Spring Boot如何进行国际化呢？那么当你读完这篇文章你会学到如下知识：<br><a id="more"></a></p><ul><li>(1) spring boot 加入thymeleaf；</li><li>(2) 页面元素国际化；</li><li>(3) spring boot默认国际化原理说明；</li><li>(4) firefox浏览器修改区域语言；</li><li>(5)chrome浏览器修改区域语言；</li><li>(6)修改默认messages配置前缀；</li><li>(7) 代码中如何获取国际化信息；</li><li>(8) 优化代码获取国际化信息；</li><li>(9) 区域解析器之AcceptHeaderLocaleResolver；</li><li>(10) 会话区域解析器之SessionLocaleResolver；</li><li>(11) Cookie区域解析器之CookieLocaleResolver；</li><li>(12)固定的区域解析器之FixedLocaleResolver ；</li><li>(13)使用参数修改用户的区域；</li></ul><p>接下里我们看看这些具体应该怎么操作。</p><p><strong>(1) spring boot 加入thymeleaf；</strong></p><p>Spring boot集成thymeleaf在<a href="http://www.vxzsk.com/440.html">http://www.vxzsk.com/440.html</a></p><p>这篇文章有介绍过，所以这里就不过多进行介绍了。在这里我们为之后的讲解做点基本准备。</p><p>模板文件resources/templates/hello.html :<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello spring boot<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>欢迎你登录到阿里巴巴网站<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这里没有特殊的代码，访问就是显示一些文字，这里还没加入国际化的相关东西，之后添加。</p><p>编写访问地址：com.kfit.controller.HelloController：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kfit.controller;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span>  <span class="string">"/hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里就是访问<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a>就跳转到hell.html进行访问。</p><p>到这里准备工作就好了。</p><p><strong>(2) 页面元素国际化；</strong></p><p>我们观察hello.html里面的信息直接就是中文显示，所以我们现在的需求是当访问语言是zh的时候显示为中文，当语言为en的时候显示为英文，那么怎么操作呢？</p><p>首先我们先定义国际化资源文件，spring boot默认就支持国际化的，而且不需要你过多的做什么配置，只需要在resources/下定义国际化配置文件即可，注意名称必须以messages开发。</p><p>我们定义如下几个文件：</p><p>messages.properties （默认，当找不到语言的配置的时候，使用该文件进行展示）。</p><p>messages_zh_CN.properties（中文）</p><p>messages_en_US.properties（英文）</p><p>具体的代码如下：</p><p>messages.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">welcome = 欢迎你登录到 阿里巴巴 网站（default）</span><br></pre></td></tr></table></figure></p><p>messages_zh_CN.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">welcome = \u6b22\u8fce\u4f60\u767b\u5f55\u5230 \u963f\u91cc\u5df4\u5df4 \u7f51\u7ad9\uff08\u4e2d\u6587\uff09</span><br></pre></td></tr></table></figure></p><p>对应的信息是：</p><p>welcome = 欢迎你登录到 阿里巴巴 网站（中文）</p><p>messages_en_US.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">welcome = welcome to login to alibaba website(English)</span><br></pre></td></tr></table></figure></p><p>配置信息就这么简单，那么在前端展示怎么修改呢，修改hello.html文件，使用#{key}的方式进行使用messages中的字段信息：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>hello spring boot<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span> <span class="attr">th:text</span>=<span class="string">"#&#123;welcome&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>重新访问：<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> 应该显示：</p><p>欢迎你登录到 阿里巴巴 网站（中文）</p><p><strong>(3) spring boot默认国际化原理说明</strong></p><p>在这里我们先打住下，简单说下原理：</p><p>第一个问题，为什么命名必须是messages开头，需要看一个源码文件：</p><p>org.springframework.boot.autoconfigure.MessageSourceAutoConfiguration：</p><p>这里提取部分代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration&#125; for &#123;<span class="doctag">@link</span> MessageSource&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Phillip Webb</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Eddú Meléndez</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>(value = MessageSource.class, search = SearchStrategy.CURRENT)</span><br><span class="line"><span class="meta">@AutoConfigureOrder</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@Conditional</span>(ResourceBundleCondition.class)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.messages"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageSourceAutoConfiguration</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Resource[] NO_RESOURCES = &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comma-separated list of basenames, each following the ResourceBundle convention.</span></span><br><span class="line"><span class="comment">     * Essentially a fully-qualified classpath location. If it doesn't contain a package</span></span><br><span class="line"><span class="comment">     * qualifier (such as "org.mypackage"), it will be resolved from the classpath root.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String basename = <span class="string">"messages"</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Message bundles encoding.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Charset encoding = Charset.forName(<span class="string">"UTF-8"</span>);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Loaded resource bundle files cache expiration, in seconds. When set to -1, bundles</span></span><br><span class="line"><span class="comment">     * are cached forever.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cacheSeconds = -<span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set whether to fall back to the system Locale if no files for a specific Locale</span></span><br><span class="line"><span class="comment">     * have been found. if this is turned off, the only fallback will be the default file</span></span><br><span class="line"><span class="comment">     * (e.g. "messages.properties" for basename "messages").</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> fallbackToSystemLocale = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>看到没有，如果我们没有在application.properties中配置spring.messages属性，那么使用默认的messages，好了这个问题就这么简单解决了。</p><p>第二问题：为什么我看到的是中文（或者英文）呢？</p><p>为了让web应用程序支持国际化，必须识别每个用户的首选区域，并根据这个区域显示内容。在Spring MVC应用程序中，用户的区域是通过区域解析器来识别的，它必须是实现LocaleResolver接口。Spring MVC提供了几个LocaleResolver实现，让你可以按照不同的条件来解析区域。除此之外，你还可以实现这个接口创建自己的区域解析器。如果没有做特殊的处理的话，Spring 采用的默认区域解析器是AcceptHeaderLocaleResolver。它通过检验HTTP请求的头部信息accept-language来解析区域。这个头部是由用户的wb浏览器底层根据底层操作系统的区域设置进行设定的。请注意，这个区域解析器无法改变用户的区域，因为它无法修改用户操作系统的区域设置。</p><p>既然无法修改，那么我们的代码怎么测试呢？请看如下内容？</p><p><strong>(4) firefox浏览器修改区域语言；</strong></p><p>打开firefox浏览器访问<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> （计算机系统语言是中文的），应该是看到如下信息：</p><p>欢迎你登录到 阿里巴巴 网站（中文）</p><p>那么我们修改我们的语言呢，在浏览器地址栏输入如下信息：</p><p>about:config</p><p>回车进入一个警告页面，然后点击按钮【我保证会小心】（注：由于版本不一样，可能会有些不一样，但是操作是一样的）。</p><!--[endif]--><p>在搜索框输入accept，然后找到intl.accept_languages修改对应的值，我这里原本是：</p><p>zh-cn, zh, en-us, en</p><p>为了看到效果，修改为：</p><p>en-us, en</p><p>修改完之后，刷新<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> ，可以看到信息：</p><p>welcome to login to alibaba website(English)</p><p>好了，没有什么特殊的需求的，记得把intl.accept_languages修改为原来的值。</p><p><strong>(5)chrome浏览器修改区域语言；</strong></p><p>我觉得firefox修改起来真是简单，chrome浏览器就稍微麻烦点了。</p><p>第一种方案就是下载插件：Quick Language Switcher，下载完插件之后，默认选项的比较少，你可以在扩展程序中，打开别的语言选项或者添加自定义的语言。这个只要插件下来来操作就很简单了，切换语言就会自动刷新页面，就能看到效果了，特别方便。注意的是：默认有一个English，这个使用的配置文件是：messages_en.properties,所以需要添加一个配置文件才能看到效果。</p><p>第二种方案是修改本地的一个配置文件，参考如下地址</p><p><a href="http://stackoverflow.com/questions/7769061/how-to-add-custom-accept-languages-to-chrome-for-pseudolocalization-testing">http://stackoverflow.com/questions/7769061/how-to-add-custom-accept-languages-to-chrome-for-pseudolocalization-testing</a></p><p>但是我这里不管怎么修改，重启浏览器之后，就被重置回来了，也就是这种方案我这里没有配置成功。第一种方案肯定是可以的。</p><p>别的浏览器就自行尝试了，因为这不是我们这不是我们实际使用的重点，那么接下来才是重点哦。</p><p><strong>(6)修改默认messages配置前缀；</strong></p><p>我们在上面说了，默认的文件名称前缀是messages_xx.properties，那么如何修改这个名称和路径呢？</p><p>这个也很简单，只需要修改application.properties文件即可加入如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">########################################################</span><br><span class="line">### i18n setting.</span><br><span class="line">########################################################</span><br><span class="line">#指定message的basename，多个以逗号分隔，如果不加包名的话，默认从classpath路径开始，默认: messages</span><br><span class="line">spring.messages.basename=i18n/messages</span><br><span class="line">#设定加载的资源文件缓存失效时间，-1的话为永不过期，默认为-1</span><br><span class="line">spring.messages.cache-seconds= 3600</span><br><span class="line">#设定Message bundles的编码，默认: UTF-8</span><br><span class="line">#spring.messages.encoding=UTF-8</span><br></pre></td></tr></table></figure></p><p>上面各个参数都注释很清楚了，这里不多说了，那么我们这里是把文件放到了i18n下，那么我们在resources下新建目录i18n，然后复制我们创建的messages_xxx.properties文件到此目录下。为了区分这是读取了新的文件，我们可以在每个文件中—i18n以进行区分。</p><p>重新访问<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> 可以看到最新的效果了。</p><p>英文：</p><p>welcome to login to alibaba website(English-en)–i18n</p><p>中文：</p><p>欢迎你登录到阿里巴巴网站（中文）–i18n</p><p><strong>(7) 代码中如何获取国际化信息；</strong></p><p>以上讲的是在模板文件进行国际化，那么在代码中如何获取到welcome呢，这个比较简单，只要在需要的地方注入类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> MessageSource messageSource;</span><br></pre></td></tr></table></figure><p>需要注意的是messageSource是</p><p>org.springframework.context.MessageSource</p><p>下的类。</p><p>那么怎么使用了，在使用前我们需要先知道一个知识点，如何得到当前请求的Locale</p><p>那么怎么获取呢，有两种获取方式：</p><p>第一种方式是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Locale locale = LocaleContextHolder.getLocale();</span><br></pre></td></tr></table></figure></p><p>第二种方式是：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Locale locale1= RequestContextUtils.getLocale(request);</span><br></pre></td></tr></table></figure></p><p>个人喜好第一种方式，因为不需要什么参数就可以获取到，第二种方式依赖于当前的request请求对象。</p><p>有了当前请求的Locale剩下的就简单了：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String msg = messageSource.getMessage(<span class="string">"welcome"</span>, <span class="keyword">null</span>,locale);</span><br><span class="line">String msg2= messageSource.getMessage(<span class="string">"welcome"</span>, <span class="keyword">null</span>,locale1);</span><br></pre></td></tr></table></figure><p>通过以上代码的其中一种方式就可以获取到messages_xxx.properties文件配置的welcome属性值了。切换区域获取的信息也是不一样的，打印信息如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">msg=欢迎你登录到阿里巴巴网站（中文）--i18n</span><br><span class="line">msg2欢迎你登录到阿里巴巴网站（中文）--i18n</span><br><span class="line">msg=welcome to login to alibaba website(English-en)--i18n</span><br><span class="line">msg2welcome to login to alibaba website(English-en)--i18n</span><br></pre></td></tr></table></figure></p><p><strong>8) 优化代码获取国际化信息；</strong></p><p>学习是永无止境的，活到老学到老。查看上面的代码你会发现这个是实际中使用起来的时候还是不是很方面，ok,没有关系，这个小节我们就对上面的代码优化下，</p><p>自定义我们自己的MessageSource，具体代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kfit.common;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.i18n.LocaleContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line">  </span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocaleMessageSourceService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MessageSource messageSource;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code ：对应messages配置的key.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> getMessage(code,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code ：对应messages配置的key.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args : 数组参数.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code,Object[] args)</span></span>&#123;</span><br><span class="line">       <span class="keyword">return</span> getMessage(code, args,<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code ：对应messages配置的key.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args : 数组参数.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> defaultMessage : 没有设置key的时候的默认值.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMessage</span><span class="params">(String code,Object[] args,String defaultMessage)</span></span>&#123;</span><br><span class="line">       <span class="comment">//这里使用比较方便的方法，不依赖request.</span></span><br><span class="line">       Locale locale = LocaleContextHolder.getLocale();</span><br><span class="line">       <span class="keyword">return</span> messageSource.getMessage(code, args, defaultMessage, locale);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在这个代码中我封装了3个常用的方法，那么应该怎么调用呢？也很简单，在需要的地方使用如下代码进行注入：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Resource</span></span><br><span class="line"><span class="keyword">private</span> LocaleMessageSourceService localeMessageSourceService;</span><br></pre></td></tr></table></figure><p>在需要的地方使用如下代码进行调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String msg3 = localeMessageSourceService.getMessage(<span class="string">"welcome"</span>);</span><br></pre></td></tr></table></figure></p><p>这个代码比之前的代码使用起来爽多了，还有很多神妙之处，大家自己发现吧。</p><p><strong>(9) 区域解析器之AcceptHeaderLocaleResolver；</strong></p><p>看到上面，大家会认为国际化也就到此了，但是我告诉大家这之后才是spring的强大之处呢，考虑的多么周到呢。</p><p>我们在之前说过，我们只所以可以看到国际化的效果是因为有一个区域解析器在进行处理。默认的区域解析器就是AcceptHeaderLocaleResolver。我们简单说明这个解析器：</p><p>Spring采用的默认区域解析器是AcceptHeaderLocaleResolver。它通过检验HTTP请求的accept-language头部来解析区域。这个头部是由用户的web浏览器根据底层操作系统的区域设置进行设定。请注意，这个区域解析器无法改变用户的区域，因为它无法修改用户操作系统的区域设置。</p><p>好了，这个默认的介绍到这里，因为这个我们无法改变，所以这种默认的设置在实际中使用的比较少。所以你如果看到当前还无法满足的需求的话，那么接着往下看，博主已经帮你都想到了。</p><p><strong>(10) 会话区域解析器之SessionLocaleResolver；</strong></p><p>会话区域解析器也就是说，你设置完只针对当前的会话有效，session失效，还原为默认状态。那么这个具体怎么操作呢？具体操作起来也是很简单的，我们需要在我们的启动类App.java（按你的实际情况进行修改）配置区域解析器为SessionLocaleResolver，具体代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SessionLocaleResolver slr = <span class="keyword">new</span> SessionLocaleResolver();</span><br><span class="line">    <span class="comment">//设置默认区域,</span></span><br><span class="line">    slr.setDefaultLocale(Locale.CHINA);</span><br><span class="line">    <span class="keyword">return</span> slr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实到这里我们就完事了，你可以通过setDefaultLocale()设置默认的语言，启动就访问<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> 进行查看，是不是已经实现国际化了。</p><p>到这里当然还不是很完美，还需要在进一步的优化了，那么怎么在页面中进行切换呢？那么假设页面上有两个按钮【切换为中文】、【切换为英文】就可以进行切换了。接下来一起来实现下：在hello.html添加如下代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/changeSessionLanauage"</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"lang"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"zh"</span>  /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">button</span>&gt;</span>切换为中文<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/changeSessionLanauage"</span> <span class="attr">method</span>=<span class="string">"get"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"lang"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"en"</span> /&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">button</span>&gt;</span>切换为英文<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里就是两个表单，切换语言，那么/changeSessionLanauage怎么编写呢，看如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/changeSessionLanauage"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">changeSessionLanauage</span><span class="params">(HttpServletRequest request,String lang)</span></span>&#123;</span><br><span class="line">   System.out.println(lang);</span><br><span class="line">   <span class="keyword">if</span>(<span class="string">"zh"</span>.equals(lang))&#123;</span><br><span class="line">       <span class="comment">//代码中即可通过以下方法进行语言设置</span></span><br><span class="line">       request.getSession().setAttribute(SessionLocaleResolver.LOCALE_SESSION_ATTRIBUTE_NAME, <span class="keyword">new</span> Locale(<span class="string">"zh"</span>, <span class="string">"CN"</span>)); </span><br><span class="line">   &#125;elseif(<span class="string">"en"</span>.equals(lang))&#123;</span><br><span class="line">       <span class="comment">//代码中即可通过以下方法进行语言设置</span></span><br><span class="line">       request.getSession().setAttribute(SessionLocaleResolver.LOCALE_SESSION_ATTRIBUTE_NAME, <span class="keyword">new</span> Locale(<span class="string">"en"</span>, <span class="string">"US"</span>)); </span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">"redirect:/hello"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这部分代码最核心的部分就是如何设置会话的区域，也就是如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.getSession().setAttribute(SessionLocaleResolver.LOCALE_SESSION_ATTRIBUTE_NAME, <span class="keyword">new</span> Locale(<span class="string">"en"</span>, <span class="string">"US"</span>));</span><br></pre></td></tr></table></figure><p>这个代码就可以把当前会话的区域进行切换了，是不是很简单。以上代码你会发现只针对会话的设置，我们在这里在优化下，针对下面讲的Cookie也会作用到，这样这个代码就很智能了，代码修改为如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/changeSessionLanauage"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">changeSessionLanauage</span><span class="params">(HttpServletRequest request,HttpServletResponse response,String lang)</span></span>&#123;</span><br><span class="line">          System.out.println(lang);</span><br><span class="line">   LocaleResolver localeResolver = RequestContextUtils.getLocaleResolver(request);</span><br><span class="line">   <span class="keyword">if</span>(<span class="string">"zh"</span>.equals(lang))&#123;</span><br><span class="line">       localeResolver.setLocale(request, response, <span class="keyword">new</span> Locale(<span class="string">"zh"</span>, <span class="string">"CN"</span>));</span><br><span class="line">   &#125;elseif(<span class="string">"en"</span>.equals(lang))&#123;</span><br><span class="line">       localeResolver.setLocale(request, response, <span class="keyword">new</span> Locale(<span class="string">"en"</span>, <span class="string">"US"</span>));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">"redirect:/hello"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这里使用:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocaleResolver localeResolver = RequestContextUtils.getLocaleResolver(request);</span><br></pre></td></tr></table></figure></p><p>获取当前使用的区域解析器LocaleResolver 调用里面的方法</p><p>setLocale 设置即可，这样的代码就是不管是会话还是cookie区域解析器都是一样的代码了。</p><p><strong>(11) Cookie区域解析器之CookieLocaleResolver；</strong></p><p>Cookie区域解析器也就是说，你设置完针对cookie生效，session失效。那么这个具体怎么操作呢？我们需要在我们的启动类App.java（按你的实际情况进行修改）配置区域解析器为CookieLocaleResolver（SessionLocaleResolver部分请注释掉），具体代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   CookieLocaleResolver slr = <span class="keyword">new</span> CookieLocaleResolver();</span><br><span class="line">    <span class="comment">//设置默认区域,</span></span><br><span class="line">    slr.setDefaultLocale(Locale.CHINA);</span><br><span class="line">    slr.setCookieMaxAge(<span class="number">3600</span>);<span class="comment">//设置cookie有效期.</span></span><br><span class="line">    returnslr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其实到这里我们就完事了，你可以通过setDefaultLocale()设置默认的语言，启动就访问<a href="http://127.0.0.1:8080/hello">http://127.0.0.1:8080/hello</a> 进行查看，是不是已经实现国际化了。</p><p>到这里当然还不是很完美，还需要在进一步的优化了，那么怎么在页面中进行切换呢？</p><p>这里主要是用到了，这个部分我们在(10)中已经进行配置了，所以到这里已近是可以进行使用了，点击页面中的按钮进行体验。</p><p><strong>(12)固定的区域解析器之FixedLocaleResolver ；</strong></p><p>一直使用固定的Local, 改变Local 是不支持的 。既然无法改变，那么不…好了，还是简单介绍下如何使用吧，还是在App.java进行编码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * cookie区域解析器;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LocaleResolver <span class="title">localeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   FixedLocaleResolver slr = <span class="keyword">new</span> FixedLocaleResolver ();</span><br><span class="line">    <span class="comment">//设置默认区域,</span></span><br><span class="line">    slr.setDefaultLocale(Locale.US);</span><br><span class="line">    returnslr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>(13)使用参数修改用户的区域；</strong></p><p>除了显式调用LocaleResolver.setLocale()来修改用户的区域之外，还可以将LocaleChangeInterceptor拦截器应用到处理程序映射中，它会发现当前HTTP请求中出现的特殊参数。其中的参数名称可以通过拦截器的paramName属性进行自定义。如果这种参数出现在当前请求中，拦截器就会根据参数值来改变用户的区域。</p><p>只需要在App.java中加入：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> LocaleChangeInterceptor <span class="title">localeChangeInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     LocaleChangeInterceptor lci = <span class="keyword">new</span> LocaleChangeInterceptor();</span><br><span class="line">     <span class="comment">// 设置请求地址的参数,默认为：locale</span></span><br><span class="line">     <span class="comment">// lci.setParamName(LocaleChangeInterceptor.DEFAULT_PARAM_NAME);</span></span><br><span class="line">     returnlci;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">    registry.addInterceptor(localeChangeInterceptor());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意这个是可以和会话区域解析器以及Cookie区域解析器一起使用的，但是不能和FixedLocaleResolver一起使用，否则会抛出异常信息。</p><hr><p>本文来自 吸引力的觉悟 的CSDN 博客 ，全文地址请点击：<a href="https://blog.csdn.net/u012100371/article/details/78199568?utm_source=copy">https://blog.csdn.net/u012100371/article/details/78199568?utm_source=copy</a> </p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chrome系浏览器显示完整地址</title>
      <link href="/2018/09/21/Chrome%E7%B3%BB%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%E5%AE%8C%E6%95%B4%E5%9C%B0%E5%9D%80/"/>
      <url>/2018/09/21/Chrome%E7%B3%BB%E6%B5%8F%E8%A7%88%E5%99%A8%E6%98%BE%E7%A4%BA%E5%AE%8C%E6%95%B4%E5%9C%B0%E5%9D%80/</url>
      
        <content type="html"><![CDATA[<p>在浏览器输入<code>chrome://flags/</code>回车，找到<code>Omnibox UI Hide Steady-State URL Scheme and Trivial Subdomains</code>，设置为Disabled，然后重启浏览器。<br>如果回车之后变成了搜索，则复制，然后在浏览器输入栏鼠标右键，选择粘贴并转到即可。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-9-21/8094545.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>markdown表格</title>
      <link href="/2018/09/16/markdown%E8%A1%A8%E6%A0%BC/"/>
      <url>/2018/09/16/markdown%E8%A1%A8%E6%A0%BC/</url>
      
        <content type="html"><![CDATA[<p><strong>markdown表格格式</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">标题一|标题二|标题三|标题四</span><br><span class="line">- |:---|---:|:---:</span><br><span class="line">xxxxxxxxx|xxxxxxxxx|xxxxxxxxx|xxxxxxxxx</span><br><span class="line">xxxxxxxxxxxxxx|xxxxxxxxxxxxxx|xxxxxxxxxxxxxx|xxxxxxxxxxxxxx</span><br><span class="line">xxxxxxxxx|xxxxxxxxx|xxxxxxxxx|xxxxxxxxx</span><br></pre></td></tr></table></figure></p><p>显示效果：<br><a id="more"></a></p><table><thead><tr><th>标题一</th><th style="text-align:left">标题二</th><th style="text-align:right">标题三</th><th style="text-align:center">标题四</th></tr></thead><tbody><tr><td>xxxxxxxxx</td><td style="text-align:left">xxxxxxxxx</td><td style="text-align:right">xxxxxxxxx</td><td style="text-align:center">xxxxxxxxx</td></tr><tr><td>xxxxxxxxxxxxxx</td><td style="text-align:left">xxxxxxxxxxxxxx</td><td style="text-align:right">xxxxxxxxxxxxxx</td><td style="text-align:center">xxxxxxxxxxxxxx</td></tr><tr><td>xxxxxxxxx</td><td style="text-align:left">xxxxxxxxx</td><td style="text-align:right">xxxxxxxxx</td><td style="text-align:center">xxxxxxxxx</td></tr></tbody></table><p>1.两竖线|中间为一个单元格，每行列数即为每行竖线数-1；<br>2.行数-1为表格行数，因为第二行为配置行，配置表格显示用，并不显示出来；<br>3.上面的标题二、标题三、标题四分别为左对齐、右对齐和居中显示。<br>4.内容和|之间的多余空格会被忽略，每行第一个|和最后一个|可以省略，-的数量至少有一个。<br>5.至少与前面空一行，否则表格无法显示</p><p><strong>单元格内换行</strong><br>使用<code>&lt;br&gt;</code>标签。</p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java 8的CompletableFuture</title>
      <link href="/2018/09/15/JDK8%E4%B9%8BCompletableFuture/"/>
      <url>/2018/09/15/JDK8%E4%B9%8BCompletableFuture/</url>
      
        <content type="html"><![CDATA[<p>JDK1.5开始提供了Future类，用来描述一个异步计算的结果。可以通过isDone()方法来判断操作是否执行完毕。你也可以调用get方法阻塞调用的线程，等待执行结束。或者使用cancel方法取消任务的执行。<br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newCachedThreadPool();</span><br><span class="line">Future&lt;Double&gt; doubleFuture = executor.submit(<span class="keyword">new</span> Callable&lt;Double&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 一个耗时的操作</span></span><br><span class="line">        <span class="keyword">return</span> doSomethingLongComputation();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// do something else.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Double result = doubleFuture.get(<span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">    System.out.println(<span class="string">"result-&gt;"</span> + result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>可以看到，我们向线程池提交一个任务，线程池立即返回了一个Future。然后我们可以继续做自己的事情，不必等待任务执行完毕。在自己的事情做完后，调用Future的get方法等待任务执行完毕，并返回结果。调用get()即为等待任务执行完毕，不论多久；而它的带超时时间的重载方法则在指定的时间之内等待执行结果，避免无限期等待下去。实际使用，建议使用带超时时间的get方法。</p><p>不过Future接口有它的局限性。比如：</p><ul><li>将两个异步结束的结果合并为一个——这2个异步计算相互独立，同时第二个又依赖第一个的结果。</li><li>等待Future集合的所有任务执行完毕。</li><li>仅等待Future结合中最快结束的任务完成。（比如访问了2个提供相同服务的服务器）</li><li>通过编程方式完成一个Future任务的执行——以手工设定异步执行结果。</li><li>响应Future的完成事件——在Future的任务执行完毕时会受到通知，然后使用Future计算的结果进行下一步操作。</li></ul><p>java 8提供的CompltableFuture继承Future，在Future的基础上实现了如上描述的功能。</p><h2 id="以异步的方式执行任务"><a href="#以异步的方式执行任务" class="headerlink" title="以异步的方式执行任务"></a>以异步的方式执行任务</h2><p>借助CompletableFuture的supplyAsync方法实现异步执行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Shop&gt; shops = ...;</span><br><span class="line">String productName = ...;</span><br><span class="line"><span class="comment">// 使用supplyAsync以异步的方式计算商品价格</span></span><br><span class="line">List&lt;CompletableFuture&lt;String&gt;&gt; futures = shops.stream()</span><br><span class="line">    .map(shop -&gt; CompletableFuture.supplyAsync(() -&gt; String.format(<span class="string">"%s price is %.2f"</span>, shop.getName(), shop.getPrice(productname))))</span><br><span class="line">    .collect(Collectors.toList());</span><br><span class="line"><span class="comment">// 调用join方法等待任务都执行完毕</span></span><br><span class="line">List&lt;String&gt; results = futures.stream().map(f -&gt; f.join()).collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><p>上面异步方法和Stream的parallelStream都是默认使用的是通用线程池，线程数为处理器个数。你可以通过<code>Runtime.getRuntime().availableProcessors();</code>得到。比如我的电脑是4核，那么就是使用的是4个线程的线程池。如果商家过多会导致执行效率较低。</p><p>幸好，supplyAsync还有还有一个带Executor参数的版本，可以指定执行器。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 指定创建的线程数最多100个，如果商家数目不多余100个，就创建商家数目的线程。</span></span><br><span class="line">ExecutorService executor = Executors.newFixedThreadPool(Math.min(shops.size(), <span class="number">100</span>), (r) -&gt; &#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>); <span class="comment">// 使用守护线程，这种方式不会阻止程序的关闭</span></span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;);</span><br><span class="line">List&lt;CompletableFuture&lt;String&gt;&gt; futures = shops.stream()</span><br><span class="line">    .map(shop -&gt; CompletableFuture.supplyAsync(() -&gt; String.format(<span class="string">"%s price is %.2f"</span>, shop.getName(), shop.getPrice(productname)), executor))</span><br><span class="line">    .collect(Collectors.toList());</span><br><span class="line">List&lt;String&gt; results = futures.stream().map(f -&gt; f.join()).collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><p><strong>线程池大小的估算</strong><br>《java并发编程实战》中，指出线程池大小与处理器的利用率之比可以使用下面的公式进行估算：<br><code>N(threads) = N(cpu) * U(cpu) * (1 + W/C)</code><br>其中：</p><ul><li>N(cpu)是处理器的核的数目，可以通过<code>Runtime.getRuntime().availableProcessors()</code>得到。</li><li>U(cpu)是期望的CPU利用率（值介于0和1之间）</li><li>W/C是等待时间与计算时间的比率<br>在本例中，99%的时间都在等待商店的响应，所以估算出的W/C比率为100.这意味着你期望的CPU利用率是100%。你需要创建一个有400个线程的线程池。但是，在实际操作中，如果你创建的线程数比商店的数目更多，反而是一种浪费，因为线程池中有些线程根本没有用到。所以，基于这种考虑将线程池的数目与你要查询的商店的数目设定为一个值，这个每个商店都对应一个服务线程。不过，为了避免商店数目过多导致服务器超负荷而崩溃，你需要设置一个上限，比如这里的100个线程。</li></ul><h2 id="将2个异步执行的结果合并为一个"><a href="#将2个异步执行的结果合并为一个" class="headerlink" title="将2个异步执行的结果合并为一个"></a>将2个异步执行的结果合并为一个</h2><p>我们假定商店提供了查询商品价格的服务getPrice，它会返回商品的价格和折扣代码，另外还提供了查询扣后价的方法。<br>另外提供了Quote类用于将getPrice返回的结果进行封装。</p><p>商家提供的getPrice方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPrice1</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> price = caculatePrice(product);</span><br><span class="line"></span><br><span class="line">    Discount.Code code = Discount.Code.values()[random.nextInt(Discount.Code.values().length)];</span><br><span class="line">    <span class="comment">// 返回结果包括商品名称、商品价格和折扣代码，是一个字符串，它们用冒号隔开；</span></span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"%s:%.2f:%s"</span>,name,price,code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Quote类的主要方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Quote <span class="title">parse</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">    String[] split = s.split(<span class="string">":"</span>);</span><br><span class="line">    String shopName = split[<span class="number">0</span>];</span><br><span class="line">    Double price = Double.parseDouble(split[<span class="number">1</span>]);</span><br><span class="line">    Discount.Code code = Discount.Code.valueOf(split[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Quote(shopName,price,code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>折扣类代码大致如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Discount</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 折扣代码和折扣率</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> Code &#123;</span><br><span class="line">        NONE(<span class="number">0</span>),SILVER(<span class="number">5</span>),GOLD(<span class="number">10</span>),PLATINUM(<span class="number">15</span>),DIAMOND(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> percentage;</span><br><span class="line"></span><br><span class="line">        Code(<span class="keyword">int</span> percentage) &#123;</span><br><span class="line">            <span class="keyword">this</span>.percentage = percentage;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 申请折扣</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> quote</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">applyDiscount</span><span class="params">(Quote quote)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s price is %.2f"</span>,quote.getShopName(),Discount.apply(quote.getPrice(),quote.getCode()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(Double price,Code code)</span> </span>&#123;</span><br><span class="line">        delay();</span><br><span class="line">        <span class="keyword">return</span> price * (<span class="number">100</span> - code.percentage)/<span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">delay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> time = <span class="number">500</span> + <span class="keyword">new</span> Random().nextInt(<span class="number">2000</span>);</span><br><span class="line">            Thread.sleep(time);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们需要实现的逻辑是：<br>1.查询商品的价格，得到商品名称、价格、折扣代码；<br>2.将1中的结果进行封装，得到Quote；<br>3.利用Discount的applyDiscount方法计算折扣价。<br>可以看到，第1步可以异步执行，而第2步只是简单的封装，不涉及远程服务和I/O操作，所以没必要使用异步。第3步由于需要联系远程Discount服务，根据折扣代码得到折扣率，所以它也以异步的方式执行。<br>我们的代码大致如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(Math.min(shops.size(), <span class="number">100</span>), (r) -&gt; &#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;);</span><br><span class="line">List&lt;CompletableFuture&lt;String&gt;&gt; futures = shops.stream()</span><br><span class="line">        .map(shop -&gt; CompletableFuture.supplyAsync(() -&gt; shop.getPrice1(product), executor)) <span class="comment">// 返回Stream&lt;Future&lt;String&gt;&gt;</span></span><br><span class="line">        .map(future -&gt; future.thenApply(Quote::parse)) <span class="comment">// 返回Stream&lt;Future&lt;Quote&gt;&gt;</span></span><br><span class="line">        .map(future -&gt; future.thenCompose(quote -&gt; CompletableFuture.supplyAsync(() -&gt; Discount.applyDiscount(quote), executor)))</span><br><span class="line">        .collect(Collectors.toList());</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; results = futures.stream().map(CompletableFuture::join).collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><p>thenApply有点类似于JavaScript中的回调函数，它在Future结果计算完成后，将结果作为参数回调这个函数。它不会阻塞线程。<br>所以这里的意思就是在拿到商店的商品名称、价格、折扣代码后，将其封装为一个Quote对象。</p><p>thenCompose用于连接2个CompletableFuture，它会将第一个Future的结果作为参数传递给第2个Future。所以这里将第2个map的结果quote作为参数传递给了第2个Future，用于计算折后价。</p><h2 id="将2个Future合并起来，无论他们是否有依赖"><a href="#将2个Future合并起来，无论他们是否有依赖" class="headerlink" title="将2个Future合并起来，无论他们是否有依赖"></a>将2个Future合并起来，无论他们是否有依赖</h2><p>如果你希望将2个完全不相干的CompletableFuture的结果整合，那么可以使用CompletableFuture的thenCombine方法。</p><p>比如，你可以以异步的方式查询某个商店商品的价格，同时你可以以异步的方式从远程汇率服务查询欧元和美元的汇率，然后将商品的价格乘以当时的汇率，得到以美元计价的商品价格。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Future&lt;Double&gt; future = CompletableFuture.supplyAsync(() -&gt; shop.getPrice(product)) <span class="comment">// 异步查询商品价格</span></span><br><span class="line">    .thenCombine(</span><br><span class="line">            <span class="comment">// 异步计算汇率</span></span><br><span class="line">            CompletableFuture.supplyAsync(() -&gt; exchangeService.getRate(Money.EUR, Money.USD)),</span><br><span class="line">            (price, rate) -&gt; price * rate <span class="comment">//执行的合并操作</span></span><br><span class="line">    );</span><br></pre></td></tr></table></figure></p><h2 id="响应Future的完成事件"><a href="#响应Future的完成事件" class="headerlink" title="响应Future的完成事件"></a>响应Future的完成事件</h2><p>比如，我们要查询100个商店的某件商品的价格，可能某个商店的服务或者网络问题，导致查询耗时很久，如果按照之前的方式等待所有的任务执行完毕，那么给人的体验就不好。比如假定某个商店查询价格耗时100秒，那么用户可能看到页面上在这100秒内都是一片空白。其实，我们可以对CompletableFuture的complete做出响应，使用它的thenAccept方法可以在任务执行完毕收收到通知，方法的参数为Future执行的结果。这样只要有任务执行完毕，就会立即显示出来。<br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService executor = Executors.newFixedThreadPool(Math.min(shops.size(), <span class="number">100</span>), (r) -&gt; &#123;</span><br><span class="line">    Thread thread = <span class="keyword">new</span> Thread(r);</span><br><span class="line">    thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> thread;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">CompletableFuture[] futures = shops.stream()</span><br><span class="line">        .map(shop -&gt; CompletableFuture.supplyAsync(() -&gt; shop.getPrice1(product),executor))</span><br><span class="line">        .map(future -&gt; future.thenApply(Quote::parse))</span><br><span class="line">        .map(future -&gt; future.thenCompose(quote -&gt; CompletableFuture.supplyAsync(() -&gt; Discount.applyDiscount(quote),executor)))</span><br><span class="line">        .map(future -&gt; future.thenAccept(s -&gt; &#123; <span class="comment">// 这里一旦Future执行完毕，立即会调用该方法</span></span><br><span class="line">            System.out.println(s + <span class="string">" (done in "</span> + (System.nanoTime() - start ) / <span class="number">1_000_000</span> + <span class="string">"msecs.)"</span>);</span><br><span class="line">        &#125;))</span><br><span class="line">        .toArray(length -&gt; <span class="keyword">new</span> CompletableFuture[length]);</span><br><span class="line"></span><br><span class="line">CompletableFuture.allOf(futures).join();</span><br><span class="line">System.out.println(<span class="string">"All shops have now responded in "</span> + (System.nanoTime() - start ) / <span class="number">1_000_000</span> + <span class="string">"msecs."</span>);</span><br></pre></td></tr></table></figure></p><p>结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JustByIt price is 135.63 (done in 1636msecs.)</span><br><span class="line">BestPrice price is 72.03 (done in 2009msecs.)</span><br><span class="line">BuyItAll price is 126.38 (done in 2442msecs.)</span><br><span class="line">LetsSaveBig price is 139.40 (done in 3069msecs.)</span><br><span class="line">MyFavoriteShop price is 115.09 (done in 3167msecs.)</span><br><span class="line">All shops have now responded in 3168msecs.</span><br><span class="line">Done in 3263 msecs</span><br></pre></td></tr></table></figure></p><p>注意：这里用到了CompletableFuture的allOf方法，这里在所有任务执行完毕后，输出了一句话，表示任务完成。</p><h2 id="仅等待Future结合中最快结束的任务完成"><a href="#仅等待Future结合中最快结束的任务完成" class="headerlink" title="仅等待Future结合中最快结束的任务完成"></a>仅等待Future结合中最快结束的任务完成</h2><p>上面的例子使用了allOf方法，表示等待一组Future执行完毕。如果只是希望某个任务执行完毕即结束，那么可以使用anyOf方法。</p><h2 id="通过编程方式完成一个Future任务的执行"><a href="#通过编程方式完成一个Future任务的执行" class="headerlink" title="通过编程方式完成一个Future任务的执行"></a>通过编程方式完成一个Future任务的执行</h2><p>假定在调用一个方法时，希望以异步的方式执行，我们在方法中使用一个线程来处理计算，然后立即返回了一个Future。那么我们可以计算完毕后，使用CompletableFuture的complete方法设置任务执行结果。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;Double&gt; <span class="title">getPriceAsync</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    CompletableFuture&lt;Double&gt; future = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">double</span> price = caculatePrice(product);</span><br><span class="line">            future.complete(price);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="CompletableFuture与异常处理"><a href="#CompletableFuture与异常处理" class="headerlink" title="CompletableFuture与异常处理"></a>CompletableFuture与异常处理</h2><p>在上面的代码中，如果执行caculatePrice方法出现异常，会导致调用CompletableFuture的get方法永远等待下去。异常被限制在计算商品价格的线程范围，最后会杀死该线程，所以调用Future的get会一直等待。</p><p>当然，你可以使用带超时参数的get的重载方法来避免无限期等待，最终抛出一个TimeoutException，但这样你并不知道执行任务的线程到底出现了什么问题。</p><p>为了解决这个问题，你可以使用CompletableFuture的completeExceptionally将异常抛出。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;Double&gt; <span class="title">getPriceAsync</span><span class="params">(String product)</span> </span>&#123;</span><br><span class="line">    CompletableFuture&lt;Double&gt; future = <span class="keyword">new</span> CompletableFuture&lt;&gt;();</span><br><span class="line">    <span class="keyword">new</span> Thread()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">double</span> price = caculatePrice(product);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 这里对0做除法并不会抛出异常，在不在线程中使用会抛出异常</span></span><br><span class="line">                <span class="comment">//System.out.println(price / 0);</span></span><br><span class="line">                <span class="comment">// 数组越界会抛出异常</span></span><br><span class="line">                <span class="keyword">int</span>[] arr = &#123;&#125;;</span><br><span class="line">                System.out.println(arr[<span class="number">1</span>]);</span><br><span class="line">                future.complete(price);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                future.completeExceptionally(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>比如，上面我们认为模拟了一个数组下标越界的异常。调用future的get方法的客户端会立即得到一个异常，get方法就不会无限期等待了。另外，调用get方法时，始终建议使用带超时参数的重载方法，避免无限等待。</p><p>另外，注意：CompletableFuture的所有异步方法都使用了同样的错误管理机制，你不用再花大力气去处理异常了。</p><p>参考《java8实战》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java 8 新的日期和时间API</title>
      <link href="/2018/09/14/JDK8%E6%96%B0%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4API/"/>
      <url>/2018/09/14/JDK8%E6%96%B0%E7%9A%84%E6%97%A5%E6%9C%9F%E5%92%8C%E6%97%B6%E9%97%B4API/</url>
      
        <content type="html"><![CDATA[<h2 id="LocalDate、LocalTime、Instant、Duration和Period"><a href="#LocalDate、LocalTime、Instant、Duration和Period" class="headerlink" title="LocalDate、LocalTime、Instant、Duration和Period"></a>LocalDate、LocalTime、Instant、Duration和Period</h2><h3 id="使用LocalDate和LocalTime"><a href="#使用LocalDate和LocalTime" class="headerlink" title="使用LocalDate和LocalTime"></a>使用LocalDate和LocalTime</h3><p>LocalDate是一个不可变对象，提供了简单的日期，不包含时间，也没有附带任何时区相关的信息。你可以通过静态方法of创建一个LocalDate实例。LocalDate提供了很多实用的方法来读取常用的值，比如年份、月份、星期几等。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">LocalDate date = LocalDate.of(<span class="number">2014</span>,<span class="number">3</span>,<span class="number">18</span>);</span><br><span class="line"><span class="keyword">int</span> year = date.getYear(); <span class="comment">// 2014</span></span><br><span class="line">Month month = date.getMonth(); <span class="comment">// MARCH</span></span><br><span class="line"><span class="keyword">int</span> day = month.dayOfMonth(); <span class="comment">// 18</span></span><br><span class="line">DayOfWeek dow = date.getDayOfWeek(); <span class="comment">// TUESDAY</span></span><br><span class="line"><span class="keyword">int</span> len = date.lengthOfMonth(); <span class="comment">// 31(days in March)</span></span><br><span class="line"><span class="keyword">boolean</span> leap = date.isLeapYear(); <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以通过工厂方法从系统时钟获取当前日期</span></span><br><span class="line">LocalDate today = LocalDate.now();</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>你还可以传递一个TemporalField参数拿到同样的信息。TemporalField是一个接口，定义了如何访问tempoal对象某个字段的值。ChronoFIeld枚举实现了这个接口，所以你可以用get方法得到枚举元素的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> year = date.get(ChronoField.YEAR);</span><br><span class="line"><span class="keyword">int</span> month = date.get(ChronoField.MONTH_OF_YEAR);</span><br><span class="line"><span class="keyword">int</span> day = date.get(ChronoField.DAY_OF_MONTH);</span><br></pre></td></tr></table></figure></p><p>可以使用LocalTime来表示时间，可以使用of重载的两个工厂方法创建它的实例。第一个重载函数接收小时和分钟，第2个重载函数同时还接受秒。同LocalDate一样，LocalTime也提供了一些getter方法来访问这些变量的值。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LocalTime time = LocalTime.of(<span class="number">16</span>,<span class="number">55</span>,<span class="number">32</span>);</span><br><span class="line"><span class="keyword">int</span> hour = time.getHour();</span><br><span class="line"><span class="keyword">int</span> minute = time.getMinute();</span><br><span class="line"><span class="keyword">int</span> second = time.getSecond();</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> _hour = time.get(ChronoField.HOUR_OF_DAY);</span><br><span class="line"></span><br><span class="line">LocalTime _time = LocalTime.now();</span><br></pre></td></tr></table></figure></p><h3 id="合并日期和时间"><a href="#合并日期和时间" class="headerlink" title="合并日期和时间"></a>合并日期和时间</h3><p>这个符合类名叫LocalDateTime，它同时表示了日期和时间，但不带时区信息。你可以直接创建，也可以通过合并日期和时间对象构造。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">LocalDateTime dt1 = LocalDateTime.of(<span class="number">2018</span>,<span class="number">9</span>,<span class="number">15</span>,<span class="number">16</span>,<span class="number">50</span>,<span class="number">30</span>); <span class="comment">// 直接创建</span></span><br><span class="line">LocalDateTime dt2 = LocalDateTime.of(date,time); <span class="comment">// 复合LocalDate和LocalTime</span></span><br><span class="line">LocalDateTime dt3 = date.atTime(<span class="number">13</span>,<span class="number">59</span>,<span class="number">39</span>); <span class="comment">// 通过日期指定时间</span></span><br><span class="line">LocalDateTime dt4 = time.atDate(date); <span class="comment">// 通过时间指定日期</span></span><br><span class="line">LocalDateTime dt5 = date.atTime(time);</span><br><span class="line"></span><br><span class="line">LocalDate date = dt1.toLocalDate(); <span class="comment">// 得到LocalDate</span></span><br><span class="line">LocalTime time = dt1.toLocalTime(); <span class="comment">// 得到LocalTime</span></span><br></pre></td></tr></table></figure></p><h3 id="机器的日期和时间格式"><a href="#机器的日期和时间格式" class="headerlink" title="机器的日期和时间格式"></a>机器的日期和时间格式</h3><p>java.time.Instant是给机器使用的，包含秒和纳秒构成的数字，它是以Unix元年时间（UTC时区1970年1月1日午夜时分）开始所经历的秒数进行计算。你可以向静态方法ofEpochSecond传递一个代表秒数的值创建一个实例。它还有一个增强版本的方法，它接收第二个以纳秒为单位的参数，对传入的描述进行调整。重载的版本会调整纳秒参数，确保保存的纳秒分片在0到999 999 999之间。<br>下面的这些调用会返回几乎相同的Instant对象。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Instant.ofEpochSecond(<span class="number">3</span>);</span><br><span class="line">Instant.ofEpochSecond(<span class="number">3</span>,<span class="number">0</span>);</span><br><span class="line">Instant.ofEpochSecond(<span class="number">2</span>,<span class="number">1_000_000_000</span>); <span class="comment">// 2秒之后再加上100万纳秒（1秒）</span></span><br><span class="line">Instant.ofEpochSecond(<span class="number">4</span>,-<span class="number">1_000_000_000</span>); <span class="comment">// 4秒之前的100万纳秒（1秒）</span></span><br></pre></td></tr></table></figure></p><h3 id="日期-时间间隔"><a href="#日期-时间间隔" class="headerlink" title="日期/时间间隔"></a>日期/时间间隔</h3><p>表示2个日期/时间的间隔，可以使用Duration或Period。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LocalTime time1 = LocalTime.of(<span class="number">15</span>,<span class="number">23</span>);</span><br><span class="line">LocalTime time2 = LocalTime.of(<span class="number">5</span>,<span class="number">29</span>);</span><br><span class="line">Duration d1 = Duration.between(time1,time2);</span><br><span class="line"></span><br><span class="line">LocalDate date1 = LocalDate.now();</span><br><span class="line">LocalDate date2 = LocalDate.of(<span class="number">2019</span>,<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">Duration d2 = Duration.between(date1,date2);</span><br><span class="line"></span><br><span class="line">LocalDateTime dateTime1 = LocalDateTime.of(date1,time1);</span><br><span class="line">LocalDateTime dateTime2 = LocalDateTime.of(date2,time2);</span><br><span class="line">Duration d3 = Duration.between(dateTime1,dateTime2);</span><br><span class="line"></span><br><span class="line">Instant instant1 = Instant.ofEpochSecond(<span class="number">3</span>);</span><br><span class="line">Instant instant2 = Instant.ofEpochSecond(<span class="number">5</span>,<span class="number">2_000_000_000</span>);</span><br><span class="line">Duration d4 = Duration.between(instant1,instant2);</span><br><span class="line"></span><br><span class="line">Duration threeMiniutes = Duration.ofMinutes(<span class="number">3</span>);</span><br><span class="line">Duration _threeMinutes = Duration.of(<span class="number">3</span>, ChronoUnit.MINUTES);</span><br><span class="line"></span><br><span class="line">Period tenDyas = Period.ofDays(<span class="number">10</span>);</span><br><span class="line">Period threeWeeks = Period.ofWeeks(<span class="number">3</span>);</span><br><span class="line">Period twoYearsSixMonthsOneDay = Period.of(<span class="number">2</span>,<span class="number">6</span>,<span class="number">1</span>);</span><br></pre></td></tr></table></figure></p><p><strong>日期-时间内中表示时间间隔的通用方法</strong></p><table><thead><tr><th>方法名</th><th style="text-align:left">是否静态方法</th><th style="text-align:left">方法描述</th></tr></thead><tbody><tr><td>between</td><td style="text-align:left">是</td><td style="text-align:left">创建两个时间点之间的interval</td></tr><tr><td>from</td><td style="text-align:left">是</td><td style="text-align:left">由一个临时节点创建interval</td></tr><tr><td>of</td><td style="text-align:left">是</td><td style="text-align:left">由它的组成部分创建interval</td></tr><tr><td>parse</td><td style="text-align:left">是</td><td style="text-align:left">由字符串创建interval</td></tr><tr><td>addTo</td><td style="text-align:left">否</td><td style="text-align:left">创建该interval的副本，并将其叠加到某个指定的temporal对象</td></tr><tr><td>get</td><td style="text-align:left">否</td><td style="text-align:left">读取该interval的状态</td></tr><tr><td>isNegative</td><td style="text-align:left">否</td><td style="text-align:left">检查该interval是否是负值，不包含0</td></tr><tr><td>iszero</td><td style="text-align:left">否</td><td style="text-align:left">检查该interval的时长是否为0</td></tr><tr><td>minus</td><td style="text-align:left">否</td><td style="text-align:left">通过减去一定的时间创建该interval的副本</td></tr><tr><td>multipliedBy</td><td style="text-align:left">否</td><td style="text-align:left">将interval的值乘以某个标量创建该interval的副本</td></tr><tr><td>negated</td><td style="text-align:left">否</td><td style="text-align:left">以忽略某个时长的方式创建该interval的副本</td></tr><tr><td>plus</td><td style="text-align:left">否</td><td style="text-align:left">以增加某个指定时长的方式创建该interval的副本</td></tr><tr><td>subtrctFrom</td><td style="text-align:left">否</td><td style="text-align:left">从指定的temporal对象中减去该interval</td></tr></tbody></table><p>上面介绍的这些日期-时间对象都是不可变的，是为了更好的支持函数式编程，确保线程安全，保持领域模式一致性。</p><h2 id="操作、解析和格式化日期"><a href="#操作、解析和格式化日期" class="headerlink" title="操作、解析和格式化日期"></a>操作、解析和格式化日期</h2><p>如果已经有了一个LocalDate对象，如果想要修改日期，可以使用它的withAttribute和with方法，会创建一个副本，并按照需要修改的属性。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LocalDate _date1 = LocalDate.of(<span class="number">2019</span>,<span class="number">5</span>,<span class="number">15</span>);</span><br><span class="line">LocalDate _date2 = _date1.withYear(<span class="number">2018</span>); <span class="comment">// 2018-05-15</span></span><br><span class="line"><span class="comment">// 使用withAttribute方法</span></span><br><span class="line">LocalDate _date3 = _date1.withDayOfMonth(<span class="number">20</span>); <span class="comment">// 2019-05-20</span></span><br><span class="line"><span class="comment">// 使用with方法</span></span><br><span class="line">LocalDate _date4 = _date1.with(ChronoField.MONTH_OF_YEAR,<span class="number">2</span>); <span class="comment">// 2019-02-15</span></span><br></pre></td></tr></table></figure></p><p>上面是比较直接的修改方式，也可以以相对方式修改日期，比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LocalDate _date5 = _date1.plusYears(<span class="number">1</span>); <span class="comment">// 2020-05-15</span></span><br><span class="line">LocalDate _date6 = _date1.minusWeeks(<span class="number">1</span>); <span class="comment">// 2019-05-08</span></span><br></pre></td></tr></table></figure></p><p><strong>表示时间点的日期-时间类的通用方法</strong></p><table><thead><tr><th>方法名</th><th style="text-align:left">是否静态方法</th><th style="text-align:left">方法描述</th></tr></thead><tbody><tr><td>from</td><td style="text-align:left">是</td><td style="text-align:left">根据传入的Temporal对象创建实例</td></tr><tr><td>now</td><td style="text-align:left">是</td><td style="text-align:left">根据系统时钟创建Temporal实例</td></tr><tr><td>of</td><td style="text-align:left">是</td><td style="text-align:left">由Temporal对象的某个部分创建该对象的实例</td></tr><tr><td>parse</td><td style="text-align:left">是</td><td style="text-align:left">由字符串创建Temporal对象的实例</td></tr><tr><td>atOffset</td><td style="text-align:left">否</td><td style="text-align:left">将Temporal对象和某个时区偏移相结合</td></tr><tr><td>atZone</td><td style="text-align:left">否</td><td style="text-align:left">将Temporal对象和某个时区相结合</td></tr><tr><td>format</td><td style="text-align:left">否</td><td style="text-align:left">使用某个指定的格式器将Temporal对象转换为字符串</td></tr><tr><td>get</td><td style="text-align:left">否</td><td style="text-align:left">读取Temporal对象某一部分的值</td></tr><tr><td>minus</td><td style="text-align:left">否</td><td style="text-align:left">通过将当前Temporal对象减去一定的时长创建副本</td></tr><tr><td>plus</td><td style="text-align:left">否</td><td style="text-align:left">通过将当前Temporal对象增加一定的时长创建副本</td></tr><tr><td>with</td><td style="text-align:left">否</td><td style="text-align:left">以该Temporal对象为模板，将某些状态进行修改创建该对象的副本。</td></tr></tbody></table><p><strong>使用TemporalAdjuster</strong><br>前面的日期操作都是相对比较直接的，你还可使用TemporalAdjuster来进行一些更复杂的操作。<br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocalDate _date7 = _date1.with(nextOrSame(DayOfWeek.SUNDAY)); <span class="comment">// 2019-05-19</span></span><br></pre></td></tr></table></figure></p><p><strong>TemporalAdjuster的工厂方法</strong></p><table><thead><tr><th>方法名</th><th style="text-align:left">方法描述</th></tr></thead><tbody><tr><td>dayOfWeekInMonth</td><td style="text-align:left">创建一个新的日期，它的值为同一个月中每一周的第几天</td></tr><tr><td>firstDayOfMonth</td><td style="text-align:left">创建一个新的日期，它的值为当月的第一天</td></tr><tr><td>firstDayOfNextMonth</td><td style="text-align:left">创建一个新的日期，它的值为下个月的第一天</td></tr><tr><td>firstDayOfNextYear</td><td style="text-align:left">创建一个新的日期，它的值为明年的第一天</td></tr><tr><td>firstDayOfYear</td><td style="text-align:left">创建一个新的日期，它的值为当年的第一天</td></tr><tr><td>firstInMonth</td><td style="text-align:left">创建一个新的日期，它的值为同一个月中，第一个符合星期几要求的值</td></tr><tr><td>lastDayOfMonth</td><td style="text-align:left">创建一个新的日期，它的值为当月的最后一天</td></tr><tr><td>lastDayOfNextMonth</td><td style="text-align:left">创建一个新的日期，它的值为下个月的最后一天</td></tr><tr><td>lastDayOfNextYear</td><td style="text-align:left">创建一个新的日期，它的值为明年的最后一天</td></tr><tr><td>lastDayOfYear</td><td style="text-align:left">创建一个新的日期，它的值为当年的今年的最后一天</td></tr><tr><td>lastInMonth</td><td style="text-align:left">创建一个新的日期，它的值为同一个月中，最后一个符合星期几要求的值</td></tr><tr><td>next/previous</td><td style="text-align:left">创建一个新的日期，并将其值设定为日期调整后/前，第一个符合指定星期几要求的日期</td></tr><tr><td>nextOrSame/preivousOrSave</td><td style="text-align:left">创建一个新的日期，并将其值设定为日期调整后/前，第一个符合指定星期几要求的日期。如果该日期已经符合要求，直接返回该对象</td></tr></tbody></table><p>如果上面的方法还不能满足你的要求，实现自己的TemporalAdjuster也很简单。实现TemporalAdjuster的adjustInto接口即可。<br>下面实现一个自定义的TemporalAdjuster，能够计算明天的日期，并过滤掉周六周日。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NextWorkingDayAdjuster</span> <span class="keyword">implements</span> <span class="title">TemporalAdjuster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Temporal <span class="title">adjustInto</span><span class="params">(Temporal temporal)</span> </span>&#123;</span><br><span class="line">        DayOfWeek dayOfWeek = DayOfWeek.of(temporal.get(ChronoField.DAY_OF_WEEK));</span><br><span class="line">        <span class="keyword">int</span> dayToAdd = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dayOfWeek == DayOfWeek.FRIDAY) &#123;</span><br><span class="line">            dayToAdd = <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (dayOfWeek == DayOfWeek.SATURDAY) &#123;</span><br><span class="line">            dayToAdd = <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> temporal.plus(dayToAdd, ChronoUnit.DAYS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NextWorkingDayAdjuster adjuster = <span class="keyword">new</span> NextWorkingDayAdjuster();</span><br><span class="line">LocalDate _date8 = _date1.with(adjuster);</span><br></pre></td></tr></table></figure></p><h3 id="日期解析和格式化"><a href="#日期解析和格式化" class="headerlink" title="日期解析和格式化"></a>日期解析和格式化</h3><p>java8日期格式化的类在java.time.format包中，其中最重要的类是DateTimeFormatter。DateTimeFormatter提供了大量的预定义格式的DateTimeFormatter。<br>比如：<br>格式化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s1 = _date1.format(DateTimeFormatter.BASIC_ISO_DATE);</span><br><span class="line">String s2 = _date1.format(DateTimeFormatter.ISO_LOCAL_DATE);</span><br></pre></td></tr></table></figure></p><p>解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LocalDate dd1 = LocalDate.parse(<span class="string">"20190112"</span>,DateTimeFormatter.BASIC_ISO_DATE);</span><br></pre></td></tr></table></figure></p><p>这些DateTimeFormmater的实例都是线程安全的，所以你能够以单例的形式创建Formatter实例，并在多个线程之间共享。</p><p>你还可以通过DateTimeFormatter的ofPattern方法创建。比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DateTimeFormatter formatter = DateTimeFormatter.ofPattern(<span class="string">"dd/MM/yyyy"</span>);</span><br></pre></td></tr></table></figure></p><p>另外，你还可以通过DateTimeFormatterBuilder来创建。<br>比如<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BASIC_ISO_DATE = <span class="keyword">new</span> DateTimeFormatterBuilder()</span><br><span class="line">    .parseCaseInsensitive()</span><br><span class="line">    .appendValue(YEAR, <span class="number">4</span>)</span><br><span class="line">    .appendValue(MONTH_OF_YEAR, <span class="number">2</span>)</span><br><span class="line">    .appendValue(DAY_OF_MONTH, <span class="number">2</span>)</span><br><span class="line">    .optionalStart()</span><br><span class="line">    .appendOffset(<span class="string">"+HHMMss"</span>, <span class="string">"Z"</span>)</span><br><span class="line">    .toFormatter(ResolverStyle.STRICT, IsoChronology.INSTANCE);</span><br></pre></td></tr></table></figure></p><h2 id="处理不同的时区"><a href="#处理不同的时区" class="headerlink" title="处理不同的时区"></a>处理不同的时区</h2><p>新的java.time.ZoneId是对老的java.util.TimeZone的替代，大大简化了时区处理的操作。<br>你可以按照ZoneId.of(地区ID标识)来得到指定时区。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZoneId romeZone = ZoneId.of(<span class="string">"Europe/Rome"</span>);</span><br></pre></td></tr></table></figure></p><p>或者通过toZoneId()来将老的时区对象转换为ZoneId。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZoneId zoneId = TimeZone.getDefault().toZoneId();</span><br></pre></td></tr></table></figure></p><p>有了ZoneId，你可以将它和LocalDate、LocalDateTime或Instant整合起来，构造为一个ZoneDateTime实例，它代表了相对于指定时区的时间点。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZonedDateTime zonedDateTime = date.atStartOfDay(zoneId);</span><br><span class="line">zonedDateTime = dateTime1.atZone(romeZone);</span><br><span class="line">zonedDateTime = instant.atZone(romeZone);</span><br></pre></td></tr></table></figure></p><p>ZoneOffset是ZoneId的一个子类，表示的是当前时间与伦敦格林尼治子午线时间的差异。比如纽约落后于伦敦5小时，可以使用下面的方式表示:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ZoneOffset zoneOffset = ZoneOffset.of(<span class="string">"-05:00"</span>); <span class="comment">// 美国东部时间偏移量</span></span><br><span class="line">LocalDateTime localDateTime = LocalDateTime.of(<span class="number">2018</span>,<span class="number">9</span>,<span class="number">19</span>,<span class="number">15</span>,<span class="number">30</span>,<span class="number">29</span>);</span><br><span class="line">OffsetDateTime offsetDateTime = OffsetDateTime.of(localDateTime,zoneOffset);</span><br></pre></td></tr></table></figure></p><p>-05:00的偏差实际上对应的是美国东部标准时间。注意：这种方式定义的ZoneOffset没有考虑夏令时的影响，所以大多数情况下，不推荐使用。</p><p>参考《java8实战》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决idea卡顿问题</title>
      <link href="/2018/09/13/%E8%A7%A3%E5%86%B3idea%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/13/%E8%A7%A3%E5%86%B3idea%E5%8D%A1%E9%A1%BF%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>idea非常好用，但比较吃内存。建议内存至少8G。通过下面的设置来提升idea的速度。</p><h2 id="vm参数设置"><a href="#vm参数设置" class="headerlink" title="vm参数设置"></a>vm参数设置</h2><p>设置idea.exe.vmoptions/idea64.exe.vmoptions的vm参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-Xms2000m</span><br><span class="line">-Xmx2000m</span><br><span class="line">-Xverify:none</span><br></pre></td></tr></table></figure></p><p>-Xverify：none 关闭Java字节码验证，从而加快了类装入的速度，并使得在仅为验证目的而启动的过程中无需装入类，缩短了启动时间。<br>一般8G内存建议设置2-3G，-Xms和-Xms设置一样大，一样大可以使IDEA启动时初始堆内存就直接到最大，以免中途扩容影响启动速度。<br><a id="more"></a></p><h2 id="禁用不使用的插件"><a href="#禁用不使用的插件" class="headerlink" title="禁用不使用的插件"></a>禁用不使用的插件</h2><p>插件介绍：<br>参考：<a href="http://kailing.pub/idea/IntelliJ-IDEA.html">http://kailing.pub/idea/IntelliJ-IDEA.html</a>。<br>Git：Git（分布式版本控制工具）插件，需本地安装 Git。<br>Subversion：SVN 插件，新版本支持 Subversion1.8<br>ClearCase：IBM Rational 的 SCM 管理工具插件。<br>CVS：CVS 插件。<br>hg4idea：Mercurial 插件，与 Git 类似的分布式版本控制工具。<br>Perforce：Perfoce 插件，商业的版本控制工具。<br>TFS：Team Foundation Server 插件，微软的客户端-服务器源代码管理系统。<br>Visual SourceSafe：VSS 插件，微软的客户端的源代码管理系统。<br>Application Servers Views：配置应用服务器插件。<br>Database：数据库插件，可用于管理 MySQL、Oracle、SQLite 等。<br>Freemarker：支持 freemarker 语法插件。<br>Java EE: Batch Applications：新版本增加的功能，支持 Java EE 7 批处理编程模型(JSR- 352)。<br>Java EE: Bean Validator：支持 Java EE 6 的数据验证模型(JSR-303)。<br>Java EE: Contexts and Denpendency Injection：支持 Java EE6 的依赖注入模型(JSR-299)。<br>Java EE: EJB, JPA, Servlets：EJB、JPA、Servlet 的插件。<br>Java EE: JMS, JSON Processing, Concurrency Transaction：JMS, JSON, Transaction 等的 插件。<br>Java EE: RESTful Web Services： JAX-RS 插件。<br>Java EE: Web Services： JAX-WS 插件。<br>Java Server Pages： JSP 插件。<br>Persistence Frameworks：持久化(JPA、Hibernate)插件。<br>Spring Batch： Spring 批处理框架的插件。<br>Spring Data：Spring 数据访问框架(Mongodb、Redis、Hadoop)插件。<br>Spring Security：Spring 安全框架的插件。<br>Spring：Spring 插件<br>Spring Web Services：Spring Web Services 插件。<br>Spring-AOP and @AspectJ：Spring-AOP 和切面语言的插件。<br>SQL：SQL 插件<br>CoffeeScript：CoffeeScript 插件，基于 Javascript 之上的一门编程语言。<br>dmServer：dmServer 插件，基于 OSGi 的模块化部署的 java 服务器。<br>Google App Engine：GAE 插件，用于创建 GAE 项目。<br>GWT：GWT 插件，支持 GWT 代码提示、编译、组件开发等。<br>Hibernate：Hibernate 插件，支持 Hibernate 代码提示、反向生成代码等。<br>Java EE: Java Server Faces：JSF 插件，支持 JSF 语法。<br>Java EE: WebSockets：13 版本新功能，支持 Java EE WebSockets(JSR-356)。<br>JBoss Seam Pageflow：Jboss Seam PageFlow 插件。<br>Jboss Seam Pages：Jboss Seam Page 插件。<br>Playframework：Playframework 插件，一个 full-stack 的 Java web 框架。<br>Spring Integration Patterns：Spring 企业应用集成框架插件。<br>Spring OSGi：Spring OSGi 插件。<br>Spring Roo Console：Spring Roo 控制台，支持 Spring Roo 命令提示等。<br>Spring Web Flow：Spring 工作流插件。<br>Struts 1.x：Struts1 插件，支持 Struts1 语法提示，结构化显示 Action、Form 等。<br>Struts 2：Struts2 插件，支持 Struts2 语法(Xml、Tag)提示，结构化显示 Action 等。<br>Tapestry：Tapestry 插件，一个 MVC 与模板技术结合的 Java 框架。<br>Vaddin：Vaddin 插件，一个基于 GWT 的 Web RIA 框架。<br>Velocity：Velocity 插件，支持 Velocity 语法提示。<br>Resin：Resin 插件。<br>Tomcat and TomEE：Tomcat 或 TomEE 服务器插件，TomEE 是经过 J2EE 6 认证的<br>Tomcat 企业版本<br>Cloud Foundry：VMware 主导基于 Spring 的开源 PaaS 云计算平台。<br>CloudBees：基于 Tomcat 和 MySQL 的开源 PaaS 云计算平台。<br>Geronimo：Apache 的 J2EE 服务器。<br>GlassFish：Sun 的 J2EE 服务器。<br>Heroku：Heroku 是一个商业的 Rails 的 PaaS 云计算平台。<br>Jboss：Jboss 服务器插件。<br>Jetty：轻量级的 Servlet 服务器。<br>JSR45：兼容 JSR-45 的所有应用服务器，JSR-45(Debugging Support for Other Languages) 为那些非 JAVA 语言写成，却需要编译成 JAVA 代码，运行在 JVM 中的程序，提 供了一个进行调试的标准机制。<br>OpenShift：红帽的开源 PaaS 云计算平台。<br>WebLogic：Oracle 的商业 J2EE 服务器。<br>WebSphere：IBM 的商业 J2EE 服务器。<br>CSS：CSS 插件，可以直接显示 css 配色的颜色。<br>HTML Tools：Html 插件，支持 emmet 快速编写 html 代码。<br>Inspection-JS：JS 代码检测，目前还没见过哪个 IDE 对 JS 的支持有这么智能。<br>JavaScript Debugger：js 调试器，需 chrome 安装 Debugger 插件才可以支持。<br>Javascript Intention Power Pack：补充上面 JS 代码检测的不足。<br>Javascript：Javascript 插件。<br>QuirksMode：用于检测 CSS 和 HTML 的主流浏览器兼容性问题。<br>W3C Validators：W3C 标准检测插件。<br>Flash/Flex：Flash/Flex 开发插件。<br>LESS：LESS 插件，LESS 是一个 CSS 预处理器，通过简单的语法和变量对 CSS 进行扩 展。<br>SASS：SASS 语法支持，SASS 扩展了 CSS，使用特定的语法来编写 CSS。<br>Stylus：Stylus 插件，Stylus 是一个 CSS 预处理器。<br>Ant：Ant 插件。<br>AspectJ：AspectJ 切面框架插件。<br>Byte Code Viewer：java 字节码反编译查看插件。<br>Commander：提供了左右两个用于查看项目结构的插件，可用于项目结构对比或导 航。<br>Copyright：版权声明插件，保证版权信息的一致。<br>Coverage：查看代码覆盖率插件。<br>Cucumber for Java：Java 的 Cucumber 插件，Cucumber 是一个 BDD 驱动的自动化测 试工具。<br>DSM Analysis：架构可视化插件，战士模块间的依赖信息。<br>Eclipse：支持导入 eclipse 结构的项目。<br>Emma：检测代码覆盖率插件<br>Gherkin：Gherkin 语言插件，Cucumber 要用到。<br>Github：Github 集成插件。<br>IntelliLang：主要用于注解语法的注入验证、正则表达式语法检查等<br>Junit：Junit 单元测试插件。<br>Maven：Maven 插件。<br>Maven Integration Extension：Maven 依赖分析图插件。<br>Properties：属性文件(.properties)编辑插件。<br>Refactor-X：Xml 代码格式化插件。<br>Remote Hosts Access：远程主机访问，支持 ftp/ssh。<br>REST Client：用于访问 REST Web Service 的客户端插件。<br>SSH Remote Run：支持通过 Terminal 运行 SSH 脚本。<br>Structural Search：支持通过语法表达式进行搜索或替换。<br>Task Management：任务管理插件，支持 YouTrack, JIRA, Lighthouse, Pivotal Tracker, GitHub, Redmine,Trac 等问题跟踪系统。<br>Terminal：终端命令插件。<br>TestNG-J：TestNG 插件。<br>Time Tracking：任务管理插件中使用到的时间跟踪功能。<br>Type Migration：类型重构优化插件，对不够完善的代码提示重构，比如，静态方法 通过对象来调用而不是通过类调用等等。<br>UML：UML 插件。<br>XpathView+XSLT：Xpath 和 XSLT，支持高亮、分析，自动补全等。<br>XSLT-Debugger：XSLT 调试工具。<br>ZKM-Unscramble：分析 Java 堆栈跟踪插件。<br>Android Designer：安卓 UI 设计器<br>Android：安卓插件<br>ASP：ASP 编辑器<br>CFML：ColdFusion 标记语言插件，ColdFusion 是一个动态 Web 服务器，其 CFML 是 一个类似 JSTL 的程序语言。<br>Cucumber for Groovy：Groovy 的 Cucumber 插件，Cucumber 是一个 BDD 驱动的自 动化测试工具。<br>Gradle：Gradle 插件，Gradle 是一个类似 Maven 的 Java 构建工具。<br>Grails：Grails 插件，Grails 是 Rails 的 Groovy 实现。<br>Groovy：Groovy 插件，Groovy 是一种基于 JVM 的动态脚本语言。<br>GuiceyIDEA：Guice 插件，Guice 是 Google 开发的 Java IOC 框架。<br>HAML：HAML 插件，HAML 是一种 Rails 下的模板语言。<br>IDEtalk：IDEA 的即时通讯工具，用处不大。<br>J2ME：J2ME 插件。<br>JavaFX：JavaFX 插件，JavaFX 是 Sun 发布的 RIA 技术。<br>Jboss Drools：Drools 插件，Drools 是一种 Java 业务规则引擎。<br>Jboss jBPM：jBPM 插件，jBPM 是一种 Java 工作量引擎。<br>Osmorc：OSGi 插件。<br>Plugin DevKit：IDEA 插件开发工具。<br>UI Designer：Swing UI 设计插件。<br>UI Designer(Core)：Swing UI 设计插件。<br>YAML：YAML 插件，YAML 是一种数据序列化格式。</p><h2 id="移除不使用的模块"><a href="#移除不使用的模块" class="headerlink" title="移除不使用的模块"></a>移除不使用的模块</h2><p>点击模块，右键，Remove Module即可（不会删除本地文件）。这其实是很重要的一点，若是一个project下有太多的module，则idea scan file index就会很久。</p><h2 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h2><p><strong>单词拼写检查</strong><br>Settings-&gt;Editor-&gt;Inspections-&gt;Spelling勾选检查，去勾选不检查单词拼写。<br>Settings-&gt;Editor-&gt;Inspections-&gt;General-&gt;Duplicated Code，不进行重复代码检查。<br>你也可以Inspections不勾选任何东西。<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwtpqrr7ufj30sj0ipwhu.jpg" alt=""></p><h2 id="目前的配置推荐"><a href="#目前的配置推荐" class="headerlink" title="目前的配置推荐"></a>目前的配置推荐</h2><p>我目前安装的idea2017.2，编辑器使用的字体是JejaVu Sans Mono，13号字体。<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwtpsvinq6j30sj0ipmzy.jpg" alt=""></p><p>显示效果如下：<br><img src="https://ws1.sinaimg.cn/large/007oxnVvgy1fwtptclc0bj30qe0iddj4.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有道云笔记安全问题</title>
      <link href="/2018/09/12/%E6%9C%89%E9%81%93%E4%BA%91%E7%AC%94%E8%AE%B0%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/"/>
      <url>/2018/09/12/%E6%9C%89%E9%81%93%E4%BA%91%E7%AC%94%E8%AE%B0%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98/</url>
      
        <content type="html"><![CDATA[<p>有道云笔记是我个人一直在用的一款笔记软件，不过突然发现一个安全问题。哪怕你的文件上了锁，在有道云笔记的数据目录仍然可以看到。<br><img src="http://omh46px9n.bkt.clouddn.com/18-9-12/59855151.jpg" alt=""></p><p>所以，在公司离职的时候记得卸载软件并清空数据目录。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java 8使用Optional取代null</title>
      <link href="/2018/09/12/JDK8%E4%BD%BF%E7%94%A8Optional%E5%8F%96%E4%BB%A3null/"/>
      <url>/2018/09/12/JDK8%E4%BD%BF%E7%94%A8Optional%E5%8F%96%E4%BB%A3null/</url>
      
        <content type="html"><![CDATA[<p>在前面的章节中我们已经使用过Optional了，这里介绍Optional的更多用法。</p><p>假定有如下数据模型：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Car car;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Car <span class="title">getCar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Insurance insurance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Insurance <span class="title">getInsurance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> insurance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Insurance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>那么，下面这段代码有什么问题？<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCarInsuranceName</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> person.getCar().getInsurance().getName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>person可能为空，ca也可能为空，insurance也可能为空，任何一个对象为空都会抛出空指针异常。</p><p>所以，常规做法我们需要做空值判断。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCarInsuranceName</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != person) &#123;</span><br><span class="line">        Car car = person.getCar();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != car) &#123;</span><br><span class="line">            Insurance insurance = car.getInsurance();</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != insurance) &#123;</span><br><span class="line">                <span class="keyword">return</span> insurance.getName();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到N多层次的空值判断，这种方式不具备可扩展性，可读性也不好。</p><p>下面我们使用java 8提供的Optional来解决这个问题。<br>数据模型修改如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Optional&lt;Car&gt; car;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;Car&gt; <span class="title">getCar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> car;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Optional&lt;Insurance&gt; insurance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Optional&lt;Insurance&gt; <span class="title">getInsurance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> insurance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Insurance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>根据车主获取保险公司名字的方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCarInsuranceName</span><span class="params">(Optional&lt;Person&gt; person)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> person.flatMap(Person::getCar)</span><br><span class="line">        .flatMap(Car::getInsurance)</span><br><span class="line">        .map(Insurance::getName)</span><br><span class="line">        .orElse(<span class="string">"unknown"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Person、Car、Insurance任意一个对象为空，结果都会返回unknown。<br>very简洁有木有？</p><h2 id="Optional入门"><a href="#Optional入门" class="headerlink" title="Optional入门"></a>Optional入门</h2><h3 id="创建Optional对象"><a href="#创建Optional对象" class="headerlink" title="创建Optional对象"></a>创建Optional对象</h3><ul><li><p>声明一个空的Optional</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Person&gt; optPerson = Optional.empty();</span><br></pre></td></tr></table></figure></li><li><p>根据非空值创建</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Person person = <span class="keyword">new</span> Person();</span><br><span class="line">Optional&lt;Person&gt; optional = Optional.of(person);</span><br></pre></td></tr></table></figure></li></ul><p>如果person为null，会立即抛出空指针异常，而不是等到访问person的属性时才返回一个错误。</p><ul><li>可接受null的Optional<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Person&gt; optional = Optional.ofNullable(person);</span><br></pre></td></tr></table></figure></li></ul><p>如果person为null，那么得到的optional就是空对象。</p><h3 id="使用map从Optional提取和转换值"><a href="#使用map从Optional提取和转换值" class="headerlink" title="使用map从Optional提取和转换值"></a>使用map从Optional提取和转换值</h3><p>从insurance公司提取公司的名称，提取名称前，你需要检查insurance是否为null，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String name = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> != insurance) &#123;</span><br><span class="line">    name = insurance.getName();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>为了支持这种模式，Optional提供了map方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Insurance&gt; optInsurance = Optional.ofNullable(insurance);</span><br><span class="line">Optional&lt;String&gt; name = optInsurance.map(Insurance::getName);</span><br></pre></td></tr></table></figure></p><h3 id="使用flatMap链接Optional对象"><a href="#使用flatMap链接Optional对象" class="headerlink" title="使用flatMap链接Optional对象"></a>使用flatMap链接Optional对象</h3><p>在之前使用流时使用了它的flatMap方法，它接受一个函数作为参数，返回值是另一个流。这个方法会应用到流中的每个元素，最终形成一个新的流的流。但是flatMap会用流的内容替换每个新生成的流，即方法生成的各个流会被合并或者扁平化为一个单一的流。<br>如果我们使用Optional.map从Optional<Person>提取Insurance的name会编译不通过。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCarInsuranceName</span><span class="params">(Optional&lt;Person&gt; person)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> person.map(Person::getCar)</span><br><span class="line">        .map(Car::getInsurance)</span><br><span class="line">        .map(Insurance::getName)</span><br><span class="line">        .orElse(<span class="string">"unknown"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>因为<code>person.map(Person::getCar)</code>返回的是一个Optional&lt;Optional<Car>&gt;对象，所以它调用map(Car::getInsurance)是非法的。但是我们可以借助Optional.flatMap来实现，如文章最开始所述。</p><h3 id="2个Optional的组合"><a href="#2个Optional的组合" class="headerlink" title="2个Optional的组合"></a>2个Optional的组合</h3><p>假定有一个方法，接收一个Person和Car对象，并以此为条件对外提供服务进行查询，通过一些业务逻辑，返回满足该组合的最便宜的保险公司。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Insurance <span class="title">findCheapestInsurance</span><span class="params">(Person person,Car car)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不同保险公司提供的查询服务</span></span><br><span class="line">    <span class="comment">// 对比所有数据</span></span><br><span class="line">    <span class="keyword">return</span> cheapestCompany;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>假设我们需要一个Null-safe版本的方法，接收2个参数Optional<Person>和Optional<Car>，返回一个Optional<Insurance>对象。如果传入的任意一个参数为空，那么返回一个空的Optional。<br>由于Optional提供了一个isPersent方法，所以可能的实现如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Insurance <span class="title">nullSafeFindCheapestInsurance</span><span class="params">(Optional&lt;Person&gt; person,Optional&lt;Car&gt; car)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (person.isPresent() &amp;&amp; car.isPresent()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(findCheapestInsurance(person.get(),car.get()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Optional.empty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>但实际上，我们完全可以使用flatMap和map来实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;Insurance&gt; <span class="title">nullSafeFindCheapestInsurance</span><span class="params">(Optional&lt;Person&gt; person, Optional&lt;Car&gt; car)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> person.flatMap(p -&gt; car.map(c -&gt; findCheapestInsurance(p, c)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="使用filter剔除特定的值"><a href="#使用filter剔除特定的值" class="headerlink" title="使用filter剔除特定的值"></a>使用filter剔除特定的值</h3><p>filter方法接收一个谓词作为参数，如果Optional对象的值存在，并且符合谓词的条件，filter方法就返回其值，否则就返回一个空的Optional对象。<br>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Insurance&gt; optInsurance = ...;</span><br><span class="line">optInsurance.filter(insurance -&gt; <span class="string">"CambriadeInsurance"</span>.equals(insurance.getName())).ifPersent(System.out::println);</span><br></pre></td></tr></table></figure></p><p>示例2：找出年龄大于或等于minAge参数的Person所对应的保险公司列表。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCarInsuranceName</span><span class="params">(Optional&lt;Person&gt; person,<span class="keyword">int</span> minAge)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> person.filter(p -&gt; p.getAge() &gt;= minAge)</span><br><span class="line">                 .flatMap(Person::getCar)</span><br><span class="line">                 .flatMap(Car::getInsurance)</span><br><span class="line">                 .map(Insurance::getName)</span><br><span class="line">                 .orElse(<span class="string">"Unknown"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="使用Optional的实战示例"><a href="#使用Optional的实战示例" class="headerlink" title="使用Optional的实战示例"></a>使用Optional的实战示例</h2><h3 id="使用Optional封装可能的null值"><a href="#使用Optional封装可能的null值" class="headerlink" title="使用Optional封装可能的null值"></a>使用Optional封装可能的null值</h3><p>假设你有一个Map&lt;String,Object&gt;方法，访问由key索引的值时，如果map中没有与key关联的值，就会返回一个null。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object value = map.get(key);</span><br></pre></td></tr></table></figure></p><p>你可以使用Optional封装map的返回值<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Object&gt; value = Optional.ofNullable(map.get(key));</span><br></pre></td></tr></table></figure></p><p>每次你希望安全的将潜在的null的对象进行转换，将其转换为Optional对象时，就可以考虑使用这种方法。</p><h3 id="异常与Optional"><a href="#异常与Optional" class="headerlink" title="异常与Optional"></a>异常与Optional</h3><p>由于某种原因，函数无法返回值，这时除了返回null，还可能抛出一个异常，比如Integer.parseInt。</p><p>你可以使用Optional对操作结果进行包装<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Optional&lt;Integer&gt; <span class="title">stringToInt</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.of(Integer.parseInt(str));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>你可以将很多类似的操作封装在一个工具类中，比如叫OptionalUtility。以后就可以直接调用OptionalUtility.stringToInt，就能将字符串转换为一个Optional<Integer>，而无需记住你在其中封装了笨重的try/catch逻辑了。</p><p>注意：不推荐使用基础类型的Optional，比如OptionalInt,OptionalLong,OptionalDouble等等，因为它们不支持map、flatMap和filter等方法，而这些确实Optional中最有用的方法。</p><p>综合示例：从属性中读取一个int属性值（属性不存在则返回0）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readDuration</span><span class="params">(Properties p, String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Optional.ofNullable(p.getProperty(key))</span><br><span class="line">            .flatMap(OptionalUtility::stringToInt)</span><br><span class="line">            .filter(i -&gt; i &gt; <span class="number">0</span>)</span><br><span class="line">            .orElse(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>参考《java8实战》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>notepad++突然崩溃，保存的文件没了怎么办</title>
      <link href="/2018/09/12/notepad++%E7%AA%81%E7%84%B6%E5%B4%A9%E6%BA%83%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%9A%84%E6%96%87%E4%BB%B6%E6%B2%A1%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E/"/>
      <url>/2018/09/12/notepad++%E7%AA%81%E7%84%B6%E5%B4%A9%E6%BA%83%EF%BC%8C%E4%BF%9D%E5%AD%98%E7%9A%84%E6%96%87%E4%BB%B6%E6%B2%A1%E4%BA%86%E6%80%8E%E4%B9%88%E5%8A%9E/</url>
      
        <content type="html"><![CDATA[<p>Notepad++是一款功能强大、界面友好且易于使用的编辑器，平时少不了与它打交道。</p><p>不过，最近使用它编辑文件时，notepad++突然崩溃，而且之前已经保存过的文件内容也被清空了。不过好在notepad++默认启用了文件定时备份，可以在备份目录找到丢失的文件。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-9-12/53766599.jpg" alt=""></p><p>如果你的notepad++没有开启文件备份，建议打开，以防万一。另外，建议文件修改完毕后立即关闭它。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8之用流收集数据</title>
      <link href="/2018/09/11/JDK8%E4%B9%8B%E7%94%A8%E6%B5%81%E6%94%B6%E9%9B%86%E6%95%B0%E6%8D%AE/"/>
      <url>/2018/09/11/JDK8%E4%B9%8B%E7%94%A8%E6%B5%81%E6%94%B6%E9%9B%86%E6%95%B0%E6%8D%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="收集器简介"><a href="#收集器简介" class="headerlink" title="收集器简介"></a>收集器简介</h2><p>收集器非常有用，用它来可以简洁而灵活的定义collect用来生成结果集合的标准。对流调用collect方法会对流中的每个元素触发规约操作。一般来说，收集器会对元素应用一个转换函数，并将结果累积在一个数据结构中，从而产生这一过程的最终输出。</p><h2 id="规约和汇总"><a href="#规约和汇总" class="headerlink" title="规约和汇总"></a>规约和汇总</h2><p>在将流中的项目合并成一个结果时，一般会使用收集器（Stream的collect）。这个结果可以是任何类型，可以复杂如一棵树的多级映射，或是简单如一个整数。<br><a id="more"></a><br>假定有如下菜单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Dish&gt; menu = Arrays.asList(</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"pork"</span>, <span class="keyword">false</span>, <span class="number">800</span>, Dish.Type.MEAT),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"beef"</span>, <span class="keyword">false</span>, <span class="number">700</span>, Dish.Type.MEAT),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"chicken"</span>, <span class="keyword">false</span>, <span class="number">400</span>, Dish.Type.MEAT),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"french fries"</span>, <span class="keyword">true</span>, <span class="number">530</span>, Dish.Type.OTHER),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"rice"</span>, <span class="keyword">true</span>, <span class="number">300</span>, Dish.Type.OTHER),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"season fruit"</span>, <span class="keyword">true</span>, <span class="number">120</span>, Dish.Type.OTHER),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"pizza"</span>, <span class="keyword">false</span>, <span class="number">300</span>, Dish.Type.OTHER),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"prawns"</span>, <span class="keyword">false</span>, <span class="number">300</span>, Dish.Type.FISH),</span><br><span class="line">    <span class="keyword">new</span> Dish(<span class="string">"salmon"</span>, <span class="keyword">false</span>, <span class="number">450</span>, Dish.Type.FISH)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><p>在下面的所有示例中，假定你已经导入了Collectors的所有静态工厂方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.*;</span><br></pre></td></tr></table></figure></p><h3 id="查找流中的最大值和最小值"><a href="#查找流中的最大值和最小值" class="headerlink" title="查找流中的最大值和最小值"></a>查找流中的最大值和最小值</h3><p>假如你想找出菜中热量最高的菜和热量最低的菜，可以使用Collectors.maxBy和Collectors.minBy这2个收集器。它们接收一个Comparator参数来比较流中的元素。<br>比如找出菜单中热量最多的菜<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建比较器</span></span><br><span class="line">Comparator&lt;Dish&gt; dishComparator = Comparator.comparingInt(Dish::getCalories);</span><br><span class="line"><span class="comment">// 根据热量比较，找出最大热量的菜</span></span><br><span class="line">Optional&lt;Dish&gt; maxCaloriesDish = menu.stream().collect(maxBy(dishComparator));</span><br><span class="line">maxCaloriesDish.ifPresent(System.out::println);</span><br></pre></td></tr></table></figure></p><h3 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h3><p><strong>求和</strong><br>Collectors类专门为汇总提供了一个工厂方法：Collectors.summingInt。它接收一个把对象映射为求和所需的int的函数，并返回一个收集器。该收集器在传递给普通的collect方法后即自行我们需要的汇总操作。</p><p>比如计算菜的总热量<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> totalCalories = menu.stream().collect(summingInt(Dish::getCalories));</span><br></pre></td></tr></table></figure></p><p>在遍历流时，会将每道菜都映射为其热量，然后把数字累加到一个累加器（这里初始值为0）。</p><p>Collectors的summingLong和summingDouble方法与summingInt用法一样，用于处理long和double的情况。</p><p><strong>求平均值</strong><br>使用Collectors.averageInt/averageLong,averageDouble来求平均数。</p><p>比如，求所有菜平均的热量。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span> avgCalories = menu.stream().collect(averagingDouble(Dish::getCalories));</span><br></pre></td></tr></table></figure></p><p><strong>一次性获得多个汇总值</strong><br>如果你想一次性获取到多个汇总的结果，比如一次性获取到最大值、最小值，平均值，求和的结果等等，可以使用Collectors.summarizingInt方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IntSummaryStatistics summaryStatistics = menu.stream().collect(summarizingInt(Dish::getCalories));</span><br><span class="line">System.out.println(summaryStatistics);</span><br></pre></td></tr></table></figure></p><p>输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IntSummaryStatistics&#123;count=9, sum=3900, min=120, average=433.333333, max=800&#125;</span><br></pre></td></tr></table></figure></p><h3 id="连接字符串"><a href="#连接字符串" class="headerlink" title="连接字符串"></a>连接字符串</h3><p>Collectors.joining方法会将流中的每个元素应用toString()方法，然后将所得到的字符串连接在一起。</p><p>比如将菜单中所有菜名连接起来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String menuNames = menu.stream().map(Dish::getName).collect(joining());</span><br><span class="line">System.out.println(menuNames); <span class="comment">// 使用joining()无参数的方法只会将结果连接在一起</span></span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">porkbeefchickenfrench friesriceseason fruitpizzaprawnssalmon</span><br></pre></td></tr></table></figure></p><p>可以发现，可读性并不好，幸好提供了重载方法。我们可以提供一个分隔符。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">menuNames = menu.stream().map(Dish::getName).collect(joining(<span class="string">","</span>));</span><br><span class="line">System.out.println(menuNames); <span class="comment">// 用逗号分隔的菜肴名称</span></span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pork,beef,chicken,french fries,rice,season fruit,pizza,prawns,salmon</span><br></pre></td></tr></table></figure></p><h3 id="广义的规约汇总"><a href="#广义的规约汇总" class="headerlink" title="广义的规约汇总"></a>广义的规约汇总</h3><p>我们之前讨论的所有收集器，都是一个可以用reducing工厂方法定义的规约过程的特殊情况而已。<br>比如使用reducing方法来计算菜单的总热量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> totalCalories = menu.stream().collect(reducing(<span class="number">0</span>, Dish::getCalories, (i, j) -&gt; i + j));</span><br></pre></td></tr></table></figure></p><p>它需要3个参数：</p><ul><li>第一个参数是规约操作的起始值，也是流中没有元素时的返回值；</li><li>第二个参数是将菜肴转换为一个表示其所含热量的int。</li><li>第三个参数是一个BinaryOpeartor<T>，将2个项目累积成一个同类型的值。在这里是对2个int求和。</li></ul><p>也可以使用下面的单参数的reducing方法来计算菜品的总热量。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Dish&gt; totalCaloriesDish = menu.stream().collect(reducing((d1,d2) -&gt; d1.getCalories() &gt; d2.getCalories() ? d1 : d2));</span><br></pre></td></tr></table></figure></p><p>你可以把单参数的reducing方法看做一个三参数的特殊情况。它把流中的第一个元素作为起点，把恒等函数（即一个函数仅仅返回你参数本身）作为一个转换函数。这也就意味着把单参数的reducing方法传递给一个collect方法，收集器就没有起点，所以会返回一个Optional对象。</p><h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><p>Collectors提供了groupingBy方法来对元素进行分组。</p><p>比如按照类别对菜肴进行分组：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Dish.Type, List&lt;Dish&gt;&gt; byTypeDishes = menu.stream().collect(groupingBy(Dish::getType));</span><br><span class="line">System.out.println(byTypeDishes);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">OTHER=[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;, </span><br><span class="line">       Dish&#123;name=&apos;rice&apos;, vegetarian=true, calories=300, type=OTHER&#125;, </span><br><span class="line">       Dish&#123;name=&apos;season fruit&apos;, vegetarian=true, calories=120, type=OTHER&#125;, </span><br><span class="line">       Dish&#123;name=&apos;pizza&apos;, vegetarian=false, calories=300, type=OTHER&#125;], </span><br><span class="line"></span><br><span class="line">FISH=[Dish&#123;name=&apos;prawns&apos;, vegetarian=false, calories=300, type=FISH&#125;, </span><br><span class="line">      Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;], </span><br><span class="line"></span><br><span class="line">MEAT=[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;, </span><br><span class="line">      Dish&#123;name=&apos;beef&apos;, vegetarian=false, calories=700, type=MEAT&#125;, </span><br><span class="line">      Dish&#123;name=&apos;chicken&apos;, vegetarian=false, calories=400, type=MEAT&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="多级分组"><a href="#多级分组" class="headerlink" title="多级分组"></a>多级分组</h3><p>要实现多级分组，可以使用Collectors.groupingBy的双参数的重载方法，它除了普通的分类函数外，还接受一个collector类型的第2个参数。那么进行二级分组的话，可以把一个内层的groupingBy传递给外层的groupingBy，并定义一个为流中项目分类的二级标准。</p><p>比如按类别和热量等级分组：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义400以下为低热量，700以下为一般，700以上为高热量</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CaloricLevel &#123;DIET, NORMAL, FAT&#125;</span><br><span class="line">大分组为类别，小分组为热量</span><br><span class="line">Map&lt;Dish.Type, Map&lt;CaloricLevel, List&lt;Dish&gt;&gt;&gt; dishesByTypeCaloriesLevel = menu.stream().collect(groupingBy(Dish::getType, groupingBy(dish -&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (dish.getCalories() &lt;= <span class="number">400</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CaloricLevel.DIET;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dish.getCalories() &lt;= <span class="number">700</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> CaloricLevel.NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CaloricLevel.FAT;</span><br><span class="line">&#125;)));</span><br><span class="line">System.out.println(dishesByTypeCaloriesLevel);</span><br></pre></td></tr></table></figure></p><p>输出结果（格式化后）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">OTHER=&#123;</span><br><span class="line">    DIET=[Dish&#123;name=&apos;rice&apos;, vegetarian=true, calories=300, type=OTHER&#125;, </span><br><span class="line">          Dish&#123;name=&apos;season fruit&apos;, vegetarian=true, calories=120, type=OTHER&#125;, </span><br><span class="line">          Dish&#123;name=&apos;pizza&apos;, vegetarian=false, calories=300, type=OTHER&#125;], </span><br><span class="line">    NORMAL=[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;]&#125;, </span><br><span class="line"></span><br><span class="line">FISH=&#123;</span><br><span class="line">    DIET=[Dish&#123;name=&apos;prawns&apos;, vegetarian=false, calories=300, type=FISH&#125;], </span><br><span class="line">    NORMAL=[Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;]&#125;, </span><br><span class="line"></span><br><span class="line">MEAT=&#123;</span><br><span class="line">    DIET=[Dish&#123;name=&apos;chicken&apos;, vegetarian=false, calories=400, type=MEAT&#125;], </span><br><span class="line">    NORMAL=[Dish&#123;name=&apos;beef&apos;, vegetarian=false, calories=700, type=MEAT&#125;], </span><br><span class="line">    FAT=[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="按子组收集数据"><a href="#按子组收集数据" class="headerlink" title="按子组收集数据"></a>按子组收集数据</h3><p>我们把第二个groupingBy传递给外层收集器来实现多级分组，但进一步讲，传递给第一个收集器的第二个收集器可以是任意类型，而不一定是一个groupingBy。<br>比如，要统计菜单中每种菜有多少种，可以传递counting收集器作为groupingBy收集器的第二个收集器。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Dish.Type, Long&gt; typesCount = menu.stream().collect(groupingBy(Dish::getType, counting()));</span><br><span class="line">System.out.println(typesCount);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;OTHER=4, FISH=2, MEAT=3&#125;</span><br></pre></td></tr></table></figure></p><p>再比如，查找每个菜品类型热量最高的菜<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Dish.Type, Optional&lt;Dish&gt;&gt; maxCaloricByType = menu.stream().collect(groupingBy(Dish::getType, maxBy(Comparator.comparingInt(Dish::getCalories))));</span><br><span class="line">System.out.println(maxCaloricByType);</span><br></pre></td></tr></table></figure></p><p>输出结果（格式化后）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">OTHER=Optional[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;], </span><br><span class="line"></span><br><span class="line">FISH=Optional[Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;], </span><br><span class="line"></span><br><span class="line">MEAT=Optional[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="将收集器的结果转换为另一种类型"><a href="#将收集器的结果转换为另一种类型" class="headerlink" title="将收集器的结果转换为另一种类型"></a>将收集器的结果转换为另一种类型</h3><p>分组操作的Map结果中的每个值上包装的Optional没什么用，你可以使用Collectors.collectingAndThen收集器去掉Optional。该方法接收2个参数——要转换的收集器和转换方法，并返回另一个收集器。<br>这个收集器相当于旧收集器的一个包装，collect操作的最后一步就是将返回值用转换方法做一个映射。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">把收集器的结果转换为另一种类型（比如去掉上面的Optional）</span><br><span class="line">Map&lt;Dish.Type, Dish&gt; maxCaloricByTypeDishes = menu.stream()</span><br><span class="line">        .collect(groupingBy(Dish::getType,</span><br><span class="line">                collectingAndThen(</span><br><span class="line">                        maxBy(Comparator.comparingInt(Dish::getCalories)), Optional::get)));</span><br><span class="line">System.out.println(maxCaloricByTypeDishes);</span><br></pre></td></tr></table></figure></p><p>输出结果（格式化后）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">OTHER=Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;, </span><br><span class="line">FISH=Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;, </span><br><span class="line">MEAT=Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;&#125;</span><br><span class="line">``</span><br><span class="line"></span><br><span class="line">### Collectors.mapping</span><br><span class="line">常常和groupingBy一起使用的另一个收集器是mapping方法生成的。它接收2个参数：一个函数对流中的元素做变换，另一个则将变换的结果对象收集起来。其目的是在累加之前对每个输入元素应用一个映射函数，这样就可以让特定类型元素的收集器适应不同类型的对象。</span><br><span class="line"></span><br><span class="line">比如想知道每种类型的Dish中有哪些CaloricLevel。</span><br><span class="line">```java</span><br><span class="line">Map&lt;Dish.Type, Set&lt;CaloricLevel&gt;&gt; byTypeCaloricDishes = menu.stream().collect(groupingBy(Dish::getType, mapping(dish -&gt; &#123;</span><br><span class="line">    if (dish.getCalories() &lt;= 400) &#123;</span><br><span class="line">        return CaloricLevel.DIET;</span><br><span class="line">    &#125; else if (dish.getCalories() &lt;= 700) &#123;</span><br><span class="line">        return CaloricLevel.NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">    return CaloricLevel.FAT;</span><br><span class="line">&#125;, toSet())));</span><br><span class="line">System.out.println(byTypeCaloricDishes);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;OTHER=[DIET, NORMAL], FISH=[DIET, NORMAL], MEAT=[DIET, NORMAL, FAT]&#125;</span><br></pre></td></tr></table></figure></p><h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><p>分区是分组的特殊情况，由一个谓词（返回一个布尔值的函数）作为分类函数，它称分区函数。分区函数返回一个布尔值，则意味着得到的分组Map的键类型是Boolean，于是它最多可以分为2组——true是一组，false是一组。</p><p>比如将菜单按照素食和非素食分开：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.按素菜 OR 荤菜分组</span></span><br><span class="line"><span class="comment">// true表示素菜；false为非素菜</span></span><br><span class="line">Map&lt;Boolean, List&lt;Dish&gt;&gt; partitionedMenu = menu.stream().collect(partitioningBy(Dish::isVegetarian));</span><br><span class="line">System.out.println(partitionedMenu + <span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure></p><p>输出结果（格式化后）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">false=[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;, </span><br><span class="line">       Dish&#123;name=&apos;beef&apos;, vegetarian=false, calories=700, type=MEAT&#125;, </span><br><span class="line">       Dish&#123;name=&apos;chicken&apos;, vegetarian=false, calories=400, type=MEAT&#125;, </span><br><span class="line">       Dish&#123;name=&apos;pizza&apos;, vegetarian=false, calories=300, type=OTHER&#125;, </span><br><span class="line">       Dish&#123;name=&apos;prawns&apos;, vegetarian=false, calories=300, type=FISH&#125;, </span><br><span class="line">       Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;], </span><br><span class="line"></span><br><span class="line">true=[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;, </span><br><span class="line">      Dish&#123;name=&apos;rice&apos;, vegetarian=true, calories=300, type=OTHER&#125;, </span><br><span class="line">      Dish&#123;name=&apos;season fruit&apos;, vegetarian=true, calories=120, type=OTHER&#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="分区的好处"><a href="#分区的好处" class="headerlink" title="分区的好处"></a>分区的好处</h3><p>分区的好处在于分区函数保留了true和false2套流元素列表。比如上面的例子中，要得到素菜列表，使用<code>partitionedMenu.get(true)即可。</code></p><p>partitionBy方法还有一个重载版本，可以传递第2个收集器。</p><p>比如，按是否素菜分区，再根据Type分组：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分区+分组</span></span><br><span class="line"><span class="comment">// 先按是否素菜分区，然后将同类别的菜放到一起</span></span><br><span class="line">Map&lt;Boolean, Map&lt;Dish.Type, List&lt;Dish&gt;&gt;&gt; vegetarianDishesByType = menu.stream().collect(partitioningBy(Dish::isVegetarian, groupingBy(Dish::getType)));</span><br><span class="line">System.out.println(vegetarianDishesByType + <span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure></p><p>输出结果（格式化）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">false=&#123;</span><br><span class="line">    OTHER=[Dish&#123;name=&apos;pizza&apos;, vegetarian=false, calories=300, type=OTHER&#125;], </span><br><span class="line">    FISH=[Dish&#123;name=&apos;prawns&apos;, vegetarian=false, calories=300, type=FISH&#125;, </span><br><span class="line">          Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;], </span><br><span class="line">    MEAT=[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;, </span><br><span class="line">          Dish&#123;name=&apos;beef&apos;, vegetarian=false, calories=700, type=MEAT&#125;, </span><br><span class="line">          Dish&#123;name=&apos;chicken&apos;, vegetarian=false, calories=400, type=MEAT&#125;]&#125;, </span><br><span class="line"></span><br><span class="line">true=&#123;</span><br><span class="line">    OTHER=[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;, </span><br><span class="line">           Dish&#123;name=&apos;rice&apos;, vegetarian=true, calories=300, type=OTHER&#125;, </span><br><span class="line">           Dish&#123;name=&apos;season fruit&apos;, vegetarian=true, calories=120, type=OTHER&#125;]&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>查找素菜和非素菜中热量最高的菜<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 找到素菜和非素菜卡路里含量最高的菜</span></span><br><span class="line">Map&lt;Boolean, Dish&gt; mostCaloricPartitionedByVegetarian =</span><br><span class="line">        menu.stream()</span><br><span class="line">                .collect(partitioningBy(Dish::isVegetarian,</span><br><span class="line">                        collectingAndThen(maxBy(comparingInt(Dish::getCalories)), Optional::get)));</span><br><span class="line">System.out.println(mostCaloricPartitionedByVegetarian + <span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;false=Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;, true=Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>找出素菜和非素菜的数量<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Boolean, Long&gt; partitionedByVegetarianCount = menu.stream().collect(partitioningBy(Dish::isVegetarian, counting()));</span><br><span class="line">System.out.println(partitionedByVegetarianCount + <span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;false=6, true=3&#125;</span><br></pre></td></tr></table></figure></p><p>按是否为素菜分组，找出热量在500以上和500一下的菜<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Boolean, Map&lt;Boolean, List&lt;Dish&gt;&gt;&gt; twoPartitionedDishes = menu.stream().collect(partitioningBy(Dish::isVegetarian, partitioningBy(d -&gt; d.getCalories() &gt; <span class="number">500</span>)));</span><br><span class="line">System.out.println(twoPartitionedDishes + <span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    false=&#123;</span><br><span class="line">        false=[Dish&#123;name=&apos;chicken&apos;, vegetarian=false, calories=400, type=MEAT&#125;, Dish&#123;name=&apos;pizza&apos;, vegetarian=false, calories=300, type=OTHER&#125;, Dish&#123;name=&apos;prawns&apos;, vegetarian=false, calories=300, type=FISH&#125;, Dish&#123;name=&apos;salmon&apos;, vegetarian=false, calories=450, type=FISH&#125;], </span><br><span class="line"></span><br><span class="line">        true=[Dish&#123;name=&apos;pork&apos;, vegetarian=false, calories=800, type=MEAT&#125;, Dish&#123;name=&apos;beef&apos;, vegetarian=false, calories=700, type=MEAT&#125;]</span><br><span class="line">    &#125;, </span><br><span class="line"></span><br><span class="line">    true=&#123;</span><br><span class="line">        false=[Dish&#123;name=&apos;rice&apos;, vegetarian=true, calories=300, type=OTHER&#125;, Dish&#123;name=&apos;season fruit&apos;, vegetarian=true, calories=120, type=OTHER&#125;], </span><br><span class="line">        true=[Dish&#123;name=&apos;french fries&apos;, vegetarian=true, calories=530, type=OTHER&#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>找出给定数字范围内的质数和非质数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;Boolean, List&lt;Integer&gt;&gt; primeNumbers = IntStream.rangeClosed(<span class="number">2</span>, <span class="number">10</span>).boxed().collect(partitioningBy(i -&gt; isPrime(i)));</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPrime</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IntStream.range(<span class="number">2</span>, i).noneMatch(n -&gt; i % n == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Collectors类的静态工厂方法"><a href="#Collectors类的静态工厂方法" class="headerlink" title="Collectors类的静态工厂方法"></a>Collectors类的静态工厂方法</h3><table><thead><tr><th>工厂方法</th><th style="text-align:left">返回类型</th><th style="text-align:left">用于</th></tr></thead><tbody><tr><td>toList</td><td style="text-align:left">List</td><td style="text-align:left">把流中所有项目收集到一个List</td></tr><tr><td>toSet</td><td style="text-align:left">Set</td><td style="text-align:left">把流中所有项目收集到一个Set，删除重复项</td></tr><tr><td>toCollection</td><td style="text-align:left">Collection</td><td style="text-align:left">把流中所有项目收集到给定的供应源创建的集合</td></tr><tr><td>counting</td><td style="text-align:left">Long</td><td style="text-align:left">计算流中元素的个数</td></tr><tr><td>summingInt</td><td style="text-align:left">Integer</td><td style="text-align:left">对流中项目的一个整数属性求和</td></tr><tr><td>averagingInt</td><td style="text-align:left">Double</td><td style="text-align:left">计算流中项目Integer 属性的平均值</td></tr><tr><td>summarizingInt</td><td style="text-align:left">IntSummaryStatistics</td><td style="text-align:left">收集关于流中项目Integer 属性的统计值，例如最大、最小、总和与平均值</td></tr><tr><td>joining`</td><td style="text-align:left">String</td><td style="text-align:left">连接对流中每个项目调用toString 方法所生成的字符串</td></tr><tr><td>maxBy</td><td style="text-align:left">Optional</td><td style="text-align:left">一个包裹了流中按照给定比较器选出的最大元素的Optional，或如果流为空则为Optional.empty()</td></tr><tr><td>minBy</td><td style="text-align:left">Optional</td><td style="text-align:left">一个包裹了流中按照给定比较器选出的最小元素的Optional，或如果流为空则为Optional.empty()</td></tr><tr><td>reducing</td><td style="text-align:left">归约操作产生的类型</td><td style="text-align:left">从一个作为累加器的初始值开始，利用BinaryOperator 与流中的元素逐个结合，从而将流归约为单个值</td></tr><tr><td>collectingAndThen</td><td style="text-align:left">转换函数返回的类型</td><td style="text-align:left">包裹另一个收集器，对其结果应用转换函数</td></tr><tr><td>groupingBy</td><td style="text-align:left">Map&lt;K, List<T>&gt;</td><td style="text-align:left">根据项目的一个属性的值对流中的项目作问组，并将属性值作为结果Map 的键</td></tr><tr><td>partitioningBy</td><td style="text-align:left">Map&lt;Boolean,List<T>&gt;</td><td style="text-align:left">根据对流中每个项目应用谓词的结果来对项进行分区</td></tr></tbody></table><h2 id="收集器接口"><a href="#收集器接口" class="headerlink" title="收集器接口"></a>收集器接口</h2><p>前面已经使用了很多Collector接口实现的收集器，像toList,groupingBy等。</p><p>下面看下Collector接口的定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Collector</span>&lt;<span class="title">T</span>, <span class="title">A</span>, <span class="title">R</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">Supplier&lt;A&gt; <span class="title">supplier</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">BiConsumer&lt;A, T&gt; <span class="title">accumulator</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">BinaryOperator&lt;A&gt; <span class="title">combiner</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Function&lt;A, R&gt; <span class="title">finisher</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">Set&lt;Characteristics&gt; <span class="title">characteristics</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>T是流中要手机的项目的类型。<br>A是累加器的类型，累加器是在收集过程中用于累积部分结果的对象。<br>R是收集操作得到的对象的类型。<br>例如，你可以实现一个ToListCollector<T>类，将Stream<T>中的所有元素收集到List<T>中，它的签名如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ToListCollector</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Collector</span>&lt;<span class="title">T</span>,<span class="title">List</span>&lt;<span class="title">T</span>&gt;,<span class="title">List</span>&lt;<span class="title">T</span>&gt;&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="建立新的结果容器：supplier方法"><a href="#建立新的结果容器：supplier方法" class="headerlink" title="建立新的结果容器：supplier方法"></a>建立新的结果容器：supplier方法</h3><p>supplier方法必须返回一个结果为空的Supplier，也就是一个无参数函数，在调用时它会创建一个空的累加器实例，供数据收集过程使用。</p><h3 id="将元素天剑到结果容器：accumulator方法"><a href="#将元素天剑到结果容器：accumulator方法" class="headerlink" title="将元素天剑到结果容器：accumulator方法"></a>将元素天剑到结果容器：accumulator方法</h3><p>accumulator方法会返回执行规约操作的函数。当遍历到流中第n个元素时，这个函数执行时会有2个参数：保存规约结果的累加器，还有第n个元素本身。</p><h3 id="对结果容器应用最终转换：finisher方法"><a href="#对结果容器应用最终转换：finisher方法" class="headerlink" title="对结果容器应用最终转换：finisher方法"></a>对结果容器应用最终转换：finisher方法</h3><p>在遍历完流后，finisher方法必须返回在累积过程的最后要调用的一个函数，以便将累加器对象转换为整个集合操作的最终结果。</p><h3 id="合并2个结果容器：combiner方法"><a href="#合并2个结果容器：combiner方法" class="headerlink" title="合并2个结果容器：combiner方法"></a>合并2个结果容器：combiner方法</h3><p>combiner方法会返回一个供规约操作使用的函数，它定义了对流的各个部分进行并行处理时，各个子部分规约说的的累加器要如何合并。</p><h3 id="characteristics方法"><a href="#characteristics方法" class="headerlink" title="characteristics方法"></a>characteristics方法</h3><p>characteristics方法会返回一个不可变的Characteristics集合，他定义了收集器的行为，尤其是关于流是否可以并行规约，以及可以使用哪些优化的提示。<br>Characteristics是一个包含三个项目的枚举：</p><ul><li>UNORDERED——规约结果不受流中项目的遍历和累积顺序的影响。</li><li>CONCURRENT——accumulator函数可以从多个线程同时调用，且该收集器可以并行规约流。如果收集器没有标为UNORDERED，那它仅在用于无序数据源时才可进行并行规约。</li><li>IDENTITY_FINISH——这表明完成器方法返回的函数时一个恒等函数，可以跳过。这种情况下，累加器对象会直接用做规约过程的最终结果。这也意味着，将累加器A不加检查的转换为R也是安全的。</li></ul><p>我们开发的ToListCollector是IDENTIFY_FINISHE的，因为用来累积流中元素的List已经是我们要的最终结果，用不着进一步转换了。</p><h3 id="实现自己的收集器"><a href="#实现自己的收集器" class="headerlink" title="实现自己的收集器"></a>实现自己的收集器</h3><p>下面实现一个自己的ToListCollector<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ToListCollector</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Collector</span>&lt;<span class="title">T</span>,<span class="title">List</span>&lt;<span class="title">T</span>&gt;,<span class="title">List</span>&lt;<span class="title">T</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Supplier&lt;List&lt;T&gt;&gt; supplier() &#123; <span class="comment">// 建立新的结果容器</span></span><br><span class="line">        <span class="keyword">return</span> () -&gt; <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BiConsumer&lt;List&lt;T&gt;, T&gt; accumulator() &#123; <span class="comment">// 将元素追加到结果容器</span></span><br><span class="line">        <span class="keyword">return</span> (List,item) -&gt; List.add(item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> BinaryOperator&lt;List&lt;T&gt;&gt; combiner() &#123; <span class="comment">// 合并2个结果容器</span></span><br><span class="line">        <span class="keyword">return</span> (list1,list2) -&gt; &#123;</span><br><span class="line">            list1.addAll(list2);</span><br><span class="line">            <span class="keyword">return</span> list1;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Function&lt;List&lt;T&gt;, List&lt;T&gt;&gt; finisher() &#123; <span class="comment">// 对结果容器进行最终转换</span></span><br><span class="line">        <span class="keyword">return</span> Function.identity();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Characteristics&gt; <span class="title">characteristics</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.unmodifiableSet(EnumSet.of(Characteristics.IDENTITY_FINISH,Characteristics.CONCURRENT));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用自定义的收集器</span></span><br><span class="line">List&lt;Dish&gt; dishes = menu.stream().collect(<span class="keyword">new</span> ToListCollector&lt;Dish&gt;());</span><br></pre></td></tr></table></figure></p><p>参考《java8实战》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8之Stream</title>
      <link href="/2018/09/08/JDK8%E4%B9%8BStream/"/>
      <url>/2018/09/08/JDK8%E4%B9%8BStream/</url>
      
        <content type="html"><![CDATA[<p>本文介绍java 8 Stream API提供的诸多操作，利用这些操作可以让你快速的完成复制的数据查询，如筛选、切片、映射、查找、匹配和规约。包括一些特殊流的用法：数值流、文件流、数组流，无限流。</p><h2 id="筛选和切片"><a href="#筛选和切片" class="headerlink" title="筛选和切片"></a>筛选和切片</h2><h3 id="用谓词筛选"><a href="#用谓词筛选" class="headerlink" title="用谓词筛选"></a>用谓词筛选</h3><p>Stream接口提供了filter方法，该方法接收一个谓词作为参数，并返回一个包含所有符合谓词的元素的流。</p><p>比如，筛选出所有的素菜：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Dish&gt; dishes = menu.stream().filter(Dish::isVegetarian).collect(toList());</span><br></pre></td></tr></table></figure></p><a id="more"></a><h3 id="元素去重"><a href="#元素去重" class="headerlink" title="元素去重"></a>元素去重</h3><p>Stream还支持distinct方法，它会返回不重复的元素的流（根据元素的hashCode和equals方法）。<br>例如，筛选出下面列表中的所有不重复的偶数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>);</span><br><span class="line">numbers.stream()</span><br><span class="line">    .filter(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">    .distinct() <span class="comment">// 根据元素的hashcode和equals方法过滤重复元素</span></span><br></pre></td></tr></table></figure></p><h3 id="截断流"><a href="#截断流" class="headerlink" title="截断流"></a>截断流</h3><p>Stream还支持limit方法，返回一个不超过给定长度的流。所需的长度作为参数传递给limit。如果流是有序的，则最多会返回前n个元素。<br>比如，筛选出热量超过300卡路里的头三道菜：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Dish&gt; highCaloriesTop3 = menu.stream() <span class="comment">// 由菜单得到一个流</span></span><br><span class="line">    .filter(dish -&gt;  dish.getCalories() &gt; <span class="number">300</span>) <span class="comment">// 接收Lambda，从流中排除某些元素</span></span><br><span class="line">    .limit(<span class="number">3</span>) <span class="comment">// 截断流，使元素不超过指定数量</span></span><br><span class="line">    .collect(Collectors.toList()); <span class="comment">// 将流转换为其他形式</span></span><br></pre></td></tr></table></figure></p><h3 id="跳过元素"><a href="#跳过元素" class="headerlink" title="跳过元素"></a>跳过元素</h3><p>Stream还支持skip方法，返回一个扔掉了前n个元素的流。如果流中元素不足n个，则返回空流。<br>比如，找出超过300卡路里的菜，但忽略前2道。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Dish&gt; highCalories = menu.stream()</span><br><span class="line">    .filter(dish -&gt; dish.getCalories() &gt; <span class="number">300</span>)</span><br><span class="line">    .skip(<span class="number">2</span>)</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><h3 id="对流中的每个元素应用函数"><a href="#对流中的每个元素应用函数" class="headerlink" title="对流中的每个元素应用函数"></a>对流中的每个元素应用函数</h3><p>Stream支持map方法，接收一个函数作为参数，会对流中的每个元素应用该函数，并映射为一个新的元素。<br>比如，获取每道菜的名称：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; dishNames = menu.stream().map(Dish::getName).collect(toList());</span><br></pre></td></tr></table></figure></p><h2 id="流的扁平化"><a href="#流的扁平化" class="headerlink" title="流的扁平化"></a>流的扁平化</h2><p>流支持flatMap方法，可以将流中的每个值都转换为一个流，然后把所有的流连接起来形成一个流。</p><p>例1：<br>给定如下单词列表[‘Hello’,’World’]，如何得到不重复的字符？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; strings = Arrays.asList(<span class="string">"Hello"</span>, <span class="string">"World"</span>);</span><br><span class="line"><span class="comment">// Arrays::stream将一个数组转换为一个流</span></span><br><span class="line">List&lt;String&gt; words = strings.stream()</span><br><span class="line">    .map(s -&gt; s.split(<span class="string">""</span>)) <span class="comment">// 得到字符数组</span></span><br><span class="line">    .flatMap(Arrays::stream) <span class="comment">// 将字符数组中的每个元素都换成另外一个流，然后把所有的流连接起来形成一个新的流</span></span><br><span class="line">    .distinct()</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><p>上面如果只是使用map方法，只能得到2个字符数组，而使用flatMap就可以将数组中的每个元素映射为一个流，然后把所有的流合起来形成一个新的流。</p><p>例2：<br>给定2个数字列表，[1,2,3],[4,5]，如何返回所有的数对？[(1,4),(1,5),(2,4),(2,5),(3,4),(3,5)]<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Integer&gt; numList1 = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">List&lt;Integer&gt; numList2 = Arrays.asList(<span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line">List&lt;<span class="keyword">int</span>[]&gt; nums = numList1.stream()</span><br><span class="line">    .flatMap(i -&gt; numList2.stream().map(j -&gt; <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;i, j&#125;))</span><br><span class="line">    .collect(Collectors.toList());</span><br></pre></td></tr></table></figure></p><h2 id="查找和匹配"><a href="#查找和匹配" class="headerlink" title="查找和匹配"></a>查找和匹配</h2><h3 id="查找谓词是否至少匹配一个元素"><a href="#查找谓词是否至少匹配一个元素" class="headerlink" title="查找谓词是否至少匹配一个元素"></a>查找谓词是否至少匹配一个元素</h3><p>使用anyMatch()方法。<br>比如，菜单中是否有素菜？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> isExistVegetarian = menu.stream().anyMatch(d -&gt; d.isVegetarian());</span><br></pre></td></tr></table></figure></p><h3 id="检查谓词是否匹配所有元素"><a href="#检查谓词是否匹配所有元素" class="headerlink" title="检查谓词是否匹配所有元素"></a>检查谓词是否匹配所有元素</h3><p>使用allMatch()方法。</p><p>比如，是否所有的菜卡路由都小于1000？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> allLess1000 = menu.stream().allMatch(d -&gt; d.getCalories() &lt; <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></p><h3 id="检查谓词是否券都不匹配所有元素"><a href="#检查谓词是否券都不匹配所有元素" class="headerlink" title="检查谓词是否券都不匹配所有元素"></a>检查谓词是否券都不匹配所有元素</h3><p>使用noneMatch，与allMatch对应。</p><p>比如，是否是否所欲的菜卡路由都是小于1000？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> allLess1000 = menu.stream().noneMatch(d -&gt; d.getCalories() &gt;= <span class="number">1000</span>);</span><br></pre></td></tr></table></figure></p><h3 id="查找元素"><a href="#查找元素" class="headerlink" title="查找元素"></a>查找元素</h3><p>findAny()方法返回当前流中的任意元素，可以和其他流操作结合使用。</p><p>比如，找一道素菜（随便哪一道）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Optional&lt;Dish&gt; dish = menu.stream().filter(Dish::isVegetarian).findAny();</span><br></pre></td></tr></table></figure></p><p>注意：findAny()返回的是一个Optional<T>。它是一个容器类，代表一个值存在或不存在。用来解决null值问题。</p><p>常用方法如下：</p><ul><li>isPresent<br> 包含值的时候返回true，否则返回false；</li><li>ifPresent(Consumer<T> block)<br> 在存在值时执行给定的代码块。</li><li>get<br> 在存在值时返回值，否则抛出一个NoSuchElement异常</li><li>orElse(T other)<br> 在存在值时返回值，否则返回一个默认值。</li></ul><p>比如，打印一道素菜的名称：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">menu.stream().filter(Dish::isVegetarian).findAny().ifPresent(d -&gt; System.out.println(d.getName()));</span><br><span class="line">```    </span><br><span class="line"></span><br><span class="line">## 规约</span><br><span class="line">### 元素求和</span><br><span class="line">使用<span class="keyword">for</span>-each求和</span><br><span class="line">```java</span><br><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">9</span>);</span><br><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> x:numbers) &#123;</span><br><span class="line">    sum += x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用reduce()方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = numbers.stream().reduct(<span class="number">0</span>,(a,b) -&gt; a+b);</span><br></pre></td></tr></table></figure></p><p>第1个参数：初始值<br>第2个参数：一个BinaryOperator<T> ，将2个元素结合起来产生一个新值。</p><p>求和过程：<br>首先，0作为Lambda的第1个参数(a)，从流中获取到1作为第2个参数，0+1=1，它成为了新的累积值。<br>然后，在用累积值和下一个元素调用Lambda，产生新的累积值3。</p><p><strong>综合示例</strong><br>有如下交易和交易员，计算下面8个问题。<br>交易员<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Trader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Trader</span><span class="params">(String name, String city)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.city = city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Trader&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", city='"</span> + city + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>交易<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Transaction</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Trader trader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> year;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Transaction</span><span class="params">(Trader trader, <span class="keyword">int</span> year,<span class="keyword">int</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">        <span class="keyword">this</span>.year = year;</span><br><span class="line">        <span class="keyword">this</span>.trader = trader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trader <span class="title">getTrader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> trader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getYear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> year;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Transaction&#123;"</span> +</span><br><span class="line">                <span class="string">"trader="</span> + trader +</span><br><span class="line">                <span class="string">", year="</span> + year +</span><br><span class="line">                <span class="string">", value="</span> + value +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">Trader raoul = <span class="keyword">new</span> Trader(<span class="string">"Raoul"</span>,<span class="string">"Cambridge"</span>);</span><br><span class="line">Trader mario = <span class="keyword">new</span> Trader(<span class="string">"Mario"</span>,<span class="string">"Milan"</span>);</span><br><span class="line">Trader alan = <span class="keyword">new</span> Trader(<span class="string">"Alan"</span>,<span class="string">"Cambridge"</span>);</span><br><span class="line">Trader brian = <span class="keyword">new</span> Trader(<span class="string">"Brian"</span>,<span class="string">"Cambridge"</span>);</span><br><span class="line"></span><br><span class="line">List&lt;Transaction&gt; transactions = Arrays.asList(</span><br><span class="line">    <span class="keyword">new</span> Transaction(brian,<span class="number">2011</span>,<span class="number">300</span>),</span><br><span class="line">    <span class="keyword">new</span> Transaction(raoul,<span class="number">2012</span>,<span class="number">1000</span>),</span><br><span class="line">    <span class="keyword">new</span> Transaction(raoul,<span class="number">2011</span>,<span class="number">400</span>),</span><br><span class="line">    <span class="keyword">new</span> Transaction(mario,<span class="number">2012</span>,<span class="number">710</span>),</span><br><span class="line">    <span class="keyword">new</span> Transaction(mario,<span class="number">2011</span>,<span class="number">700</span>),</span><br><span class="line">    <span class="keyword">new</span> Transaction(alan,<span class="number">2012</span>,<span class="number">950</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找出2011年发生的所有交易，并按交易额排序（从低到高）</span></span><br><span class="line">transactions.stream().filter(t -&gt; t.getYear() == <span class="number">2011</span>).sorted(Comparator.comparing(Transaction::getValue)).forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"1.======================="</span>);</span><br><span class="line"><span class="comment">// 交易员都在哪些不同的城市工作过</span></span><br><span class="line">transactions.stream().map(t -&gt; t.getTrader().getCity()).distinct().forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"2.======================="</span>);</span><br><span class="line"><span class="comment">// 查找所有来自剑桥的交易员，并按姓名排序</span></span><br><span class="line">transactions.stream().filter(t -&gt; <span class="string">"Cambridge"</span>.equals(t.getTrader().getCity())).map(t -&gt; t.getTrader().getName()).distinct().sorted().forEach(System.out::println);</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">transactions.stream().map(t -&gt; t.getTrader()).filter(t -&gt; t.getCity().equals(<span class="string">"Cambridge"</span>)).distinct().sorted(Comparator.comparing(Trader::getName)).forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"3.======================="</span>);</span><br><span class="line"><span class="comment">// 返回所有交易员的姓名字符串，按字母顺序排序</span></span><br><span class="line">transactions.stream().map(t -&gt; t.getTrader().getName()).distinct().sorted().forEach(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"4.======================="</span>);</span><br><span class="line"><span class="comment">// 有没有交易员是在米兰工作的</span></span><br><span class="line">transactions.stream().filter(t -&gt; <span class="string">"Milan"</span>.equals(t.getTrader().getCity())).findAny().ifPresent(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"5.======================="</span>);</span><br><span class="line"><span class="comment">// 打印生活在剑桥的交易员的所有交易额</span></span><br><span class="line">transactions.stream().filter(t -&gt; <span class="string">"Cambridge"</span>.equals(t.getTrader().getCity())).map(t -&gt; t.getValue()).reduce(Integer::sum).ifPresent(System.out::println);</span><br><span class="line"><span class="comment">//或 mapToInt转化为int流，然后用IntStream的sum求和</span></span><br><span class="line">transactions.stream().filter(t -&gt; <span class="string">"Cambridge"</span>.equals(t.getTrader().getCity())).mapToInt(Transaction::getValue).sum();</span><br><span class="line">System.out.println(<span class="string">"6.======================="</span>);</span><br><span class="line"><span class="comment">// 所有交易额中，最高的交易额是多少</span></span><br><span class="line">transactions.stream().map(t -&gt; t.getValue()).reduce(Integer::max).ifPresent(System.out::println);</span><br><span class="line">System.out.println(<span class="string">"7.======================="</span>);</span><br><span class="line"><span class="comment">// 找到交易额最少的交易</span></span><br><span class="line">transactions.stream().filter(t -&gt; t.getValue() == transactions.stream().map(a -&gt; a.getValue()).reduce(Integer::min).get()).forEach(System.out::println);</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">transactions.stream().reduce((t1,t2) -&gt; t1.getValue() &lt; t2.getValue() ? t1 : t2).ifPresent(System.out::println);</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">transactions.stream().min(Comparator.comparing(Transaction::getValue)).ifPresent(System.out::println);</span><br></pre></td></tr></table></figure><h2 id="数值流"><a href="#数值流" class="headerlink" title="数值流"></a>数值流</h2><h3 id="原始类型流特化"><a href="#原始类型流特化" class="headerlink" title="原始类型流特化"></a>原始类型流特化</h3><p>在java 8中，引入了3个原始类型特化流接口：IntStream,DoubleStream和LongStream，分别将流中的元素特化为int,double和long，从而避免暗含的装箱（int-&gt;Integer）成本。<br>每个接口都带有常用数值规约的方法，比如对数值就和的sum，找到最大元素的max。<br>还有在必要时将它们转换为流对象的方法。</p><p><strong>映射到数值流</strong><br>将流转换为特化版本的常用方法是mapToInt，mapToDouble和mapToLong。这些方法和前面说的流工作方式一样，只是返回的是一个特化流，而不是Stream<T>。<br>例如，使用mapToInt对菜单中所有菜肴的卡路里求和。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = menu.stream()</span><br><span class="line">    .mapToInt(Dish::getCalories) <span class="comment">// 转换为IntStream&lt;T&gt;</span></span><br><span class="line">    .sum(); <span class="comment">// 使用IntStream&lt;T&gt;提供的sum方法求和。</span></span><br></pre></td></tr></table></figure></p><p><strong>转换到对象流</strong><br>有了数值流，你还可以将数值流转换回对象流。将原始流转换为对象流，可以使用boxed方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IntStream is = menu.stream().mapToInt(Dish::getCalories);</span><br><span class="line">Stream&lt;Integer&gt; s = is.boxed();</span><br></pre></td></tr></table></figure></p><p><strong>OptionalInt</strong><br>IntStream/DoubleStream/LongStream对max、min等计算返回的是OptionalInt/OptionalDouble/OptionalLong。之前说过Optional的用法，这些OptionalXXX用法是一样的。<br>比如，求最大值：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OptionalInt</span></span><br><span class="line">OptionalInt max = transactions.stream().mapToInt(Transaction::getValue).max();</span><br><span class="line">max.ifPresent(System.out::println);</span><br></pre></td></tr></table></figure></p><h3 id="数值范围"><a href="#数值范围" class="headerlink" title="数值范围"></a>数值范围</h3><p>在java 8中，IntStream和LongStream提供了range()和rangeClosed()用于生成一定范围内的数字。range不包括结束值，rangeClosed包括结束值。<br>比如，求1到100有多少个偶数？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IntStream.rangeClosed(<span class="number">1</span>,<span class="number">100</span>).filter(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>).count();</span><br></pre></td></tr></table></figure></p><p><strong>数值流应用：勾股数</strong><br>勾股数满足：a<em>a+b</em>b=c*c，a,b,c均为正数。比如(3,4,5)即为一组有效的勾股数。<br>下面使用IntStream来计算100内的勾股数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">IntStream.rangeClosed(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">    .boxed()</span><br><span class="line">    .flatMap(a -&gt; IntStream.rangeClosed(a,<span class="number">100</span>) <span class="comment">// 从a开始，避免出现重复的数据，比如[3,4,5]和[4,3,5]</span></span><br><span class="line">                           .filter(b -&gt; Math.sqrt(a*a+b*b) % <span class="number">1</span> == <span class="number">0</span>) <span class="comment">// a的平方+b的平方开平方根是整数</span></span><br><span class="line">                           .mapToObj(b -&gt; <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;a,b,(<span class="keyword">int</span>)Math.sqrt(a*a+b*b)&#125;)) <span class="comment">// 返回符合条件的int数组</span></span><br><span class="line">    .forEach(i -&gt; System.out.println(i[<span class="number">0</span>] + <span class="string">","</span> + i[<span class="number">1</span>] + <span class="string">","</span> + i[<span class="number">2</span>]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的方案导致计算了2次平方根，方案2先生成a*a+b*b开平方后的结果，然后再过滤掉不符合要求的数</span></span><br><span class="line">System.out.println(<span class="string">"========方案2==========="</span>);</span><br><span class="line">IntStream.rangeClosed(<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line">    .boxed()</span><br><span class="line">    .flatMap(a -&gt; IntStream.rangeClosed(a,<span class="number">100</span>)</span><br><span class="line">        .mapToObj(b -&gt; <span class="keyword">new</span> <span class="keyword">double</span>[] &#123;a,b,Math.sqrt(a*a+b*b)&#125;))</span><br><span class="line">    .filter(a -&gt; a[<span class="number">2</span>] % <span class="number">1</span> == <span class="number">0</span>)</span><br><span class="line">    .forEach(a -&gt; System.out.println(a[<span class="number">0</span>] + <span class="string">","</span> + a[<span class="number">1</span>] + <span class="string">","</span> + a[<span class="number">2</span>]));</span><br></pre></td></tr></table></figure></p><h2 id="构建流"><a href="#构建流" class="headerlink" title="构建流"></a>构建流</h2><h3 id="由值创建流"><a href="#由值创建流" class="headerlink" title="由值创建流"></a>由值创建流</h3><p>可以使用静态方法Stream.of，来创建一个流，它可以接收任意数量的参数。<br>比如，创建一个字符串流。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream&lt;String&gt; s = Stream.of(<span class="string">"Java 8"</span> ,<span class="string">"Lambda"</span>,<span class="string">"In"</span>,<span class="string">"Action"</span>);</span><br></pre></td></tr></table></figure></p><h3 id="由数组创建流"><a href="#由数组创建流" class="headerlink" title="由数组创建流"></a>由数组创建流</h3><p>可以使用静态方法Arrays.stream来从数组创建一个流，它接收一个数组作为参数。<br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>[] numbers = &#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">3</span>,<span class="number">9</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> sum = Arrays.stream(numbers).sum(); <span class="comment">// 对数组元素求和</span></span><br></pre></td></tr></table></figure></p><h3 id="由文件创建流"><a href="#由文件创建流" class="headerlink" title="由文件创建流"></a>由文件创建流</h3><p>java中用于处理文件等I/O操作的NIO API已更新，以便使用Stream API。java.nio.file.Files中很多静态方法都会返回一个流。<br>比如一个很有用的方法Files.lines，它返回一个由指定文件中各行构成的字符串流。<br>比如：计算文件中有多少个不重复的单词。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由文件生成流</span></span><br><span class="line">String path = TraderDemo.class.getClassLoader().getResource(<span class="string">""</span>).getPath() + <span class="string">"data.txt"</span>;</span><br><span class="line"><span class="comment">// 统计文件中不重复的单词数量</span></span><br><span class="line"><span class="keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Paths.get(path.substring(<span class="number">1</span>)), Charset.forName(<span class="string">"utf-8"</span>)))&#123;</span><br><span class="line">    <span class="keyword">long</span> count = lines.flatMap(line -&gt; Arrays.stream(line.split(<span class="string">" "</span>))).distinct().count();</span><br><span class="line">    System.out.println(<span class="string">"distinct words count:"</span> + count);</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="由函数生成流：创建无限流"><a href="#由函数生成流：创建无限流" class="headerlink" title="由函数生成流：创建无限流"></a>由函数生成流：创建无限流</h3><p>Stream API提供了2个静态方法从函数生成流：iterate和generate，这2个操作可以创建无限流。一般来说，应该使用limit(n)来加以限制，否则会无穷无尽的计算下去。</p><p><strong>iterate</strong><br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从0开始，生成10个数，每个数是前面的数加2</span></span><br><span class="line">Stream.iterate(<span class="number">0</span>,n -&gt; n+<span class="number">2</span>).limit(<span class="number">10</span>).forEach(System.out::println); <span class="comment">// 0,2,4,6,8...</span></span><br></pre></td></tr></table></figure></p><p>iterate方法接收一个初始值（在这里是0），还有一个依次应用在每个产生的新值上的Lambda。</p><p>利用iterate实现斐波那契数列<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 斐波那契数列（0,1,1,2,3,5,8,13,21,34,55...)除最开始的2个数字0和1外，后续的每个数字是前2个数字之和。</span></span><br><span class="line"><span class="comment">// 生成前20个元素(0,1),(1,1),(1,2),(2,3),(3,5),(5,8)...</span></span><br><span class="line">Stream.iterate(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,a -&gt; <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;a[<span class="number">1</span>],a[<span class="number">0</span>] + a[<span class="number">1</span>]&#125;).limit(<span class="number">20</span>).forEach(a -&gt; System.out.println(<span class="string">"("</span> + a[<span class="number">0</span>] + <span class="string">","</span> + a[<span class="number">1</span>] + <span class="string">")"</span>));</span><br><span class="line"><span class="comment">// 只打印数字</span></span><br><span class="line">Stream.iterate(<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>,<span class="number">1</span>&#125;,a-&gt;<span class="keyword">new</span> <span class="keyword">int</span>[]&#123;a[<span class="number">1</span>],a[<span class="number">0</span>]+a[<span class="number">1</span>]&#125;).limit(<span class="number">20</span>).map(a -&gt; a[<span class="number">0</span>]).forEach(System.out::println);</span><br></pre></td></tr></table></figure></p><p><strong>generate</strong><br>与iterate类似，可以生成无限流。但它不是依次对每个新生成的值应用Lambda.</p><p>例如，创建5个随机的0到1的数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stream.generate(Math::random).limit(<span class="number">5</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure></p><p>如果用generate来实现斐波那契数列，则要这么写<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用generate上下行斐波那契数列，不推荐，只是演示</span></span><br><span class="line">IntSupplier fib = <span class="keyword">new</span> IntSupplier() &#123; <span class="comment">// 使用匿名类保存状态（前一项和当前项）</span></span><br><span class="line">    <span class="keyword">int</span> prev = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> curr = <span class="number">1</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAsInt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> oldPrev = prev;</span><br><span class="line">        <span class="keyword">int</span> nextVal = prev + curr;</span><br><span class="line">        prev = curr;</span><br><span class="line">        curr = nextVal;</span><br><span class="line">        <span class="keyword">return</span> oldPrev;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">IntStream.generate(fib).limit(<span class="number">10</span>).forEach(System.out::println);</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8之Lambda</title>
      <link href="/2018/09/06/JDK8%E4%B9%8BLambda/"/>
      <url>/2018/09/06/JDK8%E4%B9%8BLambda/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在开始之前，我们来看一个例子。</p><p>jdk8之前的代码（匿名类）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Apple&gt; appleComparator = <span class="keyword">new</span> Comparator&lt;Apple&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Apple o1, Apple o2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o1.getWeight().compareTo(o2.getWeight());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>Jdk8的代码（Lambda表达式）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Apple&gt; appleComparator1 = (Apple a1,Apple a2) -&gt; a1.getWeight().compareTo(a2.getWeight());</span><br></pre></td></tr></table></figure></p><p>上面2段代码是等价的。<br>一对比，发现使用Lambda表达式的代码真是简洁不少。<br><a id="more"></a></p><h2 id="Lambda表达式的特性"><a href="#Lambda表达式的特性" class="headerlink" title="Lambda表达式的特性"></a>Lambda表达式的特性</h2><ul><li><p>匿名<br>没有像普通函数一样有一个明确的名称。</p></li><li><p>函数<br>和普通方法一样，都有参数列表、函数主体、返回值，还可能有要抛出的异常列表。</p></li><li><p>传递<br>Lambda表达式可以作为参数传递给方法或存储在变量中。</p></li><li><p>简洁<br>无需像匿名类那样写很多模板代码。</p></li></ul><p>在上面的例子中，<code>(Apple a1,Apple a2)</code>中a1,a2即是参数，-&gt;用于区分参数列表和函数主体，<code>a1.getWeight().compareTo(a2.getWeight());</code>则是函数主体，执行结果即是返回值。</p><h2 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h2><p>函数式接口就是只定义一个抽象函数的接口，比如《JDK8行为参数化传递代码》中定义的<code>ApplePredicate</code>即是函数式接口。Runnable、Callable、Comparator都是函数式接口。</p><p>函数式接口是干嘛的？<br>Lambda表达式允许直接以内联的形式为函数式接口的抽象方法提供实现，并把整个表达式作为函数式接口的实例。</p><h2 id="函数描述符"><a href="#函数描述符" class="headerlink" title="函数描述符"></a>函数描述符</h2><p>函数式接口的抽象方法的前面基本上就是Lambda表达式的签名。这种抽象方法叫做函数描述符。例如，Runnable可以看做是一个没有参数也没有返回值的签名。因为它只有一个抽象方法run()，该方法不接受参数，也不返回（void）。<code>（Apple a1,Apple a2) -&gt; int</code>就是一个接收2个Apple对象作为参数，并且返回int的函数。</p><p>只有在使用函数式接口的时候才能使用Lambda表达式。</p><h2 id="使用函数式接口"><a href="#使用函数式接口" class="headerlink" title="使用函数式接口"></a>使用函数式接口</h2><p>函数式接口很有用，因为抽象方法的签名可以描述Lambda表达式的签名。<br>所以，为了应用不同的Lambda表达式，你需要一套能够描述常见函数描述符的函数式接口。<br>在java API中，Runnable、Callable、Comparator都是函数式接口。在java 8中，在java.util.function中还新加了一些新的函数式接口。</p><h3 id="Predicate"><a href="#Predicate" class="headerlink" title="Predicate"></a>Predicate</h3><p>java.util.function.Predicate<T>定义了一个名为test的抽象方法，参数为泛型T对象，并返回一个Boolean。与我们在《JDK8行为参数化传递代码》中定义了ApplePredicate一样，那么现在就可以直接使用它了，无需自己定义了。<br>举例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">filter</span><span class="params">(List&lt;T&gt; list, Predicate&lt;T&gt; p)</span> </span>&#123;</span><br><span class="line">    List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != list &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (T t : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.test(t)) &#123;</span><br><span class="line">                result.add(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; strings = Arrays.asList(<span class="string">"string"</span>, <span class="string">"strings"</span>, <span class="string">"Strings"</span>, <span class="string">"String"</span>, <span class="string">"Str"</span>);</span><br><span class="line">List&lt;String&gt; upperCaseStrings = filter(strings, s -&gt; s.charAt(<span class="number">0</span>) &gt;= <span class="number">65</span> &amp;&amp; s.charAt(<span class="number">0</span>) &lt;= <span class="number">90</span>);</span><br></pre></td></tr></table></figure></p><h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><p>java.util.function.Consumer<T>定义了一个名为accept的抽象方法，参数为泛型T对象，无返回值。<br>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">consumerFilter</span><span class="params">(List&lt;T&gt; list, Consumer&lt;T&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != list &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (T t:list) &#123;</span><br><span class="line">            c.accept(t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;String&gt; strings = Arrays.asList(<span class="string">"string"</span>, <span class="string">"strings"</span>, <span class="string">"Strings"</span>, <span class="string">"String"</span>, <span class="string">"Str"</span>);</span><br><span class="line">consumerFilter(strings,s -&gt; System.out.println(s));</span><br></pre></td></tr></table></figure></p><h3 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h3><p>java.util.function.Funciton<T>定义了一个名为apply的抽象方法，接受泛型T对象，并返回一个R对象。如果你需要定义一个Lambda，将输入对象的信息映射到输出，就可以使用这个接口。<br>举例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T,R&gt; <span class="function">Map&lt;T,R&gt; <span class="title">functionFilter</span><span class="params">(List&lt;T&gt; list, Function&lt;T,R&gt; f)</span> </span>&#123;</span><br><span class="line">    Map&lt;T,R&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != list &amp;&amp; !list.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (T t:list) &#123;</span><br><span class="line">            result.put(t,f.apply(t));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// key=原始字符串，value=字符串长度</span></span><br><span class="line">Map&lt;String,Integer&gt; stringIntegerMap = functionFilter(strings,s -&gt; s.length());</span><br><span class="line">System.out.println(stringIntegerMap);</span><br></pre></td></tr></table></figure></p><h3 id="常用的函数式接口"><a href="#常用的函数式接口" class="headerlink" title="常用的函数式接口"></a>常用的函数式接口</h3><table><thead><tr><th>函数式接口</th><th style="text-align:left">函数描述符</th><th style="text-align:left">原始类型特化</th></tr></thead><tbody><tr><td>Predicate<T></td><td style="text-align:left">T-&gt;boolean</td><td style="text-align:left">IntPredicate,LongPredicate,DoublePredicate</td></tr><tr><td>Consumer<T></td><td style="text-align:left">T-&gt;void</td><td style="text-align:left">IntConsumer,LongConsumer,DoubleConsumer</td></tr><tr><td>Function<T></td><td style="text-align:left">T-&gt;R</td><td style="text-align:left">IntFunction<R>,IntToDoubleFunction,LongFunction<R>,IntToLongFunction,<br>LongToIntFunction,DoubleFunction<R>,ToIntFunction<T>,<br>ToDoubleFunction<T>,ToLongFunction<T></td></tr><tr><td>Supplier<T></td><td style="text-align:left">()-&gt;T</td><td style="text-align:left">BooleanSupplier,IntSupplier,LongSupplier,DoubleSupplier</td></tr><tr><td>BiPredicate&lt;L,R&gt;</td><td style="text-align:left">(L,R)-&gt;boolean</td><td style="text-align:left"></td></tr><tr><td>BiConsumer&lt;T,U&gt;</td><td style="text-align:left">(T,U)-&gt;void</td><td style="text-align:left">ObjIntConsumer<T>,ObjLongConsumer<T>,ObjDoubleConsumer<T></td></tr><tr><td>BiFunction&lt;T,U,R&gt;</td><td style="text-align:left">(T,U)-&gt;R</td><td style="text-align:left">ToIntBiFunction&lt;T,U&gt;,ToLongBiFunction&lt;T,U&gt;,ToDoubleBiFunction&lt;T,U&gt;                           </td></tr><tr><td>BinaryOperator<T></td><td style="text-align:left">(T,T)-&gt;T</td><td style="text-align:left">IntBinaryOperator,LongBinaryOperator,DoubleBinaryOperator</td></tr><tr><td>UnaryOperator<T></td><td style="text-align:left">T-&gt;T</td><td style="text-align:left">IntUnaryOperator,LongUnaryOperator,DoubleUnaryOperator     </td></tr></tbody></table><h2 id="类型检查、类型推断和限制"><a href="#类型检查、类型推断和限制" class="headerlink" title="类型检查、类型推断和限制"></a>类型检查、类型推断和限制</h2><h3 id="类型检查"><a href="#类型检查" class="headerlink" title="类型检查"></a>类型检查</h3><p>Lambda表达式的类型是从使用Lambda的上下文推断出来的。上下文即为接受它传递的方法的参数或接受它的值的局部变量。上下文中Lambda表达式需要的类型为目标类型。<br>从调用的filter方法的参数找到函数式接口，由于每个函数式接口都只能有一个抽象方法，所以类型就都确定了。</p><h3 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h3><p>通过<code>类型检查</code>我们可以知道函数描述符，所以就可以推断出lambda的签名，这样java编译器就可以推断出lambda表达式的参数类型，这样就可以在lambda表达式中省略参数类型了。<br>所以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; greenApples = filter(apples,(Apple a) -&gt; &quot;green&quot;.equals(a.getColor()));</span><br></pre></td></tr></table></figure></p><p>可以简化为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; greenApples = filter(apples,a -&gt; &quot;green&quot;.equals(a.getColor()));</span><br></pre></td></tr></table></figure></p><p>但有时候显示的写出参数类型更易读，有时候去掉则更易读。需要根据实际情况作出选择。</p><h2 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h2><p>方法引用可以让你重复的使用现有的方法定义，并像Lambda一样传递它们。有些情况下，比Lambda更易读。</p><p>当你需要使用方法引用时，目标引用放在分隔符::前，方法的名称放在后面。比如Apple::getWeight就是引用了Apple类中定义的getWeight方法。但是，注意不需要括号，因为你还没有实际调用这个方法。方法引用时Lambda表达式的快捷写法。</p><p><strong>Lambda和等效的方法引用的例子</strong></p><table><thead><tr><th>函数式接口</th><th style="text-align:left">函数描述符</th></tr></thead><tbody><tr><td>(Apple a) -&gt; a.getWeight()</td><td style="text-align:left">Apple::getWeight</td></tr><tr><td>(str,i) -&gt; str.substring(i)</td><td style="text-align:left">String::substring</td></tr><tr><td>(String s) -&gt; System.out.println(s)</td><td style="text-align:left">System.out::println</td></tr><tr><td>() -&gt; Thread.currentThread().dumpStack()</td><td style="text-align:left">Thread.currentThread::dumpStack</td></tr></tbody></table><h2 id="复合Lambda表达式的有用方法"><a href="#复合Lambda表达式的有用方法" class="headerlink" title="复合Lambda表达式的有用方法"></a>复合Lambda表达式的有用方法</h2><p>许多函数式接口，比如Predicate、Function、Comparator都提供了进行复合的方法。这样你就可以将多个简单的Lambda表达式复合成更复杂的表达式。</p><h3 id="比较器复合"><a href="#比较器复合" class="headerlink" title="比较器复合"></a>比较器复合</h3><p>有如下Comparator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Apple&gt; c = Comparator.comparing(Apple::getWeight);</span><br></pre></td></tr></table></figure></p><p><strong>1.逆序</strong><br>现在想逆序显示呢？<br>你不用再重新创建一个Comparator，因为Comparator提供了一个默认方法reverse()可以使给定的Comparator逆序。<br>因此，结合前面的Comparator即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apples.sort(comparing(Apple::getWeight).reversed());</span><br></pre></td></tr></table></figure></p><p><strong>2.比较器链</strong><br>在上面的例子中，如果要比较的2个苹果的重量一样，那么哪个苹果应该排在前面呢？你可能需要再提供一个Comparator来进一步比较。比如，先根据重量排序，如果重量一样则再根据国家排序。<br>这个时候，Comparator中的thenComparing()方法就派上用场了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Comparator&lt;Apple&gt; comparator = Comparator.comparing(Apple::getWeight);</span><br><span class="line">apples.sort(comparator.reversed().thenComparing(Apple::getCountry));</span><br></pre></td></tr></table></figure></p><h3 id="谓词复合"><a href="#谓词复合" class="headerlink" title="谓词复合"></a>谓词复合</h3><p>谓词接口包括三个方法：negate、add和or，让你可以重用已有的Predicate来创建更复杂的谓词。<br>比如有如下谓词：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 红苹果</span></span><br><span class="line">Predicate&lt;Apple&gt; redApplePredicate = (Apple apple) -&gt; <span class="string">"red"</span>.equals(apple.getColor());</span><br><span class="line"><span class="comment">// 不是红色的苹果</span></span><br><span class="line">Predicate&lt;Apple&gt; nonRediApplePredicate = redApplePredicate.negate();</span><br></pre></td></tr></table></figure></p><p>使用add()方法来创建一个既是红色又是一个重的苹果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 红苹果</span></span><br><span class="line">Predicate&lt;Apple&gt; redApplePredicate = (Apple apple) -&gt; <span class="string">"red"</span>.equals(apple.getColor());</span><br><span class="line">Predicate&lt;Apple&gt; redAndWeightPredicate = redApplePredicate.and((Apple a) -&gt; a.getWeight() &gt; <span class="number">150</span>);</span><br></pre></td></tr></table></figure></p><p>使用or()方法来创建一个150克以上的红苹果，或是绿苹果。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 红苹果</span></span><br><span class="line">Predicate&lt;Apple&gt; redApplePredicate = (Apple apple) -&gt; <span class="string">"red"</span>.equals(apple.getColor());</span><br><span class="line">Predicate&lt;Apple&gt; redAndHeavyApplesOrGreen = redApplePredicate.and((Apple a) -&gt; a.getWeight() &gt; <span class="number">150</span>).or((Apple a) -&gt; <span class="string">"green"</span>.equals(a.getColor()));</span><br></pre></td></tr></table></figure></p><h3 id="函数复合"><a href="#函数复合" class="headerlink" title="函数复合"></a>函数复合</h3><p>你还可以将Function接口所代表的Lambda表达式复合起来。Function接口提供了addThen和compose2个默认方法，它们都会返回Function的一个实例。</p><p>比如，有一个函数f，给数字加1，另一个函数g给数字乘以2.你可以将它们组合成一个函数h，先给数字加1，再将结果乘以2.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;Integer,Integer&gt; f = x -&gt; x+<span class="number">1</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt; g = x -&gt; x*<span class="number">2</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt; h = f.andThen(g);</span><br><span class="line"><span class="keyword">int</span> result = h.apply(<span class="number">1</span>);</span><br><span class="line">System.out.println(result); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure></p><p>使用compose，先把给定的函数用作compose的参数里面的那个函数，然后再把函数本身用于结果。比如上面的例子使用compose的话，就是f(g(x))，而addThen则是g(f(x))。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;Integer,Integer&gt; f = x -&gt; x+<span class="number">1</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt; g = x -&gt; x*<span class="number">2</span>;</span><br><span class="line">Function&lt;Integer,Integer&gt;h = f.compose(g);</span><br><span class="line">System.out.println(h.apply(<span class="number">1</span>)); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8行为参数化传递代码</title>
      <link href="/2018/09/06/JDK8%E8%A1%8C%E4%B8%BA%E5%8F%82%E6%95%B0%E5%8C%96%E4%BC%A0%E9%80%92%E4%BB%A3%E7%A0%81/"/>
      <url>/2018/09/06/JDK8%E8%A1%8C%E4%B8%BA%E5%8F%82%E6%95%B0%E5%8C%96%E4%BC%A0%E9%80%92%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<p>在软件开发中，需求总是不断变化的，在这里介绍使用行为参数化传递代码来应对不断变化的需求。</p><h2 id="版本1：要求筛选出颜色为绿色的苹果"><a href="#版本1：要求筛选出颜色为绿色的苹果" class="headerlink" title="版本1：要求筛选出颜色为绿色的苹果"></a>版本1：要求筛选出颜色为绿色的苹果</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Apple</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String color;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> weight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Apple</span><span class="params">(String color, <span class="keyword">double</span> weight)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.color = color;</span><br><span class="line">        <span class="keyword">this</span>.weight = weight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter/settter...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Apple&#123;"</span> +</span><br><span class="line">                <span class="string">"color='"</span> + color + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", weight="</span> + weight +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>按照jdk8之前的代码，写法大致如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterByColor</span><span class="params">(List&lt;Apple&gt; apples)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != apples &amp;&amp; !apples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span>(Apple apple:apples) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"green"</span>.equals(apple.getColor())) &#123;</span><br><span class="line">                result.add(apple);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>假定现在想根据颜色查找苹果，不限定绿色。</p><h2 id="版本2：查找指定颜色的苹果："><a href="#版本2：查找指定颜色的苹果：" class="headerlink" title="版本2：查找指定颜色的苹果："></a>版本2：查找指定颜色的苹果：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterByColor</span><span class="params">(List&lt;Apple&gt; apples,String color)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != apples &amp;&amp; !apples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span>(Apple apple:apples) &#123;</span><br><span class="line">            <span class="keyword">if</span> (color.equals(apple.getColor())) &#123;</span><br><span class="line">                result.add(apple);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将颜色当做参数即可。</p><p>那么，如果要按照重量来筛选呢？</p><h2 id="版本3：查找重苹果"><a href="#版本3：查找重苹果" class="headerlink" title="版本3：查找重苹果"></a>版本3：查找重苹果</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterByColor</span><span class="params">(List&lt;Apple&gt; apples)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != apples &amp;&amp; !apples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span>(Apple apple:apples) &#123;</span><br><span class="line">            <span class="keyword">if</span> (apple.getWeight() &gt; <span class="number">150</span>) &#123;</span><br><span class="line">                result.add(apple);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后面可能会有其他需求，比如查找重量超过300G的红苹果等等需求。<br>此时，你会发现根据颜色查找和根据重量来查找仅仅1行代码不同，其余部分均相同。也就是说好多代码都重复了。<br>那么有没有一种方法来应对这种不断变动的需求，减少重复代码呢？</p><h2 id="版本4：使用策略模式"><a href="#版本4：使用策略模式" class="headerlink" title="版本4：使用策略模式"></a>版本4：使用策略模式</h2><p>那么，如果熟悉设计模式，可以想到使用策略模式。每次变动的不过是筛选苹果的策略不同。</p><p>我们将选择逻辑抽象出一个接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ApplePredicate</span>&lt;<span class="title">Apple</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple t)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>绿苹果的策略：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GreenApplePredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span>&lt;<span class="title">Apple</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"green"</span>.equals(t.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重苹果的策略：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeightApplePredicate</span> <span class="keyword">implements</span> <span class="title">ApplePredicate</span>&lt;<span class="title">Apple</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>筛选苹果的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterByCondition</span><span class="params">(List&lt;Apple&gt; apples,ApplePredicate&lt;Apple&gt; p)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">null</span> != apples &amp;&amp; !apples.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span>(Apple apple:apples) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.test(apple)) &#123;</span><br><span class="line">                result.add(apple);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 筛选绿色苹果</span></span><br><span class="line">List&lt;Apple&gt; greenApples = filterByCondition(apples,<span class="keyword">new</span> GreenApplePredicate();</span><br><span class="line"><span class="comment">// 筛选重的苹果</span></span><br><span class="line">List&lt;Apple&gt; heavyApples = filterByCondition(apples,<span class="keyword">new</span> WeightApplePredicate();</span><br></pre></td></tr></table></figure></p><p>如果要筛选出其他条件的苹果，我们就新建一个ApplePredicate的实现类即可。比如要筛选出红色且重量在150克以上的苹果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public class WeightAndRedApplePredicate implements ApplePredicate&lt;Apple&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public boolean test(Apple t) &#123;</span><br><span class="line">        return &quot;red&quot;.equals(t.getColor()) &amp;&amp; t.getWeight() &gt; 150;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 使用：</span><br><span class="line">List&lt;Apple&gt; redAndHeavyApples = filterByCondition(apples,new WeightAndRedApplePredicate());</span><br></pre></td></tr></table></figure></p><p>参数行为化的好处是：你可以把要迭代筛选的逻辑和集合中每个元素的应用的行为分开。这样你可以重复使用一个方法，给它不同的行为来达到不同的目的。</p><h2 id="版本5：使用匿名类"><a href="#版本5：使用匿名类" class="headerlink" title="版本5：使用匿名类"></a>版本5：使用匿名类</h2><p>虽然通过模板策略，我们将苹果筛选的逻辑和迭代的逻辑分开了，但是每次都需要新建一个筛选策略也是很麻烦的。熟悉GUI事件处理的可能知道，我们可以使用匿名类来创建不同的策略对象。<br><strong>绿色的苹果</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; greenApples = filterByCondition(apples, <span class="keyword">new</span> ApplePredicate&lt;Apple&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"green"</span>.equals(t.getColor());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p><strong>重苹果</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; greenApples = filterByCondition(apples, <span class="keyword">new</span> ApplePredicate&lt;Apple&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">test</span><span class="params">(Apple t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> t.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>很快，你就发现，使用匿名类还是不够好。我们对比绿苹果和重苹果的代码，发现就一行代码不同。那么有没有版本传递给filterByCondition方法的只有真正的逻辑代码？</p><h2 id="版本6："><a href="#版本6：" class="headerlink" title="版本6："></a>版本6：</h2><p>java8提供行为参数化的支持，它允许你定义一个代码块来表示一个行为，然后作为参数去传递它。<br>我们使用java8的lambda来实现上面的逻辑。<br><strong>绿苹果</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; greenApples = filterByCondition(apples,(Apple apple) -&gt; <span class="string">"green"</span>.equals(apple.getColor()));</span><br></pre></td></tr></table></figure></p><p><strong>重苹果</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; heavyApples = filterByCondition(apples,(Apple apple) -&gt; apple.getWeight() &gt; <span class="number">150</span>);</span><br></pre></td></tr></table></figure></p><p>一行代码即搞定！</p><p>还可以将lambda表达式的参数去掉。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Apple&gt; heavyApples = filterByCondition(apples,apple -&gt; apple.getWeight() &gt; <span class="number">150</span>);</span><br></pre></td></tr></table></figure></p><p>这样后面不论要怎么筛选苹果，我们改lambda表达式即可。</p><p>注：文中例子参考《Java8实战》。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK8中新增的LongAdder</title>
      <link href="/2018/09/04/JDK8%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84LongAdder/"/>
      <url>/2018/09/04/JDK8%E4%B8%AD%E6%96%B0%E5%A2%9E%E7%9A%84LongAdder/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在JDK1.5开始就新增了并发的Integer/Long的操作工具类AtomicInteger和AtomicLong。在JDK8中又新增了LongAdder，这是一个针对Long类型的数据的操作工具类。<br>那么既然已经有了AtomicLong，为何又要新增LongAdder这么一个类呢？</p><h2 id="LongAdder的实现原理"><a href="#LongAdder的实现原理" class="headerlink" title="LongAdder的实现原理"></a>LongAdder的实现原理</h2><p>我们知道，AtomicLong的实现原理是：利用底层操作系统的CAS来保证原子性，在一个死循环内不断执行CAS操作，直到操作成功。不过，CAS操作的一个问题是在并发量比较大的时候，可能很多次的执行CAS操作都不成功，这样性能就受到较大影响。<br>那我们知道，在ConcurrentHashMap中，对Map分割成多个segment，这样多个Segment的操作就可以并行执行，从而可以提高性能。在JDK8中，LongAdder与ConcurrentHashMap类似，将内部操作数据value分离成一个Cell数组，每个线程访问时，通过Hash等算法映射到其中一个Cell上。<br>计算最终的数据结果，则是各个Cell数组的累计求和。</p><h2 id="LongAdder提供的方法"><a href="#LongAdder提供的方法" class="headerlink" title="LongAdder提供的方法"></a>LongAdder提供的方法</h2><p><img src="http://omh46px9n.bkt.clouddn.com/18-9-4/94630123.jpg" alt=""></p><ul><li>add()：增加指定的数值；</li><li>increament()：增加1；</li><li>decrement()：减少1；</li><li>intValue()/floatValue()/doubleValue()：得到最终计数后的结果</li><li>sum()：求和，得到最终计数结果</li><li>sumThenReset()：求和得到最终计数结果，并重置value。</li></ul><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongAdderTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> java.util.concurrent.atomic.LongAdder count = <span class="keyword">new</span> LongAdder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AddThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">                count.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AddThread());</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> AddThread());</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(count.intValue() == <span class="number">200000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>在并发较低时LongAdder使用casBase()方法直接修改value，以达到和AtomicLong基本相当的性能；在并发较高时，自动拆分为Cell数组，并自动扩容，分散热点，以保证性能。</p><p>LongAdder原理分析：<a href="https://blog.csdn.net/u011392897/article/details/60480108">https://blog.csdn.net/u011392897/article/details/60480108</a></p><p>LongAdder与AtomicLong性能对比测试：<a href="https://blog.csdn.net/li396864285/article/details/78246357">https://blog.csdn.net/li396864285/article/details/78246357</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java7 ForkJoin框架详解</title>
      <link href="/2018/08/30/Java7%20ForkJoin%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3/"/>
      <url>/2018/08/30/Java7%20ForkJoin%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3/</url>
      
        <content type="html"><![CDATA[<a id="more"></a><p>Fork/Join框架是Java 7提供的一个用于并行执行任务的框架，是一个把大任务分割成若干个小任务，最终汇总每个小任务结果后得到大任务结果的框架。Fork/Join框架要完成两件事情：</p><p>　　1.任务分割：首先Fork/Join框架需要把大的任务分割成足够小的子任务，如果子任务比较大的话还要对子任务进行继续分割</p><p>　　2.执行任务并合并结果：分割的子任务分别放到双端队列里，然后几个启动线程分别从双端队列里获取任务执行。子任务执行完的结果都放在另外一个队列里，启动一个线程从队列里取数据，然后合并这些数据。</p><p>　　在Java的Fork/Join框架中，使用两个类完成上述操作</p><p>　　1.ForkJoinTask:我们要使用Fork/Join框架，首先需要创建一个ForkJoin任务。该类提供了在任务中执行fork和join的机制。通常情况下我们不需要直接集成ForkJoinTask类，只需要继承它的子类，Fork/Join框架提供了两个子类：</p><p>　　　　a.RecursiveAction：用于没有返回结果的任务</p><p>　　　　b.RecursiveTask:用于有返回结果的任务</p><p>　　2.ForkJoinPool:ForkJoinTask需要通过ForkJoinPool来执行</p><p>　　任务分割出的子任务会添加到当前工作线程所维护的双端队列中，进入队列的头部。当一个工作线程的队列里暂时没有任务时，它会随机从其他工作线程的队列的尾部获取一个任务(工作窃取算法)。</p><p>Fork/Join框架的实现原理</p><p>　　ForkJoinPool由ForkJoinTask数组和ForkJoinWorkerThread数组组成，ForkJoinTask数组负责将存放程序提交给ForkJoinPool，而ForkJoinWorkerThread负责执行这些任务。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Fork/Join是jdk7新增的并行计算框架，采用工作窃取算法，将一个大的任务拆分为多个小的任务，最终汇总各个小的任务的计算结果。</span></span><br><span class="line"><span class="comment"> * 比如计算1-100之类数字相加的和，假定阀值为30（即开始位置和结束位置相减&lt;=30即可进行计算），如果&gt;30则进行拆分。</span></span><br><span class="line"><span class="comment"> * 计算过程如下：</span></span><br><span class="line"><span class="comment"> * 拆分为1-50,51-100</span></span><br><span class="line"><span class="comment"> * 1-50拆分为1-25,26-50</span></span><br><span class="line"><span class="comment"> * 51-100拆分为51-75,76-100</span></span><br><span class="line"><span class="comment"> * 计算1-25的和，计算26-50的和==》合并为结果1</span></span><br><span class="line"><span class="comment"> * 计算51-75的和，计算76-100的和==》合并为结果2</span></span><br><span class="line"><span class="comment"> * 合并结果1，2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Donny</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/08/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormJoinDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ComputeTask</span> <span class="keyword">extends</span> <span class="title">RecursiveTask</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> THREAD_HOLD = <span class="number">100</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span>[] data;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> start;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> end;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ComputeTask</span><span class="params">(<span class="keyword">int</span>[] data, <span class="keyword">int</span> start, <span class="keyword">int</span> end)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.data = data;</span><br><span class="line">            <span class="keyword">this</span>.start = start;</span><br><span class="line">            <span class="keyword">this</span>.end = end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Long <span class="title">compute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Long sum = <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果任务足够小，那么直接计算</span></span><br><span class="line">            <span class="keyword">if</span> (end - start &lt;= THREAD_HOLD) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) &#123;</span><br><span class="line">                    sum += data[i];</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                System.out.println(String.format(<span class="string">"Compute %d ~ %d = %d"</span>, start, end, sum));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果任务过大，则一分为二</span></span><br><span class="line">                <span class="keyword">int</span> middle = (end + start) / <span class="number">2</span>;</span><br><span class="line">                System.out.println(String.format(<span class="string">"Split %d~%d ==&gt; %d~%d,%d~%d"</span>, start, end, start, middle, middle + <span class="number">1</span>, end));</span><br><span class="line">                ComputeTask left = <span class="keyword">new</span> ComputeTask(data, start, middle);</span><br><span class="line">                ComputeTask right = <span class="keyword">new</span> ComputeTask(data, middle + <span class="number">1</span>, end);</span><br><span class="line">                invokeAll(left, right);<span class="comment">// 注意：这里使用invokeAll，而不要使用left.fork()和right.fork()</span></span><br><span class="line"></span><br><span class="line">                Long leftSum = left.join();</span><br><span class="line">                Long rightSum = right.join();</span><br><span class="line">                sum = leftSum + rightSum;</span><br><span class="line">                System.out.println(String.format(<span class="string">"Result = %d + %d ==&gt; %d"</span>, leftSum, rightSum, sum));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ForkJoinPool pool = <span class="keyword">new</span> ForkJoinPool();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span>[] data = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1000</span>];</span><br><span class="line">        fillData(data);</span><br><span class="line">        Long sum = pool.invoke(<span class="keyword">new</span> ComputeTask(data, <span class="number">0</span>, data.length));</span><br><span class="line">        System.out.println(<span class="string">"Fork/join sum:"</span> + sum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fillData</span><span class="params">(<span class="keyword">int</span>[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">            data[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>上面的代码使用Fork/Join框架来计算一个元素个数为1000的数组的和。</p><p>执行结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Split 0~1000 ==&gt; 0~500,501~1000</span><br><span class="line">Split 501~1000 ==&gt; 501~750,751~1000</span><br><span class="line">Split 0~500 ==&gt; 0~250,251~500</span><br><span class="line">Split 501~750 ==&gt; 501~625,626~750</span><br><span class="line">Split 0~250 ==&gt; 0~125,126~250</span><br><span class="line">Compute 0 ~ 125 = 7750</span><br><span class="line">Compute 126 ~ 250 = 23250</span><br><span class="line">Result = 7750 + 23250 ==&gt; 31000</span><br><span class="line">Split 251~500 ==&gt; 251~375,376~500</span><br><span class="line">Compute 251 ~ 375 = 38750</span><br><span class="line">Compute 376 ~ 500 = 54250</span><br><span class="line">Result = 38750 + 54250 ==&gt; 93000</span><br><span class="line">Result = 31000 + 93000 ==&gt; 124000</span><br><span class="line">Split 751~1000 ==&gt; 751~875,876~1000</span><br><span class="line">Compute 751 ~ 875 = 100750</span><br><span class="line">Compute 876 ~ 1000 = 116250</span><br><span class="line">Result = 100750 + 116250 ==&gt; 217000</span><br><span class="line">Compute 626 ~ 750 = 85250</span><br><span class="line">Compute 501 ~ 625 = 69750</span><br><span class="line">Result = 69750 + 85250 ==&gt; 155000</span><br><span class="line">Result = 155000 + 217000 ==&gt; 372000</span><br><span class="line">Result = 124000 + 372000 ==&gt; 496000</span><br><span class="line">Fork/join sum:496000</span><br></pre></td></tr></table></figure></p><p>这里要注意的是：在拆分任务时不要调用fork()方法将任务推给别的线程执行，而使用invokeAll()。</p><p>这是因为执行compute()方法的线程本身也是一个Worker线程，当对两个子任务调用fork()时，这个Worker线程就会把任务分配给另外两个Worker，但是它自己却停下来等待不干活了！这样就白白浪费了Fork/Join线程池中的一个Worker线程</p><p>原因参考：<a href="https://www.liaoxuefeng.com/article/001493522711597674607c7f4f346628a76145477e2ff82000">https://www.liaoxuefeng.com/article/001493522711597674607c7f4f346628a76145477e2ff82000</a></p><p>Fork/Join实现介绍：<a href="https://blog.csdn.net/yinwenjie/article/details/71524140">https://blog.csdn.net/yinwenjie/article/details/71524140</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper客户端curator使用</title>
      <link href="/2018/07/28/zookeeper%E5%AE%A2%E6%88%B7%E7%AB%AFcurator%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/07/28/zookeeper%E5%AE%A2%E6%88%B7%E7%AB%AFcurator%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="curator简介"><a href="#curator简介" class="headerlink" title="curator简介"></a>curator简介</h2><p>curator是Netflix开源的一个zookeeper客户端，在原生API接口上进行了包装，解决了很多ZooKeeper客户端非常底层的细节开发。同时内部实现了诸如Session超时重连，Watcher反复注册、分布式计数器、分布式锁等功能，实现了Fluent风格的API接口，是使用最广泛的zookeeper客户端之一。Curator使用的链式编程风格。如果只需要zookeeper连接管理和重试功能可以只引入curator-framework。</p><p>官网地址：<a href="http://curator.apache.org/">http://curator.apache.org/</a></p><p>curator包含下面几个模块，对于大多数人来说引入<code>curator-recipes</code>即可。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-28/33085806.jpg" alt=""></p><p><strong>兼容性</strong><br>Apache Curator旨在与ZooKeeper 3.5+一起使用。 但是，它也与ZooKeeper 3.4.x兼容。<br>详情：<a href="http://curator.apache.org/zk-compatibility.html">http://curator.apache.org/zk-compatibility.html</a></p><h2 id="curator基本使用"><a href="#curator基本使用" class="headerlink" title="curator基本使用"></a>curator基本使用</h2><h3 id="curator依赖"><a href="#curator依赖" class="headerlink" title="curator依赖"></a>curator依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我这里版本比较低，官网版本已经到3.5+了。</p><h3 id="创建连接"><a href="#创建连接" class="headerlink" title="创建连接"></a>创建连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重试策略，重试间隔时间为1秒，重试次数为10次。curator管理了zookeeper的连接，在操作zookeeper的过程中出现连接问题会自动重试。</span></span><br><span class="line">RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>,<span class="number">10</span>);</span><br><span class="line"><span class="comment">// 通过工厂创建连接</span></span><br><span class="line">CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">        .connectString(ZOOKEEPER_ADDRESS) <span class="comment">// zookeeper地址</span></span><br><span class="line">        .retryPolicy(retryPolicy) <span class="comment">// 重试策略</span></span><br><span class="line">        .connectionTimeoutMs(<span class="number">15000</span>) <span class="comment">// 连接超时时间，默认15秒</span></span><br><span class="line">        .sessionTimeoutMs(<span class="number">5000</span>) <span class="comment">// 会话超时时间ms，默认60秒</span></span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// 打开连接</span></span><br><span class="line">cf.start();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"state:"</span> + cf.getState());</span><br></pre></td></tr></table></figure><p>也可以这样创建：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CuratorFramework cf = CuratorFrameworkFactory.newClient(ZOOKEEPER_ADDRESS,<span class="number">5000</span>,<span class="number">15000</span>,retryPolicy);</span><br></pre></td></tr></table></figure></p><h3 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cf.create()</span><br><span class="line">    .creatingParentsIfNeeded() <span class="comment">// 自动创建父节点</span></span><br><span class="line">    .withMode(CreateMode.PERSISTENT) <span class="comment">// 模式：持久/临时/有序/无序</span></span><br><span class="line">    .forPath(<span class="string">"/lock/ms10000"</span>,<span class="string">"10000"</span>.getBytes()); <span class="comment">// 指定路径和数据</span></span><br></pre></td></tr></table></figure><h3 id="检查节点是否存在"><a href="#检查节点是否存在" class="headerlink" title="检查节点是否存在"></a>检查节点是否存在</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Stat stat = cf.checkExists().forPath(<span class="string">"/lock/ms10000"</span>);</span><br></pre></td></tr></table></figure><h3 id="获取节点数据"><a href="#获取节点数据" class="headerlink" title="获取节点数据"></a>获取节点数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String nodeData = <span class="keyword">new</span> String(cf.getData().forPath(<span class="string">"/lock/ms10000"</span>));</span><br></pre></td></tr></table></figure><h3 id="修改节点数据"><a href="#修改节点数据" class="headerlink" title="修改节点数据"></a>修改节点数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cf.setData().forPath(<span class="string">"/lock/ms10000"</span>,<span class="string">"ms-10001"</span>.getBytes());</span><br></pre></td></tr></table></figure><h3 id="获取子节点"><a href="#获取子节点" class="headerlink" title="获取子节点"></a>获取子节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; nodes = cf.getChildren().forPath(<span class="string">"/lock"</span>);</span><br><span class="line">System.out.println(<span class="string">"/lock的子节点为："</span>);</span><br><span class="line"><span class="keyword">for</span> (String node : nodes) &#123;</span><br><span class="line">    System.out.println(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="删除子节点"><a href="#删除子节点" class="headerlink" title="删除子节点"></a>删除子节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cf.delete()</span><br><span class="line">    .guaranteed()<span class="comment">//保障机制，若未删除成功，只要会话有效会在后台一直尝试删除</span></span><br><span class="line">    .deletingChildrenIfNeeded()<span class="comment">//若当前节点包含子节点</span></span><br><span class="line">    .forPath(<span class="string">"/lock"</span>);</span><br></pre></td></tr></table></figure><h3 id="异步绑定回调方法"><a href="#异步绑定回调方法" class="headerlink" title="异步绑定回调方法"></a>异步绑定回调方法</h3><p>比如创建节点时绑定一个回调函数，该回调函数可以输出服务器的状态码和事件类型。还可以加入一个线程池进行优化操作。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ExecutorService pool = Executors.newCachedThreadPool();</span><br><span class="line">cf.create().creatingParentsIfNeeded().withMode(CreateMode.PERSISTENT)</span><br><span class="line">.inBackground(<span class="keyword">new</span> BackgroundCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(CuratorFramework cf, CuratorEvent ce)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"code:"</span> + ce.getResultCode());</span><br><span class="line">        System.out.println(<span class="string">"type:"</span> + ce.getType());</span><br><span class="line">        System.out.println(<span class="string">"线程为:"</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, pool)</span><br><span class="line">.forPath(<span class="string">"/super/c3"</span>,<span class="string">"c3内容"</span>.getBytes());</span><br></pre></td></tr></table></figure></p><h3 id="节点监听"><a href="#节点监听" class="headerlink" title="节点监听"></a>节点监听</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retry = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">CuratorFramework client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2181"</span>, <span class="number">5000</span>, <span class="number">5000</span>, retry);</span><br><span class="line">client.start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> NodeCache cache = <span class="keyword">new</span> NodeCache(client,<span class="string">"/node_1"</span>);</span><br><span class="line">cache.start();</span><br><span class="line"></span><br><span class="line">cache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] res = cache.getCurrentData().getData();</span><br><span class="line">        System.out.println(<span class="string">"data: "</span> + <span class="keyword">new</span> String(res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="子节点监听"><a href="#子节点监听" class="headerlink" title="子节点监听"></a>子节点监听</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> PathChildrenCache cache = <span class="keyword">new</span> PathChildrenCache(client,<span class="string">"/node_1"</span>,<span class="keyword">true</span>);</span><br><span class="line">cache.start();</span><br><span class="line"></span><br><span class="line">cache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework curator, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">        <span class="keyword">case</span> CHILD_ADDED:</span><br><span class="line">            System.out.println(<span class="string">"add:"</span> + event.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CHILD_UPDATED:</span><br><span class="line">            System.out.println(<span class="string">"update:"</span> + event.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> CHILD_REMOVED:</span><br><span class="line">            System.out.println(<span class="string">"remove:"</span> + event.getData());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="ACL权限"><a href="#ACL权限" class="headerlink" title="ACL权限"></a>ACL权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">RetryPolicy retry = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>);</span><br><span class="line">CuratorFramework client = CuratorFrameworkFactory.newClient(<span class="string">"127.0.0.1:2181"</span>, <span class="number">5000</span>, <span class="number">5000</span>, retry);</span><br><span class="line">client.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//ACL有IP授权和用户名密码访问的模式</span></span><br><span class="line">ACL aclRoot = <span class="keyword">new</span> ACL(Perms.ALL,<span class="keyword">new</span> Id(<span class="string">"digest"</span>,DigestAuthenticationProvider.generateDigest(<span class="string">"root:root"</span>)));</span><br><span class="line">List&lt;ACL&gt; aclList = <span class="keyword">new</span> ArrayList&lt;ACL&gt;();</span><br><span class="line">aclList.add(aclRoot);</span><br><span class="line"></span><br><span class="line">String path = client.create().creatingParentsIfNeeded().withMode(CreateMode.EPHEMERAL)</span><br><span class="line">        .withACL(aclList)</span><br><span class="line">        .forPath(<span class="string">"/node_3/node_ACL"</span>,<span class="string">"2"</span>.getBytes());</span><br><span class="line">System.out.println(path);</span><br><span class="line"></span><br><span class="line">CuratorFramework client1 =  CuratorFrameworkFactory.builder().connectString(<span class="string">"192.168.0.3:2181"</span>)</span><br><span class="line">        .sessionTimeoutMs(<span class="number">5000</span>)<span class="comment">//会话超时时间</span></span><br><span class="line">        .connectionTimeoutMs(<span class="number">5000</span>)<span class="comment">//连接超时时间</span></span><br><span class="line">        .authorization(<span class="string">"digest"</span>,<span class="string">"root:root"</span>.getBytes())<span class="comment">//权限访问</span></span><br><span class="line">        .retryPolicy(retry)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">client1.start();</span><br><span class="line"></span><br><span class="line">String re = <span class="keyword">new</span> String(client1.getData().forPath(<span class="string">"/node_3/node_ACL"</span>));</span><br><span class="line">System.out.println(re);</span><br></pre></td></tr></table></figure><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p>在<a href="http://curator.apache.org/getting-started.html">http://curator.apache.org/getting-started.html</a>有说明，核心代码就2行。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">InterProcessMutex lock = <span class="keyword">new</span> InterProcessMutex(client, lockPath);</span><br><span class="line"><span class="keyword">if</span> ( lock.acquire(maxWait, waitUnit) ) <span class="comment">// 尝试在规定的时间内获取锁</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// do some work inside of the critical section here</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        lock.release(); <span class="comment">// 释放锁</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里来一个例子。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CuratorTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZOOKEEPER_ADDRESS = <span class="string">"127.0.0.1:2181"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 重试策略，重试间隔时间为1秒，重试次数为10次。curator管理了zookeeper的连接，在操作zookeeper的过程中出现连接问题会自动重试。</span></span><br><span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>,<span class="number">10</span>);</span><br><span class="line">        <span class="comment">// 通过工厂创建连接</span></span><br><span class="line">        CuratorFramework cf = CuratorFrameworkFactory.builder()</span><br><span class="line">                .connectString(ZOOKEEPER_ADDRESS)</span><br><span class="line">                .connectionTimeoutMs(<span class="number">15000</span>)</span><br><span class="line">                .retryPolicy(retryPolicy)</span><br><span class="line">                .sessionTimeoutMs(<span class="number">5000</span>)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="comment">// 或者这样创建连接</span></span><br><span class="line">        <span class="comment">// CuratorFramework cf = CuratorFrameworkFactory.newClient(ZOOKEEPER_ADDRESS,5000,15000,retryPolicy);</span></span><br><span class="line">        <span class="comment">// 打开连接</span></span><br><span class="line">        cf.start();</span><br><span class="line">        System.out.println(<span class="string">"=======================state:"</span> + cf.getState());</span><br><span class="line"></span><br><span class="line">        String orderNo = <span class="string">"10001"</span>;</span><br><span class="line">        <span class="comment">// 模拟数据库操作</span></span><br><span class="line">        DB db = <span class="keyword">new</span> DB();</span><br><span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">        <span class="comment">// 这里有3个线程同时执行同一个订单号的操作</span></span><br><span class="line">        executorService.submit(<span class="keyword">new</span> DistributedWorkerThread(cf,db,orderNo));</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> DistributedWorkerThread(cf,db,orderNo));</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> DistributedWorkerThread(cf,db,orderNo));</span><br><span class="line">        executorService.shutdown();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">15000</span>);</span><br><span class="line">        cf.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DB</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;String&gt; orders = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(String order)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!exist(order)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.orders.add(order);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exist</span><span class="params">(String order)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.orders.contains(order);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributedWorkerThread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> CuratorFramework cf;</span><br><span class="line">        <span class="keyword">private</span> String orderNo;</span><br><span class="line">        <span class="keyword">private</span> DB db;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DistributedWorkerThread</span><span class="params">(CuratorFramework cf,DB db,String orderNo)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.cf = cf;</span><br><span class="line">            <span class="keyword">this</span>.db = db;</span><br><span class="line">            <span class="keyword">this</span>.orderNo = orderNo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            String lockNode = <span class="string">"/lock/ms"</span>+orderNo;</span><br><span class="line">            InterProcessMutex lock = <span class="keyword">new</span> InterProcessMutex(cf,lockNode);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (lock.acquire(<span class="number">10</span>, TimeUnit.SECONDS)) &#123; <span class="comment">// 这里也可以不指定时间，就是一直等直到获取到锁。</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (db.exist(orderNo)) &#123;</span><br><span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">"订单已存在！"</span>);</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">"在这里执行你的业务代码..orderNo:"</span> + orderNo);</span><br><span class="line">                        <span class="keyword">this</span>.db.add(orderNo);</span><br><span class="line">                        Thread.sleep(<span class="number">1500L</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        lock.release();</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">"执行完毕！"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">"未获取到锁.."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们看下日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pool-3-thread-3在这里执行你的业务代码..orderNo:10001</span><br><span class="line">pool-3-thread-3执行完毕！</span><br><span class="line">pool-3-thread-1订单已存在！</span><br><span class="line">pool-3-thread-1执行完毕！</span><br><span class="line">pool-3-thread-2订单已存在！</span><br><span class="line">pool-3-thread-2执行完毕！</span><br></pre></td></tr></table></figure></p><p>Curator分布式锁的分析：<a href="https://blog.csdn.net/qiangcuo6087/article/details/79067136">https://blog.csdn.net/qiangcuo6087/article/details/79067136</a></p><h3 id="Leader选举"><a href="#Leader选举" class="headerlink" title="Leader选举"></a>Leader选举</h3><p><a href="http://curator.apache.org/getting-started.html">http://curator.apache.org/getting-started.html</a>示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">LeaderSelectorListener listener = <span class="keyword">new</span> LeaderSelectorListenerAdapter()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(CuratorFramework client)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// this callback will get called when you are the leader</span></span><br><span class="line">        <span class="comment">// do whatever leader work you need to and only exit</span></span><br><span class="line">        <span class="comment">// this method when you want to relinquish leadership</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LeaderSelector selector = <span class="keyword">new</span> LeaderSelector(client, path, listener);</span><br><span class="line">selector.autoRequeue();  <span class="comment">// not required, but this is behavior that you will probably expect</span></span><br><span class="line">selector.start();</span><br></pre></td></tr></table></figure></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.java.io.IOException: Xid out of order. Got Xid 3 with err -101 expected Xid 2 for a packet with details<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">java.io.IOException: Xid out of order. Got Xid 3 with err -101 expected Xid 2 for a packet with details: clientPath:null serverPath:null finished:false header:: 2,15  replyHeader:: 0,0,-4  request:: &apos;/lock/ms10000,#3130303030,v&#123;s&#123;31,s&#123;&apos;world,&apos;anyone&#125;&#125;&#125;,0  response::  </span><br><span class="line">    at org.apache.zookeeper.ClientCnxn$SendThread.readResponse(ClientCnxn.java:892)</span><br><span class="line">    at org.apache.zookeeper.ClientCnxnSocketNIO.doIO(ClientCnxnSocketNIO.java:101)</span><br><span class="line">    at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:363)</span><br><span class="line">    at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1214)</span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://blog.csdn.net/xiaojiahao_kevin/article/details/51203083">https://blog.csdn.net/xiaojiahao_kevin/article/details/51203083</a></p><p>参考：<a href="https://blog.csdn.net/qq_15370821/article/details/73692288">https://blog.csdn.net/qq_15370821/article/details/73692288</a>,&lt;&gt;</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea日志乱码问题解决</title>
      <link href="/2018/07/25/idea%E6%97%A5%E5%BF%97%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/"/>
      <url>/2018/07/25/idea%E6%97%A5%E5%BF%97%E4%B9%B1%E7%A0%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<p>使用System.out.pringln()输出中文到控制台显示正常，但使用日志组件则显示为乱码。</p><p>1.修改idea.exe.vmoptions，增加字符集设置<br>找到idea安装目录（可以桌面找到idea图标，右键选择属性，点查找目标）。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-25/6691768.jpg" alt=""></p><p>增加<code>-Dfile.encoding=utf-8</code>。保存，然后重启idea。<br><a id="more"></a><br>2.日志配置中增加字符集设置。<br>比如log4j:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Console output...</span><br><span class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.stdout.layout.ConversionPattern=%d [%t] %c %x - %m%n</span><br><span class="line">log4j.appender.stdout.Encoding=GBK</span><br></pre></td></tr></table></figure></p><p>这是控制台日志的字符集设置（最后一行），如果发现日志文件是乱码，在文件的日志配置中增加字符集设置。<br>参考：<a href="https://blog.csdn.net/u011133135/article/details/72123196">https://blog.csdn.net/u011133135/article/details/72123196</a></p><p>3.在idea设置中找到file encoding，将所有的字符集都设置为UTF-8<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-25/45772566.jpg" alt=""></p><p>4.idea Run/Debug Configuration的VM OPTIONS增加字符集设置<br><img src="http://omh46px9n.bkt.clouddn.com/18-10-19/22433219.jpg" alt=""></p><p>一般经过上面的设置，问题即可解决。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dubbo-admin安装与使用</title>
      <link href="/2018/07/24/dubbo-admin%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/07/24/dubbo-admin%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>在dubbo加入apache后，github地址也变了。dubbo-admin需要从<a href="https://github.com/apache/incubator-dubbo-ops">https://github.com/apache/incubator-dubbo-ops</a>下载。<br>将项目克隆到本地后，可以看到dubbo-admin模块。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-24/58735559.jpg" alt=""></p><p>值得注意的是，最新的dubbo-admin集成了springboot，可以打包为jar运行。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-24/13520115.jpg" alt=""></p><p>下载后的项目名称为<code>incubator-dubbo-ops</code>，cmd到在该模块下，执行<code>mvn package -DskipTests=true</code>，将dubbo-admin打成jar包。</p><p>打包完成后，我们会在dubbo-admin/target下看到dubbo-admin的jar包<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-24/34572946.jpg" alt=""></p><p>注意：dubbo-admin的端口默认是7001，dubbo注册中心的地址是本机的2181端口，还有其他的一些配置。如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-24/62836091.jpg" alt=""><br>根据个人情况，将配置修改后，重新打包。最后使用<code>java -jar dubbo-admin-xxx.jar</code>即可启动。</p><p>PS：注意先打开本机的zookeeper。</p><p>启动后，浏览器输入<a href="http://localhost:7001">http://localhost:7001</a>即可访问，默认的用户名密码输入root，即进入首页。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成dubbo</title>
      <link href="/2018/07/21/springboot%E9%9B%86%E6%88%90dubbo/"/>
      <url>/2018/07/21/springboot%E9%9B%86%E6%88%90dubbo/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>dubbo是一个分布式的高性能Java RPC服务治理框架。<br>由于之前dubbo不更新没怎么用它。不过现在已经成为Apache的一员了，所以就不用担心这个问题了。</p><p>dubbo官网：<a href="http://dubbo.apache.org">http://dubbo.apache.org</a>，还有中文版，不错。</p><p>模块划分：<br>这里将接口和用到的bean放在dubbo-interface，服务提供方dubbo-provider，服务消费方dubbo-consumer。</p><h2 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h2><h3 id="1-项目结构"><a href="#1-项目结构" class="headerlink" title="1.项目结构"></a>1.项目结构</h3><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-21/10611569.jpg" alt=""></p><p>父pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.donny<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-interface<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span> /&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="2-dubbo-interface"><a href="#2-dubbo-interface" class="headerlink" title="2.dubbo-interface"></a>2.dubbo-interface</h3><p>这里定义一个UserService，并提供2个方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">findAllUsers</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"id="</span> + id +</span><br><span class="line">                <span class="string">", name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PS:注意User要实现序列化接口。</p><h3 id="3-dubbo-provider"><a href="#3-dubbo-provider" class="headerlink" title="3.dubbo-provider"></a>3.dubbo-provider</h3><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.donny<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dubbo-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- FIXME change it to the project's website --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.donny<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.sgroschupf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>application.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line"></span><br><span class="line">dubbo:</span><br><span class="line">  registry:</span><br><span class="line">    address: localhost:2181</span><br><span class="line"></span><br><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    root: info</span><br></pre></td></tr></table></figure></p><p>dubbo-provider.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 提供方应用信息，用于计算依赖关系 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"dubbo-provider"</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 注册中心服务地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">"zookeeper"</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">"$&#123;dubbo.registry.address&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 用dubbo协议在30001 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"30001"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 声明需要暴露的服务接口 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.donny.service.UserService"</span> <span class="attr">ref</span>=<span class="string">"userService"</span></span></span><br><span class="line"><span class="tag">                   <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">registry</span>=<span class="string">"zookeeper"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 具体服务接口的实现 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"com.donny.service.UserServiceImpl"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>UserService实现<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello,"</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAllUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;User&gt;(<span class="number">3</span>);</span><br><span class="line">        User user0 = <span class="keyword">new</span> User();</span><br><span class="line">        user0.setId(<span class="number">1L</span>);</span><br><span class="line">        user0.setName(<span class="string">"张三"</span>);</span><br><span class="line">        user0.setAge(<span class="number">18</span>);</span><br><span class="line">        users.add(user0);</span><br><span class="line"></span><br><span class="line">        User user1 = <span class="keyword">new</span> User();</span><br><span class="line">        user1.setId(<span class="number">2L</span>);</span><br><span class="line">        user1.setName(<span class="string">"李四"</span>);</span><br><span class="line">        user1.setAge(<span class="number">28</span>);</span><br><span class="line">        users.add(user1);</span><br><span class="line"></span><br><span class="line">        User user2 = <span class="keyword">new</span> User();</span><br><span class="line">        user2.setId(<span class="number">3L</span>);</span><br><span class="line">        user2.setName(<span class="string">"王五"</span>);</span><br><span class="line">        user2.setAge(<span class="number">38</span>);</span><br><span class="line">        users.add(user2);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Springboot主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:dubbo-provider.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboProviderApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        SpringApplication.run(DubboProviderApp.class,args);</span><br><span class="line">        System.in.read(); <span class="comment">// 为保证服务一直开着，利用输入流的阻塞来模拟</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="4-dubbo-consumer"><a href="#4-dubbo-consumer" class="headerlink" title="4.dubbo-consumer"></a>4.dubbo-consumer</h3><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springboot-dubbo-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.donny<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>dubbo-consumer<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.example.com<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.donny<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo-interface<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.zookeeper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zookeeper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.sgroschupf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>zkclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.curator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>curator-recipes<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>application.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line"></span><br><span class="line">dubbo:</span><br><span class="line">  registry:</span><br><span class="line">    address: localhost:2181</span><br></pre></td></tr></table></figure></p><p>dubbo-consumer.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 消费方应用名 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"dubbo-consumer"</span>  /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 注册中心服务地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">"zookeeper"</span> <span class="attr">protocol</span>=<span class="string">"zookeeper"</span> <span class="attr">address</span>=<span class="string">"$&#123;dubbo.registry.address&#125;"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 引用UserService服务--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">interface</span>=<span class="string">"com.donny.service.UserService"</span></span></span><br><span class="line"><span class="tag">                     <span class="attr">check</span>=<span class="string">"false"</span> <span class="attr">version</span>=<span class="string">"1.0"</span> <span class="attr">url</span>=<span class="string">""</span> <span class="attr">registry</span>=<span class="string">"zookeeper"</span> <span class="attr">protocol</span>=<span class="string">"dubbo"</span> <span class="attr">timeout</span>=<span class="string">"15000"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>Springboot主类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ImportResource</span>(<span class="string">"classpath:dubbo-consumer.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConsumerApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(DubboConsumerApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = DubboConsumerApp.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConsumerTest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String result = userService.sayHello(<span class="string">"jack"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">        assertEquals(result,<span class="string">"Hello,jack"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAllUers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">this</span>.userService.findAllUsers();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != users &amp;&amp; !users.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (User user : users) &#123;</span><br><span class="line">                System.out.println(user);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        assertNotNull(users);</span><br><span class="line">        assertEquals(users.size(),<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PS:这里注册中心使用的zookeeper。</p><h3 id="5-使用dubbo-spring-boot-starter"><a href="#5-使用dubbo-spring-boot-starter" class="headerlink" title="5.使用dubbo-spring-boot-starter"></a>5.使用dubbo-spring-boot-starter</h3><p>springboot提供了非常多的starter，要用什么就使用spring-boot-starter-xxx即可。dubbo也提供了相应的starter。<br>dubbo-spring-boot-starter的github地址：<a href="https://github.com/alibaba/dubbo-spring-boot-starter">https://github.com/alibaba/dubbo-spring-boot-starter</a>。使用还是比较简单的，这里不再赘述。</p><p>dubbo-spring-boot-starter的使用也可以参考这篇：<a href="https://blog.csdn.net/romantic112/article/details/79687942">https://blog.csdn.net/romantic112/article/details/79687942</a>。</p><p>参考：<a href="https://blog.csdn.net/qq_27384769/article/details/79465781">https://blog.csdn.net/qq_27384769/article/details/79465781</a></p><p>代码地址：<a href="https://gitee.com/tommy88/springboot-dubbo-demo">https://gitee.com/tommy88/springboot-dubbo-demo</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列32——Spring Cloud Config的高可用</title>
      <link href="/2018/07/20/springcloud%E7%B3%BB%E5%88%9732%E2%80%94%E2%80%94Config%20Server%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
      <url>/2018/07/20/springcloud%E7%B3%BB%E5%88%9732%E2%80%94%E2%80%94Config%20Server%E7%9A%84%E9%AB%98%E5%8F%AF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Spring Cloud Config Server的高可用涉及到3个——Git仓库、RabbitMQ（Kafka）、Config Server本身3个的高可用。因为Config Server依赖Git仓库和RabbitMQ（Kafka），所以必须保证Git仓库和RabbitMQ（Kafka）也是高可用的。这里只介绍Config Server本身的高可用。</p><p>Config Server的高可用也分为2种：Config Server未注册到Eureka Server上 、Config Server注册到了Eureka Server上。</p><h2 id="Config-Server的高可用"><a href="#Config-Server的高可用" class="headerlink" title="Config Server的高可用"></a>Config Server的高可用</h2><h3 id="Config-Server未注册到Eureka-Server上"><a href="#Config-Server未注册到Eureka-Server上" class="headerlink" title="Config Server未注册到Eureka Server上"></a>Config Server未注册到Eureka Server上</h3><p>这种情况在Spring Cloud中称之为“Config First Bootstrap”。<br>可以使用一个负载均衡软件（如nginx）来做高可用，Cloud Config Client URI指向Nginx。</p><h3 id="Config-Server注册到了Eureka-Server上"><a href="#Config-Server注册到了Eureka-Server上" class="headerlink" title="Config Server注册到了Eureka Server上"></a>Config Server注册到了Eureka Server上</h3><p>这种情况，在Spring Cloud中称之为“Discovery First Bootstrap”。<br>实现Config Server的高可用很简单，只需要将多个Config Server注册到Eureka server即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列31——Spring Cloud Config配置属性刷新之自动刷新</title>
      <link href="/2018/07/20/springcloud%E7%B3%BB%E5%88%9731%E2%80%94%E2%80%94Spring%20Cloud%20Config%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0/"/>
      <url>/2018/07/20/springcloud%E7%B3%BB%E5%88%9731%E2%80%94%E2%80%94Spring%20Cloud%20Config%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在前面一节中，我们通过执行/refresh端点来手动刷新配置，但是如果微服务的数量太多，一个一个刷新就很麻烦也很慢。本节介绍使用Spring Cloud Bus实现批量刷新和自动刷新。</p><h2 id="使用Spring-Cloud-Bus实现配置批量刷新"><a href="#使用Spring-Cloud-Bus实现配置批量刷新" class="headerlink" title="使用Spring Cloud Bus实现配置批量刷新"></a>使用Spring Cloud Bus实现配置批量刷新</h2><p>Spring Cloud Bus依赖rabbitmq或kafka，这里我们使用rabbitmq。</p><h3 id="1-rabbitmq的安装与使用"><a href="#1-rabbitmq的安装与使用" class="headerlink" title="1.rabbitmq的安装与使用"></a>1.rabbitmq的安装与使用</h3><p>进入rabbitmq的下载页面下载安装包（这里使用windows），下载地址为：<a href="http://www.rabbitmq.com/download.html">http://www.rabbitmq.com/download.html</a></p><p>在下载页面的右侧有各个系统的安装方法。</p><p>windows的地址为：<a href="http://www.rabbitmq.com/install-windows.html">http://www.rabbitmq.com/install-windows.html</a></p><p>rabbitmq依赖Erlang，所以在安装rabbitmq之前需要安装Erlang。</p><p>在<a href="http://www.rabbitmq.com/which-erlang.html">http://www.rabbitmq.com/which-erlang.html</a>这个页面给出了每个rabbitmq应该安装的Erlang版本。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/22377701.jpg" alt=""></p><p>我们下载的是3.7.7的版本，推荐的Erlang版本是21.0.x 。</p><p>erlang的下载地址为：<a href="http://erlang.org/download/">http://erlang.org/download/</a></p><p>csdn下载地址：<a href="https://download.csdn.net/download/qq_24118265/10186110">https://download.csdn.net/download/qq_24118265/10186110</a></p><p>下载完毕后，就依次安装Erlang和rabbitmq即可。</p><p>安装完毕后，可以看到rabbitmq已经作为服务启动了。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/53246659.jpg" alt=""></p><h3 id="2-开启RabbitMQ网页端控制台"><a href="#2-开启RabbitMQ网页端控制台" class="headerlink" title="2.开启RabbitMQ网页端控制台"></a>2.开启RabbitMQ网页端控制台</h3><p>1.设置ERLANG_HOME环境变量；</p><p>2.到$rabbitmq_home/sbin$执行：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins.bat enable rabbitmq_management</span><br></pre></td></tr></table></figure><p>如图：</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/74070347.jpg" alt=""></p><p>3.重新开启rabbitmq服务。</p><p>4.浏览器访问<a href="http://localhost:15672">http://localhost:15672</a>，用户名和密码默认都是guest。</p><h3 id="3-Cloud-Config-Client修改"><a href="#3-Cloud-Config-Client修改" class="headerlink" title="3.Cloud Config Client修改"></a>3.Cloud Config Client修改</h3><ol><li><p>增加spring-cloud-starter-bus-amqp依赖；</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>增加rabbitmq配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  rabbitmq:</span></span><br><span class="line"><span class="attr">      host:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">      port:</span> <span class="number">5672</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">guest</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">guest</span></span><br></pre></td></tr></table></figure></li></ol><p>   如此就大功告成了！</p><p>下面进行测试。</p><p>启动Config Server和2个Cloud Client（为了测试批量刷新配置）。<br>在Cloud Client启动时，控制台可以看到有一个端点/bus/refresh，我们用它可以批量刷新配置。<br>我们将git仓库配置文件的一个配置项做修改：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.custom.message=Hello,This is new value!!!</span><br></pre></td></tr></table></figure><p>我们使用curl执行刷新命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:8080/bus/refresh</span><br></pre></td></tr></table></figure><p>然后访问Cloud Config Client，看看是否配置更新。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/68794393.jpg" alt=""></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/92832154.jpg" alt=""></p><p>可以看到，2个Cloud Config Client应用配置都已经刷新！</p><p>观察2个Cloud Config Client，可以看到如下日志：</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/41972206.jpg" alt=""></p><p>至此就实现了批量配置刷新。</p><p>我们到RabbitMQ的控制台的Exchanges，可以看到springCloudBus。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/82901088.jpg" alt=""></p><h2 id="刷新某个Cloud-Config-Client"><a href="#刷新某个Cloud-Config-Client" class="headerlink" title="刷新某个Cloud Config Client"></a>刷新某个Cloud Config Client</h2><p>如果要刷新某个Cloud Config Client的配置，可以使用<code>/bus/refresh?destination=customers:9000</code>。其中，customers:这里是ApplicationContext ID，9000是服务的端口。</p><p>但是，如果在BUS上已经有了这个ID，则会刷新这个ID的配置，其他的会被忽略。即如果在不同的机器上部署了同样的Cloud Config Client应用，ID一样，端口一样，IP不一样，则只会有一个服务配置属性会被刷新。</p><p>解决办法就是制定spring.application.index，不过这样就很麻烦了，每个同类的微服务（ID相同）都需要指定不同的index。不过可以指定spring.application.index=${random.long}来使用随机生成的数字作为index。不过，很明显似乎是一个设计缺陷，为什么不增加一个host参数？</p><h2 id="刷新某个Cloud-Config-Client服务的所有实例"><a href="#刷新某个Cloud-Config-Client服务的所有实例" class="headerlink" title="刷新某个Cloud Config Client服务的所有实例"></a>刷新某个Cloud Config Client服务的所有实例</h2><p>这个比较简单了，使用<code>/bus/refresh?destination=customers:**</code>即可，customers指应用的id。</p><p>参考Spring Cloud Bus章节：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_spring_cloud_bus">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_spring_cloud_bus</a></p><h2 id="配置自动刷新"><a href="#配置自动刷新" class="headerlink" title="配置自动刷新"></a>配置自动刷新</h2><p>这个要借助于Git管理软件提供的WebHooks钩子，可以指定一个地址，在提交到Git仓库时自动触发请求这个地址。</p><p>比如gitee.com</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-20/42508989.jpg" alt=""></p><p>上面的URL就指定为刷新地址，如<a href="http://localhost:8080/bus/refresh">http://localhost:8080/bus/refresh</a>，密码随意了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列29——Spring Cloud Config与Eureka配合使用</title>
      <link href="/2018/07/19/springcloud%E7%B3%BB%E5%88%9729%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B8%8EEureka%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/07/19/springcloud%E7%B3%BB%E5%88%9729%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B8%8EEureka%E9%85%8D%E5%90%88%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在之前说到的Spring Cloud Config Client程序中都是通过spring.cloud.config.uri 指定Config Server的地址。这种方式Spring Cloud称之为“Config First Bootstrap”。除此之外，还支持一种服务发现的方式，Spring Cloud称之为“Discovery First Bootstrap”。本文将说明如何通过Eureka发现Config Server的服务。</p><h2 id="Spring-Cloud-Config与Eureka配合使用"><a href="#Spring-Cloud-Config与Eureka配合使用" class="headerlink" title="Spring Cloud Config与Eureka配合使用"></a>Spring Cloud Config与Eureka配合使用</h2><h3 id="1-Config-Server改造"><a href="#1-Config-Server改造" class="headerlink" title="1.Config Server改造"></a>1.Config Server改造</h3><p>既然是通过Eureka服务发现来帮助Config Client定位到Config Server，那么必须先将Config Server注册到Eureka上。</p><p>a.添加Eureka的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>b.在配置文件指定eureka的serviceUri</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-config-server</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p>注意需要指定Config Server的serviceId（spring.application.name），后面客户端从Eureka是根据serviceId查找Config Server的。</p></blockquote><p>3.在Spring Boot主类增加@EnableEurekaClient </p><h3 id="2-Config-Client改造"><a href="#2-Config-Client改造" class="headerlink" title="2.Config Client改造"></a>2.Config Client改造</h3><p>a.添加Eureka的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>b.配置文件增加Config Server的服务发现配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">cloud-config-client</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      name:</span> <span class="string">cloud-config</span></span><br><span class="line"><span class="attr">      profile:</span> <span class="string">$&#123;config.profile:dev&#125;</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">        service-id:</span> <span class="string">cloud-config-server</span></span><br><span class="line"><span class="attr">      username:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      password:</span> <span class="string">password123</span></span><br></pre></td></tr></table></figure><p>上面的配置中，discovery.enabled指定是否启用服务发现，service-id指定服务id。</p><p>在上一节中说到有2种方式配置会用户名和密码，但如果使用服务发现的话，就只能使用这种单独指定username和password的形式了。</p><p>3.在Spring Boot主类增加@EnableEurekaClient </p><p>然后依次启动Eureka Server，Config Server和Config Client即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列30——Spring Cloud Config配置属性刷新之手动刷新</title>
      <link href="/2018/07/19/springcloud%E7%B3%BB%E5%88%9730%E2%80%94%E2%80%94Spring%20Cloud%20Config%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%B7%E6%96%B0%E4%B9%8B%E6%89%8B%E5%8A%A8%E5%88%B7%E6%96%B0/"/>
      <url>/2018/07/19/springcloud%E7%B3%BB%E5%88%9730%E2%80%94%E2%80%94Spring%20Cloud%20Config%E9%85%8D%E7%BD%AE%E5%B1%9E%E6%80%A7%E5%88%B7%E6%96%B0%E4%B9%8B%E6%89%8B%E5%8A%A8%E5%88%B7%E6%96%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在以往的应用中，如果要更改应用的配置，要让配置生效必须重启应用程序。在Spring Cloud Config中我们可以刷新配置属性而不用重启应用。</p><p>这1节说明在Spring Cloud Config如何手动刷新配置属性。</p><h2 id="手动刷新配置属性"><a href="#手动刷新配置属性" class="headerlink" title="手动刷新配置属性"></a>手动刷新配置属性</h2><p>1.需要引入spring boot-actuator依赖（用到/refresh端点）</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.在Bean上增加@RefreshScope注解</p><p>比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;my.custom.message&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String customeMessage;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/customMsg"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCustomeMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.customeMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok，准备工作完毕！</p><p>先来看看my.custom.message原来的配置</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-19/12070234.jpg" alt=""></p><p>现在我们修改git仓库中配置文件的my.custom.message的配置项。</p><p>我们将value修改为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">my.custom.message=Hello,This message is changed!!!</span><br></pre></td></tr></table></figure><p>现在通过/refresh刷新配置属性。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-19/10095731.jpg" alt=""></p><p>返回结果表示my.custom.message配置有更新。</p><p>现在在访问/user/customeMsg</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-19/91936218.jpg" alt=""></p><p>可以看到，已经使用了刚刚更新的配置。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>1.默认spring-boot-acturator开启了安全认证，这里作为演示将其关闭（management.security.enabled=false）。</p><p>2.如果有很多个微服务，使用手动刷新配置的方式就不太合适了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列28——Spring Cloud Config之认证</title>
      <link href="/2018/07/18/springcloud%E7%B3%BB%E5%88%9728%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8BSecurity/"/>
      <url>/2018/07/18/springcloud%E7%B3%BB%E5%88%9728%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8BSecurity/</url>
      
        <content type="html"><![CDATA[<h2 id="Config-Server端"><a href="#Config-Server端" class="headerlink" title="Config Server端"></a>Config Server端</h2><h3 id="1-添加spring-boot-starter-security依赖"><a href="#1-添加spring-boot-starter-security依赖" class="headerlink" title="1.添加spring-boot-starter-security依赖"></a>1.添加spring-boot-starter-security依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-在配置文件配置用户名和密码"><a href="#2-在配置文件配置用户名和密码" class="headerlink" title="2.在配置文件配置用户名和密码"></a>2.在配置文件配置用户名和密码</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line"><span class="attr">  basic:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  user:</span></span><br><span class="line">    <span class="comment"># 默认为user</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">user</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">password123</span></span><br></pre></td></tr></table></figure><p>security.basic.enabled默认为true，security.user.name默认为user，security.user.password默认是随机生成的一串文字，在启动的时候从控制台可以看到。</p><p>然后在访问Config Server时会要求输入用户名和密码。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-18/80847886.jpg" alt=""></p><p>输入上面配置文件中配置的用户名和密码后就可以访问了。</p><h2 id="Config-Client端"><a href="#Config-Client端" class="headerlink" title="Config Client端"></a>Config Client端</h2><p>config server端增加认证后，config client也需要做一定的配置。</p><p>有2种方式配置用户名和密码。</p><p>第1种方式：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.cloud.config.username=user</span></span><br><span class="line"><span class="string">spring.cloud.config.password=password123</span></span><br></pre></td></tr></table></figure><p>第2种方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.uri=http://user:password123@127.0.0.1:$&#123;config.port:8888&#125;</span><br></pre></td></tr></table></figure><p>PS:如果这2种方式都配置了，生效的是第1种方式。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列27——Spring Cloud Config之非对称加密</title>
      <link href="/2018/07/17/springcloud%E7%B3%BB%E5%88%9727%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%862/"/>
      <url>/2018/07/17/springcloud%E7%B3%BB%E5%88%9727%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%862/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在上一节说了Spring Cloud Config的对称加密，也可以使用非对称加密。公钥用于加密，私钥用于解密。这一节就说说非对称加密的用法。</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="1-生成秘钥"><a href="#1-生成秘钥" class="headerlink" title="1.生成秘钥"></a>1.生成秘钥</h3><p>这里以Spring Cloud官网文档给的例子来说明。</p><p>打开CMD窗口，粘贴并执行下面的命令：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -alias mytestkey -keyalg RSA -dname &quot;CN=Web Server,OU=Unit,O=Organization,L=City,S=State,C=US&quot; -keypass changeme -keystore server.jks -storepass letmein</span><br></pre></td></tr></table></figure><p>执行完毕后，会发现该目录下生成了一个server.jks的文件。将该文件复制到classpath。</p><blockquote><p>注意：Spring Cloud官网官网给的代码是Linux下执行的（带有\表示换行），windows下需要所有代码在一行。</p></blockquote><h3 id="2-bootstrap-yml"><a href="#2-bootstrap-yml" class="headerlink" title="2.bootstrap.yml"></a>2.bootstrap.yml</h3><p>在Spring Cloud Config Server的应用的bootstrap.yml增加下面的配置，指定非对称加密的配置。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">encrypt:</span></span><br><span class="line"><span class="attr">  keyStore:</span></span><br><span class="line"><span class="attr">    location:</span> <span class="attr">classpath:/server.jks</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">letmein</span></span><br><span class="line"><span class="attr">    alias:</span> <span class="string">mytestkey</span></span><br><span class="line"><span class="attr">    secret:</span> <span class="string">changeme</span></span><br></pre></td></tr></table></figure><p>location:指定密钥文件的位置。</p><p>password指定密钥库的密码(获取keystore信息所需的密码) 。</p><p>alias指定别名</p><p>secret指定私钥的密码。</p><p>这些信息都是从第1步生成秘钥的指令中获取。</p><h3 id="3-测试"><a href="#3-测试" class="headerlink" title="3.测试"></a>3.测试</h3><p>启动Spring Cloud Config Server应用。</p><p>1.加密</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/31370734.jpg" alt=""></p><p>2.解密</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/18190089.jpg" alt=""></p><p>后面的使用与上一节一致，不再赘述。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列26——Spring Cloud Config之加解密</title>
      <link href="/2018/07/17/springcloud%E7%B3%BB%E5%88%9726%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%86/"/>
      <url>/2018/07/17/springcloud%E7%B3%BB%E5%88%9726%E2%80%94%E2%80%94Spring%20Cloud%20Config%E4%B9%8B%E5%8A%A0%E8%A7%A3%E5%AF%86/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在《springcloud系列25——SpringCloud配置管理》中介绍了以Git为首的作为配置仓库的示例。但是我们的配置项都是以明文的形式保存在Git仓库中。虽然我们可以创建私有的仓库，然后配置仓库的用户名和密码。但是如果账号被破解了呢？所以，本节要介绍的是如何加密你的配置项。这里首先介绍对称加密在Spring Cloud Config的用法。</p><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>在Spring Cloud Config中使用加解密功能，需要在你的JVM中安装有一个没有加密强度限制的JCE（JDK自带的私有强度限制的）。</p><blockquote><p>注：JCE全称为Java Cryptography Extension 。</p></blockquote><p>具体做法如下：<br>1.从oracle下载无加密强度限制的JCE；<br>oracle JCE的下载地址：<a href="http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip">http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip</a></p><p>2.复制2个策略文件替换JDK自带的策略文件。<br>解压后，可以看到2个策略文件</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/29366664.jpg" alt=""></p><p>找到jdk/jre/lib/security，然后覆盖这2个文件。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/46348564.jpg" alt=""></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在Config Server所在的应用增加秘钥的配置（配置到bootstrap.yml）：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">encrypt:</span></span><br><span class="line"><span class="attr">  key:</span> <span class="string">foo</span></span><br></pre></td></tr></table></figure><p>然后重启Config Server应用。  </p><p>Spring Cloud会我们提供了相应的加密和解密的端点。<br>1.加密</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/38676167.jpg" alt=""></p><p>2.解密</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/24212468.jpg" alt=""></p><p>我们通过Spring Cloud提供的加密端点对配置信息进行加密，然后提交到GIT仓库。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/51786617.jpg" alt=""></p><p>需要注意的是，加密的信息前面必须有{cipher}前缀。</p><p>现在，我们来请求我们刚刚上传的加密的配置文件。</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-17/40892650.jpg" alt=""></p><p>可以看到，Spring Cloud Config已经自动为我们解密了！</p><h2 id="客户端使用"><a href="#客户端使用" class="headerlink" title="客户端使用"></a>客户端使用</h2><p>在上面也已经看到了，我们请求加密的配置，Spring  Cloud Config为我们自动解密了，所以Cloud Config Client不需要做任何修改。</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.配置<code>encrypt.key=foo</code>必须配置到bootstrap.yml中，不能配置到application.yml，否则无法加密。会返回如下错误</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;description&quot;:&quot;No key was installed for encryption service&quot;,</span><br><span class="line"> &quot;status&quot;:&quot;NO_KEY&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.yml配置文件加密项需要使用引号，而Properties文件则不能用引号引起来。</p><p>yml配置示例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">dbuser</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">'&#123;cipher&#125;FKSAJDFGYOS8F7GLHAKERGFHLSAJ'</span></span><br></pre></td></tr></table></figure><p>可以参考：<a href="https://blog.csdn.net/chenxyz707/article/details/80487733">https://blog.csdn.net/chenxyz707/article/details/80487733</a></p><p>Spring Cloud Config官方文档：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_spring_cloud_config">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_spring_cloud_config</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列25——SpringCloud配置管理</title>
      <link href="/2018/07/14/springcloud%E7%B3%BB%E5%88%9725%E2%80%94%E2%80%94SpringCloud%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/"/>
      <url>/2018/07/14/springcloud%E7%B3%BB%E5%88%9725%E2%80%94%E2%80%94SpringCloud%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/</url>
      
        <content type="html"><![CDATA[<p><a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_spring_cloud_config">springcloud官方文档</a></p><h2 id="为什么要统一管理配置？"><a href="#为什么要统一管理配置？" class="headerlink" title="为什么要统一管理配置？"></a>为什么要统一管理配置？</h2><p>1、集中管理  </p><p>2、不同环境不同配置  </p><p>3、运行期间动态调整配置  </p><p>4、自动刷新 </p><h2 id="Spring-Cloud简介"><a href="#Spring-Cloud简介" class="headerlink" title="Spring Cloud简介"></a>Spring Cloud简介</h2><p>为了解决上面的4个问题，spring cloud提供了spring cloud config组件。</p><p>Spring Cloud Config为分布式系统外部化配置提供了服务器端和客户端的支持，它包括Config Server和Config Client两部分。由于Config Server和Config Cleint都实现了对Spring Environment和PropertySource抽象的映射，因此，Spring Cloud非常适合Spring应用程序，当然也可与任何其他语言编写的应用程序配合使用。</p><p>Config Server是一个可横向扩展、集中式的配置服务器，它用于集中管理应用程序各个环境下的配置，默认使用Git存储配置内容(也可使用Subversion、本地文件系统或Vault存储配置),因此可以方便的实现对配置的版本控制与内容审计。</p><p>Config Client 是Config Server的客户端，用于操作存储在Config Server中的配置属性。</p><h2 id="springcloud架构图"><a href="#springcloud架构图" class="headerlink" title="springcloud架构图"></a>springcloud架构图</h2><p>下面是从网上弄的一张架构图</p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-14/46402444.jpg" alt="">.</p><p>每个微服务有一个Spring Cloud Client，从Spring Cloud Config Server获取配置信息，Spring Cloud Config Server从Git仓库拉取配置。</p><h2 id="Spring-Cloud-Config-Server基础使用"><a href="#Spring-Cloud-Config-Server基础使用" class="headerlink" title="Spring Cloud Config Server基础使用"></a>Spring Cloud Config Server基础使用</h2><p>1.maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.Spring Boot主类增加@EnableConfigServer注解</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3.application.yml配置</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server.port=8888</span></span><br><span class="line"><span class="string">spring.cloud.config.server.git.uri=https://gitee.com/tommy88/springcloud-demos.git</span></span><br></pre></td></tr></table></figure><p>spring.cloud.config.server.git.uri配置Git仓库地址。</p><p>spring cloud config server提供了下面的映射规则：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/&#123;application&#125;/&#123;profile&#125;[/&#123;label&#125;]</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.yml</span><br><span class="line">/&#123;application&#125;-&#123;profile&#125;.properties</span><br><span class="line">/&#123;label&#125;/&#123;application&#125;-&#123;profile&#125;.properties</span><br></pre></td></tr></table></figure><p>{application}会被<code>spring.config.name</code>注入，{profile}是环境信息，比如dev/test/product。{label}是一个可选的git标签，默认是master。</p><blockquote><p>如果查找aaa项目的application-dev.yml，输入匹配路径/aaa/dev。如果application-dev.yml存在，则返回；如果不存在，则会返回application.yml的内容。</p></blockquote><h2 id="Git仓库配置详解"><a href="#Git仓库配置详解" class="headerlink" title="Git仓库配置详解"></a>Git仓库配置详解</h2><p>Spring Cloud Config支持Git/SVN/文件系统等，默认使用的是Git。这里介绍Git在Spring Cloud Config Server中的一些配置。</p><h3 id="1-Git-uri中的通配符"><a href="#1-Git-uri中的通配符" class="headerlink" title="1.Git uri中的通配符"></a>1.Git uri中的通配符</h3><p>Spring Cloud Config Server支持带有{application}和{profile}（和{label}的占位符的git存储库URL（如果需要），但请记住，无论如何都要将标签应用为git标签）。 </p><p>所以，你可以一个应用一个仓库，比如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/myorg/&#123;application&#125;</span></span><br></pre></td></tr></table></figure><p>比如有2个Git Repo，分别为aaa和bbb。比如获取aaa的dev环境的配置，通过上面的配置可以通过/aaa/dev，同理bbb的dev环境的配置则为/bbb/dev。</p><p>你也可以配置{profile}通配符，比如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/myorg/&#123;application&#125;-&#123;profile&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-模式匹配"><a href="#2-模式匹配" class="headerlink" title="2.模式匹配"></a>2.模式匹配</h3><p>通过{application}和{profile}的模式匹配，可以支持更复杂的需求。模式格式是带有{application}/{profile}通配符的使用逗号分隔的列表。</p><p>例如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          repos:</span></span><br><span class="line"><span class="attr">            simple:</span> <span class="attr">https://github.com/simple/config-repo</span></span><br><span class="line"><span class="attr">            special:</span></span><br><span class="line"><span class="attr">              pattern:</span> <span class="string">special*/dev*,special*/test*</span></span><br><span class="line"><span class="attr">              uri:</span> <span class="attr">https://github.com/special/config-repo</span></span><br><span class="line"><span class="attr">            local:</span></span><br><span class="line"><span class="attr">              pattern:</span> <span class="string">local*</span></span><br><span class="line"><span class="attr">              uri:</span> <span class="attr">file:/home/configsvc/config-repo</span></span><br></pre></td></tr></table></figure><p>如果没有指定模式，则会使用/*，即匹配所有模式。</p><p><code>spring.cloud.config.server.git.uri</code>是默认的git uri，如果<code>{application}/{profile}</code>没有匹配到任何模式，则会使用默认的git uri。</p><p>在上面的例子中，simple/<em>模式只匹配simple应用的所有环境。special则匹配special开头的dev和test环境的配置。`local/</em>`匹配任何以local开头任意profile的配置。</p><p>在上面的例子中，/special/dev会匹配到special-dev.yml，/special/default则会匹配到默认的application.yml。即上面说的，如果没有匹配到，会使用默认的git uri。</p><p>上面的配置中，repos其实是一个数组。所以如果使用yml也可以下面这样配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          repos:</span></span><br><span class="line"><span class="attr">            development:</span></span><br><span class="line"><span class="attr">              pattern:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">'*/development'</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">'*/staging'</span></span><br><span class="line"><span class="attr">              uri:</span> <span class="attr">https://github.com/development/config-repo</span></span><br><span class="line"><span class="attr">            staging:</span></span><br><span class="line"><span class="attr">              pattern:</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">'*/qa'</span></span><br><span class="line"><span class="bullet">                -</span> <span class="string">'*/production'</span></span><br><span class="line"><span class="attr">              uri:</span> <span class="attr">https://github.com/staging/config-repo</span></span><br></pre></td></tr></table></figure><h3 id="3-搜索路径"><a href="#3-搜索路径" class="headerlink" title="3.搜索路径"></a>3.搜索路径</h3><p>每个Git repo还可以选择将配置文件存储在子目录中，搜索这些目录的模式可以指定为searchPaths。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          searchPaths:</span> <span class="string">foo,bar*</span></span><br></pre></td></tr></table></figure><p>在这个例子中，Spring Cloud Config Server将会在/config-repo，/config-repo/foo和/config-repo/bar*开头的位置查找。</p><h3 id="4-clondOnStart"><a href="#4-clondOnStart" class="headerlink" title="4.clondOnStart"></a>4.clondOnStart</h3><p>默认情况下，Spring Cloud Config Server会在第一次请求配置时克隆远程仓库。可以配置在应用启动时就克隆远程仓库，这样首次请求配置就会快一些响应。</p><p>比如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://git/common/config-repo.git</span></span><br><span class="line"><span class="attr">          repos:</span></span><br><span class="line"><span class="attr">            team-a:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-a-*</span></span><br><span class="line"><span class="attr">                cloneOnStart:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-a/config-repo.git</span></span><br><span class="line"><span class="attr">            team-b:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-b-*</span></span><br><span class="line"><span class="attr">                cloneOnStart:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-b/config-repo.git</span></span><br><span class="line"><span class="attr">            team-c:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-c-*</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-a/config-repo.git</span></span><br></pre></td></tr></table></figure><p>在上面的配置中，team-a的配置在应用启动时就会从远程仓库克隆。其他的仓库在首次请求配置时从远程仓库克隆。</p><p>上面的cloneOnStart也可以配置为全局，即在spring.cloud.config.server.git.cloneOnStart=true。配置了全局的cloneOnStart，则子repo没有配置时使用全局配置，如果子repo配置了，则使用子repo的配置。</p><blockquote><p>设置cloneOnStart为true有助于在Spring Cloud Config Server启动时快速识别配资源的错误，比如仓库URI错误。这样就不至于在首次请求配置时才去检查到配置错误。</p></blockquote><h3 id="5-配置Git仓库的用户名和密码"><a href="#5-配置Git仓库的用户名和密码" class="headerlink" title="5.配置Git仓库的用户名和密码"></a>5.配置Git仓库的用户名和密码</h3><p>如果git仓库时私有的，那么就需要用户名和密码才能访问。在配置git仓库URI时指定username和password即可。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          username:</span> <span class="string">trolley</span></span><br><span class="line"><span class="attr">          password:</span> <span class="string">strongpassword</span></span><br></pre></td></tr></table></figure><h3 id="6-搜索路径中的通配符"><a href="#6-搜索路径中的通配符" class="headerlink" title="6.搜索路径中的通配符"></a>6.搜索路径中的通配符</h3><p>Spring Cloud Config Server还支持带有{application}和{profile}（以及{label}的占位符的搜索路径。</p><p>例如：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          searchPaths:</span> <span class="string">'&#123;application&#125;'</span></span><br></pre></td></tr></table></figure><p>在仓库中搜索与目录同名的文件（包括顶级目录/）。通配符在带占位符的搜索路径中也有效（搜索中包含任何匹配的目录）。</p><h3 id="7-强制从Git仓库拉取更新"><a href="#7-强制从Git仓库拉取更新" class="headerlink" title="7.强制从Git仓库拉取更新"></a>7.强制从Git仓库拉取更新</h3><p>如前所述，Spring Cloud Config Server会克隆远程git存储库，并且如果本地副本变得脏了（例如，OS进程更改了文件夹内容），那么Spring Cloud Config Server无法从远程存储库更新本地副本。</p><p>为了解决这个问题，有一个强制拉动属性，如果本地副本很脏，它将使Spring Cloud Config Server从远程存储库强行拉取。 例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          force-pull:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果您有多个存储库配置，则可以为每个存储库配置force-pull属性。 例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://git/common/config-repo.git</span></span><br><span class="line"><span class="attr">          force-pull:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          repos:</span></span><br><span class="line"><span class="attr">            team-a:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-a-*</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-a/config-repo.git</span></span><br><span class="line"><span class="attr">                force-pull:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            team-b:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-b-*</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-b/config-repo.git</span></span><br><span class="line"><span class="attr">                force-pull:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">            team-c:</span></span><br><span class="line"><span class="attr">                pattern:</span> <span class="string">team-c-*</span></span><br><span class="line"><span class="attr">                uri:</span> <span class="attr">http://git/team-a/config-repo.git</span></span><br></pre></td></tr></table></figure><blockquote><p><code>force-pull</code>默认值是false。</p></blockquote><h3 id="8-删除Git存储库中未跟踪的分支"><a href="#8-删除Git存储库中未跟踪的分支" class="headerlink" title="8.删除Git存储库中未跟踪的分支"></a>8.删除Git存储库中未跟踪的分支</h3><p>由于Spring Cloud Config Server在签出分支到本地存储库后具有远程git存储库的克隆（例如，通过标签获取属性），它将永久保留此分支或直到下一个服务器重新启动（这将创建新的本地存储库）。 因此可能存在删除远程分支但仍然可以获取其本地副本的情况。 如果Spring Cloud Config Server客户端服务以–spring.cloud.config.label = deletedRemoteBranch启动，那么它将从deletedRemoteBranch本地分支获取属性，但不从master获取属性。</p><p>为了保持本地存储库分支的清洁和远程 - 可以设置deleteUntrackedBranches属性。 它将使Spring Cloud Config Server强制从本地存储库中删除未跟踪的分支。 例：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    config:</span></span><br><span class="line"><span class="attr">      server:</span></span><br><span class="line"><span class="attr">        git:</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">https://github.com/spring-cloud-samples/config-repo</span></span><br><span class="line"><span class="attr">          deleteUntrackedBranches:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><blockquote><p><code></code>deleteUntrackedBranches<code></code>默认值为false。</p></blockquote><h2 id="Spring-Cloud-Config-Client基础使用"><a href="#Spring-Cloud-Config-Client基础使用" class="headerlink" title="Spring Cloud Config Client基础使用"></a>Spring Cloud Config Client基础使用</h2><p>可以参考<code>springcloud系列13——实现分布式配置管理</code>一节有使用的demo。</p><p>1.maven依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2.bootstrap.properties</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.uri=http://127.0.0.1:$&#123;config.port:8888&#125;</span><br><span class="line">spring.cloud.config.name=cloud-config</span><br><span class="line">spring.cloud.config.profile=$&#123;config.profile:dev&#125;</span><br></pre></td></tr></table></figure><p>指定spring cloud config server的地址，应用名称和环境。</p><p>然后就可以使用配置属性了。如果是配置文件中使用，使用${配置项name}即可，比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#DB Configuration:</span><br><span class="line">spring.datasource.driverClassName = com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url = $&#123;mysqldb.datasource.url&#125;</span><br><span class="line">spring.datasource.username = $&#123;mysqldb.datasource.username&#125;</span><br><span class="line">spring.datasource.password = $&#123;mysqldb.datasource.password&#125;</span><br></pre></td></tr></table></figure><p>如果是在java属性中，使用@Value(“${配置项那么}”)即可。</p><blockquote><p>注意：config server的uri的配置必须配置在bootstrap文件中，否则会出错。比如你config server应用端口为8080，你config server的uri配置为<a href="http://localhsot:8080，实际启动时会发现是8888端口。">http://localhsot:8080，实际启动时会发现是8888端口。</a></p><p>这是因为bootstrap文件也有一个端口，默认为8888，在应用启动时会先读取bootstrap的配置。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zuul的过滤器</title>
      <link href="/2018/07/07/springcloud%E7%B3%BB%E5%88%9724%E2%80%94%E2%80%94Zuul%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8/"/>
      <url>/2018/07/07/springcloud%E7%B3%BB%E5%88%9724%E2%80%94%E2%80%94Zuul%E7%9A%84%E8%BF%87%E6%BB%A4%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Zuul的过滤器"><a href="#Zuul的过滤器" class="headerlink" title="Zuul的过滤器"></a>Zuul的过滤器</h2><h3 id="Zuul过滤器简介"><a href="#Zuul过滤器简介" class="headerlink" title="Zuul过滤器简介"></a>Zuul过滤器简介</h3><p>spring cloud Zuul包含了对请求的路由和过滤2个功能。路由功能负责将请求转发到具体的微服务上，而过滤器负责对请求的处理过程进行干预，是实现权限校验、服务聚合等功能的基础。</p><p>在实际运行时，路由映射和请求转发是由几个不同的过滤器完成的。每一个进入zuul的http请求都会经过一系列的过滤器处理链得到请求响应并返回给客户端。 </p><p>spring cloud zuul包含4种类型的过滤器。</p><ul><li>pre过滤器。在请求被路由之前调用。Zuul请求微服务之前。比如请求身份验证，选择微服务实例，记录调试信息等。</li><li>route过滤器。负责转发请求到微服务。原始请求在此构建，并使用Apache HttpClient或Netflix Ribbon发送原始请求。</li><li>post过滤器。在route和error过滤器之后被调用。可以在响应添加标准HTTP Header、收集统计信息和指标，以及将响应发送给客户端等。</li><li>error过滤器。在处理请求发生错误时被调用。</li></ul><a id="more"></a><p>除了默认的Filter，Zuul还允许我们创建自定义的过滤器类型。比如，我们可以自定义一个STATIC类型的过滤器，它在Zuul中生成响应，而不是将请求转发给具体的微服务。</p><p>Zuul请求的生命周期如下：  </p><p><img src="http://omh46px9n.bkt.clouddn.com/blog/180707/H0aKaaIH1I.png?imageslim" alt="mark"></p><p>参考<a href="https://github.com/Netflix/zuul/wiki/How-it-Works">Netflix Zuul wiki</a></p><h3 id="自定义Zuul过滤器"><a href="#自定义Zuul过滤器" class="headerlink" title="自定义Zuul过滤器"></a>自定义Zuul过滤器</h3><p>新建模块microservice-gateway-zuul-filter。</p><p>添加Zuul和Eureka客户端的依赖：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>application.yml:</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-gateway-zuul-filter</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8809</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    user1:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">microservice-springcloud-user</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">com.netflix:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><p>定义一个pre类型的过滤器，记录请求的URI。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyZuulPreFilter</span> <span class="keyword">extends</span> <span class="title">ZuulFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger LOGGER = org.slf4j.LoggerFactory.getLogger(MyZuulPreFilter.class);</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filterType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"pre"</span>; <span class="comment">// 指定过滤器类型</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">filterOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// 过滤器顺序，数字越小越先执行</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// 是否使用该过滤器。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤器具体执行的操作</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpServletRequest request = RequestContext.getCurrentContext().getRequest();</span><br><span class="line">        String requestUri = request.getRequestURI();</span><br><span class="line">        LOGGER.info(<span class="string">"请求的URI：&#123;&#125;"</span>,requestUri);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>spring boot主类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulFilterApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulFilterApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyZuulPreFilter <span class="title">myZuulPreFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyZuulPreFilter();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：  </p><p>启动Eureka Server、user模块和microservice-gateway-zuul-filter。</p><p>我们通过Zuul的host和port访问user模块的/sample/1.</p><p><img src="http://omh46px9n.bkt.clouddn.com/blog/180707/7kEBDlj92f.png?imageslim" alt="mark"></p><p>我们看下控制台。</p><p><img src="http://omh46px9n.bkt.clouddn.com/blog/180707/2JFl2E1de7.png?imageslim" alt="mark"></p><p>我们只是简单记录一下请求的URI。更多的用法可以参考netflix-core包中的ZuulFilter实现。</p><p><img src="http://omh46px9n.bkt.clouddn.com/blog/180707/7agK4H6hIL.png?imageslim" alt="mark"></p><p>Zuul过滤器的详细使用可以参考：<a href="https://www.jianshu.com/p/ff863d532767">https://www.jianshu.com/p/ff863d532767</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列23——非JVM语言支持之sidebar</title>
      <link href="/2018/07/07/springcloud%E7%B3%BB%E5%88%9723%E2%80%94%E2%80%94%E9%9D%9EJVM%E8%AF%AD%E8%A8%80%E6%94%AF%E6%8C%81%E4%B9%8Bsidebar/"/>
      <url>/2018/07/07/springcloud%E7%B3%BB%E5%88%9723%E2%80%94%E2%80%94%E9%9D%9EJVM%E8%AF%AD%E8%A8%80%E6%94%AF%E6%8C%81%E4%B9%8Bsidebar/</url>
      
        <content type="html"><![CDATA[<h2 id="Sidebar简介"><a href="#Sidebar简介" class="headerlink" title="Sidebar简介"></a>Sidebar简介</h2><p>Sidecar是作为一个代理的服务来间接性的让其他语言可以使用Eureka等相关组件。通过与Zuul的来进行路由的映射，从而可以做到服务的获取，然后可以使用Ribbon，Feign对服务进行消费，以及对Config Server的间接性调用。</p><p>你是否想要在非jvm的语言中利用（间接性使用）Eureka，Ribbon以及Config Server？Spring Cloud Netflix Sidecar的设计灵感来自Netflix Prana。它包含一个简单的http api去获取一个已知服务的所有实例(例如主机和端口)。你也可以通过嵌入的Zuul代理(Zuul中有一个代理功能)对代理的服务进行调用，Zuul从Eureka服务注册中心获取所有的路由记录(route entries)。通过host发现(host lookup)或者Zuul代理可以直接访问Spring Cloud Config。非jvm需要应该实现一个健康检查，Sidecar能够以此来报告给Eureka注册中心该应用是up还是down状态。<br><a id="more"></a><br>在你的项目中使用Sidecar，需要添加依赖，其group为org.springframework.cloud，artifact id为spring-cloud-netflix-sidecar。(这是以maven依赖的方式)</p><p>启用Sidecar，创建一个Spring Boot应用程序，并在在应用主类上加上@EnableSidecar注解。该注解包含@EnableCircuitBreaker, @EnableDiscoveryClient以及@EnableZuulProxy。Run the resulting application on the same host as the non-jvm application. (这句不太会翻译，我的理解为：在与非jvm应用程序相同的主机上运行生成的应用程序)注：这里的生成应该是通过代理产生的服务。</p><p>配置Sidecar，在application.yml中添加sidecar.port和sidecar.health-uri。sidecar.port属性是非jre程序监听的端口号，这就是Sidecar可以正确注册应用到Eureka的原因。sidecar.health-uri是非jre应用提供的一个对外暴露的可访问uri地址，在该地址对应的接口中需要实现一个模仿Spring Boot健康检查指示器的功能。它需要返回如下的json文档。(注：通过返回一个json，其用status字段来标识你的应用的服务状态，是up还是down，sidecar会将该状态报告给eureka注册中心从而实现你的服务的状态可用情况。简单的说就是用来控制sidecar代理服务的状态！)</p><p>health-uri-document.(heal-uri指向的接口地址需要返回的json文档)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;status&quot;:&quot;UP&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里是一个Sidecar应用程序的application.yml配置示例：<br>application.yml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 5678</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: sidecar</span><br><span class="line"></span><br><span class="line">sidecar:</span><br><span class="line">  port: 8000</span><br><span class="line">  health-uri: http://localhost:8000/health.json</span><br></pre></td></tr></table></figure></p><p>API DiscoveryClient.getInstances()所对应的访问方式是/hosts/{serviceId}，这是访问/hosts/customers后的响应示例，它返回了两个不同主机上的实例(可以看到主机地址不一样)。<br>非jre程序可以访问这个api，如果sidecar的端口号为5678，那么完整url则为：<a href="http://localhost:5678/hosts/{serviceId}">http://localhost:5678/hosts/{serviceId}</a>.</p><p>/hosts/customers.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;host&quot;: &quot;myhost&quot;,</span><br><span class="line">        &quot;port&quot;: 9000,</span><br><span class="line">        &quot;uri&quot;: &quot;http://myhost:9000&quot;,</span><br><span class="line">        &quot;serviceId&quot;: &quot;CUSTOMERS&quot;,</span><br><span class="line">        &quot;secure&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;host&quot;: &quot;myhost2&quot;,</span><br><span class="line">        &quot;port&quot;: 9000,</span><br><span class="line">        &quot;uri&quot;: &quot;http://myhost2:9000&quot;,</span><br><span class="line">        &quot;serviceId&quot;: &quot;CUSTOMERS&quot;,</span><br><span class="line">        &quot;secure&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p><p>Zuul代理会自动为每个在Eureka注册中心上的服务添加路由到/serviceId上，所以上面那个customers的服务可以通过/customers访问。非Jre应用可以通过<a href="http://localhost:5678/customers来访问Customer">http://localhost:5678/customers来访问Customer</a> Service(假设Sidecar的监听端口为5678)</p><p>如果Config Server注册到了Eureka，非jre应用就可以通过Zuul代理访问它。如果ConfigServer的serviceId为configserver并且Sidecar的端口为5678，那么可以通过<a href="http://localhost:5678/configserver">http://localhost:5678/configserver</a> 的方式来访问Config Server。</p><p>非Jvm应用可以利用Config Server的能力来获取Config Server返回的YAML文档，通过访问 <a href="http://sidecar.local.spring.io:5678/configserver/default-master.yml">http://sidecar.local.spring.io:5678/configserver/default-master.yml</a> 就可以获取到类似下面的YAML文档结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka/</span><br><span class="line">  password: password</span><br><span class="line">info:</span><br><span class="line">  description: Spring Cloud Samples</span><br><span class="line">  url: https://github.com/spring-cloud-samples</span><br></pre></td></tr></table></figure></p><p>如上是对spring cloud sidebar相关章节的翻译。<br>spring cloud sidebar官方文档：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__polyglot_support_with_sidecar.html">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__polyglot_support_with_sidecar.html</a></p><p>译文参考：<a href="https://www.cnblogs.com/YrlixJoe/p/7509655.html">https://www.cnblogs.com/YrlixJoe/p/7509655.html</a></p><h2 id="使用Sidebar将nodejs应用引入spring-cloud"><a href="#使用Sidebar将nodejs应用引入spring-cloud" class="headerlink" title="使用Sidebar将nodejs应用引入spring cloud"></a>使用Sidebar将nodejs应用引入spring cloud</h2><p>这里提供了一个nodejs应用，代码如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 引入Http模块</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="comment">// 引入path模块</span></span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="comment">// 引入url模块</span></span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建Server</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 获得请求路径</span></span><br><span class="line">    <span class="keyword">var</span> pathname = url.parse(req.url).pathname;</span><br><span class="line">    res.writeHeader(<span class="number">200</span>,&#123;<span class="string">'Content-Type'</span>: <span class="string">'application/json;charset=utf-8'</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pathname == <span class="string">'/'</span>) &#123;</span><br><span class="line">        res.end(<span class="built_in">JSON</span>.stringify(&#123;<span class="string">'index'</span> : <span class="string">'欢迎来到首页！'</span>&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// /health.json返回&#123;status:'UP'&#125;</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pathname == <span class="string">'/health.json'</span>) &#123;</span><br><span class="line">        res.end(<span class="built_in">JSON</span>.stringify(&#123;<span class="string">'status'</span> : <span class="string">'UP'</span>&#125;));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 其他情况返回404</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        res.end(<span class="string">'404'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">8050</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'nodejs is listening on port 8050.'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>有如下映射关系：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">localhost:8050/ ==&gt; &#123;&apos;index&apos; : &apos;欢迎来到首页！&apos;&#125;</span><br><span class="line">localhost:8050/health.json ==&gt; &#123;&apos;status&apos; : &apos;UP&apos;&#125;</span><br><span class="line">locahost:8050/其他请求 ==&gt; 404</span><br></pre></td></tr></table></figure></p><p>在Sidebar的介绍中，我们知道需要非jvm应用提供spring boot的健康指标功能，上面/health.json即提供的此功能。</p><p>创建模块microservice-sidecar</p><p>加入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-netflix-sidecar<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring boot主类增加@EnableSidecar<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableSidecar</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SidecarApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(SidecarApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>application.yml增加sidecar配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: microservice-sidecar</span><br><span class="line"></span><br><span class="line">server:</span><br><span class="line">  port: 8807</span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    service-url:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line"></span><br><span class="line">sidecar:</span><br><span class="line">  port: 8050</span><br><span class="line">  health-uri: http://localhost:8050/health.json</span><br></pre></td></tr></table></figure></p><p>启动Eureka server，zuul和microservice-sidecar，以及nodejs的应用。</p><p>然后通过<a href="http://zuulHost:zuulPort/microservice-sidecar就可以访问nodejs应用的[http://localhsot:8050/](http://localhsot:8050/)。">http://zuulHost:zuulPort/microservice-sidecar就可以访问nodejs应用的[http://localhsot:8050/](http://localhsot:8050/)。</a></p><p>通过zuul访问nodejs的服务<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-7/5554123.jpg" alt=""></p><p>nodejs服务<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-7/30503599.jpg" alt="">  </p><p><strong>注意事项：</strong><br>1.非jvm应用需要与sidecar部署在同一台机器上。如果不想部署在同一台机器，可以配置${eureka.instance.hostName}。</p><p>2.每个非jvm应用都需要有一个对应的sidecar应用。这应该是最大的一个问题，sidecar是与业务无关的，如果有很多非jvm的应用，会导致大量的sidecar应用。具体使用时需要评估。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>如何既快速又优雅的写博客：Typora + MPic</title>
      <link href="/2018/07/07/%E5%A6%82%E4%BD%95%E6%97%A2%E5%BF%AB%E9%80%9F%E5%8F%88%E4%BC%98%E9%9B%85%E7%9A%84%E5%86%99%E5%8D%9A%E5%AE%A2%EF%BC%9ATypora%20+%20MPic/"/>
      <url>/2018/07/07/%E5%A6%82%E4%BD%95%E6%97%A2%E5%BF%AB%E9%80%9F%E5%8F%88%E4%BC%98%E9%9B%85%E7%9A%84%E5%86%99%E5%8D%9A%E5%AE%A2%EF%BC%9ATypora%20+%20MPic/</url>
      
        <content type="html"><![CDATA[<h2 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h2><p>Typora，一款简单到极致的MarkDown编辑器 </p><p><a href="https://www.typora.io/">https://www.typora.io/</a> </p><p>MPic，一款支持多种上传方式且自动生成MarkDown链接的图床工具 </p><p><a href="http://mpic.lzhaofu.cn/">http://mpic.lzhaofu.cn/</a> </p><h2 id="创建七牛云空间"><a href="#创建七牛云空间" class="headerlink" title="创建七牛云空间"></a>创建七牛云空间</h2><p><strong>一、注册并登录七牛云</strong> </p><p><a href="https://portal.qiniu.com/signup/choice">https://portal.qiniu.com/signup/choice</a> </p><p>选择个人账户，需要注意的是个人网站可以填写博客地址。 </p><p><strong>二、实名认证</strong> </p><p><a href="https://portal.qiniu.com/identity/personal">https://portal.qiniu.com/identity/personal</a> </p><p><strong>三、创建空间</strong> </p><p><a href="https://portal.qiniu.com/create">https://portal.qiniu.com/create</a> </p><p>添加对象存储 </p><p>命名空间，点击创建 </p><p>得到该空间的外链域名 </p><p>点击面板中的密钥管理 </p><p>记录AK，SK的值，以备后续填写 </p><p><strong>四、设置MPic</strong></p><ul><li><p>进入设置账号，填写上述得到的信息，点击保存</p><p><img src="http://omh46px9n.bkt.clouddn.com/blog/180707/d781fc6jkF.png?imageslim" alt="mark"></p></li></ul><p><strong>五、几种上传方式</strong></p><ul><li>将本地图片直接拖拽到窗口上传</li><li>选中本地图片，<code>Ctrl+C</code>，直接上传</li><li>使用QQ截图，<code>Ctrl+Alt+A</code>，复制图片后上传</li></ul><p>参考：<a href="https://blog.csdn.net/u011262253/article/details/78834824">https://blog.csdn.net/u011262253/article/details/78834824</a></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列22——Zuul简介及代码示例</title>
      <link href="/2018/07/05/springcloud%E7%B3%BB%E5%88%9722%E2%80%94%E2%80%94Zuul%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/"/>
      <url>/2018/07/05/springcloud%E7%B3%BB%E5%88%9722%E2%80%94%E2%80%94Zuul%E7%AE%80%E4%BB%8B%E5%8F%8A%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Zuul简介"><a href="#Zuul简介" class="headerlink" title="Zuul简介"></a>Zuul简介</h2><p>spring cloud官方文档地址：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__router_and_filter_zuul.html">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__router_and_filter_zuul.html</a></p><p>路由是微服务架构的组成部分。 例如，/可以映射到您的Web应用程序，/ api/users映射到用户服务，/api/shop映射到商店服务。 Zuul是Netflix基于JVM的路由器和服务器端负载均衡器。</p><p>Netflix使用Zuul进行以下操作：<br>认证<br>洞察<br>压力测试<br>金丝雀测试<br>动态路由<br>服务迁移<br>负载脱落<br>安全<br>静态响应处理<br>主动/主动流量管理  </p><p>Zuul的规则引擎允许任何JVM语言编写规则和过滤器，内置支持Java和Groovy。</p><p>配置属性zuul.max.host.connections已被两个新属性zuul.host.maxTotalConnections和zuul.host.maxPerRouteConnections取代，它们分别默认为200和20。</p><p>所有路由的默认Hystrix隔离模式（ExecutionIsolationStrategy）是SEMAPHORE。 如果首选此隔离模式，则可以将zuul.ribbonIsolationStrategy更改为THREAD。<br><a id="more"></a></p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>这里新建一个模块microservice-gateway-zuul。</p><p>1.引入zuul和eureka client的依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-zuul<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring cloud文档有说，Zuul starter没有包含discovery client，所以我们在上面增加了eureka client的依赖。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-5/32367881.jpg" alt=""></p><p>2.在Spring boot的主类上增加注解@EnableZuulProxy<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.application.yml配置<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-gateway-zuul</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8808</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>1.启动Eureka server；<br>2.启动user微服务；<br>3.启动zuul模块。</p><p>在user模块，有/sample/1获取用户信息的接口。</p><p>浏览器请求<a href="http://10.41.3.149:8808/microservice-springcloud-user/sample/1">http://10.41.3.149:8808/microservice-springcloud-user/sample/1</a>。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-5/96711742.jpg" alt=""></p><p>可以看到，请求成功。<br>我们看Zuul模块的控制台日志，可以看到下面的日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Mapped URL path [/microservice-springcloud-user/**] onto handler of type [class org.springframework.cloud.netflix.zuul.web.ZuulController]</span><br></pre></td></tr></table></figure></p><h3 id="自定义请求路径"><a href="#自定义请求路径" class="headerlink" title="自定义请求路径"></a>自定义请求路径</h3><p>通过Eureka server中的serviceID可以请求成功，但名字太长，如何自定义？  </p><p>比如我们想通过/user/sample/1访问，如何做到？</p><p>在application.yml增加下面的配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span> <span class="string">/user/**</span></span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-5/42034948.jpg" alt=""></p><h3 id="Zuul忽略某些服务"><a href="#Zuul忽略某些服务" class="headerlink" title="Zuul忽略某些服务"></a>Zuul忽略某些服务</h3><p>比如有user和movie2个服务，但我只想Zuul代理user服务。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">'*'</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span> <span class="string">/user/**</span></span><br></pre></td></tr></table></figure></p><p>ignoredServices:*忽略所有的服务，然后在routes中指定了user，所以最终就是Zuul代理user服务。</p><p>或者：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line">  <span class="comment"># 多个服务id之间用逗号分隔</span></span><br><span class="line"><span class="attr">  ignoredServices:</span> <span class="string">microservice-springcloud-movie</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span> <span class="string">/user/**</span></span><br></pre></td></tr></table></figure></p><h3 id="Zuul指定path和serviceId"><a href="#Zuul指定path和serviceId" class="headerlink" title="Zuul指定path和serviceId"></a>Zuul指定path和serviceId</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line">    <span class="comment"># 下面的user1只是一个标识，保证唯一即可</span></span><br><span class="line"><span class="attr">    user1:</span></span><br><span class="line">      <span class="comment"># 映射的路径</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line">      <span class="comment"># 服务id</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">microservice-springcloud-user</span></span><br></pre></td></tr></table></figure><p>上面的配置意思是：让Zuul代理microservice-springcloud-user，路径为/user/**，user1可以随便写，只要保证唯一即可。</p><p>然后通过<a href="http://10.41.3.149:8808/user/sample/1">http://10.41.3.149:8808/user/sample/1</a>请求即可。</p><h3 id="Zuul指定path-url"><a href="#Zuul指定path-url" class="headerlink" title="Zuul指定path+url"></a>Zuul指定path+url</h3><p>除了上面说的指定path+serviceId外，还可以使用path+url的配置。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    user1:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line">      <span class="comment"># url为user服务的url</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">http://10.41.3.149:7902</span></span><br></pre></td></tr></table></figure></p><p>然后通过<a href="http://10.41.3.149:8808/user/sample/1">http://10.41.3.149:8808/user/sample/1</a>请求即可。</p><h3 id="Zuul指定可用服务的负载均衡"><a href="#Zuul指定可用服务的负载均衡" class="headerlink" title="Zuul指定可用服务的负载均衡"></a>Zuul指定可用服务的负载均衡</h3><p>在spring cloud的文档中有写，如果使用上面的path+url配置，不会作为HystrixCommand执行，也不会使用Ribbon对多个URL进行负载均衡。 要实现此目的，您可以使用静态服务器列表指定serviceId。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    user1:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      serviceId:</span> <span class="string">microservice-springcloud-user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在Ribbon中禁用eureka</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="attr">  eureka:</span></span><br><span class="line"><span class="attr">   enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    listOfServers:</span> <span class="attr">localhost:7901,localhost:7902</span></span><br></pre></td></tr></table></figure></p><p>如上，需要在ribbon中禁用Eureka。然后指定了2个user服务，端口分别为7901，7902。</p><p>仍然是通过<a href="http://localhost:8808/user/sample/1">http://localhost:8808/user/sample/1</a>来访问。访问多次，可以在控制台看到SQL打印，是轮询调用7901和7902的。</p><h3 id="Zuul使用正则表达式指定路由规则"><a href="#Zuul使用正则表达式指定路由规则" class="headerlink" title="Zuul使用正则表达式指定路由规则"></a>Zuul使用正则表达式指定路由规则</h3><p>您可以使用regexmapper在serviceId和路由之间提供约定。 它使用名为groups的正则表达式从serviceId中提取变量并将它们注入路由模式。</p><p>将user服务id修改为<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-springcloud-user-v1</span></span><br></pre></td></tr></table></figure></p><p>zuul模块application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-gateway-zuul</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8808</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>Zuul主类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PatternServiceRouteMapper <span class="title">serviceRouteMapper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 第一个参数：servicePattern，第2个参数routePattern</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PatternServiceRouteMapper(</span><br><span class="line">                <span class="string">"(?&lt;name&gt;^.+)-(?&lt;version&gt;v.+$)"</span>,</span><br><span class="line">                <span class="string">"$&#123;version&#125;/$&#123;name&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>上面的PatternServiceRouteMapper意思是myusers-v1将映射为/v1/myusers/**。</p><p>接受任何正则表达式，但所有命名组必须同时出现在servicePattern和routePattern中。</p><p>如果servicePattern与serviceId不匹配，则使用默认行为。比如user的serviceId为microservice-springcloud-user，那么实际上最终是通过<a href="http://localhost:zuul端口/microservice-springcloud-user/**来访问。">http://localhost:zuul端口/microservice-springcloud-user/**来访问。</a></p><p>在上面的示例中，serviceId“myusers”将映射到路由“/myusers/**”（在未检测到版本时）默认情况下禁用此功能，仅适用于已发现的服务。</p><p>然后浏览器可以通过[<a href="http://localhost:zuul端口]/v1/microservice-springcloud-user/sample/1来访问user服务。">http://localhost:zuul端口]/v1/microservice-springcloud-user/sample/1来访问user服务。</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-7-5/5562039.jpg" alt=""></p><h3 id="为所有映射增加前缀"><a href="#为所有映射增加前缀" class="headerlink" title="为所有映射增加前缀"></a>为所有映射增加前缀</h3><p>要为所有映射添加前缀，请将zuul.prefix设置为值，例如/ api。 在默认情况下转发请求之前，会从请求中删除代理前缀（使用zuul.stripPrefix = false关闭此行为）。 </p><p>在application.yml增加<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  prefix:</span> <span class="string">/api</span></span><br></pre></td></tr></table></figure></p><p>然后通过<a href="http://localhost:Zuul端口/api/microservice-springcloud-user/sample/1来访问。">http://localhost:Zuul端口/api/microservice-springcloud-user/sample/1来访问。</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-7-5/81391687.jpg" alt=""></p><p>上面是一种全局的设置方式。可以通过zuul.stripPrefix=true/false来设置在请求具体的服务时是否剥离前缀。比如访问/api/sample/1，如果zuul.stripPrefix设置为true（默认为true），则实际请求用户服务的是/sample/1，相反请求路径是/api/sample/1.</p><p>您还可以关闭从各个路由中剥离特定于服务的前缀，例如：<br>假定user服务中指定了context-path为/user，我们访问/sample/1是通过/user/sample/1来访问的。现在我想通过<a href="http://localhost:zuul端口/user/sample/1来访问，可以这样做：">http://localhost:zuul端口/user/sample/1来访问，可以这样做：</a><br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>或者：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">      prefix:</span> <span class="string">/user</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>stripPrefix是剥离前缀的意思，设置为false就是不剥离前缀，Zuul默认是剥离前缀的。比如我们设置path=/user/**，比如访问/user/sample/1，实际请求用户服务的是/sample/1。</p><blockquote><p>stripPrefix比较实用的场景是服务带有context-path。</p></blockquote><p>zuul.stripPrefix仅适用于zuul.prefix中设置的前缀。 它对给定路由的路径中定义的前缀没有任何影响。</p><h3 id="Zuul忽略指定的路径"><a href="#Zuul忽略指定的路径" class="headerlink" title="Zuul忽略指定的路径"></a>Zuul忽略指定的路径</h3><p>上面说过了，通过ignoredServices可以指定忽略某些服务，这是比较粗粒度的控制。如果想细粒度的控制忽略某些路径，可以通过下面的方式：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  ignoredPatterns:</span> <span class="string">/**/admin/**</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    users:</span> <span class="string">/myusers/**</span></span><br></pre></td></tr></table></figure></p><p>这意味着所有诸如“/myusers/101”之类的请求将被转发到“users”服务上的“/101”。 但包括“/admin/”在内的请求则不会处理。</p><h3 id="Zuul指定路由的顺序"><a href="#Zuul指定路由的顺序" class="headerlink" title="Zuul指定路由的顺序"></a>Zuul指定路由的顺序</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    legacy:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/**</span></span><br></pre></td></tr></table></figure><p>上面配置的意思是/user**的请求转发到microservice-springcloud-user去处理，其他的请求按默认的方式处理（即通过<a href="http://zuulHost:zuulPort/服务名/请求路径）。">http://zuulHost:zuulPort/服务名/请求路径）。</a><br>比如我们启动了microservice-springcloud-user和microservice-springcloud-movie-feign-without-hystrix2个服务。</p><p>通过Zuul访问microservice-springcloud-user,可以这样访问：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/14781290.jpg" alt=""></p><p>通过Zuul访问microservice-springcloud-movie-feign-without-hystrix需要如下方式访问：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/52751763.jpg" alt=""></p><blockquote><p>如果你需要保证路由的顺序，则需要使用YAML文件，因为使用属性文件就会丢失顺序。所以，如果你用properties文件配置，可能会导致/user/**访问不到microservice-springcloud-user。</p></blockquote><h3 id="Zuul-Http-Client"><a href="#Zuul-Http-Client" class="headerlink" title="Zuul Http Client"></a>Zuul Http Client</h3><p>Zuul默认使用的是Apache的http client。之前使用的是RestClient。如果你还是想使用RestClient，可以设置ribbon.restclient.enabled=true；如果你想使用OkHttp3，可以设置ribbon.okhttp.enabled=true。</p><p>如果要自定义Apache HTTP客户端或OK HTTP客户端，请提供ClosableHttpClient或OkHttpClient类型的bean。</p><h3 id="Cookie和敏感的Headers"><a href="#Cookie和敏感的Headers" class="headerlink" title="Cookie和敏感的Headers"></a>Cookie和敏感的Headers</h3><p>在同一系统中的服务之间共享Headers是可以的，但您可能不希望敏感Headers向下游泄漏到外部服务器。您可以在路由配置中指定忽略的Headers列表。 Cookie起着特殊的作用，因为它们在浏览器中具有明确定义的语义，并且它们始终被视为敏感。如果您的代理的消费者是浏览器，那么下游服务的cookie也会给用户带来问题，因为它们都会混乱（所有下游服务看起来都来自同一个地方）。</p><p>如果您对服务的设计非常小心，例如，如果只有一个下游服务设置了cookie，那么您可以让它们从后端一直流到调用者。此外，如果您的代理设置了cookie并且您的所有后端服务都是同一系统的一部分，那么简单地共享它们就很自然（例如使用Spring Session将它们链接到某个共享状态）。除此之外，由下游服务设置的任何cookie都可能对调用者不是很有用，因此建议您（至少）将“Set-Cookie”和“Cookie”放入敏感的标头中不属于您的域名。即使对于属于您域的路由，在允许cookie在它们与代理之间流动之前，请仔细考虑它的含义。</p><p>可以将敏感报头配置为每个路由的逗号分隔列表，例如，<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/myusers/**</span></span><br><span class="line"><span class="attr">      sensitiveHeaders:</span> <span class="string">Cookie,Set-Cookie,Authorization</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">https://downstream</span></span><br></pre></td></tr></table></figure></p><p>这是sensitiveHeaders的默认值，因此除非您希望它不同，否则无需进行设置。注： 这是Spring Cloud Netflix 1.1中的新功能（在1.0中，用户无法控制Headers，所有Cookie都在所有方向上流动）。</p><p>sensitiveHeaders是黑名单，默认不为空，因此要使Zuul发送所有Headers（“忽略”的Headers除外），您必须将其明确设置为空列表。 如果要将cookie或授权Headers传递给后端，则必须执行此操作。 例：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    users:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/myusers/**</span></span><br><span class="line"><span class="attr">      sensitiveHeaders:</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">https://downstream</span></span><br></pre></td></tr></table></figure></p><p>也可以通过设置zuul.sensitiveHeaders来全局设置敏感的Headers。 如果在路由上设置了sensitiveHeaders，则会覆盖全局sensitiveHeaders设置。</p><h3 id="忽略Headers"><a href="#忽略Headers" class="headerlink" title="忽略Headers"></a>忽略Headers</h3><p>除了每个路由规则上面的敏感头部信息设置，我们还可以在网关与外部服务交互的时候，用一个全局的设置zuul.ignoredHeaders，去除那些我们不想要的http头部信息(包括请求和响应的)。在默认情况下，zuul是不会去除这些信息的。如果Spring Security不在类路径上的话，它们就会被初始化为一组众所周知的“安全”头部信息（例如，涉及缓存），这是由Spring Security指定的。在这种情况下，假设请求网关的服务也会添加头部信息，我们又要得到这些代理头部信息，就可以设置zuul.ignoreSecurityHeaders为false，同时保留Spring Security的安全头部信息和代理的头部信息。当然，我们也可以不设置这个值，仅仅获取来自代理的头部信息。</p><h3 id="路由端点"><a href="#路由端点" class="headerlink" title="路由端点"></a>路由端点</h3><p>Actuator提供了一个可以查看路由规则的端点/routes，我们在Zuul中引入Actuator依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>再把安全验证关闭，让我们可以访问到这个端点：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">management:</span></span><br><span class="line"><span class="attr">  security:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>这里，遗留请求的路由规则会影响到我们访问这个端点，先注释掉这个路由规则：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#legacy:</span></span><br><span class="line">  <span class="comment">#path: /**</span></span><br></pre></td></tr></table></figure></p><p>重启Zuul项目，我们便能看到zuul网关的路由规则了<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/7179772.jpg" alt=""></p><p>如果想知道路由的详细细节，可以增加参数?format=details<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/19453207.jpg" alt=""></p><h3 id="Strangulation-Patterns-绞杀者模式"><a href="#Strangulation-Patterns-绞杀者模式" class="headerlink" title="Strangulation Patterns (绞杀者模式)"></a>Strangulation Patterns (绞杀者模式)</h3><p>迁移现有应用程序或API时的常见模式是“扼杀”旧的端点，慢慢地用不同的实现替换它们。 Zuul代理是一个有用的工具，因为可以使用它来处理来自旧端点的客户端的所有流量，但重定向一些请求到新的端点。</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    first:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/first/**</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">http://first.example.com</span></span><br><span class="line"><span class="attr">    second:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/second/**</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">forward:/second</span></span><br><span class="line"><span class="attr">    third:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/third/**</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">forward:/3rd</span> <span class="comment"># 本地的转发</span></span><br><span class="line"><span class="attr">    legacy:</span> <span class="comment"># 老系统的请求</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/**</span></span><br><span class="line"><span class="attr">      url:</span> <span class="attr">http://legacy.example.com</span></span><br></pre></td></tr></table></figure><p>在这个例子中，我们正在扼杀“遗留”应用程序，该应用程序映射到与其他模式之一不匹配的所有请求。 /first/<strong>中的路径已被提取到具有外部URL的新服务中。 并转发/second/</strong>中的路径，以便可以在本地处理它们，例如， 使用正常的Spring @RequestMapping。 /third/**中的路径也被转发，但具有不同的前缀（即/third/foo被转发到/3rd/foo）。</p><blockquote><p>忽略的模式不会被完全忽略，它们只是不由代理处理（因此它们也可以在本地有效转发）。</p></blockquote><h3 id="通过Zuul上传文件"><a href="#通过Zuul上传文件" class="headerlink" title="通过Zuul上传文件"></a>通过Zuul上传文件</h3><p>新建一个模块microservice-file-upload，该模块用于文件上传。<br>application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">9999</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-file-upload</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><p>上传文件的Controller<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/file"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileUploadController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/upload"</span>,method = RequestMethod.POST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">uploadFile</span><span class="params">(@RequestParam(<span class="string">"file"</span>)</span> MultipartFile file) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String uploadDir = <span class="string">"E:/test/"</span>;</span><br><span class="line">        String originName = file.getOriginalFilename();</span><br><span class="line">        String uploadPath = uploadDir+originName;</span><br><span class="line"></span><br><span class="line">        File destDir = <span class="keyword">new</span> File(uploadDir);</span><br><span class="line">        <span class="keyword">if</span> (!destDir.exists()) &#123;</span><br><span class="line">            destDir.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        File dest = <span class="keyword">new</span> File(uploadPath);</span><br><span class="line">        <span class="keyword">if</span> (dest.exists()) &#123;</span><br><span class="line">            dest.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        file.transferTo(dest);</span><br><span class="line">        System.out.println(<span class="string">"文件上传路径："</span> + uploadPath);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> uploadPath;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里将服务注册到Eureka，是为了后面使用Zuul代理文件上传功能。</p><p>这里用curl测试。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -F &quot;file=@d:/luckystar88/books/java_bloomfilter.rar&quot; http://localhost:9999/file/upload</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/20498759.jpg" alt=""></p><p>可以看到，请求成功。</p><p>刚刚上传的文件大小14Kb，我们上传一个大点的文件（文件大小18.9M）。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/17037246.jpg" alt=""></p><p>出错，看错误信息，提示文件大小19M，超过了配置的最大大小10M。</p><p>解决办法：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-file-upload</span></span><br><span class="line"><span class="attr">  http:</span></span><br><span class="line"><span class="attr">    multipart:</span></span><br><span class="line">      <span class="comment"># 单个文件大小</span></span><br><span class="line"><span class="attr">      max-file-size:</span> <span class="number">1024</span><span class="string">Mb</span></span><br><span class="line">      <span class="comment"># 总上传数据的大小</span></span><br><span class="line"><span class="attr">      max-request-size:</span> <span class="number">2048</span><span class="string">Mb</span></span><br></pre></td></tr></table></figure></p><p>配置上面2项设置文件大小即可。</p><p>重新上传：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/37749859.jpg" alt=""></p><p>现在我们使用Zuul测试。</p><p>修改Zuul的application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-file-upload:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/upload-api/**</span></span><br></pre></td></tr></table></figure></p><p>将/upload-api/**的请求交给microservice-file-upload处理。</p><p>启动Eureka Server，Zuul和file-upload模块。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -F &quot;file=@d:/360极速浏览器下载/111.mp4&quot; http://localhost:8808/zuul/upload-api/file/upload</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/78384826.jpg" alt=""></p><p>可以看到上传成功。</p><p>我们准备一个大点的文件（175M）测试下上传超时。<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="bullet">-F</span> <span class="string">"file=@C:\Users\Administrator\Downloads\Spring+Cloud微服务实战.pdf"</span> <span class="attr">http://localhost:8808/zuul/upload-api/file/upload</span></span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/81090956.jpg" alt=""></p><p>可以看到Zuul报超时了。</p><p>解决办法：<br>在Zuul增加配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds:</span> <span class="number">60000</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="attr">  ConnectTimeout:</span> <span class="number">3000</span></span><br><span class="line"><span class="attr">  ReadTimeout:</span> <span class="number">60000</span></span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/71371840.jpg" alt=""></p><p>重新请求，可以看到上传成功了（文件名乱码就暂时不管了）。</p><h3 id="禁用Zuul-Filters"><a href="#禁用Zuul-Filters" class="headerlink" title="禁用Zuul Filters"></a>禁用Zuul Filters</h3><p>默认会使用很多filters，可采用如下方式禁止<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zuul.SendResponseFilter.post.disable=true</span><br></pre></td></tr></table></figure></p><h3 id="Zuul的回退"><a href="#Zuul的回退" class="headerlink" title="Zuul的回退"></a>Zuul的回退</h3><p>当Zuul中给定路径的电路跳闸时，您可以通过创建ZuulFallbackProvider类型的bean来提供回退响应。 在此bean中，您需要指定回退所针对的路由ID，并提供ClientHttpResponse作为回退返回。</p><p>我们创建一个模块microservice-gateway-zuul-fallback。<br>application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-gateway-zuul-fallback</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8808</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">zuul:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">      path:</span> <span class="string">/user/**</span></span><br><span class="line"><span class="attr">      stripPrefix:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>由于在microservice-springcloud-user服务中指定了context-path，所以这里设置stripPrefix=false。</p><p>spring boot主类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableZuulProxy</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZuulFallbackApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(ZuulFallbackApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>回退类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFallbackProvider</span> <span class="keyword">implements</span> <span class="title">ZuulFallbackProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"microservice-springcloud-user"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClientHttpResponse() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST.value();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.BAD_REQUEST.getReasonPhrase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream((getRoute() + <span class="string">"==》fallback"</span>).getBytes());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">                headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>回退的类中指定了路由为microservice-springcloud-user，同时指定了响应码，响应内容，响应类型等信息。</p><p>测试：</p><p>启动Eureka server，microservice-springcloud-user和microservice-gateway-zuul-fallback。</p><p>user服务正常时访问：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/74752153.jpg" alt=""></p><p>关闭user服务，再次访问：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-6/58750246.jpg" alt=""></p><p>通过/routes访问路由信息：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-7/28667237.jpg" alt=""></p><p>注意：FallbackProvider类中的routes必须与配置文件中的一致。</p><p>如果想为所有的路由设置一个默认的fallback，可以创建一个ZuulFallbackProvider类型的Bean，并且getRoute返回*或null。</p><p>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFallbackProvider</span> <span class="keyword">implements</span> <span class="title">ZuulFallbackProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"*"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClientHttpResponse() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> HttpStatus.OK;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"OK"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(<span class="string">"fallback"</span>.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">                headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果您想根据失败原因选择响应，请使用FallbackProvider，它将取代未来版本中的ZuulFallbackProvder。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFallbackProvider</span> <span class="keyword">implements</span> <span class="title">FallbackProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRoute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"*"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">(<span class="keyword">final</span> Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> HystrixTimeoutException) &#123;</span><br><span class="line">            <span class="keyword">return</span> response(HttpStatus.GATEWAY_TIMEOUT);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> fallbackResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpResponse <span class="title">fallbackResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ClientHttpResponse <span class="title">response</span><span class="params">(<span class="keyword">final</span> HttpStatus status)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClientHttpResponse() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpStatus <span class="title">getStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> status;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRawStatusCode</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> status.value();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> String <span class="title">getStatusText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> status.getReasonPhrase();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> InputStream <span class="title">getBody</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(<span class="string">"fallback"</span>.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> HttpHeaders <span class="title">getHeaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">                headers.setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">                <span class="keyword">return</span> headers;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列20——Turbine聚合各个节点的hystrix.stream</title>
      <link href="/2018/07/03/springcloud%E7%B3%BB%E5%88%9720%E2%80%94%E2%80%94Turbine%E8%81%9A%E5%90%88%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84hystrix.stream/"/>
      <url>/2018/07/03/springcloud%E7%B3%BB%E5%88%9720%E2%80%94%E2%80%94Turbine%E8%81%9A%E5%90%88%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84hystrix.stream/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们在之前讲过，在单个的Hystrix的应用中，我们使用/hystrix.stream可以查看监控数据，如果想以图表的形式更直观的查看监控数据，再结合dashboard就可以了。</p><p>但是，如何同时监控多个应用或集群呢？<br>我们需要使用springcloud提供的Turbine，它是将各个应用的/hystrix.stream进行聚合的组件。我们在dashboard中输入/turbine.stream即可查看所有监控应用的健康情况。</p><p>turbine的官方文档：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__hystrix_timeouts_and_ribbon_clients.html#_turbine">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/multi/multi__hystrix_timeouts_and_ribbon_clients.html#_turbine</a><br><a id="more"></a></p><h2 id="Turbine的使用"><a href="#Turbine的使用" class="headerlink" title="Turbine的使用"></a>Turbine的使用</h2><p>这里新建模块microservice-springcloud-turbine。单纯的使用turbine是很简单的。</p><p>1.引入turbine和Eureka的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-netflix-turbine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.配置turbine<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">turbine:</span><br><span class="line">  aggregator:</span><br><span class="line">    # 指定聚合哪些集群，多个使用&quot;,&quot;分割，默认为default。</span><br><span class="line">    cluster-config: default</span><br><span class="line">  # 配置监控的服务id，多个服务以逗号分隔    </span><br><span class="line">  app-config: microservice-springcloud-movie-feign-with-hystrix,microservice-springcloud-movie-feign-without-hystrix</span><br><span class="line">  clusterNameExpression: new String(&quot;default&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">    instanceId: $&#123;spring.application.name&#125;:$&#123;vcap.application.instance_id:$&#123;spring.application.instance_id:$&#123;random.value&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>turbine配置参数：  </p><blockquote><p>1.turbine.app-config=ribbon-consumer指定了要监控的应用名字为ribbon-consumer<br>2.turbine.cluster-name-expression=”default”,表示集群的名字为default<br>3.turbine.combine-host-port=true表示同一主机上的服务通过host和port的组合来进行区分，默认情况下是使用host来区分，这样会使本地调试有问题</p></blockquote><p>3.在启动类增加@EnableTurbine<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableTurbine</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TurbineApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(TurbineApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4.Dashboard的使用<br>在《springcloud系列16——Hystrix Health Indicator及Metrics Stream》已经说过了。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>a.启动Eureka Server应用；<br>b.启动user服务，因为要监控的应用使用它；<br>c.启动microservice-springcloud-movie-feign-with-hystrix,microservice-springcloud-movie-feign-without-hystrix这2个服务，其中microservice-springcloud-movie-feign-with-hystrix修改配置的端口启动2个服务；<br>d.启动turebine应用；<br>e.启动dashboard应用。</p><p>测试步骤：<br>1.检查microservice-springcloud-movie-feign-with-hystrix,microservice-springcloud-movie-feign-without-hystrix这2个服务的/hystrix.stream是否能够访问；</p><p>2.检查/turbine.stream是否可以访问；</p><p>3.分别访问microservice-springcloud-movie-feign-with-hystrix,microservice-springcloud-movie-feign-without-hystrix这2个服务的/user/1请求（依赖user的服务），然后看/turbine.stream是否输出了类似下面的数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">: ping</span><br><span class="line">data: &#123;&quot;reportingHostsLast10Seconds&quot;:3,&quot;name&quot;:&quot;meta&quot;,&quot;type&quot;:&quot;meta&quot;,&quot;timestamp&quot;:1530633245374&#125;</span><br></pre></td></tr></table></figure></p><p>如上，表示10秒内上报的主机数量为3.</p><p>4./访问dashboard应用的/hystrix，输入/turbine.stream的地址。<br>可以看到下面的页面<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-3/81256.jpg" alt="">  </p><p>参数说明：<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-3/71023251.jpg" alt=""></p><p>5.将user服务关闭，频繁刷新某个服务，然后看dashboard<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-4/6258812.jpg" alt=""><br>可以看到，显示断路器1个打开，2个关闭。因为我们只是访问了1个服务，所以其他没访问的2个服务断路器状态还是关闭的。</p><p>如果我另外一个服务也频繁访问让断路器打开，在dashboard页面就会看到2个处理打开状态。</p><p>不过有个问题，我将某个服务关闭，dashboard仍然显示的3个Hosts，但你看/turbine.stream，其实上报的hosts只有2个。<br><img src="http://omh46px9n.bkt.clouddn.com/18-7-4/52613008.jpg" alt=""></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="hystrix-stream-404-问题"><a href="#hystrix-stream-404-问题" class="headerlink" title="hystrix.stream 404 问题"></a>hystrix.stream 404 问题</h3><p>参考：<a href="http://www.voidcc.com/content/spring-boot-hystrix-stream-404">http://www.voidcc.com/content/spring-boot-hystrix-stream-404</a>。</p><p>Feign是对Hystrix支持的，所以不用增加Hystrix的依赖。但是，如果要使用dashboard则需要引入hystrix的依赖。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 整合hystrix，其实feign中自带了hystrix，引入该依赖主要是为了使用其中的hystrix-metrics-event-stream，用于dashboard --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>并且在Application类中增加如下代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">getServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HystrixMetricsStreamServlet streamServlet = <span class="keyword">new</span> HystrixMetricsStreamServlet();</span><br><span class="line">    ServletRegistrationBean registrationBean = <span class="keyword">new</span> ServletRegistrationBean(streamServlet);</span><br><span class="line">    registrationBean.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">    registrationBean.addUrlMappings(<span class="string">"/hystrix.stream"</span>);</span><br><span class="line">    registrationBean.setName(<span class="string">"HystrixMetricsStreamServlet"</span>);</span><br><span class="line">    <span class="keyword">return</span> registrationBean;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p><p>这样启动后通过<a href="http://ip:port/hystrix.stream即可访问。">http://ip:port/hystrix.stream即可访问。</a></p><p>PS：这里springcloud使用的是1.4.2.RELEASE版本。</p><h3 id="Turbine-stream的reportingHostsLast10Seconds为0"><a href="#Turbine-stream的reportingHostsLast10Seconds为0" class="headerlink" title="Turbine.stream的reportingHostsLast10Seconds为0"></a>Turbine.stream的reportingHostsLast10Seconds为0</h3><p>启动Turbine的应用后，可以通过<a href="http://ip:port/turbine.stream来查看Turbine收集监控数据。turbine的作用是聚合各个/hystrix.stream的监控数据，在单个的hystrix.stream都正常后，turbine.stream收集的上报的hosts的数量却一直是0">http://ip:port/turbine.stream来查看Turbine收集监控数据。turbine的作用是聚合各个/hystrix.stream的监控数据，在单个的hystrix.stream都正常后，turbine.stream收集的上报的hosts的数量却一直是0</a>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">: ping</span><br><span class="line">: ping</span><br><span class="line">data: &#123;&quot;reportingHostsLast10Seconds&quot;:0（这里一直是0）,&quot;name&quot;:&quot;meta&quot;,&quot;type&quot;:&quot;meta&quot;,&quot;timestamp&quot;:1530627942212&#125;</span><br></pre></td></tr></table></figure><p>Turbine需要注册Eureka。<br>所以需要引入Eureka的依赖，并配置eureka.client.url。<br>1.引入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.配置eureka.client.url<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  client:</span><br><span class="line">    serviceUrl:</span><br><span class="line">      defaultZone: http://localhost:8761/eureka</span><br><span class="line">  instance:</span><br><span class="line">    prefer-ip-address: true</span><br><span class="line">    instanceId: $&#123;spring.application.name&#125;:$&#123;vcap.application.instance_id:$&#123;spring.application.instance_id:$&#123;random.value&#125;&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>然后收集数据就正常了。在dashboard输入turbine.stream的地址即可看到监控数据。</p><h3 id="使用RequestLine一直触发的fallback"><a href="#使用RequestLine一直触发的fallback" class="headerlink" title="使用RequestLine一直触发的fallback"></a>使用RequestLine一直触发的fallback</h3><p>microservice-springcloud-movie-feign-without-hystrix服务依赖user服务，user服务已经启动了，但访问microservice-springcloud-movie-feign-without-hystrix的/user/1时仍然返回的fallback的处理结果。</p><p>这是因为我的FeignClient中configuration使用了默认的Contract。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Configuration1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public Contract feignContract() &#123;</span></span><br><span class="line"><span class="comment">//        return new feign.Contract.Default();</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注释掉默认的Contract即可。</p><p>集群配置可以参考：<a href="https://blog.csdn.net/luosai19910103/article/details/70820904/">https://blog.csdn.net/luosai19910103/article/details/70820904/</a></p><p>turbine如何聚合设置了context-path的hystrix数据：<br><a href="http://blog.didispace.com/spring-cloud-tips-4/">http://blog.didispace.com/spring-cloud-tips-4/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列19——Feign使用fallbackFactory属性打印fallback异常</title>
      <link href="/2018/06/30/springcloud%E7%B3%BB%E5%88%9719%E2%80%94%E2%80%94Feign%E4%BD%BF%E7%94%A8fallbackFactory%E5%B1%9E%E6%80%A7%E6%89%93%E5%8D%B0fallback%E5%BC%82%E5%B8%B8/"/>
      <url>/2018/06/30/springcloud%E7%B3%BB%E5%88%9719%E2%80%94%E2%80%94Feign%E4%BD%BF%E7%94%A8fallbackFactory%E5%B1%9E%E6%80%A7%E6%89%93%E5%8D%B0fallback%E5%BC%82%E5%B8%B8/</url>
      
        <content type="html"><![CDATA[<p>在FeignClient中，我们通过制定fallback，可以在服务不可用时自动调用fallback制定的处理方法。</p><p>但如果如果希望同时知道发生回退的原因呢？</p><p>可以使用fallbackFactory属性。</p><p>下面以microservice-springcloud-movie-feign-with-hystrix模块来说明。<br><a id="more"></a></p><h4 id="1-定义一个实现FallbackFactory的类"><a href="#1-定义一个实现FallbackFactory的类" class="headerlink" title="1.定义一个实现FallbackFactory的类"></a>1.定义一个实现FallbackFactory的类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserFeignClientHystrixFallbackFactory</span> <span class="keyword">implements</span> <span class="title">FallbackFactory</span>&lt;<span class="title">UserFeignClient</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(UserFeignClientHystrixFallbackFactory.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserFeignClient <span class="title">create</span><span class="params">(Throwable throwable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        logger.error(<span class="string">"fallback reason:&#123;&#125;"</span>,throwable.getMessage());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserFeignClient()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                User user = <span class="keyword">new</span> User();</span><br><span class="line">                user.setId(-<span class="number">1L</span>);</span><br><span class="line">                <span class="keyword">return</span> user;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如上，在发生回退时使用logger记录了回退的原因（异常），并返回了一个UserFeignClient，该实例重写了findUserById方法。</p><p>达到的效果就是在发生回退时，先打印回退原因，然后返回下面自定义的处理。</p><h4 id="2-FeignClient类指定fallbackFactory属性。"><a href="#2-FeignClient类指定fallbackFactory属性。" class="headerlink" title="2.FeignClient类指定fallbackFactory属性。"></a>2.FeignClient类指定fallbackFactory属性。</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不要同时使用fallback和fallbackFactory</span></span><br><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-user"</span><span class="comment">/*,fallback = UserHystrixClientFallback.class*/</span>,fallbackFactory = UserFeignClientHystrixFallbackFactory.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/sample/&#123;userId&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">User <span class="title">findUserById</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>1.启动Eureka Server；<br>2.启动user服务；<br>3.启动microservice-springcloud-movie-feign-with-hystrix。</p><p>浏览器访问/user/1，访问正常<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/44447370.jpg" alt=""></p><p>关闭user服务，再次访问/user/1<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/82379425.jpg" alt=""><br>可以看到，返回的是我们fallbackFactory中指定的处理方法的结果。</p><p>看控制台打印的异常信息是null<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/54482502.jpg" alt=""></p><p>但实际上错误原因是TimeoutException，如下<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/13141170.jpg" alt=""></p><p>现在多次刷新/user/1，使断路器打开。然后再次访问/user/1<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/45589166.jpg" alt=""></p><p>现在回退的原因是断路器打开了。</p><h4 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h4><p>fallback和fallbackFactory只能指定一个，如果2个都指定了，生效的是fallback。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列18——全局和单个禁用Feign Client对Hystrix的支持</title>
      <link href="/2018/06/30/springcloud%E7%B3%BB%E5%88%9718%E2%80%94%E2%80%94%E5%85%A8%E5%B1%80%E5%92%8C%E5%8D%95%E4%B8%AA%E7%A6%81%E7%94%A8Feign%20Client%E5%AF%B9Hystrix%E7%9A%84%E6%94%AF%E6%8C%81/"/>
      <url>/2018/06/30/springcloud%E7%B3%BB%E5%88%9718%E2%80%94%E2%80%94%E5%85%A8%E5%B1%80%E5%92%8C%E5%8D%95%E4%B8%AA%E7%A6%81%E7%94%A8Feign%20Client%E5%AF%B9Hystrix%E7%9A%84%E6%94%AF%E6%8C%81/</url>
      
        <content type="html"><![CDATA[<h2 id="全局禁用"><a href="#全局禁用" class="headerlink" title="全局禁用"></a>全局禁用</h2><p>这个比较简单，在application.yml中配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><p>加上这段配置就可以了。</p><h2 id="禁用某个Feign-Client对Hystrix的支持"><a href="#禁用某个Feign-Client对Hystrix的支持" class="headerlink" title="禁用某个Feign Client对Hystrix的支持"></a>禁用某个Feign Client对Hystrix的支持</h2><p>1.新建一个配置类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Configuration2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Configuration2里面加上这个就禁用了UserFeignClient2的Hystrix</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">    <span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//feignBuilder方法默认返回HystrixFeign.Builder也就是说Feign默认支持Hystrix</span></span><br><span class="line">        <span class="comment">//现在改成Feign.Builder就禁用了Hystrix的支持</span></span><br><span class="line">        <span class="keyword">return</span> Feign.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.在FeignClient的注解上加入configturation<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-movie"</span>,configuration = Configuration2.class,fallback = UserHystrixClientFallback2.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/list"</span>)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">showUserList</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="禁用单个Hystrix的示例代码"><a href="#禁用单个Hystrix的示例代码" class="headerlink" title="禁用单个Hystrix的示例代码"></a>禁用单个Hystrix的示例代码</h3><p>说明：模块名：microservice-springcloud-movie-feign-without-hystrix</p><p>该模块创建了2个Feign Client，Feign Client1支持Hystrix，Feign Client2不支持Hystrix。</p><p>application.yaml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-springcloud-movie-feign-without-hystrix</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    healthcheck:</span></span><br><span class="line"><span class="attr">      enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    instance-id:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ipAddress&#125;:$&#123;spring.application.instance_id:$&#123;server.port&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启用feign对Hystrix的支持</span></span><br><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#设置全局的超时时间</span></span><br><span class="line"><span class="attr">hystrix:</span></span><br><span class="line"><span class="attr">  command:</span></span><br><span class="line"><span class="attr">    default:</span></span><br><span class="line"><span class="attr">      execution:</span></span><br><span class="line"><span class="attr">        isolation:</span></span><br><span class="line"><span class="attr">          thread:</span></span><br><span class="line"><span class="attr">            timeoutInMilliseconds:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure></p><p>主类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieAppFeignWithoutHystrix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(MovieAppFeignWithoutHystrix.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-user"</span>,fallback = UserHystrixClientFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/sample/&#123;userId&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function">User <span class="title">findUserById</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-movie"</span>,configuration = Configuration2.class,fallback = UserHystrixClientFallback2.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/list"</span>)</span><br><span class="line">    <span class="function">List&lt;User&gt; <span class="title">showUserList</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHystrixClientFallback</span> <span class="keyword">implements</span> <span class="title">UserFeignClient</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHystrixClientFallback2</span> <span class="keyword">implements</span> <span class="title">UserFeignClient2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">showUserList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"UserHystrixClientFallback2.showUserList() called."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Configuration2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Configuration2里面加上这个就禁用了UserFeignClient2的Hystrix</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">    <span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//feignBuilder方法默认返回HystrixFeign.Builder也就是说Feign默认支持Hystrix</span></span><br><span class="line">        <span class="comment">//现在改成Feign.Builder就禁用了Hystrix的支持</span></span><br><span class="line">        <span class="keyword">return</span> Feign.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient2 userFeignClient2;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.findUserById(userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">listUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient2.showUserList();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(BigDecimal balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试：<br>1.启动eurake server；<br>2.启动user服务；<br>3.启动movie服务；<br>4.启动microservice-springcloud-movie-feign-without-hystrix。</p><p>浏览器访问/user/1，正常：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/19126325.jpg" alt=""></p><p>浏览器访问/user/list，正常：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/50332993.jpg" alt=""></p><p>关闭movie服务，再次访问/user/list<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/54830306.jpg" alt=""><br>提示连接超时，说明Feign Client2的Hystrix是失效的。</p><p>关闭user服务，再次访问/user/1<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-30/75084381.jpg" alt=""><br>返回的是我们定义的回退方法的结果，说明Feign Client1的Hystrix是生效的。</p><p>如上，就达到了禁用某个Feign Client对Hystrix支持的效果。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列17——Feign的Hystrix支持</title>
      <link href="/2018/06/29/springcloud%E7%B3%BB%E5%88%9717%E2%80%94%E2%80%94Feign%E7%9A%84Hystrix%E6%94%AF%E6%8C%81/"/>
      <url>/2018/06/29/springcloud%E7%B3%BB%E5%88%9717%E2%80%94%E2%80%94Feign%E7%9A%84Hystrix%E6%94%AF%E6%8C%81/</url>
      
        <content type="html"><![CDATA[<h2 id="Feign的Hystrix支持"><a href="#Feign的Hystrix支持" class="headerlink" title="Feign的Hystrix支持"></a>Feign的Hystrix支持</h2><p>springcloud官方文档参考：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#spring-cloud-feign-hystrix">17.4 Feign Hystrix Support</a>.</p><p>如果Hystrix在类路径上并且feign.hystrix.enabled = true，Feign将用断路器包装所有方法。</p><p>如果只是想某个Feign Client禁用Hystrix，可以创建一个普通的Feign.Builder，并将scope设置为prototype。</p><p>例如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FooConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Scope</span>(<span class="string">"prototype"</span>)</span><br><span class="line">    <span class="keyword">public</span> Feign.<span class="function">Builder <span class="title">feignBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Feign.builder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="Feign-Hystrix的回退（fallbacks）"><a href="#Feign-Hystrix的回退（fallbacks）" class="headerlink" title="Feign Hystrix的回退（fallbacks）"></a>Feign Hystrix的回退（fallbacks）</h2><p>Hystrix支持回退的概念：当断路器打开或出现错误时将执行默认的代码路径。 要为给定的@FeignClient启用回退，请将fallback属性设置为实现回退的类名称。 您还需要将您的实现声明为Spring bean。</p><p>示例代码：<br>这里以movie模块修改，新的模块名为microservice-springcloud-movie-feign-with-hystrix。</p><h3 id="1-为Feign启用hystrix"><a href="#1-为Feign启用hystrix" class="headerlink" title="1.为Feign启用hystrix"></a>1.为Feign启用hystrix</h3><p>修改application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  hystrix:</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p><h3 id="2-编写FeignClient，并设置fallbacks"><a href="#2-编写FeignClient，并设置fallbacks" class="headerlink" title="2.编写FeignClient，并设置fallbacks"></a>2.编写FeignClient，并设置fallbacks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-user"</span>,fallback = UserHystrixClientFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/sample/&#123;userId&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">User <span class="title">findUserById</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-创建回退类"><a href="#3-创建回退类" class="headerlink" title="3.创建回退类"></a>3.创建回退类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserHystrixClientFallback</span> <span class="keyword">implements</span> <span class="title">UserFeignClient</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(Long userId)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-测试"><a href="#4-测试" class="headerlink" title="4.测试"></a>4.测试</h3><p>1.启动Eureka Server；<br>2.启动User服务；<br>3.启动microservice-springcloud-movie-feign-with-hystrix。</p><p>启动后，浏览器访问/user/1，得到正确响应。将user服务关闭，连续刷新20次以上，再次访问得到的结果是user的id为0，即我们的Fallback类中实现的方法。结果与<a href="springcloud系列15——hystrix简介及简单代码示例">springcloud系列15——hystrix简介及简单代码示例</a>一节的一致。</p><p>代码结构：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-29/85603972.jpg" alt=""></p><p>这里要注意代码结构，否则在启动时会出现一些问题。<br>应用启动类如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(&#123;<span class="string">"com.tommy.springcloud"</span>,<span class="string">"com.tommy.config.fallback"</span>&#125;)</span><br><span class="line"><span class="meta">@EnableFeignClients</span>(<span class="string">"com.tommy.config.feign"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieAppWithFeignAndHystrix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(MovieAppWithFeignAndHystrix.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>springboot扫描的类要与feign的分开。同时Fallback的类也要被springboot扫描到。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud官方文档中文翻译版</title>
      <link href="/2018/06/25/springcloud%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91%E7%89%88/"/>
      <url>/2018/06/25/springcloud%E5%AE%98%E6%96%B9%E6%96%87%E6%A1%A3%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91%E7%89%88/</url>
      
        <content type="html"><![CDATA[<p><a href="https://springcloud.cc/spring-cloud-netflix.html">https://springcloud.cc/spring-cloud-netflix.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列16——Hystrix Health Indicator及Metrics Stream</title>
      <link href="/2018/06/25/springcloud%E7%B3%BB%E5%88%9716%E2%80%94%E2%80%94Hystrix%20Health%20Indicator%E5%8F%8AMetrics%20Stream/"/>
      <url>/2018/06/25/springcloud%E7%B3%BB%E5%88%9716%E2%80%94%E2%80%94Hystrix%20Health%20Indicator%E5%8F%8AMetrics%20Stream/</url>
      
        <content type="html"><![CDATA[<h2 id="传播安全上下文或使用Spring-Scopes"><a href="#传播安全上下文或使用Spring-Scopes" class="headerlink" title="传播安全上下文或使用Spring Scopes"></a>传播安全上下文或使用Spring Scopes</h2><p>参考springcloud官方文档：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_propagating_the_security_context_or_using_spring_scopes">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_propagating_the_security_context_or_using_spring_scopes</a>。</p><p>springcloud原文：</p><blockquote><p>If you want some thread local context to propagate into a @HystrixCommand the default declaration will not work because it executes the command in a thread pool (in case of timeouts). You can switch Hystrix to use the same thread as the caller using some configuration, or directly in the annotation, by asking it to use a different “Isolation Strategy”. </p></blockquote><p>翻译：</p><blockquote><p>如果你想要一些线程本地上下文传播到@HystrixCommand，默认声明将不起作用，因为它在线程池中执行命令（在超时的情况下）。 您可以使用某种配置将Hystrix切换为与调用方使用相同的线程，或者直接在注释中请求它使用不同的“隔离策略”。<br><a id="more"></a><br>比如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"stubMyService"</span>,</span><br><span class="line">    commandProperties = &#123;</span><br><span class="line">      <span class="meta">@HystrixProperty</span>(name=<span class="string">"execution.isolation.strategy"</span>, value=<span class="string">"SEMAPHORE"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p></blockquote><p>springcloud原文：</p><blockquote><p>The same thing applies if you are using @SessionScope or @RequestScope. You will know when you need to do this because of a runtime exception that says it can’t find the scoped context.  </p></blockquote><blockquote><p>You also have the option to set the hystrix.shareSecurityContext property to true. Doing so will auto configure an Hystrix concurrency strategy plugin hook who will transfer the SecurityContext from your main thread to the one used by the Hystrix command. Hystrix does not allow multiple hystrix concurrency strategy to be registered so an extension mechanism is available by declaring your own HystrixConcurrencyStrategy as a Spring bean. Spring Cloud will lookup for your implementation within the Spring context and wrap it inside its own plugin.</p></blockquote><p>翻译：</p><blockquote><p>如果使用@SessionScope或@RequestScope，则同样适用。 你需要知道，只有在产生一个运行时异常，并且它告诉你无法找到范围内的上下文时，你才应该这样做。</p></blockquote><blockquote><p>您也可以选择将hystrix.shareSecurityContext属性设置为true。 这样做会自动配置一个Hystrix并发策略插件钩子，他可以将SecurityContext从主线程传输到Hystrix命令使用的钩子。 Hystrix不允许注册多个hystrix并发策略，因此通过将自己的HystrixConcurrencyStrategy声明为Spring bean，可以使用扩展机制。 Spring Cloud将在Spring上下文中查找您的实现，并将其包装在自己的插件中。</p></blockquote><h2 id="健康指标"><a href="#健康指标" class="headerlink" title="健康指标"></a>健康指标</h2><p>spring-boot的actuator提供了/health端点来查看Hystrix状态。使用也很简单，在pom.xml增加依赖即可：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>因为在公网环境，有些敏感数据不适合直接查看。所以，默认情况下，访问类似<a href="http://localhost:8081/metrics">http://localhost:8081/metrics</a>会看到下面的错误：<br><img src="https://images2015.cnblogs.com/blog/27612/201704/27612-20170415132808330-923470429.png" alt=""></p><p>所以，建议对这些查看敏感数据的使用跟应用不同的端口。<br>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">management:</span><br><span class="line">  security:</span><br><span class="line">    enabled: false # 关闭安全检查</span><br><span class="line">  port: 1101 # 管理端口</span><br><span class="line">  context-path: /admin # 管理上线文路径</span><br></pre></td></tr></table></figure></p><p>如果在公网环境，建议在防火墙上做下限制，仅允许8081进来，1101用于内网访问即可，这样相对比较安全，也不用繁琐的输入密码。</p><p>在应用启动时的控制台日志，我们可以看到，spring-boot-acturator提供了非常多的指标。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/44126544.jpg" alt=""></p><p>springboot-acturator的相关内容参考：<a href="http://www.cnblogs.com/yjmyzz/p/spring-boot-actuator-tutorial.html">http://www.cnblogs.com/yjmyzz/p/spring-boot-actuator-tutorial.html</a>。</p><p>配置了springboot-actuator后，我们可以通过/health来查看Hystrix的健康状态。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/3818400.jpg" alt=""></p><p>这个表示hystrix的断路器未打开。</p><p>我们将user服务关闭，然后疯狂刷新/user/1多次（20次）以上，再次访问/admin/health。</p><p>会看到：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/87582324.jpg" alt=""><br>可以看到，hystrix的状态是CIRCUIT_OPEN，标识断路器打开了。</p><h2 id="Hystrix监控"><a href="#Hystrix监控" class="headerlink" title="Hystrix监控"></a>Hystrix监控</h2><p>/health端点只能看到断路器的整体状态，但对细节展示不详细。从上面我们会看到一个/hystrix.stream的端点，访问该端点可以看到详细的数据。页面会一直持续刷新，可以看到最新数据。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/6115834.jpg" alt=""></p><h2 id="Hystrix-Dashboard"><a href="#Hystrix-Dashboard" class="headerlink" title="Hystrix Dashboard"></a>Hystrix Dashboard</h2><p>通过/hystrix.stream可以实时看到最新的监控数据，但密密麻麻的文字，看起来不太方便。spring cloud提供了一个hystrix-dashboard的功能，可以以图形化界面展示这些数据。</p><p>使用步骤如下：<br>a.添加spring-cloud-starter-hystrix-dashboard的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix-dashboard<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>b.在启动类上增加<code>@EnableHystrixDashboard</code>注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="meta">@EnableHystrixDashboard</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieHystrixApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(MovieHystrixApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>c.重新启动movie-hystrix模块<br>d.浏览器输入movie-hystrix应用端口/hystrix，可以看到下面的页面<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/92464637.jpg" alt=""></p><p>输入下面的信息：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/44749494.jpg" alt=""><br>其实就是制定/hystrix.stream的地址，刷新的间隔。</p><p>然后就可以看到下面的界面：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/49130183.jpg" alt=""><br>可以看到，此时断路器开关是关闭的。</p><p>我们停止user模块的服务，并且狂刷页面一会儿。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/68194655.jpg" alt=""><br>可以看到，此时断路器打开了。</p><p>这显然比纯文字友好多了。还有一个问题，如果有多个hystrix.stream地址同时监控，或者把多个地址的数据汇总起来，该怎么弄？github上有一个turbine ,就是专门为解决这个问题的，大家可以自行研究下。</p><p>参考：<a href="https://www.cnblogs.com/yjmyzz/p/spring-cloud-hystrix-tutorial.html">https://www.cnblogs.com/yjmyzz/p/spring-cloud-hystrix-tutorial.html</a>。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列15——hystrix简介及简单代码示例</title>
      <link href="/2018/06/25/springcloud%E7%B3%BB%E5%88%9715%E2%80%94%E2%80%94hystrix%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/"/>
      <url>/2018/06/25/springcloud%E7%B3%BB%E5%88%9715%E2%80%94%E2%80%94hystrix%E7%AE%80%E4%BB%8B%E5%8F%8A%E7%AE%80%E5%8D%95%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="Hystrix简介"><a href="#Hystrix简介" class="headerlink" title="Hystrix简介"></a>Hystrix简介</h2><p>在微服务中，有服务A、B，C，D4个微服务。其中，C依赖D，A和B依赖C。<br>那么当D出现问题时，会导致C不可用，进而导致A和B也不可用。这就是产生了雪崩效应。</p><p>hystrix语义为“豪猪”，它身上有很多刺，具有自我保护的能力。hystrix的出现即为解决雪崩效应。</p><p>关于Hystrix的原理可用参考：<a href="https://www.jianshu.com/p/e07661b9bae8">https://www.jianshu.com/p/e07661b9bae8</a>。</p><p>spring cloud hystrix相关内容参考：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_circuit_breaker_hystrix_clients">http://cloud.spring.io/spring-cloud-static/Edgware.SR3/single/spring-cloud.html#_circuit_breaker_hystrix_clients</a>。<br><a id="more"></a></p><h2 id="简单代码示例"><a href="#简单代码示例" class="headerlink" title="简单代码示例"></a>简单代码示例</h2><p>新增模块microservice-springcloud-movie-hystrix。该模块是从microservice-springcloud-movie拷贝过去的。</p><p>在pom.xml增加hystrix依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>在App启动类增加<code>@EnableCircuitBreaker</code>注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieHystrixApp</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(MovieHystrixApp.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Controller：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"getUserFallback"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://microservice-springcloud-user/sample/"</span> + userId,User.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserFallback</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">0L</span>);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>fallbackMethod</code>指定服务调用失败时的处理方法为getUserFallback。</p><blockquote><p>注意：fallbackMethod指定的方法必须与原方法有相同的方法签名。</p></blockquote><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>1.启动EurekaServer App；<br>2.启动microservice-springcloud-user；<br>3.启动microservice-springcloud-movie-hystrix。</p><p>浏览器请求<a href="http://127.0.0.1:8761/">http://127.0.0.1:8761/</a>。<br>第一次执行会发现调用了fallbackMethod指定的方法，返回的user的id为0.<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/92335450.jpg" alt=""></p><p>后面刷新，返回的都是正常的调用user模块的。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-25/83638146.jpg" alt=""></p><p>我们将user服务关闭，再刷新页面。此时页面有一定的等待，并返回的是fallbackMethod指定的数据，user的id为0.</p><p>后面刷新页面20次，然后继续刷新，发现虽然返回的user的id还是0，但是没有等待。过几秒后，刷新页面又有等待，过一会儿又没有了。</p><p>原因在spring cloud的文档中已经说到：</p><blockquote><p>A service failure in the lower level of services can cause cascading(级联) failure all the way up to the user. When calls to a particular service is greater than circuitBreaker(断路器).requestVolumeThreshold (default: 20 requests) and failue percentage is greater than circuitBreaker.errorThresholdPercentage (default: &gt;50%) in a rolling window defined(定义) by metrics(度量标准).rollingStats.timeInMilliseconds (default: 10 seconds), the circuit(电路) opens and the call is not made. In cases of error and an open circuit a fallback(撤退) can be provided by the developer.</p></blockquote><p>翻译过来的意思就是：</p><blockquote><p>在较低级别的服务中的服务故障可能导致级联故障一直到用户。当对特定服务的调用大于circuitBreaker.requestVolumeThreshold（默认值：20请求）和故障率大于circuitBreaker.errorThresholdPercentage阈值百分比（默认值：50%）在metrics.rollingStats.timeInMilliseconds指定的时间内（默认10秒）。断路器打开并且不进行服务的调用。在错误和电路打开的情况下，开发人员可以提供回退。</p></blockquote><p>所以，在10秒后，20次请求，有50%的故障率，Hystrix会执行开发人员提供的fallback方法。</p><p>但是Hystrix有它的监控方法，所以隔一定的时间（默认5秒），Hystrix会检查服务是否可用，如果不可用，则继续打开断路器开关，并按指定的回退方法处理；如果服务恢复正常，则执行服务调用。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列14——Eureka、Ribbon和Feign常见问题和解决</title>
      <link href="/2018/06/22/springcloud%E7%B3%BB%E5%88%9714%E2%80%94%E2%80%94Eureka%E3%80%81Ribbon%E5%92%8CFeign%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3/"/>
      <url>/2018/06/22/springcloud%E7%B3%BB%E5%88%9714%E2%80%94%E2%80%94Eureka%E3%80%81Ribbon%E5%92%8CFeign%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3/</url>
      
        <content type="html"><![CDATA[<h3 id="1-修改System-Status的Environment和Data-Center"><a href="#1-修改System-Status的Environment和Data-Center" class="headerlink" title="1.修改System Status的Environment和Data Center"></a>1.修改System Status的Environment和Data Center</h3><p>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-22/70268387.jpg" alt=""></p><p>增加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  environment: product</span><br><span class="line">  datacenter: spring cloud</span><br></pre></td></tr></table></figure></p><p>或者在启动时使用<code>-Deureka.datacenter=spring cloud</code>这种方式来指定。<br><a id="more"></a></p><h3 id="2-Eureka配置instanceId显示IP"><a href="#2-Eureka配置instanceId显示IP" class="headerlink" title="2.Eureka配置instanceId显示IP"></a>2.Eureka配置instanceId显示IP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    instance-id:</span><br><span class="line">    # 显示应用名称：ip地址：端口号</span><br><span class="line">    $&#123;spring.application.name&#125;:$&#123;spring.cloud.client.ipAddress&#125;:$&#123;server.port&#125;</span><br></pre></td></tr></table></figure><h3 id="3-Consider-defining-a-bean-of-type-‘com-tommy-config-feign-UserFeignClient’-in-your-configuration"><a href="#3-Consider-defining-a-bean-of-type-‘com-tommy-config-feign-UserFeignClient’-in-your-configuration" class="headerlink" title="3.Consider defining a bean of type ‘com.tommy.config.feign.UserFeignClient’ in your configuration."></a>3.Consider defining a bean of type ‘com.tommy.config.feign.UserFeignClient’ in your configuration.</h3><p>参考：<a href="https://www.jianshu.com/p/551c7c251f91">https://www.jianshu.com/p/551c7c251f91</a></p><p>在@EnableFeignClients注解上增加UserFeignClient所在的package。<br>即：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span>(&#123;<span class="string">"com.tommy.config.feign"</span>&#125;)</span><br></pre></td></tr></table></figure></p><h3 id="4-使用RestTemplate调用服务提供方返回List的服务问题"><a href="#4-使用RestTemplate调用服务提供方返回List的服务问题" class="headerlink" title="4.使用RestTemplate调用服务提供方返回List的服务问题"></a>4.使用RestTemplate调用服务提供方返回List的服务问题</h3><p>这里是在百度云视频第18节中看到的，比如服务提供方定义了一个接口返回List<User>，调用方使用RestTemplate调用时返回的并不是List。</p><p>即下面的代码是错误的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;User&gt; list = <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"http://microservice-springcloud-user/user/list"</span>,List.class);</span><br></pre></td></tr></table></figure></p><p>应该改成<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User[] users = <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"http://microservice-springcloud-user/user/list"</span>,User[].class);</span><br><span class="line"></span><br><span class="line">List&lt;User&gt; list = Arrays.asList(users);</span><br></pre></td></tr></table></figure></p><p>不过，我本地测试没有出现这个问题。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo博客从github迁移到gitee</title>
      <link href="/2018/06/09/hexo-blog-from-github-to-gitee/"/>
      <url>/2018/06/09/hexo-blog-from-github-to-gitee/</url>
      
        <content type="html"><![CDATA[<p>gitee感觉做的不错，而且是国内的，速度要比github快不少。所以将博客从github迁移到gitee。<br><a id="more"></a><br>1.在gitee.com修改个性地址：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/22136927.jpg" alt=""><br>比如这里最后是tommy88。</p><p>2.在gitee.com创建一个public项目，名称为上面的tommy88.<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/88846405.jpg" alt=""></p><p>3.打开git bash，进入到博客目录。<br>在git Bash中，输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;username&quot; (注：username为你git上的用户名)</span><br></pre></td></tr></table></figure></p><p>后面一直回车，直到结束。</p><p>打开生成的id_rsa.pub文件，复制公钥到gitee的ssh key。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/62875862.jpg" alt=""></p><p>配置完毕后，使用下面的命令测试一下SSH Key<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@gitee.com</span><br></pre></td></tr></table></figure></p><p>后面你使用hexo d直接就提交到gitee仓库中了。</p><p>4.修改hexo的_config.yml<br>Deploy部分修改为gitee的地址<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@gitee.com:tommy88/tommy88.git</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure></p><p>5.博客内容提交到gitee后，开启gitee pages。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/60603681.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/89743013.jpg" alt=""><br>部署后，会显示一个网站地址，这个地址就是你的博客地址。</p><p>6.将博客源代码托管到gitee<br>参考<a href="https://tommy88.gitee.io/2017/08/26/hexo-github-personal-blog/">https://tommy88.gitee.io/2017/08/26/hexo-github-personal-blog/</a>文章中的<code>将博客文章、配置与主题设置备份到osc</code>章节。</p><p>注意：如果之前备份过，这里由于修改了个性地址，会导致仓库地址发生变化，本地再次执行git push origin master命令时会提示<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/26469247.jpg" alt=""></p><p>到博客根目录下的.git文件夹，打开config文件，修改gitee地址<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/17487857.jpg" alt=""></p><p>将url修改为最新的地址<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-9/51169413.jpg" alt=""></p><p>再次push就成功了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>netty自定义编码器和解码器（粘包处理）</title>
      <link href="/2018/06/08/netty-custom-decoder-and-encoder/"/>
      <url>/2018/06/08/netty-custom-decoder-and-encoder/</url>
      
        <content type="html"><![CDATA[<p>这里的实现方式是：将消息分为两部分，也就是消息头和消息尾，消息头中写入要发送数据的总长度，通常是在消息头的第一个字段使用int值来标识发送数据的长度。<br><a id="more"></a><br>首先我们写一个Encoder，我们继承自MessageToByteEncoder<T> ，把对象转换成byte，继承这个对象，会要求我们实现一个encode方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] body = convertToBytes(msg);  <span class="comment">//将对象转换为byte，伪代码，具体用什么进行序列化，你们自行选择。可以使用我上面说的一些</span></span><br><span class="line">    <span class="keyword">int</span> dataLength = body.length;  <span class="comment">//读取消息的长度</span></span><br><span class="line">    out.writeInt(dataLength);  <span class="comment">//先将消息长度写入，也就是消息头</span></span><br><span class="line">    out.writeBytes(body);  <span class="comment">//消息体中包含我们要发送的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>那么当我们在Decode的时候，该怎么处理发送过来的数据呢?这里我们继承ByteToMessageDecoder方法，继承这个对象，会要求我们实现一个decode方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (in.readableBytes() &lt; HEAD_LENGTH) &#123;  <span class="comment">//这个HEAD_LENGTH是我们用于表示头长度的字节数。  由于上面我们传的是一个int类型的值，所以这里HEAD_LENGTH的值为4.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    in.markReaderIndex();                  <span class="comment">//我们标记一下当前的readIndex的位置</span></span><br><span class="line">    <span class="keyword">int</span> dataLength = in.readInt();       <span class="comment">// 读取传送过来的消息的长度。ByteBuf 的readInt()方法会让他的readIndex增加4</span></span><br><span class="line">    <span class="keyword">if</span> (dataLength &lt; <span class="number">0</span>) &#123; <span class="comment">// 我们读到的消息体长度为0，这是不应该出现的情况，这里出现这情况，关闭连接。</span></span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in.readableBytes() &lt; dataLength) &#123; <span class="comment">//读到的消息体长度如果小于我们传送过来的消息长度，则resetReaderIndex. 这个配合markReaderIndex使用的。把readIndex重置到mark的地方</span></span><br><span class="line">        in.resetReaderIndex();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] body = <span class="keyword">new</span> <span class="keyword">byte</span>[dataLength];  <span class="comment">//  嗯，这时候，我们读到的长度，满足我们的要求了，把传送过来的数据，取出来吧~~</span></span><br><span class="line">    in.readBytes(body);  <span class="comment">//</span></span><br><span class="line">    Object o = convertToObject(body);  <span class="comment">//将byte数据转化为我们需要的对象。伪代码，用什么序列化，自行选择</span></span><br><span class="line">    out.add(o);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>下面来一个示例（实例只做了字符串的处理，其他自定义对象的处理参考上面）。<br>服务端（接收端）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioEventLoopGroup boss = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        NioEventLoopGroup worker = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"></span><br><span class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        bootstrap.group(boss,worker)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                <span class="comment">// 添加自定义的解码器</span></span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> MyCustomMessageDecoder());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> ServerMessageHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture future = bootstrap.bind(<span class="number">9999</span>).sync();</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            boss.shutdownGracefully();</span><br><span class="line">            worker.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>自定义的消息解码器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomMessageDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 消息头：发送端写的是一个int，占用4字节。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> HEAD_LENGTH = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &lt; HEAD_LENGTH) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 标记一下当前的readIndex的位置</span></span><br><span class="line">        in.markReaderIndex();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取数据长度</span></span><br><span class="line">        <span class="keyword">int</span> dataLength = in.readInt();</span><br><span class="line">        <span class="comment">// 我们读到的消息体长度为0，这是不应该出现的情况，这里出现这情况，关闭连接。</span></span><br><span class="line">        <span class="keyword">if</span> (dataLength &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            ctx.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//读到的消息体长度如果小于我们传送过来的消息长度，则resetReaderIndex. 这个配合markReaderIndex使用的。把readIndex重置到mark的地方</span></span><br><span class="line">        <span class="keyword">if</span> (in.readableBytes() &lt; dataLength) &#123;</span><br><span class="line">            in.resetReaderIndex();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将缓冲区的数据读到字节数组</span></span><br><span class="line">        <span class="keyword">byte</span>[] body = <span class="keyword">new</span> <span class="keyword">byte</span>[dataLength];</span><br><span class="line">        in.readBytes(body);</span><br><span class="line">        <span class="comment">//将byte数据转化为我们需要的对象。伪代码，用什么序列化，自行选择</span></span><br><span class="line">        Object msg = convertToObj(body);</span><br><span class="line">        out.add(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">convertToObj</span><span class="params">(<span class="keyword">byte</span>[] body)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(body,<span class="number">0</span>,body.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Server端的消息处理器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerMessageHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> messageCount = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String _msg = (String) msg;</span><br><span class="line">        System.out.println(<span class="string">"["</span>+(++messageCount)+<span class="string">"]接收到消息："</span> + _msg);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意：业务异常需要处理，不能不管，否则会调用exceptionCaught()</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        bootstrap.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_SNDBUF,<span class="number">10</span>)</span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO))</span><br><span class="line">                .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        <span class="comment">// 增加自定义编码器</span></span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> MyCustomMessageEncoder());</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> ClientMessageHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture future = bootstrap.connect(<span class="string">"127.0.0.1"</span>, <span class="number">9999</span>).sync();</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>自定义的消息编码器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCustomMessageEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 要发送的数据</span></span><br><span class="line">        <span class="comment">// 这里如果是自定义的类型，msg即为自定义的类型，需要转为byte[]</span></span><br><span class="line">        <span class="keyword">byte</span>[] body = ((ByteBuf)msg).array();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据长度</span></span><br><span class="line">        <span class="keyword">int</span> dataLength = body.length;</span><br><span class="line">        <span class="comment">// 缓冲区先写入数据长度</span></span><br><span class="line">        out.writeInt(dataLength);</span><br><span class="line">        <span class="comment">// 再写入数据</span></span><br><span class="line">        out.writeBytes(body);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端的消息处理器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientMessageHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String msg = <span class="string">"hello,world"</span>;</span><br><span class="line">        <span class="keyword">byte</span>[] data;</span><br><span class="line">        ByteBuf buf;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123;</span><br><span class="line">            data = (msg+i).getBytes();</span><br><span class="line">            buf = Unpooled.copiedBuffer(data);</span><br><span class="line">            ctx.writeAndFlush(buf);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"100条 消息发送完毕"</span>);</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行效果<br>客户端：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-8/12436941.jpg" alt=""></p><p>服务端：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-8/44882484.jpg" alt=""></p><p>参考：<a href="https://blog.csdn.net/AlbertFly/article/details/51533992">https://blog.csdn.net/AlbertFly/article/details/51533992</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ajax跨域问题</title>
      <link href="/2018/06/02/fix-ajax-crossdomain-problem/"/>
      <url>/2018/06/02/fix-ajax-crossdomain-problem/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是Ajax跨域问题"><a href="#什么是Ajax跨域问题" class="headerlink" title="什么是Ajax跨域问题"></a>什么是Ajax跨域问题</h2><p>这里通过一个示例来说明。<br>我们这里准备了2个Springboot工程。<br>crossdomain-server:<br>端口：8080</p><p>对外提供的接口如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResultBean <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"TestController.get()."</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean(<span class="string">"hello,justin"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过浏览器请求<a href="http://localhost:8080/test/get">http://localhost:8080/test/get</a>得到如下结果：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/11597273.jpg" alt=""><br><a id="more"></a><br>crossdomain-client:<br>端口：8081<br>提供了一个简单的页面，用于Ajax请求crossdomain-server的接口。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"/jquery.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">onclick</span>=<span class="string">"get1();"</span>&gt;</span>get请求<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">get1</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            $.getJSON(<span class="string">"http://localhost:8080/test/get"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span></span><br><span class="line">                alert(json);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>但是点击“get请求”后，发现控制台报错了。<br>如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/93569935.jpg" alt=""></p><p>这个就是Ajax跨域问题。</p><h2 id="Ajax跨域的原因"><a href="#Ajax跨域的原因" class="headerlink" title="Ajax跨域的原因"></a>Ajax跨域的原因</h2><p>产生跨域是由于浏览器的安全策略，JavaScript只能访问和操作自己域下的资源，不能访问和操作其他域下的资源。跨域问题是针对JS和ajax的，html本身没有跨域问题，比如a标签、script标签、甚至form标签（可以直接跨域发送数据并接收数据）等。所谓的同源，指的是域名、协议、端口均相等。</p><h2 id="解决Ajax跨域的方式"><a href="#解决Ajax跨域的方式" class="headerlink" title="解决Ajax跨域的方式"></a>解决Ajax跨域的方式</h2><h3 id="1-jsonp"><a href="#1-jsonp" class="headerlink" title="1.jsonp"></a>1.jsonp</h3><p>我们对crossdomain-server做些修改：<br>a.增加ControllerAdvice<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonpAdvice</span> <span class="keyword">extends</span> <span class="title">AbstractJsonpResponseBodyAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JsonpAdvice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="string">"callback"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>b.页面Ajax请求方式改为jsonp<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每个测试用例的超时时间</span></span><br><span class="line">jasmine.DEFAULT_TIMEOUT_INTERVAL = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">var</span> base = <span class="string">"http://localhost:8080/test"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试模块</span></span><br><span class="line">describe(<span class="string">"ajax跨域"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">"jsonp请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result;</span><br><span class="line">        </span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:base+<span class="string">"/get"</span>,</span><br><span class="line">            dataType:<span class="string">"jsonp"</span>,</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">                result = callback;</span><br><span class="line">                </span><br><span class="line">                expect(result).toEqual(&#123;</span><br><span class="line">                    <span class="string">"data"</span>: <span class="string">"hello,justin"</span></span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">                done();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>浏览器输入<a href="http://localhost:8081">http://localhost:8081</a>可以看到测试通过，<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/87147828.jpg" alt=""></p><p>看下jsonp请求：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/21203667.jpg" alt=""></p><blockquote><p>这里使用了jasmine测试框架，具体使用方法可以执行百度。jasmine的github地址为：<a href="https://jasmine.github.io">https://jasmine.github.io</a>，可以在release中下载。使用可以参考：<a href="https://jasmine.github.io/2.3/introduction.html">https://jasmine.github.io/2.3/introduction.html</a>。</p></blockquote><blockquote><p>jsonp虽然可以解决跨域问题，但jsonp只支持get请求，而且还需要修改前后台代码。<br>jsonp为什么只支持get，不支持post？<br>jsonp不是使用xhr发送的，是使用动态插入script标签实现的，当前无法指定请求的method，只能是get。<br>调用的地方看着一样，实际上和普通的ajax有2点明显差异：1. 不是使用xhr 2.服务器返回的不是json数据，而是js代码。</p></blockquote><h3 id="2-被调用方修改以支持跨域"><a href="#2-被调用方修改以支持跨域" class="headerlink" title="2.被调用方修改以支持跨域"></a>2.被调用方修改以支持跨域</h3><p>我们这里使用Filter，在响应中增加Access-Control-Allow-Origin。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrossdoaminServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(CrossdoaminServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">crossFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        FilterRegistrationBean bean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        bean.addUrlPatterns(<span class="string">"/*"</span>);</span><br><span class="line">        bean.setFilter(<span class="keyword">new</span> CrossFilter());</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CrossFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        HttpServletResponse resp = (HttpServletResponse) response;</span><br><span class="line">        <span class="comment">// 允许http://localhost:8081域访问</span></span><br><span class="line">        resp.addHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"http://localhost:8081"</span>);</span><br><span class="line">        </span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>crossdomain-client前端测试点：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 测试模块</span></span><br><span class="line">describe(<span class="string">"ajax跨域"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">     it(<span class="string">"get请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result;</span><br><span class="line">        </span><br><span class="line">        $.getJSON(base+<span class="string">"/get"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">json</span>)</span>&#123;</span><br><span class="line">            result = json;</span><br><span class="line">            </span><br><span class="line">            expect(result).toEqual(&#123;</span><br><span class="line">                <span class="string">"data"</span>: <span class="string">"hello,justin"</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">            done();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;); </span><br><span class="line">    </span><br><span class="line">    it(<span class="string">"jsonp请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> result;</span><br><span class="line">        </span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            method:<span class="string">"post"</span>,</span><br><span class="line">            url:base+<span class="string">"/get"</span>,</span><br><span class="line">            dataType:<span class="string">"jsonp"</span>,</span><br><span class="line">            success:<span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">                result = callback;</span><br><span class="line">                </span><br><span class="line">                expect(result).toEqual(&#123;</span><br><span class="line">                    <span class="string">"data"</span>: <span class="string">"hello,justin"</span></span><br><span class="line">                &#125;)</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">                done();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>测试结果：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/25273026.jpg" alt=""></p><p>可以将<code>Access-Control-Allow-Origin</code>设置为*，这样任何域都可以访问。同时可以通过<code>Access-Control-Allow-Methods</code>指定允许访问的方法。<br>如允许GET请求：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 同样可以将Access-Control-Allow-Methods设置为*，表示允许所有方法。</span><br><span class="line">resp.addHeader(&quot;Access-Control-Allow-Methods&quot;, &quot;GET&quot;);</span><br></pre></td></tr></table></figure></p><h3 id="带cookie的跨域"><a href="#带cookie的跨域" class="headerlink" title="带cookie的跨域"></a>带cookie的跨域</h3><p>我们在crossdomain-server增加一个测试方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/getCookie"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean <span class="title">getCookie</span><span class="params">(@CookieValue(name=<span class="string">"cookie1"</span>)</span> String cookie1) </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"TestController.getCookie().cookie1="</span> + cookie1);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean(<span class="string">"cookie:"</span> + cookie1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后浏览器访问crossdomain-server的任意一个请求，使用<code>document.cookie=&quot;cookie1=justin&quot;</code>来增加一个名为cookie1，值为justin的cookie。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/71187588.jpg" alt=""></p><p>crossdomain-client增加一个测试用例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"getCookie请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    </span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type:<span class="string">"get"</span>,</span><br><span class="line">        url:base+<span class="string">"/getCookie"</span>,</span><br><span class="line">        xhrFields: &#123;</span><br><span class="line">            <span class="comment">// 默认情况下，跨源请求不提供凭据(cookie、HTTP认证及客户端SSL证明等)。通过将withCredentials属性设置为true，可以指定某个请求应该发送凭据。如果服务器接收带凭据的请求，会用下面的HTTP头部来响应。</span></span><br><span class="line">            withCredentials: <span class="literal">true</span></span><br><span class="line">        &#125;,  </span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span><br><span class="line">            result = json;</span><br><span class="line">            </span><br><span class="line">            expect(result).toEqual(&#123;</span><br><span class="line">                <span class="string">"data"</span>: <span class="string">"cookie:justin"</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">            done();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>我们访问<a href="http://localhsot:8081，">http://localhsot:8081，</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/98074659.jpg" alt=""><br>可以看到，请求是成功的（statuscode=200），请求也带上了cookie。但jasmine提示失败。<br>我们看下浏览器控制台：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/66778521.jpg" alt=""><br>提示信息很明确了：提示我们响应头需要设置Access-Control-Allow-Credentials为true。<br>我们到CrossFilter设置一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resp.addHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br></pre></td></tr></table></figure></p><p>ok，加上以后再次请求就成功了。</p><p>注意：这里不能设置Access-Control-Allow-Origin为*，否则会报下面的错误：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/67848327.jpg" alt=""><br>但是，我们不可能只有一个跨域的站，怎么处理？<br>我们观察浏览器的请求，可以发现，如果是跨域请求，会有Origin请求头，我们后台根据这个请求头设置即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String url = req.getHeader(<span class="string">"Origin"</span>);</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isEmpty(url)) &#123;</span><br><span class="line">    resp.addHeader(<span class="string">"Access-Control-Allow-Origin"</span>, url);</span><br><span class="line">    resp.addHeader(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>错误：Missing cookie ‘cookie1’ for method parameter of type String</strong><br>最后发现是jquery版本太低，这里使用了jquery1.11.3后ok了。</p><h3 id="带自定义请求头的跨域访问"><a href="#带自定义请求头的跨域访问" class="headerlink" title="带自定义请求头的跨域访问"></a>带自定义请求头的跨域访问</h3><p>在crossdomain-server增加一个请求方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/customHeader"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean <span class="title">getCustomHeader</span><span class="params">(@RequestHeader(<span class="string">"X-My-Header"</span>)</span> String myHeader) </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"TestController.getCustomHeader().myHeader="</span> + myHeader);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean(<span class="string">"header:"</span> + myHeader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在crossdomain-client增加一个测试用例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"getCustomeHeader请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    </span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type:<span class="string">"get"</span>,</span><br><span class="line">        url:base+<span class="string">"/customHeader"</span>,</span><br><span class="line">        headers:&#123;</span><br><span class="line">            <span class="string">'X-My-Header'</span>:<span class="string">'justin'</span></span><br><span class="line">        &#125;,  </span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span><br><span class="line">            result = json;</span><br><span class="line">            </span><br><span class="line">            expect(result).toEqual(&#123;</span><br><span class="line">                <span class="string">"data"</span>: <span class="string">"header:justin"</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">            done();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>测试发现报错了<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/26794827.jpg" alt=""><br>意思我们的Access-Control-Allow-Headers响应头没有包含这个自定义的请求头，所以我们在CrossFilter加上<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resp.addHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type,X-My-Header"</span>);</span><br></pre></td></tr></table></figure></p><p>再次请求，成功。</p><p>与<code>Access-Control-Allow-Origin</code>一样，我们也可以对<code>Access-Control-Allow-Headers</code>进行动态设置。<br>我们观察customHeader的预检命令的请求头中有<code>Access-Control-Request-Headers:x-my-header</code>。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/87362826.jpg" alt=""><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String headers = req.getHeader(<span class="string">"Access-Control-Request-Headers"</span>);</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.isEmpty(headers)) &#123;</span><br><span class="line">    resp.addHeader(<span class="string">"Access-Control-Allow-Headers"</span>, headers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="预检命令"><a href="#预检命令" class="headerlink" title="预检命令"></a>预检命令</h3><p>我们在crossdomain-server增加一个postJson方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/postJson"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean <span class="title">postJson</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"TestController.postJson()"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean(<span class="string">"hello,"</span> + user.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在crossdomain-client增加一个测试用例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">it(<span class="string">"postJson请求"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    </span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type:<span class="string">"post"</span>,</span><br><span class="line">        url:base+<span class="string">"/postJson"</span>,</span><br><span class="line">        contentType:<span class="string">"application/json;charset=utf-8"</span>,</span><br><span class="line">        data:<span class="built_in">JSON</span>.stringify(&#123;<span class="attr">name</span>:<span class="string">"justin"</span>&#125;),</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span>(<span class="params">json</span>) </span>&#123;</span><br><span class="line">            result = json;</span><br><span class="line">            </span><br><span class="line">            expect(result).toEqual(&#123;</span><br><span class="line">                <span class="string">"data"</span>: <span class="string">"hello,justin"</span></span><br><span class="line">            &#125;)</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 校验完成，通知jasmine框架</span></span><br><span class="line">            done();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>浏览器访问发现postJson失败了，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/3811400.jpg" alt=""><br>而且，我要请求的是一个post请求的/postJson请求，但实际浏览器是发出了一个OPTIONS请求，这个就是预检命令。</p><p>看下浏览器的控制台：<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/10201040.jpg" alt=""><br>意思是我们的响应头<code>Access-Control-Allow-Headers</code>中没有找到请求头<code>Content-Type</code>。</p><p>所以，我们修改一下代码，增加Content-Type。<br>我们在crossdomain-server的CrossFilter中增加：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">resp.addHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Content-Type"</span>);</span><br></pre></td></tr></table></figure></p><p>这次请求成功了<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-2/59491218.jpg" alt=""><br>可以看到postJson实际发送了2个请求，第一个是OPTIONS，它返回200后，浏览器再次发送了我们要请求的。</p><blockquote><p>简单请求：<br>请求方法为GET，POST，HEAD。<br>且请求header中无自定义请求头，且Content-type为下面几种：text/plain,multipart/form-data,application/x-www-form-urlencoded.</p></blockquote><blockquote><p>非简单请求：<br>put,delete方法的Ajax请求<br>发送json格式的Ajax请求<br>带自定义请求头的Ajax请求<br>比如一个post的json请求，实际浏览器先发出一个OPTIONS预检命令，然后才发送的POST请求。可以在Filter中增加请求头Access-Control-Max-Age:3600(数字秒）来缓存预检命令的结果，这样在指定的时间内浏览器不会再次发送预检命令。</p></blockquote><h3 id="3-服务器代理"><a href="#3-服务器代理" class="headerlink" title="3.服务器代理"></a>3.服务器代理</h3><h4 id="使用nginx解决跨域"><a href="#使用nginx解决跨域" class="headerlink" title="使用nginx解决跨域"></a>使用nginx解决跨域</h4><p>我们使用nginx帮我们对请求做了转发，将b.com的请求转发到<a href="http://localhost:8080，同时设置了相关的响应头。">http://localhost:8080，同时设置了相关的响应头。</a></p><p>1.修改本机hosts文件，将b.com映射到127.0.0.1；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 b.com</span><br></pre></td></tr></table></figure></p><p>2.在nginx.conf文件最后（最后一个}上面）增加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include vhost/*.conf;</span><br></pre></td></tr></table></figure></p><p>3.在nginx.conf同级目录增加vhost目录，并在下面创建b.com.conf文件。<br>b.com.conf文件内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    # 监听80端口</span><br><span class="line">    listen 80;</span><br><span class="line">    # 监控的域名</span><br><span class="line">    server_name b.com;</span><br><span class="line">    # 拦截所有请求</span><br><span class="line">    location /&#123;</span><br><span class="line">        # 将请求转发给http://localhost:8080/</span><br><span class="line">        proxy_pass http://localhost:8080/;</span><br><span class="line">        </span><br><span class="line">        # 允许访问所有的方法    </span><br><span class="line">        add_header Access-Control-Allow-Methods *;</span><br><span class="line">        # 设置预检命令的有效期</span><br><span class="line">        add_header Access-Control-Max-Age 3600;</span><br><span class="line">        # 允许凭据</span><br><span class="line">        add_header Access-Control-Allow-Credentials true;</span><br><span class="line">        # 使用$http_orgin获取请求头orgin的值</span><br><span class="line">        add_header Access-Control-Allow-Origin $http_origin;</span><br><span class="line">        # 使用$http_access_control_request_headers获取请求头Access-Control-Request-Headers的值</span><br><span class="line">        add_header Access-Control-Allow-Headers $http_access_control_request_headers;</span><br><span class="line"></span><br><span class="line">        # 如果是预检命令，直接返回200OK</span><br><span class="line">        if ($request_method = OPTIONS)&#123;</span><br><span class="line">            return 200;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4.crossdomain-server修改<br>注释掉CrossFilter的使用代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  @Bean</span></span><br><span class="line"><span class="comment">//  public FilterRegistrationBean crossFilter() &#123;</span></span><br><span class="line"><span class="comment">//      FilterRegistrationBean bean = new FilterRegistrationBean();</span></span><br><span class="line"><span class="comment">//      bean.addUrlPatterns("/*");</span></span><br><span class="line"><span class="comment">//      bean.setFilter(new CrossFilter());</span></span><br><span class="line"><span class="comment">//      return bean;</span></span><br><span class="line"><span class="comment">//  &#125;</span></span><br></pre></td></tr></table></figure></p><p>5.crossdomain-client修改<br>将<a href="http://localhost:8080改成http://b.com">http://localhost:8080改成http://b.com</a><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> base = <span class="string">"http://b.com/test"</span>;</span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure></p><p>6.测试<br>cmd切换到ningx所在目录，使用nginx -t先测试一下配置是否正确，没问题执行start nginx启动nginx服务。  </p><p>所有请求都访问ok。<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-6/88472040.jpg" alt=""></p><h3 id="4-Spring框架解决方案"><a href="#4-Spring框架解决方案" class="headerlink" title="4.Spring框架解决方案"></a>4.Spring框架解决方案</h3><p>在Controller上增加@CrossOrigin注解即可。</p><h3 id="5-调用方解决跨域——隐藏跨域"><a href="#5-调用方解决跨域——隐藏跨域" class="headerlink" title="5.调用方解决跨域——隐藏跨域"></a>5.调用方解决跨域——隐藏跨域</h3><p>这里仍然借助nginx来实现。原理就是在调用方的页面请求使用相对路径，让浏览器认为跨域的请求（crossdomain-server）和调用发（crossdomain-client）是在同一个域（crossdomain-client的域）。而在nginx中，将跨域的请求转发给实际的被调用方（crossdomain-server）。</p><p>a.修改hosts，增加本机IP到a.com的映射；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 a.com</span><br></pre></td></tr></table></figure></p><p>b.在nginx的conf目录新建vhost目录，并在该目录下新建文件a.com.conf，文件内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    # 监听80端口</span><br><span class="line">    listen 80;</span><br><span class="line">    # 监控a.com</span><br><span class="line">    server_name a.com;</span><br><span class="line"></span><br><span class="line">    # 将所有请求转发到http://localhost:8081/</span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://localhost:8081/;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # 将/crossdomain-server请求转发到http://localhost:8080/</span><br><span class="line">    location /crossdomain-server&#123;</span><br><span class="line">        proxy_pass http://localhost:8080/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>c.nginx.conf修改<br>在文件最后（大括号上面）增加下面的配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include vhost/*.conf;</span><br></pre></td></tr></table></figure></p><p>将vhost下面的所有.conf结尾的文件都加载进来。</p><p>d.crossdomain-server修改<br>去掉TestController上的@CrossOrigin注解。</p><p>e.crossdomain-client修改<br>将<code>var base = &quot;http://localhost:8080/test&quot;;</code>修改为<code>var base = &quot;/crossdomain-server/test&quot;;</code>。</p><p>测试：浏览器输入<a href="a.com">a.com</a>，回车<br><img src="http://omh46px9n.bkt.clouddn.com/18-6-7/64215854.jpg" alt=""><br>所有请求全部成功。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Ajax跨域的解决方法有很多，使用时要根据实际的情况选择合适的解决方法。</p><p>可以参考慕课网的课程<a href="https://www.imooc.com/video/16571">https://www.imooc.com/video/16571</a>讲的很详细。</p><p>代码：<a href="https://gitee.com/qincd/crossdomain-demo">https://gitee.com/qincd/crossdomain-demo</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Metrics+Influxdb+Grafana监控系统并图表展示</title>
      <link href="/2018/05/15/use-metrics-influxdb-grafana-monitor-system/"/>
      <url>/2018/05/15/use-metrics-influxdb-grafana-monitor-system/</url>
      
        <content type="html"><![CDATA[<p>Metrics即度量的意思，我们对系统做监控、统计等就需要用到Metrics。<br>metrics地址：<a href="https://github.com/dropwizard/metrics">https://github.com/dropwizard/metrics</a>。<br>文档地址：<a href="https://metrics.dropwizard.io/4.0.0/">https://metrics.dropwizard.io/4.0.0/</a>。</p><blockquote><p>本文使用的metrics-core和metrics-influxdb版本如下：<br><code>metrics-core=4.0.0</code><br><code>metrics-influxdb=0.8.0</code><br><code>jdk版本1.8</code></p></blockquote><h2 id="使用metrics统计controller的访问数"><a href="#使用metrics统计controller的访问数" class="headerlink" title="使用metrics统计controller的访问数"></a>使用metrics统计controller的访问数</h2><h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><p>添加metrics-core<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.dropwizard.metrics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;metrics.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>定义Metric配置<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetricsConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MetricRegistry <span class="title">metricRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MetricRegistry registry = <span class="keyword">new</span> MetricRegistry();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 输出到控制台</span></span><br><span class="line">        ConsoleReporter reporter = ConsoleReporter.forRegistry(registry)</span><br><span class="line">                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">                .build();</span><br><span class="line">        reporter.start(<span class="number">5</span>,TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">return</span> registry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Meter <span class="title">userControllerMeter</span><span class="params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">        Meter meter = registry.meter(<span class="string">"userControllerMeter"</span>);</span><br><span class="line">        <span class="keyword">return</span> meter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试Controller：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"userControllerMeter"</span>)</span><br><span class="line">    <span class="keyword">private</span> Meter userControllerMeter;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 存储用户信息的List。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,String&gt; userInfos = <span class="keyword">new</span> HashMap&lt;String,String&gt;(<span class="number">5</span>) &#123;&#123;</span><br><span class="line">        put(<span class="string">"test"</span>,<span class="string">"测试用户"</span>);</span><br><span class="line">        put(<span class="string">"root"</span>,<span class="string">"root用户"</span>);</span><br><span class="line">        put(<span class="string">"admin"</span>,<span class="string">"管理员"</span>);</span><br><span class="line">    &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">test</span><span class="params">(ModelAndView mv, @RequestParam String userid)</span> </span>&#123;</span><br><span class="line">        userControllerMeter.mark();</span><br><span class="line"></span><br><span class="line">        String user = getUserById(userid);</span><br><span class="line"></span><br><span class="line">        mv.setViewName(<span class="string">"/test"</span>);</span><br><span class="line">        mv.addObject(<span class="string">"user"</span>,user);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟一个获取用户信息的操作。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getUserById</span><span class="params">(String userid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(userid)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里模拟是一个耗时的操作，比如从其他系统获取用户信息。</span></span><br><span class="line">        <span class="keyword">long</span> sleepTime = (<span class="keyword">long</span>) (Math.random()*<span class="number">10</span>*<span class="number">1000</span>+<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(sleepTime);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userInfos.get(userid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在浏览器中输入<a href="http://localhost:8081/user/get?userid=test">http://localhost:8081/user/get?userid=test</a>，并访问多次。<br>控制台输出：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/60515899.jpg" alt=""><br>可以看到，Meters统计了总的访问次数，当前的频率（每秒多少次），1分钟内、5分钟内、15分钟内的频率。</p><h2 id="使用Metrics统计某个方法的调用时间"><a href="#使用Metrics统计某个方法的调用时间" class="headerlink" title="使用Metrics统计某个方法的调用时间"></a>使用Metrics统计某个方法的调用时间</h2><p>这里我们统计调用UserController中<br>1.MetricsConfig增加：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Timer <span class="title">getUserTime</span><span class="params">(MetricRegistry registry)</span> </span>&#123;</span><br><span class="line">    Timer timer = registry.timer(<span class="string">"getUserTimeTimer"</span>);</span><br><span class="line">    <span class="keyword">return</span> timer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.UserController修改<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="meta">@Qualifier</span>(<span class="string">"getUserTime"</span>)</span><br><span class="line"><span class="keyword">private</span> Timer getUserTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计调用getUserById耗费的时间</span></span><br><span class="line">Timer.Context context = getUserTime.time();</span><br><span class="line">String user = getUserById(userid);</span><br><span class="line">context.stop();</span><br></pre></td></tr></table></figure></p><p>在浏览器中输入<a href="http://localhost:8081/user/get?userid=test">http://localhost:8081/user/get?userid=test</a>，并访问多次。<br>控制台输出：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/70506139.jpg" alt=""><br>可以看到，Timer统计了总的调用次数，当前的调用次数（每秒多少次）、1分钟、5分钟、15分钟，最小耗时，最大耗时，平均耗时，75%的调用耗时，95%,98%,99%的调用耗时。</p><h2 id="Metrics数据的可视化"><a href="#Metrics数据的可视化" class="headerlink" title="Metrics数据的可视化"></a>Metrics数据的可视化</h2><p>这里以Influxdb和Grafana来构建一个实时的监控界面。<br>处理流程如下：采集数据（Metrics）——&gt;存储数据（InfluxDB）——&gt;展示数据（Grafana）。</p><h3 id="安装InfluxDB"><a href="#安装InfluxDB" class="headerlink" title="安装InfluxDB"></a>安装InfluxDB</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget http://dl.influxdata.com/influxdb/releases/influxdb-0.12.2-1.x86_64.rpm</span><br><span class="line">yum localinstall influxdb-0.12.2-1.x86_64.rpm</span><br></pre></td></tr></table></figure><p>安装后启动服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service influxdb start</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/41894403.jpg" alt=""><br>启动成功后，浏览器输入ip:8083访问。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/11485994.jpg" alt=""><br>到设置中，<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/82080950.jpg" alt=""><br>可以看到http端口为8086，用户名和密码为空，这里我们设置用户名和密码都为root。</p><h3 id="安装Grafana"><a href="#安装Grafana" class="headerlink" title="安装Grafana"></a>安装Grafana</h3><p>参考：<a href="https://blog.csdn.net/syshzbtt/article/details/71574204">https://blog.csdn.net/syshzbtt/article/details/71574204</a>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.2.0-1.x86_64.rpm </span><br><span class="line">sudo yum localinstall grafana-4.2.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure></p><p>安装后启动服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service grafana-server start</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/46363534.jpg" alt=""><br>浏览器输入IP:3000访问，用户名和密码为admin。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/54436848.jpg" alt=""></p><h3 id="将数据收集到Influxdb"><a href="#将数据收集到Influxdb" class="headerlink" title="将数据收集到Influxdb"></a>将数据收集到Influxdb</h3><p>前面我们将数据直接输出到控制台，我们制定的Metrics Reporter为<code>ConsoleReporter</code>，这里写入Influxdb，需要引入一个依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.davidb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>metrics-influxdb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;metrics.influxdb.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>MetricsConfig修改：<br>我们将收集到的统计数据发送到InfluxDB<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ScheduledReporter reporter = InfluxdbReporter.forRegistry(registry)</span><br><span class="line">        <span class="comment">// influxdb的ip,port，用户名,密码,数据库</span></span><br><span class="line">        .protocol(InfluxdbProtocols.http(<span class="string">"192.168.200.99"</span>,<span class="number">8086</span>,<span class="string">"root"</span>,<span class="string">"root"</span>,<span class="string">"my-influxdb"</span>))</span><br><span class="line">        .convertRatesTo(TimeUnit.SECONDS)</span><br><span class="line">        .convertDurationsTo(TimeUnit.MILLISECONDS)</span><br><span class="line">        .filter(MetricFilter.ALL)</span><br><span class="line">        .skipIdleMetrics(<span class="keyword">false</span>)</span><br><span class="line">        .build();</span><br><span class="line">reporter.start(<span class="number">5</span>,TimeUnit.SECONDS);</span><br></pre></td></tr></table></figure></p><p>我们到InfluxDB的管理页面创建一个数据库<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/8029046.jpg" alt=""><br>点击<code>Create Database</code>，在Query中填入<code>CREATE DATABASE &quot;my-influxdb&quot;</code><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/74584176.jpg" alt=""><br>然后回车，数据库就创建好了。</p><p>在Grafana的管理页面新建一个<code>DataSource</code>，<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/3494788.jpg" alt=""></p><p>在<code>Home</code>页面，New一个dashboard<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/78793334.jpg" alt=""><br>点<code>Graph</code><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/87791693.jpg" alt=""><br>点<code>Panel Title</code><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/42931639.jpg" alt=""><br>点<code>Edit</code><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/54009636.jpg" alt=""><br>点<code>General</code>可以修改标题<br>在<code>Metrics</code>中，点SQL可以可视化编辑SQL。<code>A From</code>后面的<code>default</code>是默认数据源（在上面新建数据源时可以指定为默认数据源，或自己指定为你上面创建数据源名称），<code>userControllerMeter</code>是表名。在上面MetricsConfig中指定的名称，我们也可以在Influxdb中根据它来查询。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/92082805.jpg" alt=""><br>第二行<code>field(value)</code>即我们要监控的指标，这里对应的就是<code>count</code>字段，<code>ALIAY BY</code>即是字段的别名，图表中显示用。点空白处，如果图表还是没数据，将日期显示范围扩大。<br>这样，就可以看到如下的图表<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-15/30048921.jpg" alt=""></p><p>遇到的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.UnsupportedClassVersionError: com/justin/metrics/config/MetricsConfig : Unsupported major.minor version 52.0 (unable to load class com.justin.metrics.config.MetricsConfig)。</span><br></pre></td></tr></table></figure></p><p>我的metrics-demo模块用的jdk7，引入的metrics-influxdb版本是0.8.2（mvn仓库最低就是这个版本），但0.8.2使用的jdk8编译的，所以有这个问题。<br>但是，将metrics-demo模块的jdk改成1.8后，还是有这个问题。最后更改整个project的版本为1.8解决。</p><p>这里只是作为一个演示，这是偏运维的东西，但作为开发人员还是有必要了解一下。</p><p>参考：<a href="https://www.jianshu.com/p/e4f70ddbc287">https://www.jianshu.com/p/e4f70ddbc287</a>、<a href="https://www.jianshu.com/p/fadcf4d92b0e">https://www.jianshu.com/p/fadcf4d92b0e</a>。</p><p>源代码：<a href="https://gitee.com/qincd/my-test-projects/">https://gitee.com/qincd/my-test-projects/</a>下<code>metrics-demo</code>模块。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xshell评估过期或免费使用</title>
      <link href="/2018/05/15/xshell-expiration-of-assessment-or-free-use/"/>
      <url>/2018/05/15/xshell-expiration-of-assessment-or-free-use/</url>
      
        <content type="html"><![CDATA[<p>xshell出现下面的评估过期的错误<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-14/95474630.jpg" alt=""></p><p>解决办法：<br>进入<a href="https://www.netsarang.com/download/free_license.html">https://www.netsarang.com/download/free_license.html</a>页面，点击“Download”<br>，这个页面是Free License的。</p><p>然后填入下面的个人信息（邮箱要正确）<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-14/10271641.jpg" alt=""></p><p>然后会给你发送一封邮件，进入邮件<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-14/78663230.jpg" alt=""><br>点击链接下载软件，进行安装。安装的即为<code>Free for Home/School</code>版本，就可以免费使用了。</p><blockquote><p>默认现在的软件安装后是需要License的。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea修改背景色</title>
      <link href="/2018/05/12/idea-background-settings/"/>
      <url>/2018/05/12/idea-background-settings/</url>
      
        <content type="html"><![CDATA[<p>首先，护眼的颜色RGB分别为199,237,204,16进制为#C7EDCC。</p><h2 id="编辑器区域背景色的设置"><a href="#编辑器区域背景色的设置" class="headerlink" title="编辑器区域背景色的设置"></a>编辑器区域背景色的设置</h2><p>在Idea的settings-&gt;Editor-&gt;Colors&amp;Fonts-&gt;General中，将Default Text的背景色设置为上面的颜色。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/23505651.jpg" alt=""><br><a id="more"></a></p><h2 id="控制台区域背景色设置"><a href="#控制台区域背景色设置" class="headerlink" title="控制台区域背景色设置"></a>控制台区域背景色设置</h2><p>在idea的settings-&gt;Editor-&gt;Color&amp;Fonts-&gt;Console Colors将Console background设置为上面的颜色。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/17660851.jpg" alt=""></p><h2 id="左侧项目列表的背景色设置"><a href="#左侧项目列表的背景色设置" class="headerlink" title="左侧项目列表的背景色设置"></a>左侧项目列表的背景色设置</h2><p>如果只进行上面的设置，会发现左侧项目列表背景色没变。我们需要通过设置windows窗口的背景色来实现。</p><p>这里以windows7为例，进入个性化，<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/15486584.jpg" alt=""><br>选择“窗口颜色”，<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/23201683.jpg" alt=""><br>选择“高级外观设置”，选择“窗口”，<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/54750500.jpg" alt=""><br>然后点“颜色”下拉框，点“其他颜色”，然后输入上面的RGB值，然后点“添加到自定义颜色”，最后确定即可。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/38835272.jpg" alt=""></p><p>idea还有一点设置，将主题设置为windows。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/31689876.jpg" alt=""></p><p>最后效果图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-12/1670395.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>轻量级的java HTTP Server——NanoHttpd</title>
      <link href="/2018/05/11/Nano-httpd-simple-usage/"/>
      <url>/2018/05/11/Nano-httpd-simple-usage/</url>
      
        <content type="html"><![CDATA[<p>NanoHTTPD是一个免费、轻量级的(只有一个Java文件) HTTP服务器,可以很好地嵌入到Java程序中。支持 GET, POST, PUT, HEAD 和 DELETE 请求，支持文件上传，占用内存很小。<br>github地址：<a href="https://github.com/NanoHttpd/nanohttpd">https://github.com/NanoHttpd/nanohttpd</a>。</p><p>maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.nanohttpd<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span> <span class="comment">&lt;!-- &lt;groupId&gt;com.nanohttpd&lt;/groupId&gt; for 2.1.0 and earlier --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nanohttpd<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>官网demo：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">package</span> com.example;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> fi.iki.elonen.NanoHTTPD;</span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> If you're using NanoHTTPD &gt;= 3.0.0 the namespace is different,</span></span><br><span class="line"><span class="comment">//       instead of the above import use the following:</span></span><br><span class="line"><span class="comment">// import org.nanohttpd.NanoHTTPD;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">NanoHTTPD</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">App</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="number">8080</span>);</span><br><span class="line">        start(NanoHTTPD.SOCKET_READ_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">        System.out.println(<span class="string">"\nRunning! Point your browsers to http://localhost:8080/ \n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">new</span> App();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            System.err.println(<span class="string">"Couldn't start server:\n"</span> + ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Response <span class="title">serve</span><span class="params">(IHTTPSession session)</span> </span>&#123;</span><br><span class="line">        String msg = <span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello server&lt;/h1&gt;\n"</span>;</span><br><span class="line">        Map&lt;String, String&gt; parms = session.getParms();</span><br><span class="line">        <span class="keyword">if</span> (parms.get(<span class="string">"username"</span>) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            msg += <span class="string">"&lt;form action='?' method='get'&gt;\n  &lt;p&gt;Your name: &lt;input type='text' name='username'&gt;&lt;/p&gt;\n"</span> + <span class="string">"&lt;/form&gt;\n"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msg += <span class="string">"&lt;p&gt;Hello, "</span> + parms.get(<span class="string">"username"</span>) + <span class="string">"!&lt;/p&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newFixedLengthResponse(msg + <span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行App，浏览器打开<a href="http://localhost:8080/">http://localhost:8080/ </a>即可看到效果。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-11/92840333.jpg" alt=""></p><p>输入username，然后回车：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-11/69200993.jpg" alt=""></p><p>这样一个简单的登录功能就完成了。</p><p>问题：<br>如果form中指定action为post，你会发现后台session获取不到参数。<br>解决办法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.parseBody(<span class="keyword">new</span> HashMap());</span><br><span class="line">params = session.getParms();</span><br></pre></td></tr></table></figure></p><p>意思也就是，对于post请求，你需要先调用parseBody()方法，直接传一个简单的新构造的map就行了，然后再调用getParams()方法。<br>参考：<a href="https://blog.csdn.net/obguy/article/details/53841559">https://blog.csdn.net/obguy/article/details/53841559</a>。</p><p>示例代码：<a href="https://gitee.com/qincd/my-test-projects/tree/master/test1">https://gitee.com/qincd/my-test-projects/tree/master/test1</a>下的<code>com.tommy.core.test.nanohttpd</code>包下。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>通过java反射实现简易的springmvc</title>
      <link href="/2018/05/10/write-springmvc-by-java-reflect/"/>
      <url>/2018/05/10/write-springmvc-by-java-reflect/</url>
      
        <content type="html"><![CDATA[<p>通过java反射实现的简易的spring ioc和springmvc的一部分功能，很多东西没有考虑进去，只是提供一种思路。<br><strong>简易实现spring的ioc和springmvc</strong>.</p><p>思路：<br>模仿SpringMVC定义如下几个注解。<br>@Service:Service层注解；<br>@Controller：Controller注解；<br>@Autowired：自动注入依赖；<br>@RequestMapping：定义请求的url映射。<br><a id="more"></a><br>假定我们又UserController，定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Contorller</span>(<span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userService.insert(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/user"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/showUserList.htm"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">showUserList</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView(<span class="string">"/list"</span>);</span><br><span class="line">        List&lt;User&gt; users = userService.getAll();</span><br><span class="line">        mv.addObject(<span class="string">"users"</span>,users);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们在系统启动时，就根据配置的basePackage扫描该基础包下所有的@Service和@Controller的类。<br>1.springioc部分，解决依赖注入问题<br>定义HashMap&lt;String,Object&gt;维护类的全限定名与实例对象的关系，将所有注解了@Service和@Controller的类初始化。<br>然后扫描所有注解的类，扫描所有的Field，如果是被@Autowired注解，则从上面的Map中取出实例对象进行设置。–》依赖注入</p><p>如果被@Autowired注解的是接口，则会遍历所有的@Service和@Controller的对象，找出其实现类，并注入。</p><p>2.springmvc部分，遍历所有上面的Map中的对象，如果是@Controller注解的类，则：<br>a.读取@Controller的value，即得到上面示例URL中的/user部分。<br>b.遍历所有的方法，如果是被@RequestMapping注解，则取出其value，即示例中的/add部分。</p><p>3.定义DispatcherServlet，作为所有请求的入口类<br>通过request.getRequestURI()获取到请求的uri，比如/myspring-mvc/user/add。通过request.getContextPath()获取到上下文名称，将uri中项目上下文去掉，即得到/user/add。<br>然后通过上面的springmvc部分的Map可以获取到Method，通过method.invoke方法调用Controller类的处理方法。可以参考Springmvc返回String或ModelAndView渲染页面。<br>如果返回String，即视图名称，可以根据String是否包括forward或redirect关键字，像springmvc一样进行forward或redirect处理。数据则根据request进行设置即可。</p><p>本例测试：</p><p>错误的URL测试：<br><a href="http://localhost:8081/myspring-mvc/test/index2.htm">http://localhost:8081/myspring-mvc/test/index2.htm</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-9/24982881.jpg" alt=""></p><blockquote><p>url可以随意写，只要不是/test/index.htm和/test/showUserList.htm都可以。</p></blockquote><p>不带数据的测试：<br><a href="http://localhost:8081/myspring-mvc/test/index.htm">http://localhost:8081/myspring-mvc/test/index.htm</a></p><p>带数据的测试：<br><a href="http://localhost:8081/myspring-mvc/test/showUserList.htm">http://localhost:8081/myspring-mvc/test/showUserList.htm</a>，效果：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-9/45332363.jpg" alt=""></p><p>这里只是简易版本的实现，还有很多因素没有考虑，仅仅是结合反射来实现一个简易版的springmvc功能。</p><p>源代码：<a href="https://gitee.com/qincd/my-test-projects">https://gitee.com/qincd/my-test-projects</a>下的myspring-mvc模块。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>对视频播放url进行Blob加密</title>
      <link href="/2018/05/05/video-url-blob-encrypt/"/>
      <url>/2018/05/05/video-url-blob-encrypt/</url>
      
        <content type="html"><![CDATA[<p>在知乎上看到一个视频，准备下载下来，结果下载不了，复制地址发现是blob://xxx。知乎帖子：<a href="https://www.zhihu.com/question/62753680/answer/382455062">https://www.zhihu.com/question/62753680/answer/382455062</a>。</p><p>百度发现是对视频地址进行了blob加密，文章地址：<a href="https://blog.csdn.net/qq_36688143/article/details/79162013">https://blog.csdn.net/qq_36688143/article/details/79162013</a>。</p><p>下面是使用Java Servlet+html5 video结合实现的一个对视频地址进行blob加密的示例。代码参考上文链接。<br><a id="more"></a><br>后台Servlet:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBlobVideoServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"C:\\Users\\Administrator\\Desktop\\102_d41c7dd69f5eba69800d5c3401a3c384_1.mp4"</span>);</span><br><span class="line">        String fileName = file.getName();</span><br><span class="line">        String userAgent = req.getHeader(<span class="string">"User-Agent"</span>).toLowerCase();</span><br><span class="line">        <span class="keyword">if</span> (userAgent.indexOf(<span class="string">"firefox"</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">            resp.addHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + <span class="keyword">new</span> String(fileName.getBytes(<span class="string">"GB2312"</span>), <span class="string">"ISO-8859-1"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.addHeader(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment;filename="</span> + URLEncoder.encode(fileName, <span class="string">"UTF-8"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置response编码</span></span><br><span class="line">        resp.setCharacterEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        resp.addHeader(<span class="string">"Content-Length"</span>, <span class="string">""</span> + file.length());</span><br><span class="line">        <span class="comment">//设置输出文件类型</span></span><br><span class="line">        resp.setContentType(<span class="string">"video/mpeg4"</span>);</span><br><span class="line"></span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream os = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取response输出流</span></span><br><span class="line">            os = resp.getOutputStream();</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="keyword">int</span> len;</span><br><span class="line">            <span class="keyword">while</span> ((len = fis.read(buffer)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 输出文件</span></span><br><span class="line">                os.write(buffer,<span class="number">0</span>,len);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != fis) &#123;</span><br><span class="line">                fis.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != os) &#123;</span><br><span class="line">                os.flush();</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>页面：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=gbk"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>blob video demo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">id</span>=<span class="string">"sound"</span> <span class="attr">width</span>=<span class="string">"500"</span> <span class="attr">height</span>=<span class="string">"300"</span> <span class="attr">controls</span>=<span class="string">"controls"</span>&gt;</span><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="comment">//创建XMLHttpRequest对象</span></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</span></span><br><span class="line"><span class="javascript">    <span class="comment">//配置请求方式、请求地址以及是否同步</span></span></span><br><span class="line"><span class="javascript">    xhr.open(<span class="string">'POST'</span>, <span class="string">'/play'</span>, <span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">    <span class="comment">//设置请求结果类型为blob</span></span></span><br><span class="line"><span class="javascript">    xhr.responseType = <span class="string">'blob'</span>;</span></span><br><span class="line"><span class="javascript">    <span class="comment">//请求成功回调函数</span></span></span><br><span class="line"><span class="javascript">    xhr.onload = <span class="function"><span class="keyword">function</span> (<span class="params">e</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (<span class="keyword">this</span>.status == <span class="number">200</span>) &#123;<span class="comment">//请求成功</span></span></span><br><span class="line"><span class="javascript">            <span class="comment">//获取blob对象</span></span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> blob = <span class="keyword">this</span>.response;</span></span><br><span class="line"><span class="javascript">            <span class="comment">//获取blob对象地址，并把值赋给容器</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">'sound'</span>).src=URL.createObjectURL(blob);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    xhr.send();</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>效果展示：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-5/94631648.jpg" alt=""></p><p>代码：<a href="https://gitee.com/qincd/my-test-projects">https://gitee.com/qincd/my-test-projects</a>下blob-video模块。</p><blockquote><p>不过，知乎的对视频做了切割。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决Maven生成项目很慢的问题</title>
      <link href="/2018/05/05/maven-generate-project-too-slow/"/>
      <url>/2018/05/05/maven-generate-project-too-slow/</url>
      
        <content type="html"><![CDATA[<p><img src="http://omh46px9n.bkt.clouddn.com/18-5-5/36077377.jpg" alt=""><br>如上图标红部分，加上<code>archetypeCatalog=internal</code>，不加这个参数，在maven生成骨架的时候将会非常慢，有时候会直接卡住。</p><p>来自网上的解释：<br>archetypeCatalog表示插件使用的archetype元数据，不加这个参数时默认为remote，local，即中央仓库archetype元数据，由于中央仓库的archetype太多了，所以导致很慢，指定internal来表示仅使用内部元数据。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Jenkins配置+Maven的自动化构建</title>
      <link href="/2018/05/04/use-jenkins-and-maven-automake-project/"/>
      <url>/2018/05/04/use-jenkins-and-maven-automake-project/</url>
      
        <content type="html"><![CDATA[<p>jenkins的搭建参考前一篇文章：<a href="http://tommy88.top/Linux下安装和配置jenkins">Linux下安装和配置jenkins</a>.<br>本篇文章介绍如何通过jenkins+maven自动化构建Web应用。</p><h2 id="git插件安装与配置"><a href="#git插件安装与配置" class="headerlink" title="git插件安装与配置"></a>git插件安装与配置</h2><p>如果git没有安装或配置不当，在新建任务时，会产生下面的问题。<br>问题：<br>1.jenkins Error performing command: git ls-remote -h<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/8533399.jpg" alt=""><br><a id="more"></a><br>解决：<br>查看jenkins已经安装了git插件，但仍然提示这个错误。在Jenkins所在的服务器上发现git没有安装。<br>使用<code>git --version</code><br>参考地址：<a href="https://blog.csdn.net/wangfei0904306/article/details/56011877">https://blog.csdn.net/wangfei0904306/article/details/56011877</a></p><p>从另外一篇文章说需要使用源码的方式安装，地址：<a href="https://blog.csdn.net/u013256816/article/details/54743470">https://blog.csdn.net/u013256816/article/details/54743470</a><br>好吧，那就来安装吧。<br>1.从<a href="https://mirrors.edge.kernel.org/pub/software/scm/git/">https://mirrors.edge.kernel.org/pub/software/scm/git/</a>下载git最新版；<br>2.参考上面链接的源码安装方式进行安装。<br>这里贴一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">安装依赖的包 </span><br><span class="line">yum install curl-devel expat-devel gettext-devel openssl-devel zlib-devel gcc perl-ExtUtils-MakeMaker</span><br><span class="line"></span><br><span class="line">下载git源码并解压 </span><br><span class="line">目前最新版本下载地址：https://github.com/git/git/releases/tag/v2.11.0 </span><br><span class="line">解压 tar zxvf git-2.11.0.tar.gz </span><br><span class="line">cd git-2.11.0</span><br><span class="line"></span><br><span class="line">编译安装 </span><br><span class="line">make prefix=/usr/local/git all </span><br><span class="line">make prefix=/usr/local/git install</span><br><span class="line"></span><br><span class="line">配置环境变量 </span><br><span class="line">vim /etc/profile </span><br><span class="line">加入export PATH=$PATH:/usr/local/git/bin </span><br><span class="line">生效配置文件 source /etc/profile</span><br><span class="line"></span><br><span class="line">查看git </span><br><span class="line">whereis git </span><br><span class="line">git –version</span><br></pre></td></tr></table></figure></p><p>最后使用<code>git --version</code>看到下面的图说明已经安装成功。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/98352258.jpg" alt=""></p><p>然后在jenkins的系统设置-&gt;全局工具配置界面，配置git的路径。<br><code>Path to git executable</code>填入： “whereis git”的地址 + “/bin/git” （如上面”whereis git”的地址为”/usr/local/git”，则应该填入 “/usr/local/git/bin/git”） 并保存<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/81733967.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/42900009.jpg" alt=""><br>参考这篇文章：<a href="https://blog.csdn.net/wangfei0904306/article/details/56011877">https://blog.csdn.net/wangfei0904306/article/details/56011877</a></p><h2 id="maven安装与配置"><a href="#maven安装与配置" class="headerlink" title="maven安装与配置"></a>maven安装与配置</h2><p>参考：linux下maven安装参考<a href="https://www.cnblogs.com/jimisun/p/8054819.html">https://www.cnblogs.com/jimisun/p/8054819.html</a><br>maven安装后记得在jenkins的系统配置-&gt;全局工具配置中配置maven的MAVEN_HOME。</p><h2 id="JAVA-HOME的配置"><a href="#JAVA-HOME的配置" class="headerlink" title="JAVA_HOME的配置"></a>JAVA_HOME的配置</h2><p>前一篇文章已经讲了，因为jenkins启动依赖Java，所以已经安装和配置了Java环境。还需要在jenkins的系统设置-&gt;全局工具配置-&gt;JDK配置JAVA_HOME。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/91487035.jpg" alt=""></p><h2 id="新建一个任务"><a href="#新建一个任务" class="headerlink" title="新建一个任务"></a>新建一个任务</h2><p>配置git仓库地址<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/43859163.jpg" alt=""><br>配置Maven执行目标<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/43957886.jpg" alt=""><br>配置发布到容器<br>这里我们将应用部署到tomcat，需要安装一个插件.<br>在jenkins系统设置-&gt;插件管理-&gt;可选插件汇总搜索<code>Deploy to container</code>，找到插件并安装。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/29429594.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/94594431.jpg" alt=""></p><p>配置tomcat用户<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/44236479.jpg" alt=""></p><p>tomcat配置<br>找到tomcat–&gt;config–&gt;tomcat-users.xml<br>打开后在<code>&lt;tomcat-users&gt;&lt;/tomcat-users&gt;</code>之间增加如下用户信息：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"manager-gui"</span>&gt;</span><span class="tag">&lt;/<span class="name">role</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"manager-script"</span>&gt;</span><span class="tag">&lt;/<span class="name">role</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"tomcat"</span> <span class="attr">password</span>=<span class="string">"admin"</span> <span class="attr">roles</span>=<span class="string">"manager-gui,manager-script"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>最后保存设置，执行构建即可。</p><p>jenkins每次构建时，都会自动从git上更新，然后打包，最后发布到tomcat中。这样开发环境提交的修改，执行一次构建测试环境就可以看到最新的内容，十分方便。</p><p><strong>注意</strong><br>这里要部署的tomcat必须是启动的。因为<code>Deploy to container</code>插件实际是使用的tomcat的管理控制台来部署应用的。<br>地址：<a href="http://vm1.com:8080/manager/html">http://vm1.com:8080/manager/html</a>，输入我们上面配置tomcat用户的地方的用户名和密码进入。<br>然后选择war包即可。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/1106392.jpg" alt=""></p><p>所以说，这里应用的tomcat必须是启动的。<br>否则，构建时，会出现拒绝连接的错误。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/9137165.jpg" alt=""></p><p>参考：<a href="https://blog.csdn.net/tengxing007/article/details/77626628">使用Jenkins配置+Maven的自动化构建</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下安装和配置jenkins</title>
      <link href="/2018/05/04/linux-jenkins-install-and-configuration/"/>
      <url>/2018/05/04/linux-jenkins-install-and-configuration/</url>
      
        <content type="html"><![CDATA[<p>1.从jenkins官网下载最新的jenkins的war包，地址：<a href="https://jenkins.io/">https://jenkins.io/</a>.<br>2.将jenkins.war丢到tomcat中，并启动<br>3.浏览器输入ip:port/jenkins访问Jenkins。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/8628344.jpg" alt=""><br>在启动时，在日志中可以看到jenkins生成了一个管理密码，复制该密码并粘贴到上图中，以解锁jenkins。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/30113437.jpg" alt=""></p><p>4.进入选择插件安装界面，选择第一个（安装推荐的插件）<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/76133592.jpg" alt=""></p><p>5.下一步就是创建一个jenkins的管理员<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/75245641.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/75783253.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/18551599.jpg" alt=""></p><p>问题：<br>1.Linux下，将jenkins.war放入tomcat启动报错，但在windows中启动正常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">严重: One or more listeners failed to start. Full details will be found in the appropriate container log file</span><br><span class="line">五月 04, 2018 10:34:24 下午 org.apache.catalina.core.StandardContext startInternal</span><br><span class="line">严重: Context [/jenkins] startup failed due to previous errors</span><br></pre></td></tr></table></figure></p><p>解决：<br>估计是jdk版本问题，我重新安装和配置了jdk1.8后ok。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux下JDK的安装和配置</title>
      <link href="/2018/05/04/linux-jdk-install-and-configuration/"/>
      <url>/2018/05/04/linux-jdk-install-and-configuration/</url>
      
        <content type="html"><![CDATA[<p>1.从官网下载jdk安装包，下载完成后放入Linux指定的目录。</p><blockquote><p>这里使用的rz命令上传，如果没有安装rz，可以使用<code>yum install lrzsz</code>进行安装。</p></blockquote><p>这里安装的jdk版本是jdk-7u55<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/3708395.jpg" alt=""></p><p>2.解压到指定的目录<br>这里将jdk解压在/usr/java。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf /data/jdk-7u55-linux-x64.gz -C /usr/java</span><br></pre></td></tr></table></figure></p><p>3.配置java环境变量<br><code>vi /etc/profile</code>打开文件，<code>shift+g</code>进入文件尾部。添加如下java环境变量配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/java/jdk1.7.0_55</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export classpath=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib</span><br><span class="line">export PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;PATH&#125;</span><br></pre></td></tr></table></figure></p><p>然后:wq保存，最后使用<code>source /etc/profile</code>使配置生效。</p><p>4.测试<br>输入<code>java -verison</code>，出现如下文字即说明配置成功。<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-4/60495568.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java IDE的实现原理</title>
      <link href="/2018/05/02/java-ide-impletation-principle/"/>
      <url>/2018/05/02/java-ide-impletation-principle/</url>
      
        <content type="html"><![CDATA[<p>像Eclipse等java IDE是怎么编译和查找java源代码的呢？</p><h2 id="源代码保存"><a href="#源代码保存" class="headerlink" title="源代码保存"></a>源代码保存</h2><p>这个无需多说，在编译器写入代码，并保存到文件。这个利用流来实现。</p><h2 id="编译为class文件"><a href="#编译为class文件" class="headerlink" title="编译为class文件"></a>编译为class文件</h2><p>java提供了JavaCompiler，我们可以通过它来编译java源文件为class文件。</p><h2 id="查找class"><a href="#查找class" class="headerlink" title="查找class"></a>查找class</h2><p>可以通过<code>Class.forName(fullClassPath)</code>或自定义类加载器来实现。</p><h2 id="生成对象，并调用对象方法"><a href="#生成对象，并调用对象方法" class="headerlink" title="生成对象，并调用对象方法"></a>生成对象，并调用对象方法</h2><p>通过上面一个查找class，得到Class对象后，可以通过newInstance()或构造器的newInstance()得到对象。然后得到Method，最后调用方法，传入相关参数即可。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyIDE</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span>&#123;</span><br><span class="line">        <span class="comment">// 定义java代码，并保存到文件（Test.java）</span></span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(<span class="string">"package com.tommy.core.test.reflect;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"public class Test &#123;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"    private String name;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"    public Test(String name)&#123;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"        this.name = name;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"        System.out.println(\"hello,my name is \" + name);\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"    &#125;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"    public String sayHello(String name) &#123;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"        return \"hello,\" + name;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"    &#125;\n"</span>);</span><br><span class="line">        sb.append(<span class="string">"&#125;\n"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line"></span><br><span class="line">        String baseOutputDir = <span class="string">"F:\\output\\classes\\"</span>;</span><br><span class="line">        String baseDir = baseOutputDir + <span class="string">"com\\tommy\\core\\test\\reflect\\"</span>;</span><br><span class="line">        String targetJavaOutputPath = baseDir + <span class="string">"Test.java"</span>;</span><br><span class="line">        <span class="comment">// 保存为java文件</span></span><br><span class="line">        FileWriter fileWriter = <span class="keyword">new</span> FileWriter(targetJavaOutputPath);</span><br><span class="line">        fileWriter.write(sb.toString());</span><br><span class="line">        fileWriter.flush();</span><br><span class="line">        fileWriter.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 编译为class文件</span></span><br><span class="line">        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</span><br><span class="line">        StandardJavaFileManager manager = compiler.getStandardFileManager(<span class="keyword">null</span>,<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">        List&lt;File&gt; files = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        files.add(<span class="keyword">new</span> File(targetJavaOutputPath));</span><br><span class="line">        Iterable compilationUnits = manager.getJavaFileObjectsFromFiles(files);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 编译</span></span><br><span class="line">        <span class="comment">// 设置编译选项，配置class文件输出路径</span></span><br><span class="line">        Iterable&lt;String&gt; options = Arrays.asList(<span class="string">"-d"</span>,baseOutputDir);</span><br><span class="line">        JavaCompiler.CompilationTask task = compiler.getTask(<span class="keyword">null</span>, manager, <span class="keyword">null</span>, options, <span class="keyword">null</span>, compilationUnits);</span><br><span class="line">        <span class="comment">// 执行编译任务</span></span><br><span class="line">        task.call();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过反射得到对象</span></span><br><span class="line"><span class="comment">//        Class clazz = Class.forName("com.tommy.core.test.reflect.Test");</span></span><br><span class="line">        <span class="comment">// 使用自定义的类加载器加载class</span></span><br><span class="line">        Class clazz = <span class="keyword">new</span> MyClassLoader(baseOutputDir).loadClass(<span class="string">"com.tommy.core.test.reflect.Test"</span>);</span><br><span class="line">        <span class="comment">// 得到构造器</span></span><br><span class="line">        Constructor constructor = clazz.getConstructor(String.class);</span><br><span class="line">        <span class="comment">// 通过构造器new一个对象</span></span><br><span class="line">        Object test = constructor.newInstance(<span class="string">"jack.tsing"</span>);</span><br><span class="line">        <span class="comment">// 得到sayHello方法</span></span><br><span class="line">        Method method = clazz.getMethod(<span class="string">"sayHello"</span>, String.class);</span><br><span class="line">        <span class="comment">// 调用sayHello方法</span></span><br><span class="line">        String result = (String) method.invoke(test, <span class="string">"jack.ma"</span>);</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>自定义类加载器代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClassLoader</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String baseDir;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyClassLoader</span><span class="params">(String baseDir)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.baseDir = baseDir;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        String fullClassFilePath = <span class="keyword">this</span>.baseDir + name.replace(<span class="string">"\\."</span>,<span class="string">"/"</span>) + <span class="string">".class"</span>;</span><br><span class="line">        File classFilePath = <span class="keyword">new</span> File(fullClassFilePath);</span><br><span class="line">        <span class="keyword">if</span> (classFilePath.exists()) &#123;</span><br><span class="line">            FileInputStream fileInputStream = <span class="keyword">null</span>;</span><br><span class="line">            ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                fileInputStream = <span class="keyword">new</span> FileInputStream(classFilePath);</span><br><span class="line">                <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">                byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                <span class="keyword">while</span> ((len = fileInputStream.read(data)) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    byteArrayOutputStream.write(data,<span class="number">0</span>,len);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> defineClass(name,byteArrayOutputStream.toByteArray(),<span class="number">0</span>,byteArrayOutputStream.size());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != fileInputStream) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        fileInputStream.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != byteArrayOutputStream) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        byteArrayOutputStream.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>java源文件和编译后的class文件如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-5-2/58994753.jpg" alt=""></p><p>关于类的加载器可以参考：<a href="http://tommy88.top/2018/04/11/java-classloader/">http://tommy88.top/2018/04/11/java-classloader/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springmvc集成velocity</title>
      <link href="/2018/04/28/springmvc-and-velocity-integration/"/>
      <url>/2018/04/28/springmvc-and-velocity-integration/</url>
      
        <content type="html"><![CDATA[<p>velocity是一个基于java的模板引擎，通过特定的语法，可以获取到在java中定义的对象，从而实现页面与java代码的分离。由于JSP需要先转换为Servlet，然后编译为class执行，导致效率较低。在访问量较大时表现较差，velocity则可以作为JSP的替代。</p><p>velocity的介绍、语法等可以参考：<a href="https://www.jianshu.com/p/5913903324ff">https://www.jianshu.com/p/5913903324ff</a>。<br><a id="more"></a><br>这里是一个springmvc集成velocity的显示用户列表和修改用户信息的例子，备忘。</p><h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><p>添加velocity的相关依赖。（注：spring相关的依赖未给出）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-tools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><blockquote><p>注意：必须引入spring-context-support依赖，否则velocityConfig配置中configLocation和resourceLoaderPath属性找不到。</p></blockquote><h2 id="springmvc配置"><a href="#springmvc配置" class="headerlink" title="springmvc配置"></a>springmvc配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 自动扫描controller包下的所有类，如果@Controller注入为bean --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.tommy.velocity.controller"</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 注解驱动 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- velocity环境配置 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"velocityConfig"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.velocity.VelocityConfigurer"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- velocity配置文件路径  或者直接用velocityProperties属性 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"classpath:velocity.properties"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- velocity模板路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"resourceLoaderPath"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/view/"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- velocity视图解析器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"velocityViewResolver"</span> <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.velocity.VelocityLayoutViewResolver"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"order"</span> <span class="attr">value</span>=<span class="string">"0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"contentType"</span> <span class="attr">value</span>=<span class="string">"text/html;charset=UTF-8"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cache"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".vm"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"layoutUrl"</span> <span class="attr">value</span>=<span class="string">"layout/layout.vm"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"exposeSpringMacroHelpers"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--是否使用spring对宏定义的支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"exposeSessionAttributes"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--是否开放request属性--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"requestContextAttribute"</span> <span class="attr">value</span>=<span class="string">"request"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--request属性引用名称--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateToolAttribute"</span> <span class="attr">value</span>=<span class="string">"dateTool"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"numberToolAttribute"</span> <span class="attr">value</span>=<span class="string">"numberTool"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>velocity.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#设置字符集</span><br><span class="line">#encoding</span><br><span class="line">input.encoding=UTF-8</span><br><span class="line">output.encoding=UTF-8</span><br><span class="line">contentType=text/html;charset=UTF-8</span><br><span class="line"></span><br><span class="line">#autoreload when vm changed</span><br><span class="line">file.resource.loader.cache=false</span><br><span class="line">file.resource.loader.modificationCheckInterval  =1</span><br><span class="line">velocimacro.library.autoreload=false</span><br></pre></td></tr></table></figure></p><h2 id="web-xml配置"><a href="#web-xml配置" class="headerlink" title="web.xml配置"></a>web.xml配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 防止spring内存溢出监听器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        org.springframework.web.filter.CharacterEncodingFilter</span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>rest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>spring mvc servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">            /WEB-INF/spring-mvc.xml</span><br><span class="line">        <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>rest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意配置Spring的字符集过滤器，否则向后台提交数据时中文乱码。</p><h2 id="模板文件"><a href="#模板文件" class="headerlink" title="模板文件"></a>模板文件</h2><p>布局模板：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>$!page_title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    #parse("default/header.vm")</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    $screen_content</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>header.vm:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html;charset=UTF-8"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"no-store"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Pragma"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Expires"</span> <span class="attr">content</span>=<span class="string">"3600"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"</span> <span class="attr">name</span>=<span class="string">"viewport"</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>展示用户列表的模板：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring MVC and Velocity<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Spring MVC and Velocity<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>id<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>age<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>操作<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        #foreach($user in $users)</span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>$!&#123;user.id&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>$!&#123;user.name&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span>$!&#123;user.age&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/preEdit?userId=$&#123;user.id&#125;"</span>&gt;</span>修改<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        #end</span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>修改的模板：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Spring MVC and Velocity<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Spring MVC and Velocity<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/edit"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"$&#123;user.id&#125;"</span> /&gt;</span></span><br><span class="line">    姓名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"$!&#123;user.name&#125;"</span> /&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    年龄：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span> <span class="attr">value</span>=<span class="string">"$!&#123;user.age&#125;"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer,User&gt; users = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        initData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/list"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showList</span><span class="params">(ModelMap map)</span> </span>&#123;</span><br><span class="line">        map.put(<span class="string">"users"</span>,users);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/list"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/preEdit"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">preEdit</span><span class="params">(ModelMap map, Integer userId)</span> </span>&#123;</span><br><span class="line">        User user = users.get(userId);</span><br><span class="line">        map.put(<span class="string">"user"</span>,user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/edit"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/edit"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">edit</span><span class="params">(ModelMap map, User user)</span> </span>&#123;</span><br><span class="line">        users.put(user.getId(),user);</span><br><span class="line">        <span class="keyword">return</span> showList(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++) &#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setId(i);</span><br><span class="line">            user.setName(<span class="string">"测试用户"</span> + i);</span><br><span class="line">            user.setAge((<span class="keyword">int</span>) (Math.random()*<span class="number">100</span>+<span class="number">10</span>));</span><br><span class="line">            users.put(i, user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>User:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>演示：<br>列表页面<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-28/22517675.jpg" alt=""><br>修改一个用户名称<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-28/57154262.jpg" alt=""><br>再次回到列表页面<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-28/42027621.jpg" alt=""></p><p>本文示例代码：<a href="https://gitee.com/qincd/my-test-projects">https://gitee.com/qincd/my-test-projects</a>下的spring-velocity模块。</p><p>本文参考：<a href="https://blog.csdn.net/yyychyzzzz/article/details/56679732">springmvc集成 velocity,实现多视图整合(jsp,velocity)</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java关键字volatile解析</title>
      <link href="/2018/04/26/java%E5%85%B3%E9%94%AE%E5%AD%97volatile%E8%A7%A3%E6%9E%90/"/>
      <url>/2018/04/26/java%E5%85%B3%E9%94%AE%E5%AD%97volatile%E8%A7%A3%E6%9E%90/</url>
      
        <content type="html"><![CDATA[<p>volatile是一个轻量级的锁（synchronized），如果一个变量使用volatile，则它比使用synchronized的成本更低，因为它不会引起线上上下文的切换和调度。</p><p>一个变量如果用volatile修饰了，则Java可以确保所有线程看到这个变量的值是一致的，如果某个线程对volatile修饰的共享变量进行更新，那么其他线程可以立马看到这个更新，这就是所谓的线程可见性。</p><p>注意：volatile不保证操作的原子性，但synchronized则可以保证。</p><p>volatile相对于synchronized稍微轻量些，在某些场合它可以替代synchronized，但是又不能完全取代synchronized，只有在某些场合才能够使用volatile。使用它必须满足如下两个条件：<br>1.对变量的写操作不依赖当前值；<br>2.该变量没有包含在具有其他变量的不变式中。<br><a id="more"></a><br>volatile经常用于两个两个场景：状态量标记、double check</p><p>double check示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (singleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    singleton = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>当然单例模式延迟初始化还可使用其他的方式，比如枚举、静态内部类。可以参考这篇文章：<a href="https://blog.csdn.net/goodlixueyong/article/details/51935526">https://blog.csdn.net/goodlixueyong/article/details/51935526</a>。</p><blockquote><p>注意：使用volatile做双重检查只有在jdk1.5或之后的版本正常，之前的版本由于JMM（java内存模型）仍然是有问题的。</p></blockquote><p>参考：<a href="http://www.importnew.com/23520.html">死磕Java并发：深入分析volatile的实现原理</a>、<a href="https://www.cnblogs.com/a31415926/p/6744485.html">Java volatile关键字解惑</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决hexo代码多行空白的问题</title>
      <link href="/2018/04/25/hexo-resolve-multiline-blank/"/>
      <url>/2018/04/25/hexo-resolve-multiline-blank/</url>
      
        <content type="html"><![CDATA[<p>最近更换了hexo主题后，生成的文章代码最后面显示了多个空白行，而前面代码中原本的空白行则被移除了，看起来比较别扭。</p><p>解决办法：<br>1.找到hexo-util/lib/highlight.js文件<br>一般的路径为${blog_path}/node_modules/hexo-util/lib/highlight.js<br>2.修改highlight.js文件中的代码<br>大概在35~38行<br>修改前：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">numbers += <span class="string">'&lt;div class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/div&gt;'</span>;</span><br><span class="line">content += <span class="string">'&lt;div class="line'</span>;</span><br><span class="line">content += (mark.indexOf(firstLine + i) !== <span class="number">-1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span><br><span class="line">content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/div&gt;'</span>;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>修改后：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">numbers += <span class="string">'&lt;span class="line"&gt;'</span> + (firstLine + i) + <span class="string">'&lt;/span&gt;\n'</span>;</span><br><span class="line">content += <span class="string">'&lt;span class="line'</span>;</span><br><span class="line">content += (mark.indexOf(firstLine + i) !== <span class="number">-1</span>) ? <span class="string">' marked'</span> : <span class="string">''</span>;</span><br><span class="line">content += <span class="string">'"&gt;'</span> + line + <span class="string">'&lt;/span&gt;\n'</span>;</span><br></pre></td></tr></table></figure></p><p>参考文章：<a href="https://blog.csdn.net/u014717036/article/details/79372461">https://blog.csdn.net/u014717036/article/details/79372461</a></p><p>另外一个问题，就是生成的代码前面的部分空白，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/45684314.jpg" alt=""><br>解决办法：<br>这个跟具体使用的主题有关，比如BlueLake主题。<br>在highlight.styl文件中找到<code>padding: 0.3em 15px 0.3em 1em</code>，去掉即可。<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/93957518.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web安全通信之JWT简介</title>
      <link href="/2018/04/25/web-security-commnication-with-jwt/"/>
      <url>/2018/04/25/web-security-commnication-with-jwt/</url>
      
        <content type="html"><![CDATA[<h2 id="jwt简介"><a href="#jwt简介" class="headerlink" title="jwt简介"></a>jwt简介</h2><p>JWT是JSON Web Token的简称，它是一个非常轻巧的规范。这个规范允许我们使用JWT在用户和服务器之间传递安全可靠的信息。<br>和Cookie-Session的模式不同，JWT使用Token替换了SessionID的资源访问和状态保持。</p><h2 id="jwt的组成"><a href="#jwt的组成" class="headerlink" title="jwt的组成"></a>jwt的组成</h2><p>1.Header: 标题包含了令牌的元数据，并且在最小包含签名和/或加密算法的类型<br>2.Claims: Claims包含您想要签署的任何信息<br>3.JSON Web Signature (JWS): 在header中指定的使用该算法的数字签名和声明<br><a id="more"></a>  </p><h2 id="jwt的认证过程"><a href="#jwt的认证过程" class="headerlink" title="jwt的认证过程"></a>jwt的认证过程</h2><p>1.用户登录系统；<br>2.服务端验证，将认证信息通过指定的算法（例如HS256）进行加密，例如对用户名和用户所属角色进行加密，加密私钥是保存在服务器端的，将加密后的结果发送给客户端，加密的字符串格式为三个”.” 分隔的字符串 Token，分别对应头部、载荷与签名，头部和载荷都可以通过 base64 解码出来，签名部分不可以；<br>3.客户端拿到返回的 Token，存储到 local storage 或本地数据库；<br>4.下次客户端再次发起请求，将 Token 附加到 header 中；<br>5.服务端获取header中的Token，通过相同的算法对Token中的用户名和所属角色进行相同的加密验证，如果验证结果相同，则说明这个请求是正常的，没有被篡改。这个过程可以完全不涉及到查询 Redis 或其他存储；</p><h2 id="jjwt"><a href="#jjwt" class="headerlink" title="jjwt"></a>jjwt</h2><p>JJWT是一个提供端到端的JWT创建和验证的Java库。<br>JJWT的目标是最容易使用和理解用于在JVM上创建和验证JSON Web令牌(JWTs)的库。<br>JJWT是基于JWT、JWS、JWE、JWK和JWA RFC规范的Java实现。</p><h2 id="jjwt安装"><a href="#jjwt安装" class="headerlink" title="jjwt安装"></a>jjwt安装</h2><p>在pom.xml中配置jjwt的依赖即可：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>     </span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>     </span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>     </span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="创建签名秘钥"><a href="#创建签名秘钥" class="headerlink" title="创建签名秘钥"></a>创建签名秘钥</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Key key = MacProvider.generateKey(); </span><br><span class="line">String compactJws = Jwts.builder().setSubject(<span class="string">"Joe"</span>).signWith(SignatureAlgorithm.HS512, key).compact();</span><br></pre></td></tr></table></figure><h2 id="验证JWT"><a href="#验证JWT" class="headerlink" title="验证JWT"></a>验证JWT</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">assert</span> Jwts.parser().setSigningKey(key).parseClaimsJws(compactJws).getBody().getSubject().equals(<span class="string">"Joe"</span>);</span><br></pre></td></tr></table></figure><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>下面通过一个示例代码来说明如何使用。示例程序基于springboot。<br>本例代码在：<a href="https://gitee.com/qincd/my-test-projects">https://gitee.com/qincd/my-test-projects</a>下的jwt-demo模块。</p><p>jwt的操作工具类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenMgr</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title">generalKey</span><span class="params">()</span> <span class="keyword">throws</span> Base64DecodingException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] encodedKey = Base64.decode(Constant.JWT_SECERT);</span><br><span class="line">        SecretKey key = <span class="keyword">new</span> SecretKeySpec(encodedKey, <span class="number">0</span>, encodedKey.length, <span class="string">"AES"</span>);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 签发JWT</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> subject</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ttlMillis</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createJWT</span><span class="params">(String id, String subject, <span class="keyword">long</span> ttlMillis)</span> <span class="keyword">throws</span> Base64DecodingException </span>&#123;</span><br><span class="line">        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="keyword">long</span> nowMillis = System.currentTimeMillis();</span><br><span class="line">        Date now = <span class="keyword">new</span> Date(nowMillis);</span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line">        JwtBuilder builder = Jwts.builder()</span><br><span class="line">                .setId(id)</span><br><span class="line">                .setSubject(subject)</span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                .signWith(signatureAlgorithm, secretKey);</span><br><span class="line">        <span class="keyword">if</span> (ttlMillis &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> expMillis = nowMillis + ttlMillis;</span><br><span class="line">            Date expDate = <span class="keyword">new</span> Date(expMillis);</span><br><span class="line">            builder.setExpiration(expDate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证JWT</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtStr</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CheckResult <span class="title">validateJWT</span><span class="params">(String jwtStr)</span> </span>&#123;</span><br><span class="line">        CheckResult checkResult = <span class="keyword">new</span> CheckResult();</span><br><span class="line">        Claims claims = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            claims = parseJWT(jwtStr);</span><br><span class="line">            checkResult.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">            checkResult.setClaims(claims);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">            checkResult.setErrCode(Constant.JWT_ERRCODE_EXPIRE);</span><br><span class="line">            checkResult.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SignatureException e) &#123;</span><br><span class="line">            checkResult.setErrCode(Constant.JWT_ERRCODE_FAIL);</span><br><span class="line">            checkResult.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            checkResult.setErrCode(Constant.JWT_ERRCODE_FAIL);</span><br><span class="line">            checkResult.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> checkResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 解析JWT字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwt</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SecretKey secretKey = generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>jwt校验实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckResult</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> Claims claims;</span><br><span class="line">    <span class="keyword">private</span> String errCode;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuccess</span><span class="params">(<span class="keyword">boolean</span> success)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Claims <span class="title">getClaims</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> claims;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClaims</span><span class="params">(Claims claims)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.claims = claims;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrCode</span><span class="params">(String errCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errCode = errCode;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>常量类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JWT_SECERT = <span class="string">"security"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JWT_ERRCODE_EXPIRE = <span class="string">"expire"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JWT_ERRCODE_FAIL = <span class="string">"fail"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>JwtFilter：用于拦截/api/*请求<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtFilter</span> <span class="keyword">extends</span> <span class="title">GenericFilter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// jwt验证</span></span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="comment">// 1.从Cookie获取jwt</span></span><br><span class="line">        String token = getTokenFromCookie(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// 2.从headers中获取</span></span><br><span class="line">            token = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="comment">// 3.从请求参数获取</span></span><br><span class="line">            token = request.getParameter(<span class="string">"token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(<span class="string">"Missing or invalid token."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CheckResult checkResult = TokenMgr.validateJWT(token);</span><br><span class="line">        <span class="keyword">if</span> (checkResult.isSuccess()) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">"claims"</span>,checkResult.getClaims());</span><br><span class="line">            filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkResult.getErrCode().equals(Constant.JWT_ERRCODE_EXPIRE)) &#123;</span><br><span class="line">                servletResponse.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">                PrintWriter printWriter = servletResponse.getWriter();</span><br><span class="line">                printWriter.write(<span class="string">"token过期，请重新登录"</span>);</span><br><span class="line">                printWriter.flush();</span><br><span class="line">                printWriter.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (checkResult.getErrCode().equals(Constant.JWT_ERRCODE_FAIL)) &#123;</span><br><span class="line">                PrintWriter printWriter = servletResponse.getWriter();</span><br><span class="line">                servletResponse.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">                printWriter.write(<span class="string">"token验证失败！"</span>);</span><br><span class="line">                printWriter.flush();</span><br><span class="line">                printWriter.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTokenFromCookie</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String token = <span class="keyword">null</span>;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">int</span> len = <span class="keyword">null</span> == cookies ? <span class="number">0</span>:cookies.length;</span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;cookies.length;i++) &#123;</span><br><span class="line">                Cookie cookie = cookies[i];</span><br><span class="line">                <span class="keyword">if</span> (cookie.getName().equals(<span class="string">"token"</span>)) &#123;</span><br><span class="line">                    token = cookie.getValue();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>LoginController:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/login"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toLogin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/login"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/login"</span>,method = RequestMethod.POST)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,String&gt; <span class="title">login</span><span class="params">(String username,String password,HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,String&gt; result = <span class="keyword">new</span> HashMap&lt;String, String&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (username.equals(<span class="string">"admin"</span>) &amp;&amp; password.equals(<span class="string">"123456"</span>)) &#123;</span><br><span class="line">            String id= UUID.randomUUID().toString();</span><br><span class="line">            String subject = <span class="string">"&#123;role:1,permission:[1,2,3]&#125;"</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String token = TokenMgr.createJWT(id,subject,<span class="number">5</span>*<span class="number">60</span>*<span class="number">1000L</span>);</span><br><span class="line">                result.put(<span class="string">"token"</span>,token);</span><br><span class="line">                result.put(<span class="string">"code"</span>,<span class="string">"0"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Base64DecodingException e) &#123;</span><br><span class="line">                result.put(<span class="string">"code"</span>,<span class="string">"1"</span>);</span><br><span class="line">                result.put(<span class="string">"msg"</span>, <span class="string">"内部错误！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            result.put(<span class="string">"code"</span>,<span class="string">"1"</span>);</span><br><span class="line">            result.put(<span class="string">"msg"</span>,<span class="string">"用户名或密码错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ApiController:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/test"</span>,method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String,Object&gt; <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">4</span>);</span><br><span class="line">        map.put(<span class="string">"id"</span>,<span class="number">10000L</span>);</span><br><span class="line">        map.put(<span class="string">"name"</span>,<span class="string">"张三"</span>);</span><br><span class="line">        map.put(<span class="string">"age"</span>,<span class="number">99</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>SpringBoot应用启动类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(WebApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//过滤器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FilterRegistrationBean <span class="title">jwtFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> FilterRegistrationBean registrationBean = <span class="keyword">new</span> FilterRegistrationBean();</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> JwtFilter());</span><br><span class="line">        registrationBean.addUrlPatterns(<span class="string">"/api/*"</span>);</span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(WebApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>增加对jwtFilter的配置。</p><p>login.jsp:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"ctx"</span> value=<span class="string">"$&#123;pageContext.request.contextPath&#125;"</span>/&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;用户登录&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=<span class="string">"loginDiv"</span>&gt;</span><br><span class="line">    用户名：&lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span>&gt;&lt;br&gt;</span><br><span class="line">    密码：&lt;input type=<span class="string">"password"</span> name=<span class="string">"password"</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">"button"</span> value=<span class="string">"登录"</span> onclick=<span class="string">"login();"</span>&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script type="text/javascript" src="$&#123;ctx&#125;/js/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  <span class="function">function <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> t = &#123;</span><br><span class="line">      username:$(<span class="string">'input[name=username]'</span>).val(),</span><br><span class="line">      password:$(<span class="string">'input[name=password]'</span>).val()</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (t.username == <span class="string">''</span> || t.password== <span class="string">''</span>) &#123;</span><br><span class="line">      alert(<span class="string">'参数不全'</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $.post(<span class="string">'$&#123;ctx&#125;/login'</span>,t, function(r) &#123;</span><br><span class="line">      <span class="keyword">if</span> (r.code == <span class="number">0</span>) &#123;</span><br><span class="line">        location.replace(<span class="string">'$&#123;ctx&#125;/api/test?token='</span>+ r.token);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(r.msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>测试：<br>进入登录页面登录<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/40723692.jpg" alt=""><br>这里用户名和秘密为admin和123456</p><p>输入后，点登录按钮，会进入到/api/test页面。<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/92104964.jpg" alt=""><br>上面示例代码中token的有效期为5分钟，在5分钟内，可以在任何其他机器或浏览器输入登录后的地址，可以拿到返回结果。<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/76932439.jpg" alt=""></p><p>如果超过5分钟再访问则会提示token过期。<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-25/96939779.jpg" alt=""></p><p>示例工程参考：<a href="https://blog.csdn.net/wangcantian/article/details/74330458">Web安全通讯之JWT的Java实现</a>、<a href="https://blog.csdn.net/change_on/article/details/76279441">JWT 进阶 – JJWT</a>、<a href="https://blog.csdn.net/qq_37636695/article/details/79265711">JWT的Java使用 (JJWT)</a>、<a href="https://blog.csdn.net/loveyou128144/article/details/74025136">你的JWTs存储在哪里</a>、<a href="http://www.lisa33xiaoq.net/1092.html">JWT（JSON WEB TOKEN）框架 JJWT 教程</a>、<a href="https://github.com/jwtk/jjwt">jjwt的github地址</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java是值传递还是引用传递？</title>
      <link href="/2018/04/21/java-pass-by-value-or-reference/"/>
      <url>/2018/04/21/java-pass-by-value-or-reference/</url>
      
        <content type="html"><![CDATA[<p>在Java中一切皆对象，无论是int a;还是String a;，这两个变量a都是对象。<br>在传递的时候究竟是按什么方式传递的呢？其答案就是：即是按值传递也是按引用传递，但通常基本数据类型（如int,double等）我们认为其是“值传递”，而自定义数据类型（class）我们认为其是“引用传递”。</p><h2 id="简单类型"><a href="#简单类型" class="headerlink" title="简单类型"></a>简单类型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = a;</span><br><span class="line">    a = b;</span><br><span class="line">    b = c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="keyword">int</span> a=<span class="number">10</span>;</span><br><span class="line"><span class="keyword">int</span> b=<span class="number">20</span>;</span><br><span class="line">swap(a, b);</span><br><span class="line">System.out.println(a);</span><br><span class="line">System.out.println(b);</span><br></pre></td></tr></table></figure><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">20</span><br></pre></td></tr></table></figure></p><p>可以看到，swap()方法并没有改变传入的参数的值。即说明参数是简单类型时是按值传递的。<br><a id="more"></a></p><p>用Integer测试一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap2</span><span class="params">(Integer a,Integer b)</span> </span>&#123;</span><br><span class="line">    Integer c = a;</span><br><span class="line">    a = b;</span><br><span class="line">    b = c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">Integer a=<span class="number">10</span>;</span><br><span class="line">Integer b=<span class="number">20</span>;</span><br><span class="line">swap2(a, b);</span><br><span class="line">System.out.println(a);</span><br><span class="line">System.out.println(b);</span><br></pre></td></tr></table></figure></p><p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10</span><br><span class="line">20</span><br></pre></td></tr></table></figure></p><p>可以看到参数是简单类型或是它的包装类型，都不会改变参数的值。</p><p>包括String。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    str = <span class="string">"world"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">String string = <span class="string">"hello"</span>;</span><br><span class="line">change(string);</span><br><span class="line">System.out.println(string); <span class="comment">// hello</span></span><br></pre></td></tr></table></figure><p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello</span><br></pre></td></tr></table></figure></p><p>通过上面的例子可以知道，在java中，简单类型（包括String）可以认为是按值传递的。</p><h2 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    t.id = <span class="number">20</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//调用</span></span><br><span class="line">T t = <span class="keyword">new</span> T();</span><br><span class="line">t.id=<span class="number">10</span>;</span><br><span class="line">change(t);</span><br><span class="line">System.out.println(t.id); <span class="comment">// 20</span></span><br></pre></td></tr></table></figure><p>输出：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span></span><br></pre></td></tr></table></figure></p><p>可以看到t.id的值被改变了，说明是按引用传递的。</p><p>详细内容可以参考：<a href="https://www.cnblogs.com/SilentCode/p/4858790.html">深入理解Java引用类型</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java的4种引用类型——强引用、软引用、弱引用、虚引用</title>
      <link href="/2018/04/21/java-four-kind-of-reference/"/>
      <url>/2018/04/21/java-four-kind-of-reference/</url>
      
        <content type="html"><![CDATA[<p>在java中提供了4个级别的引用：强引用、软引用、弱引用、虚引用。只有强引用（FinalReference）类是包类可见，其他都是public，可以在应用程序中直接使用。</p><p>软引用适用于实现内存敏感的缓存，弱引用适用于实现无法防止其键（或值）被回收的规范化映射，而虚引用则适用于以某种比 Java 终结机制更灵活的方式调度 pre-mortem 清除操作。</p><p>参考：<a href="https://blog.csdn.net/rodbate/article/details/72857447">Java中的四种引用类型 Strong, Soft, Weak And Phantom</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用NIO提升性能</title>
      <link href="/2018/04/19/use-nio-to-improve-performance/"/>
      <url>/2018/04/19/use-nio-to-improve-performance/</url>
      
        <content type="html"><![CDATA[<h2 id="Buffer简介"><a href="#Buffer简介" class="headerlink" title="Buffer简介"></a>Buffer简介</h2><p>在JDK1.4之前，我们进行文件/流的读写都是通过java.io包的相关类来进行操作，虽然操作简便，但是性能较差。在JDK1.4引入了java.nio包，提供了相关的通道（Channel）和缓冲（Buffer）来操作，极大的提升了读写性能。</p><p>通道是双向的，既可用于读也可用于写数据。它从缓冲读取或写入数据到缓冲区。</p><p>基本每个java的基本类型都有一个对应的Buffer，比如byte的ByteBuffer；int的IntBuffer等等，但ByteBuffer是最常用的，是大多数标准I/O操作的接口。</p><p>Buffer有3个重要的参数：位置(position)、容量(capacity)、上限(limit)。</p><ul><li>位置(position)<br>a.在写模式下，标识当前缓冲区的位置，将从position的下个位置开始写数据；<br>b.在读模式下，标识当前缓冲区读取的位置，将从此位置之后读取数据。</li><li>容量(capacity)<br>缓冲区的容量上限</li><li>上限(limit)<br>a.在写模式下，标识缓冲区的实际上限，它小于或等于容量(capacity)。通常情况下和容量(capacity)相等。<br>b.在读模式下，代表可以读取的总容量，和上次写入的数据量相等。</li></ul><a id="more"></a><h2 id="Buffer的创建"><a href="#Buffer的创建" class="headerlink" title="Buffer的创建"></a>Buffer的创建</h2><p>Buffer的创建有2种方式：<br>1.从堆中创建<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br></pre></td></tr></table></figure></p><p>2.从已有的数组创建<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">ByteBuffer buffer = ByteBuffer.wrap(data);</span><br></pre></td></tr></table></figure></p><h2 id="重置和清空缓冲区"><a href="#重置和清空缓冲区" class="headerlink" title="重置和清空缓冲区"></a>重置和清空缓冲区</h2><ul><li><p>rewind()<br>position置为0，mark清除，limit无修改。<br>作用：为读取Buffer中有效数据做准备。</p></li><li><p>clear()<br>position置为0，mark清除，limit设置为capacity。<br>作用：为重新写入Buffer做准备。</p></li><li><p>flip()<br>position置为0，mark清除，limit设置为position。<br>作用：读写切换时使用</p></li></ul><h2 id="读写缓冲区"><a href="#读写缓冲区" class="headerlink" title="读写缓冲区"></a>读写缓冲区</h2><p>常用的操作有：</p><ul><li><p>public byte get()<br>返回当前position上的数据，并将position向下移动一位。</p></li><li><p>public ByteBuffer get(byte[] dst)<br>从缓冲区读取数据到dst数组，并恰当的移动position到合适的位置。</p></li><li><p>public byte get(int index)<br>读取指定Index上的数据，不会改变position的位置。</p></li><li><p>public ByteBuffer put(byte b)<br>在当前位置写入给定的数据，并将position向后移动一位。</p></li><li><p>public ByteBuffer put(int index,byte b)<br>将数据写入缓冲区的index位置。position没有改变。</p></li><li><p>public ByteBuffer put(byte[] src)<br>将给定的数组写入当前Buffer。并恰当的移动position到合适的位置。</p></li></ul><p>ByteBuffer提供了非常多的方法，这里只是列举了几个常用的方法。</p><h2 id="标志缓冲区"><a href="#标志缓冲区" class="headerlink" title="标志缓冲区"></a>标志缓冲区</h2><p>标志(mark)有点像书签，在需要标记的地方mark一下，后续任何时候都可以回到mark的地方。</p><p>Buffer提供了了下面2个方法：</p><ul><li><p>mark()<br>用于记录当前的位置。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">mark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mark = position;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>reset()<br>用于恢复到mark的位置，即将position设置为mark。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Buffer <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> m = mark;</span><br><span class="line">    <span class="keyword">if</span> (m &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidMarkException();</span><br><span class="line">    position = m;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">    buffer.put((<span class="keyword">byte</span>)i);</span><br><span class="line">&#125;</span><br><span class="line">buffer.flip(); <span class="comment">// 重置position,为读取数据做准备</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;buffer.limit();i++) &#123;</span><br><span class="line">    System.out.print(buffer.get());</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">4</span>) &#123; <span class="comment">// 在第5个字节的位置做标记</span></span><br><span class="line">        buffer.mark();</span><br><span class="line">        System.out.print(<span class="string">"(mark at "</span> + i + <span class="string">")"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">buffer.reset(); <span class="comment">// 回到标记的地方</span></span><br><span class="line">System.out.println();</span><br><span class="line">System.out.println(<span class="string">"reset to mark."</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=buffer.position();i&lt;buffer.limit();i++) &#123;</span><br><span class="line">    System.out.print(buffer.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01234</span>(mark at <span class="number">4</span>)<span class="number">56789</span></span><br><span class="line">reset to mark.</span><br><span class="line"><span class="number">56789</span></span><br></pre></td></tr></table></figure></p><p>上面的代码中，我们先向下缓冲区写入了10个数字（0到9）。然后循环从缓冲区读取并输出，并在第5个位置做了标记。最后重新回到标记的地方，获取缓冲区剩余的数据输出。</p><h2 id="复制缓冲区"><a href="#复制缓冲区" class="headerlink" title="复制缓冲区"></a>复制缓冲区</h2><p>复制缓冲区是以原缓冲区为基础，生成一个新的缓冲区。新生成的缓冲区与原缓冲区共享内存，对任意一方的数据改动都是相互可见的，但是2者又各自维护自己的position、limit、mark。这大大增加了程序的灵活性，为同时处理数据提供了可能。</p><p>复制缓冲区的方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">duplicate</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure></p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">    buffer.put((<span class="keyword">byte</span>)i);</span><br><span class="line">&#125;</span><br><span class="line">ByteBuffer buf = buffer.duplicate();</span><br><span class="line">System.out.println(<span class="string">"After buffer.duplicate"</span>);</span><br><span class="line">System.out.println(buffer);</span><br><span class="line">System.out.println(buf);</span><br><span class="line">buf.flip();</span><br><span class="line">System.out.println(<span class="string">"After buf.flip()"</span>);</span><br><span class="line">System.out.println(buffer);</span><br><span class="line">System.out.println(buf);</span><br><span class="line">buf.put((<span class="keyword">byte</span>)<span class="number">100</span>);</span><br><span class="line">System.out.println(<span class="string">"After buf.put((byte)100)"</span>);</span><br><span class="line">System.out.println(buffer);</span><br><span class="line">System.out.println(buf);</span><br><span class="line">System.out.println(<span class="string">"buffer.get(0)="</span> + buffer.get(<span class="number">0</span>));</span><br><span class="line">System.out.println(<span class="string">"buf.get(0)="</span> + buf.get(<span class="number">0</span>));</span><br></pre></td></tr></table></figure></p><p>输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">After buffer.duplicate</span><br><span class="line">java.nio.HeapByteBuffer[pos=10 lim=1024 cap=1024]</span><br><span class="line">java.nio.HeapByteBuffer[pos=10 lim=1024 cap=1024]</span><br><span class="line">After buf.flip()</span><br><span class="line">java.nio.HeapByteBuffer[pos=10 lim=1024 cap=1024]</span><br><span class="line">java.nio.HeapByteBuffer[pos=0 lim=10 cap=1024]</span><br><span class="line">After buf.put((byte)100)</span><br><span class="line">java.nio.HeapByteBuffer[pos=10 lim=1024 cap=1024]</span><br><span class="line">java.nio.HeapByteBuffer[pos=1 lim=10 cap=1024]</span><br><span class="line">buffer.get(0)=100</span><br><span class="line">buf.get(0)=100</span><br></pre></td></tr></table></figure></p><p>最开始创建了一个有1024个字节的缓冲区buffer，然后写入了10个数。随后通过duplicate()方法复制了一个缓冲区buf。<br>可以看到复制后的缓冲区的pos,limit,cap都与原缓冲区一致。<br>然后使用buf.flip()重置新的缓冲区buf<br>然后写入了一个数字100，这时2个缓冲区的position和limit都不一样。说明原缓冲区和复制的缓冲区维护了各自的position和limit。<br>最后打印原来的缓冲区和新的缓冲区的第1个位置的数据，都是100.说明原缓冲区和复制的缓冲区共享内存。</p><h2 id="缓冲区分片"><a href="#缓冲区分片" class="headerlink" title="缓冲区分片"></a>缓冲区分片</h2><p>利用缓冲区分片，可以将一个大的缓冲区分割成若干个子缓冲区，子缓冲区和父缓冲区共享数据。当需要处理一个缓冲区的一个分片时，使用slice()方法得到一个子缓冲区，然后可以像处理普通缓冲区的方法一样处理子缓冲区。<br>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">    buffer.put((<span class="keyword">byte</span>)i);</span><br><span class="line">&#125;</span><br><span class="line">buffer.position(<span class="number">2</span>);</span><br><span class="line">buffer.limit(<span class="number">6</span>);</span><br><span class="line"><span class="comment">// 得到一个从第3个位置开始到第6个位置结束的子缓冲区</span></span><br><span class="line">ByteBuffer newBuffer = buffer.slice();</span><br><span class="line"><span class="comment">// 输出子缓冲区的内容</span></span><br><span class="line"><span class="keyword">while</span> (newBuffer.hasRemaining()) &#123;</span><br><span class="line">    System.out.print(newBuffer.get());</span><br><span class="line">&#125;</span><br><span class="line">System.out.println();</span><br><span class="line"><span class="comment">// 修改子缓冲区</span></span><br><span class="line">newBuffer.flip();</span><br><span class="line">newBuffer.put((<span class="keyword">byte</span>)<span class="number">100</span>);</span><br><span class="line">System.out.println(newBuffer.get(<span class="number">0</span>));</span><br><span class="line"><span class="comment">// 这里为什么去第3个位置？因为子缓冲区的第1个位置=父缓冲区的第3个位置</span></span><br><span class="line">System.out.println(buffer.get(<span class="number">2</span>));</span><br></pre></td></tr></table></figure></p><p>输出结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2345</span><br><span class="line">100</span><br><span class="line">100</span><br></pre></td></tr></table></figure></p><p>从结果可以看到，newBuffer是buffer的一部分（子缓冲区），而且数据是共享的（最后获取的第3个位置的数字都是100）。</p><h2 id="只读缓冲区"><a href="#只读缓冲区" class="headerlink" title="只读缓冲区"></a>只读缓冲区</h2><p>可以通过<code>asReadOnlyBuffer()</code>方法得到一个只读缓冲区，该缓冲区与原缓冲区共享内存数据。将缓冲区作为参数传递给某个方法时，无法确认该方法会不会破坏缓冲区的数据，此时可以使用只读缓冲区保证缓冲区数据不会被修改。<br>同时，因为只读缓冲区和原缓冲区共享内存，因此原缓冲区的数据修改，对只读缓冲区也是可见的。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ByteBuffer buffer = ByteBuffer.allocate(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">    buffer.put((<span class="keyword">byte</span>)i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 得到一个只读缓冲区</span></span><br><span class="line">ByteBuffer bb = buffer.asReadOnlyBuffer();</span><br><span class="line"><span class="comment">// 重置position，准备读取数据</span></span><br><span class="line">bb.flip();</span><br><span class="line"><span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">    System.out.print(bb.get()+<span class="string">","</span>);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println();</span><br><span class="line"><span class="comment">// 重置原缓冲区的position，准备开始写入数据</span></span><br><span class="line">buffer.flip();</span><br><span class="line"><span class="comment">// 在原缓冲区写入一个数字100</span></span><br><span class="line">buffer.put((<span class="keyword">byte</span>)<span class="number">100</span>);</span><br><span class="line"><span class="comment">// 由于上面读取只读缓冲区的数据时，position移动了，所以这里重置position，准备从头开始读取数据</span></span><br><span class="line">bb.flip();</span><br><span class="line"><span class="keyword">while</span> (bb.hasRemaining()) &#123;</span><br><span class="line">    System.out.print(bb.get()+<span class="string">","</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出结果如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0,1,2,3,4,5,6,7,8,9,</span><br><span class="line">100,1,2,3,4,5,6,7,8,9,</span><br></pre></td></tr></table></figure></p><p>在原缓冲区写入了一个数字100，然后在只读缓冲区也是可以拿到的，说明原缓冲区与只读缓冲区是共享内存数据的。</p><h2 id="文件映射到内存"><a href="#文件映射到内存" class="headerlink" title="文件映射到内存"></a>文件映射到内存</h2><p>NIO提供了一个将文件映射到内存的方法进行I/O操作，它比常规的基于流的I/O操作快很多。这个操作由FileChannel.map()方法实现。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">RandomAccessFile raf = <span class="keyword">new</span> RandomAccessFile(<span class="string">"d:/urls.txt"</span>,<span class="string">"rw"</span>);</span><br><span class="line"><span class="comment">// 得到FileChannel</span></span><br><span class="line">FileChannel channel = raf.getChannel();</span><br><span class="line"><span class="comment">// 得到MappedByteBuffer，映射文件的第1到第1024个位置的内容到Buffer</span></span><br><span class="line">MappedByteBuffer mbb = channel.map(FileChannel.MapMode.READ_WRITE, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line"><span class="comment">// 循环输出缓冲的数据</span></span><br><span class="line"><span class="keyword">while</span>(mbb.hasRemaining()) &#123;</span><br><span class="line">    System.out.print((<span class="keyword">char</span>)mbb.get()); <span class="comment">// 这里文本的内容长度小于1024，mbb.get()到文件末尾后是空</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 重置position，在文件开始位置写入hello,world</span></span><br><span class="line">mbb.flip();</span><br><span class="line">mbb.put(<span class="string">"hello,world"</span>.getBytes());</span><br><span class="line">raf.close();</span><br></pre></td></tr></table></figure></p><p>MappedByteBuffer是ByteBuffer的子类，所以可以像操作ByteBuffer操作它。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java数据结构之Set</title>
      <link href="/2018/04/18/java-datastructure-Set/"/>
      <url>/2018/04/18/java-datastructure-Set/</url>
      
        <content type="html"><![CDATA[<p>先来一张UML图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-18/17536760.jpg" alt=""></p><p>如上，Set最重要的是HashSet、LinkedHashSet、TreeSet和CopyOnWriteArraySet几个实现类。Set中的元素是不能重复的。关于Set的实现细节可以参考Map，因为这些Set的实现都是对应的Map的一种封装。比如HashSet是对HashMap的封装，LinkedHashSet对应LinkedHashMap，TreeSet对应TreeMap。</p><p>以HashSet为例，其内部维护了一个HashMap对象。在初始化HashSet时new了一个HashMap对象，后面的Set相关的操作方法都委托HashMap来完成。</p><p>比如，add方法和remove方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> map.remove(o)==PRESENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>相关的Set及其特性：</p><ul><li>HashSet<br>对应的Map是HashMap，是基于Hash的快速元素插入，元素无顺序。</li><li>LinkedHashSet<br>对应的Map是LinkedHashMap，是基于Hash的快速元素插入，同时维护了元素插入时集合的顺序。遍历集合时，按照先进先出的顺序排序。</li><li>TreeSet<br>基于红黑树的实现，有着高效的基于元素Key的排序算法。</li></ul><p>参考：《java程序性能优化——让你java程序更快、更稳定》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java数据结构之Map</title>
      <link href="/2018/04/17/java-datastructure-Map/"/>
      <url>/2018/04/17/java-datastructure-Map/</url>
      
        <content type="html"><![CDATA[<p>Java中的List和Map是使用频率非常高的数据结构。这里介绍下常用的Map实现。<br>先来看下类图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-17/76935559.jpg" alt=""></p><h2 id="HashMap的实现原理"><a href="#HashMap的实现原理" class="headerlink" title="HashMap的实现原理"></a>HashMap的实现原理</h2><p>HashMap的实现原理参考：<a href="http://tommy88.top/2018/03/20/HashMap%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">HashMap的实现原理</a></p><h2 id="HashMap与HashTable的异同"><a href="#HashMap与HashTable的异同" class="headerlink" title="HashMap与HashTable的异同"></a>HashMap与HashTable的异同</h2><p>HashTable与HashMap的存储机制基本相同，都是采用数组+链表。<br>不同点：<br>1.HashMap是非线程安全的，HashTable是线程安全的。它的大多数方法都加了synchronized。<br>2.HashMap允许key和value的值为null，HashTable不允许null值的存在。在HashTable的put方法中，如果V为null，直接抛出NullPointerException。<br>3.因为HashTable加了同步处理，所以HashMap效率高于HashTable。</p><h2 id="HashTable与ConcurrentHashMap有何不同？"><a href="#HashTable与ConcurrentHashMap有何不同？" class="headerlink" title="HashTable与ConcurrentHashMap有何不同？"></a>HashTable与ConcurrentHashMap有何不同？</h2><p>HashTable与ConcurrentHashMap都是线程安全的Map，有何不同？<br>HashTable使用的synchronized对方法加锁，实际锁住的是整个对象；而ConcurrentHashMap使用的是lock，这样在操作的时候锁住的不是这个对象。<br>而且ConcurrentHashMap采用了分段锁的设计，只有在同一个分段内才存在竞态关系，不同的分段锁之间没有锁竞争。相比于对整个Map加锁的设计，分段锁大大的提高了高并发环境下的处理能力。</p><p>ConcurrentHashMap使用多个子Hash表，即Segment。每个Segment是一个子Hash表。</p><p>ConcurrentHashMap要避免调用size()和containsValue()方法，会对整个Map进行扫描。</p><p>参考：<a href="http://www.importnew.com/22007.html">ConcurrentHashMap总结</a>、<a href="http://www.importnew.com/21786.html">Java集合—ConcurrentHashMap原理分析</a></p><h2 id="LinkedHashMap——有序的HashMap"><a href="#LinkedHashMap——有序的HashMap" class="headerlink" title="LinkedHashMap——有序的HashMap"></a>LinkedHashMap——有序的HashMap</h2><p>LinkedHashMap继承自HashMap，在HashMap的基础上增加了一个链表，用以存放元素的顺序。</p><p>LinkedHashMap提供2种类型的顺序：一是元素插入时的顺序；二是最近访问的顺序。<br>可以通过下面的构造函数指定排序行为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">float</span> loadFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">boolean</span> accessOrder)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>accessOrder为true时表示按照元素访问时间排序；为false时表示按照元素插入的顺序排序。默认是false。<br>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">16</span>,<span class="number">0.75f</span>,<span class="keyword">false</span>);</span><br><span class="line">map.put(<span class="string">"hello"</span>,<span class="string">"hello"</span>);</span><br><span class="line">map.put(<span class="string">"world"</span>,<span class="string">"world"</span>);</span><br><span class="line">map.put(<span class="string">"!"</span>,<span class="string">"!"</span>);</span><br><span class="line"><span class="keyword">for</span> (Iterator&lt;String&gt; iterator = map.keySet().iterator();iterator.hasNext();) &#123;</span><br><span class="line">    String key = iterator.next();</span><br><span class="line">    System.out.println(key + <span class="string">"-&gt;"</span> + map.get(key));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello-&gt;hello</span><br><span class="line">world-&gt;world</span><br><span class="line">!-&gt;!</span><br></pre></td></tr></table></figure></p><p>按照元素插入的顺序输出。<br>如果把上面的构造函数的最后一个参数accessOrder改为true，则在迭代器遍历时会报错。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,String&gt; map = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(<span class="number">16</span>,<span class="number">0.75f</span>,<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure></p><p>错误信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.util.ConcurrentModificationException</span><br><span class="line">at java.util.LinkedHashMap$LinkedHashIterator.nextEntry(LinkedHashMap.java:390)</span><br><span class="line">at java.util.LinkedHashMap$KeyIterator.next(LinkedHashMap.java:401)</span><br><span class="line">at com.tommy.core.test.Test.main(Test.java:54)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:601)</span><br><span class="line">at com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)</span><br></pre></td></tr></table></figure></p><p>ConcurrentModificationException异常一般是在对集合迭代的过程中被修改时抛出。不仅仅是LinkedHashMap，所有的集合都不允许在迭代器中修改集合的结构。</p><p>因为我们将accessOrder改为true，表示按照最后访问的时间排序。在迭代器中遍历时会将访问的元素移动链表到尾部，发生了修改操作。</p><p>我们看下LinkedHashMap的get方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;)getEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">return</span> e.value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recordAccess</span><span class="params">(HashMap&lt;K,V&gt; m)</span> </span>&#123;</span><br><span class="line">    LinkedHashMap&lt;K,V&gt; lm = (LinkedHashMap&lt;K,V&gt;)m;</span><br><span class="line">    <span class="keyword">if</span> (lm.accessOrder) &#123;</span><br><span class="line">        lm.modCount++;</span><br><span class="line">        remove();</span><br><span class="line">        addBefore(lm.header);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，在get方法中调用了e.recordAccess()方法，recordAccess方法中如果accessOrder=true会有修改操作。所以在迭代器中循环get时出错了。</p><p>但是，如果把遍历的代码改一下，运行就正常了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String,String&gt;&gt; iterator = map.entrySet().iterator();iterator.hasNext();) &#123;</span><br><span class="line">    Map.Entry&lt;String,String&gt; entry = iterator.next();</span><br><span class="line">    System.out.println(entry.getKey() + <span class="string">"-&gt;"</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>没报错是因为没有对数据结构修改，因为直接调用的getKey和getValue方法。</p><h2 id="TreeMap——另一种排序的Map"><a href="#TreeMap——另一种排序的Map" class="headerlink" title="TreeMap——另一种排序的Map"></a>TreeMap——另一种排序的Map</h2><p>TreeMap实现了SortedMap接口，这意味着它可以对元素进行排序。</p><p>但TreeMap与LinkedHashMap的排序不同，它是通过指定的Comparator或Comparable确定。</p><p>为了确定Key的排序算法，可以通过2种方式制定：<br>1.在TreeMap的构造函数中注入一个Comparator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TreeMap</span><span class="params">(Comparator&lt;? <span class="keyword">super</span> K&gt; comparator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.使用实现了Comparable接口的Key。</p><p>如果不指定Comparable或Compartor，则在put时会报ClassCastException。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.ClassCastException: com.tommy.core.test.Test$Student cannot be cast to java.lang.Comparable</span><br><span class="line">at java.util.TreeMap.compare(TreeMap.java:1188)</span><br><span class="line">at java.util.TreeMap.put(TreeMap.java:531)</span><br><span class="line">at com.tommy.core.test.Test.main(Test.java:62)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</span><br><span class="line">at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</span><br><span class="line">at java.lang.reflect.Method.invoke(Method.java:601)</span><br><span class="line">at com.intellij.rt.execution.application.AppMain.main(AppMain.java:140)</span><br></pre></td></tr></table></figure></p><p>因为构造函数没有传入Comparator，TreeMap认为你的Key（即这里的Student）应该实现了Comparable接口，所以会做一个转换，就出错了。</p><p>示例代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Student</span>&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Student o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || <span class="keyword">this</span>.id &gt; o.id</span><br><span class="line">                ) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.id == o.id) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TreeMap&lt;Student,Student&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">Student s1 = <span class="keyword">new</span> Student(<span class="number">1003</span>,<span class="string">"张三"</span>);</span><br><span class="line">Student s2 = <span class="keyword">new</span> Student(<span class="number">1002</span>,<span class="string">"李四"</span>);</span><br><span class="line">Student s3 = <span class="keyword">new</span> Student(<span class="number">1001</span>,<span class="string">"王五"</span>);</span><br><span class="line">map.put(s1,s1);</span><br><span class="line">map.put(s2,s2);</span><br><span class="line">map.put(s3,s3);</span><br><span class="line"><span class="keyword">for</span>(Iterator&lt;Student&gt; iterator = map.keySet().iterator();iterator.hasNext();) &#123;</span><br><span class="line">    Student student = iterator.next();</span><br><span class="line">    System.out.println(student.id+<span class="string">":"</span>+student.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>或者TreeMap的初始化指定Comparator：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">TreeMap&lt;Student, Student&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;(<span class="keyword">new</span> Comparator() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Object o1, Object o2)</span> </span>&#123;</span><br><span class="line">        Student s1 = (Student) o1;</span><br><span class="line">        Student s2 = (Student) o2;</span><br><span class="line">        <span class="keyword">boolean</span> f1 = s1 == <span class="keyword">null</span> &amp;&amp; s2 == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> (f1 || s1.id == s2.id) ? <span class="number">0</span> : (s1.id &gt; s2.id ? <span class="number">1</span> : -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1001:王五</span><br><span class="line">1002:李四</span><br><span class="line">1003:张三</span><br></pre></td></tr></table></figure></p><p>此外，TreeMap还提供了一系列有用的方法，用于获取大于，小于，以及2个Key直接的子Map的功能。</p><blockquote><p>如果需要使用Map，并且需要实现排序的功能，建议使用TreeMap。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java数据结构之List</title>
      <link href="/2018/04/13/java-datastructure-List/"/>
      <url>/2018/04/13/java-datastructure-List/</url>
      
        <content type="html"><![CDATA[<p>List是java中重要的数据结构之一，这里介绍常用的3种实现方式：ArrayList、Vector、LinkedList。<br>类图如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-13/30562141.jpg" alt=""></p><p>可以看到，ArrayList、Vector、LinkedList都是AbstractList的实现。而AbstractList实现了List接口，并扩展自AbstractCollection。</p><p>其中，ArrayList和Vector底层使用了数组，LinkedList使用的是循环双向链表。这是2种完全不同的实现，所有这也决定了它们的适应的工作场景不同。</p><p>ArrayList和Vector的区别是对多线程的支持，ArrayList没有对任何一个方法做同步，因此不是线程安全的。而Vector中绝大多数方法都做了线程同步。所以在多线程环境中，建议使用Vector，反之则使用ArrayList。<br><a id="more"></a></p><p>ArrayList和Vector实现除了同步几乎一样，所以下面以ArrayList进行说明。</p><h2 id="添加元素"><a href="#添加元素" class="headerlink" title="添加元素"></a>添加元素</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 确保内部数组有足够的空间</span></span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    <span class="comment">// 将元素添加到数组的末尾</span></span><br><span class="line">    elementData[size++] = e;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = elementData.length;</span><br><span class="line">    <span class="comment">// 新的数组容量是原来数组的1.5倍</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 如果新的容量小于需要的最小容量，则使用最小需要的容量</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    <span class="comment">// minCapacity is usually close to size, so this is a win:</span></span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在添加元素前，ArrayList先确保数组空间够用，否则会对数组进行扩容。新数组的长度是原数组的1.5倍。</p><p>通过代码可以知道，如果ArrayList内部数组的空间足够大，那么添加元素是很快的。在数组的容量不够时，会进行扩容，在扩容的过程中，会进行大量的数组的复制操作。</p><h3 id="LinkedList的add操作"><a href="#LinkedList的add操作" class="headerlink" title="LinkedList的add操作"></a>LinkedList的add操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    linkLast(e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkLast</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; l = last;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(l, e, <span class="keyword">null</span>);</span><br><span class="line">    last = newNode;</span><br><span class="line">    <span class="keyword">if</span> (l == <span class="keyword">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        l.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将新的元素放到最后。并设置添加前的最后一个元素的下一个元素是要添加的元素。<br>可以看到，LinkedList不用担心容量的问题，添加的效率也是很高的，只是每次添加时会生成一个新的Node对象，会有一定的性能损耗。在ArrayList容量足够的情况下，ArrayList的速度是非常快的，是直接操作的数组。</p><h3 id="添加操作性能测试"><a href="#添加操作性能测试" class="headerlink" title="添加操作性能测试"></a>添加操作性能测试</h3><p>1.ArrayList的添加操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5000000</span>;i++) &#123;</span><br><span class="line">    list.add(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis() - s);</span><br></pre></td></tr></table></figure></p><p>耗时：161ms.</p><p>2.LinkedList的添加操作<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5000000</span>;i++) &#123;</span><br><span class="line">    linkedList.add(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis() - s);</span><br></pre></td></tr></table></figure></p><p>耗时：3476ms.</p><blockquote><p>如果列表容量足够（不用扩容），添加元素到尾部，推荐使用ArrayList，效率高于LinkedList。</p></blockquote><h3 id="添加元素到任意位置"><a href="#添加元素到任意位置" class="headerlink" title="添加元素到任意位置"></a>添加元素到任意位置</h3><p>1.ArrayList<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    rangeCheckForAdd(index);</span><br><span class="line">    ensureCapacityInternal(size + <span class="number">1</span>);  <span class="comment">// Increments modCount!!</span></span><br><span class="line">    System.arraycopy(elementData, index, elementData, index + <span class="number">1</span>,</span><br><span class="line">                     size - index);</span><br><span class="line">    elementData[index] = element;</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，ArrayList添加元素到指定位置时，会导致index之后的所有元素向后移动，如果数据量大而index比较小的话，产生的数组拷贝是非常多的。这样必然导致效率降低。所以，尽量将元素插入到列表的尾部，可以提高该方法的性能。</p><p>2.LinkedList<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> index, E element)</span> </span>&#123;</span><br><span class="line">    checkPositionIndex(index);</span><br><span class="line">    <span class="keyword">if</span> (index == size)</span><br><span class="line">        linkLast(element);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        linkBefore(element, node(index));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">linkBefore</span><span class="params">(E e, Node&lt;E&gt; succ)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert succ != null;</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; pred = succ.prev;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;&gt;(pred, e, succ);</span><br><span class="line">    succ.prev = newNode;</span><br><span class="line">    <span class="keyword">if</span> (pred == <span class="keyword">null</span>)</span><br><span class="line">        first = newNode;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        pred.next = newNode;</span><br><span class="line">    size++;</span><br><span class="line">    modCount++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Node&lt;E&gt; <span class="title">node</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert isElementIndex(index);</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; (size &gt;&gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        Node&lt;E&gt; x = first;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; index; i++)</span><br><span class="line">            x = x.next;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;E&gt; x = last;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size - <span class="number">1</span>; i &gt; index; i--)</span><br><span class="line">            x = x.prev;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果index=size，就跟add(E e)是一样的，添加在最后；否则调用linkBefore方法。<br>在linkBefore方法中，注意第2个参数node(index)，该方法中，如果index在LinkedList的前半部分就在前半部分查找；否则在后半部分查找。所以，可以看到，如果index在靠近中间的位置，效率比较低。</p><h3 id="添加元素到任意位置测试"><a href="#添加元素到任意位置测试" class="headerlink" title="添加元素到任意位置测试"></a>添加元素到任意位置测试</h3><p>1.ArrayList<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50000</span>;i++) &#123;</span><br><span class="line">    list.add(<span class="number">0</span>,i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis() - s);</span><br></pre></td></tr></table></figure></p><p>耗时：236ms。</p><p>2.LinkedList<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">50000</span>;i++) &#123;</span><br><span class="line">    linkedList.add(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(System.currentTimeMillis() - s);</span><br></pre></td></tr></table></figure></p><p>耗时：5ms。</p><blockquote><p>除了一些极端的情况（首尾），添加元素到列表任意位置，LinkedList效率高于ArrayList。所以如果有在任意位置插入元素的需求，可以考虑LinkedList。</p></blockquote><h2 id="删除任意位置的元素"><a href="#删除任意位置的元素" class="headerlink" title="删除任意位置的元素"></a>删除任意位置的元素</h2><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    rangeCheck(index);</span><br><span class="line">    modCount++;</span><br><span class="line">    E oldValue = elementData(index);</span><br><span class="line">    <span class="keyword">int</span> numMoved = size - index - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (numMoved &gt; <span class="number">0</span>)</span><br><span class="line">        System.arraycopy(elementData, index+<span class="number">1</span>, elementData, index,</span><br><span class="line">                         numMoved);</span><br><span class="line">    elementData[--size] = <span class="keyword">null</span>; <span class="comment">// Let gc do its work</span></span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，跟add(index,E e)方法比较类似，在任意位置删除元素后，都需要进行数组的重组。而且，要删除的元素越靠前，开销越小；要删除的元素越靠后，开销越大。</p><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">remove</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    checkElementIndex(index);</span><br><span class="line">    <span class="keyword">return</span> unlink(node(index));</span><br><span class="line">&#125;</span><br><span class="line"> <span class="function">E <span class="title">unlink</span><span class="params">(Node&lt;E&gt; x)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// assert x != null;</span></span><br><span class="line">    <span class="keyword">final</span> E element = x.item;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; next = x.next;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; prev = x.prev;</span><br><span class="line">    <span class="keyword">if</span> (prev == <span class="keyword">null</span>) &#123;</span><br><span class="line">        first = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prev.next = next;</span><br><span class="line">        x.prev = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        last = prev;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next.prev = prev;</span><br><span class="line">        x.next = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    x.item = <span class="keyword">null</span>;</span><br><span class="line">    size--;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意remove方法中，最后调用了unlink方法，该方法中也查找了index位置的元素。代码同add(index,E)。<br>如果元素在前半段，则在链表的前半段循环查找；否则在链表的后半段循环查找。所以如果要删除的元素在前半段或后半段还好，如果在中间位置效率就比较低了（需要循环一半的链表）。</p><h2 id="容量参数"><a href="#容量参数" class="headerlink" title="容量参数"></a>容量参数</h2><p>在前面添加元素的地方说了，ArrayList和Vector在容量不够的情况下会进行扩容，新的容量是原来的1.5倍，扩容后会对之前的数据重组，所以性能损耗是比较大的。<br>在ArrayList和Vector的构造器中，有一个初始容量参数可指定列表的容量，如果在构造列表时预估数据量，将会避免进行列表扩容，从而可以提升效率。</p><h2 id="列表遍历"><a href="#列表遍历" class="headerlink" title="列表遍历"></a>列表遍历</h2><p>分别使用ArrayList和LinkedList进行for循环、forEach循环、迭代器进行100万条数据的遍历测试。<br>测试代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000000</span>;i++) &#123;</span><br><span class="line">    list.add(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;list.size();i++) &#123;</span><br><span class="line">    list.get(i);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"for循环耗时："</span> + (System.currentTimeMillis() - s) + <span class="string">"ms."</span>);</span><br><span class="line">s = System.currentTimeMillis();</span><br><span class="line">Integer tmp = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span> (Integer i:list) &#123;</span><br><span class="line">    tmp = i;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"forEach耗时："</span>+(System.currentTimeMillis() - s) + <span class="string">"ms."</span>);</span><br><span class="line">s = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (Iterator&lt;Integer&gt; iterator = list.iterator();iterator.hasNext();) &#123;</span><br><span class="line">    tmp = iterator.next();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"迭代器耗时："</span> + (System.currentTimeMillis() - s) + <span class="string">"ms."</span>);</span><br></pre></td></tr></table></figure></p><p>ArrayList测试结果：<br>for循环耗时：4ms.<br>forEach耗时：17ms.<br>迭代器耗时：10ms.</p><p>LinkedList测试结果：<br>forEach耗时：11ms.<br>迭代器耗时：15ms.<br>for循环耗时：无穷大，没法等到执行结束。</p><p>注意：上面代码在测试时将for循环放到最后，否则测试LinkedList时，看不到forEach和迭代器的执行结果。</p><blockquote><p>可以看到，对于ArrayList来说，for循环的效率是最高的，forEach反而最低。LinkedList使用for循环完全没法忍受，原因可以看之前的LinkedList查找元素的部分，每次循环都会遍历一次列表。<br>编译后的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> var8 = System.currentTimeMillis();</span><br><span class="line">Integer tmp = <span class="keyword">null</span>;</span><br><span class="line">Iterator i;</span><br><span class="line">Integer i1;</span><br><span class="line"><span class="keyword">for</span>(i = list.iterator(); i.hasNext(); i1 = (Integer)i.next()) &#123;</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"forEach耗时："</span> + (System.currentTimeMillis() - var8) + <span class="string">"ms."</span>);</span><br><span class="line">var8 = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span>(i = list.iterator(); i.hasNext(); tmp = (Integer)i.next()) &#123;</span><br><span class="line">    ;</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"迭代器耗时："</span> + (System.currentTimeMillis() - var8) + <span class="string">"ms."</span>);</span><br><span class="line">var8 = System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> var9 = <span class="number">0</span>; var9 &lt; list.size(); ++var9) &#123;</span><br><span class="line">    list.get(var9);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">"for循环耗时："</span> + (System.currentTimeMillis() - var8) + <span class="string">"ms."</span>);</span><br></pre></td></tr></table></figure></p></blockquote><p>forEach在编译时被优化为使用迭代器，但是多了一个赋值操作，所以比使用迭代器慢一点。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>要根据应用场景选择合适的List，否则会导致性能问题。同时也要注意ArrayList和Vector的容量，使用前如果能评估大小，最好初始化List时就指定，这样可以避免数组扩容，导致大量的数据拷贝，导致性能下降。</p><p>参考：《java程序性能优化——让你的java程序更快、更稳定》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分享一个对象复制的工具类</title>
      <link href="/2018/04/13/share-one-object-copy-utility/"/>
      <url>/2018/04/13/share-one-object-copy-utility/</url>
      
        <content type="html"><![CDATA[<ul><li>使用cglib的BeanCopier复制对象的工具类。</li><li>性能比spring的BeanUtils，Apache common的BeanUtils快很多倍。</li><li>注意：</li><li>1）BeanCopier只拷贝名称和类型都相同的属性</li><li>2）当目标类的setter数目比getter少时，创建BeanCopier会失败而导致拷贝不成功</li><li>3）引用类型不会拷贝，直接引用，所以操作源对象的引用类型属性会导致copy的对象的引用类型属性一起变化。<a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanCopyUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用WeakHashMap缓存,在内存不足时会自动释放</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String,BeanCopier&gt; BEAN_COPIER_MAP = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String,Converter&gt; CONVERTER_MAP = <span class="keyword">new</span> WeakHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object lock1 = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object lock2 = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">BeanCopyUtils</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建BeanCopier，并缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> useConverter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BeanCopier <span class="title">getBeanCopier</span><span class="params">(Object src,Object target,<span class="keyword">boolean</span> useConverter)</span> </span>&#123;</span><br><span class="line">        String key = generateKey(src,target,useConverter);</span><br><span class="line">        BeanCopier bc = BEAN_COPIER_MAP.get(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == bc) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock1) &#123;</span><br><span class="line">                bc = BEAN_COPIER_MAP.get(key);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == bc) &#123;</span><br><span class="line">                    bc = BeanCopier.create(src.getClass(),target.getClass(),useConverter);</span><br><span class="line">                    BEAN_COPIER_MAP.put(key,bc);</span><br><span class="line">                    System.out.println(<span class="string">"Create BeanCopier with key:"</span> + key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 复制对象属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Object src,Object target)</span> </span>&#123;</span><br><span class="line">        BeanCopier bc = getBeanCopier(src, target, <span class="keyword">false</span>);</span><br><span class="line">        bc.copy(src,target,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用自定义的属性转换器复制对象属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> converter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(Object src,Object target,Converter converter)</span> </span>&#123;</span><br><span class="line">        BeanCopier bc = getBeanCopier(src,target,<span class="keyword">true</span>);</span><br><span class="line">        bc.copy(src,target,converter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象属性复制，只复制fields中指定的属性，每个属性用逗号分隔</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyWithFields</span><span class="params">(Object src,Object target,<span class="keyword">final</span> String fields)</span> </span>&#123;</span><br><span class="line">        BeanCopier bc = getBeanCopier(src,target,<span class="keyword">true</span>);</span><br><span class="line">        bc.copy(src, target, newConverter(src,target,fields,<span class="keyword">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对象属性复制，排除指定属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> src</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fields</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyWithoutFields</span><span class="params">(Object src,Object target,<span class="keyword">final</span> String fields)</span> </span>&#123;</span><br><span class="line">        BeanCopier bc = getBeanCopier(src,target,<span class="keyword">true</span>);</span><br><span class="line">        bc.copy(src, target, newConverter(src,target,fields,<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * new属性转换器，</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fields 需要复制或排除的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fieldCopyFlag 属性复制标识 true:表明fields为需要复制的属性；false:表明fields是需要排除复制的属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Converter <span class="title">newConverter</span><span class="params">(Object src,Object target,<span class="keyword">final</span> String fields,<span class="keyword">final</span> <span class="keyword">boolean</span> fieldCopyFlag)</span> </span>&#123;</span><br><span class="line">        String key = buildConverterkey(src,target,fields,fieldCopyFlag);</span><br><span class="line">        Converter converter = CONVERTER_MAP.get(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == converter) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock2) &#123;</span><br><span class="line">                converter = CONVERTER_MAP.get(key);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == converter) &#123;</span><br><span class="line">                    converter = <span class="keyword">new</span> Converter() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> Object <span class="title">convert</span><span class="params">(Object fieldValue, Class fieldType, Object methodName)</span> </span>&#123;</span><br><span class="line">                            String field = methodName.toString().substring(<span class="number">3</span>); <span class="comment">// 得到属性名，如Name</span></span><br><span class="line">                            field = field.substring(<span class="number">0</span>,<span class="number">1</span>).toLowerCase() + field.substring(<span class="number">1</span>); <span class="comment">// 将首字母小写</span></span><br><span class="line">                            <span class="keyword">if</span> ((fieldCopyFlag &amp;&amp; fields.contains(field)) || (!fieldCopyFlag &amp;&amp; !fields.contains(field))) &#123;</span><br><span class="line">                                <span class="keyword">return</span> fieldValue;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    CONVERTER_MAP.put(key,converter);</span><br><span class="line">                    System.out.println(<span class="string">"Created Converter with key:"</span> + key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">generateKey</span><span class="params">(Object src,Object target,<span class="keyword">boolean</span> useConverter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> src.getClass().getName() + target.getClass().getName() + String.valueOf(useConverter);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">buildConverterkey</span><span class="params">(Object src,Object target,String fields,<span class="keyword">boolean</span> copyFlag)</span> </span>&#123;</span><br><span class="line">        String baseKey = generateKey(src,target,<span class="keyword">true</span>);</span><br><span class="line">        String key = baseKey + fields + String.valueOf(copyFlag);</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java字符串连接</title>
      <link href="/2018/04/12/java-string-join/"/>
      <url>/2018/04/12/java-string-join/</url>
      
        <content type="html"><![CDATA[<p>由于String是不可变对象（final），所以，对字符串进行连接、替换操作时，String对象总是会生成新的对象。所以连接和替换时性能很差。</p><h2 id="String常量字符串的累加"><a href="#String常量字符串的累加" class="headerlink" title="String常量字符串的累加"></a>String常量字符串的累加</h2><p>比如我们使用如下代码进行字符串连接：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"hello"</span>+<span class="string">"world"</span>+<span class="string">"!"</span>;</span><br></pre></td></tr></table></figure></p><p>先有hello和world2个字符串生成helloworld，然后再生成helloworld!。<br><a id="more"></a><br>将上面的代码做5万次循环。<br>但上面的代码执行效率竟然比使用StringBuilder快，为什么呢？<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">sb.append(<span class="string">"hello"</span>);</span><br><span class="line">sb.append(<span class="string">"world"</span>);</span><br><span class="line">sb.append(<span class="string">"!"</span>);</span><br></pre></td></tr></table></figure></p><p>对第一段代码进行反编译，可以看到对于常量字符串的累加，java在编译时就做了优化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">"helloworld!"</span>;</span><br></pre></td></tr></table></figure></p><h2 id="String变量字符串的累加"><a href="#String变量字符串的累加" class="headerlink" title="String变量字符串的累加"></a>String变量字符串的累加</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String a = <span class="string">"hello"</span>;</span><br><span class="line">        String b = <span class="string">"world"</span>;</span><br><span class="line">        String c = <span class="string">"!"</span>;</span><br><span class="line">        <span class="keyword">int</span> loopCount = <span class="number">50000000</span>;</span><br><span class="line">        <span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;loopCount;i++) &#123;</span><br><span class="line"><span class="comment">//            test(a,b,c);</span></span><br><span class="line">            test2(a,b,c);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"cost "</span> + (System.currentTimeMillis() - s) + <span class="string">"ms."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String a,String b,String c)</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        String s = stringBuilder.append(a).append(b).append(c).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(String a,String b,String c)</span> </span>&#123;</span><br><span class="line">        String s = a + b + c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同样做5万次循环，发现与使用StringBuilder性能差不多。<br>反编译，发现java在编译时做了优化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String a = <span class="string">"hello"</span>;</span><br><span class="line">        String b = <span class="string">"world"</span>;</span><br><span class="line">        String c = <span class="string">"!"</span>;</span><br><span class="line">        <span class="keyword">int</span> loopCount = <span class="number">50000000</span>;</span><br><span class="line">        <span class="keyword">long</span> s = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopCount; ++i) &#123;</span><br><span class="line">            test2(a, b, c);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"cost "</span> + (System.currentTimeMillis() - s) + <span class="string">"ms."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(String a, String b, String c)</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        stringBuilder.append(a).append(b).append(c).toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">(String a, String b, String c)</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> StringBuilder()).append(a).append(b).append(c).toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，java在编译的时候将字符串的+操作转换成了使用StringBuilder的append方式。</p><h2 id="构建超大的字符串"><a href="#构建超大的字符串" class="headerlink" title="构建超大的字符串"></a>构建超大的字符串</h2><p>对下面的代码ABC分别执行10000次。<br>代码A：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    s = s + i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>执行耗时：4542ms。</p><p>代码B：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String s = <span class="string">""</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    s = s.concat(String.valueOf(i));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>执行耗时：4079ms。</p><p>代码C：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    stringBuilder.append(i);</span><br><span class="line">&#125;</span><br><span class="line">String s = stringBuilder.toString();</span><br></pre></td></tr></table></figure></p><p>执行耗时：259ms。</p><p>可以看到，从快到慢依次是StringBuilder &gt; String.concat() &gt; String+。并且StringBuilder要快很多。</p><p>观察编译后的代码发现代码Ajava编译器并没有做任何优化。</p><h2 id="选择StringBuilder还是StringBuffer？"><a href="#选择StringBuilder还是StringBuffer？" class="headerlink" title="选择StringBuilder还是StringBuffer？"></a>选择StringBuilder还是StringBuffer？</h2><p>StringBuffer与StringBuilder最大的不同在于，StringBuffer对几乎所有的方法都做了同步，StringBuilder没有做任何同步。<br>由于方法同步需要消耗一定的系统资源，因此，StringBuffer效率要低于StringBuilder。但是，在多线程环境中，StringBuilder无法保证线程安全，不能使用。</p><p>所以，如果是不需要考虑线程安全的情况下，使用StringBuilder；相反则使用StringBuffer。</p><h2 id="容量参数"><a href="#容量参数" class="headerlink" title="容量参数"></a>容量参数</h2><p>无论是StringBuffer还是StringBuilder都可以在初始化时设置一个容量参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringBuffer</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringBuilder</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>;</span><br></pre></td></tr></table></figure></p><p>在不指定容量参数时，默认是16个字符。<br>代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StringBuilder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>StringBuffer和StringBuilder都继承自AbstractStringBuilder，AbstractStringBuilder的构造器代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AbstractStringBuilder(<span class="keyword">int</span> capacity) &#123;</span><br><span class="line">    value = <span class="keyword">new</span> <span class="keyword">char</span>[capacity];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="不带容量参数测试"><a href="#不带容量参数测试" class="headerlink" title="不带容量参数测试"></a>不带容量参数测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//StringBuilder sb = new StringBuilder();</span></span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000000</span>;i++) &#123;</span><br><span class="line">    sb.append(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>StringBuilder耗时405ms，StringBuffer耗时557ms。</p><h3 id="带容量参数测试"><a href="#带容量参数测试" class="headerlink" title="带容量参数测试"></a>带容量参数测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//StringBuilder sb = new StringBuilder(68888890);</span></span><br><span class="line">StringBuffer sb = <span class="keyword">new</span> StringBuffer(<span class="number">68888890</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10000000</span>;i++) &#123;</span><br><span class="line">    sb.append(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//System.out.println(sb.length());</span></span><br></pre></td></tr></table></figure><p>StringBuilder耗时330ms，StringBuffer耗时464ms。</p><p>通过对比，可以看到增加容量参数可以增加StringBuffer和StringBuilder的性能。</p><blockquote><p>StringBuffer和StringBuilder在执行append方法时，实际是调用父类AbstractStringBuilder的append方法。<br>父类append方法定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> AbstractStringBuilder <span class="title">append</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) str = <span class="string">"null"</span>;</span><br><span class="line">    <span class="keyword">int</span> len = str.length();</span><br><span class="line">    ensureCapacityInternal(count + len);</span><br><span class="line">    str.getChars(<span class="number">0</span>, len, value, count);</span><br><span class="line">    count += len;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>可以看到一个ensureCapacityInternal方法，定义如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This method has the same contract as ensureCapacity, but is</span></span><br><span class="line"><span class="comment"> * never synchronized.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacityInternal</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// overflow-conscious code</span></span><br><span class="line">    <span class="keyword">if</span> (minimumCapacity - value.length &gt; <span class="number">0</span>)</span><br><span class="line">        expandCapacity(minimumCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This implements the expansion semantics of ensureCapacity with no</span></span><br><span class="line"><span class="comment"> * size check or synchronization.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">expandCapacity</span><span class="params">(<span class="keyword">int</span> minimumCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = value.length * <span class="number">2</span> + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minimumCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minimumCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (minimumCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">        newCapacity = Integer.MAX_VALUE;</span><br><span class="line">    &#125;</span><br><span class="line">    value = Arrays.copyOf(value, newCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>minimumCapacity就是现在存储的数据的长度+本次append字符串的长度。如果该长度比定义的保存数据的char[]的长度大，说明char[]存储空间不够，需要进行扩容了。</p></blockquote><blockquote><p>扩容的逻辑：新的容量为目前数据的容量的2倍+2；如果扩容后的长度仍然小于目前数据的长度+本次append字符串的长度，则新的容量为目前数据的长度+本次append字符串的长度。<br>然后执行了一次数组的复制，将旧的数据复制到新的数组中。</p></blockquote><p>所以，如果指定合适的容量，可以避免SringBuilder和StringBuffer的内存复制，这样可以提升append的性能。<br>这个跟HashMap比较像，HashMap在put数据时，也会在容量不够是进行扩容。</p><p>参考：《Java程序性能优化——让你的java程序更快、更稳定》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java的类加载器</title>
      <link href="/2018/04/11/java-classloader/"/>
      <url>/2018/04/11/java-classloader/</url>
      
        <content type="html"><![CDATA[<h2 id="1-为什么要有类加载器"><a href="#1-为什么要有类加载器" class="headerlink" title="1.为什么要有类加载器"></a>1.为什么要有类加载器</h2><p>java文件编译后产生的，class文件不是可执行文件，需要通过类加载器将.class加载到虚拟机中。</p><h2 id="2-java类加载器有多少"><a href="#2-java类加载器有多少" class="headerlink" title="2.java类加载器有多少"></a>2.java类加载器有多少</h2><p>Bootstrap–&gt;ExtClassLoader-&gt;AppClassLoader-&gt;自定义的ClassLoader。</p><ul><li>BootStrap ClassLoader：称为启动类加载器，C++实现的，是Java类加载层次中最顶层的类加载器(JVM启动后初始化的)，负责加载JDK中的核心类库，如：rt.jar、resources.jar、charsets.jar等；</li><li>ExtensionClassLoader：称为扩展类加载器，负责加载Java的扩展类库，默认加载JAVA_HOME/jre/lib/ext/目下的所有jar。该加载器是有java实现的，由Bootstrploader加载ExtClassLoader,并且将ExtClassLoader的父加载器设置为Bootstrp loader；</li><li>AppClassLoader：称为系统类加载器，负责加载应用程序classpath目录下的所有jar和class文件。</li></ul><h2 id="3-类加载器的委托机制"><a href="#3-类加载器的委托机制" class="headerlink" title="3.类加载器的委托机制"></a>3.类加载器的委托机制</h2><p>先委托给父加载器去加载，一直委托到最顶层Bootstrap，Bootstrap去查找对应的类，没找到则委托ExtClassLoader去查找，一直到最底层的ClassLoader。</p><h2 id="4-自定义类加载器"><a href="#4-自定义类加载器" class="headerlink" title="4.自定义类加载器"></a>4.自定义类加载器</h2><p>继承ClassLoader,重写findClass方法即可。</p><h2 id="5-应用场景"><a href="#5-应用场景" class="headerlink" title="5.应用场景"></a>5.应用场景</h2><p>热部署、tomcat为每个应用创建了不同的类加载器隔离应用（tomcat的类加载器破坏了双亲委派机制，tomcat是从自定义的类加载器往Bootstrap查找）、class文件解密（假定传输方对class为了安全进行了加密，接收方需要自定义加载器进行解密，然后创建响应的对象使用）、java Applet（从远程下载class文件）、应用中需要用到不同版本的jar。</p><p>可以参考下面的这些链接，有详细的说明和例子。<br>参考：<a href="https://blog.csdn.net/liuxiao723846/article/details/47422683">自定义类加载器：从网上加载class到内存、实例化调用其中的方法</a>、<a href="https://blog.csdn.net/ITermeng/article/details/75669628">JVM高级特性与实践（九）：类加载器 与 双亲委派模式（自定义类加载器源码探究ClassLoader）</a>、<a href="https://www.ibm.com/developerworks/cn/java/j-lo-classloader/index.html?ca=drs-cn-0301">深入探讨 Java 类加载器</a>、<a href="https://www.imooc.com/article/19223">java类加载器和双亲委派模型</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git中本地与远程库的关联与取消</title>
      <link href="/2018/04/10/git-local-remote-relation/"/>
      <url>/2018/04/10/git-local-remote-relation/</url>
      
        <content type="html"><![CDATA[<p>1.在本地目录下关联远程repository ：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote add origin git@github.com:git_username/repository_name.git</span><br></pre></td></tr></table></figure></p><p>2.取消本地目录下关联的远程库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git remote remove origin</span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://blog.csdn.net/wsycsdn19930512/article/details/50574217">https://blog.csdn.net/wsycsdn19930512/article/details/50574217</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo主题推荐</title>
      <link href="/2018/04/10/hexo-recommended-themes/"/>
      <url>/2018/04/10/hexo-recommended-themes/</url>
      
        <content type="html"><![CDATA[<p>hexo主题：<br>hexo官网所有主题：<a href="https://hexo.io/themes/">https://hexo.io/themes/</a></p><p>个人觉得比较ok的主题：<br><a href="https://shuoit.net/">https://shuoit.net/</a><br><a href="http://www.91h5.cc/">http://www.91h5.cc/</a><br><a href="https://itimetraveler.github.io/hexo-theme-hiero/archives/">https://itimetraveler.github.io/hexo-theme-hiero/archives/</a><br><a href="http://chaoo.oschina.io/">http://chaoo.oschina.io/</a><br><a href="http://haojen.github.io/">http://haojen.github.io/</a><br><a href="https://www.haomwei.com/">https://www.haomwei.com/</a><br><a href="https://blog.minhow.com/">https://blog.minhow.com/</a><br><a href="http://notes.iissnan.com/">http://notes.iissnan.com/</a><br><a href="http://raytaylorlin.com/">http://raytaylorlin.com/</a><br><a href="http://sabrinaluo.github.io/tech/">http://sabrinaluo.github.io/tech/</a><br><a href="http://blog.minfive.com/">http://blog.minfive.com/</a><br><a href="https://vevlins.github.io/">https://vevlins.github.io/</a><br><a href="https://geekplux.com/">https://geekplux.com/</a><br><a href="https://yanm1ng.github.io/">https://yanm1ng.github.io/</a><br><a href="http://moxfive.xyz/">http://moxfive.xyz/</a><br><a href="http://bubuzou.com/">http://bubuzou.com/</a><br><a href="https://www.buhuoblog.com/">https://www.buhuoblog.com/</a><br><a href="https://www.imys.net/">https://www.imys.net/</a><br><a href="https://luuman.github.io/">https://luuman.github.io/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Session跨域共享问题解决</title>
      <link href="/2018/04/09/session-crossdomain-share/"/>
      <url>/2018/04/09/session-crossdomain-share/</url>
      
        <content type="html"><![CDATA[<h2 id="1-Session跨域存在的问题"><a href="#1-Session跨域存在的问题" class="headerlink" title="1.Session跨域存在的问题"></a>1.Session跨域存在的问题</h2><p>不同的域名下，Session无法共享。即设定用户在<a href="http://www.a.com登录，后端在Session中放入了用户的username和age，用户从www.a.com跳转到www.b.com，无法获取到Session中的用户信息。">www.a.com登录，后端在Session中放入了用户的username和age，用户从www.a.com跳转到www.b.com，无法获取到Session中的用户信息。</a></p><p>演示：<br>这里使用一个nginx+2个tomcat来演示。nginx在本机，1台tomcat在本机，另外一台IP为192.168.74.135。<br><a id="more"></a></p><p>项目结构如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-9/1037416.jpg" alt=""></p><p>添加JSP和servlet的依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置servlet--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置jsp jstl的支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>页面如下：<br>session.jsp<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@include</span> file=<span class="string">"head.jsp"</span>%&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Session跨域共享测试&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;form method=<span class="string">"POST"</span>&gt;</span><br><span class="line">    用户名：&lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> /&gt;</span><br><span class="line">    年龄：&lt;input type=<span class="string">"text"</span> name=<span class="string">"age"</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">"button"</span> value=<span class="string">"创建Session"</span> id=<span class="string">"addBtn"</span>&gt;</span><br><span class="line">  &lt;/form&gt;</span><br><span class="line">  &lt;hr/&gt;</span><br><span class="line">  &lt;input type=<span class="string">"button"</span>value=<span class="string">"获取Session"</span> id=<span class="string">"getSessionBtn"</span>&gt;</span><br><span class="line">  &lt;textarea rows="10" cols="80"&gt;&lt;/textarea&gt;</span><br><span class="line">  &lt;script src="$&#123;ctx&#125;/js/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">  &lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line">    <span class="keyword">var</span> flag = <span class="keyword">true</span>;</span><br><span class="line">    $(<span class="string">'#addBtn'</span>).click(function()&#123;</span><br><span class="line">      <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">       alert(<span class="string">'操作正在进行中...'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      flag = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">var</span> name = $(<span class="string">'[name=username]'</span>).val();</span><br><span class="line">      <span class="keyword">var</span> age = $(<span class="string">'[name=age]'</span>).val();</span><br><span class="line">      <span class="keyword">if</span> (name != <span class="string">''</span> &amp;&amp; age != <span class="string">''</span>) &#123;</span><br><span class="line">        $.post(<span class="string">'$&#123;ctx&#125;/session/add'</span>,&#123;username:name, age:age&#125;,function(r) &#123;</span><br><span class="line">          <span class="keyword">var</span> code = $.parseJSON(r).code;</span><br><span class="line">          console.log(<span class="string">'code-&gt;'</span> + code);</span><br><span class="line">          <span class="keyword">if</span> (code == <span class="number">0</span>) &#123;</span><br><span class="line">            alert(<span class="string">'创建session成功！'</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          flag = <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        alert(<span class="string">'缺少参数！'</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    $(<span class="string">'#getSessionBtn'</span>).click(function() &#123;</span><br><span class="line">      <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">        alert(<span class="string">'操作正在进行中...'</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      flag = <span class="keyword">false</span>;</span><br><span class="line">      $.get(<span class="string">'$&#123;ctx&#125;/session/get'</span>,function(r) &#123;</span><br><span class="line">        $(<span class="string">'textarea'</span>).html(r);</span><br><span class="line">        flag = <span class="keyword">true</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>head.jsp:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; isELIgnored=&quot;false&quot; %&gt;</span><br><span class="line">&lt;%@taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;</span><br><span class="line">&lt;c:set var=&quot;ctx&quot; value=&quot;$&#123;pageContext.request.contextPath&#125;&quot; /&gt;</span><br></pre></td></tr></table></figure></p><p>创建Session的Servlet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"sessionAddServlet"</span>,urlPatterns = <span class="string">"/session/add"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionAddServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String username = req.getParameter(<span class="string">"username"</span>);</span><br><span class="line">        String age = req.getParameter(<span class="string">"age"</span>);</span><br><span class="line">        System.out.println(String.format(<span class="string">"username-&gt;%s,age-&gt;%s"</span>,username,age));</span><br><span class="line">        HttpSession session = req.getSession();</span><br><span class="line">        session.setAttribute(<span class="string">"username"</span>,username);</span><br><span class="line">        session.setAttribute(<span class="string">"age"</span>,age);</span><br><span class="line">        PrintWriter printWriter = resp.getWriter();</span><br><span class="line">        printWriter.write(<span class="string">"&#123;\"code\":0&#125;"</span>);</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        printWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>获取Session的Servlet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"getSessionServlet"</span>,urlPatterns = <span class="string">"/session/get"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetSessionServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        HttpSession session = req.getSession();</span><br><span class="line">        String username = (String) session.getAttribute(<span class="string">"username"</span>);</span><br><span class="line">        String age = (String) session.getAttribute(<span class="string">"age"</span>);</span><br><span class="line">        String ip = req.getRemoteHost();</span><br><span class="line">        String userInfo = String.format(<span class="string">"&#123;ip:%s,username:%s,age:%s&#125;"</span>,ip,username,age);</span><br><span class="line">        System.out.println(userInfo);</span><br><span class="line">        PrintWriter pw = resp.getWriter();</span><br><span class="line">        pw.write(userInfo);</span><br><span class="line">        pw.flush();</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>将应用达成WAR包分别部署到本机和192.168.74.135的tomcat，并启动它们。<br>端口信息如下：<br>192.168.74.135的端口为8080，本机的端口为8081。</p><p>nginx配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream server_list &#123;</span><br><span class="line">    server 192.168.74.135:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       8088;</span><br><span class="line">    server_name  localhost_nginx;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        #root   html;</span><br><span class="line">        proxy_pass http://server_list;</span><br><span class="line">        #index  index.html index.htm;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   ...后面省略</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里指定nginx监听端口为8088，默认是80。</p><p>测试：<br>1.在浏览器输入<a href="http://localhost:8088/crossdomain-session/session.jsp">http://localhost:8088/crossdomain-session/session.jsp</a>，这样通过nginx转发请求。<br>a.输入用户名，年龄，然后点击“创建Session”创建Session保存用户名和年龄。<br>b.点击“获取Session”，<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-9/9100165.jpg" alt=""><br>可以看到用户名和年龄有值。<br>c.再次点击”获取Session”<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-9/35977810.jpg" alt=""><br>可以看到，这次请求的IP是192.168.74.135，用户名和年龄都是空。</p><p>因为Session是本机IP创建的，所以本机IP可以获取到，而192.168.74.135则无法获取到。</p><h2 id="2-使用IP-HASH"><a href="#2-使用IP-HASH" class="headerlink" title="2.使用IP_HASH"></a>2.使用IP_HASH</h2><p>在upstream中增加ip_hash;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream server_list &#123;</span><br><span class="line">    server 192.168.74.135:8080;</span><br><span class="line">    server localhost:8081;</span><br><span class="line">    ip_hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>重新启动nginx，再多次点击“获取Session”，发现都是本机的请求。nginx根据IP将请求分配给了本机的tomcat，由于Session是本机的tomcat创建的，所以可以获取到。</p><p>其实可以看到，多个tomcat并没有共享Session，只是nginx根据IP分发到了固定的tomcat。</p><p>弊端：<br>1.nginx不是最前端的服务器。ip_hash要求nginx一定是最前端的服务器，否则nginx得不到正确ip，就不能根据ip作hash。譬如使用的是squid为最前端，那么nginx取ip时只能得到squid的服务器ip地址，用这个地址来作分流是肯定错乱的。</p><p>2.nginx的后端还有其它方式的负载均衡。假如nginx后端又有其它负载均衡，将请求又通过另外的方式分流了，那么某个客户端的请求肯定不能定位到同一台session应用服务器上。这么算起来，nginx后端只能直接指向应用服务器，或者再搭一个squid，然后指向应用服务器。最好的办法是用location作一次分流，将需要session的部分请求通过ip_hash分流，剩下的走其它后端去。<br>可以参考：<a href="http://www.cnblogs.com/xiaogangqq123/archive/2011/03/04/1971002.html">http://www.cnblogs.com/xiaogangqq123/archive/2011/03/04/1971002.html</a></p><h2 id="3-使用jvm-route"><a href="#3-使用jvm-route" class="headerlink" title="3.使用jvm-route"></a>3.使用jvm-route</h2><p>参考：<a href="https://blog.csdn.net/honghailiang888/article/details/51066411">https://blog.csdn.net/honghailiang888/article/details/51066411</a><br>跟ip hash类似，也并没有真正解决session共享问题。而且将特定会话附属到特定的tomcat上，当该tomcat宕机时，用户的Session也会丢失。</p><h2 id="4-使用Redis等NoSQL"><a href="#4-使用Redis等NoSQL" class="headerlink" title="4.使用Redis等NoSQL"></a>4.使用Redis等NoSQL</h2><p>这里以Redis为例。</p><p>在用户登录成功后，将用户相关信息放入Redis，并设置过期时间；在用户退出登录时从Redis删除；如果会话超时则重新将用户数据放入Redis。</p><p>操作Redis的工具类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Redis服务器IP</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String ADDR = <span class="string">"192.168.74.135"</span>;</span><br><span class="line">    <span class="comment">//Redis的端口号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> PORT = <span class="number">6379</span>;</span><br><span class="line">    <span class="comment">//访问密码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String AUTH = <span class="string">"system"</span>;</span><br><span class="line">    <span class="comment">//可用连接实例的最大数目，默认值为8；</span></span><br><span class="line">    <span class="comment">//如果赋值为-1，则表示不限制；如果pool已经分配了maxActive个jedis实例，则此时pool的状态为exhausted(耗尽)。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_ACTIVE = <span class="number">1024</span>;</span><br><span class="line">    <span class="comment">//控制一个pool最多有多少个状态为idle(空闲的)的jedis实例，默认值也是8。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_IDLE = <span class="number">200</span>;</span><br><span class="line">    <span class="comment">//等待可用连接的最大时间，单位毫秒，默认值为-1，表示永不超时。如果超过等待时间，则直接抛出JedisConnectionException；</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_WAIT = <span class="number">10000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> TIMEOUT = <span class="number">10000</span>;</span><br><span class="line">    <span class="comment">//在borrow一个jedis实例时，是否提前进行validate操作；如果为true，则得到的jedis实例均是可用的；</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> TEST_ON_BORROW = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPool jedisPool = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化Redis连接池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">            config.setMaxTotal(MAX_ACTIVE);</span><br><span class="line">            config.setMaxIdle(MAX_IDLE);</span><br><span class="line">            config.setMaxWaitMillis(MAX_WAIT);</span><br><span class="line">            config.setTestOnBorrow(TEST_ON_BORROW);</span><br><span class="line">            jedisPool = <span class="keyword">new</span> JedisPool(config, ADDR, PORT, TIMEOUT, AUTH);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Jedis实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> Jedis <span class="title">getJedis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (jedisPool != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Jedis resource = jedisPool.getResource();</span><br><span class="line">                <span class="keyword">return</span> resource;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 释放jedis资源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jedis</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">returnResource</span><span class="params">(<span class="keyword">final</span> Jedis jedis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">            jedisPool.returnResource(jedis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取redis键值-object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            String value = jedis.get(key);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"getObject获取redis键值异常:key="</span> + key + <span class="string">" cause:"</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置redis键值-object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">set</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.set(key,value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"setObject设置redis键值异常:key="</span> + key + <span class="string">" value="</span> + value + <span class="string">" cause:"</span> + e.getMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">set</span><span class="params">(String key, String value,<span class="keyword">int</span> expiretime)</span> </span>&#123;</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            result = jedis.set(key,value);</span><br><span class="line">            <span class="keyword">if</span>(result.equals(<span class="string">"OK"</span>)) &#123;</span><br><span class="line">                jedis.expire(key.getBytes(), expiretime);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.err.println(<span class="string">"setObject设置redis键值异常:key="</span> + key + <span class="string">" value="</span> + value + <span class="string">" cause:"</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除key</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">delkey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.del(key.getBytes());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">existsKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.exists(key.getBytes());</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Set&lt;String&gt; <span class="title">keys</span><span class="params">(String keyPattern)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jedis = jedisPool.getResource();</span><br><span class="line">            <span class="keyword">return</span> jedis.keys(keyPattern);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                jedis.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>操作Cookie的工具类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CookieUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String <span class="title">getCookie</span><span class="params">(HttpServletRequest request,String cookieName)</span> </span>&#123;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        String key = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != cookies &amp;&amp; cookies.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Cookie cookie: cookies) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cookie.getName().equals(<span class="string">"sid"</span>)) &#123;</span><br><span class="line">                    key = cookie.getValue();</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>创建Session的Servlet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"sessionAddServlet"</span>,urlPatterns = <span class="string">"/session/add"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionAddServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String username = req.getParameter(<span class="string">"username"</span>);</span><br><span class="line">        String age = req.getParameter(<span class="string">"age"</span>);</span><br><span class="line">        System.out.println(String.format(<span class="string">"username-&gt;%s,age-&gt;%s"</span>,username,age));</span><br><span class="line">        String key = CookieUtil.getCookie(req, <span class="string">"sid"</span>);</span><br><span class="line">        <span class="keyword">boolean</span> addFlag = <span class="keyword">null</span> == key || <span class="string">""</span>.equals(key);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != key &amp;&amp; !<span class="string">""</span>.equals(key)) &#123;</span><br><span class="line">            String sid = RedisUtil.get(key);</span><br><span class="line">            addFlag = <span class="keyword">null</span> == sid || <span class="string">""</span>.equals(sid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (addFlag) &#123;</span><br><span class="line">            key = UUID.randomUUID().toString();</span><br><span class="line">            String ip = req.getRemoteHost();</span><br><span class="line">            System.out.println(<span class="string">"创建Session的IP："</span> + ip);</span><br><span class="line">            String userInfo = String.format(<span class="string">"&#123;username:%s,age:%s&#125;"</span>,username,age);</span><br><span class="line">            <span class="comment">// 将要保存到session中的数据写入Redis，有效期30分钟</span></span><br><span class="line">            RedisUtil.set(key,userInfo,<span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>);</span><br><span class="line">            <span class="comment">// 将Session的Key写入到用户浏览器cookie</span></span><br><span class="line">            Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"sid"</span>,key);</span><br><span class="line">            resp.addCookie(cookie);</span><br><span class="line">            System.out.println(<span class="string">"sid-&gt;"</span> + key);</span><br><span class="line">        &#125;</span><br><span class="line">        PrintWriter printWriter = resp.getWriter();</span><br><span class="line">        printWriter.write(String.format(<span class="string">"&#123;\"code\":0,\"msg\":\"%s\"&#125;"</span>,addFlag ? <span class="string">"Session创建成功！"</span>:<span class="string">"Session已存在！"</span>));</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        printWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>获取Session的Servlet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet</span>(name = <span class="string">"getSessionServlet"</span>,urlPatterns = <span class="string">"/session/get"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetSessionServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        String key = CookieUtil.getCookie(req,<span class="string">"sid"</span>);</span><br><span class="line">        String userInfo = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != key) &#123;</span><br><span class="line">            userInfo = RedisUtil.get(key);</span><br><span class="line">            System.out.println(userInfo);</span><br><span class="line">        &#125;</span><br><span class="line">        userInfo = userInfo == <span class="keyword">null</span> ? <span class="string">"No Session info."</span>:userInfo;</span><br><span class="line">        userInfo += <span class="string">"\nIP:"</span>+req.getRemoteHost();</span><br><span class="line">        PrintWriter pw = resp.getWriter();</span><br><span class="line">        pw.write(userInfo);</span><br><span class="line">        pw.flush();</span><br><span class="line">        pw.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意：<br>1.在创建Session（放入用户数据到Redis）的地方，如果已经有了Session，不能再重复创建。这个上面已经实现；<br>2.写入用户数据到Redis需要有过期时间（跟Session过期时间一致）；<br>3.用户退出登录时，需要将Redis的数据清空；</p><h2 id="5-进阶版"><a href="#5-进阶版" class="headerlink" title="5.进阶版"></a>5.进阶版</h2><p>上面使用Redis可以实现Session共享的功能，但是需要程序员去写这些相关代码。其实这些代码对所有需要使用Session共享的应用都是一样的，完全可以抽出来。<br>比如作为一个单独的依赖，其他应用使用只需要引入该依赖，并进行少量设置即可，相关Session操作跟操作HttpSession没有不同。</p><ul><li>重写HttpSession，涉及到Session相关的操作全部改为操作Redis；</li><li>重写HttpServletRequest，因为HttpServletRequest中有创建HttpSession的方法，我们需要改为我们自定义的HttpSession的实现类；</li><li>定义一个Filter，过滤需要登录的受保护的资源。在doFilter方法中，我们根据ServletRequest和ServletResponse重新构造我们自定义的HttpServletRequest。并调用filterChain.doFilter方法，将ServletRequest包装为我们自己的ServletRequest；</li></ul><p>代码参考：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpSessionImpl</span> <span class="keyword">implements</span> <span class="title">HttpSession</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line">    <span class="keyword">private</span> HttpServletResponse response;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> createTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastAccessTime;</span><br><span class="line">    <span class="comment">// session有效期30分钟</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxInactiveInterval = <span class="number">30</span>*<span class="number">60</span>;</span><br><span class="line">    <span class="keyword">private</span> Vector&lt;String&gt; names = <span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String SESSION_KEY_PREFIX = <span class="string">"session"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HttpSessionImpl</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">        <span class="keyword">this</span>.response = response;</span><br><span class="line">        <span class="keyword">boolean</span> isExist = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 如果已经有Session就不再创建了，否则会导致每次请求产生新的Session</span></span><br><span class="line">        <span class="comment">// 从请求头获取sid</span></span><br><span class="line">        String sid = CookieUtil.getCookie(request,<span class="string">"sid"</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != sid &amp;&amp; !<span class="string">""</span>.equals(sid)) &#123;</span><br><span class="line">            <span class="comment">// 检查Redis是否存在该Key</span></span><br><span class="line">            Set&lt;String&gt; keys = RedisUtil.keys(SESSION_KEY_PREFIX+<span class="string">":"</span>+sid+<span class="string">":*"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != keys &amp;&amp; !keys.isEmpty()) &#123;</span><br><span class="line">                isExist = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">this</span>.id = sid;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isExist) &#123;</span><br><span class="line">            <span class="keyword">this</span>.id = sid != <span class="keyword">null</span> &amp;&amp;!<span class="string">""</span>.equals(sid) ? sid : UUID.randomUUID().toString();</span><br><span class="line">            <span class="keyword">this</span>.createTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == sid || <span class="string">""</span>.equals(sid)) &#123;</span><br><span class="line">                Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"sid"</span>,<span class="keyword">this</span>.id);</span><br><span class="line">                response.addCookie(cookie);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getCreationTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getLastAccessedTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lastAccessTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletContext <span class="title">getServletContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> request.getServletContext();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMaxInactiveInterval</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.maxInactiveInterval = i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMaxInactiveInterval</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> maxInactiveInterval;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpSessionContext <span class="title">getSessionContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getAttribute</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lastAccessTime = System.currentTimeMillis();</span><br><span class="line">        String key = SESSION_KEY_PREFIX + <span class="string">":"</span> + id + <span class="string">":"</span> + s;</span><br><span class="line">        <span class="keyword">return</span> RedisUtil.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAttribute(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getAttributeNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> names.elements();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String[] getValueNames() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttribute</span><span class="params">(String s, Object o)</span> </span>&#123;</span><br><span class="line">        String key = SESSION_KEY_PREFIX + <span class="string">":"</span> + id + <span class="string">":"</span> + s;</span><br><span class="line">        <span class="comment">// 这里RedisUtil要实现保存对象，即byte[]的功能。</span></span><br><span class="line">        <span class="comment">//RedisUtil.set(s,o,maxInactiaveInterval);</span></span><br><span class="line">        <span class="comment">// 这里测试，假定保存的value是String类型</span></span><br><span class="line">        RedisUtil.set(key, (String) o, maxInactiveInterval);</span><br><span class="line">        <span class="keyword">this</span>.lastAccessTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.names.add(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putValue</span><span class="params">(String s, Object o)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeAttribute</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        String key = SESSION_KEY_PREFIX + <span class="string">":"</span> + id + <span class="string">":"</span> + s;</span><br><span class="line">        RedisUtil.delkey(key);</span><br><span class="line">        <span class="keyword">this</span>.names.remove(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeValue</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// session过期时，从Redis删除相关数据</span></span><br><span class="line">        String key;</span><br><span class="line">        <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">            key = SESSION_KEY_PREFIX + <span class="string">":"</span> + id + <span class="string">":"</span> + name;</span><br><span class="line">            RedisUtil.delkey(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isNew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TommyHttpServletRequest</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> HttpServletRequest request;</span><br><span class="line">    <span class="keyword">private</span> HttpServletResponse response;</span><br><span class="line">    <span class="keyword">private</span> HttpSessionImpl session;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TommyHttpServletRequest</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(request);</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">        <span class="keyword">this</span>.response = response;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpSession <span class="title">getSession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getSession(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpSession <span class="title">getSession</span><span class="params">(<span class="keyword">boolean</span> create)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (create &amp;&amp; <span class="keyword">this</span>.session == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.session = <span class="keyword">new</span> HttpSessionImpl(request,response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebFilter</span>(filterName = <span class="string">"sessionFilter"</span>,urlPatterns = <span class="string">"/*"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        TommyHttpServletRequest request = <span class="keyword">new</span> TommyHttpServletRequest((HttpServletRequest) servletRequest, (HttpServletResponse) servletResponse);</span><br><span class="line">        filterChain.doFilter(request,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以将上面的当初抽取出来作为一个依赖，其他应用引入该依赖，并配置Redis和Filter即可。</p><h2 id="6-使用Spring-Session"><a href="#6-使用Spring-Session" class="headerlink" title="6.使用Spring Session"></a>6.使用Spring Session</h2><p>参考：<a href="http://tommy88.top/2017/08/31/distribute-session-share/">分布式系统session共享方案</a></p><p>代码参考：<a href="https://gitee.com/qincd/my-test-projects">crossdomain-session</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列13——实现分布式配置管理</title>
      <link href="/2018/04/08/springcloud-series-13-distributed-configuration-management/"/>
      <url>/2018/04/08/springcloud-series-13-distributed-configuration-management/</url>
      
        <content type="html"><![CDATA[<p>在软件开发中，少不了系统参数配置信息。通常我们会将信息写入配置文件中。但是如果有很多个服务或应用需要配置，并且每个服务还分为开发、测试、生产等不同维度的配置，那配置量还是很大的。当然，我们也可以将配置信息放入Redis、db、zookeeper等，然后开发一个管理界面进行管理。但是这无疑增加了额外的工作成本。</p><p>在spring cloud中，为我们提供了分布式配置管理功能，我们只需稍加配置即可使用。<br><a id="more"></a><br>使用spring cloud来实现分布式配置管理功能大致需要如下几步：<br>1、创建配置文件仓库<br>Spring cloud使用git或svn存放配置文件，默认情况下使用git，因此你需要安装git私服或者直接使用互联网上的github或者git.oschina，这里使用的git.oschina。<br>创建一个空的module，取名cloud-config-repo，另外创建2个配置文件，名字分别为cloud-config-dev.properties和cloud-config-test.properteis。<br>这两个文件分别对应开发环境和测试环境所需要的配置信息，配置信息如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysqldb.datasource.url=jdbc\:mysql\://192.168.74.135\:3306/test?useUnicode\=true&amp;characterEncoding\=utf-8</span><br><span class="line">mysqldb.datasource.username=root</span><br><span class="line">mysqldb.datasource.password=123456</span><br><span class="line">logging.level.org.springframework.web:DEBUG</span><br><span class="line"></span><br><span class="line">my.custom.message=Hello,This message is from cloud-config-repo!</span><br></pre></td></tr></table></figure></p><p>如上，配置文件包含了mysql的数据库连接信息和一条自定义的message。</p><p>然后提交到git.oschina。</p><p>2、创建spring cloud配置服务器<br>配置服务器的作用是从远程git或svn仓库中提取配置信息，并提供rest接口给外部调用。这个功能是spring cloud提供的，我们只需引入相关的jar包，并稍微设置一下即可。</p><p>创建一个module，并取名为cloud-config-server。<br>在pom文件中增加配置服务器的相关依赖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></p><p>application.properteis文件配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.port=8888</span><br><span class="line">spring.cloud.config.server.git.uri=https://gitee.com/qincd/springcloud-demos.git</span><br><span class="line">spring.cloud.config.server.git.searchPaths=cloud-config-repo</span><br></pre></td></tr></table></figure></p><p>其中server.port是配置当前web应用绑定8888端口，git.uri指定配置文件所在的git工程路径，searchPaths表示将搜索该文件夹下的配置文件（我们的配置文件放在springcloud-demos这个工程的cloud-config-repo文件夹下）</p><p>在spring boot应用启动类中增加@EnableConfigServer，激活该应用为配置文件服务器。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后启动cloud-config-server，浏览器输入<a href="http://127.0.0.1:8888/cloud-config-dev.properties">http://127.0.0.1:8888/cloud-config-dev.properties</a>，可以看到已经获取到配置信息，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-8/33054229.jpg" alt=""></p><p>3、创建一个服务使用该远程配置<br>创建一个module，取名为cloud-config-client，来从cloud-config-server获取配置信息使用。</p><p>这里我们使用mysql的配置信息来获取用户的信息，以及显示自定义的1条消息。</p><p>相关依赖如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>在resources下新增bootstrap.properteis文件，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.uri=http://127.0.0.1:$&#123;config.port:8888&#125;</span><br><span class="line">spring.cloud.config.name=cloud-config</span><br><span class="line">spring.cloud.config.profile=$&#123;config.profile:dev&#125;</span><br></pre></td></tr></table></figure></p><p>其中config.uri指定远程加载配置信息的地址，就是前面我们刚建立的配置管理服务器的地址，绑定端口8888，其中config.port:8888，表示如果在命令行提供了config.port参数，我们就用这个端口，否则就用8888端口。config.name表示配置文件名称，查看我们前面创建配置文件，是这个名称：<br>cloud-config-dev.properties<br>可以分成两部分: {application}- {profile}.properties</p><p>所以我们配置config.name为cloud-config，config.profile为dev，其中dev表示开发配置文件，配置文件仓库里还有一个测试环境的配置文件，切换该配置文件只需要将dev改为test即可，当然这个参数也可以由启动时命令行传入，如：<br>java -jar cloud-simple-service-1.0.0.jar –config.profile =test<br>此时应用就会加载测试环境下的配置信息。</p><p>application.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server.port=8080</span><br><span class="line"></span><br><span class="line">#DB Configuration:</span><br><span class="line">spring.datasource.driverClassName = com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url = $&#123;mysqldb.datasource.url&#125;</span><br><span class="line">spring.datasource.username = $&#123;mysqldb.datasource.username&#125;</span><br><span class="line">spring.datasource.password = $&#123;mysqldb.datasource.password&#125;</span><br><span class="line"></span><br><span class="line">#JPA Configuration:</span><br><span class="line">spring.jpa.database=MySQL</span><br><span class="line">spring.jpa.show-sql=true</span><br><span class="line">spring.jpa.generate-ddl=true</span><br><span class="line">spring.jpa.hibernate.ddl-auto=update</span><br><span class="line">#spring.jpa.database-platform=org.hibernate.dialect.MySQL5Dialect</span><br><span class="line">spring.jpa.hibernate.naming_strategy=org.hibernate.cfg.ImprovedNamingStrategy</span><br><span class="line">#spring.jpa.database=org.hibernate.dialect.MySQL5InnoDBDialect</span><br><span class="line">#spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MYSQL5Dialect</span><br></pre></td></tr></table></figure></p><p>数据库的一张user表数据如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-8/9007617.jpg" alt=""></p><p>定义一个实体类User<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"user_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"user_image"</span>)</span><br><span class="line">    <span class="keyword">private</span> String userImage;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String summary;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> Long createdAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>增加一个根据username获取用户想信息的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">CrudRepository</span>&lt;<span class="title">User</span>,<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">User <span class="title">findByUsername</span><span class="params">(String username)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userDao.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/&#123;username&#125;"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserByUsername</span><span class="params">(@PathVariable String username)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(username)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"参数不能为空！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userService.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再增加一个获取自定义配置信息的Service<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;my.custom.message&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCustomMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>OK，准备工作完毕！下面进行测试。</p><p>启动cloud-config-server和cloud-config-client应用。<br>1.数据库配置测试<br>浏览器输入<a href="http://127.0.0.1:8080/user/admin">http://127.0.0.1:8080/user/admin</a>，结果如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-8/34352996.jpg" alt=""><br>可以看到获取到了用户信息，即说明已经使用了远程参考的数据库配置信息。</p><p>2.自定义消息测试<br>我们新建一个测试类来进行测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppTest</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetCustomMsg</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String msg = configService.getCustomMsg();</span><br><span class="line">        assertNotNull(msg);</span><br><span class="line">        System.out.println(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行该测试类，执行结果如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-4-8/97909672.jpg" alt=""><br>说明已经获取到了远程参考中定义的自定义配置。</p><p>代码：<a href="https://gitee.com/qincd/springcloud-demos/">https://gitee.com/qincd/springcloud-demos/</a></p><p>说明：本文参照<a href="http://www.cnblogs.com/skyblog/p/5129603.html">使用spring cloud实现分布式配置管理</a>进行测试。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BlueLake主题增加gitment评论</title>
      <link href="/2018/04/03/hexo-bluelake-theme-use-gitment/"/>
      <url>/2018/04/03/hexo-bluelake-theme-use-gitment/</url>
      
        <content type="html"><![CDATA[<h2 id="1-注册-OAuth-Application"><a href="#1-注册-OAuth-Application" class="headerlink" title="1.注册 OAuth Application"></a>1.注册 OAuth Application</h2><p><a href="https://github.com/settings/applications/new">点击此处</a> 来注册一个新的 OAuth Application。其他内容可以随意填写，但要确保填入正确的 callback URL（一般是评论页面对应的域名，如 <a href="https://imsun.net）。">https://imsun.net）。</a><br>如果使用的github地址跳转到<a href="http://tommy88.top，则填写http://tommy88.top。">http://tommy88.top，则填写http://tommy88.top。</a></p><p>你会得到一个 client ID 和一个 client secret，这个将被用于之后的用户登录。</p><h2 id="2-在BlueLake主题的-config-yml中增加gitment的配置"><a href="#2-在BlueLake主题的-config-yml中增加gitment的配置" class="headerlink" title="2.在BlueLake主题的_config.yml中增加gitment的配置"></a>2.在BlueLake主题的_config.yml中增加gitment的配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gitment:</span><br><span class="line">  enable: true # 是否开启gitment评论系统</span><br><span class="line">  mint: true #</span><br><span class="line">  count: true # 是否显示评论数</span><br><span class="line">  lazy: true # 懒加载，设置为ture时需手动展开评论</span><br><span class="line">  cleanly: true # 是否隐藏&apos;Powered by ...&apos;</span><br><span class="line">  language: en # 语言，置空则随主题的语言</span><br><span class="line">  github_user: luckystar88 # Github用户名</span><br><span class="line">  github_repo: comments # 在Github新建一个仓库用于存放评论，这是仓库名</span><br><span class="line">  client_id: beecde0acb47cc10965c # 注册OAuth Application时生成</span><br><span class="line">  client_secret: 2a7655badd4d1e416000a3abc4b0676e5c70577f # 注册OAuth Application时生成</span><br><span class="line">  proxy_gateway: # Address of api proxy, See: https://github.com/aimingoo/intersect</span><br><span class="line">  redirect_protocol: # Protocol of redirect_uri with force_redirect_protocol when mint enabled</span><br></pre></td></tr></table></figure><h2 id="3-在comments-js-jade中增加gitment配置"><a href="#3-在comments-js-jade中增加gitment配置" class="headerlink" title="3.在comments_js.jade中增加gitment配置"></a>3.在comments_js.jade中增加gitment配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">if theme.gitment.enable</span><br><span class="line">  link(rel=&apos;stylesheet&apos;,href=&apos;https://imsun.github.io/gitment/style/default.css&apos;)</span><br><span class="line">  script(src=&apos;https://imsun.github.io/gitment/dist/gitment.browser.js&apos;)</span><br><span class="line">  script.</span><br><span class="line">    var gitment = new Gitment(&#123;</span><br><span class="line">      id: &apos;#&#123;page.path&#125;&apos;, // 可选。默认为 location.href</span><br><span class="line">      owner: &apos;#&#123;theme.gitment.github_user&#125;&apos;,</span><br><span class="line">      repo: &apos;#&#123;theme.gitment.github_repo&#125;&apos;,</span><br><span class="line">      oauth: &#123;</span><br><span class="line">        client_id: &apos;#&#123;theme.gitment.client_id&#125;&apos;,</span><br><span class="line">        client_secret: &apos;#&#123;theme.gitment.client_secret&#125;&apos;,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    gitment.render(&apos;comments&apos;)</span><br></pre></td></tr></table></figure><p>注意：BlueLake主题使用的容器是base.jade中的id=comments的div，所以这里gitment.render的id不是自己创建的容器。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用socket模拟tomcat实现静态资源处理</title>
      <link href="/2018/03/30/use-socket-mock-tomcat-handle-static-resources/"/>
      <url>/2018/03/30/use-socket-mock-tomcat-handle-static-resources/</url>
      
        <content type="html"><![CDATA[<h2 id="步骤："><a href="#步骤：" class="headerlink" title="步骤："></a>步骤：</h2><p>1.服务端使用ServerSocket，监听指定的端口。<br>2.调用ServerSocket的accept方法接收客户端连接，得到Socket对象。<br>3.根据Socket对象的getInputStream()方法得到输入流，从而拿到浏览器发送的http请求的基本信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /htmlfiles/test2.jsp HTTP/1.1</span><br><span class="line">Host: localhost:9191</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.146 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class="line">DNT: 1</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: Hm_lvt_9bd56a6d0766b887592ee921aa94763f=1500436957; __atuvc=47%7C35; _ga=GA1.1.2016651800.1504071340; Hm_lvt_4e003ba2028a4a83d95714c602ee7df5=1507970222; Hm_lvt_47acec2d282c3986f1b600abdc11c7ab=1520665960,1521097911,1521252255,1521540649</span><br></pre></td></tr></table></figure></p><p>4.解析http请求，提取要访问的资源文件的位置，使用Socket的getOutputStream拿到输出流，将文件的内容写到输出流。<br>5.资源请求完毕，关闭相关的流和Socket。<br><a id="more"></a></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ServerSocket serverSocket = <span class="keyword">null</span>;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">9191</span>);</span><br><span class="line">            System.out.println(<span class="string">"Server已在端口9191启动！"</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                socket = serverSocket.accept();</span><br><span class="line">                InputStream inputStream = socket.getInputStream();</span><br><span class="line">                Request request = <span class="keyword">new</span> Request(inputStream);</span><br><span class="line">                OutputStream outputStream = socket.getOutputStream();</span><br><span class="line">                Response response = <span class="keyword">new</span> Response(outputStream, request);</span><br><span class="line">                response.response();</span><br><span class="line">                outputStream.close();</span><br><span class="line">                inputStream.close();</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                serverSocket.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String uri;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Request</span><span class="params">(InputStream in)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String content = IOUtils.getRequestContent(in);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == content || <span class="string">""</span>.equals(content)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Bad request."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"客户端请求：\n"</span> + content);</span><br><span class="line">            parseUri(content);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseUri</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uri = content.substring(content.indexOf(<span class="string">"/"</span>),content.indexOf(<span class="string">"HTTP/"</span>)-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUri</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUri</span><span class="params">(String uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uri = uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Request request;</span><br><span class="line">    <span class="keyword">private</span> OutputStream os;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Response</span><span class="params">(OutputStream os, Request request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.os = os;</span><br><span class="line">        <span class="keyword">this</span>.request = request;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">response</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String uri = request.getUri();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != uri &amp;&amp; !<span class="string">""</span>.equals(uri)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isResource()) &#123;</span><br><span class="line">                String path = Http_Server.WEB_ROOT + uri.substring(<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (IOUtils.isFileExist(path)) &#123;</span><br><span class="line">                    IOUtils.writeFile(os, path);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    String errorMessage = buildResponse(<span class="string">"File Not Found"</span>,<span class="string">"404"</span>,<span class="string">""</span>);</span><br><span class="line">                    IOUtils.write(os, errorMessage.getBytes());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String errorMessage = buildResponse(<span class="string">"动态请求暂不支持"</span>,<span class="string">"200"</span>,<span class="string">"OK"</span>);</span><br><span class="line">                IOUtils.write(os, errorMessage.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildResponse</span><span class="params">(String content, String statusCode, String statusMsg)</span> </span>&#123;</span><br><span class="line">        String html = buildHTML(content);</span><br><span class="line">        <span class="keyword">int</span> chineseCount = StringUtils.getChineseCharCount(html);</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        buffer.append(<span class="string">"HTTP/1.1 "</span>)</span><br><span class="line">                .append(statusCode).append(<span class="string">" "</span>)</span><br><span class="line">                .append(statusMsg).append(<span class="string">"\r\n"</span>)</span><br><span class="line">                .append(<span class="string">"Content-Type: text/html\r\n"</span>)</span><br><span class="line"><span class="comment">//                .append("Content-Length: ")</span></span><br><span class="line"><span class="comment">//                .append(html.length()+2*chineseCount) // 1个中文字符占3个字节</span></span><br><span class="line">                .append(<span class="string">"\r\n\r\n"</span>)</span><br><span class="line">                .append(html);</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildHTML</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        StringBuffer html = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        html.append(<span class="string">"&lt;html&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;head&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\"&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;/head&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;body&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;h1&gt;"</span>).append(content).append(<span class="string">"&lt;/h1&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;/body&gt;\n"</span>);</span><br><span class="line">        html.append(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">        <span class="keyword">return</span> html.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isResource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String[] suffixs = &#123;<span class="string">"html"</span>, <span class="string">"js"</span>, <span class="string">"css"</span>, <span class="string">"jpg"</span>, <span class="string">"jpeg"</span>, <span class="string">"gif"</span>, <span class="string">"bmp"</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (String suf : suffixs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (request.getUri().endsWith(<span class="string">"."</span> + suf)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IOUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRequestContent</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        <span class="keyword">int</span> len = inputStream.read(data);</span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(data,<span class="number">0</span>,len);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isFileExist</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(path);</span><br><span class="line">        <span class="keyword">return</span> file.exists();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getFileContent(String path) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(path);</span><br><span class="line">            <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[(<span class="keyword">int</span>) file.length()];</span><br><span class="line">                FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">                fis.read(data);</span><br><span class="line">                <span class="keyword">return</span> data;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream os,<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            os.write(data);</span><br><span class="line">            os.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeFile</span><span class="params">(OutputStream os,String path)</span> </span>&#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> BUFFER_SIZE = <span class="number">1024</span>;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(path);</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">            <span class="keyword">int</span> len = fis.read(data,<span class="number">0</span>,BUFFER_SIZE);</span><br><span class="line">            <span class="keyword">boolean</span> isFirst = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">while</span> (len != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isFirst) &#123;</span><br><span class="line">                    os.write(<span class="string">"HTTP/1.0 200 OK\r\n"</span>.getBytes());</span><br><span class="line">                    os.write(<span class="string">"\r\n"</span>.getBytes());;<span class="comment">// 根据 HTTP 协议, 空行将结束头信息</span></span><br><span class="line">                    isFirst = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                os.write(data,<span class="number">0</span>,len);</span><br><span class="line">                len = fis.read(data,<span class="number">0</span>,BUFFER_SIZE);</span><br><span class="line">                os.flush();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (fis != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fis.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Http_Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String WEB_ROOT = Http_Server.class.getResource(<span class="string">"/"</span>).getPath();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试HTML<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>测试页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">"/htmlfiles/css/test.css"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是测试页面。<span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://localhost:9191/htmlfiles/images/1.jpg"</span>&gt;</span>点击打开图片<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>资源文件放在src目录下。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/41857555.jpg" alt=""></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>1.动态请求测试<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/4136960.jpg" alt=""></p><p>2.不存在的静态文件<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/12083022.jpg" alt=""></p><p>3.存在的静态文件<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/97192850.jpg" alt=""></p><p>4.图片等二进制文件测试<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/37310765.jpg" alt=""></p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>1.你得通过响应头告诉浏览器请求的状态码和资源类型，否则浏览器会告诉你这是无效的http响应。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">os.write(<span class="string">"HTTP/1.0 200 OK\r\n"</span>.getBytes());</span><br><span class="line">os.write(<span class="string">"\r\n"</span>.getBytes());;<span class="comment">// 根据 HTTP 协议, 空行将结束头信息</span></span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-3-30/42783805.jpg" alt=""></p><p>2.如果指定了Content-Length，需要注意中文1个字符占用3个字节，否则会导致浏览器显示不全。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buffer.append(<span class="string">"Content-Length: "</span>)</span><br><span class="line">buffer.append(html.length()+<span class="number">2</span>*chineseCount) <span class="comment">// 1个中文字符占3个字节</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysql分库分区分表</title>
      <link href="/2018/03/28/mysql-pool-partiion-table/"/>
      <url>/2018/03/28/mysql-pool-partiion-table/</url>
      
        <content type="html"><![CDATA[<p>分库分表、分区、读写分离 这些都是用在什么场景下 ，会带来哪些效率或者其他方面的好处<br><a href="https://segmentfault.com/q/1010000009044121">https://segmentfault.com/q/1010000009044121</a></p><p>mysql 分表，分区，分库相关及merge引擎<br><a href="https://blog.csdn.net/mengfanzhong/article/details/55107106">https://blog.csdn.net/mengfanzhong/article/details/55107106</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HttpClient进行https请求</title>
      <link href="/2018/03/22/HttpClient-https/"/>
      <url>/2018/03/22/HttpClient-https/</url>
      
        <content type="html"><![CDATA[<p>并不是所有的https请求都需要按照下面的代码进行设置，如果遇到下面的问题，则需要这么做。</p><blockquote><p>javax.net.ssl.SSLException: hostname in certificate didn’t match:</p></blockquote><a id="more"></a><h2 id="采用绕过验证的方式处理https请求"><a href="#采用绕过验证的方式处理https请求" class="headerlink" title="采用绕过验证的方式处理https请求"></a>采用绕过验证的方式处理https请求</h2><p>需要指定信任所有证书，并指定不校验域名。</p><h3 id="DefaultHttpClient"><a href="#DefaultHttpClient" class="headerlink" title="DefaultHttpClient"></a>DefaultHttpClient</h3><p>代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DefaultHttpClient <span class="title">getHttpClient</span><span class="params">(String url, Proxy proxy)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SSLSocketFactory sf = <span class="keyword">new</span> SSLSocketFactory(<span class="keyword">new</span> TrustStrategy() &#123;</span><br><span class="line">        <span class="comment">// 信任所有</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTrusted</span><span class="params">(java.security.cert.X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> java.security.cert.CertificateException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    sf.setHostnameVerifier(SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER);</span><br><span class="line">    <span class="comment">// 连接池设置</span></span><br><span class="line">    SchemeRegistry schemeRegistry = <span class="keyword">new</span> SchemeRegistry();</span><br><span class="line">    schemeRegistry.register(<span class="keyword">new</span> Scheme(<span class="string">"http"</span>, <span class="number">80</span>, PlainSocketFactory.getSocketFactory()));</span><br><span class="line">    schemeRegistry.register(<span class="keyword">new</span> Scheme(<span class="string">"https"</span>, <span class="number">443</span>, sf));</span><br><span class="line">    PoolingClientConnectionManager cm = <span class="keyword">new</span> PoolingClientConnectionManager(schemeRegistry);</span><br><span class="line">    cm.setMaxTotal(<span class="number">200</span>); <span class="comment">// 连接池里的最大连接数</span></span><br><span class="line">    cm.setDefaultMaxPerRoute(<span class="number">20</span>); <span class="comment">// 每个路由的默认最大连接数</span></span><br><span class="line">    <span class="comment">// 其它设置</span></span><br><span class="line">    DefaultHttpClient httpClient = <span class="keyword">new</span> DefaultHttpClient(cm);</span><br><span class="line">    CookieStore cookieStore = httpClient.getCookieStore();</span><br><span class="line">    <span class="comment">// 添加语言cookie</span></span><br><span class="line">    BasicClientCookie2 langCookie = <span class="keyword">new</span> BasicClientCookie2(<span class="string">"LangKey"</span>, <span class="string">"cs"</span>);</span><br><span class="line">    langCookie.setVersion(<span class="number">0</span>);</span><br><span class="line">    langCookie.setDomain(Utility.getPurceHost(url));</span><br><span class="line">    langCookie.setPath(<span class="string">"/"</span>);</span><br><span class="line">    cookieStore.addCookie(langCookie);</span><br><span class="line">    HttpRequestRetryHandler myRetryHandler = <span class="keyword">new</span> HttpRequestRetryHandler() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">retryRequest</span><span class="params">(IOException exception,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">int</span> executionCount, HttpContext context)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (executionCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果超过最大重试次数，那么就不要继续了</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> NoHttpResponseException) &#123;</span><br><span class="line">                <span class="comment">// 如果服务器丢掉了连接，那么就重试</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> SSLHandshakeException) &#123;</span><br><span class="line">                <span class="comment">// 不要重试SSL握手异常</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            HttpRequest request = (HttpRequest) context</span><br><span class="line">                    .getAttribute(ExecutionContext.HTTP_REQUEST);</span><br><span class="line">            <span class="keyword">boolean</span> idempotent = !(request <span class="keyword">instanceof</span> HttpEntityEnclosingRequest);</span><br><span class="line">            <span class="keyword">if</span> (idempotent) &#123;</span><br><span class="line">                <span class="comment">// 如果请求被认为是幂等的，那么就重试</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    httpClient.setHttpRequestRetryHandler(myRetryHandler);</span><br><span class="line">    <span class="comment">// 设置读取超时时间</span></span><br><span class="line">    httpClient.getParams().setIntParameter(<span class="string">"http.socket.timeout"</span>,</span><br><span class="line">            SnatchConstant.TIMEOUT);</span><br><span class="line">    <span class="comment">// 设置连接超时超时</span></span><br><span class="line">    httpClient.getParams()</span><br><span class="line">            .setIntParameter(HttpConnectionParams.CONNECTION_TIMEOUT,</span><br><span class="line">                    SnatchConstant.TIMEOUT);</span><br><span class="line">    <span class="comment">// 添加代理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != proxy) &#123;</span><br><span class="line">        <span class="keyword">if</span> (proxy.getUsed() == <span class="number">1</span>) &#123;</span><br><span class="line">            String ip = proxy.getIp();<span class="comment">// 代理ip</span></span><br><span class="line">            <span class="keyword">int</span> port = proxy.getPort();<span class="comment">// 代理端口</span></span><br><span class="line">            String proxyUserName = proxy.getUsername();<span class="comment">// 代理账号用户名</span></span><br><span class="line">            String proxyPassword = proxy.getPassword();<span class="comment">// 代理账号密码</span></span><br><span class="line">            <span class="keyword">if</span> (!(Utility.isNull(ip) || port &lt;= <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="comment">// 访问的目标站点，端口和协议</span></span><br><span class="line">                httpClient.getCredentialsProvider().setCredentials(</span><br><span class="line">                        <span class="keyword">new</span> AuthScope(ip, port),</span><br><span class="line">                        <span class="keyword">new</span> UsernamePasswordCredentials(proxyUserName,</span><br><span class="line">                                proxyPassword));</span><br><span class="line">                <span class="comment">// 代理的设置</span></span><br><span class="line">                HttpHost proxyHost = <span class="keyword">new</span> HttpHost(ip, port);</span><br><span class="line">                httpClient.getParams().setParameter(</span><br><span class="line">                        ConnRoutePNames.DEFAULT_PROXY, proxyHost);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> httpClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="CloseableHttpClient"><a href="#CloseableHttpClient" class="headerlink" title="CloseableHttpClient"></a>CloseableHttpClient</h3><p>如果是CloseableHttpClient，可以使用下面的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CloseableHttpClient <span class="title">createSSLClientDefault</span><span class="params">(String url, Proxy proxy)</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        CookieStore cookieStore = <span class="keyword">new</span> BasicCookieStore();</span><br><span class="line">        <span class="comment">// 添加语言cookie</span></span><br><span class="line">        BasicClientCookie2 langCookie = <span class="keyword">new</span> BasicClientCookie2(<span class="string">"LangKey"</span>, <span class="string">"cs"</span>);</span><br><span class="line">        langCookie.setVersion(<span class="number">0</span>);</span><br><span class="line">        langCookie.setDomain(Utility.getPurceHost(url));</span><br><span class="line">        langCookie.setPath(<span class="string">"/"</span>);</span><br><span class="line">        cookieStore.addCookie(langCookie);</span><br><span class="line">        RequestConfig config = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">            config = RequestConfig.custom().setConnectTimeout(SnatchConstant.TIMEOUT).setSocketTimeout(SnatchConstant.TIMEOUT).build();</span><br><span class="line">        &#125;</span><br><span class="line">        SSLContext sslContext = <span class="keyword">new</span> SSLContextBuilder().loadTrustMaterial(<span class="keyword">null</span>, <span class="keyword">new</span> TrustStrategy() &#123;</span><br><span class="line">            <span class="comment">//信任所有</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTrusted</span><span class="params">(java.security.cert.X509Certificate[] x509Certificates, String s)</span> <span class="keyword">throws</span> java.security.cert.CertificateException </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).build();</span><br><span class="line">        SSLConnectionSocketFactory sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(sslContext);</span><br><span class="line">        <span class="keyword">return</span> HttpClients.custom().setSSLSocketFactory(sslsf).setDefaultCookieStore(cookieStore).setDefaultRequestConfig(config).setRetryHandler((<span class="keyword">new</span> HttpRequestRetryHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">retryRequest</span><span class="params">(IOException exception, <span class="keyword">int</span> executionCount, HttpContext context)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (executionCount &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果超过最大重试次数，那么就不要继续了</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> NoHttpResponseException) &#123;</span><br><span class="line">                    <span class="comment">// 如果服务器丢掉了连接，那么就重试</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> SSLHandshakeException) &#123;</span><br><span class="line">                    <span class="comment">// 不要重试SSL握手异常</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                HttpRequest request = (HttpRequest) context.getAttribute(ExecutionContext.HTTP_REQUEST);</span><br><span class="line">                <span class="keyword">boolean</span> idempotent = !(request <span class="keyword">instanceof</span> HttpEntityEnclosingRequest);</span><br><span class="line">                <span class="keyword">if</span> (idempotent) &#123;</span><br><span class="line">                    <span class="comment">// 如果请求被认为是幂等的，那么就重试</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)).build();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeyManagementException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeyStoreException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>  HttpClients.createDefault();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://blog.csdn.net/klzyf100/article/details/78873222">轻松把玩HttpClient之配置ssl，采用绕过证书验证实现https</a></p><h2 id="加载证书来访问HTTPS网站"><a href="#加载证书来访问HTTPS网站" class="headerlink" title="加载证书来访问HTTPS网站"></a>加载证书来访问HTTPS网站</h2><h3 id="DefaultHttpClient-1"><a href="#DefaultHttpClient-1" class="headerlink" title="DefaultHttpClient"></a>DefaultHttpClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DefaultHttpClient hc = <span class="keyword">new</span> DefaultHttpClient();</span><br><span class="line"><span class="comment">//加载证书  </span></span><br><span class="line">java.security.KeyStore trustStore = java.security.KeyStore.getInstance(java.security.KeyStore.getDefaultType());  </span><br><span class="line"><span class="comment">//"123456"为制作证书时的密码  </span></span><br><span class="line">trustStore.load(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"你的证书位置"</span>)), <span class="string">"123456"</span>.toCharArray());  </span><br><span class="line">org.apache.http.conn.ssl.SSLSocketFactory socketFactory = <span class="keyword">new</span> org.apache.http.conn.ssl.SSLSocketFactory(trustStore);  </span><br><span class="line"><span class="comment">//不校验域名  </span></span><br><span class="line">socketFactory.setHostnameVerifier(org.apache.http.conn.ssl.SSLSocketFactory.ALLOW_ALL_HOSTNAME_VERIFIER);  </span><br><span class="line"><span class="comment">//这个8446是和被访问端约定的端口，一般为443  </span></span><br><span class="line">org.apache.http.conn.scheme.Scheme sch = <span class="keyword">new</span> org.apache.http.conn.scheme.Scheme(<span class="string">"https"</span>, socketFactory, <span class="number">8446</span>);  </span><br><span class="line">hc.getConnectionManager().getSchemeRegistry().register(sch);</span><br></pre></td></tr></table></figure><p>参考：<a href="http://blog.csdn.net/wangshfa/article/details/9059089">http://blog.csdn.net/wangshfa/article/details/9059089</a></p><h3 id="CloseableHttpClient-1"><a href="#CloseableHttpClient-1" class="headerlink" title="CloseableHttpClient"></a>CloseableHttpClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">KeyStore trustStore  = KeyStore.getInstance(KeyStore.getDefaultType());  </span><br><span class="line"><span class="comment">//加载证书文件  </span></span><br><span class="line">FileInputStream instream = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(<span class="string">"/home/victor/my.store"</span>));  </span><br><span class="line"><span class="keyword">try</span> &#123;  </span><br><span class="line">   trustStore.load(instream, <span class="string">"mypassword"</span>.toCharArray());  </span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">   instream.close();  </span><br><span class="line">&#125;  </span><br><span class="line">SSLContext sslcontext = SSLContexts.custom().loadTrustMaterial(trustStore).build();  </span><br><span class="line">SSLConnectionSocketFactory sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(sslcontext,  </span><br><span class="line">       SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);  </span><br><span class="line">CloseableHttpClient httpclient = HttpClients.custom()  </span><br><span class="line">       .setSSLSocketFactory(sslsf)  </span><br><span class="line">       .build();</span><br></pre></td></tr></table></figure><p>参考：<a href="http://blog.csdn.net/wanglha/article/details/51140846">http://blog.csdn.net/wanglha/article/details/51140846</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows查看某个端口被谁占用</title>
      <link href="/2018/03/22/windows-find-who-bind-a-port/"/>
      <url>/2018/03/22/windows-find-who-bind-a-port/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="https://jingyan.baidu.com/article/3c48dd34491d47e10be358b8.html">https://jingyan.baidu.com/article/3c48dd34491d47e10be358b8.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一位10年Java工作经验的架构师聊Java和工作经验</title>
      <link href="/2018/03/22/an-architect-with-10years-experience-talk-about-java-and-experience/"/>
      <url>/2018/03/22/an-architect-with-10years-experience-talk-about-java-and-experience/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="http://blog.csdn.net/lifuxiangcaohui/article/details/48342315">http://blog.csdn.net/lifuxiangcaohui/article/details/48342315</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 架构设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>抓取WebSocket推送的消息</title>
      <link href="/2018/03/21/grab-websocket-push-messages/"/>
      <url>/2018/03/21/grab-websocket-push-messages/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>很多直播或对数据及时性要求比较高的网站，使用了WebSocket。这种数据要怎么抓呢？</p><p>我们这里以socket.io为例，我们可以查看网站网页源代码看使用的H5的WebSocket还是socket.io等JS库。</p><p>这里以java语言为例说明。假定网站使用的是socket.io库来实现消息推送。我们如何通过java来获取服务端推送的信息呢？</p><p>socket.io提供了java的客户端实现socket.io-client。所以获取服务端推送的数据，本质是作为一个客户端连接上WebSocket server。<br><a id="more"></a></p><h2 id="连接websocket-server接收推送的数据"><a href="#连接websocket-server接收推送的数据" class="headerlink" title="连接websocket server接收推送的数据"></a>连接websocket server接收推送的数据</h2><h3 id="首先添加依赖"><a href="#首先添加依赖" class="headerlink" title="首先添加依赖"></a>首先添加依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.socket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>socket.io-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="ws地址的java代码"><a href="#ws地址的java代码" class="headerlink" title="ws地址的java代码"></a>ws地址的java代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Socket socket = IO.socket(<span class="string">"http://localhost:9098/"</span>);</span><br><span class="line">socket.on(Socket.EVENT_CONNECTING, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... objects)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"WebSocket连接中"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).on(Socket.EVENT_CONNECT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... objects)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"WebSocket连接成功！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).on(<span class="string">"OnMSG"</span>, <span class="keyword">new</span> Emitter.Listener() &#123; <span class="comment">// 这里指定要接收的事件名称</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... objects)</span> </span>&#123;</span><br><span class="line">            JSONObject object = (JSONObject) objects[<span class="number">0</span>];</span><br><span class="line">            System.out.println(<span class="string">"OnMSG:\n"</span>+object.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).on(Socket.EVENT_DISCONNECT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... objects)</span> </span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"WebSocket连接关闭！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="comment">// 连接websocket server</span></span><br><span class="line">socket.connect();</span><br><span class="line"><span class="comment">// 休眠3S后发送一条信息给websocket server</span></span><br><span class="line">Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line"><span class="keyword">if</span> (socket.connected()) &#123;</span><br><span class="line">    JSONObject msg = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    msg.put(<span class="string">"from"</span>,<span class="string">"jack"</span>);</span><br><span class="line">    msg.put(<span class="string">"to"</span>,<span class="string">"admin"</span>);</span><br><span class="line">    msg.put(<span class="string">"content"</span>,<span class="string">"Hello,I am jack!"</span>);</span><br><span class="line">    socket.emit(<span class="string">"OnMSG"</span>, msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果websocket地址是ws://localhost:9098，则在socket.io-java中地址写<a href="http://localhost:9098">http://localhost:9098</a>；如果是wss://localhost:9098，则写为<a href="https://localhost:9098">https://localhost:9098</a>.</p><p>服务端的例子参考：<a href="http://tommy88.top/2018/03/08/socketio%E6%8E%A8%E9%80%81%E6%8A%80%E6%9C%AF/">socketio推送技术</a>。</p><h3 id="wss地址的java代码"><a href="#wss地址的java代码" class="headerlink" title="wss地址的java代码"></a>wss地址的java代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HostnameVerifier <span class="title">getMyHostnameVerifier</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HostnameVerifier() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String s, SSLSession sslSession)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> X509TrustManager <span class="title">getTrustManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> X509TrustManager() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> java.security.cert.X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> java.security.cert.X509Certificate[] &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] certs, String authType)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] certs, String authType)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> SSLContext <span class="title">createSSLContext</span><span class="params">(X509TrustManager trustManager)</span> <span class="keyword">throws</span> GeneralSecurityException, IOException </span>&#123;</span><br><span class="line"><span class="comment">//        Security.insertProviderAt(new BouncyCastleProvider(), 1);</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TrustManager[] trustAllCerts = <span class="keyword">new</span> TrustManager[]&#123;trustManager&#125;;</span><br><span class="line">        <span class="comment">// Install the all-trusting trust manager</span></span><br><span class="line">        SSLContext sc = SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">        sc.init(<span class="keyword">null</span>, trustAllCerts, <span class="keyword">new</span> java.security.SecureRandom());</span><br><span class="line">        <span class="keyword">return</span> sc;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line">        exception.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">X509TrustManager trustManager = getTrustManager();</span><br><span class="line">SSLContext sslContext = createSSLContext(trustManager);</span><br><span class="line">HostnameVerifier myHostnameVerifier = getMyHostnameVerifier();</span><br><span class="line">OkHttpClient okHttpClient = <span class="keyword">new</span> OkHttpClient.Builder()</span><br><span class="line">        .hostnameVerifier(myHostnameVerifier)</span><br><span class="line">        .sslSocketFactory(sslContext.getSocketFactory(), trustManager)</span><br><span class="line">        .build();</span><br><span class="line"><span class="comment">// default settings for all sockets</span></span><br><span class="line">IO.setDefaultOkHttpWebSocketFactory(okHttpClient);</span><br><span class="line">IO.setDefaultOkHttpCallFactory(okHttpClient);</span><br><span class="line"><span class="comment">// set as an option</span></span><br><span class="line">IO.Options opts = <span class="keyword">new</span> IO.Options();</span><br><span class="line">opts.callFactory = okHttpClient;</span><br><span class="line">opts.webSocketFactory = okHttpClient;</span><br><span class="line">opts.port = <span class="number">443</span>;</span><br><span class="line">opts.secure = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">final</span> Socket socket = IO.socket(<span class="string">"http://localhost:9098/"</span>, opts);</span><br><span class="line">...</span><br><span class="line">其他部分的代码参考ws部分</span><br></pre></td></tr></table></figure><p>在浏览器中，在websocket请求的Frames部分是发送和接收到消息。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-21/2140342.jpg" alt=""><br>向上箭头（绿色）表示向websocket server发送的消息，向下箭头（红色）表示接收的消息。</p><h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>有些网站可能对url上加了token或其他参数验证，防止不可靠的连接，一般比如会员登录后，生成token并发起websocket连接。这就需要自己处理token。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推送技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HashMap的实现原理</title>
      <link href="/2018/03/20/HashMap-realization-principle/"/>
      <url>/2018/03/20/HashMap-realization-principle/</url>
      
        <content type="html"><![CDATA[<p>在java中，HashMap是一种重要的数据结构，它的底层实际上是一个数组，数组的每个元素是一个链表。</p><p>在添加元素的时候，会根据hash函数计算出在数组中的下标。如果数组中该下标有元素存在，则将当前元素覆盖之前的元素；之前的元素则放到当前元素的下一个元素。如果数组中该位置没有元素，则直接放到该位置。</p><p>元素个数默认是16，加载因子是0.75，当元素的个数达到数组容量*加载因子时，会进行扩容（容量增加一倍）。</p><p>在构造HashMap时，会进行容量的计算，以及数组的初始化。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认数组容量</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// 默认加载因子</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"><span class="comment">// 保存数据的数组</span></span><br><span class="line"><span class="keyword">transient</span> Entry[] table;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>HashMap的构造方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 参数检查</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal initial capacity: "</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal load factor: "</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="comment">// Find a power of 2 &gt;= initialCapacity</span></span><br><span class="line">    <span class="comment">// 找出一个&gt;=指定容量的数，该数必须是2的N次方。比如指定的容量是10，则最终capacity=16</span></span><br><span class="line">    <span class="keyword">int</span> capacity = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (capacity &lt; initialCapacity)</span><br><span class="line">        capacity &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="comment">// 数组进行扩容的阀值</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>)(capacity * loadFactor);</span><br><span class="line">    table = <span class="keyword">new</span> Entry[capacity];</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 使用指定的容量和默认加载因子构造HashMap</span></span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不指定参数，则使用默认的容量和加载因子构造HashMap</span></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)(DEFAULT_INITIAL_CAPACITY * DEFAULT_LOAD_FACTOR);</span><br><span class="line">    table = <span class="keyword">new</span> Entry[DEFAULT_INITIAL_CAPACITY];</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>HashMap的hash函数：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>一个好的hash函数，应该最大限度的保证key与value一一对应，即保证数组的每个位置上都只有一个元素，不用再去遍历链表，这样查找和添加的速度都是最快的。</p><p>计算元素在数组中的索引：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注意：h是上面经过对key经过hash之后的值。</p><p>看下HashMap的put方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，HashMap支持null作为key。<br>看下putForNullKey的处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> V <span class="title">putForNullKey</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[<span class="number">0</span>]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e.key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(<span class="number">0</span>, <span class="keyword">null</span>, value, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>key=null的元素放在数组的首位，替换key=null的元素的value，返回原来的value。</p><p>如果key不是null，首先通过hash函数计算key的hash值，然后通过indexFor计算在数组中的下标。<br>然后遍历计算的数组下标的元素的链表，如果存在key=传入的key的元素，则覆盖原来的value，并返回原来的value。</p><p>如果在计算的数组索引位置的链表结构上没有找到key为传入key的元素，则执行addEntry方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在addEntry中，首先拿到通过hash函数计算到的数组相应index的元素，然后构造一个新的Entry对象，放到数组的index位置。<br>如果数组元素的个数达到阀值（即数组容量*负载因子），则将数组容量扩容2倍。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">resize</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>&#123;</span><br><span class="line">    Entry[] oldTable = table;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = oldTable.length;</span><br><span class="line">    <span class="keyword">if</span> (oldCapacity == MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Entry[] newTable = <span class="keyword">new</span> Entry[newCapacity];</span><br><span class="line">    transfer(newTable);</span><br><span class="line">    table = newTable;</span><br><span class="line">    threshold = (<span class="keyword">int</span>)(newCapacity * loadFactor);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Entry[] newTable)</span> </span>&#123;</span><br><span class="line">    Entry[] src = table;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = newTable.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; src.length; j++) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; e = src[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            src[j] = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">                <span class="keyword">int</span> i = indexFor(e.hash, newCapacity);</span><br><span class="line">                e.next = newTable[i];</span><br><span class="line">                newTable[i] = e;</span><br><span class="line">                e = next;</span><br><span class="line">            &#125; <span class="keyword">while</span> (e != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>主要看transfer方法，遍历原数组的每个元素，如果某个位置有元素，则遍历该链表结构上的所有元素，重新计算在数组的下标，并放到新数组中。</p><p>get方法更put类似，先通过hash函数对key进行hash，然后通过indexFor得到在数组的位置。然后遍历数组中该位置的链表上的所有元素，找出key为传入的key的元素，返回。</p><p>HashMap其中有些设计很精妙，比如数组的容量为何是2的N次方？hash函数和indexFor函数。<br>详细可以参考：<a href="http://www.importnew.com/16301.html">HashMap的实现原理</a></p><p>下来来一个简易版的HashMap实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">V <span class="title">put</span><span class="params">(K k, V v)</span></span>;</span><br><span class="line">    <span class="function">V <span class="title">get</span><span class="params">(K k)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHashMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">MyMap</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// 计算当前数组元素的个数，hash计算后index相同的元素只作为一个计算。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">// 默认负载因子</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">double</span> defaultLoader = <span class="number">0.75</span>;</span><br><span class="line">    <span class="comment">// 默认容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> defaultCapacity = <span class="number">16</span>;</span><br><span class="line">    <span class="comment">// 实际使用的加载因子</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> loader;</span><br><span class="line">    <span class="comment">// 实际的数组容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capacity = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 保存Map元素的数组</span></span><br><span class="line">    <span class="keyword">private</span> Entry&lt;K, V&gt;[] table = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHashMap</span><span class="params">(<span class="keyword">int</span> capacity, <span class="keyword">double</span> loader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loader = loader;</span><br><span class="line">    <span class="comment">// 找出一个刚好大于给定元素个数的数作为数组的容量</span></span><br><span class="line">    <span class="comment">// 比如指定capactiy为10，则实际容量是16.</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">this</span>.capacity &lt; capacity) &#123;</span><br><span class="line">    <span class="keyword">this</span>.capacity = <span class="keyword">this</span>.capacity &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">"capacity is :"</span> + <span class="keyword">this</span>.capacity);</span><br><span class="line">    table = <span class="keyword">new</span> Entry[<span class="keyword">this</span>.capacity];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHashMap</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(capacity,defaultLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 不指定容量和加载因子，则使用默认的</span></span><br><span class="line">    <span class="keyword">this</span>(defaultCapacity, defaultLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K k, V v)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当元素的个数达到数组的容量*负载因子时，进行扩容。</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; <span class="keyword">this</span>.capacity * <span class="keyword">this</span>.loader) &#123;</span><br><span class="line">    expand();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据hash函数计算K在数组中的下标</span></span><br><span class="line">    <span class="keyword">int</span> index = getIndex(k);</span><br><span class="line">    <span class="comment">// 计算出的数组下标的元素</span></span><br><span class="line">    Entry&lt;K, V&gt; entry = table[index];</span><br><span class="line">    <span class="comment">// entry为null，说明当前数组index位置还没有元素</span></span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">    entry = <span class="keyword">new</span> Entry(k, v, <span class="keyword">null</span>);</span><br><span class="line">    table[index] = entry;</span><br><span class="line">    <span class="comment">// 添加元素后，size计数器加1</span></span><br><span class="line">    size++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 说明，数组index位置已经有元素</span></span><br><span class="line">    <span class="comment">// 将原来index位置的元素作为新元素的next，即新元素覆盖老元素，老元素作为新元素的下一个元素。</span></span><br><span class="line">    Entry&lt;K,V&gt; newEntry = <span class="keyword">new</span> Entry(k, v, entry);</span><br><span class="line">    <span class="comment">// 新元素覆盖老元素的位置。</span></span><br><span class="line">    table[index] = newEntry;</span><br><span class="line">    <span class="comment">// 注意这里，size并不会增加，因为该位置原来有元素，新的元素只是增加到链表上而已。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里返回的是新元素的value，即返回的是要put的元素</span></span><br><span class="line">    <span class="keyword">return</span> table[index].getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(K k)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据hash函数计算K在数组中的下标</span></span><br><span class="line">    <span class="keyword">int</span> index = getIndex(k);</span><br><span class="line">    <span class="comment">// 如果下标超出当前记录的数组的index，或者数组该位置没有元素，直接返回null。</span></span><br><span class="line">    <span class="keyword">if</span> (table[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算的数组index位置的元素</span></span><br><span class="line">    Entry&lt;K, V&gt; entry = table[index];</span><br><span class="line">    <span class="comment">// 上面已经处理了entry为null的情况，这里next为null，说明数组index位置只有一个元素，直接返回</span></span><br><span class="line">    <span class="keyword">if</span> (entry.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> entry.getValue();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 链表上所有元素在数组的下标一样，但key不一样。这里需要遍历所有链表上的元素确定是哪个元素</span></span><br><span class="line">    <span class="keyword">while</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Entry&lt;K, V&gt; oldEntry = entry;</span><br><span class="line">    entry = entry.next;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (oldEntry.getKey() == k || k.equals(oldEntry.getKey())) &#123;</span><br><span class="line">    <span class="keyword">return</span> oldEntry.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算Key在数组的下标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(K k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index = k.hashCode() % <span class="keyword">this</span>.capacity;</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> ? index : -index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扩容方法。将数组容量扩大一倍。原来的数据重新计算在数组的位置。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.capacity = <span class="keyword">this</span>.capacity * <span class="number">2</span>;</span><br><span class="line">    Entry&lt;K, V&gt;[] newTable = <span class="keyword">new</span> Entry[<span class="keyword">this</span>.capacity];</span><br><span class="line">    List&lt;Entry&lt;K, V&gt;&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.table.length; i++) &#123;</span><br><span class="line">    <span class="comment">// 数组的某个位置元素为空不处理。</span></span><br><span class="line">    <span class="keyword">if</span> (table[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Entry&lt;K, V&gt; entry = table[i];</span><br><span class="line">    <span class="comment">// 当前数组位置只有一个元素，链表上没有其他数据</span></span><br><span class="line">    <span class="keyword">if</span> (entry.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">    list.add(entry);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 添加链表上所有的元素</span></span><br><span class="line">    <span class="keyword">while</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Entry&lt;K, V&gt; oldEntry = entry;</span><br><span class="line">    entry = entry.next;</span><br><span class="line">    <span class="comment">// 这里将当前元素的下一个元素设置为null，重新计算next。</span></span><br><span class="line">    oldEntry.next = <span class="keyword">null</span>;</span><br><span class="line">    list.add(oldEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重新计算元素在数组的index</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    Entry&lt;K, V&gt; entry = list.get(i);</span><br><span class="line">    <span class="keyword">this</span>.put(entry.getKey(), entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.table = newTable;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 链表结构，存储数组的元素key,value和下一个元素</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;K&gt;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;V&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// key</span></span><br><span class="line">    K k;</span><br><span class="line">    <span class="comment">// value</span></span><br><span class="line">    V v;</span><br><span class="line">    <span class="comment">// 下一个元素，即通过hash函数计算出index相同的元素</span></span><br><span class="line">    Entry&lt;K, V&gt; next;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Entry</span><span class="params">(K k, V v, Entry&lt;K, V&gt; next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.k = k;</span><br><span class="line">    <span class="keyword">this</span>.v = v;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> K <span class="title">getKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Long t1 = System.currentTimeMillis();</span><br><span class="line">    MyMap&lt;String, String&gt; myMap = <span class="keyword">new</span> MyHashMap&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    myMap.put(<span class="string">"key"</span> + i, <span class="string">"value"</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    System.out.println(<span class="string">"key"</span> + i + <span class="string">"  value:"</span> + myMap.get(<span class="string">"key"</span> + i));</span><br><span class="line">    &#125;</span><br><span class="line">    Long t2 = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"自己写的HashMap耗时："</span> + (t2-t1));</span><br><span class="line">    System.out.println(<span class="string">"======================HashMap=========================="</span>);</span><br><span class="line">    Long t3 = System.currentTimeMillis();</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    map.put(<span class="string">"key"</span> + i, <span class="string">"value"</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    System.out.println(<span class="string">"key"</span> + i + <span class="string">"  value:"</span> + map.get(<span class="string">"key"</span> + i));</span><br><span class="line">    &#125;</span><br><span class="line">    Long t4 = System.currentTimeMillis();</span><br><span class="line">    System.out.println(<span class="string">"JDK的HashMap耗时："</span> + (t4-t3));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java多线程之wait、notify、notifyAll</title>
      <link href="/2018/03/17/java-multi-thread-wait_notify_notifyAll/"/>
      <url>/2018/03/17/java-multi-thread-wait_notify_notifyAll/</url>
      
        <content type="html"><![CDATA[<p>在java中，线程间通信可以使用wait、notify、notifyAll来进行控制。注意：这3个方法是Object的方法。</p><p>在调用一个对象的wait、notify、notifyAll方法时，必须持有该对象的锁。否则会报下面的错误：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;Thread-1&quot; java.lang.IllegalMonitorStateException</span><br><span class="line">at java.lang.Object.notify(Native Method)</span><br><span class="line">at com.tommy.core.test.threadtest.SubThread.run(Test1.java:58)</span><br></pre></td></tr></table></figure></p><p>多个线程都持有同一个对象的时候，如果都要进入synchronized(obj){……}的内部，就必须拿到这个对象的锁，synchronized的机制保证了同一时间最多只能有1个线程拿到了对象的锁.<br><a id="more"></a><br>wait：线程自动释放其占有的对象锁，并等待notify<br>notify：唤醒一个正在wait当前对象锁的线程，并让它拿到对象锁<br>notifyAll：唤醒所有正在wait前对象锁的线程</p><p>notify和notifyAll的最主要的区别是：notify只是唤醒一个正在wait当前对象锁的线程，而notifyAll唤醒所有。值得注意的是：notify是本地方法，具体唤醒哪一个线程由虚拟机控制；notifyAll后并不是所有的线程都能马上往下执行，它们只是跳出了wait状态，接下来它们还会是竞争对象锁。</p><p>永远在循环（loop）里调用 wait 和 notify，不是在 If 语句。<br>原因参考：<a href="http://www.importnew.com/16453.html">如何在 Java 中正确使用 wait, notify 和 notifyAll – 以生产者消费者模型为例</a></p><p>下面通过一个IBM的多线程面试题来说明。<br>实现的功能是：主线程和子线程一次执行1次，共执行10次。</p><p>共享资源对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">R</span> </span>&#123;</span><br><span class="line">    <span class="comment">// true：主线程运行标志；false：子线程运行标志。</span></span><br><span class="line">    <span class="keyword">boolean</span> masterRunFlag = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>主线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MasterThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> R r;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MasterThread</span><span class="params">(R r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.r = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">while</span> (!r.masterRunFlag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"主线程等待执行.flag="</span>+r.masterRunFlag);</span><br><span class="line">                        r.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                r.masterRunFlag = <span class="keyword">false</span>;</span><br><span class="line">                System.out.println(<span class="string">"主线程第"</span> + (i + <span class="number">1</span>) + <span class="string">"次执行。flag="</span>+r.masterRunFlag);</span><br><span class="line">                i++;</span><br><span class="line">                r.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"主线程执行完毕。。。。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>子线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> R r;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubThread</span><span class="params">(R r)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.r = r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line">                <span class="keyword">while</span> (r.masterRunFlag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"子线程等待执行。flag="</span>+r.masterRunFlag);</span><br><span class="line">                        r.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                r.masterRunFlag = <span class="keyword">true</span>;</span><br><span class="line">                System.out.println(<span class="string">"子线程第"</span> + (i + <span class="number">1</span>) + <span class="string">"次执行完毕。flag="</span>+r.masterRunFlag);</span><br><span class="line">                i++;</span><br><span class="line">                r.notify();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"子线程执行完毕。。。。"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        MasterThread mt = <span class="keyword">new</span> MasterThread(r);</span><br><span class="line">        SubThread st = <span class="keyword">new</span> SubThread(r);</span><br><span class="line">        mt.start();</span><br><span class="line">        st.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>执行结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">主线程第<span class="number">1</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">1</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">2</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">2</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">3</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">3</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">4</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">4</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">5</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">5</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">6</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">6</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">7</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">7</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">8</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">8</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">9</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程等待执行.flag=<span class="keyword">false</span></span><br><span class="line">子线程第<span class="number">9</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程等待执行。flag=<span class="keyword">true</span></span><br><span class="line">主线程第<span class="number">10</span>次执行。flag=<span class="keyword">false</span></span><br><span class="line">主线程执行完毕。。。。</span><br><span class="line">子线程第<span class="number">10</span>次执行完毕。flag=<span class="keyword">true</span></span><br><span class="line">子线程执行完毕。。。。</span><br></pre></td></tr></table></figure></p><p>注意：主线程（生产者）和子线程（消费者）的执行次数必须相同。因为主线程和子线程的执行都依赖对方改变masterRunFlag的状态。<br>所以这里主线程执行10次，子线程也必须执行10次。</p><p>生产者、消费者模型，可以参考：<a href="https://www.jianshu.com/p/f7d4819b7b24">https://www.jianshu.com/p/f7d4819b7b24</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nginx安装与配置</title>
      <link href="/2018/03/15/nginx-install-and-configuration/"/>
      <url>/2018/03/15/nginx-install-and-configuration/</url>
      
        <content type="html"><![CDATA[<h2 id="windows上安装Linux虚拟机"><a href="#windows上安装Linux虚拟机" class="headerlink" title="windows上安装Linux虚拟机"></a>windows上安装Linux虚拟机</h2><p>参考：<a href="http://tommy88.top/2018/03/15/vmware%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%AE%89%E8%A3%85/">VMware虚拟机安装</a></p><h2 id="nginx安装"><a href="#nginx安装" class="headerlink" title="nginx安装"></a>nginx安装</h2><p>参考：<a href="http://www.runoob.com/linux/nginx-install-setup.html">http://www.runoob.com/linux/nginx-install-setup.html</a></p><h2 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h2><p>在上面我们将nginx安装在/usr/local/nginx。<br>通过下面的命令启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sbin/nginx</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-3-16/27825533.jpg" alt=""></p><p>启动后，在主机浏览器输入虚拟机的IP测试，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-16/66328916.jpg" alt=""><br>说明测试Ok了。</p><h2 id="nginx负载均衡、多域名配置"><a href="#nginx负载均衡、多域名配置" class="headerlink" title="nginx负载均衡、多域名配置"></a>nginx负载均衡、多域名配置</h2><p>参考：<a href="http://blog.csdn.net/physicsdandan/article/details/45667357">nginx反向代理配置</a></p><h2 id="nginx缓存静态文件"><a href="#nginx缓存静态文件" class="headerlink" title="nginx缓存静态文件"></a>nginx缓存静态文件</h2><p>参考：<a href="https://linux.cn/article-7726-1.html">https://linux.cn/article-7726-1.html</a></p><h2 id="nginx-session共享"><a href="#nginx-session共享" class="headerlink" title="nginx session共享"></a>nginx session共享</h2><p>参考：<a href="https://cloud.tencent.com/developer/article/1041678">https://cloud.tencent.com/developer/article/1041678</a></p><h2 id="隐藏nginx版本号"><a href="#隐藏nginx版本号" class="headerlink" title="隐藏nginx版本号"></a>隐藏nginx版本号</h2><p>参考：<a href="https://www.cnblogs.com/toughlife/p/5475180.html">https://www.cnblogs.com/toughlife/p/5475180.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VMware虚拟机安装</title>
      <link href="/2018/03/15/vmware-install/"/>
      <url>/2018/03/15/vmware-install/</url>
      
        <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>VMWare14和CentOS系统镜像文件。</p><h2 id="安装VMWare"><a href="#安装VMWare" class="headerlink" title="安装VMWare"></a>安装VMWare</h2><p>一路next直到完成，可能花费时间较长。</p><h2 id="安装虚拟机"><a href="#安装虚拟机" class="headerlink" title="安装虚拟机"></a>安装虚拟机</h2><p>1.选择“文件”-&gt;”新建虚拟机“-&gt;“典型”-&gt;“稍后安装操作系统”-&gt;”Linux“-&gt;”CentOS 6 64位“（这里根据你准备的CentOS版本选择）-&gt;虚拟机的名字（随便填）-&gt;最大磁盘大小（就默认20G即可）-&gt;”完成“。</p><p>2,选择左侧的虚拟机，右键“设置”，设置内存为2G，CD/DVD选择你的镜像文件，最后点完成。<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-15/86003350.jpg" alt=""></p><p>3.点击左侧的虚拟机，然后在右边点“开启此虚拟机”进行系统安装。在出现的操作选择的页面中，选择第一个Install or update…（用方向键选择），然后用TAB确定，最后按Enter。第一步Media Check,这个根据需要安装，我们这里就不管了，直接忽略。后面基本一路next，最后设置密码，然后安装完毕后，要重启才能生效。</p><h2 id="为虚拟机分配静态IP"><a href="#为虚拟机分配静态IP" class="headerlink" title="为虚拟机分配静态IP"></a>为虚拟机分配静态IP</h2><p>参考：<a href="http://blog.csdn.net/xiaoyangsavvy/article/details/73718473">http://blog.csdn.net/xiaoyangsavvy/article/details/73718473</a></p><h2 id="使用远程工具连接虚拟机"><a href="#使用远程工具连接虚拟机" class="headerlink" title="使用远程工具连接虚拟机"></a>使用远程工具连接虚拟机</h2><p>参考：<a href="http://blog.csdn.net/xiaoyangsavvy/article/details/73718473">http://blog.csdn.net/xiaoyangsavvy/article/details/73718473</a></p><p>问题：xshell无法连接虚拟机<br>昨天安装虚拟机后，可以使用xshell连接虚拟机，今天就不能访问了。在主机中ping虚拟机的IP提示“TTL 传输中过期”，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-16/18948330.jpg" alt=""></p><p>百度了一通没用，但可以 参考一下：<a href="https://zhangge.net/4177.html">解决ping域名时出现“TTL传输中过期”的问题</a></p><p>最后增加了一个端口转发成功。将主机的2222映射到虚拟机的22端口。<br>参考：<a href="http://blog.csdn.net/feinifi/article/details/76066594">远程连接win7上VMWare安装的linux虚拟机</a>、<a href="https://www.cnblogs.com/youxin/p/3931327.html">windows下使用远程工具登录虚拟机上的Linux、访问虚拟机上的服务 、端口转发、win7 telnet登陆虚拟机</a></p><p>===========================================<br>解决：<br>启动虚拟机前，确保网络适配器是NAT，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-16/33288412.jpg" alt=""></p><p>确保下面的參数例如以下设置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ONBOOT=yes</span><br><span class="line">NM_CONTROLLED=yes</span><br></pre></td></tr></table></figure></p><p>增加了下面的设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DNS1=192.168.84.2</span><br><span class="line">IPV6INIT=no</span><br><span class="line">ARPCHECK=no</span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://www.cnblogs.com/gavanwanggw/p/6960996.html">https://www.cnblogs.com/gavanwanggw/p/6960996.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>chrome浏览器必装插件</title>
      <link href="/2018/03/15/chrome-browser-plugins/"/>
      <url>/2018/03/15/chrome-browser-plugins/</url>
      
        <content type="html"><![CDATA[<h2 id="crxMouse"><a href="#crxMouse" class="headerlink" title="crxMouse"></a>crxMouse</h2><p>鼠标手势插件。</p><p>可以实现浏览器的后退、前进、向上滚动、向下滚动、关闭标签页、重新打开关闭的标签页、到底部、到顶部、刷新页面、强制刷新、到左侧标签页、到右侧标签页、新建窗口、关闭窗口、进入扩展设置页。</p><h2 id="IDM-Integration-Module"><a href="#IDM-Integration-Module" class="headerlink" title="IDM Integration Module"></a>IDM Integration Module</h2><p>浏览器默认下载工具或迅雷的替代工具。IDM使用多线程下载，可以提升你的下载速度最多5倍。并且可以监视网页视频和音频。</p><p>下载IDM的绿色版，在“选项”中将chrome浏览器加入到监视，chrome浏览器打开提示集成IDM，集成后即可替换浏览器的默认下载。后续用浏览器下载文件时会自动使用IDM下载。<br><a id="more"></a></p><h2 id="Proxy-SwitchySharp"><a href="#Proxy-SwitchySharp" class="headerlink" title="Proxy SwitchySharp"></a>Proxy SwitchySharp</h2><p>浏览器代理切换插件</p><h2 id="Tampermonkey"><a href="#Tampermonkey" class="headerlink" title="Tampermonkey"></a>Tampermonkey</h2><p>油猴，是一款免费的浏览器扩展和最为流行的用户脚本管理器。我们可以用它做很多事情，比如百度云下载大文件会要求启动百度云客户端，使用百度云直接下载助手脚本即可直接下载。</p><p>参考：<a href="http://tampermonkey.net/">http://tampermonkey.net/</a><br>油猴脚本：<a href="https://greasyfork.org/zh-CN">https://greasyfork.org/zh-CN</a></p><h2 id="有道词典Chrome划词插件"><a href="#有道词典Chrome划词插件" class="headerlink" title="有道词典Chrome划词插件"></a>有道词典Chrome划词插件</h2><p>不多说，提供了划词翻译、句子翻译功能。</p><h2 id="谷歌访问助手"><a href="#谷歌访问助手" class="headerlink" title="谷歌访问助手"></a>谷歌访问助手</h2><p>访问谷歌、Gmail、youtobe的插件。不是很稳定，如果有条件，自己搭建vpn。</p><h2 id="Advanced-REST-client"><a href="#Advanced-REST-client" class="headerlink" title="Advanced REST client"></a>Advanced REST client</h2><p>http请求测试插件。</p><h2 id="插件安装方法"><a href="#插件安装方法" class="headerlink" title="插件安装方法"></a>插件安装方法</h2><p>如果没法通过Google的在线商店安装，可以先从<a href="http://chromecj.com/">http://chromecj.com/</a>下载，然后进入扩展页，将下载的*.crx拖拽进去安装即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>说说web数据推送技术</title>
      <link href="/2018/03/10/web-datapush-tecnology/"/>
      <url>/2018/03/10/web-datapush-tecnology/</url>
      
        <content type="html"><![CDATA[<h2 id="页面使用定时器，定时向后端请求数据"><a href="#页面使用定时器，定时向后端请求数据" class="headerlink" title="页面使用定时器，定时向后端请求数据"></a>页面使用定时器，定时向后端请求数据</h2><h2 id="页面使用定时器，定时检查资源是否有更新"><a href="#页面使用定时器，定时检查资源是否有更新" class="headerlink" title="页面使用定时器，定时检查资源是否有更新"></a>页面使用定时器，定时检查资源是否有更新</h2><p>在检查到资源有更新时，触发一次Ajax请求，从后端获取数据。</p><h2 id="后端将变化的数据写入文件，页面定时请求"><a href="#后端将变化的数据写入文件，页面定时请求" class="headerlink" title="后端将变化的数据写入文件，页面定时请求"></a>后端将变化的数据写入文件，页面定时请求</h2><h2 id="comet"><a href="#comet" class="headerlink" title="comet"></a>comet</h2><p>利用Ajax与服务器建立http长连接查询是否有数据更新，服务器收到一个连接如果没有数据更新就阻塞这个连接不要返回给客户端，直到有新数据再返回给客户端。Web客户端，发起的连接一旦被返回，或者超时就再次建立http长连接。这样就能保证数据的即时更新，以及尽量减少服务器的计算工作。</p><h2 id="websocket"><a href="#websocket" class="headerlink" title="websocket"></a>websocket</h2><p>WebSocketAPI是下一代客户端-服务器的异步通信方法。该通信取代了单个的TCP套接字，使用ws或wss协议，可用于任意的客户端和服务器程序。</p><h2 id="socket-io"><a href="#socket-io" class="headerlink" title="socket.io"></a>socket.io</h2><p>Socket.IO使用检测功能来判断是否建立WebSocket连接，或者是AJAXlong-polling连接，或Flash等。可快速创建实时的应用程序。</p><p>参考：<a href="http://blog.csdn.net/yi412/article/details/45847283">基于web的服务器push技术：comet vs websocket</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推送技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot jsp支持</title>
      <link href="/2018/03/09/springboot-jsp-support/"/>
      <url>/2018/03/09/springboot-jsp-support/</url>
      
        <content type="html"><![CDATA[<p>springboot不推荐使用jsp,默认使用的是Thymeleaf模板。不过，如果你一定要使用jsp，需要做一些配置。<br><a id="more"></a></p><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.springboot.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsp-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>jsp-demo Maven Webapp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">springboot.version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">springboot.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置servlet--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置jsp jstl的支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--对jsp的支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="application-properties"><a href="#application-properties" class="headerlink" title="application.properties"></a>application.properties</h2><p>指定jsp文件的位置在/WEB-INF/jsp/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.mvc.view.prefix=/WEB-INF/jsp/</span><br><span class="line">spring.mvc.view.suffix=.jsp</span><br></pre></td></tr></table></figure></p><h2 id="应用启动类"><a href="#应用启动类" class="headerlink" title="应用启动类"></a>应用启动类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试controller"><a href="#测试controller" class="headerlink" title="测试controller"></a>测试controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">""</span>,<span class="string">"/test"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">index</span><span class="params">(ModelAndView mv)</span> </span>&#123;</span><br><span class="line">        mv.setViewName(<span class="string">"/test"</span>);</span><br><span class="line">        mv.addObject(<span class="string">"msg"</span>,<span class="string">"你好，世界！"</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试页面"><a href="#测试页面" class="headerlink" title="测试页面"></a>测试页面</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Test Page&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  $&#123;msg&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="部署测试"><a href="#部署测试" class="headerlink" title="部署测试"></a>部署测试</h2><p>在idea的tomcat中添加该web项目，启动tomcat。<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-9/20561679.jpg" alt=""><br>可以看到，测试成功。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><p>由于jsp的性能比较低，而且对JSP的支持比较麻烦，spring推荐使用Thymeleaf模板，spring的官网即是使用的该模板。所以如无必要尽量还是不要使用JSP了。<br>如果是打jar包运行，把spring-boot-start-tomcat的依赖去掉。</p><h2 id="springboot打jar包运行相关问题"><a href="#springboot打jar包运行相关问题" class="headerlink" title="springboot打jar包运行相关问题"></a>springboot打jar包运行相关问题</h2><p>1.idea多模块项目启动访问JSP404；<br>需要指定工作目录为当前模块<br>Run-&gt;Edit Configurations，将spring-boot启动类的Working Directory指定为$MODULE-WORKING-DIR$。</p><p>2.jar包无法读取配置文件（classpath路径）；<br>可以使用spring的ResourcesLoader<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResourceLoader <span class="title">resourceLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> DefaultResourceLoader();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用流，不要使用File</span></span><br><span class="line">InputStream cc = resourceLoader.getResource(classPathLocation).getInputStream();</span><br></pre></td></tr></table></figure></p><p>3.向资源文件写入数据<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(getClass().getClassLoader().getResource(URLCONFIGFILE).getFile());</span><br></pre></td></tr></table></figure></p><p>4.打成jar包后运行访问页面404<br>a.spring-boot-maven-plugin使用1.4.2版本，并指定启动类<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.hhly.rbnode.Application<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">layout</span>&gt;</span>JAR<span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>b.将webapp下的文件拷贝到/META-INF<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/webapp<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">targetPath</span>&gt;</span>META-INF/resources<span class="tag">&lt;/<span class="name">targetPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">include</span>&gt;</span>**/**<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>参考：<a href="https://blog.csdn.net/u013189824/article/details/80389419">https://blog.csdn.net/u013189824/article/details/80389419</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea springboot项目热更新</title>
      <link href="/2018/03/09/springboot-hot-deploy/"/>
      <url>/2018/03/09/springboot-hot-deploy/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在项目开发过程中，常常会改动页面数据或者修改数据结构，为了显示改动效果，往往需要重启应用查看改变效果。这种开发体验无疑是很差的，Springboot为我们提供了devtools来帮助我们实现热更新。</p><h2 id="使用springboot提供的spring-boot-devtools"><a href="#使用springboot提供的spring-boot-devtools" class="headerlink" title="使用springboot提供的spring-boot-devtools"></a>使用springboot提供的spring-boot-devtools</h2><h3 id="添加devtools依赖"><a href="#添加devtools依赖" class="headerlink" title="添加devtools依赖"></a>添加devtools依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="springboot-maven插件配置"><a href="#springboot-maven插件配置" class="headerlink" title="springboot maven插件配置"></a>springboot maven插件配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span> <span class="comment">&lt;!-- 如果没有该配置，devtools不会生效 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure><!--more--><h3 id="application-properties配置"><a href="#application-properties配置" class="headerlink" title="application.properties配置"></a>application.properties配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#热部署生效</span><br><span class="line">spring.devtools.restart.enabled=true</span><br><span class="line">#设置重启的目录</span><br><span class="line">spring.devtools.restart.additional-paths=src/main/java</span><br><span class="line">#classpath目录下的resources文件夹内容修改不重启</span><br><span class="line">spring.devtools.restart.exclude=src/main/resources</span><br><span class="line"></span><br><span class="line"># 禁用缓存（开发阶段）</span><br><span class="line">spring.thymeleaf.cache=false</span><br></pre></td></tr></table></figure><h3 id="打开idea的自动make功能"><a href="#打开idea的自动make功能" class="headerlink" title="打开idea的自动make功能"></a>打开idea的自动make功能</h3><p><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwrlan6urij20z10isq6a.jpg" alt=""></p><h3 id="查找Registry-–-gt-找到并勾选compiler-automake-allow-when-app-running"><a href="#查找Registry-–-gt-找到并勾选compiler-automake-allow-when-app-running" class="headerlink" title="查找Registry –&gt; 找到并勾选compiler.automake.allow.when.app.running"></a>查找Registry –&gt; 找到并勾选compiler.automake.allow.when.app.running</h3><blockquote><p>网上都是快捷键CTRL + SHIFT + A，如果不生效，在keymap中搜索registry，然后设置快捷键即可。<br><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwrlb2qsrnj20z10isgnj.jpg" alt=""></p></blockquote><p><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwrlbcnqvyj20wm0jjdir.jpg" alt=""></p><h3 id="页面修改自动加载"><a href="#页面修改自动加载" class="headerlink" title="页面修改自动加载"></a>页面修改自动加载</h3><p>在application.properties中禁用了缓存后，在浏览器禁用缓存。<br><img src="https://ws1.sinaimg.cn/large/a561df8cgy1fwrl912xp3j20jm03n3yq.jpg" alt=""></p><p>页面有修改就会自动加载。</p><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>直接运行springboot主类即可。</p><p>class只要有变动就会重启，springboot实现了自己的类加载器，该加载器加载自己写的类，另外一个加载器加载第三方的依赖。重启的时候只重启自己写的类，所以速度很快。</p><h3 id="通过-trigger文件来触发更新"><a href="#通过-trigger文件来触发更新" class="headerlink" title="通过.trigger文件来触发更新"></a>通过.trigger文件来触发更新</h3><p>上面的配置，只要文件有修改就会触发更新。有2个问题：</p><ul><li>如果电脑配置较差，那么就会比较卡顿；</li><li>由于idea是自动保存的，可能你文件还没有修改好，这个时候重启其实是不必要的。</li></ul><p>所以，基于上面的原因，可以通过trigger来触发。</p><p>在application.properties中增加如下配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  devtools:</span><br><span class="line">    restart:</span><br><span class="line">      trigger-file: .trigger</span><br></pre></td></tr></table></figure></p><p>在resources目录下新建META-INF目录，在该目录下创建.trigger文件，文件内容为空。<br>如果要触发更新，就随便修改.trigger文件即可。</p><h2 id="在idea集成的tomcat中运行Springboot"><a href="#在idea集成的tomcat中运行Springboot" class="headerlink" title="在idea集成的tomcat中运行Springboot"></a>在idea集成的tomcat中运行Springboot</h2><h3 id="pom-xml中打包类型修改为war"><a href="#pom-xml中打包类型修改为war" class="headerlink" title="pom.xml中打包类型修改为war"></a>pom.xml中打包类型修改为war</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;packaging&gt;war&lt;/packaging&gt;</span><br></pre></td></tr></table></figure><h3 id="maven添加spring-boot-starter-tomcat依赖"><a href="#maven添加spring-boot-starter-tomcat依赖" class="headerlink" title="maven添加spring-boot-starter-tomcat依赖"></a>maven添加spring-boot-starter-tomcat依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="应用启动类修改"><a href="#应用启动类修改" class="headerlink" title="应用启动类修改"></a>应用启动类修改</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(App.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继承SpringBootServletInitializer，重写configure方法。</p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><p>跟常规的idea的web项目一样即可。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-9/94462064.jpg" alt=""></p><p>后续页面、资源文件、class等修改都跟常规的idea的web项目一样操作即可。这样class只要没有增加类、方法、修改签名等就不用重启tomcat了。</p><blockquote><p>注意：我发现有时候没法触发自动重启，手动触发一下编译即可（idea中快捷键ctrl+F9）。</p></blockquote><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://tengj.top/2017/06/01/springboot10/">常用热部署方式</a></p><p>参考：<a href="https://www.cnblogs.com/winner-0715/p/6666579.html">https://www.cnblogs.com/winner-0715/p/6666579.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>socket.io数据推送</title>
      <link href="/2018/03/08/socketio-push-tecnology/"/>
      <url>/2018/03/08/socketio-push-tecnology/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="https://www.cnblogs.com/wxgblogs/p/6852470.html">基于netty-socketio的web推送服务</a>、<a href="http://blog.csdn.net/sun_t89/article/details/52060946">Spring Boot实战之netty-socketio实现简单聊天室(给指定用户推送消息)</a>、<a href="http://blog.csdn.net/function__/article/details/73089504">socket.io 中文文档</a></p><p>socketio简介<br>Socket.io是一个WebSocket库，包括了客户端的js和服务器端的nodejs，它的目标是构建可以在不同浏览器和移动设备上使用的实时应用。它会自动根据浏览器从WebSocket、AJAX长轮询、Iframe流等等各种方式中选择最佳的方式来实现网络实时应用，非常方便和人性化，而且支持的浏览器最低达IE5.5.<br><a id="more"></a></p><p>socket.io特点<br>实时分析：将数据推送到客户端，这些客户端会被表示为实时计数器，图表或日志客户。<br>实时通信和聊天：只需几行代码便可写成一个Socket.IO的”Hello,World”聊天应用。<br>二进制流传输：从1.0版本开始，Socket.IO支持任何形式的二进制文件传输，例如：图片，视频，音频等。<br>文档合并：允许多个用户同时编辑一个文档，并且能够看到每个用户做出的修改。</p><h2 id="Demo简介"><a href="#Demo简介" class="headerlink" title="Demo简介"></a>Demo简介</h2><p>服务端使用netty-socketio，客户端使用socket.io.js。<br>本例完全来自上面的链接，这里只是测试效果以及做备忘。本例实现的功能是一个用户向另外一个用法发小消息。</p><h2 id="maven中添加依赖"><a href="#maven中添加依赖" class="headerlink" title="maven中添加依赖"></a>maven中添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.corundumstudio.socketio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-socketio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="服务端SocketServer"><a href="#服务端SocketServer" class="headerlink" title="服务端SocketServer"></a>服务端SocketServer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChatServer</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> EventListenner eventListenner;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Configuration config = <span class="keyword">new</span> Configuration();</span><br><span class="line">        config.setPort(<span class="number">9098</span>);</span><br><span class="line">        SocketConfig socketConfig = <span class="keyword">new</span> SocketConfig();</span><br><span class="line">        socketConfig.setReuseAddress(<span class="keyword">true</span>);</span><br><span class="line">        socketConfig.setTcpNoDelay(<span class="keyword">true</span>);</span><br><span class="line">        socketConfig.setSoLinger(<span class="number">0</span>);</span><br><span class="line">        config.setSocketConfig(socketConfig);</span><br><span class="line">        config.setHostname(<span class="string">"localhost"</span>);</span><br><span class="line">        SocketIOServer server = <span class="keyword">new</span> SocketIOServer(config);</span><br><span class="line">        server.addListeners(eventListenner);</span><br><span class="line">        server.start();</span><br><span class="line">        System.out.println(<span class="string">"启动正常"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="缓存类，缓存客户端连接"><a href="#缓存类，缓存客户端连接" class="headerlink" title="缓存类，缓存客户端连接"></a>缓存类，缓存客户端连接</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(<span class="string">"clientCache"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketIOClientCache</span> </span>&#123;</span><br><span class="line">    <span class="comment">//String：EventType类型</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,SocketIOClient&gt; clients=<span class="keyword">new</span> ConcurrentHashMap&lt;String,SocketIOClient&gt;();</span><br><span class="line">    <span class="comment">//用户发送消息添加</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addClient</span><span class="params">(SocketIOClient client,MsgBean msgBean)</span></span>&#123;</span><br><span class="line">        clients.put(msgBean.getFrom(),client);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用户退出时移除</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(MsgBean msgBean)</span> </span>&#123;</span><br><span class="line">        clients.remove(msgBean.getFrom());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取所有</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  SocketIOClient <span class="title">getClient</span><span class="params">(String to)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> clients.get(to);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="消息发送的类"><a href="#消息发送的类" class="headerlink" title="消息发送的类"></a>消息发送的类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"socketIOResponse"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketIOResponse</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendEvent</span><span class="params">(SocketIOClient client, MsgBean bean)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"推送消息"</span>);</span><br><span class="line">        client.sendEvent(<span class="string">"OnMSG"</span>, bean);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件监听器"><a href="#事件监听器" class="headerlink" title="事件监听器"></a>事件监听器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"eventListenner"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventListenner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"clientCache"</span>)</span><br><span class="line">    <span class="keyword">private</span> SocketIOClientCache clientCache;</span><br><span class="line">    <span class="meta">@Resource</span>(name = <span class="string">"socketIOResponse"</span>)</span><br><span class="line">    <span class="keyword">private</span> SocketIOResponse socketIOResponse;</span><br><span class="line">    <span class="meta">@OnConnect</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">       System.out.println(<span class="string">"建立连接"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnEvent</span>(<span class="string">"OnMSG"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">(SocketIOClient client, MsgBean bean)</span> </span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">"收到消息-from: %s to:%s\n"</span>, bean.getFrom(), bean.getTo());</span><br><span class="line">        clientCache.addClient(client, bean);</span><br><span class="line">        SocketIOClient ioClients = clientCache.getClient(bean.getTo());</span><br><span class="line">        System.out.println(<span class="string">"clientCache"</span>);</span><br><span class="line">        <span class="keyword">if</span> (ioClients == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">"你发送消息的用户不在线"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        socketIOResponse.sendEvent(ioClients,bean);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnDisconnect</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"关闭连接"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="消息bean"><a href="#消息bean" class="headerlink" title="消息bean"></a>消息bean</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MsgBean</span> </span>&#123; </span><br><span class="line">    <span class="keyword">private</span> String from;</span><br><span class="line">    <span class="keyword">private</span> String to;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getFrom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> from;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFrom</span><span class="params">(String from)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.from = from;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getTo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> to;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTo</span><span class="params">(String to)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.to = to;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"MsgBean [from="</span> + from + <span class="string">", to="</span> + to + <span class="string">", content="</span> + content + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="页面"><a href="#页面" class="headerlink" title="页面"></a>页面</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>socket.io demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"content-type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=UTF-8"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/js/jquery.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/js/socket.io.min.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        body &#123;</span><br><span class="line">            padding: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#console</span> &#123;</span></span><br><span class="line">            height: 400px;</span><br><span class="line">            overflow: auto;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.username-msg</span> &#123;</span></span><br><span class="line">            color: orange;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.connect-msg</span> &#123;</span></span><br><span class="line">            color: green;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.disconnect-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.send-msg</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#888</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Netty-socketio chat demo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"console"</span> <span class="attr">class</span>=<span class="string">"well"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"well form-inline"</span> <span class="attr">onsubmit</span>=<span class="string">"return false;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"from"</span> <span class="attr">class</span>=<span class="string">"input-xlarge"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"from. . . "</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"to"</span> <span class="attr">class</span>=<span class="string">"input-xlarge"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"to. . . "</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"content"</span> <span class="attr">class</span>=<span class="string">"input-xlarge"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"content. . . "</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"sendMessage()"</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"sendDisconnect()"</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>Disconnect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> socket = io.connect(<span class="string">'http://localhost:9098'</span>);</span></span><br><span class="line"><span class="javascript">    socket.on(<span class="string">'connect'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="xml">        output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"connect-msg"</span>&gt;</span>Client has connected to the server!<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="javascript">    socket.on(<span class="string">'OnMSG'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span></span><br><span class="line"><span class="xml">        output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"username-msg"</span>&gt;</span>' + data.content + ' : <span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="javascript">    socket.on(<span class="string">'disconnect'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="xml">        output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"disconnect-msg"</span>&gt;</span>The client has disconnected! <span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span><br><span class="line">    &#125;);</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">sendDisconnect</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        socket.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> <span class="keyword">from</span> = $(<span class="string">"#from"</span>).val();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> to = $(<span class="string">"#to"</span>).val();</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> content = $(<span class="string">'#content'</span>).val();</span></span><br><span class="line"><span class="javascript">        socket.emit(<span class="string">'OnMSG'</span>, &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">from</span> : <span class="keyword">from</span>,</span></span><br><span class="line">            to : to,</span><br><span class="line">            content : content</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params">message</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(message)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> currentTime = <span class="string">"&lt;span&gt;"</span> + <span class="keyword">new</span> <span class="built_in">Date</span>() + <span class="string">"&lt;/span&gt;"</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> element = $(<span class="string">"&lt;div&gt;"</span> + currentTime + <span class="string">" "</span> + message + <span class="string">"&lt;/div&gt;&lt;br/&gt;"</span>);</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#console'</span>).prepend(element);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>说明:工程基于springboot，关于springboot相关的内容并未给出。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>浏览器2个标签页分页输入地址，进入到聊天页面。<br>标签页1<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-8/38185838.jpg" alt=""></p><p>我们假定标签页1用户为admin，标签页2用户为test。<br>标签页1：admin向test发送1条消息，点击发送，切换到标签页2，发现并没有消息。因为这个时候缓存中没有test，所以没有发送成功。<br>标签页2：test向admin发送1条消息。<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-8/13550640.jpg" alt=""><br>切换到标签页1，可以发现已经接受到test发送的消息<br><img src="http://omh46px9n.bkt.clouddn.com/18-3-8/94183906.jpg" alt=""></p><p>我们F12打开开发人员工具，可以看到多次发送消息并没有产生新的请求。</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.中文乱码<br>尚未找到解决方案。</p><p>netty-socketio:<a href="https://github.com/mrniko/netty-socketio">https://github.com/mrniko/netty-socketio</a><br>netty-socketio-demo:<a href="https://github.com/mrniko/netty-socketio-demo">https://github.com/mrniko/netty-socketio-demo</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推送技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot thymeleaf模板使用</title>
      <link href="/2018/03/08/Springboot+Thymeleaf%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/03/08/Springboot+Thymeleaf%E9%85%8D%E7%BD%AE%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="application-properties添加对thymeleaf的支持"><a href="#application-properties添加对thymeleaf的支持" class="headerlink" title="application.properties添加对thymeleaf的支持"></a>application.properties添加对thymeleaf的支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.thymeleaf.prefix=classpath:/templates/</span><br><span class="line">spring.thymeleaf.suffix=.html</span><br><span class="line">spring.thymeleaf.mode=HTML5</span><br><span class="line">spring.thymeleaf.encoding=UTF-8</span><br><span class="line">spring.thymeleaf.content-type=text/html</span><br><span class="line">spring.thymeleaf.cache=false</span><br><span class="line">spring.resources.chain.strategy.content.enabled=true</span><br><span class="line">spring.resources.chain.strategy.content.paths=/**</span><br></pre></td></tr></table></figure><h2 id="加入相关依赖"><a href="#加入相关依赖" class="headerlink" title="加入相关依赖"></a>加入相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：thymeleaf模板使用的资源文件位于/resources/static，html文件一般则位于/resources/templates/。<br><a id="more"></a></p><h2 id="测试controller"><a href="#测试controller" class="headerlink" title="测试controller"></a>测试controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.setViewName(<span class="string">"test"</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">"your_name"</span>,<span class="string">"World"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="test-html"><a href="#test-html" class="headerlink" title="test.html:"></a>test.html:</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>socket.io demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/js/jquery.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            alert(<span class="string">'page load.'</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello,<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"$&#123;your_name&#125;"</span>&gt;</span>!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><div class="tip"><br>thymeleaf使用HTML5，对文件格式要求严格，比如：&lt;input type=text&gt;会报出下面的错误：<br>org.xml.sax.SAXParseException: 元素类型 “input” 必须由匹配的结束标记 “</input>“ 终止。</p><p>解决方法参考：<a href="https://www.cnblogs.com/memoryXudy/p/7681991.html">spring-boot-starter-thymeleaf 避坑指南</a><br></tip></p><p>thymeleaf用法参考：<a href="https://www.cnblogs.com/ityouknow/p/5833560.html">https://www.cnblogs.com/ityouknow/p/5833560.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot thymeleaf模板使用</title>
      <link href="/2018/03/08/springboot_thymeleaf/"/>
      <url>/2018/03/08/springboot_thymeleaf/</url>
      
        <content type="html"><![CDATA[<h2 id="application-properties添加对thymeleaf的支持"><a href="#application-properties添加对thymeleaf的支持" class="headerlink" title="application.properties添加对thymeleaf的支持"></a>application.properties添加对thymeleaf的支持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.thymeleaf.prefix=classpath:/templates/</span><br><span class="line">spring.thymeleaf.suffix=.html</span><br><span class="line">spring.thymeleaf.mode=HTML5</span><br><span class="line">spring.thymeleaf.encoding=UTF-8</span><br><span class="line">spring.thymeleaf.content-type=text/html</span><br><span class="line">spring.thymeleaf.cache=false</span><br><span class="line">spring.resources.chain.strategy.content.enabled=true</span><br><span class="line">spring.resources.chain.strategy.content.paths=/**</span><br></pre></td></tr></table></figure><h2 id="加入相关依赖"><a href="#加入相关依赖" class="headerlink" title="加入相关依赖"></a>加入相关依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：thymeleaf模板使用的资源文件位于/resources/static，html文件一般则位于/resources/templates/。<br><a id="more"></a></p><h2 id="测试controller"><a href="#测试controller" class="headerlink" title="测试controller"></a>测试controller</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ModelAndView modelAndView = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        modelAndView.setViewName(<span class="string">"test"</span>);</span><br><span class="line">        modelAndView.addObject(<span class="string">"your_name"</span>,<span class="string">"World"</span>);</span><br><span class="line">        <span class="keyword">return</span> modelAndView;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="test-html"><a href="#test-html" class="headerlink" title="test.html:"></a>test.html:</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span> <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>socket.io demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/js/jquery.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="javascript">        $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            alert(<span class="string">'page load.'</span>);</span></span><br><span class="line">        &#125;);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    Hello,<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"$&#123;your_name&#125;"</span>&gt;</span>!<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><div class="tip"><br>thymeleaf使用HTML5，对文件格式要求严格，比如：&lt;input type=text&gt;会报出下面的错误：<br>org.xml.sax.SAXParseException: 元素类型 “input” 必须由匹配的结束标记 “</input>“ 终止。</p><p>解决方法参考：<a href="https://www.cnblogs.com/memoryXudy/p/7681991.html">spring-boot-starter-thymeleaf 避坑指南</a><br></tip></p><p>thymeleaf用法参考：<a href="https://www.cnblogs.com/ityouknow/p/5833560.html">https://www.cnblogs.com/ityouknow/p/5833560.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java日志管理</title>
      <link href="/2018/03/02/java-log-manage/"/>
      <url>/2018/03/02/java-log-manage/</url>
      
        <content type="html"><![CDATA[<h2 id="java常用日志框架简介"><a href="#java常用日志框架简介" class="headerlink" title="java常用日志框架简介"></a>java常用日志框架简介</h2><p>log4j和logback都是java项目中经常使用的日志框架，通常会结合slf4j一起使用。<br>log4j和logback都是具体的日志实现框架，slf4j是一个接口层框架，slf4j-log4j，slf4j-logback则是针对log4j和logback的桥接框架。使用slf4j，就可以随意切换日志框架，而不用修改代码。</p><h2 id="高并发系统日志记录"><a href="#高并发系统日志记录" class="headerlink" title="高并发系统日志记录"></a>高并发系统日志记录</h2><p>多线程环境会由于多个线程同时会向一个日志文件记录日志，所以会导致日志混乱，查找某个线程的日志变的不方便。比如跟踪某个订单号、某个用户的相关日志。<br>我们可以使用slf4j的MDC来解决这个问题。<br><a id="more"></a></p><p>MDC ( Mapped Diagnostic Contexts )，顾名思义，其目的是为了便于我们诊断线上问题而出现的方法工具类。虽然，Slf4j 是用来适配其他的日志具体实现包的，但是针对 MDC功能，目前只有logback以及log4j支持。<br>MDC对外提供的接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MDC</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Put a context value as identified by key</span></span><br><span class="line">  <span class="comment">//into the current thread's context map.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(String key, String val)</span></span>;</span><br><span class="line">  <span class="comment">//Get the context identified by the key parameter.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String key)</span></span>;</span><br><span class="line">  <span class="comment">//Remove the context identified by the key parameter.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(String key)</span></span>;</span><br><span class="line">  <span class="comment">//Clear all entries in the MDC.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>接口定义非常简单，此外，其使用也非常简单。</p><p>一般，我们在代码中，只需要将指定的值put到线程上下文的Map中，然后，在对应的地方使用 get方法获取对应的值。此外，对于一些线程池使用的应用场景，可能我们在最后使用结束时，需要调用clear方法来清洗将要丢弃的数据。</p><p>看看一个MDC使用的简单示例<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MDC.put(<span class="string">"traceNo"</span>,<span class="string">"jd.com"</span>);</span><br><span class="line">logger.info(<span class="string">"method testFindByName in UserServiceTest"</span>);</span><br><span class="line">User user = userService.findByName(<span class="string">"test"</span>);</span><br><span class="line">logger.info(<span class="string">"user:&#123;&#125;"</span>,user);</span><br><span class="line">Assert.assertNotNull(user);</span><br><span class="line">MDC.clear();</span><br></pre></td></tr></table></figure></p><p>logback.xml配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"stdout"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 对日志进行格式化。 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">            %d&#123;yyyy-MM-dd HH:mm:ss&#125; %level %logger.%M\(%F:%L\)] [%X&#123;traceNo&#125;] %msg%n</span><br><span class="line">        <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>如上，在logback.xml中的pattern中我们加入了<code>[%X{traceNo}]</code>，在MDC中放入traceNo的值，就可以记录日志了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2018-03-03 10:11:27 INFO com.tommy.myapp.dao.UserServiceTest.testFindByName(UserServiceTest.java:52)] [jd.com] user:User&#123;id=1, name=&apos;test&apos;, birthday=Sat Mar 03 10:11:27 CST 2018&#125;</span><br></pre></td></tr></table></figure><p>注意日志中的[jd.com]，这就是我们日志中加入的自定义的字段，在Linux系统中，我们可以通过<code>grep traceNo xx.log --color</code>查询某个跟踪号相关的日志，并高亮显示。</p><p>在WEB系统中，则可以新建一个自定义的请求过滤器，对业务请求进行过滤，在过滤器内处理请求前加入traceNo，请求处理完毕后，从MDC删除traceNo。</p><p>logback MDC的使用和分析可以参考：<a href="http://blog.csdn.net/liubo2012/article/details/46337063">Slf4j MDC 使用和 基于 Logback 的实现分析</a></p><p>logback使用参考：<a href="http://blog.csdn.net/johnson_moon/article/details/77532583">Java 日志组件slf4j+logback使用实例</a>、<a href="https://www.cnblogs.com/yaomajor/p/5707678.html">logback.xml常用配置</a></p><p>参考：<a href="http://www.importnew.com/16331.html">Java日志终极指南</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日志 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring单元测试</title>
      <link href="/2018/03/01/spring-unittests/"/>
      <url>/2018/03/01/spring-unittests/</url>
      
        <content type="html"><![CDATA[<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>参考<a href="http://tommy88.top/2018/02/28/SpringDataJpa%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/">《SpringDataJpa基本使用》</a>。</p><h2 id="DAO测试"><a href="#DAO测试" class="headerlink" title="DAO测试"></a>DAO测试</h2><p>新建一个测试基类，后续所有的测试类继承该类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(locations = <span class="string">"classpath:spring.xml"</span>)</span><br><span class="line"><span class="meta">@TransactionConfiguration</span>(transactionManager = <span class="string">"transactionManager"</span>,defaultRollback = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseSpringTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoTest</span> <span class="keyword">extends</span> <span class="title">BaseSpringTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(UserDaoTest.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"testSave method in UserDaoTest"</span>);</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">"test"</span>);</span><br><span class="line">        user.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        user = <span class="keyword">this</span>.userDao.save(user);</span><br><span class="line">        <span class="keyword">assert</span> user.getId() &gt; <span class="number">0</span>;</span><br><span class="line">        dbUserId = user.getId();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：dao的测试一定不能污染数据库，这里配置了TransactionConfiguration，在测试方法执行完毕后回滚事务。<br><a id="more"></a></p><h2 id="Service测试"><a href="#Service测试" class="headerlink" title="Service测试"></a>Service测试</h2><p>service层的测试通常依赖dao层，对于dao的依赖，使用mock框架mock出相应的bean，重心放在service方法的逻辑处理是否正确。<br>参考：<a href="http://tommy88.top/2018/03/01/springockito-annotations%E5%81%9Aspring%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">《springockito-annotations做spring的单元测试》</a></p><h2 id="Controller测试"><a href="#Controller测试" class="headerlink" title="Controller测试"></a>Controller测试</h2><p>参考<a href="https://www.cnblogs.com/hthuang/p/6902998.html">Spring Controller单元测试</a></p><h2 id="外部接口测试"><a href="#外部接口测试" class="headerlink" title="外部接口测试"></a>外部接口测试</h2><p>1.mock外部依赖；<br>2.新建被测试外部依赖接口service的实现（在test/java/src），使用单元测试的spring配置文件。</p><h2 id="多线程测试"><a href="#多线程测试" class="headerlink" title="多线程测试"></a>多线程测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(locations = <span class="string">"classpath:spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiThreadServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MultiThreadServiceTest.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">multithreadSaveTest</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> WorkerTask());</span><br><span class="line">            thread.start();</span><br><span class="line">            latch.countDown(); <span class="comment">// 线程启动后将latch数量减一，在WorkTask中会等待latch数量为0时执行数据库插入和查询操作。即保证所有线程同时执行数据库插入和查询操作。</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这里要休眠一定时间，否则会导致所有WorkTask都没有执行。</span></span><br><span class="line">        <span class="comment">// 因为Junit将测试方法执行完毕就退出了，这时候子线程其实还没开始执行。</span></span><br><span class="line">        Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">teadDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 执行数据库清理工作。在多线程环境，在单元测试类上加入@Transactional并没有用，只对被测试方法本身所在的线程（主线程）有用，其他线程无效。</span></span><br><span class="line">        <span class="comment">// 所以这里在单元测试执行完毕后，对数据库做清理工作。</span></span><br><span class="line">        userService.deleteAll(dbIds);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">private</span> Collection&lt;Long&gt; dbIds = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">WorkerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                latch.await(); <span class="comment">// 等待所有线程准备就绪同时执行数据库插入操作。</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setName(<span class="string">"test"</span>);</span><br><span class="line">            user.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">            user = userService.save(user);</span><br><span class="line">            <span class="keyword">assert</span> user.getId() &gt; <span class="number">0</span>;</span><br><span class="line">            dbIds.add(user.getId());</span><br><span class="line">            user = userService.findById(user.getId());</span><br><span class="line">            logger.info(<span class="string">"user:&#123;&#125;"</span>,user);</span><br><span class="line">            Assert.assertNotNull(user);</span><br><span class="line">            Assert.assertEquals(<span class="string">"test"</span>,user.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：多线程环境单元测试，就算在测试类上加入@Transactional注解，数据库操作也是不会回滚的。原因可以查看代码注释，所以需要手动执行清理操作。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springockito-annotations做spring的单元测试</title>
      <link href="/2018/03/01/springockito-annotations-to-test-spring/"/>
      <url>/2018/03/01/springockito-annotations-to-test-spring/</url>
      
        <content type="html"><![CDATA[<p>Service层通常依赖DAO的Bean，在做Service层的单元测试时应该将DAO层的Bean Mock出来，只关注于Service层的业务逻辑处理是否正确。这里介绍的是使用springockito-annotations来模拟spring bean。<br><a id="more"></a></p><h2 id="引入springockito-annotations依赖"><a href="#引入springockito-annotations依赖" class="headerlink" title="引入springockito-annotations依赖"></a>引入springockito-annotations依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.kubek2k<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springockito-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springockito.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(loader = SpringockitoContextLoader.class,locations = <span class="string">"classpath:spring.xml"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(UserServiceTest.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@ReplaceWithMock</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao; <span class="comment">// UserService中依赖UserDao，这里mock出UserDao</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1L</span>);</span><br><span class="line">        user.setName(<span class="string">"test"</span>);</span><br><span class="line">        user.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="comment">// 对UserDao的findByName方法进行模拟，如果传入的参数是test则返回uesr对象。</span></span><br><span class="line">        Mockito.when(userDao.findByName(<span class="string">"test"</span>)).thenReturn(user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindByName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"method testFindByName in UserServiceTest"</span>);</span><br><span class="line">        User user = userService.findByName(<span class="string">"test"</span>);</span><br><span class="line">        logger.info(<span class="string">"user:&#123;&#125;"</span>,user);</span><br><span class="line">        Assert.assertNotNull(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：涉及到的spring的配置文件以及其他依赖、代码等没有给出。</p><p>具体使用可以参考：<a href="http://www.codeceo.com/article/spring-test-is-easy.html">Spring 测试：其实很简单</a>、<a href="http://josephgao.iteye.com/blog/1927546">ockito-annotations 做spring的单元测试</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Data Jpa使用</title>
      <link href="/2018/02/28/SpringDataJpa-basic-usage/"/>
      <url>/2018/02/28/SpringDataJpa-basic-usage/</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Data-Jpa简介"><a href="#Spring-Data-Jpa简介" class="headerlink" title="Spring Data Jpa简介"></a>Spring Data Jpa简介</h2><p> Spring Data JPA是Spring Data框架的一个模块。<br> Spring Data JPA依赖于Spring的核心jar,JPA只有接口和注解，Spring Data JPA的功能实现默是使用的Hibernate，因此还必须引入Hibernate对JPA的支持（整合）项目hibernate-entitymanager。</p><p> JPA编程是通过EntityManagerFactory（类似SessionFactory），获得EntityManager （类似Session）进行增删改查，CRUD的方法分别为：<br> 增加 persist()、修改 merge()、删除 remove()、查询 find()</p><h2 id="Spring-Data-JPA配置和基本使用"><a href="#Spring-Data-JPA配置和基本使用" class="headerlink" title="Spring Data JPA配置和基本使用"></a>Spring Data JPA配置和基本使用</h2><p>1.引入spring data jpa和hibernate-entitymanager的依赖；<br>2.配置DataSource，配置EntityManagerFactory，配置事务，配置JPA扫描。<br>3.编写接口继承Repository系列接口，按照JPA规范编写相关方法。<br><a id="more"></a></p><h2 id="具体实例"><a href="#具体实例" class="headerlink" title="具体实例"></a>具体实例</h2><p>依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>4.0.3.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">spring.groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.0.28<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>5.1.45<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.data.jpa.version</span>&gt;</span>1.7.0.RELEASE<span class="tag">&lt;/<span class="name">spring.data.jpa.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hibernate.entitymanager.version</span>&gt;</span>4.3.6.Final<span class="tag">&lt;/<span class="name">hibernate.entitymanager.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">junit.version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">junit.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aspectjweaver.version</span>&gt;</span>1.8.1<span class="tag">&lt;/<span class="name">aspectjweaver.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.data<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.data.jpa.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-entitymanager<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;hibernate.entitymanager.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;junit.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aspectjweaver.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span> <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:cache</span>=<span class="string">"http://www.springframework.org/schema/cache"</span> <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jpa</span>=<span class="string">"http://www.springframework.org/schema/data/jpa"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/context/spring-context-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">     http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache-4.0.xsd http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.tommy.myapp"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:db.properties"</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--alibaba druid数据库连接池配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.druid.pool.DruidDataSource"</span> <span class="attr">init-method</span>=<span class="string">"init"</span> <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 基本属性 url、user、password --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.url&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.username&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.password&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置初始化大小、最小、最大 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialSize"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minIdle"</span> <span class="attr">value</span>=<span class="string">"10"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxActive"</span> <span class="attr">value</span>=<span class="string">"100"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置获取连接等待超时的时间 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWait"</span> <span class="attr">value</span>=<span class="string">"60000"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置间隔多久才进行一次检测，检测需要关闭的空闲连接，单位是毫秒 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeBetweenEvictionRunsMillis"</span> <span class="attr">value</span>=<span class="string">"60000"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置一个连接在池中最小生存的时间，单位是毫秒 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minEvictableIdleTimeMillis"</span> <span class="attr">value</span>=<span class="string">"300000"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"validationQuery"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.test_sql&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指明连接是否被空闲连接回收器(如果有)进行检验.如果检测失败,则连接将被从池中去除.注意: 设置为true后如果要生效,validationQuery参数必须设置为非空字符串 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testWhileIdle"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 默认值是 true ，当从连接池取连接时，验证这个连接是否有效 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 默认值是 flase, 当从把该连接放回到连接池的时，验证这个连接是否有效 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnReturn"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 打开PSCache，并且指定每个连接上PSCache的大小 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"poolPreparedStatements"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolPreparedStatementPerConnectionSize"</span> <span class="attr">value</span>=<span class="string">"20"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置监控统计拦截的filters --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filters"</span> <span class="attr">value</span>=<span class="string">"stat"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 实体管理工厂 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 数据源 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描实体类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"packagesToScan"</span> <span class="attr">value</span>=<span class="string">"com.tommy.myapp.entity"</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--JPA供应商适配：数据库和方言 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaVendorAdapter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 数据库类型配置 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.type&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 是否自动生成DDL建表 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"generateDdl"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 配置dialect方言 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"databasePlatform"</span> <span class="attr">value</span>=<span class="string">"$&#123;db.dialect&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 打印sql --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"showSql"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置hibernate的其他属性 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jpaProperties"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"hibernate.format_sql"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 事务管理器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"transactionManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.orm.jpa.JpaTransactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"entityManagerFactory"</span> <span class="attr">ref</span>=<span class="string">"entityManagerFactory"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 注册驱动 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">"transactionAdvice"</span> <span class="attr">transaction-manager</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"add*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"append*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"insert*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"save*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"update*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"modify*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"edit*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"delete*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"remove*"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"repair"</span> <span class="attr">propagation</span>=<span class="string">"REQUIRED"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"get*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"select*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"find*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"load*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"search*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">"*"</span> <span class="attr">propagation</span>=<span class="string">"SUPPORTS"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- AOP配置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"myPointcut"</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">expression</span>=<span class="string">"execution(* com.tommy.myapp.service.impl.*.*(..))"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">"transactionAdvice"</span> <span class="attr">pointcut-ref</span>=<span class="string">"myPointcut"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jpa:repositories</span> <span class="attr">base-package</span>=<span class="string">"com.tommy.myapp.dao"</span> <span class="attr">entity-manager-factory-ref</span>=<span class="string">"entityManagerFactory"</span></span></span><br><span class="line"><span class="tag">                      <span class="attr">transaction-manager-ref</span>=<span class="string">"transactionManager"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jpa:repositories</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>db.properties:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.type=MYSQL</span><br><span class="line">db.dialect=org.hibernate.dialect.MySQL5InnoDBDialect</span><br><span class="line">db.url=jdbc:mysql://192.168.74.135:3306/test?useUnicode=true&amp;characterEncoding=utf8</span><br><span class="line">db.username=root</span><br><span class="line">db.password=123456</span><br><span class="line">db.test_sql=select 1</span><br></pre></td></tr></table></figure></p><p>User.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"t_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birthday;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>UserDao.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDao</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">User <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>单元测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="meta">@ContextConfiguration</span>(locations = <span class="string">"classpath:spring.xml"</span>)</span><br><span class="line"><span class="meta">@TransactionConfiguration</span>(transactionManager = <span class="string">"transactionManager"</span>,defaultRollback = <span class="keyword">true</span>) <span class="comment">// 单元测试完毕回滚事务</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDao userDao;</span><br><span class="line">    <span class="keyword">private</span> Long dbUserId = <span class="number">0L</span>;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSave</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">"test"</span>);</span><br><span class="line">        user.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        user = <span class="keyword">this</span>.userDao.save(user);</span><br><span class="line">        <span class="keyword">assert</span> user.getId() &gt; <span class="number">0</span>;</span><br><span class="line">        dbUserId = user.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindUserById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">this</span>.userDao.findOne(dbUserId);</span><br><span class="line">        <span class="keyword">assert</span> user != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindUserByName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String name = <span class="string">"test"</span>;</span><br><span class="line">        User user = <span class="keyword">this</span>.userDao.findByName(name);</span><br><span class="line">        <span class="keyword">assert</span> user != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>相关问题：<br>1.org.hibernate.id.IdentifierGenerationException: ids for this class must be manually assigned before<br>解决：在实体类的id字段上加入@GeneratedValue(strategy = GenerationType.AUTO)注解<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line"><span class="keyword">private</span> Long id;</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://blog.csdn.net/shuaicihai/article/details/54987094">Spring Data JPA框架</a>、<a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-spring-jpa/index.html">使用Spring Data JPA简化JPA开发</a>、<a href="http://blog.51cto.com/dba10g/1791528">Spring Data系列入门</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>web工程非Spring管理的Bean使用Spring管理的Bean</title>
      <link href="/2018/02/26/web-not-spring-managed-app-use-spring-managed-beans/"/>
      <url>/2018/02/26/web-not-spring-managed-app-use-spring-managed-beans/</url>
      
        <content type="html"><![CDATA[<p>某个类的属性在每次构建对象时传入，且属性不是固定的，就没法使用spring管理它。但这个类有可能应用其他被spring管理的类。</p><p>那么既然是web工程，我们可以创建一个ServletContextListener，然后在web.xml中配置该监听器即可。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitDataListener</span> <span class="keyword">implements</span> <span class="title">ServletContextListener</span> </span>&#123;  </span><br><span class="line">      </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> </span>&#123;  </span><br><span class="line">        </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInitialized</span><span class="params">(ServletContextEvent event)</span> </span>&#123;  </span><br><span class="line">        ApplicationContext context = WebApplicationContextUtils.getRequiredWebApplicationContext(<span class="keyword">this</span>.getServletContext());</span><br><span class="line">SpringUtil.setContext(context);</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>SpringUtil：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setContext</span><span class="params">(ApplicationContext _context)</span> </span>&#123;</span><br><span class="line">    context = _context;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> context.getBean(beanName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; tClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> context.getBean(tClass);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>web.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>com.tommy.myapp.listener.InitDataListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>然后其他工程中可以通过SpringUtil.getBean()来获取spring管理的bean。</p><p>当然了，你用一个Servlet也是可以的，继承HttpServlet，在init()中获取ApplicationContext，注意在web.xml中配置该servlet。</p><p>这里可能的应用场景包括：<br>1.在系统启动时查询一些数据放入内存等等；–也可以使用@PostConstruct注解，在对象初始化后执行。<br>2.在非Spring管理的类中应用Spring管理的类。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mybatis逆向工程生成代码</title>
      <link href="/2018/02/26/MyBatis-code-generation/"/>
      <url>/2018/02/26/MyBatis-code-generation/</url>
      
        <content type="html"><![CDATA[<p>mybatis官方提供了一个逆向工程，可以针对单表自动生成mybatis执行所需要的代码（包括mapper.xml、mapper.java、po..）。一般在开发中，常用的逆向工程方式是通过数据库的表生成代码。</p><p>mybatis-generator有三种用法：命令行、eclipse插件、maven插件。个人觉得maven插件最方便，可以在eclipse/intellij idea等ide上可以通用。<br><a id="more"></a></p><h2 id="在pom-xml中添加plugin"><a href="#在pom-xml中添加plugin" class="headerlink" title="在pom.xml中添加plugin"></a>在pom.xml中添加plugin</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>mybatis-generator<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>src/main/resources/generatorConfig.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>Generate MyBatis Artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.35<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中generatorConfig.xml的位置，大家根据实际情况自行调整</p><h2 id="generatorConfig-xml配置文件"><a href="#generatorConfig-xml配置文件" class="headerlink" title="generatorConfig.xml配置文件"></a>generatorConfig.xml配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE generatorConfiguration</span></span><br><span class="line"><span class="meta">        PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"testTables"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressAllComments"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mysql数据库连接的信息：驱动类、连接地址、用户名、密码 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"com.mysql.jdbc.Driver"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">connectionURL</span>=<span class="string">"jdbc:mysql://192.168.74.135:3306/test"</span> <span class="attr">userId</span>=<span class="string">"root"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">password</span>=<span class="string">"123456"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--oracle配置--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;jdbcConnection driverClass="oracle.jdbc.OracleDriver" connectionURL="jdbc:oracle:thin:@127.0.0.1:1521:yycg"</span></span><br><span class="line"><span class="comment">            userId="yycg"</span></span><br><span class="line"><span class="comment">            password="yycg"&gt;</span></span><br><span class="line"><span class="comment">        &lt;/jdbcConnection&gt; --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer，</span></span><br><span class="line"><span class="comment">        为 true时把JDBC DECIMAL和NUMERIC类型解析为java.math.BigDecimal --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- targetProject:生成model类的位置，重要！！ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.tommy.myapp.model"</span> <span class="attr">targetProject</span>=<span class="string">"./src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- enableSubPackages:是否让schema作为包的后缀 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 从数据库返回的值被清理前后的空格 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- targetProject:mapper映射xml文件生成的位置，重要！！ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"com.tommy.myapp.mapper"</span></span></span><br><span class="line"><span class="tag">                         <span class="attr">targetProject</span>=<span class="string">"./src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- targetPackage：mapper接口生成的位置，重要！！ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">targetPackage</span>=<span class="string">"com.tommy.myapp.dao"</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">targetProject</span>=<span class="string">"./src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 指定数据库表，要生成哪些表，就写哪些表，要和数据库中对应，不能写错！ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"articles"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"blog"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"user"</span>&gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn mybatis-generator:generate</span><br></pre></td></tr></table></figure><p>如果是在intellij 环境，直接鼠标点击即可<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-26/56451262.jpg" alt=""></p><p>刷新工程目录，即可看到生成的文件。</p><p>注意： 建表时，表字段名称建议用”_”分隔多个单词，比如:order_detail,这样生成的model，属性名称就会变成漂亮的驼峰命名，即：orderDetail。</p><p>另外，每次最好不要在实际的工程中生成，如果有同名的会覆盖。所以建议以一个单独的工程来生成，然后拷贝过去。</p><p>参考：<a href="http://blog.csdn.net/eson_15/article/details/51694684">MyBatis的逆向工程生成代码</a>、<a href="http://blog.csdn.net/gebitan505/article/details/51788894">Mybatis逆向工程_使用maven</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>取消Notepad++红色下划线（错误提示）</title>
      <link href="/2018/02/26/notepad++-remove-red-underline-show/"/>
      <url>/2018/02/26/notepad++-remove-red-underline-show/</url>
      
        <content type="html"><![CDATA[<p>notepad++新升级了之后就有自动判断的红线，单词拼错了就给提示，看着这红线实在难受。</p><p>把【插件】-【DSpellCheck】-【Spell Check Document Automatically】前面的打钩去掉即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列12——Eureka的高可用</title>
      <link href="/2018/02/04/springcloud-series-12-eureka-high-avaiable/"/>
      <url>/2018/02/04/springcloud-series-12-eureka-high-avaiable/</url>
      
        <content type="html"><![CDATA[<p>Eureka Server的高可用是通过各个Eureka Server作为服务向其他Eureka Server注册，来实现服务列表的同步，达到高可用的效果。</p><p>默认情况下，每个Eureka服务器也是Eureka客户端，并且需要（至少一个）服务URL来定位对等端。</p><a id="more"></a><p>我们对以前的Eureka Server工程做修改，在application.yml配置如下：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer1</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer1</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer2:8762/eureka/,http://peer3:8763/eureka/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8762</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer2</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer2</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer3:8763/eureka/</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8763</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  profiles:</span> <span class="string">peer3</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    hostname:</span> <span class="string">peer3</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka/,http://peer2:8762/eureka/</span></span><br></pre></td></tr></table></figure></p><p>这里是本地测试，所以3个Eureka Server的配置都写在一个配置文件。<br>修改hosts文件：<code>127.0.0.1  peer1 peer2 peer3</code>，peer1,peer2,peer3都映射到127.0.0.1。<br>在启动时指定profile，idea的配置如下：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-4/6227969.jpg" alt=""></p><p>依次启动peer1，peer2，peer3。<br>观察peer1，peer2的日志都有报错。peer1报错是因为peer2和peer3服务没有启动，导致没法将自己注册到peer2和peer3。peer2报错是因为peer3没有启动，peer3启动正常，无错误。<br>查看peer1<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-4/2354961.jpg" alt=""></p><p>查看peer2<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-4/18175827.jpg" alt=""></p><p>查看peer3<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-4/59489243.jpg" alt=""><br>可以看到：</p><ul><li>1.每个Eureka Server都是其他Eureka Server的一个服务；</li><li>2.每个Eureka Server都是相互同步的。</li></ul><p>其他服务提供者的application.yml修改：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://peer1:8761/eureka,http://peer1:8762/eureka,http://peer1:8763/eureka</span></span><br></pre></td></tr></table></figure></p><p>建议把每个Eureka Server地址都写上。只写其中一个启动也是没问题的。但是，如果只写peer1的地址，那么该服务挂掉，且peer1也挂掉，将导致服务不能注册。</p><p>Eureka Server的高可用参考<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-eureka-server-zones-and-regions">Spring Cloud官方文档</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列11——覆盖Feign的默认配置</title>
      <link href="/2018/02/03/springcloud-series-11-covering-Feign-default-configuration/"/>
      <url>/2018/02/03/springcloud-series-11-covering-Feign-default-configuration/</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Cloud-Feign简介"><a href="#Spring-Cloud-Feign简介" class="headerlink" title="Spring Cloud Feign简介"></a>Spring Cloud Feign简介</h2><p>Spring Cloud官方原文：</p><blockquote><p>A central concept in Spring Cloud’s Feign support is that of the named client. Each feign client is part of an ensemble of components that work together to contact a remote server on demand, and the ensemble has a name that you give it as an application developer using the<code>@FeignClient</code> annotation. Spring Cloud creates a new ensemble as an<code>ApplicationContext</code> on demand for each named client using<code>FeignClientsConfiguration</code>. This contains (amongst other things) an<code>feign.Decoder</code>, a<code>feign.Encoder</code>, and a<code>feign.Contract</code>.</p></blockquote><blockquote><p>Spring Cloud lets you take full control of the feign client by declaring additional configuration (on top of the <code>FeignClientsConfiguration</code>) using <code>@FeignClient</code>. </p></blockquote><a id="more"></a><p>翻译：<br>Spring Cloud的Feign支持中的一个中心概念是命名的客户端。 每个feign客户端都是组件的一部分，这些组件是按需联系远程服务器的组件的一部分，并且集合有一个名称，您可以使用@FeignClient注释将其作为应用程序开发人员提供。 Spring Cloud使用<code>FeignClientsConfiguration</code>创建一个新的集合，作为每个指定客户端的<code>ApplicationContext</code>。 这包含（其中包括）<code>feign.Decoder</code>，<code>feign.Encoder</code>和<code>feign.Contract</code>。</p><p>通过使用<code>@FeignClient</code>声明额外的配置（在<code>FeignClientsConfiguration</code>之上），Spring Cloud可让您完全控制Feign客户端。</p><h2 id="覆盖Feign的默认配置"><a href="#覆盖Feign的默认配置" class="headerlink" title="覆盖Feign的默认配置"></a>覆盖Feign的默认配置</h2><h3 id="定义Feign客户端接口"><a href="#定义Feign客户端接口" class="headerlink" title="定义Feign客户端接口"></a>定义Feign客户端接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"microservice-springcloud-user"</span>,configuration = MyConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestLine</span>(<span class="string">"GET /sample/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function">User <span class="title">findUserById</span><span class="params">(@Param(<span class="string">"userId"</span>)</span> Long userId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="自定义FeignClientsConfiguration"><a href="#自定义FeignClientsConfiguration" class="headerlink" title="自定义FeignClientsConfiguration"></a>自定义FeignClientsConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Contract <span class="title">feignContract</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> feign.Contract.Default();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用的Controller"><a href="#使用的Controller" class="headerlink" title="使用的Controller"></a>使用的Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findUser/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.findUserById(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="tip"><br>注意：FeignClientsConfiguration类不在Spring Boot启动类的扫描路径下，否则会覆盖该项目所有的Feign接口的默认配置。<br></div><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>1.启动Eureka Server；</li><li>2.启动microservice-springcloud-user服务；</li><li>3.启动microservice-springcloud-movie-feign-customization（本例中的测试项目）；<br>浏览器输入<a href="http://10.41.12.63:7901/findUser/1">http://10.41.12.63:7901/findUser/1</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-2-3/91877619.jpg" alt=""><br>请求成功。</li></ul><div class="tip"><br><em> 1.@FeignClient注解的serviceId参数不建议被使用。<br></em> 2.以前使用@FeignClient注解的时候使用了url参数，name参数不是必须的；但现在name必须，只是作为一个标识。<br>* 3.Feign默认使用的spring MVC的注解，参考《springcloud系列10——Feign的简介及基础使用》。如果覆盖了Feign的默认配置，则需要使用Feign的注解。<br></div><h2 id="FeignClient使用name和url的示例"><a href="#FeignClient使用name和url的示例" class="headerlink" title="@FeignClient使用name和url的示例"></a>@FeignClient使用name和url的示例</h2><p>这里使用的Feign的默认配置。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"test"</span>, url = <span class="string">"http://localhost:8761"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeignClient2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/eureka/apps/&#123;serviceName&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">String <span class="title">findServiceInfo</span><span class="params">(@PathVariable(<span class="string">"serviceName"</span>)</span> String serviceName)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> FeignClient2 feignClient2;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findUser/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.findUserById(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/service/&#123;serviceName&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findServiceInfoFromEureka</span><span class="params">(@PathVariable String serviceName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.feignClient2.findServiceInfo(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意目录结构：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-3/50727440.jpg" alt=""><br>FeignConfiguration类如果加了@Configuration注解，则不能被@ComponetScan扫描到，可以不加这个注解。<br>Spring Cloud官方文档有说：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-3/86978165.jpg" alt=""></p><p>参考：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-feign-overriding-defaults">Spring Cloud官方文档——spring-cloud-feign-overriding-defaults</a></p><h2 id="Feign日志配置"><a href="#Feign日志配置" class="headerlink" title="Feign日志配置"></a>Feign日志配置</h2><p>为每个创建的Feign客户端创建一个记录器。 默认情况下，记录器的名称是用于创建Feign客户端的接口的完整类名称。 Feign日志记录只响应DEBUG级别。</p><h3 id="配置日志级别"><a href="#配置日志级别" class="headerlink" title="配置日志级别"></a>配置日志级别</h3><p>在application.yml中增加FeignClient的日志级别（注意：每个FeignClient是单独配置的）<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line"><span class="attr">  level:</span></span><br><span class="line">    <span class="string">com.tommy.springcloud.config.feign.UserFeignClient:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure></p><h3 id="设置记录哪些日志"><a href="#设置记录哪些日志" class="headerlink" title="设置记录哪些日志"></a>设置记录哪些日志</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Contract <span class="title">feignContract</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> feign.Contract.Default();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里配置日志记录所有请求和响应信息，包括请求头、请求体、元数据</p><h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><p><img src="http://omh46px9n.bkt.clouddn.com/18-2-3/81620960.jpg" alt=""></p><h3 id="日志记录的选择"><a href="#日志记录的选择" class="headerlink" title="日志记录的选择"></a>日志记录的选择</h3><p>您可以为每个客户端配置的Logger.Level对象告诉Feign需要记录多少。 选择是：</p><ul><li>NONE：不记录（默认）。</li><li>BASIC：只记录请求方法和URL以及响应状态码和执行时间。</li><li>HEADERS：记录基本信息以及请求和响应标题。</li><li>FULL：记录请求和响应的标题，正文和元数据。</li></ul><p>参考：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#_feign_logging">Spring Cloud官方文档——Feign logging</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列10——Feign的简介及基础使用</title>
      <link href="/2018/02/02/springcloud-series-10-Feign-install-and-basic-useage/"/>
      <url>/2018/02/02/springcloud-series-10-Feign-install-and-basic-useage/</url>
      
        <content type="html"><![CDATA[<h2 id="Feign简介"><a href="#Feign简介" class="headerlink" title="Feign简介"></a>Feign简介</h2><p>Feign 是一个声明web服务客户端，这使得编写web服务客户端更容易，使用Feign 创建一个接口并对它进行注解，它具有可插拔的注解支持包括Feign注解与JAX-RS注解，Feign还支持可插拔的编码器与解码器，Spring Cloud 增加了对 Spring MVC的注解，Spring Web 默认使用了HttpMessageConverters, Spring Cloud集成了Ribbon 和 Eureka使Feign支持http client负载均衡。</p><p>上面其实是对Spring Cloud官方文档<code>Declarative REST Client: Feign</code>一节的翻译。</p><h2 id="Feign基本使用"><a href="#Feign基本使用" class="headerlink" title="Feign基本使用"></a>Feign基本使用</h2><h3 id="添加spring-cloud-starter-openfeign依赖"><a href="#添加spring-cloud-starter-openfeign依赖" class="headerlink" title="添加spring-cloud-starter-openfeign依赖"></a>添加spring-cloud-starter-openfeign依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="应用启动类上加入-EnableFeignClients"><a href="#应用启动类上加入-EnableFeignClients" class="headerlink" title="应用启动类上加入@EnableFeignClients"></a>应用启动类上加入@EnableFeignClients</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="定义一个接口类并加入-FeignClient"><a href="#定义一个接口类并加入-FeignClient" class="headerlink" title="定义一个接口类并加入@FeignClient"></a>定义一个接口类并加入@FeignClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"microservice-springcloud-user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserFeignClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/sample/&#123;userId&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function">User <span class="title">findUserById</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId)</span>;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;userId&#125;"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function">User <span class="title">updateUser</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId, @<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>)</span> String name,@<span class="title">RequestParam</span><span class="params">(<span class="string">"balance"</span>)</span> BigDecimal balance)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的例子代码中提供了2个get请求和一个post请求。@FeignClient中value为服务id。</p><h3 id="在Controller中注入上面创建的接口"><a href="#在Controller中注入上面创建的接口" class="headerlink" title="在Controller中注入上面创建的接口"></a>在Controller中注入上面创建的接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserFeignClient userFeignClient;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/findUser/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.findUserById(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/user/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">updateUserById</span><span class="params">(@PathVariable Long userId, User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userFeignClient.updateUser(userId,user.getName(),user.getBalance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>1.启动Eureka Server；</li><li>2.启动microservice-springcloud-user服务；</li><li>3.启动microservice-springcloud-movie（本例）；</li></ul><h3 id="1-GET请求测试"><a href="#1-GET请求测试" class="headerlink" title="1.GET请求测试"></a>1.GET请求测试</h3><p>浏览器输入<a href="http://localhost:7901/findUser/1">http://localhost:7901/findUser/1</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/63299360.jpg" alt=""><br>可以看到，请求成功。</p><h3 id="2-POST请求测试"><a href="#2-POST请求测试" class="headerlink" title="2.POST请求测试"></a>2.POST请求测试</h3><p>使用ARC（一个Chrome浏览器的http插件）测试POST请求，请求也是成功的<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/14379739.jpg" alt=""></p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul><li>1.在UserFeignClient中不能使用GetMapping，要使用RequestMapping注解；</li><li>2.url路径中的参数，在@PathVariable注解中必须指定value，如<code>@PathVariable(&quot;userId&quot;) Long userId</code>，使用@RequestParam也需要指定value；</li><li>3.不支持复杂对象，需要结合@RequestParam实现复杂对象。如果使用复杂对象，比如：<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;userId&#125;"</span>, method = RequestMethod.POST)</span><br><span class="line"><span class="function">User <span class="title">updateUser</span><span class="params">(@PathVariable(<span class="string">"userId"</span>)</span> Long userId, User user)</span>;</span><br></pre></td></tr></table></figure></li></ul><p>比如上面方法中的User为复杂对象，在使用ARC（一个Chrome浏览器的http插件）测试时，后台Controller接收是正常的，但UserFeignClient调用microservice-springcloud-user时User里面属性都是null，如下图。<br>后台Controller<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/25881628.jpg" alt=""></p><p>UserFeignClient<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/29148360.jpg" alt=""></p><p>参考：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/multi/multi_spring-cloud-feign.html">Spring Cloud官方文档</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列9——Ribbon脱离Eureka使用</title>
      <link href="/2018/02/02/springcloud-series-9-use%20Ribbon-without-Eureka/"/>
      <url>/2018/02/02/springcloud-series-9-use%20Ribbon-without-Eureka/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Eureka对远程服务发现提供了抽象，你不需要在客户端硬编码URL。但是，如果你不想在Ribbon中使用Eureka，也是非常简单的。<br>这里仍然以前面章节中的microservice-springcloud-movie进行测试。</p><h2 id="在Ribbon中禁用Eureka"><a href="#在Ribbon中禁用Eureka" class="headerlink" title="在Ribbon中禁用Eureka"></a>在Ribbon中禁用Eureka</h2><p>在application.yml中增加下面的配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line"><span class="attr">  eureka:</span></span><br><span class="line"><span class="attr">   enabled:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure></p><h2 id="声明Ribbon客户端提供的服务列表"><a href="#声明Ribbon客户端提供的服务列表" class="headerlink" title="声明Ribbon客户端提供的服务列表"></a>声明Ribbon客户端提供的服务列表</h2><p>在application.yml中增加：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    listOfServers:</span> <span class="attr">localhost:7902,localhost:7903</span></span><br><span class="line"><span class="attr">    NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br><span class="line"><span class="attr">microservice-springcloud-user2:</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    listOfServers:</span> <span class="attr">localhost:7904,localhost:7905</span></span><br></pre></td></tr></table></figure></p><p>在上面Ribbon客户端中定义的服务列表包括了microservice-springcloud-user和microservice-springcloud-user2两个服务，其中microservice-springcloud-user服务随机访问，microservice-springcloud-user2不配置则使用默认的轮询策略。<br><a id="more"></a></p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>1.启动Eureka Server；</li><li>2.启动microservice-springcloud-user的2个服务；</li><li>3.启动microservice-springcloud-user2的2个服务；</li><li>4.启动microservice-springcloud-movie。</li></ul><h3 id="测试1"><a href="#测试1" class="headerlink" title="测试1"></a>测试1</h3><p>浏览器中输入<a href="http://localhost:7901/test">http://localhost:7901/test</a>并刷新多次，查看控制台<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/26873693.jpg" alt=""><br>可以看到microservice-springcloud-user随机访问的，microservice-springcloud-user2则是轮询。</p><h3 id="测试2"><a href="#测试2" class="headerlink" title="测试2"></a>测试2</h3><p>如果在application.yml中不配置microservice-springcloud-user2，则访问<a href="http://localhost:7901/test">http://localhost:7901/test</a>会报错，但使用了eureka则不会。</p><h2 id="直接使用Ribbon-API"><a href="#直接使用Ribbon-API" class="headerlink" title="直接使用Ribbon API"></a>直接使用Ribbon API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancer;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doStuff</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceInstance instance = loadBalancer.choose(<span class="string">"stores"</span>);</span><br><span class="line">        URI storesUri = URI.create(String.format(<span class="string">"http://%s:%s"</span>, instance.getHost(), instance.getPort()));</span><br><span class="line">        <span class="comment">// ... do something with the URI</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/multi/multi_spring-cloud-ribbon.html">Spring Cloud官方文档</a>第16.6到16.8章节。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列8——使用配置文件自定义Ribbon Client</title>
      <link href="/2018/02/02/springcloud-series-8-use-config-file-custom-RibbonClient/"/>
      <url>/2018/02/02/springcloud-series-8-use-config-file-custom-RibbonClient/</url>
      
        <content type="html"><![CDATA[<p>参考《springcloud系列7——通过代码自定义配置ribbon》，将microservice-springcloud-movie中应用启动类中的@RibbonClient注释。这里是继续《springcloud系列7——通过代码自定义配置ribbon》测试的。</p><h2 id="配置文件修改"><a href="#配置文件修改" class="headerlink" title="配置文件修改"></a>配置文件修改</h2><p>在application.yml中增加下面的配置：<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义访问microservice-springcloud-user服务随机访问</span></span><br><span class="line"><span class="attr">microservice-springcloud-user:</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>1.启动Eureka Server；</li><li>2.microservice-springcloud-user中分别修改端口为7902,7904，然后分别启动；</li><li>3.microservice-springcloud-user中分别修改端口为7903,7905，spring.application.name修改为microservice-springcloud-user2，然后分别启动；</li><li>4.启动microservice-springcloud-movie；<br>浏览器输入<a href="http://localhost:8761/">http://localhost:8761/</a>，可以看到：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/71502946.jpg" alt=""><br>提供microservice-springcloud-user和microservice-springcloud-user2服务的分别有2个。</li></ul><h3 id="microservice-springcloud-user服务随机访问测试"><a href="#microservice-springcloud-user服务随机访问测试" class="headerlink" title="microservice-springcloud-user服务随机访问测试"></a>microservice-springcloud-user服务随机访问测试</h3><p>在浏览器输入<a href="http://localhost:7901/user/1">http://localhost:7901/user/1</a>多次，查看控制台：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/7830296.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/43028216.jpg" alt=""><br>可以看到一个控制台打印了2条SQL，一个控制台打印了4条SQL。说明是随机的。</p><h3 id="microservice-springcloud-user默认负载均衡规则测试"><a href="#microservice-springcloud-user默认负载均衡规则测试" class="headerlink" title="microservice-springcloud-user默认负载均衡规则测试"></a>microservice-springcloud-user默认负载均衡规则测试</h3><p>Ribbon默认使用的负载均衡策略是轮询，在上面的配置文件中，只对microservice-springcloud-user配置了随机访问，那么microservice-springcloud-user2应该是轮询的。下面测试一下。<br>在浏览器输入<a href="http://localhost:7901/test">http://localhost:7901/test</a>，查看microservice-springcloud-movie控制台：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-2/89037145.jpg" alt=""><br>可以看到microservice-springcloud-user是随机访问，microservice-springcloud-user2是轮询的。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>Spring Cloud官方文档<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/multi/multi_spring-cloud-ribbon.html">Customizing the Ribbon Client using properties</a>中<code>Customizing the Ribbon Client using properties</code>部分。</p><div class="tip"><br>注意：Spring Cloud官方文档提到的使用负载均衡规则的优先级：配置文件 &gt; 代码自定义 &gt; 系统默认。<br></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列7——通过代码自定义配置ribbon</title>
      <link href="/2018/02/01/springcloud-series-7-use-code-custom-ribbon/"/>
      <url>/2018/02/01/springcloud-series-7-use-code-custom-ribbon/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们这里准备了2组服务：</p><ul><li>2个microservice-springcloud-user服务，端口分别为7902和7904；</li><li>2个microservice-springcloud-user2服务，端口分别为7903和7905；<br>我们想实现的效果是：microservice-springcloud-user服务随机访问，microservice-springcloud-user2服务顺序访问。下面我们通过代码的方式来实现。</li></ul><a id="more"></a><h2 id="创建Ribbon规则"><a href="#创建Ribbon规则" class="headerlink" title="创建Ribbon规则"></a>创建Ribbon规则</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RibbonChooseConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">ribbonRule</span><span class="params">(IClientConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里指定的规则是随机。</p><blockquote><p>The FooConfiguration has to be @Configuration but take care that it is not in a @ComponentScan for the main application context, otherwise it will be shared by all the @RibbonClients. If you use @ComponentScan (or @SpringBootApplication) you need to take steps to avoid it being included (for instance put it in a separate, non-overlapping package, or specify the packages to scan explicitly in the @ComponentScan).    </p></blockquote><p>上面是Spring Cloud官方文档的原文，这里的config类所在的包有一定讲究，就是你的包不能被@ComponentScan或者@SpringBootApplication扫描到。官方文档Ribbon部分：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-ribbon">http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-ribbon</a></p><h2 id="在应用启动类上配置访问规则"><a href="#在应用启动类上配置访问规则" class="headerlink" title="在应用启动类上配置访问规则"></a>在应用启动类上配置访问规则</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient</span>(name = <span class="string">"microservice-springcloud-user"</span>,configuration = RibbonChooseConfiguration.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里指定microservice-springcloud-user使用的规则是RibbonChooseConfiguration定义的规则，也就是随机的。</p><h2 id="测试Controller修改"><a href="#测试Controller修改" class="headerlink" title="测试Controller修改"></a>测试Controller修改</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoadBalancerClient loadBalancerClient;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;userId&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://microservice-springcloud-user/sample/"</span> + userId,User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServiceInstance serviceInstance = loadBalancerClient.choose(<span class="string">"microservice-springcloud-user"</span>);</span><br><span class="line">        System.out.println(serviceInstance.getServiceId()+<span class="string">"--&gt;"</span>+serviceInstance.getHost()+<span class="string">":"</span>+serviceInstance.getPort());</span><br><span class="line">        ServiceInstance serviceInstance2 = loadBalancerClient.choose(<span class="string">"microservice-springcloud-user2"</span>);</span><br><span class="line">        System.out.println(serviceInstance2.getServiceId()+<span class="string">"--&gt;"</span>+serviceInstance2.getHost()+<span class="string">":"</span>+serviceInstance2.getPort());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello,world"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getUser()方法仍然访问microservice-springcloud-user服务，test()方法则2个服务都访问，打印服务的id、ip和端口。</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>1.开启2个microservice-springcloud-user服务，端口分别为7902和7904；</li><li>2.开启2个microservice-springcloud-user2服务，端口分别为7903和7905；</li><li>3.开启microservice-springcloud-movie，进行测试；</li><li><p>4.浏览器输入<a href="http://localhost:7901/user/1">http://localhost:7901/user/1</a>，查看控制台：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/14020805.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/56479550.jpg" alt=""><br>可以看到，microservice-springcloud-user一个控制台打印了3条SQL，一个1条SQL，说明访问是随机的。而我们在代码中指定了Ribbon访问microservice-springcloud-user的规则是随机的，所以说明规则生效了。</p></li><li><p>5.浏览器输入<a href="http://localhost:7901/test">http://localhost:7901/test</a>，访问6次<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/517566.jpg" alt=""><br>可以看到，microservice-springcloud-user是随机访问的，microservice-springcloud-user2是轮询。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列6——通过注册中心调用服务</title>
      <link href="/2018/02/01/springcloud-series-6-use-regisster-center-call-servies/"/>
      <url>/2018/02/01/springcloud-series-6-use-regisster-center-call-servies/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面在注册中心已经注册了一个服务microservice-springcloud-user，这里我们在microservice-springcloud-movie中通过注册中心调用microservice-springcloud-user用户查询服务，并且实现负载均衡能力。</p><div class="tip"><br>注意：这里不是直接通过microservice-springcloud-movie调用，是通过Eureka Server。<br></div><h2 id="microservice-springcloud-movie增加eureka-client的依赖"><a href="#microservice-springcloud-movie增加eureka-client的依赖" class="headerlink" title="microservice-springcloud-movie增加eureka client的依赖"></a>microservice-springcloud-movie增加eureka client的依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="application-yml增加eureka配置"><a href="#application-yml增加eureka配置" class="headerlink" title="application.yml增加eureka配置"></a>application.yml增加eureka配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7901</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">microservice-springcloud-movie</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    instanceId:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;vcap.application.instance_id:$&#123;spring.application.instance_id:$&#123;random.value&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="MovieController修改"><a href="#MovieController修改" class="headerlink" title="MovieController修改"></a>MovieController修改</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/user/&#123;userId&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable Long userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(<span class="string">"http://microservice-springcloud-user/sample/"</span> + userId,User.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里是通过注册到注册中心的服务名称来调用（microservice-springcloud-user中spring.application.name）。</p><h2 id="启动类修改"><a href="#启动类修改" class="headerlink" title="启动类修改"></a>启动类修改</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(App.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动类2处修改：</p><ul><li>增加@EnableEurekaClient；</li><li>RestTemplate增加@LoadBalanced，表示开启客户端负载均衡。</li></ul><h2 id="负载均衡测试"><a href="#负载均衡测试" class="headerlink" title="负载均衡测试"></a>负载均衡测试</h2><ul><li>1.启动microservice-discovery-eureka；</li><li>2.启动microservice-springcloud-user；</li><li>3.修改microservice-springcloud-user的application.yml中server.port为其他值（比如7903），再启动microservice-springcloud-user；</li><li>4.启动microservice-springcloud-movie<br>浏览器输入<a href="http://localhost:8761/，可以看到2个user的service。如图：">http://localhost:8761/，可以看到2个user的service。如图：</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/92903999.jpg" alt=""></li></ul><p>浏览器输入<a href="http://localhost:7901/user/1">http://localhost:7901/user/1</a>，看控制台日志<br>microservice-springcloud-user其中一个打印了查询的SQL，刷新浏览器，可以看到microservice-springcloud-user另外一个打印了查询的SQL。多次执行，都是按顺序依次调用，实现了负载均衡。</p><h2 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h2><p>springcloud的负载均衡是通过Ribbon实现的，是一个客户端的负载均衡组件，Ribbon实现了客户端的一些负载均衡算法，包括轮询（Round-Robin）、随机选择、最大可用策略等多种策略。<br>Ribbon负载均衡策略</p><ul><li>RoundRobinRule: 轮询策略，Ribbon以轮询的方式选择服务器，这个是默认值。所以示例中所启动的两个服务会被循环访问;</li><li>RandomRule: 随机选择，也就是说Ribbon会随机从服务器列表中选择一个进行访问;</li><li>BestAvailableRule: 最大可用策略，即先过滤出故障服务器后，选择一个当前并发请求数最小的;</li><li>WeightedResponseTimeRule: 带有加权的轮询策略，对各个服务器响应时间进行加权处理，然后在采用轮询的方式来获取相应的服务器;</li><li>AvailabilityFilteringRule: 可用过滤策略，先过滤出故障的或并发请求大于阈值一部分服务实例，然后再以线性轮询的方式从过滤后的实例清单中选出一个;</li><li>ZoneAvoidanceRule: 区域感知策略，先使用主过滤条件（区域负载器，选择最优区域）对所有实例过滤并返回过滤后的实例清单，依次使用次过滤条件列表中的过滤条件对主过滤条件的结果进行过滤，判断最小过滤数（默认1）和最小过滤百分比（默认0），最后对满足条件的服务器则使用RoundRobinRule(轮询方式)选择一个服务器实例。<br>参考：<a href="https://www.jianshu.com/p/df9393755a05">https://www.jianshu.com/p/df9393755a05</a></li></ul><p>Spring Cloud官方文档Ribbon的介绍：<a href="http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-ribbon">http://cloud.spring.io/spring-cloud-static/Edgware.SR1/single/spring-cloud.html#spring-cloud-ribbon</a></p><div class="tip"><br>注意：Spring Cloud官方文档中在<code>How to Include Ribbon</code>一节中说，要加入Ribbon的starter依赖。实际上是不需要的，在spring-cloud-dependencies依赖中已经包含了Ribbon的starter。<br>或者idea模块依赖中也可以看到已经有Ribbon的依赖了。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/89285417.jpg" alt=""><br></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列5——创建服务并注册到Eureka</title>
      <link href="/2018/02/01/springcloud-series-5-create-and-register-services-to-Eureka/"/>
      <url>/2018/02/01/springcloud-series-5-create-and-register-services-to-Eureka/</url>
      
        <content type="html"><![CDATA[<h2 id="添加eureka客户端的依赖"><a href="#添加eureka客户端的依赖" class="headerlink" title="添加eureka客户端的依赖"></a>添加eureka客户端的依赖</h2><p>在microservice-springcloud-user模块加入eureka客户端的依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="在application-yml添加eureka的配置"><a href="#在application-yml添加eureka的配置" class="headerlink" title="在application.yml添加eureka的配置"></a>在application.yml添加eureka的配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line"><span class="attr">    serviceUrl:</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br><span class="line"><span class="attr">  instance:</span></span><br><span class="line"><span class="attr">    prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">    instanceId:</span> <span class="string">$&#123;spring.application.name&#125;:$&#123;vcap.application.instance_id:$&#123;spring.application.instance_id:$&#123;random.value&#125;&#125;&#125;</span></span><br></pre></td></tr></table></figure><ul><li>spring.application.name属性<br>我们可以指定微服务的名称后续在调用的时候只需要使用该名称就可以进行服务的访问。</li><li>eureka.client.serviceUrl.defaultZone属性<br>指定服务注册中心的位置。为了在本机上测试区分服务提供方和服务注册中心，使用server.port属性设置不同的端口。<a id="more"></a><h2 id="启动类增加-EnableEurekaClient注解"><a href="#启动类增加-EnableEurekaClient注解" class="headerlink" title="启动类增加@EnableEurekaClient注解"></a>启动类增加@EnableEurekaClient注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceUserProviderApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MicroserviceUserProviderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>@EnableEurekaClient : 声明这是一个Eureka Client</p><p>启动MicroserviceUserProviderApplication，访问<a href="http://localhost:8761">http://localhost:8761</a>，可以看到有一个服务microservice-springcloud-user。<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/80321717.jpg" alt=""></p><div class="tip"><br>注意：启动《springcloud系列4——创建一个Eureka Server》中的Eureka Server。<br></div>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列4——创建一个Eureka Server</title>
      <link href="/2018/02/01/springcloud-series-4-create-Eureka%20Server/"/>
      <url>/2018/02/01/springcloud-series-4-create-Eureka%20Server/</url>
      
        <content type="html"><![CDATA[<h2 id="创建一个Eureka-Server"><a href="#创建一个Eureka-Server" class="headerlink" title="创建一个Eureka Server"></a>创建一个Eureka Server</h2><p>创建一个子模块microserver-discovery-eureka，该模块属于<code>microserver-spring-cloud</code>（看第一篇）。</p><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>microserver-spring-cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>microservice-discovery-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>microservice-discovery-eureka<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><div class="tip"><br>注意：microserver-spring-cloud的pom.xml中增加springcloud依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>Edgware.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><br><br></div><p>应用启动类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaApplication</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注意：</span></span><br><span class="line"><span class="comment">     * 1.启动之后访问的地址是：http://localhost:8761/，不是http://localhost:8761/eureka。</span></span><br><span class="line"><span class="comment">     * 2.注意父pom.xml中spring-cloud-dependencies的版本，可能导致子工程中找不到对应版本。这里使用的版本Edgware.SR1是Ok的。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaApplication.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过@EnableEurekaServer注解启动一个服务注册中心</p><p>application.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8761</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line"><span class="attr">  client:</span></span><br><span class="line">    <span class="comment"># 表示是否将自己注册到Eureka Server,默认为true.由于当前应用就是Eureka Server,故而设置为false.</span></span><br><span class="line"><span class="attr">    register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 表示是否从Eureka Server获取注册信息,默认为true.因为这是一个单点的Eureka Server,不需要同步其他的Eureka Server节点的数据,这里设置为false</span></span><br><span class="line"><span class="attr">    fetch-registry:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    service-url:</span></span><br><span class="line">      <span class="comment"># 设置Eureka Server的地址,查询服务和注册服务都需要依赖这个地址.默认是http://localhost:8761/eureka/;多个地址可使用','风格.</span></span><br><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://localhost:8761/eureka</span></span><br></pre></td></tr></table></figure></p><p>运行EurekaApplication，在浏览器输入<a href="http://localhost:8761/">http://localhost:8761/</a>，可以看到下面的页面，还没有任何服务。<br><img src="http://omh46px9n.bkt.clouddn.com/18-2-1/86723387.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列3——Eureka简介和原理</title>
      <link href="/2018/02/01/springcloud-series-3-Eureka-introduction-and-principle/"/>
      <url>/2018/02/01/springcloud-series-3-Eureka-introduction-and-principle/</url>
      
        <content type="html"><![CDATA[<h2 id="Eureka简介及原理"><a href="#Eureka简介及原理" class="headerlink" title="Eureka简介及原理"></a>Eureka简介及原理</h2><p>Eureka是Netflix开发的服务发现组件，本身是一个基于REST的服务。Spring Cloud将它集成在其子项目spring-cloud-netflix中，以实现Spring Cloud的服务发现功能。目前Eureka 项目相当活跃，代码更新相当频繁，目前最新的版本是1.5.5。Eureka 2.0也在紧锣密鼓地开发中，2.0将会带来更强的功能和更好的扩展性，但是由于还没有Release，故而不作讨论。</p><p>本文讲解的Spring Cloud Camden SR1所使用的Eureka版本是1.4.11，还是比较新的。同时有了Eureka 1.x的基础，未来上手Eureka 2.x也会比较容易。</p><p>Eureka的Github：<a href="https://github.com/Netflix/Eureka">https://github.com/Netflix/Eureka</a></p><h2 id="Region、Zone解析"><a href="#Region、Zone解析" class="headerlink" title="Region、Zone解析"></a>Region、Zone解析</h2><p>Eureka的官方文档对regin、zone几乎没有提及，由于概念抽象，新手很难理解。因此，在分析Eureka原理之前，我们先来了解一下region、zone、Eureka集群三者的关系，如图4-2。<br><img src="http://www.itmuch.com/images/4.4-2.png" alt=""><br>图4-2 region、zone、Eureka集群之间的关系</p><p>region和zone（或者Availability Zone）均是AWS的概念。在非AWS环境下，我们可以简单地将region理解为Eureka集群，zone理解成机房。这样图4-2就很好理解了——一个Eureka集群被部署在了zone1机房和zone2机房中。</p><p>对region和zone感兴趣的读者可前往<a href="http://blog.csdn.net/awschina/article/details/17639191">http://blog.csdn.net/awschina/article/details/17639191</a> 扩展阅读。Spring Cloud中默认的region是us-east-1 。<br><a id="more"></a></p><h2 id="Eureka架构"><a href="#Eureka架构" class="headerlink" title="Eureka架构"></a>Eureka架构</h2><p><img src="http://www.itmuch.com/images/4.4.png" alt=""><br>图4-3 Eureka架构图</p><p>图4-3是来自Eureka官方的架构图，大致描述了Eureka集群的工作过程。图中包含的组件非常多，可能比较难以理解，我们用通俗易懂的语言解释一下：</p><ul><li>Application Service 相当于本书中的服务提供者，Application Client相当于本书中的服务消费者；</li><li>ke Remote Call，可以简单理解为调用RESTful API；</li><li><p>us-east-1c、us-east-1d等都是zone，它们都属于us-east-1这个region；<br>由图可知，Eureka包含两个组件：Eureka Server 和 Eureka Client，它们的作用如下：</p></li><li><p>Eureka Client是一个Java客户端，用于简化与Eureka Server的交互；</p></li><li>Eureka Server提供服务发现的能力，各个微服务启动时，会通过Eureka Client向Eureka Server进行注册自己的信息（例如网络信息），Eureka Server会存储该服务的信息；</li><li>微服务启动后，会周期性地向Eureka Server发送心跳（默认周期为30秒）以续约自己的信息。如果Eureka Server在一定时间内没有接收到某个微服务节点的心跳，Eureka Server将会注销该微服务节点（默认90秒）；<br>每个Eureka Server同时也是Eureka Client，多个Eureka Server之间通过复制的方式完成服务注册表的同步；</li><li>Eureka Client会缓存Eureka Server中的信息。即使所有的Eureka Server节点都宕掉，服务消费者依然可以使用缓存中的信息找到服务提供者。</li></ul><p>综上，Eureka通过心跳检测、健康检查和客户端缓存等机制，提高了系统的灵活性、可伸缩性和可用性。</p><p>转载于<a href="http://www.itmuch.com/spring-cloud-1/">Spring Cloud第一篇 Eureka简介及原理</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列2——SpringCloud简介</title>
      <link href="/2018/02/01/springcloud-series-2-SpringCloud-introduction/"/>
      <url>/2018/02/01/springcloud-series-2-SpringCloud-introduction/</url>
      
        <content type="html"><![CDATA[<h2 id="Spring-Cloud简介"><a href="#Spring-Cloud简介" class="headerlink" title="Spring Cloud简介"></a>Spring Cloud简介</h2><p>Spring Cloud是一系列框架的有序集合。利用Spring Boot的开发模式简化了分布式系统基础设施的开发，如服务发现、注册、配置中心、消息总线、负载均衡、断路器、数据监控等（这里只简单的列了一部分），都可以用Spring Boot的开发风格做到一键启动和部署。Spring Cloud将目前比较成熟、经得起实际考验的服务框架组合起来，通过Spring Boot风格进行再封装，屏蔽掉了复杂的配置和实现原理，最终整合出一套简单易懂、易部署和易维护的分布式系统架构平台。</p><h2 id="Spring-Cloud组成"><a href="#Spring-Cloud组成" class="headerlink" title="Spring Cloud组成"></a>Spring Cloud组成</h2><p>Spring Cloud的子项目，大致可分成两类：</p><p>一类是对现有成熟框架Spring Boot的封装和抽象，也是数量最多的项目；</p><p>第二类是开发了一部分分布式系统的基础设施的实现，如Spring Cloud Stream就是kafka, ActiveMQ这样的角色。开发人员进行微服务的实践，第一类子项目就已经足够使用，如：</p><ul><li><p>Spring Cloud Netflix<br>　　是对Netflix开发的一套分布式服务框架的封装，包括服务的发现和注册，负载均衡、断路器、REST客户端、请求路由等。</p></li><li><p>Spring Cloud Config<br>　　将配置信息中央化保存, 配置Spring Cloud Bus可以实现动态修改配置文件。</p></li><li><p>Spring Cloud Bus<br>　　分布式消息队列，是对Kafka, MQ的封装。</p></li><li><p>Spring Cloud Security<br>　　对Spring Security的封装，并能配合Netflix使用。</p></li><li><p>Spring Cloud Zookeeper<br>　　对Zookeeper的封装，使之能配置其它Spring Cloud的子项目使用。</p></li><li><p>Spring Cloud Eureka<br>  Spring Cloud Eureka 是 Spring Cloud Netflix 微服务套件中的一部分，它基于Netflix Eureka 做了二次分装，主要负责完成微服务架构中的服务治理功能。</p></li></ul><a id="more"></a><h2 id="Spring-Cloud未来"><a href="#Spring-Cloud未来" class="headerlink" title="Spring Cloud未来"></a>Spring Cloud未来</h2><p>Spring Cloud为未来互联网企业提供分布式基础设施解决方案。同时，随着近几年微服务架构和Docker容器概念的火爆，也会让Spring Cloud在未来越来越“云”化的软件开发风格中立有一席之地，尤其是在目前五花八门的分布式解决方案中提供了标准化的、全站式的技术方案，有效推进服务端软件系统技术水平提升。</p><p>转载于<a href="http://www.jcodecraeer.com/a/chengxusheji/java/2017/1031/8663.html">http://www.jcodecraeer.com/a/chengxusheji/java/2017/1031/8663.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springcloud系列1——使用Springboot对外提供rest服务</title>
      <link href="/2018/02/01/springcloud-series-1-use-Springboot-to-support-outer-services/"/>
      <url>/2018/02/01/springcloud-series-1-use-Springboot-to-support-outer-services/</url>
      
        <content type="html"><![CDATA[<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>由于springclound基于Springboot，因此第一篇熟悉一下Springboot。<br>这里为了后面的演示，创建一个project，名为<code>microservice-spring-cloud</code>。<br>创建2个子模块：</p><ul><li>microservice-springcloud-user<br>  该模块提供用户查询功能</li><li>microservice-springcloud-movie<br>  该模块是电影模块，从microservice-springcloud-user模块查询用户信息。</li></ul><a id="more"></a><h2 id="microservice-spring-cloud"><a href="#microservice-spring-cloud" class="headerlink" title="microservice-spring-cloud"></a>microservice-spring-cloud</h2><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.springcloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>microserver-spring-cloud<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>microservice-springcloud-user<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>microservice-springcloud-movie<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/libs-milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>false<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="microservice-springcloud-user模块"><a href="#microservice-springcloud-user模块" class="headerlink" title="microservice-springcloud-user模块"></a>microservice-springcloud-user模块</h2><p>该模块使用Springboot，数据库使用h2内存数据库，数据库框架使用jpa。</p><p>application.yml:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 7902</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: microservice-springcloud-user</span><br><span class="line">  jpa:</span><br><span class="line">    generate-ddl: false</span><br><span class="line">    # 显示SQL</span><br><span class="line">    show-sql: true</span><br><span class="line">    format_sql: true</span><br><span class="line">    hibernate:</span><br><span class="line">      ddl-auto: none</span><br><span class="line">  datasource:</span><br><span class="line">    platform: h2</span><br><span class="line">    # 指定DDL脚本</span><br><span class="line">    schema: classpath:schema.sql</span><br><span class="line">    # 指定数据初始化脚本</span><br><span class="line">    data: classpath:data.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">loggin:</span><br><span class="line">  level:</span><br><span class="line">    root: INFO</span><br><span class="line">    org.hibernate: INFO</span><br><span class="line">    org.hibernate.type.descriptor.sql.BasicBinder: TRACE</span><br><span class="line">    org.hibernate.type.descriptor.sql.BasicExtractor: TRACE</span><br><span class="line">    com.tommy: DEBUG</span><br></pre></td></tr></table></figure></p><p>schema.sql:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">USER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> ;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">USER</span>(<span class="keyword">id</span> <span class="built_in">bigint</span> <span class="keyword">generated</span> <span class="keyword">BY</span> <span class="keyword">DEFAULT</span>  <span class="keyword">AS</span> <span class="keyword">IDENTITY</span> ,username <span class="built_in">VARCHAR</span>(<span class="number">32</span>),<span class="keyword">NAME</span> <span class="built_in">VARCHAR</span> (<span class="number">20</span>),balance <span class="built_in">DECIMAL</span>(<span class="number">10</span>,<span class="number">2</span>),PRIMARY <span class="keyword">KEY</span> (<span class="keyword">id</span>));</span><br></pre></td></tr></table></figure></p><p>data.sql:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">USER</span>(<span class="keyword">ID</span>,username,<span class="keyword">NAME</span> ,balance) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'user1'</span>,<span class="string">'张三'</span>,<span class="number">100.00</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">USER</span>(<span class="keyword">ID</span>,username,<span class="keyword">NAME</span> ,balance) <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'user2'</span>,<span class="string">'李四'</span>,<span class="number">100.00</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">USER</span>(<span class="keyword">ID</span>,username,<span class="keyword">NAME</span> ,balance) <span class="keyword">VALUES</span> (<span class="number">3</span>,<span class="string">'user3'</span>,<span class="string">'王五'</span>,<span class="number">100.00</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">USER</span>(<span class="keyword">ID</span>,username,<span class="keyword">NAME</span> ,balance) <span class="keyword">VALUES</span> (<span class="number">4</span>,<span class="string">'user4'</span>,<span class="string">'马六'</span>,<span class="number">100.00</span>);</span><br></pre></td></tr></table></figure></p><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>microservice-sample-provider<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>microservice-sample-provider<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>用户实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Column</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(BigDecimal balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>数据库操作类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tommy.springcloud.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">User</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>对外提供服务的Controller：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud.controller;</span><br><span class="line"><span class="keyword">import</span> com.tommy.springcloud.entity.User;</span><br><span class="line"><span class="keyword">import</span> com.tommy.springcloud.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserRepository userRepository;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/sample/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.userRepository.findOne(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>应用启动类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.springcloud;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Administrator</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceUserProviderApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MicroserviceUserProviderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动后，通过<a href="http://localhost:7902/sample/1">http://localhost:7902/sample/1</a>，即可查询用户id为1的用户信息。</p><h2 id="microservice-springcloud-movie模块"><a href="#microservice-springcloud-movie模块" class="headerlink" title="microservice-springcloud-movie模块"></a>microservice-springcloud-movie模块</h2><p>电影模块，从microservice-springcloud-user模块查询用户信息。</p><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.tommy.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>microservice-springcloud-movie<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>microservice-springcloud-movie<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.9.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>application.yml:<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7901</span></span><br></pre></td></tr></table></figure></p><p>用户实体类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.cloud.microservicemovie.entity;</span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal balance;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> balance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBalance</span><span class="params">(BigDecimal balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>MovieController<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.cloud.microservicemovie.controller;</span><br><span class="line"><span class="keyword">import</span> com.tommy.cloud.microservicemovie.entity.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MovieController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/movie/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findUserById</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.restTemplate.getForObject(<span class="string">"http://localhost:7902/sample/"</span> + id, User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>应用启动类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tommy.cloud.microservicemovie;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroserviceSampleConsumerApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MicroserviceSampleConsumerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动后，通过<a href="http://localhost:7901/movie/1">http://localhost:7901/movie/1</a>，即可查询用户id为1的用户信息。<br>至此，使用Springboot搭建的一个服务提供者和服务消费者模块就完成了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springcloud </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis常见问题</title>
      <link href="/2018/01/31/show-redis-client-list-ip/"/>
      <url>/2018/01/31/show-redis-client-list-ip/</url>
      
        <content type="html"><![CDATA[<h2 id="查看Redis连接数"><a href="#查看Redis连接数" class="headerlink" title="查看Redis连接数"></a>查看Redis连接数</h2><p>在Redis命令行执行<code>info clients</code><br>得到类似下面的结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">connected_clients:357 </span><br><span class="line">client_longest_output_list:0 </span><br><span class="line">client_biggest_input_buf:0 </span><br><span class="line">blocked_clients:0</span><br></pre></td></tr></table></figure></p><p>redis连接数过多的问题可以参考：<a href="http://blog.csdn.net/u013050593/article/details/56480358">处理redis连接数过多</a><br><a id="more"></a></p><h2 id="查询Redis客户端列表"><a href="#查询Redis客户端列表" class="headerlink" title="查询Redis客户端列表"></a>查询Redis客户端列表</h2><p>Redis操作很慢，网络正常，Redis连接数也还好。<br>使用<code>client list</code>查看Redis客户端分布，发现大量的Redis连接（同一个IP），且执行的都是keys命令，导致Redis命令执行缓慢。</p><p>Redis命令行常用命令参考：<a href="http://blog.csdn.net/xy18930914/article/details/51119175">Redis详解与常见问题解决方案</a>、<a href="http://blog.csdn.net/secretx/article/details/73498148">一行shell查看redis 连接数分布</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用jstack排查系统问题</title>
      <link href="/2018/01/31/use_stack_to_find_system_bugs/"/>
      <url>/2018/01/31/use_stack_to_find_system_bugs/</url>
      
        <content type="html"><![CDATA[<h2 id="jstack介绍"><a href="#jstack介绍" class="headerlink" title="jstack介绍"></a>jstack介绍</h2><p>jstack是java虚拟机自带的一种堆栈跟踪工具,用于生成java虚拟机当前时刻的线程快照。</p><p>生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等。 线程出现停顿的时候通过jstack来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做什么事情，或者等待什么资源。 如果java程序崩溃生成core文件，jstack工具可以用来获得core文件的java stack和native stack的信息，从而可以轻松地知道java程序是如何崩溃和在程序何处发生问题。</p><a id="more"></a><h2 id="使用jstack的一般步骤"><a href="#使用jstack的一般步骤" class="headerlink" title="使用jstack的一般步骤"></a>使用jstack的一般步骤</h2><h3 id="查找java进程id"><a href="#查找java进程id" class="headerlink" title="查找java进程id"></a>查找java进程id</h3><p><img src="http://omh46px9n.bkt.clouddn.com/18-1-31/16590401.jpg" alt=""><br>这里得到的进程ID是10226.</p><h3 id="找出最耗费CPU的线程"><a href="#找出最耗费CPU的线程" class="headerlink" title="找出最耗费CPU的线程"></a>找出最耗费CPU的线程</h3><p>可以使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.ps -Lfp pid</span><br><span class="line">2.ps -mp pid -o THREAD, tid, time</span><br><span class="line">3.top -Hp pid</span><br></pre></td></tr></table></figure></p><p>上面3者之一。这里使用第3种：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top -Hp 10226</span><br></pre></td></tr></table></figure></p><p><img src="http://omh46px9n.bkt.clouddn.com/18-1-31/70535887.jpg" alt=""></p><p>TIME列就是各个Java线程耗费的CPU时间，CPU时间最长的是线程ID为11149的线程，用<code>printf &quot;%x\n&quot; 11149</code>得到11149的十六进制值为2b8d，下面会用到。</p><h3 id="使用jstack输出进程10226的堆栈信息，然后根据线程ID的十六进制grep。"><a href="#使用jstack输出进程10226的堆栈信息，然后根据线程ID的十六进制grep。" class="headerlink" title="使用jstack输出进程10226的堆栈信息，然后根据线程ID的十六进制grep。"></a>使用jstack输出进程10226的堆栈信息，然后根据线程ID的十六进制grep。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack 10226 | grep 2b8d</span><br></pre></td></tr></table></figure><p>接下来就可以根据结果分析代码了。</p><p>或者直接在找出进程id后，使用<code>jstack -l 10226 &gt; 10226.txt</code>将进程的所有堆栈想信息输出到10226.txt文件。<br>然后分析10226.txt，找出有问题的代码修改。<br>比如：<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-31/32600343.jpg" alt=""><br>可以看到有问题的代码和行数。</p><p>参考：<a href="http://www.blogjava.net/jzone/articles/303979.html">线程的状态信息</a>、<a href="http://www.hollischuang.com/archives/110">Java命令学习系列（二）——Jstack</a>、<a href="http://kyfxbl.iteye.com/blog/1634910">执行jstack报Unable to open socket file错误</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jstack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>secureCRT安装、破解</title>
      <link href="/2018/01/28/secureCRT-unpack-and-use/"/>
      <url>/2018/01/28/secureCRT-unpack-and-use/</url>
      
        <content type="html"><![CDATA[<p>SecureCRT是最常用的终端仿真程序，简单的说就是Windows下登录UNIX或Liunx服务器主机的软件。本文讲解SecureCRT的安装、破解与使用。<br><a id="more"></a></p><h2 id="下载-amp-安装"><a href="#下载-amp-安装" class="headerlink" title="下载&amp;安装"></a>下载&amp;安装</h2><p>1.从<a href="https://pan.baidu.com/s/1dGMKJF7">https://pan.baidu.com/s/1dGMKJF7</a>下载<br>2.解压缩下载的文件，双击<code>scrt736-x64.exe</code>执行安装。</p><h2 id="破解"><a href="#破解" class="headerlink" title="破解"></a>破解</h2><p>1.打开<code>SecureCRT.7.3.keygen.exe</code>，点击<code>Patch</code>按钮，依次选择<code>SecureCRT.exe</code>和<code>LicenseHelper.exe</code><br>2.双击打开安装后的secureCRT，在<code>License Wizard</code>选择下一步，然后点击<code>Enter License Manually</code>按钮，然后依次填入注册机上的<code>Name</code>,<code>Company</code>，<code>Serial</code>，<code>License key</code>，<code>Issue date</code>，然后点击下一步，完成。如果输入完毕，点击下一步提示你的License不适用于该版本，在注册机上点<code>Generate</code>，重新生成License key，再次输入。</p><h2 id="PublicKey认证的设置"><a href="#PublicKey认证的设置" class="headerlink" title="PublicKey认证的设置"></a>PublicKey认证的设置</h2><p><img src="http://omh46px9n.bkt.clouddn.com/18-1-28/34019952.jpg" alt=""><br><code>Authentication</code>只选择<code>PublicKey</code>，点击<code>Properties</code><br>选择key文件，点击OK即可。<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-28/33079073.jpg" alt=""></p><p><div class="tip"><br>这里以JumpServer堡垒机为例说明。在JumpServer的WEB页面输入用户名，密码和手机动态口令，登入后，可以下载key文件。这里的Key文件即为上面PublicKey认证用到的文件。<br></div><br><img src="http://omh46px9n.bkt.clouddn.com/18-1-28/97122478.jpg" alt=""><br>点击<code>key</code>后面的下载，下载PublicKey文件。</p><h2 id="中文乱码问题"><a href="#中文乱码问题" class="headerlink" title="中文乱码问题"></a>中文乱码问题</h2><p><img src="http://omh46px9n.bkt.clouddn.com/18-1-28/69483979.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-1-28/67805093.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java代理设置</title>
      <link href="/2018/01/27/httpclient-proxy/"/>
      <url>/2018/01/27/httpclient-proxy/</url>
      
        <content type="html"><![CDATA[<p>本文主要讲述使用HttpClient时的代理设置。</p><h2 id="常见的设置代理的方法"><a href="#常见的设置代理的方法" class="headerlink" title="常见的设置代理的方法"></a>常见的设置代理的方法</h2><h3 id="使用系统代理配置"><a href="#使用系统代理配置" class="headerlink" title="使用系统代理配置"></a>使用系统代理配置</h3><p>可以通过下面的方式来分别设置HTTP代理，HTTPS代理和SOCKS代理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HTTP 代理，只能代理 HTTP 请求</span></span><br><span class="line">System.setProperty(<span class="string">"http.proxyHost"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">System.setProperty(<span class="string">"http.proxyPort"</span>, <span class="string">"9876"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// HTTPS 代理，只能代理 HTTPS 请求</span></span><br><span class="line">System.setProperty(<span class="string">"https.proxyHost"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">System.setProperty(<span class="string">"https.proxyPort"</span>, <span class="string">"9876"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// SOCKS 代理，支持 HTTP 和 HTTPS 请求</span></span><br><span class="line"><span class="comment">// 注意：如果设置了 SOCKS 代理就不要设 HTTP/HTTPS 代理</span></span><br><span class="line">System.setProperty(<span class="string">"socksProxyHost"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">System.setProperty(<span class="string">"socksProxyPort"</span>, <span class="string">"1080"</span>);</span><br></pre></td></tr></table></figure></p><p>这里有三点要说明：<br>1.系统默认先使用 HTTP/HTTPS 代理，如果既设置了 HTTP/HTTPS 代理，又设置了 SOCKS 代理，SOCKS 代理会起不到作用<br>2.由于历史原因，注意 socksProxyHost 和 socksProxyPort 中间没有小数点<br>3.HTTP 和 HTTPS 代理可以合起来缩写，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 同时支持代理 HTTP/HTTPS 请求</span></span><br><span class="line">System.setProperty(<span class="string">"proxyHost"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">System.setProperty(<span class="string">"proxyPort"</span>, <span class="string">"9876"</span>);</span><br></pre></td></tr></table></figure></p><h3 id="JVM-命令行参数"><a href="#JVM-命令行参数" class="headerlink" title="JVM 命令行参数"></a>JVM 命令行参数</h3><p>在VM arguments中填写参数：<code>-DproxyHost=127.0.0.1 -DproxyPort=9876</code></p><h2 id="HttpURLConnection-使用代理"><a href="#HttpURLConnection-使用代理" class="headerlink" title="HttpURLConnection 使用代理"></a>HttpURLConnection 使用代理</h2><p>HttpURLConnection 的 openConnection() 方法可以传入一个 Proxy 参数，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Proxy proxy = <span class="keyword">new</span> Proxy(Proxy.Type.HTTP, <span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">9876</span>));</span><br><span class="line">URL obj = <span class="keyword">new</span> URL(url);</span><br><span class="line">HttpURLConnection con = (HttpURLConnection) obj.openConnection(proxy);</span><br></pre></td></tr></table></figure></p><p>OK 了，就这么简单！</p><p>不仅如此，我们注意到 Proxy 构造函数的第一个参数为枚举类型 Proxy.Type.HTTP ，那么很显然，如果将其修改为 Proxy.Type.SOCKS 即可以使用 SOCKS 代理。</p><h2 id="HttpClient-使用代理"><a href="#HttpClient-使用代理" class="headerlink" title="HttpClient 使用代理"></a>HttpClient 使用代理</h2><p>由于 HttpClient 非常灵活，使用 HttpClient 来连接代理有很多不同的方法。最简单的方法莫过于下面这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HttpHost proxy = <span class="keyword">new</span> HttpHost(<span class="string">"127.0.0.1"</span>, <span class="number">9876</span>, <span class="string">"HTTP"</span>);</span><br><span class="line">CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">HttpGet request = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">CloseableHttpResponse response = httpclient.execute(proxy, request);</span><br></pre></td></tr></table></figure></p><h3 id="使用RequestConfig类"><a href="#使用RequestConfig类" class="headerlink" title="使用RequestConfig类"></a>使用RequestConfig类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient httpclient = HttpClients.createDefault();       </span><br><span class="line">HttpGet request = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line"> </span><br><span class="line">request.setConfig(</span><br><span class="line">    RequestConfig.custom()</span><br><span class="line">        .setProxy(<span class="keyword">new</span> HttpHost(<span class="string">"45.32.21.237"</span>, <span class="number">8888</span>, <span class="string">"HTTP"</span>))</span><br><span class="line">        .build()</span><br><span class="line">);</span><br><span class="line">         </span><br><span class="line">CloseableHttpResponse response = httpclient.execute(request);</span><br></pre></td></tr></table></figure><h3 id="使用RoutePlanner类"><a href="#使用RoutePlanner类" class="headerlink" title="使用RoutePlanner类"></a>使用RoutePlanner类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HttpHost proxy = <span class="keyword">new</span> HttpHost(<span class="string">"127.0.0.1"</span>, <span class="number">9876</span>, <span class="string">"HTTP"</span>);</span><br><span class="line">DefaultProxyRoutePlanner routePlanner = <span class="keyword">new</span> DefaultProxyRoutePlanner(proxy); </span><br><span class="line">CloseableHttpClient httpclient = HttpClients.custom()</span><br><span class="line">        .setRoutePlanner(routePlanner)</span><br><span class="line">        .build();</span><br><span class="line">HttpGet request = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">CloseableHttpResponse response = httpclient.execute(request);</span><br></pre></td></tr></table></figure><h2 id="使用系统代理"><a href="#使用系统代理" class="headerlink" title="使用系统代理"></a>使用系统代理</h2><p>怎么在程序中自动使用系统代理呢？</p><p>对于 HttpURLConnection 类来说，程序不用做任何变动，它会默认使用系统代理。但是 HttpClient 默认是不使用系统代理的，如果想让它默认使用系统代理，可以通过 SystemDefaultRoutePlanner 和 ProxySelector 来设置。示例代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SystemDefaultRoutePlanner routePlanner = <span class="keyword">new</span> SystemDefaultRoutePlanner(ProxySelector.getDefault());</span><br><span class="line">CloseableHttpClient httpclient = HttpClients.custom()</span><br><span class="line">        .setRoutePlanner(routePlanner)</span><br><span class="line">        .build();</span><br><span class="line">HttpGet request = <span class="keyword">new</span> HttpGet(url);     </span><br><span class="line">CloseableHttpResponse response = httpclient.execute(request);</span><br></pre></td></tr></table></figure></p><p>以上内容来自：<a href="http://www.aneasystone.com/archives/2015/12/java-and-http-using-proxy.html">Java 和 HTTP 的那些事（二） 使用代理</a></p><h2 id="使用shadowsocks的代理说明"><a href="#使用shadowsocks的代理说明" class="headerlink" title="使用shadowsocks的代理说明"></a>使用shadowsocks的代理说明</h2><p>我有一台香港的windows服务器，在上面搭建了Shadowsocks服务，本地浏览器测试正常，但程序中使用System.setProperty和RequestConfig的方式都无效。<br>最后使用RoutePlanner类成功。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Windows Server 上搭建Shadowsocks服务器</title>
      <link href="/2018/01/27/create-shadowsocks-server-on-windows/"/>
      <url>/2018/01/27/create-shadowsocks-server-on-windows/</url>
      
        <content type="html"><![CDATA[<p>这里是在windows上搭建Shadowsocks服务器，使用的是github上的<code>libQtShadowsocks</code>项目。<br>项目地址：<a href="https://github.com/shadowsocks/libQtShadowsocks">https://github.com/shadowsocks/libQtShadowsocks</a></p><a id="more"></a><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>一台可以翻墙的windows。</p><h2 id="下载libQtShadowsocks"><a href="#下载libQtShadowsocks" class="headerlink" title="下载libQtShadowsocks"></a>下载libQtShadowsocks</h2><p>从<a href="https://github.com/shadowsocks/libQtShadowsocks/releases">https://github.com/shadowsocks/libQtShadowsocks/releases</a>下载一个已经编译好的版本，这里是shadowsocks-libqss-v1.10.0-win64.7z，原来下载的是最新的2.0版本，结果用不了。<br>下载后解压到任意位置，里面就一个shadowsocks-libqss.exe文件。</p><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>在解压目录下创建2个文件，一个config.json，一个shadowsocks-server.bat。<br>config.json放置配置信息。<br>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">    &quot;server&quot;:&quot;0.0.0.0&quot;,  </span><br><span class="line">    &quot;server_port&quot;:8023,  </span><br><span class="line">    &quot;local_address&quot;:&quot;127.0.0.1&quot;,  </span><br><span class="line">    &quot;local_port&quot;:1080,  </span><br><span class="line">    &quot;password&quot;:&quot;wyvbboy&quot;,  </span><br><span class="line">    &quot;timeout&quot;:600,  </span><br><span class="line">    &quot;method&quot;:&quot;aes-256-cfb&quot;,  </span><br><span class="line">    &quot;http_proxy&quot;: false,  </span><br><span class="line">    &quot;auth&quot;: false  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>配置说明：<br><strong>server</strong><br>the address your server listens（服务器IP）<br><strong>local_address</strong><br>the address your local listens（本地代理地址）<br><strong>local_port</strong><br>local port（本地代理端口）（写之前创建的ss的端口）<br><strong>port_password</strong><br>password used for encryption(自己设定的服务器端口和密码)（自己可以随便设定）<br><strong>timeout</strong><br>in seconds（超时断开，以秒为单位）<br><strong>method</strong><br>default: “aes-256-cfb”, see Encryption（加密方式）<br><strong>fast_open</strong><br>use TCP_FASTOPEN, true / false（是否使用TCP）<br><strong>workers</strong><br>number of workers, available on Unix/Linux（这个只在Unix和Linux下有用，可不设置）。  </p><p>shadowsocks-server.bat内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@echo off</span><br><span class="line">shadowsocks-libqss.exe -c config.json -S</span><br></pre></td></tr></table></figure></p><h2 id="运行Shadowsocks服务"><a href="#运行Shadowsocks服务" class="headerlink" title="运行Shadowsocks服务"></a>运行Shadowsocks服务</h2><p>直接运行shadowsocks-server.bat即可运行Shadowsocks服务，你也可以在命令提示符进入软件目录，运行<code>shadowsocks-libqss.exe -c config.json -S</code>这行命令。</p><h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><p>这里使用的客户端为Shadowsocks，github地址：<a href="https://github.com/shadowsocks/shadowsocks-windows">https://github.com/shadowsocks/shadowsocks-windows</a>。<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-27/20320334.jpg" alt=""></p><div class="tip"><br>注意：要以PAC模式运行，如果选择全局模式，所有的访问都会使用shadowsocks；如果选择了PaC模式，则只有pac.txt中的网址才会使用shadowsocks。<br></div><br><img src="http://omh46px9n.bkt.clouddn.com/18-1-27/26369304.jpg" alt=""><br><br><div class="tip"><br>注意防火墙开通相应的端口。<br></div><h2 id="自定义规则"><a href="#自定义规则" class="headerlink" title="自定义规则"></a>自定义规则</h2><p>参考：<a href="http://honglu.me/2015/06/26/ShadowSocks%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99/">http://honglu.me/2015/06/26/ShadowSocks%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99/</a><br>从网上查阅的资料<br>编辑FGWList的用户规则<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-27/22145328.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/18-1-27/57076129.jpg" alt=""><br>但我本地最后从FGWList更新本地pac时报错了<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-27/88271228.jpg" alt=""></p><p>所以我是直接修改的pac.txt文件，在其中加入你想使用shadowsocks访问的网址，最后选择使用PAC模式即可。</p><h2 id="多用户"><a href="#多用户" class="headerlink" title="多用户"></a>多用户</h2><p>如果希望多个用户使用shadowsocks服务，使用下面的配置替换<code>password:xxx</code>部分。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;port_password&quot;: &#123;  </span><br><span class="line">   &quot;8381&quot;: &quot;foobar1&quot;,  </span><br><span class="line">   &quot;8382&quot;: &quot;foobar2&quot;,  </span><br><span class="line">   &quot;8383&quot;: &quot;foobar3&quot;,  </span><br><span class="line">   &quot;8384&quot;: &quot;foobar4&quot; </span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>更新于2018-05-31.<br>某天shadowsocks服务不能使用了。<br>server端日志：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2018-05-31 16:15:41.382 INFO: Connecting clients1.google.com:443 from 183.62.174.53:48977</span><br><span class="line">2018-05-31 16:15:44.649 INFO: Connecting clients1.google.com:443 from 183.62.174.53:49021</span><br><span class="line">2018-05-31 16:15:44.665 INFO: Connecting clients1.google.com:443 from 183.62.174.53:49032</span><br><span class="line">2018-05-31 16:15:50.803 INFO: Connecting clients1.google.com:443 from 183.62.174.53:49103</span><br><span class="line">2018-05-31 16:15:56.177 INFO: Connecting www.google.com:443 from 183.62.174.53:49199</span><br><span class="line">2018-05-31 16:15:56.185 INFO: Connecting www.google.com:443 from 183.62.174.53:49200</span><br><span class="line">2018-05-31 16:16:11.364 DEBUG: Local socket: The remote host closed the connection</span><br><span class="line">2018-05-31 16:16:14.637 DEBUG: Local socket: The remote host closed the connection</span><br><span class="line">2018-05-31 16:16:14.654 DEBUG: Local socket: The remote host closed the connection</span><br><span class="line">2018-05-31 16:16:20.794 DEBUG: Local socket: The remote host closed the connection</span><br><span class="line">2018-05-31 16:16:26.164 DEBUG: Local socket: The remote host closed the connection</span><br><span class="line">2018-05-31 16:16:26.172 DEBUG: Local socket: The remote host closed the connection</span><br></pre></td></tr></table></figure></p><p>更换了算法、端口还是不行，客户端更新版本也不行，最后更新服务端版本后ok了。这里使用的版本是：shadowsocks-libqss-v2.0.2-win64.7z。</p><p>PS：有问题先看看github上相关的Issues。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tesseract-ocr-demo</title>
      <link href="/2018/01/19/tesseract-ocr-demo/"/>
      <url>/2018/01/19/tesseract-ocr-demo/</url>
      
        <content type="html"><![CDATA[<h2 id="Tesseract-OCR验证码识别"><a href="#Tesseract-OCR验证码识别" class="headerlink" title="Tesseract-OCR验证码识别"></a>Tesseract-OCR验证码识别</h2><p>1.下载tesseract，目前最新版本tesseract-ocr-setup-3.05.01.exe；<br>2.安装，安装的时候勾选中文（如果要识别中文）；<br>3.配置环境变量。<br><strong>将安装目录配置到path中；</strong>将tessdata目录配置到TESSDATA_PREFIX环境变量；<br>4.重启电脑。（idea要重启电脑才能读取环境变量）<br>5.命令行测试。<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-11/99287105.jpg" alt=""><br>识别结果：<br><img src="http://omh46px9n.bkt.clouddn.com/18-1-11/39364801.jpg" alt=""><br>发现有些无关的东西。</p><p>6.测试代码（JAVA）：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** 验证码识别</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/1/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LJValideCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger log = Logger.getLogger(LJValideCode.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String LANG_OPTION = <span class="string">"-l"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String EOL = <span class="string">"/"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            String code = recognizeText(<span class="keyword">new</span> File(<span class="string">"D:/Work/helloworld/resources/validate/download/"</span>+i+<span class="string">".jpg"</span>));</span><br><span class="line">            System.out.println(code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> imageFile</span></span><br><span class="line"><span class="comment">     *            传入的图像文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 识别后的字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">recognizeText</span><span class="params">(File imageFile)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置输出文件的保存的文件目录</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        File outputFile = <span class="keyword">new</span> File(imageFile.getParentFile(), <span class="string">"output"</span>);</span><br><span class="line">        StringBuffer strB = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        List&lt;String&gt; cmd = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        cmd.add(<span class="string">"tesseract"</span>);</span><br><span class="line">        cmd.add(imageFile.getName());</span><br><span class="line">        cmd.add(outputFile.getName());</span><br><span class="line">        cmd.add(LANG_OPTION);</span><br><span class="line"><span class="comment">//      cmd.add("chi_sim");</span></span><br><span class="line">        cmd.add(<span class="string">"eng"</span>);</span><br><span class="line">        ProcessBuilder pb = <span class="keyword">new</span> ProcessBuilder();</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *Sets this process builder's working directory.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        pb.directory(imageFile.getParentFile());</span><br><span class="line">        pb.command(cmd);</span><br><span class="line">        <span class="keyword">for</span> (String string :cmd) &#123;</span><br><span class="line">            System.out.print(string + <span class="string">" "</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        pb.redirectErrorStream(<span class="keyword">true</span>);</span><br><span class="line">        Process process = pb.start();</span><br><span class="line">        <span class="comment">// tesseract.exe 1.jpg 1 -l chi_sim</span></span><br><span class="line">        <span class="comment">// Runtime.getRuntime().exec("tesseract.exe 1.jpg 1 -l chi_sim");</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * the exit value of the process. By convention, 0 indicates normal</span></span><br><span class="line"><span class="comment">         * termination.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"><span class="comment">//      System.out.println(cmd.toString());</span></span><br><span class="line">        <span class="keyword">int</span> w = process.waitFor();</span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span>)<span class="comment">// 0代表正常退出</span></span><br><span class="line">        &#123;</span><br><span class="line">            BufferedReader in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(</span><br><span class="line">                    <span class="keyword">new</span> FileInputStream(outputFile.getAbsolutePath() + <span class="string">".txt"</span>),</span><br><span class="line">                    <span class="string">"UTF-8"</span>));</span><br><span class="line">            String str;</span><br><span class="line">            <span class="keyword">while</span> ((str = in.readLine()) != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                strB.append(str).append(EOL);</span><br><span class="line">            &#125;</span><br><span class="line">            in.close();</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            String msg = <span class="string">""</span>;</span><br><span class="line">            BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(process.getInputStream()));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                msg += line;</span><br><span class="line">            &#125;</span><br><span class="line">            bufferedReader.close();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">new</span> File(outputFile.getAbsolutePath() + <span class="string">".txt"</span>).delete();</span><br><span class="line">        String result = <span class="string">""</span>;</span><br><span class="line">        String string = strB.toString();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;string.length();i++) &#123;</span><br><span class="line">            <span class="comment">// 这里识别的验证码是数字，实际识别后发现有一些无关的东西，所以这里过滤掉。</span></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNumeric(string.charAt(i)+<span class="string">""</span>)) &#123;</span><br><span class="line">                result += string.charAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="OCR识别训练"><a href="#OCR识别训练" class="headerlink" title="OCR识别训练"></a>OCR识别训练</h2><p><a href="http://blog.csdn.net/why200981317/article/details/48265621">http://blog.csdn.net/why200981317/article/details/48265621</a></p><h2 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h2><p>Tesseract-OCR识别中文与训练字库实例<br><a href="https://www.cnblogs.com/mafeng/p/8124159.html">https://www.cnblogs.com/mafeng/p/8124159.html</a><br><a href="https://www.cnblogs.com/wzben/p/5930538.html">https://www.cnblogs.com/wzben/p/5930538.html</a></p><p>Android Studio里面配置Tesseract<br><a href="http://www.cnblogs.com/wzben/p/5932331.html">http://www.cnblogs.com/wzben/p/5932331.html</a></p><p>基于Tesseract的身份证识别Android端应用<br><a href="http://www.cnblogs.com/wzben/p/5945071.html">http://www.cnblogs.com/wzben/p/5945071.html</a></p><p>tess4j识别图片中的文字<br><a href="http://blog.csdn.net/u012386311/article/details/60135355">http://blog.csdn.net/u012386311/article/details/60135355</a></p><p>JAVA识别身份证号码，H5识别身份证号码，tesseract-ocr识别（一）<br><a href="http://blog.csdn.net/hiredme/article/details/50894814">http://blog.csdn.net/hiredme/article/details/50894814</a></p><p>ocr智能图文识别 tess4j 图文，验证码识别<br><a href="https://www.cnblogs.com/cmyxn/p/6993422.html">https://www.cnblogs.com/cmyxn/p/6993422.html</a></p><p>商业：<br><a href="http://leadtools.gcpowertools.com.cn/products/ocr/">http://leadtools.gcpowertools.com.cn/products/ocr/</a></p><p>机器学习之验证码识别<br><a href="http://blog.csdn.net/Alis_xt/article/details/65627303">http://blog.csdn.net/Alis_xt/article/details/65627303</a></p><p>tesseract-ocr:<br>wiki:<a href="https://github.com/tesseract-ocr/tesseract/wiki/Data-Files">https://github.com/tesseract-ocr/tesseract/wiki/Data-Files</a></p><p>相关问题：<a href="https://github.com/tesseract-ocr/tesseract/wiki/FAQ">https://github.com/tesseract-ocr/tesseract/wiki/FAQ</a></p><p>提升识别的质量：<br><a href="https://github.com/tesseract-ocr/tesseract/wiki/ImproveQuality">https://github.com/tesseract-ocr/tesseract/wiki/ImproveQuality</a><br>上面提到Tesseract works best on images which have a DPI of at least 300 dpi, so it may be beneficial to resize images. </p><p>使用java修改图片DPI：<br><a href="http://blog.csdn.net/shakalin2008/article/details/78799671">http://blog.csdn.net/shakalin2008/article/details/78799671</a><br><a href="http://blog.csdn.net/chenweionline/article/details/2026855">http://blog.csdn.net/chenweionline/article/details/2026855</a></p><p>OCR学习及tesseract的一些测试<br><a href="http://blog.csdn.net/viewcode/article/details/7784600">http://blog.csdn.net/viewcode/article/details/7784600</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 验证码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP推送技术</title>
      <link href="/2018/01/17/http_push/"/>
      <url>/2018/01/17/http_push/</url>
      
        <content type="html"><![CDATA[<p>在一般的Web应用中，浏览器和服务器之间使用的是请求/响应的交互模式。浏览器发出请求，服务器根据收到的请求来生成相应的响应。浏览器再对收到的响应进行处理，展现给用户。响应的格式可能是 HTML、XML 或 JSON 等。为了防止页面整个刷新，引入了Ajax来实现页面的局部刷新。不过对于需要及时获取服务器数据的应用场景来说，使用Ajax轮询就不行了，服务器并不能在有新数据时主动推送给浏览器，只能等待浏览器的下一次请求到来后响应。</p><p>对于数据及时性要求比较高的应用来说，可以考虑的实现方式是：基于HTML5的WebSocket、基于HTML5的服务器推送事件（EventSource）、comet技术。</p><p>关于服务器数据推送的相关技术可以参考：<a href="https://www.ibm.com/developerworks/cn/web/1307_chengfu_serversentevent/">HTML5 服务器推送事件（Server-sent Events）实战开发</a>、<a href="https://www.cnblogs.com/magicsoar/p/3615080.html">html5利用websocket完成的推送功能（tomcat）</a>、<a href="http://tommy88.top/%2F2017%2F08%2F31%2FWeb-push-comet4j%2F">Web推送技术之comet4j使用</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推送技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>tess4j验证码识别</title>
      <link href="/2018/01/11/tess4j_demo/"/>
      <url>/2018/01/11/tess4j_demo/</url>
      
        <content type="html"><![CDATA[<p>tess4j验证码识别</p><h2 id="tess4j的安装和使用"><a href="#tess4j的安装和使用" class="headerlink" title="tess4j的安装和使用"></a>tess4j的安装和使用</h2><p>参考：<a href="https://www.cnblogs.com/cmyxn/p/6993422.html">https://www.cnblogs.com/cmyxn/p/6993422.html</a></p><h2 id="tess4j提高识别率"><a href="#tess4j提高识别率" class="headerlink" title="tess4j提高识别率"></a>tess4j提高识别率</h2><p>1.对称近邻均值滤波<br>参考：<a href="http://blog.csdn.net/fangbinwei93/article/details/50562449">http://blog.csdn.net/fangbinwei93/article/details/50562449</a></p><p>2.指定config为digits，并修改tessdata\configs\digits文件，将白名单中设置需要识别的内容。如只需要识别数字，则指定whitelist为0123456789即可。<br>也可在程序中指定：<br>参考<a href="http://blog.csdn.net/hellousb2010/article/details/39477859">http://blog.csdn.net/hellousb2010/article/details/39477859</a></p><p>3.尽量指定图像的一块区域识别。比如验证码起始位置和结束位置很多空白的，可以去掉，只对验证码区域做识别。</p><p>4.训练字库，提升识别率<br><a href="http://blog.csdn.net/white0blue/article/details/47972405">http://blog.csdn.net/white0blue/article/details/47972405</a><br><a href="http://blog.csdn.net/tuling_research/article/details/41091163">http://blog.csdn.net/tuling_research/article/details/41091163</a></p><h2 id="其他参考"><a href="#其他参考" class="headerlink" title="其他参考"></a>其他参考</h2><h3 id="tesseract-ocr参数"><a href="#tesseract-ocr参数" class="headerlink" title="tesseract-ocr参数"></a>tesseract-ocr参数</h3><p><a href="http://www.sk-spell.sk.cx/tesseract-ocr-parameters-in-302-version">http://www.sk-spell.sk.cx/tesseract-ocr-parameters-in-302-version</a></p><h3 id="使用百度的OCR识别"><a href="#使用百度的OCR识别" class="headerlink" title="使用百度的OCR识别"></a>使用百度的OCR识别</h3><p><a href="http://console.bce.baidu.com/ai/#/ai/ocr/overview/index">http://console.bce.baidu.com/ai/#/ai/ocr/overview/index</a><br><img src="http://omh46px9n.bkt.clouddn.com/18-1-19/4117096.jpg" alt=""><br>1天500次的免费调用，一般也足够使用了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 验证码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python博客搭建</title>
      <link href="/2018/01/10/Python_blog/"/>
      <url>/2018/01/10/Python_blog/</url>
      
        <content type="html"><![CDATA[<p>python搭建博客问题汇总</p><h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>python版本：2.7<br>web框架：Flask<br>orm框架：flask_sqlalchemy<br>前端框架：Bootstrap</p><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><h2 id="问题1：如何限制访问受保护的资源（需登录）"><a href="#问题1：如何限制访问受保护的资源（需登录）" class="headerlink" title="问题1：如何限制访问受保护的资源（需登录）"></a>问题1：如何限制访问受保护的资源（需登录）</h2><p>flask中拦截用户登录修饰符decorator的使用<br><a href="https://segmentfault.com/a/1190000006658289">https://segmentfault.com/a/1190000006658289</a><br><a href="http://blog.csdn.net/kongxx/article/details/51654751">http://blog.csdn.net/kongxx/article/details/51654751</a><br><a href="http://blog.csdn.net/kuangshp128/article/details/65629533">http://blog.csdn.net/kuangshp128/article/details/65629533</a><br><a id="more"></a></p><h2 id="问题2：如何书写Markdown格式的文章。"><a href="#问题2：如何书写Markdown格式的文章。" class="headerlink" title="问题2：如何书写Markdown格式的文章。"></a>问题2：如何书写Markdown格式的文章。</h2><p>flask markdown用法：<br><a href="http://blog.csdn.net/jhgjdfhre/article/details/52253630">http://blog.csdn.net/jhgjdfhre/article/details/52253630</a><br>说明一下：如果要代码语法高亮，参考：<a href="http://pythonhosted.org/Markdown/extensions/code_hilite.html">http://pythonhosted.org/Markdown/extensions/code_hilite.html</a><br>1.安装Pygments<br>2.使用<code>pygmentize -S default -f html -a .codehilite &gt; styles.css</code>生成styles.css<br>3.复制styles.css到你的工程中。</p><h2 id="问题3：flask框架数据库和页面分页"><a href="#问题3：flask框架数据库和页面分页" class="headerlink" title="问题3：flask框架数据库和页面分页"></a>问题3：flask框架数据库和页面分页</h2><p>flask数据分页：<br><a href="http://baagee.vip/index/article/id/63.html">http://baagee.vip/index/article/id/63.html</a><br><a href="https://www.jianshu.com/p/d5224b90afeb">https://www.jianshu.com/p/d5224b90afeb</a><br><a href="http://www.jb51.net/article/118715.htm">http://www.jb51.net/article/118715.htm</a></p><h2 id="问题4：Flask框架使用的模板引擎Jinja2用法。"><a href="#问题4：Flask框架使用的模板引擎Jinja2用法。" class="headerlink" title="问题4：Flask框架使用的模板引擎Jinja2用法。"></a>问题4：Flask框架使用的模板引擎Jinja2用法。</h2><p>Jinja2文档：<br><a href="http://docs.jinkan.org/docs/jinja2/templates.html">http://docs.jinkan.org/docs/jinja2/templates.html</a></p><h2 id="问题5：Flask框架Jinja2日期格式化"><a href="#问题5：Flask框架Jinja2日期格式化" class="headerlink" title="问题5：Flask框架Jinja2日期格式化"></a>问题5：Flask框架Jinja2日期格式化</h2><p>新建一个日期处理函数<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file:jinja_filter.py</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line">__author__ = <span class="string">'j.tommy'</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">datetimeformat</span><span class="params">(value, format=<span class="string">'%Y-%m-%d'</span>)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    将float类型的日期格式化为字符串格式。</span></span><br><span class="line"><span class="string">    :param value: 日期（float类型）</span></span><br><span class="line"><span class="string">    :param format: 日期格式</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    d = datetime.datetime.fromtimestamp(value)</span><br><span class="line">    <span class="keyword">print</span> d,type(d)</span><br><span class="line">    <span class="keyword">return</span> d.strftime(format)</span><br><span class="line">```    </span><br><span class="line">在app中指定过滤器</span><br><span class="line">```python</span><br><span class="line"><span class="comment"># 用于页面模板进行日期格式化</span></span><br><span class="line">app.jinja_env.filters[<span class="string">'datetimeformat'</span>] = jinja_filters.datetimeformat</span><br></pre></td></tr></table></figure></p><p>页面使用<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;blog.created_at|datetimeformat(<span class="string">'%Y-%m-%d %H:%M'</span>)&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>python博客代码：<a href="https://gitee.com/qincd/awesome-python-blog">https://gitee.com/qincd/awesome-python-blog</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>notepad++之python环境搭建</title>
      <link href="/2018/01/03/notepad-python/"/>
      <url>/2018/01/03/notepad-python/</url>
      
        <content type="html"><![CDATA[<p>参考<a href="http://blog.csdn.net/qianggezhishen/article/details/47379963">在Notepad++中搭配Python开发环境(修改版）</a><br>比如设置运行的快捷键为CTRL+SHIFT+F10.<br><a id="more"></a><br>python的插件式通过pip或easy_install安装的。安装插件前确保安装了pip或easy_install。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Git配置多个SSH-Key</title>
      <link href="/2018/01/02/Git-config-multi-SSH-Key/"/>
      <url>/2018/01/02/Git-config-multi-SSH-Key/</url>
      
        <content type="html"><![CDATA[<p>默认情况下，我们通过ssh-keygen -t rsa -C “<a href="mailto:XXXXXX@XXX.com">XXXXXX@XXX.com</a>”命令生成的ssh keys是在用户目录的.ssh目录（~/.ssh）中，一个id_rsa，一个id_rsa.pub。<br>然后一路回车，最后再.ssh目录即可看到id_rsa和id_rsa.pub。将id_rsa.pub文件内容复制并添加到github或gitlab的ssh key。<br>如果使用了github，同时使用了gitlab，就需要配置多个ssh key，并通过配置config文件用以区分多个ssh key。<br><a id="more"></a></p><p>参考：<a href="http://blog.csdn.net/birdben/article/details/51824788">http://blog.csdn.net/birdben/article/details/51824788</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>将项目迁移到gitlab</title>
      <link href="/2017/12/14/svn-to-git/"/>
      <url>/2017/12/14/svn-to-git/</url>
      
        <content type="html"><![CDATA[<p>1.在gitlab上建立project，得到一个git地址，如：<a href="http://192.168.74.90/xxx_sportSnatch/bt_receive.git。">http://192.168.74.90/xxx_sportSnatch/bt_receive.git。</a><br>在gitlib上可以看到2种，一种是ssh，一种是http的。我们后面使用git bash操作，使用http方式。</p><p>2.忽略不需要提交的文件<br>这里以idea为例，忽略target目录和.iml文件。<br>在bt_receive项目根目录创建.gitignore文件，文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.idea</span><br><span class="line">*.iml</span><br><span class="line">target</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>3.在项目所在目录（比如bt_receive）右键，git bash here。<br>会弹出一个git bash窗口<br>依次执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd bt_receive</span><br><span class="line">git init</span><br><span class="line">git add .</span><br><span class="line">git commit -m &apos;Initial commit&apos;</span><br><span class="line">git remote add origin http://192.168.74.90/hhly_sportSnatch/bt_receive.git</span><br><span class="line">git push origin master（这一步执行后提示输入用户名和密码，输入gitlab的用户名和密码即可）</span><br></pre></td></tr></table></figure></p><p>这样代码就会提交到git的master分支上。</p><p>4.删除gitlab上的文件<br>比如idea的打包目录target。这些是不需要上传到gitlab上的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git rm -r --cached -n &quot;target/&quot; #这一步不会删除，只会显示要删除的文件</span><br><span class="line">git rm -r --cached &quot;target/&quot; #这一步删除target目录</span><br><span class="line">git commit -m &apos;remove target folder&apos; #提交修改到本地仓库</span><br><span class="line">git push origin master # 推送到远程仓库</span><br></pre></td></tr></table></figure></p><p>注意：要安装git for windows</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>IDEA中git操作</title>
      <link href="/2017/12/13/idea-git-operate/"/>
      <url>/2017/12/13/idea-git-operate/</url>
      
        <content type="html"><![CDATA[<p>&lt;在IDEA中实战Git&gt;参考：<a href="http://blog.csdn.net/autfish/article/details/52513465">http://blog.csdn.net/autfish/article/details/52513465</a><br>包括了：</p><ul><li>创建项目并提交到远程Git仓库</li><li>从远程Git仓库上获取项目源码</li><li>提交修改到Git仓库</li><li>从Git仓库获取更新</li><li>创建分支，在分支上开发</li><li>分支合并到主干<a id="more"></a>&lt;IDEA中切换到某个分支&gt;<br>1.执行fetch/pull操作；<br>2.在右下角选择你要切换的分支<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-14/27714091.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-14/92975433.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-14/55868551.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-14/86803817.jpg" alt=""></li></ul><p>&lt;IDEA中checkout某个Tag&gt;<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-13/74205747.jpg" alt=""><br>切换到某个Tag，复制SHA<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-13/10984762.jpg" alt=""><br>在图1中粘贴<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-13/43703010.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-13/7848921.jpg" alt=""></p><p>也可参考：<a href="http://blog.csdn.net/zhang_guyuan/article/details/77160387">http://blog.csdn.net/zhang_guyuan/article/details/77160387</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java日期多线程处理</title>
      <link href="/2017/12/13/java-date-multithread/"/>
      <url>/2017/12/13/java-date-multithread/</url>
      
        <content type="html"><![CDATA[<p>java的DateFormat不是线程安全的，在多线程环境可能导致出现问题。</p><p>线程不安全的处理方式<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateFormat DATE_FORMAT = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);<span class="comment">//线程不安全</span></span><br></pre></td></tr></table></figure></p><p>问题参考：<a href="http://blog.csdn.net/zdp072/article/details/41044059">http://blog.csdn.net/zdp072/article/details/41044059</a></p><p>网上提到的几种替代方案：<br>1.每次new一个对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">parse</span><span class="params">(String date)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>).parse(date);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.通过ThreadLocal进行处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt; LOCAL_DATE_FORMAT = <span class="keyword">new</span> ThreadLocal&lt;DateFormat&gt;()&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> DateFormat <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>3.java8 通过 DateTimeFormatter 进行处理<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">LocalDateTime dateTime = LocalDateTime.parse(date, DATE_TIME_FORMATTER);</span><br><span class="line">LOCAL_DATE_FORMAT.get().parse(date);</span><br></pre></td></tr></table></figure></p><p>如果是JDK8的应用，可以使用instant代替Date，Localdatetime代替Calendar，Datetimeformatter代替Simpledateformatter，官方给出的解释：simple beautiful strong immutable thread-safe。</p><p>4.使用Joda-Time<br>Joda-Time 是一个很棒的开源的 JDK 的日期和日历 API 的替代品，其 DateTimeFormat 是线程安全而且不变的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DateTimeFormatter fmt = DateTimeFormat.forPattern(<span class="string">"yyyyMMdd"</span>); </span><br><span class="line">   <span class="function"><span class="keyword">public</span> Date <span class="title">convert</span><span class="params">(String source)</span></span>&#123;</span><br><span class="line">   DateTime d = fmt.parseDateTime(source);</span><br><span class="line">   returnd.toDate(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5.使用Apache commons-lang包下的DateUtils和DateFormatUtils处理。<br>参考：<a href="http://blog.csdn.net/marila4720/article/details/8468394">http://blog.csdn.net/marila4720/article/details/8468394</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows开启FTP服务</title>
      <link href="/2017/12/10/Windows-FTP/"/>
      <url>/2017/12/10/Windows-FTP/</url>
      
        <content type="html"><![CDATA[<h2 id="1-开启FTP服务"><a href="#1-开启FTP服务" class="headerlink" title="1.开启FTP服务"></a>1.开启FTP服务</h2><p>“控制面板”-》“程序和功能”-》“打开或关闭Windows功能”，在弹出的窗口中选择“Internet信息服务”，然后“确定”，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/70509703.jpg" alt=""><br><a id="more"></a></p><p>“计算机”-》右键-》“管理”<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/65082512.jpg" alt=""></p><h2 id="2-FTP共享文件夹"><a href="#2-FTP共享文件夹" class="headerlink" title="2.FTP共享文件夹"></a>2.FTP共享文件夹</h2><p><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/16374607.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/65930701.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/42550379.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/59629110.jpg" alt=""><br>然后点“完成”。</p><p>ftp://你的IP即可访问。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/72307632.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> FTP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty使用Protobuf编解码</title>
      <link href="/2017/12/10/Netty-Protobuf/"/>
      <url>/2017/12/10/Netty-Protobuf/</url>
      
        <content type="html"><![CDATA[<p>Protobuf是一个灵活、高效、结构化的数据序列化框架，相比于XML等传统的序列化工具，它更小、更快、更简单。Protobuf支持数据结构化一次可以到处使用，甚至跨语言使用，通过代码生成工具可以自动生成不同语言版本的源代码，甚至可以在使用不同版本的数据结构进程间进行数据传递，实现数据结构的前向兼容。</p><p>下面结合一个例子看看在Netty如何使用Protobuf对POJO对象进行编解码。</p><h2 id="1-Protobuf环境搭建"><a href="#1-Protobuf环境搭建" class="headerlink" title="1.Protobuf环境搭建"></a>1.Protobuf环境搭建</h2><p>从<a href="https://developers.google.com/protocol-buffers/docs/downloads下载Protobuf，本例中是3.0.0版本。">https://developers.google.com/protocol-buffers/docs/downloads下载Protobuf，本例中是3.0.0版本。</a></p><p>下载后对压缩包进行解压，在/bin目录可以看到protoc.exe。protoc.exe根据.proto文件生成代码。下面根据图书订购程序定义SubcribeReq.proto和SubcribeResp.proto文件。<br>SubcribeReq.proto文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package netty;</span><br><span class="line">option java_package = &quot;com.tommy.netty.protobuf&quot;;</span><br><span class="line">option java_outer_classname = &quot;SubcribeReqProto&quot;;</span><br><span class="line"></span><br><span class="line">message SubcribeReq &#123;</span><br><span class="line">int32 subReqID = 1;</span><br><span class="line">string userName = 2;</span><br><span class="line">string productName = 3;</span><br><span class="line">repeated string address = 4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>SubcribeResp.proto文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package netty;</span><br><span class="line">option java_package = &quot;com.tommy.netty.protobuf&quot;;</span><br><span class="line">option java_outer_classname = &quot;SubcribeRespProto&quot;;</span><br><span class="line"></span><br><span class="line">message SubcribeResp &#123;</span><br><span class="line">int32 subReqID = 1;</span><br><span class="line">int32 respCode = 2;</span><br><span class="line">string desc = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>通过protoc.exe生成代码。<br>进入到protoc.exe目录，分别执行：<br><code>protoc.exe --java_out=.\src .\netty\SubcribeReq.proto</code>和<code>protoc.exe --java_out=.\src .\netty\SubcribeResp.proto</code><br>在/bin目录的src目录中可以看到生成的文件。（注意：要提前创建好src目录）<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/49128754.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/97870455.jpg" alt=""></p><p>将生成的SubcribeReqProto.java和SubcribeRespProto.java复制到工程中。</p><p>在工程中导入protobuf3.0.0的包：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.google.protobuf/protobuf-java --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.protobuf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>protobuf-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><h2 id="2-Protobuf编解码开发"><a href="#2-Protobuf编解码开发" class="headerlink" title="2.Protobuf编解码开发"></a>2.Protobuf编解码开发</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/12/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSubcribeReqProto</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encode(SubcribeReqProto.SubcribeReq subcribeReq) &#123;</span><br><span class="line">        <span class="keyword">return</span> subcribeReq.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SubcribeReqProto.<span class="function">SubcribeReq <span class="title">decode</span><span class="params">(<span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SubcribeReqProto.SubcribeReq.parseFrom(body);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SubcribeReqProto.<span class="function">SubcribeReq <span class="title">createSubcribeReq</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SubcribeReqProto.SubcribeReq.Builder builder = SubcribeReqProto.SubcribeReq.newBuilder();</span><br><span class="line">        builder.setSubReqID(<span class="number">1</span>);</span><br><span class="line">        builder.setUserName(<span class="string">"j.tommy"</span>);</span><br><span class="line">        builder.setProductName(<span class="string">"Netty权威指南"</span>);</span><br><span class="line">        List&lt;String&gt; addressList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        addressList.add(<span class="string">"北京市"</span>);</span><br><span class="line">        addressList.add(<span class="string">"上海市"</span>);</span><br><span class="line">        addressList.add(<span class="string">"西安市"</span>);</span><br><span class="line">        addressList.add(<span class="string">"深圳市"</span>);</span><br><span class="line">        builder.addAllAddress(addressList);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvalidProtocolBufferException </span>&#123;</span><br><span class="line">        SubcribeReqProto.SubcribeReq req = createSubcribeReq();</span><br><span class="line">        System.out.println(<span class="string">"Before encode:"</span> + req);</span><br><span class="line">        SubcribeReqProto.SubcribeReq req2 = decode(encode(req));</span><br><span class="line">        System.out.println(<span class="string">"After decode:"</span> + req2);</span><br><span class="line">        System.out.println(<span class="string">"Assert equals:"</span> + req.equals(req2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过SubcribeReq的.newBuilder()创建Builder，通过Builder设置SubscribeReq的属性，最后通过builder.builder()方法生成对象。</p><p>编码时通过SubscribeReq的toByteArray()即可将SubcribeReq编码为直接数组。<br>解码时通过SubscribeReq的parseForm将二进制数组编码为SubscribeReq对象。</p><p>运行结果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/82964556.jpg" alt=""></p><h2 id="3-Netty的Protobuf订购程序开发"><a href="#3-Netty的Protobuf订购程序开发" class="headerlink" title="3.Netty的Protobuf订购程序开发"></a>3.Netty的Protobuf订购程序开发</h2><p>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/12/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubcribeServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        ServerBootstrap s = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        s.group(bossGroup,workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO))</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">100</span>)</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufDecoder(SubcribeReqProto.SubcribeReq.getDefaultInstance()));</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32LengthFieldPrepender());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> SubcribeServerHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture cf = s.bind(<span class="number">9989</span>).sync();</span><br><span class="line">            cf.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubcribeServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> SubcribeRespProto.<span class="function">SubcribeResp <span class="title">createSubcribeResp</span><span class="params">(<span class="keyword">int</span> subReqID)</span> </span>&#123;</span><br><span class="line">        SubcribeRespProto.SubcribeResp.Builder builder = SubcribeRespProto.SubcribeResp.newBuilder();</span><br><span class="line">        builder.setSubReqID(subReqID);</span><br><span class="line">        builder.setRespCode(<span class="number">0</span>);</span><br><span class="line">        builder.setDesc(<span class="string">"Order success."</span>);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SubcribeReqProto.SubcribeReq req = (SubcribeReqProto.SubcribeReq) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + req.getSubReqID() + <span class="string">",userName:"</span> + req.getUserName() + <span class="string">",productName:"</span> + req.getProductName());</span><br><span class="line">        SubcribeRespProto.SubcribeResp resp = createSubcribeResp(req.getSubReqID());</span><br><span class="line">        ctx.writeAndFlush(resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/12/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubcribleClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        b.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32FrameDecoder());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufDecoder(SubcribeRespProto.SubcribeResp.getDefaultInstance()));</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufVarint32LengthFieldPrepender());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> ProtobufEncoder());</span><br><span class="line">                        sc.pipeline().addLast(<span class="keyword">new</span> SubcribleClientHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.connect(<span class="string">"127.0.0.1"</span>, <span class="number">9989</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubcribleClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SubcribeReqProto.SubcribeReq req = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            req = createSubcribeReq(i);</span><br><span class="line">            ctx.write(req);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> SubcribeReqProto.<span class="function">SubcribeReq <span class="title">createSubcribeReq</span><span class="params">(<span class="keyword">int</span> subSeqID)</span> </span>&#123;</span><br><span class="line">        SubcribeReqProto.SubcribeReq.Builder builder = SubcribeReqProto.SubcribeReq.newBuilder();</span><br><span class="line">        builder.setSubReqID(subSeqID);</span><br><span class="line">        builder.setUserName(<span class="string">"j.tommy"</span>);</span><br><span class="line">        builder.setProductName(<span class="string">"netty权威指南"</span>);</span><br><span class="line">        List&lt;String&gt; addressList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        addressList.add(<span class="string">"北京市"</span>);</span><br><span class="line">        addressList.add(<span class="string">"西安市"</span>);</span><br><span class="line">        addressList.add(<span class="string">"深圳市"</span>);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SubcribeRespProto.SubcribeResp resp = (SubcribeRespProto.SubcribeResp) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span> + resp.getSubReqID() + <span class="string">",responseCode:"</span> + resp.getRespCode() + <span class="string">",desc:"</span> + resp.getDesc());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ProtobufVarint32FrameDecoder，它主要用来处理半包；</p><p>ProtobufDecoder解压器，它的参数是com.google.protobuf.MessageLite，实际上是告诉ProtobufDecoder需要解码的目标类是什么，否则仅仅从字节数组是无法知道要解码的目标类型信息的。</p><p>服务端中ProtobufEncoder用于对响应的SubcribeResp进行编码。</p><p>运行结果：<br>服务端：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/42748982.jpg" alt=""><br>客户端：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-10/56553006.jpg" alt=""></p><h2 id="4-Protobuf的使用注意事项"><a href="#4-Protobuf的使用注意事项" class="headerlink" title="4.Protobuf的使用注意事项"></a>4.Protobuf的使用注意事项</h2><p>ProtobufDecoder仅仅负责解码，它不支持读半包。因此在ProtobufDecoder的前面，一定要有能够处理半包消息的解码器。<br>有3种方式可以选择：<br>1.使用Netty提供的ProtobufVarint32FrameDecoder，它可以处理半包消息；<br>2.继承Netty提供的通用半包解码器LengthFieldBasedFrameDecoder;<br>3.继承ByteToMessageDecoder类，自己处理半包消息。</p><p>如果只使用ProtobufDecoder解码器，而忽略对半包消息的处理，程序没法正常工作。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
            <tag> Protobuf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java时区转换</title>
      <link href="/2017/12/10/java-timezone/"/>
      <url>/2017/12/10/java-timezone/</url>
      
        <content type="html"><![CDATA[<p>包括将世界标准时间转换为本地时间和将世界标准时间转换为目标时区的本地时间，以及将本地时间转换为世界标准时间。<br><a id="more"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/12/10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DateUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将世界标准时间转换为本地时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gmtDate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">convertGMT2Local</span><span class="params">(Date gmtDate)</span> </span>&#123;</span><br><span class="line">        Calendar c = Calendar.getInstance();</span><br><span class="line">        c.setTime(gmtDate);</span><br><span class="line">        <span class="keyword">int</span> zoneOffset = c.get(Calendar.ZONE_OFFSET);</span><br><span class="line">        <span class="keyword">int</span> dstOffset = c.get(Calendar.DST_OFFSET);</span><br><span class="line">        c.add(Calendar.MILLISECOND,zoneOffset+dstOffset);</span><br><span class="line">        <span class="keyword">return</span> c.getTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将世界标准时间转换为目标时区的本地时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> gmtDate</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">convertGMTToLocal</span><span class="params">(Date gmtDate, String id)</span> </span>&#123;</span><br><span class="line">        Calendar calendar = Calendar.getInstance(TimeZone.getTimeZone(<span class="string">"UTC"</span>));</span><br><span class="line">        calendar.setTime(gmtDate);</span><br><span class="line">        calendar.setTimeZone(TimeZone.getTimeZone(id));</span><br><span class="line">        <span class="keyword">int</span> zoneOffset = calendar.get(Calendar.ZONE_OFFSET);</span><br><span class="line">        <span class="keyword">int</span> dstOffset = calendar.get(Calendar.DST_OFFSET);</span><br><span class="line">        calendar.add(Calendar.MILLISECOND, dstOffset+zoneOffset);</span><br><span class="line">        <span class="keyword">return</span> calendar.getTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将本地时间转换为世界标准时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> date</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">convertToGMT</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Local Time Zone Calendar Instance</span></span><br><span class="line">        Calendar calendar = Calendar.getInstance();</span><br><span class="line">        calendar.setTime(date);</span><br><span class="line">        <span class="keyword">int</span> zoneOffset = calendar.get(Calendar.ZONE_OFFSET);</span><br><span class="line">        <span class="keyword">int</span> dstOffset = calendar.get(Calendar.DST_OFFSET);</span><br><span class="line">        calendar.add(Calendar.MILLISECOND, -(dstOffset+zoneOffset));</span><br><span class="line">        <span class="keyword">return</span> calendar.getTime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String gmtDateString = <span class="string">"2017-12-10T04:10:01.794Z"</span>;</span><br><span class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'"</span>);</span><br><span class="line">        SimpleDateFormat sdf2 = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Date gmtDate = sdf.parse(gmtDateString);</span><br><span class="line">            Date localDate = convertGMT2Local(gmtDate);</span><br><span class="line">            System.out.println(sdf2.format(localDate));</span><br><span class="line"><span class="comment">//            for (String id : TimeZone.getAvailableIDs()) &#123;</span></span><br><span class="line"><span class="comment">//                System.out.println(id);</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            localDate = convertGMTToLocal(gmtDate,<span class="string">"Asia/Hong_Kong"</span>);</span><br><span class="line">            System.out.println(sdf2.format(localDate));</span><br><span class="line">            gmtDate = convertToGMT(localDate);</span><br><span class="line">            System.out.println(sdf.format(gmtDate));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>参考：<a href="http://blog.csdn.net/calkee/article/details/50879383">http://blog.csdn.net/calkee/article/details/50879383</a><br><a href="http://blog.csdn.net/tjgykhulj/article/details/68953636">http://blog.csdn.net/tjgykhulj/article/details/68953636</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>log4j动态创建日志文件</title>
      <link href="/2017/12/10/log4j-create-dynamic-log-files/"/>
      <url>/2017/12/10/log4j-create-dynamic-log-files/</url>
      
        <content type="html"><![CDATA[<p>比如现在系统会给多个公司发送数据，现希望给每个公司的数据有单独的日志文件记录。由于公司名字是动态的没法在log4j配置文件中写死，这时就只能通过动态创建了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/12/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Log4jUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String,Logger&gt; loggerMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Logger&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Logger <span class="title">getLogger</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        Logger logger = loggerMap.get(name);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != logger) &#123;</span><br><span class="line">            <span class="keyword">return</span> logger;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createNewLogger(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Logger <span class="title">createNewLogger</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        Logger logger = Logger.getLogger(name);</span><br><span class="line">        logger.removeAllAppenders();</span><br><span class="line">        logger.setLevel(Level.DEBUG);</span><br><span class="line">        logger.setAdditivity(<span class="keyword">false</span>);</span><br><span class="line">        RollingFileAppender appender = <span class="keyword">new</span> RollingFileAppender();</span><br><span class="line">        PatternLayout layout = <span class="keyword">new</span> PatternLayout();</span><br><span class="line">        String conversionPatten = <span class="string">"[%d] %p %t %c - %m%n"</span>;</span><br><span class="line">        layout.setConversionPattern(conversionPatten);</span><br><span class="line">        appender.setLayout(layout);</span><br><span class="line">        String basePath = <span class="string">"/usr/logs/rb/"</span>;</span><br><span class="line">        appender.setFile(basePath + name + <span class="string">".log"</span>);</span><br><span class="line">        appender.setEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        appender.setMaxBackupIndex(<span class="number">10</span>);</span><br><span class="line">        appender.setMaxFileSize(<span class="string">"50MB"</span>);</span><br><span class="line">        appender.setAppend(<span class="keyword">true</span>);</span><br><span class="line">        appender.activateOptions();</span><br><span class="line">        logger.addAppender(appender);</span><br><span class="line">        loggerMap.put(name,logger);</span><br><span class="line">        <span class="keyword">return</span> logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><p>测试代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态生成日志文件名。</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/12/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicLogFileName</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        LogTestThread ltt1 = <span class="keyword">new</span> LogTestThread(<span class="string">"test1"</span>);</span><br><span class="line">        LogTestThread ltt2 = <span class="keyword">new</span> LogTestThread(<span class="string">"test2"</span>);</span><br><span class="line">        ltt1.start();</span><br><span class="line">        ltt2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogTestThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogTestThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Logger logger = Log4jUtil.getLogger(<span class="keyword">this</span>.name);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep((<span class="keyword">long</span>) (Math.random()*<span class="number">1500L</span>+<span class="number">1000L</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            logger.info(<span class="keyword">this</span>.getName() + <span class="string">" msg."</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 日志 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jQuery图表插件之plot</title>
      <link href="/2017/12/03/jQuery-plot/"/>
      <url>/2017/12/03/jQuery-plot/</url>
      
        <content type="html"><![CDATA[<p>使用参考：<a href="https://www.cnblogs.com/lwme/archive/2012/08/18/jquery-flot-plugin.html">https://www.cnblogs.com/lwme/archive/2012/08/18/jquery-flot-plugin.html</a></p><p>下面是一个显示内存和存储空间使用率的折线统计图<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- statistics chart built with jQuery Flot --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row chart"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h4</span> <span class="attr">class</span>=<span class="string">"clearfix"</span>&gt;</span></span><br><span class="line">        MQ内存和空间使用</span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"btn-group pull-right"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;button class="glow left"&gt;日&lt;/button&gt;</span></span><br><span class="line"><span class="comment">            &lt;button class="glow middle active"&gt;月&lt;/button&gt;</span></span><br><span class="line"><span class="comment">            &lt;button class="glow right"&gt;年&lt;/button&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"chartOpts"</span> <span class="attr">class</span>=<span class="string">"form-control"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">th:each</span>=<span class="string">"t:$&#123;mqConfigs&#125;"</span> <span class="attr">th:value</span>=<span class="string">"$&#123;t.serverIp&#125;"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;t.serverIp&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-12"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"statsChart"</span> <span class="attr">style</span>=<span class="string">"height: 500px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- end statistics chart --&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 切换服务器时，自动定时获取数据重绘</span></span><br><span class="line">$(<span class="string">'#chartOpts'</span>).on(<span class="string">'change'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> server = $(<span class="keyword">this</span>).val();</span><br><span class="line"><span class="keyword">if</span> (server != <span class="string">''</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (timerId) &#123;</span><br><span class="line">clearInterval(timerId);</span><br><span class="line">&#125;</span><br><span class="line">darwMqStatistics();</span><br><span class="line">timerId = setInterval(<span class="string">'darwMqStatistics()'</span>,<span class="number">60000</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> timerId;</span><br><span class="line"><span class="comment">// 鼠标移动到图表的点上时显示提示</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showTooltip</span>(<span class="params">x, y, contents</span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'&lt;div id="tooltip"&gt;'</span> + contents + <span class="string">'&lt;/div&gt;'</span>).css( &#123;</span><br><span class="line">            position: <span class="string">'absolute'</span>,</span><br><span class="line">            display: <span class="string">'none'</span>,</span><br><span class="line">            top: y - <span class="number">30</span>,</span><br><span class="line">            left: x - <span class="number">50</span>,</span><br><span class="line">            color: <span class="string">"#fff"</span>,</span><br><span class="line">            padding: <span class="string">'2px 5px'</span>,</span><br><span class="line">            <span class="string">'border-radius'</span>: <span class="string">'6px'</span>,</span><br><span class="line">            <span class="string">'background-color'</span>: <span class="string">'#000'</span>,</span><br><span class="line">            opacity: <span class="number">0.80</span></span><br><span class="line">        &#125;).appendTo(<span class="string">"body"</span>).fadeIn(<span class="number">200</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> previousPoint = <span class="literal">null</span>;</span><br><span class="line">    $(<span class="string">"#statsChart"</span>).bind(<span class="string">"plothover"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, pos, item</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (item) &#123;</span><br><span class="line">            <span class="keyword">if</span> (previousPoint != item.dataIndex) &#123;</span><br><span class="line">                previousPoint = item.dataIndex;</span><br><span class="line">                $(<span class="string">"#tooltip"</span>).remove();</span><br><span class="line">                <span class="keyword">var</span> x = item.datapoint[<span class="number">0</span>].toFixed(<span class="number">0</span>),</span><br><span class="line">                        y = item.datapoint[<span class="number">1</span>].toFixed(<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">var</span> xLabel = item.series.xaxis.ticks[item.dataIndex].label;</span><br><span class="line">                showTooltip(item.pageX, item.pageY,</span><br><span class="line">                        item.series.label + <span class="string">": "</span> + y + <span class="string">"%"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            $(<span class="string">"#tooltip"</span>).remove();</span><br><span class="line">            previousPoint = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">darwMqStatistics</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> serverIp = $(<span class="string">'#chartOpts'</span>).val();</span><br><span class="line">    $.<span class="keyword">get</span>(CTX+'/mqMonitor/getStatisticsData',&#123;serverIp:serverIp&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">r</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> storeUsed = r.data.storeUsed;</span><br><span class="line">        <span class="keyword">var</span> memoryUsed = r.data.memoryUsed;</span><br><span class="line">        <span class="keyword">var</span> xLabel = r.data.xLabel;</span><br><span class="line">        <span class="built_in">console</span>.log(storeUsed);</span><br><span class="line">        <span class="built_in">console</span>.log(memoryUsed);</span><br><span class="line">        <span class="built_in">console</span>.log(xLabel);</span><br><span class="line">        <span class="comment">// jQuery Flot Chart</span></span><br><span class="line">        <span class="keyword">var</span> plot = $.plot($(<span class="string">"#statsChart"</span>),</span><br><span class="line">            [ &#123; <span class="attr">data</span>: storeUsed, <span class="attr">label</span>: <span class="string">"存储空间使用百分比"</span>&#125;,</span><br><span class="line">                &#123; <span class="attr">data</span>: memoryUsed, <span class="attr">label</span>: <span class="string">"内存使用百分比"</span> &#125;], &#123;</span><br><span class="line">                series: &#123;</span><br><span class="line">                    lines: &#123; <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">                        lineWidth: <span class="number">1</span>,</span><br><span class="line">                        fill: <span class="literal">true</span>,</span><br><span class="line">                        fillColor: &#123; <span class="attr">colors</span>: [ &#123; <span class="attr">opacity</span>: <span class="number">0.1</span> &#125;, &#123; <span class="attr">opacity</span>: <span class="number">0.13</span> &#125; ] &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    points: &#123; <span class="attr">show</span>: <span class="literal">true</span>,</span><br><span class="line">                        lineWidth: <span class="number">2</span>,</span><br><span class="line">                        radius: <span class="number">3</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    shadowSize: <span class="number">0</span>,</span><br><span class="line">                    stack: <span class="literal">false</span> <span class="comment">/*如果有多条线要设置成false，否则最上面显示的那条线是下面所有线的value的和*/</span></span><br><span class="line">                &#125;,</span><br><span class="line">                grid: &#123; <span class="attr">hoverable</span>: <span class="literal">true</span>,</span><br><span class="line">                    clickable: <span class="literal">true</span>,</span><br><span class="line">                    tickColor: <span class="string">"#f9f9f9"</span>,</span><br><span class="line">                    borderWidth: <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                legend: &#123;</span><br><span class="line">                        show: <span class="literal">true</span>,</span><br><span class="line">                    labelBoxBorderColor: <span class="string">"#fff"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                colors: [<span class="string">"#a7b5c5"</span>, <span class="string">"#30a0eb"</span>],</span><br><span class="line">                xaxis: &#123;</span><br><span class="line">                    ticks: xLabel,</span><br><span class="line">                    font: &#123;</span><br><span class="line">                        size: <span class="number">12</span>,</span><br><span class="line">                        family: <span class="string">"Open Sans, Arial"</span>,</span><br><span class="line">                        variant: <span class="string">"small-caps"</span>,</span><br><span class="line">                        color: <span class="string">"#697695"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                yaxis: &#123;</span><br><span class="line">                    ticks:[[<span class="number">0</span>,<span class="string">'0'</span>],[<span class="number">10</span>,<span class="string">'10%'</span>],[<span class="number">20</span>,<span class="string">'20%'</span>],[<span class="number">30</span>,<span class="string">'30%'</span>],[<span class="number">40</span>,<span class="string">'40%'</span>],[<span class="number">50</span>,<span class="string">'50%'</span>],[<span class="number">60</span>,<span class="string">'60%'</span>],[<span class="number">70</span>,<span class="string">'70%'</span>],[<span class="number">80</span>,<span class="string">'80%'</span>],[<span class="number">90</span>,<span class="string">'90%'</span>],[<span class="number">100</span>,<span class="string">'100%'</span>]],</span><br><span class="line">                    font: &#123;<span class="attr">size</span>:<span class="number">12</span>, <span class="attr">color</span>: <span class="string">"#9da3a9"</span>&#125;,</span><br><span class="line">                    tickOptions: &#123;</span><br><span class="line">                        formatString: <span class="string">"'%.2f"</span>,</span><br><span class="line">                        showMark: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>效果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-12-3/5477413.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>httpclient之basic认证</title>
      <link href="/2017/12/02/httpclient-baisc-auth/"/>
      <url>/2017/12/02/httpclient-baisc-auth/</url>
      
        <content type="html"><![CDATA[<p>本文主要说明如何使用httpclient进行basic认证。</p><p>我们常用的登录是form形式，但也有的登录采用的basic认证，比如activeMq默认就是basic认证。</p><a id="more"></a><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> CloseableHttpClient <span class="title">getBasicHttpClient</span><span class="params">(String username,String password)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建HttpClientBuilder</span></span><br><span class="line">    HttpClientBuilder httpClientBuilder = HttpClientBuilder.create();</span><br><span class="line">    <span class="comment">// 设置BasicAuth</span></span><br><span class="line">    CredentialsProvider provider = <span class="keyword">new</span> BasicCredentialsProvider();</span><br><span class="line">    <span class="comment">// Create the authentication scope</span></span><br><span class="line">    AuthScope scope = <span class="keyword">new</span> AuthScope(AuthScope.ANY_HOST, AuthScope.ANY_PORT, AuthScope.ANY_REALM);</span><br><span class="line">    <span class="comment">// Create credential pair，在此处填写用户名和密码</span></span><br><span class="line">    UsernamePasswordCredentials credentials = <span class="keyword">new</span> UsernamePasswordCredentials(username,password);</span><br><span class="line">    <span class="comment">// Inject the credentials</span></span><br><span class="line">    provider.setCredentials(scope, credentials);</span><br><span class="line">    <span class="comment">// Set the default credentials provider</span></span><br><span class="line">    httpClientBuilder.setDefaultCredentialsProvider(provider);</span><br><span class="line">    <span class="comment">// HttpClient</span></span><br><span class="line">    CloseableHttpClient closeableHttpClient = httpClientBuilder.build();</span><br><span class="line">    <span class="keyword">return</span> closeableHttpClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Ok，获取到CloseableHttpClient后，其他的操作就简单了。<br>比如想通过httpclient访问ActiveMQ的首页的内容，<a href="http://192.168.74.135:8161/admin。">http://192.168.74.135:8161/admin。</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HttpGet get = <span class="keyword">new</span> HttpGet(<span class="string">"http://192.168.74.135:8161/admin"</span>);</span><br><span class="line">CloseableHttpResponse response = getBasicHttpClient(<span class="string">"admin"</span>,<span class="string">"admin"</span>).execute(get);</span><br><span class="line">System.out.println(EntityUtils.toString(response.getEntity));</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> httpclient </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>art-template日期格式化</title>
      <link href="/2017/11/30/art-template-dateformat/"/>
      <url>/2017/11/30/art-template-dateformat/</url>
      
        <content type="html"><![CDATA[<p>使用art-template我们避免了N多的字符串拼接，但遇到日期格式化该如何处理呢？</p><p>我们定义一个处理日期格式化的JS函数，放到一个单独的文件dateformate.js。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对日期进行格式化，</span></span><br><span class="line"><span class="comment"> * @param date 要格式化的日期</span></span><br><span class="line"><span class="comment"> * @param format 进行格式化的模式字符串</span></span><br><span class="line"><span class="comment"> *     支持的模式字母有：</span></span><br><span class="line"><span class="comment"> *     y:年,</span></span><br><span class="line"><span class="comment"> *     M:年中的月份(1-12),</span></span><br><span class="line"><span class="comment"> *     d:月份中的天(1-31),</span></span><br><span class="line"><span class="comment"> *     h:小时(0-23),</span></span><br><span class="line"><span class="comment"> *     m:分(0-59),</span></span><br><span class="line"><span class="comment"> *     s:秒(0-59),</span></span><br><span class="line"><span class="comment"> *     S:毫秒(0-999),</span></span><br><span class="line"><span class="comment"> *     q:季度(1-4)</span></span><br><span class="line"><span class="comment"> * @return String</span></span><br><span class="line"><span class="comment"> * @author yanis.wang</span></span><br><span class="line"><span class="comment"> * @see http://yaniswang.com/frontend/2013/02/16/dateformat-performance/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dateFormat</span>(<span class="params">date, format</span>) </span>&#123;</span><br><span class="line">    date = <span class="keyword">new</span> <span class="built_in">Date</span>(date);</span><br><span class="line">    <span class="keyword">var</span> map = &#123;</span><br><span class="line">        <span class="string">"M"</span>: date.getMonth() + <span class="number">1</span>, <span class="comment">//月份</span></span><br><span class="line">        <span class="string">"d"</span>: date.getDate(), <span class="comment">//日</span></span><br><span class="line">        <span class="string">"h"</span>: date.getHours(), <span class="comment">//小时</span></span><br><span class="line">        <span class="string">"m"</span>: date.getMinutes(), <span class="comment">//分</span></span><br><span class="line">        <span class="string">"s"</span>: date.getSeconds(), <span class="comment">//秒</span></span><br><span class="line">        <span class="string">"q"</span>: <span class="built_in">Math</span>.floor((date.getMonth() + <span class="number">3</span>) / <span class="number">3</span>), <span class="comment">//季度</span></span><br><span class="line">        <span class="string">"S"</span>: date.getMilliseconds() <span class="comment">//毫秒</span></span><br><span class="line">    &#125;;</span><br><span class="line">    format = format.replace(<span class="regexp">/([yMdhmsqS])+/g</span>, <span class="function"><span class="keyword">function</span>(<span class="params">all, t</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> v = map[t];</span><br><span class="line">        <span class="keyword">if</span>(v !== <span class="literal">undefined</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(all.length &gt; <span class="number">1</span>)&#123;</span><br><span class="line">                v = <span class="string">'0'</span> + v;</span><br><span class="line">                v = v.substr(v.length<span class="number">-2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> v;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(t === <span class="string">'y'</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> (date.getFullYear() + <span class="string">''</span>).substr(<span class="number">4</span> - all.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> all;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> format;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>使用：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// art-template日期格式化</span></span><br><span class="line">template.defaults.imports.dateFormat = dateFormat;</span><br></pre></td></tr></table></figure></p><p>在页面先定义模板html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"mqMonitorRecordTemplate"</span> <span class="attr">type</span>=<span class="string">"text/html"</span>&gt;</span></span><br><span class="line">    &#123;&#123;each list item index&#125;&#125;</span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;index+1&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item['serverIp']&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=#dateFormat(item['createTime'],'yyyy</span>/<span class="attr">MM</span>/<span class="attr">dd</span> <span class="attr">hh:mm</span>')%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item['type']&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;item['reason']&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></span><br><span class="line">    &#123;&#123;/each&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>在<code>&lt;script&gt;</code>中先编译上面的模板<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> render = template.compile($(<span class="string">'#mqMonitorRecordTemplate'</span>).html());</span><br></pre></td></tr></table></figure></p><p>使用（一个分页的例子）：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mqMonitorRecordSearch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> pageNo = $(<span class="string">'[name=pageNo]'</span>).val();</span><br><span class="line">    <span class="keyword">var</span> data = &#123;</span><br><span class="line">        serverIp: $(<span class="string">'[name=serverIp]'</span>).val(),</span><br><span class="line">        type: $(<span class="string">'[name=type]'</span>).val()</span><br><span class="line">    &#125;;</span><br><span class="line">    $.<span class="keyword">get</span>('[[$&#123;ctx&#125;]]/mqMonitor/search/<span class="string">' + pageNo,data,function(r) &#123;</span></span><br><span class="line"><span class="string">        if (r.returnCode == 0) &#123;</span></span><br><span class="line">            $('#mqMonitorRecordTbl tbody').html(render(r.data.pager)); // 这行代码是使用模板渲染，获取渲染后的html，设置到tbody。</span><br><span class="line">            $(<span class="string">'#DataTables_Table_1_paginate'</span>).html(r.data.pageHtml);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            layer.alert(r.errMsg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot单元测试</title>
      <link href="/2017/11/30/SpringBoot-unittest/"/>
      <url>/2017/11/30/SpringBoot-unittest/</url>
      
        <content type="html"><![CDATA[<h2 id="常规的Service和DAO的测试"><a href="#常规的Service和DAO的测试" class="headerlink" title="常规的Service和DAO的测试"></a>常规的Service和DAO的测试</h2><p>在SpringBoot里添加单元测试是非常简单的一件事，我们只需要添加SpringBoot单元测试的依赖jar，然后再添加两个注解就可搞定了。</p><p>首先我们来添加单元测试所需要的jar<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>接着我们写了一个单元测试的demo<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)  </span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = FirstExample.class)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> <span class="keyword">extends</span> <span class="title">BaseTestService</span></span>&#123;  </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> PersonService personService;  </span><br><span class="line">    <span class="meta">@Test</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSys</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        System.out.println(personService.getPersonDomain().toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后我们run一下，一个单元测试就搞定了。<br><a id="more"></a></p><p>另外：@RunWith和@SprintBootTest这两个注解上都有@Inherited这个注解，所以我们可以定义一个单元测的父类，然后所有的单元测试类继承这个父类就行了。如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)  </span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = FirstExample.class)  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTestService</span> </span>&#123;  </span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> <span class="keyword">extends</span> <span class="title">BaseTestService</span></span>&#123;  </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    <span class="keyword">private</span> PersonService personService;  </span><br><span class="line">    <span class="meta">@Test</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSys</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">        System.out.println(personService.getPersonDomain().toString());  </span><br><span class="line">    &#125;  </span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如果你用的SpringBoot是1.4.0之前的话，所用的注解稍有不同。你需要把@SpringBootTest注解换成@SpringApplicationConfiguration和@WebAppConfiguration。<br>出处：<a href="https://www.2cto.com/kf/201611/569221.html">https://www.2cto.com/kf/201611/569221.html</a></p><h2 id="controller测试"><a href="#controller测试" class="headerlink" title="controller测试"></a>controller测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringJUnit4ClassRunner.class)</span><br><span class="line"><span class="comment">//@SpringApplicationConfiguration(classes = MockServletContext.class)//这个测试单个controller，不建议使用</span></span><br><span class="line"><span class="meta">@SpringApplicationConfiguration</span>(classes = Application.class)<span class="comment">//这里的Application是springboot的启动类名。</span></span><br><span class="line"><span class="meta">@WebAppConfiguration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext context;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"> <span class="comment">//       mvc = MockMvcBuilders.standaloneSetup(new TestController()).build();</span></span><br><span class="line">        mvc = MockMvcBuilders.webAppContextSetup(context).build();<span class="comment">//建议使用这种</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mvc.perform(MockMvcRequestBuilders.get(<span class="string">"/data/getMarkers"</span>)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">                .param(<span class="string">"lat"</span>, <span class="string">"123.123"</span>).param(<span class="string">"lon"</span>, <span class="string">"456.456"</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(MockMvcResultMatchers.status().isOk())</span><br><span class="line">                .andDo(MockMvcResultHandlers.print())</span><br><span class="line">                .andExpect(MockMvcResultMatchers.content().string(Matchers.containsString(<span class="string">"SUCCESS"</span>)));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.springboot单元测试保存和修改数据，发现数据库并没有更改。<br>原因：Springboot单元测试默认设置的事务自动回滚，需要通过注解@Rollback(false)设置不回滚。<br><a href="http://blog.csdn.net/qq_32002237/article/details/78044172">http://blog.csdn.net/qq_32002237/article/details/78044172</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring结合activemq消息过期配置</title>
      <link href="/2017/11/23/spring-activemq-overtime-msg/"/>
      <url>/2017/11/23/spring-activemq-overtime-msg/</url>
      
        <content type="html"><![CDATA[<p>包括queue和topic的消息过期配置。发送消息使用的spring-jms提供的JmsTemplate。</p><p>queue的配置<br>设置pubSubDomain为false，默认即为false。需要将explicitQosEnabled设置为true，过期时间要生效依赖它。timeToLive即为过期时间，本例中设置的是10秒过期。</p><p>topic的配置<br>设置pubSubDomain为true，表示是发布订阅模式。explicitQosEnabled设置为true，timeToLive设置过期时间。</p><a id="more"></a><h2 id="spring结合ActiveMQ过期消息"><a href="#spring结合ActiveMQ过期消息" class="headerlink" title="spring结合ActiveMQ过期消息"></a>spring结合ActiveMQ过期消息</h2><p>完整的spring配置文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:jms</span>=<span class="string">"http://www.springframework.org/schema/jms"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms.xsd"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"propertyConfigurer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"fileEncoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"locations"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>classpath:mq.properties<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.connection.CachingConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>JMS连接工厂<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"targetConnectionFactory"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.spring.ActiveMQConnectionFactory"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.brokerURL&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.userName&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.password&#125;"</span>/&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;property name="trustAllPackages" value="true"/&gt;--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useAsyncSend"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useDedicatedTaskRunner"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"optimizeAcknowledge"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"producerWindowSize"</span> <span class="attr">value</span>=<span class="string">"1024000"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sessionCacheSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;mq.sessionCacheSize&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsQueueTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>PTP模式模型<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultDestination"</span> <span class="attr">ref</span>=<span class="string">"destinationQueue"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pubSubDomain"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"deliveryPersistent"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 发送模式  DeliveryMode.NON_PERSISTENT=1:非持久 ; DeliveryMode.PERSISTENT=2:持久，可以不配置，默认就是持久--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"deliveryMode"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"explicitQosEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeToLive"</span> <span class="attr">value</span>=<span class="string">"10000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTopicTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>发布/订阅模式模型<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"connectionFactory"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultDestination"</span> <span class="attr">ref</span>=<span class="string">"destinationTopic"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pubSubDomain"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"deliveryPersistent"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 发送模式  DeliveryMode.NON_PERSISTENT=1:非持久 ; DeliveryMode.PERSISTENT=2:持久--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"deliveryMode"</span> <span class="attr">value</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"explicitQosEnabled"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeToLive"</span> <span class="attr">value</span>=<span class="string">"10000"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"destinationTopic"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"test.topic"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"destinationQueue"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"test.queue"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>发送代码示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"spring-jms-producer.xml"</span>);</span><br><span class="line">    JmsTemplate j = (JmsTemplate) ac.getBean(<span class="string">"jmsTopicTemplate"</span>);</span><br><span class="line">    j.send(<span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> session.createTextMessage(<span class="string">"hello,world"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    System.out.println(<span class="string">"消息发送完毕"</span>);</span><br><span class="line">    System.exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>queue和topic的发送一样，不再赘述。</p><p>发送消息后<br>对于queue，在Activemq Console的queues中可以看到Messages Enqueued数量加1<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-23/77525188.jpg" alt=""><br>10秒后，Messages Dequeued中加1，同时ActiveMQ.DLQ（即死信队列）中加1.<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-23/54245365.jpg" alt=""></p><p>对于topic，可以看到Pending Queue Size加1.<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-23/23091184.jpg" alt=""><br>10秒后，Pending Queue Size减1.<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-23/48587761.jpg" alt="">,，同时ActiveMQ.DLQ中加1.<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-23/47673662.jpg" alt=""></p><h2 id="死信队列消息的处理"><a href="#死信队列消息的处理" class="headerlink" title="死信队列消息的处理"></a>死信队列消息的处理</h2><p>死信队列的消息来源包括2部分：<br>1.过期的消息，如上面的例子；<br>2.客户端消息处理异常，导致MQ反复重新发送，最终达到阀值（默认为6次），放入死信队列。</p><p>对于第1点<br>如果有大量的消息，或消费者消费的太慢，或订阅者offline，会导致死信队列存在大量的过期消息。最终可能会导致磁盘爆满。<br>解决方法：<br>1.监听死信队列<br>这样我们可以知道哪些数据处理失败，同时因为消费了消息，死信队列中的消息减少，这样避免了磁盘爆满。</p><p>2.过期的消息不放到死信队列。<br>在activemq.xml中的<broker>增加一个策略：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span> <span class="attr">expireMessagesPeriod</span>=<span class="string">"30000"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharedDeadLetterStrategy</span> <span class="attr">processExpired</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>expireMessagesPeriod=30000表示每隔30秒检查是否过期<br>processExpired为false表示不保存过期消息到死信队列，为true则是保留。<br>参考<a href="http://ask.csdn.net/questions/376817">http://ask.csdn.net/questions/376817</a><br>ActiveMQ消息策略：<a href="http://blog.csdn.net/wangtaomtk/article/details/51531354">http://blog.csdn.net/wangtaomtk/article/details/51531354</a></p><p>对于第2点<br>可以将重新投递的次数设置小一些，因为1次处理异常，多次也是一样。</p><h2 id="更多ActiveMQ使用和优化"><a href="#更多ActiveMQ使用和优化" class="headerlink" title="更多ActiveMQ使用和优化"></a>更多ActiveMQ使用和优化</h2><p>Spring+ActiveMQ消息持久化，Topic持久化订阅<br><a href="http://blog.csdn.net/u014756827/article/details/77896930">http://blog.csdn.net/u014756827/article/details/77896930</a></p><p>activemq性能优化：<br><a href="http://blog.csdn.net/yinwenjie/article/details/50991443">http://blog.csdn.net/yinwenjie/article/details/50991443</a></p><p>ActiveMQ讯息传送机制以及ACK机制<br><a href="http://www.oschina.net/question/2854673_2190316?sort=time">http://www.oschina.net/question/2854673_2190316?sort=time</a></p><p>消息预取限制：activeMQ　消息量限制　与　性能<br><a href="http://www.360doc.com/content/11/1027/19/1542811_159668819.shtml">http://www.360doc.com/content/11/1027/19/1542811_159668819.shtml</a></p><p>ActiveMQ消息策略<br><a href="http://blog.csdn.net/wangtaomtk/article/details/51531354">http://blog.csdn.net/wangtaomtk/article/details/51531354</a></p><p>折腾ActiveMQ时遇到的问题和解决方法<br><a href="http://blog.163.com/_kid/blog/static/3040547620161634230453/">http://blog.163.com/_kid/blog/static/3040547620161634230453/</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ActiveMQ处理积压的消息</title>
      <link href="/2017/11/22/ActiveMQ-delete-overtime-queue-topic/"/>
      <url>/2017/11/22/ActiveMQ-delete-overtime-queue-topic/</url>
      
        <content type="html"><![CDATA[<h2 id="为持久化消息设置过期时间"><a href="#为持久化消息设置过期时间" class="headerlink" title="为持久化消息设置过期时间"></a>为持久化消息设置过期时间</h2><p>ActiveMQ提供了一个timeStampingBrokerPlugin插件，通过此插件，我们可以为持久化消息设置过期时间。参考：<a href="http://activemq.apache.org/timestampplugin.html">http://activemq.apache.org/timestampplugin.html</a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 86,400,000 ms = 1 day --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">timeStampingBrokerPlugin</span> <span class="attr">ttlCeiling</span>=<span class="string">"86400000"</span> <span class="attr">zeroExpirationOverride</span>=<span class="string">"86400000"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>zeroExpirationOverride会为没有设置过期时间的消息设置过期时间。ttlCeiling表示过期时间上限，如果程序中设置的过期时间超过此值，以此值为准。</p><h2 id="配置消息过期丢弃策略"><a href="#配置消息过期丢弃策略" class="headerlink" title="配置消息过期丢弃策略"></a>配置消息过期丢弃策略</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">borker</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--expireMessagesPeriod=60000表示每隔60s检查消息是否过期--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--topic=&gt;表示对所有topic都生效--&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"&gt;"</span> <span class="attr">expireMessagesPeriod</span>=<span class="string">"60000"</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--processExpired为false表示过期消息不进入死信队列，即执行删除操作--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharedDeadLetterStrategy</span> <span class="attr">processExpired</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">borker</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="删除空的Queue和Topic"><a href="#删除空的Queue和Topic" class="headerlink" title="删除空的Queue和Topic"></a>删除空的Queue和Topic</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.apache.org/schema/core"</span> <span class="attr">schedulePeriodForDestinationPurge</span>=<span class="string">"10000"</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">  <span class="tag">&lt;<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">policyMap</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"&gt;"</span> <span class="attr">gcInactiveDestinations</span>=<span class="string">"true"</span> <span class="attr">inactiveTimoutBeforeGC</span>=<span class="string">"30000"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">policyEntries</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">policyMap</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">destinationPolicy</span>&gt;</span></span><br><span class="line">       </span><br><span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span><br></pre></td></tr></table></figure><p>schedulePeriodForDestinationPurge：执行清理任务的周期；<br>gcInactiveDestinations=true：表示启用清理功能；<br>inactiveTimoutBeforeGC：queue或topic的超时时间，在规定的时间内，无有效订阅，没有入队记录，超时后就会被清理。<br>参考：<a href="http://activemq.apache.org/delete-inactive-destinations.html">http://activemq.apache.org/delete-inactive-destinations.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mybatis对CLOB类型的处理</title>
      <link href="/2017/11/19/mybatis-clob/"/>
      <url>/2017/11/19/mybatis-clob/</url>
      
        <content type="html"><![CDATA[<p>mybatis插入时，当插入clob类型时报错，ORA-01461:仅能绑定要插入LONG列的LONG值。<br>mapper文件SQL如下<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;insert id="addDutyPost" parameterType="dp"&gt;</span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> sds_duty_post(<span class="keyword">id</span>,title,<span class="keyword">content</span>,creator,create_date)</span><br><span class="line">    <span class="keyword">select</span> SEQ_SDS_DUTY_POST.NEXTVAL,<span class="comment">#&#123;title,jdbcType=VARCHAR&#125;,#&#123;content,jdbcType=CLOB&#125;,#&#123;creator,jdbcType=VARCHAR&#125;,sysdate</span></span><br><span class="line">    <span class="keyword">from</span> dual <span class="keyword">where</span> <span class="keyword">not</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="string">'x'</span> <span class="keyword">from</span> sds_duty_post <span class="keyword">where</span> title=<span class="comment">#&#123;title&#125;)</span></span><br><span class="line">&lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure></p><p>这个SQL在长度&lt;4000时，工作正常；大于4000，会提示ORA-01461.<br>在插入时指定了jdbcType=CLOB，但仍然不奏效。</p><a id="more"></a><p>在网上查了很久，有可能问题是出现在当从dual中取数据时，会将clob对象的字段转为Long型。<br>所以改写一下SQL<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;select id="selPostByTitle" parameterType="string" resultType="dp"&gt;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">as</span> postid,title,<span class="keyword">content</span>,creator,create_date,updator,update_date <span class="keyword">from</span> sds_duty_post <span class="keyword">where</span> title=<span class="comment">#&#123;value&#125;</span></span><br><span class="line">&lt;/<span class="keyword">select</span>&gt;</span><br><span class="line">&lt;<span class="keyword">insert</span> <span class="keyword">id</span>=<span class="string">"addDutyPost"</span> parameterType=<span class="string">"dp"</span>&gt;</span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> sds_duty_post(<span class="keyword">id</span>,title,<span class="keyword">content</span>,creator,create_date)</span><br><span class="line">    <span class="keyword">values</span> (SEQ_SDS_DUTY_POST.NEXTVAL,<span class="comment">#&#123;title,jdbcType=VARCHAR&#125;,#&#123;content,jdbcType=CLOB&#125;,#&#123;creator,jdbcType=VARCHAR&#125;,sysdate)</span></span><br><span class="line">&lt;/<span class="keyword">insert</span>&gt;</span><br></pre></td></tr></table></figure></p><p>我这里分成了2个SQL，selPostByTitle用来实现根据title查询记录，addDutyPost用来添加记录。只是最开始的SQL是合二为一。<br>拆分后问题即解决，查询不需要指定jdbcType=CLOB。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Netty对POJO对象进行序列化</title>
      <link href="/2017/11/18/netty-pojo-serialiazation/"/>
      <url>/2017/11/18/netty-pojo-serialiazation/</url>
      
        <content type="html"><![CDATA[<p>使用JDK的ObjectInputStream和ObjectOutputStream可以实现java对象的序列化和反序列化（只要被序列化的POJO对象实现Serializable接口）。</p><p>在不需要考虑跨语言，并且对序列化的性能要去不苛刻时，JDK默认的序列化机制是最明智的选择之一。</p><p>下面的例子中，我们使用Netty的ObjectDecoder和ObjectEncoder对请求和应答对象进行序列化。<br><a id="more"></a><br>请求对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeReq</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> subReqId;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscribeReq</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscribeReq</span><span class="params">(<span class="keyword">int</span> subReqId, String userName, String productName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subReqId = subReqId;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">        <span class="keyword">this</span>.productName = productName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSubReqId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> subReqId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSubReqId</span><span class="params">(<span class="keyword">int</span> subReqId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subReqId = subReqId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProductName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductName</span><span class="params">(String productName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.productName = productName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SubscribeReq&#123;"</span> +</span><br><span class="line">                <span class="string">"subReqId="</span> + subReqId +</span><br><span class="line">                <span class="string">", userName='"</span> + userName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", productName='"</span> + productName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>应答对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscribeResp</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> subReqId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> respCode;</span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscribeResp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscribeResp</span><span class="params">(<span class="keyword">int</span> subReqId, <span class="keyword">int</span> respCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subReqId = subReqId;</span><br><span class="line">        <span class="keyword">this</span>.respCode = respCode;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SubscribeResp</span><span class="params">(<span class="keyword">int</span> subReqId, <span class="keyword">int</span> respCode, String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subReqId = subReqId;</span><br><span class="line">        <span class="keyword">this</span>.respCode = respCode;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"SubscribeResp&#123;"</span> +</span><br><span class="line">                <span class="string">"subReqId="</span> + subReqId +</span><br><span class="line">                <span class="string">", respCode="</span> + respCode +</span><br><span class="line">                <span class="string">", desc='"</span> + desc + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>服务端<br>在ChannelPipeline中增加ObjectDecoder解码器和ObjectEncoder编码器，并对要进行java序列化的对象实现Serialzable接口。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubReqServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        b.group(bossGroup,workerGroup).channel(NioServerSocketChannel.class).option(ChannelOption.SO_BACKLOG,<span class="number">1024</span>).childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> ObjectDecoder(<span class="number">1024</span>*<span class="number">1024</span>, ClassResolvers.weakCachingConcurrentResolver(<span class="keyword">this</span>.getClass().getClassLoader())));</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> ObjectEncoder());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> SubReqServerHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">9988</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubReqServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SubscribeReq subscribeReq = (SubscribeReq) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + subscribeReq);</span><br><span class="line">        ctx.writeAndFlush(resp(subscribeReq.getSubReqId()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> SubscribeResp <span class="title">resp</span><span class="params">(<span class="keyword">int</span> subReqId)</span> </span>&#123;</span><br><span class="line">        SubscribeResp subscribeResp = <span class="keyword">new</span> SubscribeResp(subReqId,<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> subscribeResp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubReqClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        b.group(group).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY,<span class="keyword">true</span>).handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> ObjectDecoder(<span class="number">1024</span>*<span class="number">1024</span>, ClassResolvers.cacheDisabled(<span class="keyword">this</span>.getClass().getClassLoader())));</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> ObjectEncoder());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> SubReqClientHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.connect(<span class="string">"127.0.0.1"</span>,<span class="number">9988</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubReqClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        cause.printStackTrace();</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 链路激活后，向服务端发送10条订购信息</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            SubscribeReq subscribeReq = <span class="keyword">new</span> SubscribeReq(i,<span class="string">"tommy"</span>,<span class="string">"Netty权威指南"</span>);</span><br><span class="line">            ctx.write(subscribeReq);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SubscribeResp subscribeResp = (SubscribeResp) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span>  + subscribeResp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行结果：<br>服务端<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-18/76598766.jpg" alt=""><br>客户端<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-18/27651857.jpg" alt=""></p><p>ObjectDecoder负责对实现了Serialzable接口的POJO对象进行解码，它有多个构造函数，支持不同的ClassResolver。<br>服务端使用的是weakCachingConcurrentResolver，创建线程安全的WeakReferenceMap对类加载器进行缓存，它支持多线程并发访问。当虚拟机内存不足时，会释放缓存中的内存。<br>客户端使用的是cacheDisabled，禁止对类加载器进行缓存，它在基于OSGi的动态模块化编程中经常使用。由于OSGi的bundle可以进行热部署和热升级，当某个bundle升级后，它对应的类加载器也将一起升级，因此在动态模块化编程中，很少对类加载器进行缓存，因为它随时可能发生变化。<br>为了防止异常码流和解码错位导致的内存溢出，这里将单个对象的最大序列化后的字节数设置为1M。</p><p>ObjectEncoder负责将实现了Serialzable接口的POJO对象进行编码，用户对对象手动进行序列化，关注于自己的业务即可。<br>对象的序列化和反序列化都由Netty的ObjectDecoder和ObjectEncoder来搞定。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty固定长度解码器</title>
      <link href="/2017/11/18/Netty-fix-length-decoder/"/>
      <url>/2017/11/18/Netty-fix-length-decoder/</url>
      
        <content type="html"><![CDATA[<p>FixedLengthFrameDecoder是固定长度解码器，它根据指定的长度自动对消息进行解码，开发者不需要考虑TCP拆包/粘包问题。<br>下面通过一个例子进行说明。</p><p>服务端：<br>在服务端的ChannelPipleline中增加FixedLengthFrameDecoder，长度设置为20，然后依次增加字符串解码器和自定义的EchoServerHandler。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用FixedLengthFrameDecoder解码器解决TCP粘包/拆包问题。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        b.group(bossGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> FixedLengthFrameDecoder(<span class="number">20</span>)); <span class="comment">// 固定长度解码器，长度设置为20</span></span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> EchoServerHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">8899</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String body = (String) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + body + <span class="string">",counter="</span> + ++counter);</span><br><span class="line">        <span class="comment">// 响应客户端</span></span><br><span class="line">        ByteBuf resp = Unpooled.copiedBuffer(body.getBytes());</span><br><span class="line">        ctx.write(resp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端：<br>在客户端的ChannelPipleline中增加FixedLengthFrameDecoder，长度设置为20，然后依次增加字符串解码器和自定义的EchoClientHandler。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        b.group(group).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY,<span class="keyword">true</span>).handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> FixedLengthFrameDecoder(<span class="number">20</span>));</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> EchoClientHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.connect(<span class="string">"127.0.0.1"</span>,<span class="number">8899</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String req = <span class="string">"hello,this message is from client."</span>;</span><br><span class="line">        ByteBuf sendBuf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123;</span><br><span class="line">            sendBuf = Unpooled.copiedBuffer(req.getBytes());</span><br><span class="line">            ctx.writeAndFlush(sendBuf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String resp = (String) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span>  + resp + <span class="string">",counter="</span> + ++counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>示例中，客户端发送的消息是hello,this message is from client.<br>因为按照固定长度截取，所以服务端接收到的是这样的：<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-18/41553604.jpg" alt=""></p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DelimiterBasedFrameDecoder解决TCP粘包拆包问题</title>
      <link href="/2017/11/17/netty-DelimiterBasedFrameDecoder-use/"/>
      <url>/2017/11/17/netty-DelimiterBasedFrameDecoder-use/</url>
      
        <content type="html"><![CDATA[<p>通过对DelimiterBasedFrameDecoder的使用，我们可以自动完成分隔符为结束标识的消息的解码。</p><p>下面的例子中，将$_作为分隔符。</p><a id="more"></a><p>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用DelimiterBasedFrameDecoder解码器解决TCP粘包/拆包问题。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> String DELIMITER = <span class="string">"$_"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        b.group(bossGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class)</span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>)</span><br><span class="line">                .handler(<span class="keyword">new</span> LoggingHandler(LogLevel.INFO))</span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        ByteBuf delimiter = Unpooled.copiedBuffer(DELIMITER.getBytes());</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> DelimiterBasedFrameDecoder(<span class="number">1024</span>,delimiter)); <span class="comment">// 这里的1024标识单条消息的最大长度，如果达到长度后仍然没有读取到分隔符，就抛出TooLongFrameException，防止由于异常码流缺失导致的内存溢出，这是Netty解码器的可靠性保护；第二个参数是分隔符</span></span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> EchoServerHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">8899</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String body = (String) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + body + <span class="string">",counter="</span> + ++counter);</span><br><span class="line">        <span class="comment">// 响应客户端</span></span><br><span class="line">        body += EchoServer.DELIMITER;</span><br><span class="line">        ByteBuf resp = Unpooled.copiedBuffer(body.getBytes());</span><br><span class="line">        ctx.write(resp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">static</span> String DELIMITER = <span class="string">"$_"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        b.group(group).channel(NioSocketChannel.class).option(ChannelOption.TCP_NODELAY,<span class="keyword">true</span>).handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                ByteBuf delimiter = Unpooled.copiedBuffer(DELIMITER.getBytes());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> DelimiterBasedFrameDecoder(<span class="number">1024</span>,delimiter));</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">                socketChannel.pipeline().addLast(<span class="keyword">new</span> EchoClientHandler());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.connect(<span class="string">"127.0.0.1"</span>,<span class="number">8899</span>).sync();</span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EchoClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String req = <span class="string">"hello,this message is from client."</span>+EchoClient.DELIMITER;</span><br><span class="line">        ByteBuf sendBuf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123;</span><br><span class="line">            sendBuf = Unpooled.copiedBuffer(req.getBytes());</span><br><span class="line">            ctx.writeAndFlush(sendBuf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String resp = (String) msg;</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span>  + resp + <span class="string">",counter="</span> + ++counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Netty解决TCP粘包-拆包问题</title>
      <link href="/2017/11/17/netty-tcp/"/>
      <url>/2017/11/17/netty-tcp/</url>
      
        <content type="html"><![CDATA[<h2 id="TCP粘包和拆包"><a href="#TCP粘包和拆包" class="headerlink" title="TCP粘包和拆包"></a>TCP粘包和拆包</h2><p>TCP底层并不知道上层业务数据的具体含义，它会根据缓冲区的实际情况进行包的拆分，所以在业务上认为，一个完整的包可能会被TCP拆分成多个包进行发送，也有可能将多个小的数据包封装成一个大的数据包发送，这就是所谓的TCP粘包/拆包问题。</p><h2 id="TCP粘包-拆包的原因"><a href="#TCP粘包-拆包的原因" class="headerlink" title="TCP粘包/拆包的原因"></a>TCP粘包/拆包的原因</h2><p>1.应用程序写入的字节大小大于套接字发送缓冲区大小；<br>2.进行MSS大小的TCP分段；<br>3.以太网帧的payload大于MTU进行IP分片。</p><h2 id="解决策略"><a href="#解决策略" class="headerlink" title="解决策略"></a>解决策略</h2><p>由于底层的TCP协议无法理解上层业务数据，所以在底层是无法保证数据包不被拆分和重组的。只能通过上层的业务协议栈设计来解决，根据业务的主流 协议的解决方案，归纳为如下：<br>（1）消息定长，例如每个报文的大小定位200字节，如果不够，空位补空格；<br>（2）包结尾增加回车换行符进行分割，例如FTP协议；<br>（3）将消息分为消息头和消息体，消息头中包含标识消息的总长度（或者消息体长度）的字段，通常涉及思路是消息头的第一个字段使用int32来表示消息的总长度；<br>（4）更复杂的应用层协议。<br><a id="more"></a></p><h2 id="未考虑TCP粘包导致的功能异常案例"><a href="#未考虑TCP粘包导致的功能异常案例" class="headerlink" title="未考虑TCP粘包导致的功能异常案例"></a>未考虑TCP粘包导致的功能异常案例</h2><p>服务端代码片段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ByteBuf类似于JDK中的ByteBuffer，但提供更强大跟灵活的功能</span></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        <span class="keyword">byte</span>[] req = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()]; <span class="comment">// 根据缓冲区可读字节数构建字节数组</span></span><br><span class="line">        buf.readBytes(req); <span class="comment">// 将缓冲区的直接数组复制到req</span></span><br><span class="line">        String body = <span class="keyword">new</span> String(req, <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + body + <span class="string">",counter:"</span> + ++counter);</span><br><span class="line">        <span class="comment">// 如果接受到的消息时Server Time，则异步将服务端当前时间发送给客户端。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(body)) &#123;</span><br><span class="line">            ByteBuf resp = Unpooled.copiedBuffer((<span class="keyword">new</span> Date()).toString().getBytes());</span><br><span class="line">            <span class="comment">// 这里write方法只是将数据写入缓冲区，并没有真正发送</span></span><br><span class="line">            ctx.write(resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 将缓冲区的数据写入SocketChannel</span></span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里增加了counter来统计接收到报文的数量。</p><p>客户端代码片段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuf msgSendBuf;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeClientHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 链路建立成功后，将Server Time请求发送给服务端</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123; <span class="comment">// 这里循环发送100次请求</span></span><br><span class="line">            <span class="comment">// 待发送数据</span></span><br><span class="line">            String req = <span class="string">"Server Time"</span>;</span><br><span class="line">            msgSendBuf = Unpooled.copiedBuffer(req.getBytes());</span><br><span class="line">            ctx.writeAndFlush(msgSendBuf);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 接收服务端响应</span></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        <span class="keyword">byte</span>[] resp = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(resp);</span><br><span class="line">        String response = <span class="keyword">new</span> String(resp, <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span> + response + <span class="string">",counter:"</span> + ++counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端在连接上服务端后，循环发送100条报文。在Handler类中增加了counter来统计接收到的服务器响应的次数。</p><p>运行结果如下：<br>服务端<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-17/68864170.jpg" alt=""></p><p>客户端：<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-17/57646709.jpg" alt=""><br>可以看到服务端只接收到2次，客户端并没有接收到服务端的响应。<br>服务端只接收到2次的原因是发生了TCP粘包，第1次接收的报文长度是1024。<br>客户端没有接收到服务器响应是因为由于发送了粘包，导致不符合服务端响应的条件。</p><h2 id="使用LineBasedFrameDecoder和StringDecoder解决粘包"><a href="#使用LineBasedFrameDecoder和StringDecoder解决粘包" class="headerlink" title="使用LineBasedFrameDecoder和StringDecoder解决粘包"></a>使用LineBasedFrameDecoder和StringDecoder解决粘包</h2><p>服务端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    socketChannel.pipeline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">1024</span>));</span><br><span class="line">    socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">    socketChannel.pipeline().addLast(<span class="keyword">new</span> TimeServerHandler());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>增加了LineBasedFrameDecoder和StringDecoder解码器。</p><p>TimeServerHandler的channelRead方法修改：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String body = (String) msg;</span><br><span class="line">    System.out.println(<span class="string">"接收到客户端请求："</span> + body + <span class="string">",counter:"</span> + ++counter);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果接受到的消息时Server Time，则异步将服务端当前时间发送给客户端。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(body)) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] data = ((<span class="keyword">new</span> Date()).toString() + System.getProperty(<span class="string">"line.separator"</span>)).getBytes();</span><br><span class="line">        ByteBuf resp = Unpooled.copiedBuffer(data);</span><br><span class="line">        <span class="comment">// 这里write方法只是将数据写入缓冲区，并没有真正发送</span></span><br><span class="line">        ctx.write(resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>1.直接将msg转换为String；<br>2.响应的消息最后增加了换行符。</p><p>客户端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">b.group(group)</span><br><span class="line">    .channel(NioSocketChannel.class) <span class="comment">// 设置线程的Channel</span></span><br><span class="line">    .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>) <span class="comment">// 设置NIOSocketChannel的参数</span></span><br><span class="line">    .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123; <span class="comment">// 绑定I/O事件处理类</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            socketChannel.pipeline().addLast(<span class="keyword">new</span> LineBasedFrameDecoder(<span class="number">1024</span>));</span><br><span class="line">            socketChannel.pipeline().addLast(<span class="keyword">new</span> StringDecoder());</span><br><span class="line">            socketChannel.pipeline().addLast(<span class="keyword">new</span> TimeClientHandler());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p><p>增加了LineBasedFrameDecoder和StringDecoder解码器。</p><p>TimeClientHandler的channelActive和channelRead方法修改：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 链路建立成功后，将Server Time请求发送给服务端</span></span><br><span class="line">    String req = <span class="string">"Server Time"</span> + System.getProperty(<span class="string">"line.separator"</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++) &#123; <span class="comment">// 这里循环发送100次请求</span></span><br><span class="line">        <span class="comment">// 待发送数据</span></span><br><span class="line">        msgSendBuf = Unpooled.copiedBuffer(req.getBytes());</span><br><span class="line">        ctx.writeAndFlush(msgSendBuf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 接收服务端响应</span></span><br><span class="line">    String response = (String) msg;</span><br><span class="line">    System.out.println(<span class="string">"接收到服务端响应："</span> + response + <span class="string">",counter:"</span> + ++counter);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>1.发送的报文最后增加换行符；<br>2.接收的消息msg直接转为String。</p><p>运行结果：<br>服务端<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-17/72973720.jpg" alt=""><br>客户端<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-17/8257291.jpg" alt=""></p><h2 id="LineBasedFrameDecoder和StringDecoder的原理分析"><a href="#LineBasedFrameDecoder和StringDecoder的原理分析" class="headerlink" title="LineBasedFrameDecoder和StringDecoder的原理分析"></a>LineBasedFrameDecoder和StringDecoder的原理分析</h2><p>LineBasedFrameDecoder的工作原理是依次遍历ByteBuf中的可读直接，看是否有\r\n或\n，如果有，就以此位置为结束为止，从可读索引到结束位置区间的字节就组成了一行。<br>它是以换行符为标志的解码器。支持携带结束符或不携带结束符两种解码方式，同时支持配置单行的最大长度。如果在连续读取到最大长度后仍然没有发现换行符，就会抛出异常，同时忽略之前读到的异常码流。</p><p>StringDecoder的功能非常简单，就是将接受到的对象转换层字符串，然后继续调用后面的Handler。<br>LineBasedFrameDecoder和StringDecoder组合起来就是支持换行的文本解码器，被设计用来支持TCP粘包和拆包。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Netty版本时间服务器</title>
      <link href="/2017/11/17/Netty-timeserver/"/>
      <url>/2017/11/17/Netty-timeserver/</url>
      
        <content type="html"><![CDATA[<p>本篇文章与前几篇文章BIO编程、AIO编程、伪异步IO编程、NIO编程一起，作为对比的Netty实现，并未考虑TCP粘包/拆包的问题。<br>由阻塞I/O，伪异步I/O，非阻塞I/O，异步非阻塞I/O到Netty实现相同功能的代价，以及使用其他方式的弊端。</p><p>下面仍以时间服务器为例进行说明。<br><a id="more"></a><br>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建NIO线程组，用于服务端接收客户端请求</span></span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="comment">// 用户处理SocketChannel的网络读写</span></span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="comment">// 启动NIO服务端的辅助启动类</span></span><br><span class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        b.group(bossGroup, workerGroup)</span><br><span class="line">                .channel(NioServerSocketChannel.class) <span class="comment">// 设置线程的Channel</span></span><br><span class="line">                .option(ChannelOption.SO_BACKLOG, <span class="number">1024</span>) <span class="comment">// 设置NioServerSocketChannel的参数</span></span><br><span class="line">                .childHandler(<span class="keyword">new</span> ChildChannelHandler()); <span class="comment">// 绑定I/O事件的处理类</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.bind(<span class="number">8808</span>).sync(); <span class="comment">// 绑定监听端口，并阻塞等待绑定操作完成</span></span><br><span class="line">            f.channel().closeFuture().sync(); <span class="comment">// 阻塞，等待服务端链路关闭</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            bossGroup.shutdownGracefully(); <span class="comment">// 进行优雅退出，会释放跟shutdownGracefully相关联的资源</span></span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildChannelHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        socketChannel.pipeline().addLast(<span class="keyword">new</span> TimeServerHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// ByteBuf类似于JDK中的ByteBuffer，但提供更强大跟灵活的功能</span></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        <span class="keyword">byte</span>[] req = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()]; <span class="comment">// 根据缓冲区可读字节数构建字节数组</span></span><br><span class="line">        buf.readBytes(req); <span class="comment">// 将缓冲区的直接数组复制到req</span></span><br><span class="line">        String body = <span class="keyword">new</span> String(req, <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + body);</span><br><span class="line">        <span class="comment">// 如果接受到的消息时Server Time，则异步将服务端当前时间发送给客户端。</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(body)) &#123;</span><br><span class="line">            ByteBuf resp = Unpooled.copiedBuffer((<span class="keyword">new</span> Date()).toString().getBytes());</span><br><span class="line">            <span class="comment">// 这里write方法只是将数据写入缓冲区，并没有真正发送</span></span><br><span class="line">            ctx.write(resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 将缓冲区的数据写入SocketChannel</span></span><br><span class="line">        ctx.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 构造NIO线程组</span></span><br><span class="line">        NioEventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="comment">// 辅助启动类</span></span><br><span class="line">        Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        b.group(group)</span><br><span class="line">                .channel(NioSocketChannel.class) <span class="comment">// 设置线程的Channel</span></span><br><span class="line">                .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>) <span class="comment">// 设置NIOSocketChannel的参数</span></span><br><span class="line">                .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123; <span class="comment">// 绑定I/O事件处理类</span></span><br><span class="line">                    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel socketChannel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        socketChannel.pipeline().addLast(<span class="keyword">new</span> TimeClientHandler());</span><br><span class="line">                    &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ChannelFuture f = b.connect(<span class="string">"127.0.0.1"</span>, <span class="number">8808</span>).sync(); <span class="comment">// 连接并等待连接成功</span></span><br><span class="line">            f.channel().closeFuture().sync(); <span class="comment">// 阻塞，等待客户端连接关闭</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            group.shutdownGracefully(); <span class="comment">// 优雅退出</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ByteBuf msgSendBuf;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TimeClientHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 待发送数据</span></span><br><span class="line">        String req = <span class="string">"Server Time"</span>;</span><br><span class="line">        msgSendBuf = Unpooled.copiedBuffer(req.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 链路建立成功后，将Server Time请求发送给服务端</span></span><br><span class="line">        ctx.writeAndFlush(msgSendBuf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 接收服务端响应</span></span><br><span class="line">        ByteBuf buf = (ByteBuf) msg;</span><br><span class="line">        <span class="keyword">byte</span>[] resp = <span class="keyword">new</span> <span class="keyword">byte</span>[buf.readableBytes()];</span><br><span class="line">        buf.readBytes(resp);</span><br><span class="line">        String response = <span class="keyword">new</span> String(resp, <span class="string">"UTF-8"</span>);</span><br><span class="line">        System.out.println(<span class="string">"接收到服务端响应："</span> + response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>相比使用NIO开发简单了很多。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Netty </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AIO编程</title>
      <link href="/2017/11/16/AIO-programing/"/>
      <url>/2017/11/16/AIO-programing/</url>
      
        <content type="html"><![CDATA[<p>NIO2.0引入了新的异步通道的概念，并提供了异步文件通道和异步套接字通道的实现。异步通道提供2种方式获取操作结果。</p><p>1.通过java.util.concurrent.Future来获取异步操作的结果；<br>2.在异步操作的时候传入一个java.nio.channels。<br>CompletionHandler作为异步完成的回调。</p><p>NIO2.0的异步套接字通道是真正的异步非阻塞I/O，它对应UNIX网络编程中的事件驱动I/O（AIO），它不需要通过多路复用器轮询注册的通道即可实现异步读写，从而简化了NIO的编程模型。<br><a id="more"></a></p><p>AIO版本的时间服务器代码<br>服务端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeServer ts = <span class="keyword">new</span> TimeServer();</span><br><span class="line">        AsyncTimeServerHandler atsh = ts.new AsyncTimeServerHandler(<span class="number">9999</span>);</span><br><span class="line">        <span class="comment">// 可以不使用线程</span></span><br><span class="line">        <span class="keyword">new</span> Thread(atsh,<span class="string">"AsyncTimeServerHandler"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AsyncTimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> AsynchronousServerSocketChannel asynchronousServerSocketChannel;</span><br><span class="line">        <span class="keyword">private</span> CountDownLatch latch = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncTimeServerHandler</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建一个异步的服务端通道</span></span><br><span class="line">                asynchronousServerSocketChannel = AsynchronousServerSocketChannel.open();</span><br><span class="line">                <span class="comment">// 绑定监听端口</span></span><br><span class="line">                asynchronousServerSocketChannel.bind(<span class="keyword">new</span> InetSocketAddress(port));</span><br><span class="line">                System.out.println(<span class="string">"TimeServer is start at:"</span> + port);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 使用CountDownLatch来让服务端在操作完成才退出。</span></span><br><span class="line">            latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">            doAccept();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                latch.await(); <span class="comment">// 阻塞</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAccept</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 接收客户端的连接，使用CompletionHandler来接收accept操作成功的通知消息</span></span><br><span class="line">            asynchronousServerSocketChannel.accept(<span class="keyword">this</span>,<span class="keyword">new</span> AccpetCompleteHandler());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AccpetCompleteHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">AsynchronousSocketChannel</span>,<span class="title">AsyncTimeServerHandler</span>&gt; </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(AsynchronousSocketChannel result, AsyncTimeServerHandler attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 继续接收其他的客户端连接</span></span><br><span class="line">            attachment.asynchronousServerSocketChannel.accept(attachment,<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 客户端连接成功后，使用ReadCompletionHandler读取客户端发送的信息，将信息读取到byteBuffer。</span></span><br><span class="line">            ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">            result.read(byteBuffer,byteBuffer,<span class="keyword">new</span> ReadCompleteHandler(result));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, AsyncTimeServerHandler attachment)</span> </span>&#123;</span><br><span class="line">            exc.printStackTrace();</span><br><span class="line">            attachment.latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ReadCompleteHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Integer</span>,<span class="title">ByteBuffer</span>&gt; </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> AsynchronousSocketChannel channel;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ReadCompleteHandler</span><span class="params">(AsynchronousSocketChannel channel)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.channel = channel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 为后续的从缓冲区读取数据做准备</span></span><br><span class="line">            attachment.flip();</span><br><span class="line">            <span class="comment">// 根据缓冲区的可读字节数创建数组</span></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[attachment.remaining()];</span><br><span class="line">            <span class="comment">// 将缓冲区的可读数据读取到bytes数组</span></span><br><span class="line">            attachment.get(bytes);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                String body = <span class="keyword">new</span> String(bytes,<span class="string">"UTF-8"</span>);</span><br><span class="line">                System.out.println(<span class="string">"接收到客户端请求："</span> + body);</span><br><span class="line">                <span class="comment">// 如果客户端发送的是Server Time，则将服务器当前时间发送给客户端。</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(body)) &#123;</span><br><span class="line">                    doWrite((<span class="keyword">new</span> Date()).toString());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">            exc.printStackTrace();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                channel.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(String response)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = response.getBytes();</span><br><span class="line">            <span class="comment">// 根据响应内容的大小构建缓冲区</span></span><br><span class="line">            ByteBuffer buffer = ByteBuffer.allocate(bytes.length);</span><br><span class="line">            <span class="comment">// 将相应内容复制到缓冲区</span></span><br><span class="line">            buffer.put(bytes);</span><br><span class="line">            <span class="comment">// 为后续从缓冲区读取数据准备</span></span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">// 异步write方法将缓冲区数据写出</span></span><br><span class="line">            channel.write(buffer, buffer, <span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 如果缓冲区还有数据，继续发送</span></span><br><span class="line">                    <span class="keyword">if</span> (attachment.hasRemaining()) &#123;</span><br><span class="line">                        channel.write(attachment,attachment,<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeClient tc = <span class="keyword">new</span> TimeClient();</span><br><span class="line">        AsyncTimeClientHandler tch = tc.new AsyncTimeClientHandler(<span class="string">"127.0.0.1"</span>,<span class="number">9999</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(tch,<span class="string">"TimeClientHandler"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">AsyncTimeClientHandler</span> <span class="keyword">implements</span> <span class="title">CompletionHandler</span>&lt;<span class="title">Void</span>,<span class="title">AsyncTimeClientHandler</span>&gt;,<span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String host;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">private</span> CountDownLatch latch ;</span><br><span class="line">        <span class="keyword">private</span> AsynchronousSocketChannel client;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AsyncTimeClientHandler</span><span class="params">(String host,<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.host = host;</span><br><span class="line">            <span class="keyword">this</span>.port = port;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client = AsynchronousSocketChannel.open();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 使用CountDownLatch，防止异步操作还未完成就退出了。</span></span><br><span class="line">            latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 异步连接服务端</span></span><br><span class="line">            client.connect(<span class="keyword">new</span> InetSocketAddress(host,port),<span class="keyword">this</span>,<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                latch.await(); <span class="comment">// 阻塞</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close(); <span class="comment">// 操作完成后，关闭通道</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Void result, AsyncTimeClientHandler attachment)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 要向服务器发送的数据</span></span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="string">"Server Time"</span>.getBytes();</span><br><span class="line">            <span class="keyword">final</span> ByteBuffer buffer = ByteBuffer.allocate(data.length);</span><br><span class="line">            buffer.put(data);</span><br><span class="line">            buffer.flip();</span><br><span class="line">            <span class="comment">// 异步写消息给服务端</span></span><br><span class="line">            client.write(buffer, buffer, <span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 如果有消息还没有发送完毕，则继续发送</span></span><br><span class="line">                    <span class="keyword">if</span> (buffer.hasRemaining()) &#123;</span><br><span class="line">                        client.write(attachment,attachment,<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 消息发送完成后，异步读取服务器响应</span></span><br><span class="line">                        <span class="comment">// 预分配空间为1K</span></span><br><span class="line">                        ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                        client.read(readBuffer, readBuffer, <span class="keyword">new</span> CompletionHandler&lt;Integer, ByteBuffer&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">completed</span><span class="params">(Integer result, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                                <span class="comment">// 为后续从缓冲区读取数据做准备</span></span><br><span class="line">                                attachment.flip();</span><br><span class="line">                                <span class="comment">// 根据缓冲区可读字节的长度构建字节数组</span></span><br><span class="line">                                <span class="keyword">byte</span>[] data = <span class="keyword">new</span> <span class="keyword">byte</span>[attachment.remaining()];</span><br><span class="line">                                <span class="comment">// 将缓冲区数据复制到data数组</span></span><br><span class="line">                                attachment.get(data);</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    String body = <span class="keyword">new</span> String(data,<span class="string">"UTF-8"</span>);</span><br><span class="line">                                    System.out.println(<span class="string">"接收到服务端消息："</span> + body);</span><br><span class="line">                                    <span class="comment">// 这里模拟只请求服务器1次，完成后退出。</span></span><br><span class="line">                                    latch.countDown();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">try</span> &#123;</span><br><span class="line">                                    client.close();</span><br><span class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                                    e.printStackTrace();</span><br><span class="line">                                &#125;</span><br><span class="line">                                latch.countDown();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, ByteBuffer attachment)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        client.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">failed</span><span class="params">(Throwable exc, AsyncTimeClientHandler attachment)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>JDK底层通过线程池ThreadPoolExecutor来执行回调通知。AsynchronousServerSocketChannel和AsynchronousSocketChannel，他们都由JDK底层的线程池回调并驱动读写操作。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NIO编程</title>
      <link href="/2017/11/15/NIO-programing/"/>
      <url>/2017/11/15/NIO-programing/</url>
      
        <content type="html"><![CDATA[<p>NIO是JDK1.4进入的非阻塞IO。NIO弥补了原来BIO的不足。</p><p>与NIO相关的几个概念</p><p>1.缓冲区Buffer<br>Buffer是一个对象，包含一些要 写入或读出的数据。在NIO库中，所有数据都是经过缓冲区处理的。在读取数据时，它是直接读取到缓冲区的；在写入数据时，写入到缓冲区中。任何时候访问NIO中的数据，都是通过缓冲区进行操作。</p><p>缓冲区本质上是一个数组，通常是一个字节数组（ByteBuffer），也可以使用其他种类的数组。但是缓冲区不仅是一个数组，它提供了对数据的结构化访问以及维护读写位置等信息。</p><p>最常用的是ByteBuffer，它提供了一组功能用于操作byte数组。</p><p>2.通道Channel<br>Channel是一个通道，可以通过它来读取和写入数据。通道是双向的，流只在一个方向移动，而且通道可以同时用于读取和写入。<br>因为Channel是全双工的，所以可以更好的映射底层操作系统的api。<br><a id="more"></a><br>3.多路复用器Selector<br>Selector会不断轮询注册在它上面的Channel，如果某个Channel上有新的TCP连接、读和写事件，这个Channel就处于就绪状态。会被Selector轮询出来，然后通过SelectionKey可以获取就绪的Channel的集合，进行后续的I/O操作。<br>一个多路复用器可以同时轮询多个Channel，由于JDK使用epool替代了传统的select实现，所以它并没有最大连接句柄1024/2048的限制。这也就意味着只需要一个线程负责Selector的轮询，就可以接入成千上万的客户端。</p><p>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioTimeServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioTimeServer nts = <span class="keyword">new</span> NioTimeServer();</span><br><span class="line">        <span class="comment">// 创建Reactor线程，并启动</span></span><br><span class="line">        TimeServerHandler tsh = nts.new TimeServerHandler(<span class="number">8080</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(tsh,<span class="string">"Nio-Time-Server"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line">        Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        ServerSocketChannel serverSocketChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 初始化多路复用器，绑定监听端口</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> port</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeServerHandler</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建多路复用器</span></span><br><span class="line">                selector = Selector.open();</span><br><span class="line">                <span class="comment">// 打开ServerSocketChannel，监听客户端连接</span></span><br><span class="line">                serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">                <span class="comment">// 设置连接为非阻塞模式</span></span><br><span class="line">                serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">// 绑定监听端口</span></span><br><span class="line">                serverSocketChannel.socket().bind(<span class="keyword">new</span> InetSocketAddress(port),<span class="number">1024</span>);</span><br><span class="line">                <span class="comment">// 将ServerSocketChannel注册到Reactor线程的多路复用器上，并监听OP_ACCET事件</span></span><br><span class="line">                serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">                System.out.println(<span class="string">"The time server is start at port:"</span> + port);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 循环遍历selector，休眠时间为1S，无论是否有读写事件发生，selector每隔1S被唤醒1次。</span></span><br><span class="line">            <span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 选择一组准备就绪的Key</span></span><br><span class="line">                    selector.select(<span class="number">1000</span>);</span><br><span class="line">                    <span class="comment">// 遍历准备就绪的Key</span></span><br><span class="line">                    Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">                    Iterator&lt;SelectionKey&gt; itKeys = keys.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (itKeys.hasNext()) &#123;</span><br><span class="line">                        SelectionKey k = itKeys.next();</span><br><span class="line">                        itKeys.remove();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            handleKey(k);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                k.cancel();</span><br><span class="line">                                <span class="keyword">if</span> (k.channel() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    k.channel().close();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 关闭多路复用器，所有注册在上面的Channel和Pipe等资源会自动去注册并关闭，不需要重复释放资源</span></span><br><span class="line">            <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleKey</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (key.isValid()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (key.isAcceptable()) &#123;</span><br><span class="line">                    <span class="comment">// 多路复用器监听到新的客户端接入，处理新的接入请求</span></span><br><span class="line">                    ServerSocketChannel ssc = (ServerSocketChannel) key.channel();</span><br><span class="line">                    SocketChannel sc = ssc.accept();</span><br><span class="line">                    <span class="comment">// 设置客户端链路为非阻塞模式</span></span><br><span class="line">                    sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="comment">// 将新接入的客户端注册到Reactor线程的多路复用器上，并监听读操作，用来读取客户端发送的消息</span></span><br><span class="line">                    sc.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">                    SocketChannel socketChannel = (SocketChannel) key.channel();</span><br><span class="line">                    ByteBuffer readBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    <span class="comment">// 异步读取客户端消息到缓冲区</span></span><br><span class="line">                    <span class="keyword">int</span> readBytes = socketChannel.read(readBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 重置缓冲区的position，将limit设置为postion，position设置为0.用于后续的读取操作</span></span><br><span class="line">                        readBuffer.flip();</span><br><span class="line">                        <span class="comment">// 创建一个容量为缓冲区可读字节个数的字节数组。=limit - postion。本例中position=0，所以实际上=limit</span></span><br><span class="line">                        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readBuffer.remaining()];</span><br><span class="line">                        <span class="comment">// 将缓冲区的可读的数据复制到字节数组中</span></span><br><span class="line">                        readBuffer.get(bytes);</span><br><span class="line">                        <span class="comment">// 根据字节数组，构造一个字符串</span></span><br><span class="line">                        String body = <span class="keyword">new</span> String(bytes,<span class="string">"UTF-8"</span>);</span><br><span class="line">                        System.out.println(<span class="string">"服务器接收到客户端请求："</span> + body);</span><br><span class="line">                        <span class="comment">// 如果客户端发送的是Server Time的请求，则应答</span></span><br><span class="line">                        <span class="keyword">if</span> (body.equalsIgnoreCase(<span class="string">"Server Time"</span>)) &#123;</span><br><span class="line">                            doWrite(socketChannel,(<span class="keyword">new</span> Date()).toString());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (readBytes &lt; <span class="number">0</span>) &#123; <span class="comment">// 客户端链路关闭</span></span><br><span class="line">                        key.cancel();</span><br><span class="line">                        socketChannel.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123; <span class="comment">// 没有读取到数据，不处理</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 向客户端写入当前时间</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> sc</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> response</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(SocketChannel sc , String response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span> &amp;&amp; response.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = response.getBytes();</span><br><span class="line">                <span class="comment">// 构造一个缓冲区，缓冲区的大小=要发送给客户端的数据的字节长度</span></span><br><span class="line">                ByteBuffer writeBuffer = ByteBuffer.allocate(bytes.length);</span><br><span class="line">                <span class="comment">// 将数据复制到缓冲区</span></span><br><span class="line">                writeBuffer.put(bytes);</span><br><span class="line">                <span class="comment">// 重置缓冲区postion</span></span><br><span class="line">                writeBuffer.flip();</span><br><span class="line">                <span class="comment">// 将消息异步发送到客户端</span></span><br><span class="line">                sc.write(writeBuffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017/11/11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NioTimeClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        NioTimeClient ntc = <span class="keyword">new</span> NioTimeClient();</span><br><span class="line">        TimeClientHandler tch = ntc.new TimeClientHandler(<span class="string">"127.0.0.1"</span>,<span class="number">8080</span>);</span><br><span class="line">        <span class="comment">// 创建Reactor线程并启动</span></span><br><span class="line">        <span class="keyword">new</span> Thread(tch,<span class="string">"Nio Time Client"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeClientHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> String host;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stop = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">private</span> Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">private</span> SocketChannel socketChannel = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeClientHandler</span><span class="params">(String host,<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.host = host;</span><br><span class="line">            <span class="keyword">this</span>.port = port;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                selector = Selector.open();</span><br><span class="line">                socketChannel = SocketChannel.open();</span><br><span class="line">                socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doConnect();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"开始轮休多路复用器已准备就绪的key"</span>);</span><br><span class="line">            <span class="keyword">while</span> (!stop) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.select(<span class="number">1000</span>);</span><br><span class="line">                    Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">                    Iterator&lt;SelectionKey&gt; itKeys = keys.iterator();</span><br><span class="line">                    <span class="keyword">while</span> (itKeys.hasNext()) &#123;</span><br><span class="line">                        SelectionKey sk = itKeys.next();</span><br><span class="line">                        itKeys.remove();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            handleInput(sk);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (sk != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                sk.cancel();</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">if</span> (sk.channel() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                sk.channel().close();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    selector.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleInput</span><span class="params">(SelectionKey sk)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (sk.isValid()) &#123;</span><br><span class="line">                SocketChannel sc = (SocketChannel) sk.channel();</span><br><span class="line">                <span class="keyword">if</span> (sk.isConnectable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (sc.finishConnect()) &#123;</span><br><span class="line">                        sc.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                        doWrite(sc);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.exit(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (sk.isReadable()) &#123;</span><br><span class="line">                    ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">                    <span class="keyword">int</span> readBytes = sc.read(byteBuffer);</span><br><span class="line">                    <span class="keyword">if</span> (readBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        byteBuffer.flip();</span><br><span class="line">                        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[byteBuffer.remaining()];</span><br><span class="line">                        byteBuffer.get(bytes);</span><br><span class="line">                        String response = <span class="keyword">new</span> String(bytes,<span class="string">"UTF-8"</span>);</span><br><span class="line">                        System.out.println(<span class="string">"Server response:"</span> + response);</span><br><span class="line">                        <span class="keyword">this</span>.stop = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (readBytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        sk.cancel();</span><br><span class="line">                        sc.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">boolean</span> connected = socketChannel.connect(<span class="keyword">new</span> InetSocketAddress(host,port));</span><br><span class="line">            <span class="keyword">if</span> (connected) &#123;</span><br><span class="line">                socketChannel.register(selector,SelectionKey.OP_READ);</span><br><span class="line">                doWrite(socketChannel);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                socketChannel.register(selector,SelectionKey.OP_CONNECT);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = <span class="string">"Server Time"</span>.getBytes();</span><br><span class="line">            ByteBuffer writeBuffer = ByteBuffer.allocate(data.length);</span><br><span class="line">            writeBuffer.put(data);</span><br><span class="line">            writeBuffer.flip();</span><br><span class="line">            sc.write(writeBuffer);</span><br><span class="line">            <span class="keyword">if</span> (!writeBuffer.hasRemaining()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Server Time请求发送成功！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里的代码并没有考虑“半包读”和“半包写”，如果加上这些，相比BIO难度要大很多。</p><p>实用NIO编程的优点：<br>1.客户端发起的连接操作时异步的，可以通过在多路复用器注册OP_CONNECT等待后续结果，不需要向BIO的客户端那样被同步阻塞。<br>2.SocketChannel的读写操作都是异步的，如果没有可写数据，它不会同步等待，直接返回。这样I/O线程可以处理其他的链路。<br>3.线程模型的优化：由于JDK的selector在Linux等主流的操作系统中通过epoll实现，它没有连接句柄数的限制，这样一个Selector线程就可以同时处理成千上万的客户端连接，而且性能不会随着客户端的增加而线性下降。因此，它非常适合做高性能、高负载的网络服务器。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>伪异步IO编程</title>
      <link href="/2017/11/15/not-aio-programing/"/>
      <url>/2017/11/15/not-aio-programing/</url>
      
        <content type="html"><![CDATA[<p>为了解决BIO（同步阻塞IO）带来的一个链路需要一个线程处理的问题，后来有人对它的线程模型进行了优化，后端通过一个线程池来处理多个客户端的接入，从而形成了一个客户端个数M：线程池最大数N的关系。M可以远大于N，通过线程池可以灵活的调整线程资源，设置线程的最大值，防止由于大量并发导致资源耗尽。<br><a id="more"></a><br>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ThreadFactory namedThreadFactory = <span class="keyword">new</span> ThreadFactoryBuilder().setNameFormat(<span class="string">"demo-pool-%d"</span>).build();</span><br><span class="line">    <span class="keyword">private</span> ExecutorService es = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>,<span class="number">100</span>,<span class="number">0L</span>, TimeUnit.MICROSECONDS,<span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">1024</span>),namedThreadFactory,<span class="keyword">new</span> ThreadPoolExecutor.AbortPolicy());</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeServer timeServer = <span class="keyword">new</span> TimeServer();</span><br><span class="line">        timeServer.start(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        ServerSocket ss = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">            System.out.println(<span class="string">"TimeServer is running..."</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Socket socket = ss.accept();</span><br><span class="line">                es.submit(<span class="keyword">new</span> TimeServerHandler(socket));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ss != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ss.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                es.shutdownNow();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeServerHandler</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">            PrintWriter pw = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">                pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()),<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    String input = br.readLine();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == input) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"接收到客户端请求："</span> + input);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(input)) &#123;</span><br><span class="line">                        pw.println((<span class="keyword">new</span> Date()).toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ip:"</span> + socket.getInetAddress().getHostAddress() + <span class="string">" I/O异常"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        br.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pw.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        socket.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeClient tc = <span class="keyword">new</span> TimeClient();</span><br><span class="line">        tc.connect(<span class="string">"127.0.0.1"</span>,<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(String host,<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> Socket(host,port);</span><br><span class="line">            in = socket.getInputStream();</span><br><span class="line">            out = socket.getOutputStream();</span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(out),<span class="keyword">true</span>);</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">            System.out.println(<span class="string">"请求服务器时间"</span>);</span><br><span class="line">            pw.println(<span class="string">"Server Time"</span>);</span><br><span class="line">            String response = br.readLine();</span><br><span class="line">            System.out.println(<span class="string">"response:"</span> + response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>伪异步IO通过线程池+任务队列来实现，当有新的客户端接入时，将客户端封装成一个新的Task，交给线程池处理。由于线程池和任务队列的大小都是可控制的，所以不论有多少个客户端访问，都不会导致资源耗尽和宕机。</p><p>伪异步IO的弊端：<br>当对Socket的输入流进行读取时，它会一直阻塞，直到发生下面3种事件之一：<br>1.有数据可读；<br>2.可用数据已经读取完毕；<br>3.发生空指针或IO异常。</p><p>这就意味着，当对方发送请求或应答消息缓慢、或者网络传输较慢时，读取输入流一方的线程将被长时间阻塞。在此期间，其他接入消息只能在任务队列中排队。</p><p>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>传统的BIO编程</title>
      <link href="/2017/11/15/bio-programing/"/>
      <url>/2017/11/15/bio-programing/</url>
      
        <content type="html"><![CDATA[<p>在传统的同步阻塞模型开发中，ServerSocket绑定监听端口，Socket发起连接操作。连接成功后，双方通过输入输出流进行同步阻塞式通信。</p><p>下面以时间服务器为例说明。<br>客户端向服务端发送“Server Time”，服务端向客户端返回服务端当前时间。<br><a id="more"></a><br>服务端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeServer timeServer = <span class="keyword">new</span> TimeServer();</span><br><span class="line">        timeServer.start(<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        ServerSocket ss = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ss = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">            System.out.println(<span class="string">"TimeServer is running..."</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                Socket socket = ss.accept();</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> TimeServerHandler(socket)).start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ss != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ss.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                es.shutdownNow();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">TimeServerHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">TimeServerHandler</span><span class="params">(Socket socket)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.socket = socket;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">            PrintWriter pw = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">                pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()),<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    String input = br.readLine();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == input) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    System.out.println(<span class="string">"接收到客户端请求："</span> + input);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(input)) &#123;</span><br><span class="line">                        pw.println((<span class="keyword">new</span> Date()).toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"ip:"</span> + socket.getInetAddress().getHostAddress() + <span class="string">" I/O异常"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (br != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        br.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (pw != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pw.close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        socket.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>客户端代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/11.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TimeClient tc = <span class="keyword">new</span> TimeClient();</span><br><span class="line">        tc.connect(<span class="string">"127.0.0.1"</span>,<span class="number">8080</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(String host,<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        Socket socket = <span class="keyword">null</span>;</span><br><span class="line">        InputStream in = <span class="keyword">null</span>;</span><br><span class="line">        OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> Socket(host,port);</span><br><span class="line">            in = socket.getInputStream();</span><br><span class="line">            out = socket.getOutputStream();</span><br><span class="line">            PrintWriter pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(out),<span class="keyword">true</span>);</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">            System.out.println(<span class="string">"请求服务器时间"</span>);</span><br><span class="line">            pw.println(<span class="string">"Server Time"</span>);</span><br><span class="line">            String response = br.readLine();</span><br><span class="line">            System.out.println(<span class="string">"response:"</span> + response);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    out.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>由一个Acceptor线程负责监听客户端连接请求，接收到客户端连接请求后，为每个客户端分配一个新的线程进行链路处理。处理完成后，通过输出流应答客户端。</p><p>BIO模型的最大问题在于缺乏弹性伸缩能力，因为服务端线程和客户端是呈现的1:1的关系。当线程数膨胀后，系统性能急剧下降，随着并发访问量的继续增大，系统会发生线程堆栈溢出、创建新线程失败等问题，最终导致进程宕机，不能对外提供服务。<br>参考《Netty权威指南》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>notepad++7.5版本插件安装方法</title>
      <link href="/2017/11/15/notepad7.5-version-plugins-install/"/>
      <url>/2017/11/15/notepad7.5-version-plugins-install/</url>
      
        <content type="html"><![CDATA[<p>notepad++7.5版本，插件安装方法与之前不同。是通过“设置-&gt;导入-&gt;导入插件”来完成的。<br>需要先将插件下载到本地。</p><p>这里说一下2个格式化插件的安装方法。</p><p>1.JSON Viewer<br>从<a href="https://sourceforge.net/projects/nppjsonviewer/">https://sourceforge.net/projects/nppjsonviewer/</a>下载到本地，然后解压缩导入.dll文件，然后重启notepad++即可。</p><p>2.XML Tools<br>从<a href="https://sourceforge.net/projects/npp-plugins/files/XML%20Tools/">https://sourceforge.net/projects/npp-plugins/files/XML%20Tools/</a>下载，然后解压缩。<br>导入XML Tools.dll文件，然后将ext_libs解压缩然后将里面的项目.dll复制到与notepad++同级目录，然后重启。</p><a id="more"></a>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Socket编程使用IO流需要注意的地方</title>
      <link href="/2017/11/11/Socket-OutputStream/"/>
      <url>/2017/11/11/Socket-OutputStream/</url>
      
        <content type="html"><![CDATA[<p>在Socket编程中，我们经常会创建Socket连接后。获取InputStream和OutputStream，并进一步包装以便方便的进行数据的读取或写入操作。<br>但是，如果流使用的不对，就可能会产生无法读取到数据的情况。</p><p>下面是使用BufferedWriter和PrintWriter需要注意的地方。</p><h2 id="1-使用BufferedReader和BufferedWriter"><a href="#1-使用BufferedReader和BufferedWriter" class="headerlink" title="1.使用BufferedReader和BufferedWriter"></a>1.使用BufferedReader和BufferedWriter</h2><p>如果使用BufferedReader和BufferedWriter来一次读取或写入一行数据，必须要加\n，代表一行结束。否则BufferedReader读取不到数据。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">BufferedWriter pw = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream()));</span><br><span class="line">    pw = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream()));</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        String input = br.readLine();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == input) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"接收到客户端请求："</span> + input);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"Server Time"</span>.equalsIgnoreCase(input)) &#123;</span><br><span class="line">            <span class="comment">// 注意：这里使用了BufferedWriter，必须要加\n，否则对方的BufferedReader的readLine()获取不到数据。</span></span><br><span class="line">            pw.write((<span class="keyword">new</span> Date()).toString()+<span class="string">"\n"</span>);</span><br><span class="line">            pw.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">System.out.println(<span class="string">"ip:"</span> + socket.getInetAddress().getHostAddress() + <span class="string">" I/O异常"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="2-使用BufferedReader和PrintWriter"><a href="#2-使用BufferedReader和PrintWriter" class="headerlink" title="2.使用BufferedReader和PrintWriter"></a>2.使用BufferedReader和PrintWriter</h2><p>仍然是使用BufferedReader一次读取一行数据，写数据用PrintWriter的println()方法。同时在构造PrintWriter时设置autoFlush=true。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">socket = <span class="keyword">new</span> Socket(host,port);</span><br><span class="line">in = socket.getInputStream();</span><br><span class="line">out = socket.getOutputStream();</span><br><span class="line">PrintWriter pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(out),<span class="keyword">true</span>); <span class="comment">// 这里设置autoFlush=true</span></span><br><span class="line">BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">System.out.println(<span class="string">"请求服务器时间"</span>);</span><br><span class="line">pw.println(<span class="string">"Server Time"</span>); <span class="comment">// 使用println写数据，不要使用write()</span></span><br><span class="line">String response = br.readLine();</span><br><span class="line">System.out.println(<span class="string">"response:"</span> + response);</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成ActiveMQ</title>
      <link href="/2017/11/10/springboot-ActiveMQ/"/>
      <url>/2017/11/10/springboot-ActiveMQ/</url>
      
        <content type="html"><![CDATA[<h2 id="1-添加依赖："><a href="#1-添加依赖：" class="headerlink" title="1.添加依赖："></a>1.添加依赖：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- activemq --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-在application-properties中加入activemq的配置"><a href="#2-在application-properties中加入activemq的配置" class="headerlink" title="2.在application.properties中加入activemq的配置"></a>2.在application.properties中加入activemq的配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring.activemq.broker-url=tcp://192.168.74.135:61616</span><br><span class="line">spring.activemq.user=admin</span><br><span class="line">spring.activemq.password=admin</span><br><span class="line">spring.activemq.pool.enabled=true</span><br><span class="line">spring.activemq.pool.max-connections=50</span><br><span class="line">spring.activemq.pool.expiry-timeout=10000</span><br><span class="line">spring.activemq.pool.idle-timeout=30000</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3-创建一个消息生产者"><a href="#3-创建一个消息生产者" class="headerlink" title="3.创建一个消息生产者"></a>3.创建一个消息生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsTemplate jmsTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Destination destination,String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jmsTemplate.convertAndSend(destination,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-创建一个消息消费者"><a href="#4-创建一个消息消费者" class="headerlink" title="4.创建一个消息消费者"></a>4.创建一个消息消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JMSConsumer.class);</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = <span class="string">"springboot.queue.test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveQueue</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-测试类"><a href="#5-测试类" class="headerlink" title="5.测试类"></a>5.测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JMSProducer jmsProducer;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Destination destination = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"springboot.queue.test"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            jmsProducer.sendMessage(destination,<span class="string">"hello,world!"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BaseTest代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = com.sample.activity.web.Application.class)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="6-发送和接收TOPIC消息"><a href="#6-发送和接收TOPIC消息" class="headerlink" title="6.发送和接收TOPIC消息"></a>6.发送和接收TOPIC消息</h2><p>默认只能发送和接收queue消息，如果要发送和接收topic消息，需要在application.properties文件中加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.jms.pub-sub-domain=true</span><br></pre></td></tr></table></figure></p><p>发送和接收的代码同queue一样。<br>但是这样有另外一个问题：无法发送和接收queue消息。那么如何同时支持发送和接收queue/topic消息呢？</p><h2 id="7-支持同时发送和接收queue-topic"><a href="#7-支持同时发送和接收queue-topic" class="headerlink" title="7.支持同时发送和接收queue/topic"></a>7.支持同时发送和接收queue/topic</h2><p>i. 新建一个JMS的配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String TOPIC = <span class="string">"springboot.topic.test"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE = <span class="string">"springboot.queue.test"</span>;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQQueue(QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Topic <span class="title">topic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQTopic(TOPIC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// topic模式的ListenerContainer</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerTopic(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">        bean.setPubSubDomain(<span class="keyword">true</span>);</span><br><span class="line">        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queue模式的ListenerContainer</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerQueue(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ii. 消息消费者的代码改成如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JMSConsumer.class);</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = JmsConfig.TOPIC,containerFactory = <span class="string">"jmsListenerContainerTopic"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTopicMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到topic消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = JmsConfig.QUEUE,containerFactory = <span class="string">"jmsListenerContainerQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueueMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到queue消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，这里指定了ConnectionFactory。</p><p>iii. 测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JMSProducer jmsProducer;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Topic topic;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Queue queue;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            jmsProducer.sendMessage(queue,<span class="string">"queue,world!"</span> + i);</span><br><span class="line">            jmsProducer.sendMessage(topic, <span class="string">"topic,world!"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>springboot中activemq的一些配置属性参考：<a href="https://github.com/spring-projects/spring-boot/blob/v1.5.4.RELEASE/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jms/activemq/ActiveMQProperties.java">springboot activemq配置属性</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成ActiveMQ</title>
      <link href="/2017/11/10/springboot%E9%9B%86%E6%88%90activeMQ/"/>
      <url>/2017/11/10/springboot%E9%9B%86%E6%88%90activeMQ/</url>
      
        <content type="html"><![CDATA[<h2 id="1-添加依赖："><a href="#1-添加依赖：" class="headerlink" title="1.添加依赖："></a>1.添加依赖：</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- activemq --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-在application-properties中加入activemq的配置"><a href="#2-在application-properties中加入activemq的配置" class="headerlink" title="2.在application.properties中加入activemq的配置"></a>2.在application.properties中加入activemq的配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">spring.activemq.broker-url=tcp://192.168.74.135:61616</span><br><span class="line">spring.activemq.user=admin</span><br><span class="line">spring.activemq.password=admin</span><br><span class="line">spring.activemq.pool.enabled=true</span><br><span class="line">spring.activemq.pool.max-connections=50</span><br><span class="line">spring.activemq.pool.expiry-timeout=10000</span><br><span class="line">spring.activemq.pool.idle-timeout=30000</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="3-创建一个消息生产者"><a href="#3-创建一个消息生产者" class="headerlink" title="3.创建一个消息生产者"></a>3.创建一个消息生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSProducer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsTemplate jmsTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Destination destination,String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jmsTemplate.convertAndSend(destination,message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-创建一个消息消费者"><a href="#4-创建一个消息消费者" class="headerlink" title="4.创建一个消息消费者"></a>4.创建一个消息消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JMSConsumer.class);</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = <span class="string">"springboot.queue.test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveQueue</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-测试类"><a href="#5-测试类" class="headerlink" title="5.测试类"></a>5.测试类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JMSProducer jmsProducer;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Destination destination = <span class="keyword">new</span> ActiveMQQueue(<span class="string">"springboot.queue.test"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            jmsProducer.sendMessage(destination,<span class="string">"hello,world!"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BaseTest代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = com.sample.activity.web.Application.class)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseTest</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="6-发送和接收TOPIC消息"><a href="#6-发送和接收TOPIC消息" class="headerlink" title="6.发送和接收TOPIC消息"></a>6.发送和接收TOPIC消息</h2><p>默认只能发送和接收queue消息，如果要发送和接收topic消息，需要在application.properties文件中加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.jms.pub-sub-domain=true</span><br></pre></td></tr></table></figure></p><p>发送和接收的代码同queue一样。<br>但是这样有另外一个问题：无法发送和接收queue消息。那么如何同时支持发送和接收queue/topic消息呢？</p><h2 id="7-支持同时发送和接收queue-topic"><a href="#7-支持同时发送和接收queue-topic" class="headerlink" title="7.支持同时发送和接收queue/topic"></a>7.支持同时发送和接收queue/topic</h2><p>i. 新建一个JMS的配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String TOPIC = <span class="string">"springboot.topic.test"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String QUEUE = <span class="string">"springboot.queue.test"</span>;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQQueue(QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Topic <span class="title">topic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ActiveMQTopic(TOPIC);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// topic模式的ListenerContainer</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerTopic(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">        bean.setPubSubDomain(<span class="keyword">true</span>);</span><br><span class="line">        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// queue模式的ListenerContainer</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerQueue(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ii. 消息消费者的代码改成如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JMSConsumer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JMSConsumer.class);</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = JmsConfig.TOPIC,containerFactory = <span class="string">"jmsListenerContainerTopic"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTopicMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到topic消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@JmsListener</span>(destination = JmsConfig.QUEUE,containerFactory = <span class="string">"jmsListenerContainerQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onQueueMessage</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到queue消息：&#123;&#125;"</span>,msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>可以看到，这里指定了ConnectionFactory。</p><p>iii. 测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JMSProducer jmsProducer;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Topic topic;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Queue queue;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testJms</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++) &#123;</span><br><span class="line">            jmsProducer.sendMessage(queue,<span class="string">"queue,world!"</span> + i);</span><br><span class="line">            jmsProducer.sendMessage(topic, <span class="string">"topic,world!"</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>springboot中activemq的一些配置属性参考：<a href="https://github.com/spring-projects/spring-boot/blob/v1.5.4.RELEASE/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/jms/activemq/ActiveMQProperties.java">springboot activemq配置属性</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用TimerTask的坑</title>
      <link href="/2017/11/10/java-timertask/"/>
      <url>/2017/11/10/java-timertask/</url>
      
        <content type="html"><![CDATA[<p>使用TimerTask可以方便的实现定时任务的功能，但是如果使用不当，反而会带来隐患。</p><p>在使用TimerTask时，TimerTask中的代码必须要做异常处理，否则产生异常的时候，就挂掉了。<br>特别像使用MQ发送数据的时候，不会显式的要求你捕获异常，如果你忘记了，那么在某个时刻MQ异常的时候（比如网络异常），在发送数据到MQ失败的时候，TimerTask就挂掉了。</p><p>比如如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext_*.xml"</span>);</span><br><span class="line"><span class="keyword">final</span> JmsSender jmsSender = ac.getBean(JmsSender.class);</span><br><span class="line">Timer timer = <span class="keyword">new</span> Timer();</span><br><span class="line"><span class="comment">// 1.TimerTask中不处理异常</span></span><br><span class="line">timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始发送数据"</span>);</span><br><span class="line">        jmsSender.sendTopicMsg(<span class="string">"test.topic"</span>,<span class="string">"hello,world"</span>);</span><br><span class="line">        System.out.println(<span class="string">"数据发送成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,<span class="number">10000</span>,<span class="number">5000</span>);</span><br></pre></td></tr></table></figure></p><p>这段代码没有做异常处理，我们看下执行结果：<br><a id="more"></a><br><img src="http://omh46px9n.bkt.clouddn.com/17-11-10/35635230.jpg" alt=""><br>最开始启动程序时，让MQ正常启动起来，这个时候TimerTask是正常工作的；在某个时刻关闭MQ，这个时候发现TimerTask中已经没有打印任何东西了，包括后面MQ恢复了也没有再打印，说明TimerTask已经挂掉了。<br>所以在使用TimerTask的时候要尤其注意这点，搞不好就踩着坑了。</p><p>处理方法有这么几种：<br>1.仍然使用TimerTask，但做异常处理；<br>2.使用单一线程的线程池来做；<br>3.使用线程，同样做异常处理。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>为dubbo接口增加IP白名单</title>
      <link href="/2017/11/04/dubbo-interface-whiteip/"/>
      <url>/2017/11/04/dubbo-interface-whiteip/</url>
      
        <content type="html"><![CDATA[<p>在开发dubbo接口时，有时可能会限制接口的访问，ip白名单即是一种。在dubbo中，通过扩展Filter接口，可以实现IP白名单的功能。</p><p>先定义一个配置IP白名单的bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/4.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPWhiteList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isEnabled; <span class="comment">// 是否启用白名单</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; allowIps; <span class="comment">// 允许的白名单列表</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isEnabled;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnabled</span><span class="params">(<span class="keyword">boolean</span> isEnabled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.isEnabled = isEnabled;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getAllowIps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> allowIps;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAllowIps</span><span class="params">(List&lt;String&gt; allowIps)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.allowIps = allowIps;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>然后我们实现dubbo的Filter接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/11/4.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IPWhiteListFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IPWhiteList ipWhiteList;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIpWhiteList</span><span class="params">(IPWhiteList ipWhiteList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ipWhiteList = ipWhiteList;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ipWhiteList.isEnabled()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"dubbo IP白名单被禁用！"</span>);</span><br><span class="line">            <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">        &#125;</span><br><span class="line">        String clientIp = RpcContext.getContext().getRemoteHost();</span><br><span class="line">        <span class="keyword">if</span> (ipWhiteList.getAllowIps().contains(clientIp)) &#123;</span><br><span class="line">            <span class="keyword">return</span> invoker.invoke(invocation);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"dubbo客户端IP["</span> + clientIp + <span class="string">"]不在白名单，禁止调用！"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcResult();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在/resources目录下，新建META-INF/dubbo目录，并新建一个名为com.alibaba.dubbo.rpc.Filter的文本文件<br><img src="http://omh46px9n.bkt.clouddn.com/17-11-4/32927644.jpg" alt=""><br>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipWhiteListFilter=com.tommy.service.provider.filter.IPWhiteListFilter</span><br></pre></td></tr></table></figure></p><p>dubbo的配置文件中增加filter的配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"demo-provider"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"multicast://224.5.6.7:1234"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">"dubbo"</span> <span class="attr">port</span>=<span class="string">"20880"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:provider</span> <span class="attr">filter</span>=<span class="string">"ipWhiteListFilter"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.tommy.service.DemoService"</span> <span class="attr">ref</span>=<span class="string">"demoService"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoService"</span> <span class="attr">class</span>=<span class="string">"com.tommy.service.provider.DemoServiceImpl"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ipWhiteList"</span> <span class="attr">class</span>=<span class="string">"com.tommy.service.provider.bean.IPWhiteList"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enabled"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"allowIps"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>192.168.71.170<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://blog.csdn.net/mj158518/article/details/47379799">http://blog.csdn.net/mj158518/article/details/47379799</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> dubbo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>字符串分隔性能测试</title>
      <link href="/2017/10/14/string-split-test/"/>
      <url>/2017/10/14/string-split-test/</url>
      
        <content type="html"><![CDATA[<p>看《Java程序性能优化-让你的Java程序更快、更稳定》一书，在提到字符串分割的性能优化方面，提到了String自带的split方法，使用StringTokenizer，以及使用String.indexOf3种方式做测试，效率JDK&lt;StringTokenizer&lt;indexOf。 但我本机测试结果却不同，本机测试的结果是StringTokenizer&lt;StringUtils(apache commons-lang包)&lt;JDK&lt;indexOf。<br><a id="more"></a><br>测试代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">spliteTest</span><span class="params">(String testType)</span> </span>&#123;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    String str = <span class="keyword">null</span>;</span><br><span class="line">    String SPLIT = <span class="string">","</span>; <span class="comment">// 分隔符</span></span><br><span class="line">    <span class="keyword">int</span> MAX = <span class="number">10000</span>; <span class="comment">// 分割10000次</span></span><br><span class="line">    <span class="comment">// 构造一个包含1000个分隔符的长字符串</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">1000</span>;i++) &#123;</span><br><span class="line">        stringBuffer.append(i+SPLIT);</span><br><span class="line">    &#125;</span><br><span class="line">    str = stringBuffer.toString();</span><br><span class="line">    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">switch</span> (testType) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"jdk"</span>:</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;MAX;i++) &#123;</span><br><span class="line">                str.split(SPLIT);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(testType + <span class="string">" cost "</span> + (System.currentTimeMillis() - start));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"stringTokenizer"</span>:</span><br><span class="line">            StringTokenizer stringTokenizer = <span class="keyword">new</span> StringTokenizer(str,SPLIT);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;MAX;i++) &#123;</span><br><span class="line">                <span class="keyword">while</span> (stringTokenizer.hasMoreTokens()) &#123;</span><br><span class="line">                    stringTokenizer.nextToken();</span><br><span class="line">                &#125;</span><br><span class="line">                stringTokenizer = <span class="keyword">new</span> StringTokenizer(str,SPLIT);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(testType +<span class="string">" cost "</span> + (System.currentTimeMillis() - start));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"stringUtils"</span>:</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;MAX;i++) &#123;</span><br><span class="line">                StringUtils.split(str,SPLIT);</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(testType +<span class="string">" cost "</span> + (System.currentTimeMillis() - start));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">"indexOf"</span>:</span><br><span class="line">            String tmp = str;</span><br><span class="line">            String splitStr = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;MAX;i++) &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> index = tmp.indexOf(SPLIT); <span class="comment">// 找到分隔符</span></span><br><span class="line">                    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    splitStr = tmp.substring(<span class="number">0</span>,index); <span class="comment">// 此次循环分隔的子串</span></span><br><span class="line">                    tmp = tmp.substring(index+<span class="number">1</span>); <span class="comment">// 剩下需要处理的字符串</span></span><br><span class="line">                &#125;</span><br><span class="line">                tmp = str;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(testType +<span class="string">" cost "</span> + (System.currentTimeMillis() - start));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jdk cost 259</span><br><span class="line">stringTokenizer cost 374</span><br><span class="line">stringUtils cost 225</span><br><span class="line">indexOf cost 149</span><br></pre></td></tr></table></figure></p><p>有时候jdk&gt;StringUtils，有时候反过来，差别很小。但StringTokenizer效率很低。indexOf始终是速度最快的。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决360浏览器不支持IDM下载的问题</title>
      <link href="/2017/09/23/resolve-360browser-not-support-idm/"/>
      <url>/2017/09/23/resolve-360browser-not-support-idm/</url>
      
        <content type="html"><![CDATA[<p>像360安全浏览器和360极速浏览器的设置中，下载工具都只能选择自己。不能选择IDM下载。<br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-23/23985231.jpg" alt=""></p><p>如何让它们支持IDM下载呢？<br>在IDM的文件夹中，可以看到一个扩展文件，将它拖动的浏览器中进行安装即可。<br><a id="more"></a><br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-23/64117854.jpg" alt=""><br>然后打开IDM，可以看到360安全/技术浏览器了。如果没有手动添加浏览器。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-23/98345810.jpg" alt=""><br>然后就可以用IDM下载了。</p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat监控助手-自动重启相关服务</title>
      <link href="/2017/09/22/Tomcat-monitor/"/>
      <url>/2017/09/22/Tomcat-monitor/</url>
      
        <content type="html"><![CDATA[<h2 id="功能说明"><a href="#功能说明" class="headerlink" title="功能说明"></a>功能说明</h2><p>该小工具使用swing实现，实现监控某个服务地址，在异常时（连续3次访问不通）自动重启tomcat，并启动配置好的抓取项。</p><p>先看下效果图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/22124054.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/82269477.jpg" alt=""><br><a id="more"></a></p><h2 id="代码说明"><a href="#代码说明" class="headerlink" title="代码说明"></a>代码说明</h2><p>下面是代码：<br>配置文件TomcatMonitor.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#tomcat的启动脚本位置</span><br><span class="line">tomcat.home=D:/luckystar88/soft/apache-tomcat-8.5.6/bin/startup.bat</span><br><span class="line">#tomcat服务监控地址</span><br><span class="line">listen.url=http://localhost:8080/nodeManage/index.jsp</span><br><span class="line">#tomcat监控间隔（秒）</span><br><span class="line">listen.interval=10</span><br><span class="line"></span><br><span class="line">#抓取节点</span><br><span class="line">snatch.node=test-99-YY</span><br><span class="line">#抓取节点下的抓取项</span><br><span class="line">snatch.items=皇冠#足球.滚球#1,皇冠#足球.单式#1,皇冠#足球.早餐#0,皇冠#足球.单式.上半场波胆#0,皇冠#足球.单式.全场波胆#0,皇冠#足球.单式.总进球#0,皇冠#足球.单式.半场全场#0,利记#足球.滚球#0,利记#足球.单式#0,利记#足球.早餐#0,浩博#足球.早餐#0,浩博#足球.单式#0,浩博#足球.滚球#0,500w#500w必发指数#0,球探网#足球.赛果（API）#0,球探网#足球.比分.API#0,竞彩网#足球.受注赛程#0</span><br><span class="line">#开启抓取项的URL</span><br><span class="line">snatch.url=http://localhost:8080/nodeManage/nodeSnatchManage/startOrStopSnatchItem</span><br><span class="line"></span><br><span class="line">#管理中心的登录地址</span><br><span class="line">snatch.login.url=http://localhost:8080/nodeManage/user/login</span><br><span class="line">#管理中心登录用户名</span><br><span class="line">snatch.login.username=admin</span><br><span class="line">#管理中心登录密码</span><br><span class="line">snatch.login.pwd=test123456</span><br></pre></td></tr></table></figure></p><p>读写配置文件的工具类PropertiesUtils<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CONF_FILE = <span class="string">"/TomcatMonitor.properties"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_TOMCAT_HOME = <span class="string">"tomcat.home"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_URL = <span class="string">"listen.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_INTERVAL = <span class="string">"listen.interval"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_NODE = <span class="string">"snatch.node"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_ITEMS = <span class="string">"snatch.items"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_URL = <span class="string">"snatch.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_URL = <span class="string">"snatch.login.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_USERNAME = <span class="string">"snatch.login.username"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_PWD = <span class="string">"snatch.login.pwd"</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        InputStream in = PropertiesUtils.class.getResourceAsStream(CONF_FILE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.load(in);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> properties.getProperty(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String key,String value)</span> </span>&#123;</span><br><span class="line">        properties.setProperty(key,value);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.store(<span class="keyword">new</span> FileOutputStream(PropertiesUtils.class.getResource(CONF_FILE).getPath()),<span class="string">"update "</span> + key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Http请求的工具类HttpClientUtils：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/20.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String USER_AGENT = <span class="string">"Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.90 Safari/537.36"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;CloseableHttpClient&gt; HTTP_CLIENT_THREAD_LOCAL = <span class="keyword">new</span> ThreadLocal&lt;CloseableHttpClient&gt;()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> CloseableHttpClient <span class="title">initialValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> HttpClients.custom().setUserAgent(USER_AGENT).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CloseableHttpClient <span class="title">getClosableHttpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> HTTP_CLIENT_THREAD_LOCAL.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">get</span><span class="params">(String url,Map&lt;String,Object&gt; params,String encoding)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        url = makeUrlParams(url,params);</span><br><span class="line">        HttpGet hg = <span class="keyword">new</span> HttpGet(url);</span><br><span class="line">        CloseableHttpClient chc = getClosableHttpClient();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CloseableHttpResponse chr = chc.execute(hg);</span><br><span class="line">            <span class="keyword">if</span> (chr.getStatusLine().getStatusCode() == HttpStatus.SC_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> EntityUtils.toString(chr.getEntity(),StringUtils.isEmpty(encoding) ? <span class="string">"utf-8"</span> : encoding);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            hg.releaseConnection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">post</span><span class="params">(String url,Map&lt;String,Object&gt; params,String encoding)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HttpPost hp = <span class="keyword">new</span> HttpPost(url);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != params &amp;&amp; !params.isEmpty()) &#123;</span><br><span class="line">            List&lt;NameValuePair&gt; urlParams = <span class="keyword">new</span> ArrayList&lt;NameValuePair&gt;();</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;Map.Entry&lt;String,Object&gt;&gt; it = params.entrySet().iterator();it.hasNext();) &#123;</span><br><span class="line">                Map.Entry&lt;String,Object&gt; entry = it.next();</span><br><span class="line">                urlParams.add(<span class="keyword">new</span> BasicNameValuePair(entry.getKey(),entry.getValue()+<span class="string">""</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            hp.setEntity(<span class="keyword">new</span> UrlEncodedFormEntity(urlParams));</span><br><span class="line">        &#125;</span><br><span class="line">        CloseableHttpClient chc = getClosableHttpClient();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            CloseableHttpResponse chr = chc.execute(hp);</span><br><span class="line">            <span class="keyword">if</span> (chr.getStatusLine().getStatusCode() == HttpStatus.SC_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> EntityUtils.toString(chr.getEntity(), StringUtils.isEmpty(encoding) ? <span class="string">"utf-8"</span> : encoding);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            hp.releaseConnection();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 组装URL参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">makeUrlParams</span><span class="params">(String url,Map&lt;String,Object&gt; params)</span> </span>&#123;</span><br><span class="line">        StringBuffer urlBuf = <span class="keyword">new</span> StringBuffer(url);</span><br><span class="line">        <span class="keyword">boolean</span> isEmpty = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != params &amp;&amp; !params.isEmpty()) &#123;</span><br><span class="line">            isEmpty = <span class="keyword">false</span>;</span><br><span class="line">            urlBuf.append(<span class="string">"?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!isEmpty) &#123;</span><br><span class="line">            Iterator&lt;Map.Entry&lt;String,Object&gt;&gt; it = params.entrySet().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                Map.Entry&lt;String,Object&gt; entry = it.next();</span><br><span class="line">                urlBuf.append(entry.getKey()).append(<span class="string">"="</span>).append(entry.getValue()).append(<span class="string">"&amp;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> isEmpty ? url : urlBuf.substring(<span class="number">0</span>,urlBuf.length()-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>表格用到的数据对象SnatchConfig：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/21.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnatchConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> String thirdSystem;</span><br><span class="line">    <span class="keyword">private</span> String snatchItem;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> startFlag;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SnatchConfig</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SnatchConfig</span><span class="params">(<span class="keyword">int</span> index,String thirdSystem,String snatchItem,<span class="keyword">boolean</span> startFlag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">        <span class="keyword">this</span>.thirdSystem = thirdSystem;</span><br><span class="line">        <span class="keyword">this</span>.snatchItem = snatchItem;</span><br><span class="line">        <span class="keyword">this</span>.startFlag = startFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSnatchItem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> snatchItem;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSnatchItem</span><span class="params">(String snatchItem)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.snatchItem = snatchItem;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isStartFlag</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStartFlag</span><span class="params">(<span class="keyword">boolean</span> startFlag)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startFlag = startFlag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.index = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getThirdSystem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> thirdSystem;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setThirdSystem</span><span class="params">(String thirdSystem)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.thirdSystem = thirdSystem;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>用于显示表格数据的SnatchInfoTableModel：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">**</span><br><span class="line"> * Created by j.tommy on <span class="number">2017</span>/<span class="number">9</span>/<span class="number">21</span>.</span><br><span class="line"> */</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnatchInfoTableModel</span> <span class="keyword">implements</span> <span class="title">TableModel</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String[] headers = &#123;<span class="string">"编号"</span>,<span class="string">"第三方系统"</span>,<span class="string">"抓取项"</span>,<span class="string">"是否开启抓取"</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> java.util.List&lt;SnatchConfig&gt; configs = <span class="keyword">new</span> ArrayList&lt;SnatchConfig&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SnatchInfoTableModel</span><span class="params">(List&lt;SnatchConfig&gt; configs )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.configs = configs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getRowCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configs.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getColumnCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> headers.length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getColumnName</span><span class="params">(<span class="keyword">int</span> columnIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> headers[columnIndex];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getColumnClass(<span class="keyword">int</span> columnIndex) &#123;</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">0</span>) <span class="keyword">return</span> Integer.class;</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">1</span>) <span class="keyword">return</span> String.class;</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">2</span>) <span class="keyword">return</span> String.class;</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">3</span>) <span class="keyword">return</span> Boolean.class; <span class="comment">// 返回bool类型，swing就会显示CheckBox了。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCellEditable</span><span class="params">(<span class="keyword">int</span> rowIndex, <span class="keyword">int</span> columnIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> columnIndex == <span class="number">0</span> ? <span class="keyword">false</span> : <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValueAt</span><span class="params">(<span class="keyword">int</span> rowIndex, <span class="keyword">int</span> columnIndex)</span> </span>&#123;</span><br><span class="line">        SnatchConfig sc = configs.get(rowIndex);</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">0</span>) <span class="keyword">return</span> sc.getIndex();</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">1</span>) <span class="keyword">return</span> sc.getThirdSystem();</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">2</span>) <span class="keyword">return</span> sc.getSnatchItem();</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">3</span>) <span class="keyword">return</span> sc.isStartFlag();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValueAt</span><span class="params">(Object aValue, <span class="keyword">int</span> rowIndex, <span class="keyword">int</span> columnIndex)</span> </span>&#123;</span><br><span class="line">        SnatchConfig sc = configs.get(rowIndex);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == sc) sc = <span class="keyword">new</span> SnatchConfig();</span><br><span class="line">        <span class="keyword">if</span> (columnIndex == <span class="number">0</span>) System.out.println(<span class="string">"暂不提供修改功能。"</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (columnIndex == <span class="number">1</span>) sc.setThirdSystem((String) aValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (columnIndex == <span class="number">2</span>) sc.setSnatchItem((String) aValue);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (columnIndex == <span class="number">3</span>) sc.setStartFlag((Boolean) aValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTableModelListener</span><span class="params">(TableModelListener l)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeTableModelListener</span><span class="params">(TableModelListener l)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>用于开启抓取项的StartSnatchItemManager：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/21.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StartSnatchItemManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">login</span><span class="params">(TomcatMonitor tm)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        String username = PropertiesUtils.getString(PropertiesUtils.KEY_LOGIN_USERNAME);</span><br><span class="line">        String pwd = PropertiesUtils.getString(PropertiesUtils.KEY_LOGIN_PWD);</span><br><span class="line">        String loginUrl = PropertiesUtils.getString(PropertiesUtils.KEY_LOGIN_URL);</span><br><span class="line">        Map&lt;String,Object&gt; params = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">2</span>);</span><br><span class="line">        params.put(<span class="string">"username"</span>,username);</span><br><span class="line">        params.put(<span class="string">"pwd"</span>,pwd);</span><br><span class="line">        String content = HttpClientUtils.post(loginUrl, params, <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(content);</span><br><span class="line">        <span class="keyword">boolean</span> loginCheck = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != content &amp;&amp; !<span class="string">""</span>.equals(content)) &#123;</span><br><span class="line">            String returnCode = (String) JsonUtil.getValue(content,<span class="string">"returncode"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != returnCode &amp;&amp; <span class="string">"0"</span>.equals(returnCode)) &#123;</span><br><span class="line">                loginCheck = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                String errmsg = (String) JsonUtil.getValue(content,<span class="string">"errmsg"</span>);</span><br><span class="line">                String msg = <span class="string">"登录管理中心失败！无法开启抓取项。错误信息："</span> + errmsg;</span><br><span class="line">                tm.insertLog(msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> loginCheck;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启抓取项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tm</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> snatchUrl 开启抓取项的URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> snatchNode 抓取节点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> snatchItems 抓取项（见属性文件配置）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">startSnatchItems</span><span class="params">(TomcatMonitor tm,String snatchUrl,String snatchNode,String snatchItems)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> loginResult = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loginResult = login(tm);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            tm.insertLog(<span class="string">"登录失败！err="</span> + e.getMessage());</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!loginResult) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String,Object&gt; params = <span class="keyword">new</span> HashMap&lt;String, Object&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != snatchItems &amp;&amp; !<span class="string">""</span>.equals(snatchItems)) &#123;</span><br><span class="line">            String[] items = snatchItems.split(<span class="string">","</span>);</span><br><span class="line">            params.clear();</span><br><span class="line">            <span class="keyword">for</span> (String item : items) &#123;</span><br><span class="line">                String startFlag = item.split(<span class="string">"#"</span>)[<span class="number">2</span>];</span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">"1"</span>.equals(startFlag)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                params.put(<span class="string">"onlyCode"</span>,snatchNode);</span><br><span class="line">                params.put(<span class="string">"operateStatus"</span>,<span class="string">"1"</span>);</span><br><span class="line">                params.put(<span class="string">"thirdSystem"</span>,item.split(<span class="string">"#"</span>)[<span class="number">0</span>]);</span><br><span class="line">                params.put(<span class="string">"snatchItem"</span>,item.split(<span class="string">"#"</span>)[<span class="number">1</span>]);</span><br><span class="line">                <span class="comment">// 开启抓取项</span></span><br><span class="line">                String result = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    result = HttpClientUtils.get(snatchUrl, params, <span class="string">"utf-8"</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    tm.insertLog(<span class="string">"开启抓取项失败！err="</span> + e.getMessage());</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != result) &#123;</span><br><span class="line">                    Double returncode = (Double) JsonUtil.getValue(result,<span class="string">"returncode"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> != result &amp;&amp; returncode == <span class="number">0</span>) &#123;</span><br><span class="line">                        String msg = <span class="string">"抓取项：["</span> + item.split(<span class="string">"#"</span>)[<span class="number">0</span>] + <span class="string">"."</span> + item.split(<span class="string">"#"</span>)[<span class="number">1</span>] + <span class="string">"]开启成功！"</span>;</span><br><span class="line">                        System.out.println(msg);</span><br><span class="line">                        tm.insertLog(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        String errmsg = (String) JsonUtil.getValue(result,<span class="string">"errmsg"</span>);</span><br><span class="line">                        String errMsg = <span class="string">"抓取项：["</span> + item.split(<span class="string">"#"</span>)[<span class="number">0</span>] + <span class="string">"."</span> + item.split(<span class="string">"#"</span>)[<span class="number">1</span>] + <span class="string">"]开启失败！msg="</span> + errmsg;</span><br><span class="line">                        tm.insertLog(errMsg);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>用来展示GUI和事件处理的TomcatMonitor：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tomcat监控助手。</span></span><br><span class="line"><span class="comment"> * 用来实现在Tomcat服务异常时，自动重启Tomcat服务。</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatMonitor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tomcat启动脚本位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField1;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控地址URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField2;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来显示监控日志的Panel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextPane logPanel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用帮助按钮</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JButton helpButton;</span><br><span class="line">    JPanel mainPanel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始监控按钮</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JButton jkButton;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控间隔（秒）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField3;</span><br><span class="line">    <span class="keyword">private</span> JTabbedPane tp;</span><br><span class="line">    <span class="keyword">private</span> JTextField snatchNodeFd = <span class="keyword">new</span> JTextField(<span class="number">60</span>);</span><br><span class="line">    <span class="keyword">private</span> JTextField snatchUrlField = <span class="keyword">new</span> JTextField(<span class="number">60</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否监控的标志位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> listenFlag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">private</span> String tomcatHome;</span><br><span class="line">    <span class="keyword">private</span> String listenUrl;</span><br><span class="line">    <span class="keyword">private</span> String interval;</span><br><span class="line">    <span class="keyword">private</span> String snatchNode;</span><br><span class="line">    <span class="keyword">private</span> String snatchItems;</span><br><span class="line">    <span class="keyword">private</span> String snatchUrl;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ListenThread lt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TomcatMonitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initSecondPane();</span><br><span class="line">        loadConf();</span><br><span class="line">        helpButton.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                JOptionPane.showMessageDialog(<span class="keyword">null</span>, <span class="string">"这是一个tomcat监控小工具，通过定时扫描指定的页面来确认服务是否正常。\n在服务异常时，自动重新启动tomcat服务器。\n启动是通过命令行启动的tomcat的startup.bat脚本。\n"</span>, <span class="string">"使用说明"</span>, JOptionPane.INFORMATION_MESSAGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        logPanel.setContentType(<span class="string">"text/html"</span>);</span><br><span class="line">        logPanel.setEditable(<span class="keyword">false</span>);</span><br><span class="line">        jkButton.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                String text = <span class="string">"监控中..."</span>;</span><br><span class="line">                <span class="keyword">if</span> (jkButton.getText().equals(text)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> r = JOptionPane.showConfirmDialog(<span class="keyword">null</span>,<span class="string">"停止监控？"</span>,<span class="string">"系统提示"</span>,JOptionPane.YES_NO_OPTION);</span><br><span class="line">                    <span class="keyword">if</span> (r == JOptionPane.YES_OPTION) &#123;</span><br><span class="line">                        TomcatMonitor.<span class="keyword">this</span>.lt = <span class="keyword">null</span>;</span><br><span class="line">                        TomcatMonitor.<span class="keyword">this</span>.listenFlag = <span class="keyword">false</span>;</span><br><span class="line">                        jkButton.setText(<span class="string">"开始监控"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> validateFlag = validateForm();</span><br><span class="line">                <span class="keyword">if</span> (validateFlag) &#123;</span><br><span class="line">                    TomcatMonitor.<span class="keyword">this</span>.listenFlag = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (lt == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                        lt = <span class="keyword">new</span> ListenThread();</span><br><span class="line">                        lt.start();</span><br><span class="line">                    &#125;</span><br><span class="line">                    jkButton.setText(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        insertLog(<span class="string">"tomcat监控助手启动成功！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化抓取项配置TAB组件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initSecondPane</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JPanel secondPane = <span class="keyword">new</span> JPanel();</span><br><span class="line">        GridBagLayout gbl = <span class="keyword">new</span> GridBagLayout();</span><br><span class="line">        secondPane.setLayout(gbl);</span><br><span class="line">        List&lt;SnatchConfig&gt; snatchConfigs = getSnatchConfigs();</span><br><span class="line">        SnatchInfoTableModel sitm = <span class="keyword">new</span> SnatchInfoTableModel(snatchConfigs);</span><br><span class="line">        <span class="keyword">final</span> JTable jt = <span class="keyword">new</span> JTable(sitm);</span><br><span class="line">        Font font = <span class="keyword">new</span> Font(<span class="string">"宋体"</span>,Font.BOLD,<span class="number">13</span>);</span><br><span class="line">        jt.getTableHeader().setFont(font);</span><br><span class="line">        jt.setFont(font);</span><br><span class="line">        JScrollPane jp = <span class="keyword">new</span> JScrollPane(jt);</span><br><span class="line">        <span class="comment">// 设置表格的宽度和高度</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;jt.getColumnCount();i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">                jt.getColumnModel().getColumn(i).setPreferredWidth(<span class="number">30</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">1</span>)</span><br><span class="line">                jt.getColumnModel().getColumn(i).setPreferredWidth(<span class="number">100</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">2</span>)</span><br><span class="line">                jt.getColumnModel().getColumn(i).setPreferredWidth(<span class="number">200</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jt.setRowHeight(<span class="number">40</span>);</span><br><span class="line">        jt.setPreferredScrollableViewportSize(<span class="keyword">new</span> Dimension(<span class="number">820</span>,<span class="number">500</span>));</span><br><span class="line">        JLabel snatchNodeLbl = <span class="keyword">new</span> JLabel(<span class="string">"抓取项所属节点："</span>);</span><br><span class="line">        snatchNodeFd.setPreferredSize(<span class="keyword">new</span> Dimension(<span class="number">200</span>,<span class="number">30</span>));</span><br><span class="line">        JLabel snatchUrlLabel = <span class="keyword">new</span> JLabel(<span class="string">"开启抓取项URL："</span>);</span><br><span class="line">        JButton saveSnatchConfigBtn = <span class="keyword">new</span> JButton(<span class="string">"保存配置"</span>);</span><br><span class="line">        snatchUrlField.setToolTipText(<span class="string">"请输入抓取项URL"</span>);</span><br><span class="line">        snatchUrlField.setPreferredSize(<span class="keyword">new</span> Dimension(<span class="number">200</span>,<span class="number">30</span>));</span><br><span class="line">        secondPane.add(jp,<span class="keyword">new</span> GBC(<span class="number">0</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.WEST).setInsets(-<span class="number">40</span>,<span class="number">10</span>,<span class="number">0</span>,<span class="number">10</span>));</span><br><span class="line">        secondPane.add(snatchNodeLbl,<span class="keyword">new</span> GBC(<span class="number">0</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.WEST).setInsets(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>));</span><br><span class="line">        secondPane.add(snatchNodeFd,<span class="keyword">new</span> GBC(<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.WEST).setInsets(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>));</span><br><span class="line">        secondPane.add(snatchUrlLabel,<span class="keyword">new</span> GBC(<span class="number">0</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.WEST).setInsets(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>));</span><br><span class="line">        secondPane.add(snatchUrlField,<span class="keyword">new</span> GBC(<span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.WEST).setInsets(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>));</span><br><span class="line">        secondPane.add(saveSnatchConfigBtn,<span class="keyword">new</span> GBC(<span class="number">1</span>,<span class="number">4</span>,<span class="number">1</span>,<span class="number">1</span>).setAnchor(GridBagConstraints.CENTER));</span><br><span class="line">        tp.add(<span class="string">"抓取项配置"</span>,secondPane);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 保存抓取配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        saveSnatchConfigBtn.addActionListener(<span class="keyword">new</span> AbstractAction() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">boolean</span> dataChangeFlag = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 抓取节点</span></span><br><span class="line">                String snatchNode = snatchNodeFd.getText();</span><br><span class="line">                <span class="keyword">if</span> (!snatchNode.equals(TomcatMonitor.<span class="keyword">this</span>.snatchNode) &amp;&amp; !<span class="string">""</span>.equals(snatchNode)) &#123;</span><br><span class="line">                    dataChangeFlag = <span class="keyword">true</span>;</span><br><span class="line">                    PropertiesUtils.setString(PropertiesUtils.KEY_SNATCH_NODE,snatchNode);</span><br><span class="line">                    TomcatMonitor.<span class="keyword">this</span>.snatchNode = snatchNode;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 抓取URL</span></span><br><span class="line">                String snatchURL = snatchUrlField.getText();</span><br><span class="line">                <span class="keyword">if</span> (!snatchURL.equals(snatchUrl) &amp;&amp; !<span class="string">""</span>.equals(snatchURL)) &#123;</span><br><span class="line">                    dataChangeFlag = <span class="keyword">true</span>;</span><br><span class="line">                    PropertiesUtils.setString(PropertiesUtils.KEY_SNATCH_URL,snatchURL);</span><br><span class="line">                    TomcatMonitor.<span class="keyword">this</span>.snatchUrl = snatchURL;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">int</span> rows = jt.getRowCount();</span><br><span class="line">                <span class="keyword">if</span> (rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    StringBuffer snatchConfigBuff = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;rows;i++) &#123;</span><br><span class="line">                        String thirdSystem = (String) jt.getModel().getValueAt(i,<span class="number">1</span>);</span><br><span class="line">                        String snatchItem = (String) jt.getModel().getValueAt(i,<span class="number">2</span>);</span><br><span class="line">                        <span class="keyword">boolean</span> startFlag = (Boolean)jt.getModel().getValueAt(i,<span class="number">3</span>);</span><br><span class="line">                        snatchConfigBuff.append(thirdSystem).append(<span class="string">"#"</span>).append(snatchItem).append(<span class="string">"#"</span>).append(startFlag?<span class="number">1</span>:<span class="number">0</span>).append(<span class="string">","</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    String snatchItems = snatchConfigBuff.substring(<span class="number">0</span>,snatchConfigBuff.length()-<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">if</span> (!snatchItems.equals(TomcatMonitor.<span class="keyword">this</span>.snatchItems)) &#123;</span><br><span class="line">                        <span class="comment">// 保存到配置文件</span></span><br><span class="line">                        PropertiesUtils.setString(PropertiesUtils.KEY_SNATCH_ITEMS,snatchItems);</span><br><span class="line">                        dataChangeFlag = <span class="keyword">true</span>;</span><br><span class="line">                        TomcatMonitor.<span class="keyword">this</span>.snatchItems = snatchItems;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String tipMsg = <span class="string">"配置已保存"</span>;</span><br><span class="line">                <span class="keyword">if</span> (!dataChangeFlag) &#123;</span><br><span class="line">                    tipMsg = <span class="string">"配置无修改，无需保存！"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                JOptionPane.showMessageDialog(<span class="keyword">null</span>,tipMsg,<span class="string">"提示"</span>,JOptionPane.INFORMATION_MESSAGE);</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 输入框验证</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">validateForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String tomcatHome = textField1.getText();</span><br><span class="line">        String listenUrl = textField2.getText();</span><br><span class="line">        String interval = textField3.getText();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == tomcatHome || <span class="string">""</span>.equals(tomcatHome)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入tomcat启动脚本位置！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == listenUrl || <span class="string">""</span>.equals(listenUrl)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入监控地址！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!listenUrl.startsWith(<span class="string">"http://"</span>)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入正确的监控地址！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interval.matches(<span class="string">"\\d+"</span>)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入正确的监控间隔（秒）！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> intervalTime = Integer.parseInt(interval);</span><br><span class="line">        <span class="keyword">if</span> (intervalTime &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"监控间隔不能小于10秒！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!tomcatHome.equals(<span class="keyword">this</span>.tomcatHome)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tomcatHome = tomcatHome;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_TOMCAT_HOME,tomcatHome);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!listenUrl.equals(<span class="keyword">this</span>.listenUrl)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.listenUrl = listenUrl;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_LISTEN_URL,listenUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interval.equals(<span class="keyword">this</span>.interval)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.interval = interval;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_LISTEN_INTERVAL,interval);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从配置文件加载tomcat启动脚本位置、监控url、监控间隔、抓取节点、抓取url</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String tomcatHome = PropertiesUtils.getString(PropertiesUtils.KEY_TOMCAT_HOME);</span><br><span class="line">        String listenUrl = PropertiesUtils.getString(PropertiesUtils.KEY_LISTEN_URL);</span><br><span class="line">        String listenInterval = PropertiesUtils.getString(PropertiesUtils.KEY_LISTEN_INTERVAL);</span><br><span class="line">        String snatchNode = PropertiesUtils.getString(PropertiesUtils.KEY_SNATCH_NODE);</span><br><span class="line">        String snatchUrl = PropertiesUtils.getString(PropertiesUtils.KEY_SNATCH_URL);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != tomcatHome &amp;&amp; !<span class="string">""</span>.equals(tomcatHome)) &#123;</span><br><span class="line">            textField1.setText(tomcatHome);</span><br><span class="line">            <span class="keyword">this</span>.tomcatHome = tomcatHome;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != listenUrl &amp;&amp; !<span class="string">""</span>.equals(listenUrl)) &#123;</span><br><span class="line">            textField2.setText(listenUrl);</span><br><span class="line">            <span class="keyword">this</span>.listenUrl = listenUrl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != listenInterval &amp;&amp; !<span class="string">""</span>.equals(listenInterval)) &#123;</span><br><span class="line">            textField3.setText(listenInterval);</span><br><span class="line">            <span class="keyword">this</span>.interval = listenInterval;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != snatchNode &amp;&amp; !<span class="string">""</span>.equals(snatchNode)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.snatchNode = snatchNode;</span><br><span class="line">            snatchNodeFd.setText(snatchNode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != snatchUrl &amp;&amp; !<span class="string">""</span>.equals(snatchUrl)) &#123;</span><br><span class="line">            snatchUrlField.setText(snatchUrl);</span><br><span class="line">            <span class="keyword">this</span>.snatchUrl = snatchUrl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从配置文件加载抓取项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;SnatchConfig&gt; <span class="title">getSnatchConfigs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;SnatchConfig&gt; snatchConfigs = <span class="keyword">new</span> ArrayList&lt;SnatchConfig&gt;();</span><br><span class="line">        String snatchItems = PropertiesUtils.getString(PropertiesUtils.KEY_SNATCH_ITEMS);</span><br><span class="line">        <span class="keyword">this</span>.snatchItems = snatchItems;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != snatchItems &amp;&amp; !<span class="string">""</span>.equals(snatchItems)) &#123;</span><br><span class="line">            String[] items = snatchItems.split(<span class="string">","</span>);</span><br><span class="line">            <span class="keyword">int</span> index = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (String item : items) &#123;</span><br><span class="line">                String[] itemConfig = item.split(<span class="string">"#"</span>);</span><br><span class="line">                <span class="keyword">boolean</span> startFlag = <span class="string">"0"</span>.equals(itemConfig[<span class="number">2</span>]) ? <span class="keyword">false</span> : <span class="keyword">true</span>;</span><br><span class="line">                snatchConfigs.add(<span class="keyword">new</span> SnatchConfig(index,itemConfig[<span class="number">0</span>],itemConfig[<span class="number">1</span>],startFlag));</span><br><span class="line">                index++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> snatchConfigs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启tomcat，然后等待120S，待tomcat启动完毕后，开启指定的抓取项。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTomcat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runtime.exec(tomcatHome);</span><br><span class="line">            insertLog(<span class="string">"120秒后检测是否启动成功..."</span>);</span><br><span class="line">            <span class="comment">// 休眠120秒后启动抓取项</span></span><br><span class="line">            Thread.sleep(<span class="number">120000</span>);</span><br><span class="line">            insertLog(<span class="string">"检测是否启动成功..."</span>);</span><br><span class="line">            <span class="comment">// 检查是否启动成功</span></span><br><span class="line">            String content = HttpClientUtils.get(listenUrl,<span class="keyword">null</span>,<span class="string">"utf-8"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != content &amp;&amp; !<span class="string">""</span>.equals(content)) &#123;</span><br><span class="line">                <span class="comment">// 开启抓取项</span></span><br><span class="line">                insertLog(<span class="string">"Tomcat启动成功！正在开启抓取项..."</span>);</span><br><span class="line">                StartSnatchItemManager.startSnatchItems(<span class="keyword">this</span>,snatchUrl,snatchNode,snatchItems);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                insertLog(<span class="string">"启动tomcat失败！"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            insertLog(<span class="string">"启动tomcat失败！error="</span> + e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            insertLog(<span class="string">"启动tomcat失败！error="</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向logPanel插入日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msg</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertLog</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        StyledDocument sd = logPanel.getStyledDocument();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String current = df.format(<span class="keyword">new</span> Date());</span><br><span class="line">            msg = current + <span class="string">","</span> + msg +<span class="string">"\n"</span>;</span><br><span class="line">            <span class="keyword">int</span> docLength = sd.getLength();</span><br><span class="line">            <span class="keyword">if</span> (docLength &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">                sd.remove(<span class="number">0</span>,docLength);</span><br><span class="line">                sd.insertString(sd.getLength(),<span class="string">"日志过多，之前的日志已被清除！"</span>, logPanel.getCharacterAttributes());</span><br><span class="line">            &#125;</span><br><span class="line">            sd.insertString(sd.getLength(),msg,logPanel.getCharacterAttributes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadLocationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * tomcat监控线程，定时请求给定的URL，检测服务是否正常。在tomcat服务异常时自动重启tomcat。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (listenFlag) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    String content = HttpClientUtils.get(listenUrl,<span class="keyword">null</span>,<span class="string">"utf-8"</span>);</span><br><span class="line">                    String f = <span class="string">"成功"</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == content) &#123;</span><br><span class="line">                        f = <span class="string">"失败"</span>;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String msg = <span class="string">"请求URL："</span> + listenUrl + <span class="string">",结果："</span>+ f;</span><br><span class="line">                    insertLog(msg);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (count &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">                        insertLog(<span class="string">"tomcat服务监控连续3次异常，重新启动..."</span>);</span><br><span class="line">                        startTomcat();</span><br><span class="line">                        count = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    String msg = <span class="string">"监控异常！error="</span> + e.getMessage();</span><br><span class="line">                    insertLog(msg);</span><br><span class="line">                    insertLog(<span class="string">"正在重新启动Tomcat..."</span>);</span><br><span class="line">                    startTomcat();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>*Long.parseLong(interval));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame frame = <span class="keyword">new</span> JFrame(<span class="string">"Tomcat监控小工具"</span>);</span><br><span class="line">        <span class="keyword">final</span> TomcatMonitor tm = <span class="keyword">new</span> TomcatMonitor();</span><br><span class="line">        frame.setContentPane(tm.tp);</span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class="line">        frame.setResizable(<span class="keyword">false</span>);</span><br><span class="line">        frame.pack();</span><br><span class="line">        frame.setSize(<span class="number">900</span>,<span class="number">750</span>);</span><br><span class="line">        frame.setLocationRelativeTo(tm.tp);</span><br><span class="line">        frame.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        frame.addWindowListener(<span class="keyword">new</span> WindowAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">windowClosing</span><span class="params">(WindowEvent e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.windowClosing(e);</span><br><span class="line">                tm.listenFlag = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里特别说明：GUI使用idea来创建的。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/52200098.jpg" alt=""><br>TAB导航也是可以通过idea来添加的。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/91330382.jpg" alt=""><br>但是这里我第2个TAB是自己用代码写的，费时费力，完全是不必要的。</p><h2 id="打包说明"><a href="#打包说明" class="headerlink" title="打包说明"></a>打包说明</h2><p>最后是打包成Jar运行的。<br>将要打包的文件（.class和.properties）复制到E:/test<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/46974448.jpg" alt=""></p><p>注意：要将idea生成的class也复制过来<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/56919831.jpg" alt=""></p><p>打包命令：E:>jar -cvf aa.jar -C test .<br>上面的命令即将test目录下的所有文件和目录打成一个jar包。</p><p>将依赖的jar放到一个lib目录中，然后将打包后的文件和lib放到一个目录中。比如：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/16174022.jpg" alt=""></p><p>用解压缩软件打开aa.jar，修改MANIFEST.MF文件，增加Main-Class和Class-Path，如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/81024228.jpg" alt=""><br>Main-Class用来指定程序启动入口，Class-Path指定依赖的jar包。<br>然后双击aa.jar或者在命令行执行java -jar aa.jar就可以执行了。</p><h2 id="jar包中读写配置文件"><a href="#jar包中读写配置文件" class="headerlink" title="jar包中读写配置文件"></a>jar包中读写配置文件</h2><p>后来发现上面的方式，读取jar中的配置文件是OK的，但是写入报错。<br>后采用了下面的方式处理：<br>这里打包的目录结构如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-22/65362027.jpg" alt=""><br>compile是class文件，lib是依赖的jar包，res是配置文件。<br>将程序的class文件拷贝到compile目录，依赖的jar拷贝到lib，依赖的配置文件拷贝到res目录，然后命令行切换到E:/test目录。<br>执行：E:\test&gt;jar -cvf /test/aa.jar -C compile/ .<br>这样就会在/test目录生成aa.jar。修改aa.jar中的MANIFEST.MF，修改Main-Class和Class-Path，这个是跟上面一样的。然后执行java -jar aa.jar就可以了。</p><p>属性文件的读取时使用读写文件，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CONF_FILE = <span class="string">"/res/TomcatMonitor.properties"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_TOMCAT_HOME = <span class="string">"tomcat.home"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_URL = <span class="string">"listen.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_INTERVAL = <span class="string">"listen.interval"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_NODE = <span class="string">"snatch.node"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_ITEMS = <span class="string">"snatch.items"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_SNATCH_URL = <span class="string">"snatch.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_URL = <span class="string">"snatch.login.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_USERNAME = <span class="string">"snatch.login.username"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LOGIN_PWD = <span class="string">"snatch.login.pwd"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String fullConfigPath = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        String rootPath = getRootPath();</span><br><span class="line">        fullConfigPath = rootPath + CONF_FILE;</span><br><span class="line">        System.out.println(fullConfigPath);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(fullConfigPath))));</span><br><span class="line">            properties.load(br);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getRootPath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String rootPath = System.getProperty(<span class="string">"user.dir"</span>).replace(<span class="string">"\\"</span>, <span class="string">"/"</span>);</span><br><span class="line">        <span class="keyword">return</span> rootPath;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> properties.getProperty(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String key,String value)</span> </span>&#123;</span><br><span class="line">        properties.setProperty(key,value);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.store(<span class="keyword">new</span> FileOutputStream(fullConfigPath),<span class="string">"update "</span> + key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样执行程序是会报错的，但打jar包执行没问题。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA-SWING监控Tomcat小工具</title>
      <link href="/2017/09/17/java-swing-tomcat-monitor/"/>
      <url>/2017/09/17/java-swing-tomcat-monitor/</url>
      
        <content type="html"><![CDATA[<p>由于线上的一个抓取节点Tomcat经常莫名其妙的被关掉，所以准备写个小工具来监控。在Tomcat服务异常时，重新启动。</p><p>界面使用的intellij idea设计。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/15393970.jpg" alt=""><br><a id="more"></a><br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/18502654.jpg" alt=""></p><p><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/71089763.jpg" alt=""><br>设计完毕后，点右键-&gt;Jump to source<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/87424770.jpg" alt=""></p><p>注意：idea不会为你生成main方法，需要自己写。</p><p>完整代码：<br>TomcatMonitor<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tomcat监控助手。</span></span><br><span class="line"><span class="comment"> * 用来实现在Tomcat服务异常时，自动重启Tomcat服务。</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TomcatMonitor</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Tomcat启动脚本位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField1;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控地址URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField2;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来显示监控日志的Panel</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextPane logPanel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用帮助按钮</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JButton helpButton;</span><br><span class="line">    JPanel mainPanel;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开始监控按钮</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JButton jkButton;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控间隔（秒）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> JTextField textField3;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否监控的标志位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> listenFlag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">private</span> String tomcatHome;</span><br><span class="line">    <span class="keyword">private</span> String listenUrl;</span><br><span class="line">    <span class="keyword">private</span> String interval;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 监控线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ListenThread lt = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TomcatMonitor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loadConf();</span><br><span class="line">        helpButton.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                JOptionPane.showMessageDialog(<span class="keyword">null</span>, <span class="string">"这是一个tomcat监控小工具，通过定时扫描指定的页面来确认服务是否正常。\n在服务异常时，自动重新启动tomcat服务器。\n启动是通过命令行启动的tomcat的startup.bat脚本。\n"</span>, <span class="string">"使用说明"</span>, JOptionPane.INFORMATION_MESSAGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        logPanel.setContentType(<span class="string">"text/html"</span>);</span><br><span class="line">        logPanel.setEditable(<span class="keyword">false</span>);</span><br><span class="line">        jkButton.addActionListener(<span class="keyword">new</span> ActionListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">                String text = <span class="string">"监控中..."</span>;</span><br><span class="line">                <span class="keyword">if</span> (jkButton.getText().equals(text)) &#123;</span><br><span class="line">                    <span class="keyword">int</span> r = JOptionPane.showConfirmDialog(<span class="keyword">null</span>,<span class="string">"停止监控？"</span>,<span class="string">"系统提示"</span>,JOptionPane.YES_NO_OPTION);</span><br><span class="line">                    <span class="keyword">if</span> (r == JOptionPane.YES_OPTION) &#123;</span><br><span class="line">                        TomcatMonitor.<span class="keyword">this</span>.lt = <span class="keyword">null</span>;</span><br><span class="line">                        TomcatMonitor.<span class="keyword">this</span>.listenFlag = <span class="keyword">false</span>;</span><br><span class="line">                        jkButton.setText(<span class="string">"开始监控"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> validateFlag = validateForm();</span><br><span class="line">                <span class="keyword">if</span> (validateFlag) &#123;</span><br><span class="line">                    TomcatMonitor.<span class="keyword">this</span>.listenFlag = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (lt == <span class="keyword">null</span> ) &#123;</span><br><span class="line">                        lt = <span class="keyword">new</span> ListenThread();</span><br><span class="line">                        lt.start();</span><br><span class="line">                    &#125;</span><br><span class="line">                    jkButton.setText(text);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        insertLog(<span class="string">"tomcat监控助手启动成功！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">validateForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String tomcatHome = textField1.getText();</span><br><span class="line">        String listenUrl = textField2.getText();</span><br><span class="line">        String interval = textField3.getText();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == tomcatHome || <span class="string">""</span>.equals(tomcatHome)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入tomcat启动脚本位置！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == listenUrl || <span class="string">""</span>.equals(listenUrl)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入监控地址！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!listenUrl.startsWith(<span class="string">"http://"</span>)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入正确的监控地址！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interval.matches(<span class="string">"\\d+"</span>)) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"请输入正确的监控间隔（秒）！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> intervalTime = Integer.parseInt(interval);</span><br><span class="line">        <span class="keyword">if</span> (intervalTime &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            JOptionPane.showMessageDialog(<span class="keyword">null</span>,<span class="string">"监控间隔不能小于10秒！"</span>,<span class="string">"系统提示"</span>,JOptionPane.WARNING_MESSAGE);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!tomcatHome.equals(<span class="keyword">this</span>.tomcatHome)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tomcatHome = tomcatHome;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_TOMCAT_HOME,tomcatHome);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!listenUrl.equals(<span class="keyword">this</span>.listenUrl)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.listenUrl = listenUrl;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_LISTEN_URL,listenUrl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!interval.equals(<span class="keyword">this</span>.interval)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.interval = interval;</span><br><span class="line">            PropertiesUtils.setString(PropertiesUtils.KEY_LISTEN_INTERVAL,interval);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadConf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String tomcatHome = PropertiesUtils.getString(PropertiesUtils.KEY_TOMCAT_HOME);</span><br><span class="line">        String listenUrl = PropertiesUtils.getString(PropertiesUtils.KEY_LISTEN_URL);</span><br><span class="line">        String listenInterval = PropertiesUtils.getString(PropertiesUtils.KEY_LISTEN_INTERVAL);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != tomcatHome &amp;&amp; !<span class="string">""</span>.equals(tomcatHome)) &#123;</span><br><span class="line">            textField1.setText(tomcatHome);</span><br><span class="line">            <span class="keyword">this</span>.tomcatHome = tomcatHome;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != listenUrl &amp;&amp; !<span class="string">""</span>.equals(listenUrl)) &#123;</span><br><span class="line">            textField2.setText(listenUrl);</span><br><span class="line">            <span class="keyword">this</span>.listenUrl = listenUrl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != listenInterval &amp;&amp; !<span class="string">""</span>.equals(listenInterval)) &#123;</span><br><span class="line">            textField3.setText(listenInterval);</span><br><span class="line">            <span class="keyword">this</span>.interval = listenInterval;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTomcat</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runtime.exec(tomcatHome);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            insertLog(<span class="string">"启动tomcat失败！error="</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">insertLog</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        StyledDocument sd = logPanel.getStyledDocument();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String current = df.format(<span class="keyword">new</span> Date());</span><br><span class="line">            msg = current + <span class="string">","</span> + msg +<span class="string">"\n"</span>;</span><br><span class="line">            <span class="keyword">int</span> docLength = sd.getLength();</span><br><span class="line">            <span class="keyword">if</span> (docLength &gt; <span class="number">100000</span>) &#123;</span><br><span class="line">                sd.remove(<span class="number">0</span>,docLength);</span><br><span class="line">                sd.insertString(sd.getLength(),<span class="string">"日志过多，之前的日志已被清除！"</span>, logPanel.getCharacterAttributes());</span><br><span class="line">            &#125;</span><br><span class="line">            sd.insertString(sd.getLength(),msg,logPanel.getCharacterAttributes());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadLocationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ListenThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (listenFlag) &#123;</span><br><span class="line">                HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    URL url = <span class="keyword">new</span> URL(listenUrl);</span><br><span class="line">                    connection = (HttpURLConnection) url.openConnection();</span><br><span class="line">                    connection.connect();</span><br><span class="line">                    <span class="keyword">int</span> responseCode = connection.getResponseCode();</span><br><span class="line">                    String msg = <span class="string">"请求URL："</span> + listenUrl + <span class="string">",结果："</span>+ (responseCode &gt; <span class="number">200</span> ? <span class="string">"失败"</span>:<span class="string">"成功"</span>) + <span class="string">",responseCode="</span> + responseCode;</span><br><span class="line">                    insertLog(msg);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    String msg = <span class="string">"监控异常！error="</span> + e.getMessage();</span><br><span class="line">                    insertLog(msg);</span><br><span class="line">                    insertLog(<span class="string">"正在重新启动Tomcat..."</span>);</span><br><span class="line">                    startTomcat();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">null</span> != connection) &#123;</span><br><span class="line">                            connection.disconnect();</span><br><span class="line">                        &#125;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>*Long.parseLong(interval));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        JFrame frame = <span class="keyword">new</span> JFrame(<span class="string">"Tomcat监控小工具"</span>);</span><br><span class="line">        <span class="keyword">final</span> TomcatMonitor tm = <span class="keyword">new</span> TomcatMonitor();</span><br><span class="line">        JScrollPane jsp = <span class="keyword">new</span> JScrollPane(tm.mainPanel);</span><br><span class="line">        frame.setContentPane(jsp);</span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);</span><br><span class="line">        frame.setResizable(<span class="keyword">false</span>);</span><br><span class="line">        frame.pack();</span><br><span class="line">        frame.setSize(<span class="number">800</span>,<span class="number">600</span>);</span><br><span class="line">        frame.setLocationRelativeTo(jsp);</span><br><span class="line">        frame.setVisible(<span class="keyword">true</span>);</span><br><span class="line">        frame.addWindowListener(<span class="keyword">new</span> WindowAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">windowClosing</span><span class="params">(WindowEvent e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">super</span>.windowClosing(e);</span><br><span class="line"></span><br><span class="line">                tm.listenFlag = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>一个属性文件读写工具类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String CONF_FILE = <span class="string">"/TomcatMonitor.properties"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_TOMCAT_HOME = <span class="string">"tomcat.home"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_URL = <span class="string">"listen.url"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String KEY_LISTEN_INTERVAL = <span class="string">"listen.interval"</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        InputStream in = PropertiesUtils.class.getResourceAsStream(CONF_FILE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.load(in);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getString</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> properties.getProperty(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setString</span><span class="params">(String key,String value)</span> </span>&#123;</span><br><span class="line">        properties.setProperty(key,value);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            properties.store(<span class="keyword">new</span> FileOutputStream(PropertiesUtils.class.getResource(CONF_FILE).getPath()),<span class="string">"update "</span> + key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>属性文件TomcatMonitor.properties：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tomcat.home=D:/soft/tomcat7.0.1/bin/startup.bat</span><br><span class="line">listen.url=http://localhost:8080/abc/test.jsp</span><br><span class="line">listen.interval=10</span><br></pre></td></tr></table></figure></p><p>最后打成一个JAR包，方便执行。<br>注意：idea设计的GUI窗体代码在com/intellij下面，这个也要打进去。</p><p>将相关的classes复制到一个单独的目录。如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/53193583.jpg" alt=""><br>注意包括配置文件。</p><p>然后用java命令打包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd E:</span><br><span class="line">jar -cvf aa.jar -C test .</span><br></pre></td></tr></table></figure></p><p>这样打包后jar中的MANIFEST.MF文件中没有Main-Class配置，增加：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/11371864.jpg" alt=""></p><p>然后双击或者在命令行执行java -jar TomcatMonitor.jar就可以了。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-17/56105138.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>观察者模式</title>
      <link href="/2017/09/15/observer-design/"/>
      <url>/2017/09/15/observer-design/</url>
      
        <content type="html"><![CDATA[<p>在软件系统中，当一个对象的行为依赖另外一个对象的状态时，观察者模式就很有用。若不使用观察者模式，实现类似的功能，需要在一个线程中不断监听对象状态的变化。<br>在一个复杂的系统中，可能会因此开启很多线程，这将使系统性能产生额外的负担。</p><p>观察者模式的意义也在于此，它可以在单线程中，在自身状态发生变化时，及时通知所依赖的对象。</p><p>以下使用一个例子来说明。<br>AbstractSubject抽象主题对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 抽象主题类。模拟在修改主题的text属性时，通知所有观察者。</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractSubject</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 主题属性</span></span><br><span class="line">    String text;</span><br><span class="line">    <span class="comment">// 添加观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(IObserver observer)</span></span>;</span><br><span class="line">    <span class="comment">// 删除观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(IObserver observer)</span></span>;</span><br><span class="line">    <span class="comment">// 通知所有观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">inform</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 设置主题属性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>具体主题对象ConcreteSubject<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">AbstractSubject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Vector&lt;IObserver&gt; observers = <span class="keyword">new</span> Vector&lt;IObserver&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addObserver</span><span class="params">(IObserver observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != observer) &#123;</span><br><span class="line">            observers.addElement(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeObserver</span><span class="params">(IObserver observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != observer) &#123;</span><br><span class="line">            observers.removeElement(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">inform</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Event event = <span class="keyword">new</span> Event();</span><br><span class="line">        event.setMsg(text);</span><br><span class="line">        <span class="comment">// 通知所有观察者</span></span><br><span class="line">        <span class="keyword">for</span> (IObserver observer : observers) &#123;</span><br><span class="line">            observer.changeEvent(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置主题属性，并通知所有观察者</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.text = text;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.getClass().getName() + <span class="string">" setText. Text is ["</span> + text + <span class="string">"]."</span>);</span><br><span class="line">        inform();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>在具体的观察者实现类中，维护了一个观察者队列，并提供了添加和删除观察者的方法。在自身状态（text属性）发生变化时，通知所有观察者。</p><p>观察者接口对象IObserver<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 观察者接口。</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IObserver</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 给主题回调的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeEvent</span><span class="params">(Event event)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>具体的观察者ConcreateObserver<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreateObserver</span> <span class="keyword">implements</span> <span class="title">IObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreateObserver</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">changeEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="keyword">this</span>.name + <span class="string">" received subject event. msg="</span> + event.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>主题对象属性text发生变化时，通知观察者的方法参数Event<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 构造一个主题</span></span><br><span class="line">        AbstractSubject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        <span class="comment">// 添加2个观察者</span></span><br><span class="line">        subject.addObserver(<span class="keyword">new</span> ConcreateObserver(<span class="string">"observer-1"</span>));</span><br><span class="line">        subject.addObserver(<span class="keyword">new</span> ConcreateObserver(<span class="string">"observer-2"</span>));</span><br><span class="line">        <span class="comment">// 对主题对象的一个属性设值</span></span><br><span class="line">        subject.setText(<span class="string">"hello"</span>);</span><br><span class="line">        System.out.println(<span class="string">"=================="</span>);</span><br><span class="line">        subject.setText(<span class="string">"你好"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试结果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-15/29424029.jpg" alt=""></p><p>观察者模式如此常用，以至于JDK内部就为我们开发人员提供了一套观察者模式的实现。<br>在java.util包中，包括Observable类和Observer接口。<br>在Observable中，已经实现了主要的功能，包括添加观察者、删除观察者、通知观察者。<br>在Observer接口中，定义了update方法，它会在Observable中的nofityObservers方法中被调用，以获得最新的状态变化。<br>我们只需要继承Observable、并实现Observer接口即可。</p><p>下面仍然是实现上面例子的功能，但这里使用JDK提供的Observable和Observer。<br>具体主题类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJdkObservable</span> <span class="keyword">extends</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.setChanged();</span><br><span class="line">        <span class="keyword">this</span>.notifyObservers();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>具体观察者：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/15.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJdkObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyJdkObserver</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (o <span class="keyword">instanceof</span> MyJdkObservable) &#123;</span><br><span class="line">            MyJdkObservable myJdkObservable = (MyJdkObservable) o;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="keyword">this</span>.name + <span class="string">" received event.MyJdkObservable.name="</span> + myJdkObservable.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MyJdkObservable myJdkObservable = <span class="keyword">new</span> MyJdkObservable();</span><br><span class="line">myJdkObservable.addObserver(<span class="keyword">new</span> MyJdkObserver(<span class="string">"observer-1"</span>));</span><br><span class="line">myJdkObservable.addObserver(<span class="keyword">new</span> MyJdkObserver(<span class="string">"observer-2"</span>));</span><br><span class="line">myJdkObservable.setName(<span class="string">"hello"</span>);</span><br><span class="line">System.out.println(<span class="string">"==================="</span>);</span><br><span class="line">myJdkObservable.setName(<span class="string">"你好"</span>);</span><br></pre></td></tr></table></figure></p><p>测试结果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-15/76090496.jpg" alt=""></p><p>在JDK中，观察者模式也得到的普遍的应用。一个典型的例子就是JButton。JButton继承自AbstractButton，AbstractButton中维护着一组监听器，它们就扮演着观察者的角色。</p><p>参考《Java程序性能优化-让你的Java程序更快、更稳定》(葛一宁等编著)。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java中的native关键字</title>
      <link href="/2017/09/15/java-native-keywords/"/>
      <url>/2017/09/15/java-native-keywords/</url>
      
        <content type="html"><![CDATA[<p>在看《《Java程序性能优化-让你的Java程序更快、更稳定》(葛一宁等编著)》一书时，文中提到JDK中OutputStream和InputStream使用观察者模式，提高I/O性能。<br>如下代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"d:test.txt"</span>)));</span><br></pre></td></tr></table></figure></p><p>通过结合BufferedOutputStream对数据做了缓存处理，调用write方法时并不是每次都会直接写入磁盘。只有当缓冲区满的时候，才会写入磁盘。<br>代码片段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt;= buf.length) &#123;</span><br><span class="line">        <span class="comment">/* If the request length exceeds the size of the output buffer,</span></span><br><span class="line"><span class="comment">           flush the output buffer and then write the data directly.</span></span><br><span class="line"><span class="comment">           In this way buffered streams will cascade harmlessly. */</span></span><br><span class="line">        flushBuffer();</span><br><span class="line">        out.write(b, off, len);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; buf.length - count) &#123;</span><br><span class="line">        flushBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    System.arraycopy(b, off, buf, count, len);</span><br><span class="line">    count += len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>如上代码，最后实际是调用的FileOutputStream的write方法写入磁盘的。最终调用的是FileOutputStream的writeBytes方法，这是一个native方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">writeBytes</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len, <span class="keyword">boolean</span> append)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure></p><p>可以看到，它的实现并不在FileOutputStream。</p><p>那么，到底最终是如何写入磁盘的呢？</p><p>native关键字说明其修饰的方法是一个原生态方法，方法对应的实现不是在当前文件，而是在用其他语言（如C和C++）实现的文件中。Java语言本身不能对操作系统底层进行访问和操作，但是可以通过JNI接口调用其他语言来实现对底层的访问。</p><p>具体可以参考这2篇文章：<a href="http://blog.csdn.net/funneies/article/details/8949660">Java中native关键字</a>、<a href="https://www.ibm.com/developerworks/cn/java/jnimthds/">在 Windows 中实现 Java 本地方法</a>.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>装饰者模式</title>
      <link href="/2017/09/14/decorator-design/"/>
      <url>/2017/09/14/decorator-design/</url>
      
        <content type="html"><![CDATA[<p>装饰者模式有一个设计非常巧妙的结构，可以为对象动态添加功能。在基本的设计原则中，有一个重要的原则叫做合成/聚合复用原则。根据该原则的思想，代码复用应该尽可能使用委托，而不是继承。<br>因为继承是一种紧密耦合，任何父类的改动都会影响其子类，不利于系统维护。而委托则是松散耦合，只要接口不变，委托类的变动并不会影响其上层维护对象。</p><p>装饰者模式充分运用了这种思想，通过委托机制，复用系统的各个组件，在运行时，将这些组件功能进行叠加，从而构造出一个“超级对象”，使其拥有所有这些组件的功能。<br>而各个子功能模块，被很好的维护在各个组件的相关类中，拥有简洁的系统结构。</p><p>下面以一个例子来说明。<br>IPacketCretor即装饰者接口，用于处理具体的内容。PacketBodyCreator是具体的组件，用于构造要发布的信息的核心内容，但是它不负责将其构造成一个格式工整、可直接发布的数据格式。<br>PacketHTTPHeaderCreator负责给具体的内容加上HTTP头部，PacketHTMLHeaderCreator负责将给定的内容格式化成HTML文本。3个功能组件相互独立且分离，便于系统维护。<br><a id="more"></a><br>IPacketCreator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPacketCreator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleContent</span><span class="params">()</span></span>; <span class="comment">// 用于处理具体内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PacketBodyCreator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PacketBodyCreator</span> <span class="keyword">implements</span> <span class="title">IPacketCreator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Content of packet."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PacketDecorator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">PacketDecorator</span> <span class="keyword">implements</span> <span class="title">IPacketCreator</span> </span>&#123;</span><br><span class="line">    IPacketCreator ipc;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PacketDecorator</span><span class="params">(IPacketCreator ipc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ipc = ipc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PacketHTMLHeaderCreator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PacketHTMLHeaderCreator</span> <span class="keyword">extends</span> <span class="title">PacketDecorator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PacketHTMLHeaderCreator</span><span class="params">(IPacketCreator ipc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ipc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        buffer.append(<span class="string">"&lt;html&gt;"</span>);</span><br><span class="line">        buffer.append(<span class="string">"&lt;body&gt;"</span>);</span><br><span class="line">        buffer.append(ipc.handleContent());</span><br><span class="line">        buffer.append(<span class="string">"&lt;/body&gt;"</span>);</span><br><span class="line">        buffer.append(<span class="string">"&lt;/html&gt;"</span>);</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>PacketHTTPHeaderCreator<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PacketHTTPHeaderCreator</span> <span class="keyword">extends</span> <span class="title">PacketDecorator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PacketHTTPHeaderCreator</span><span class="params">(IPacketCreator ipc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(ipc);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handleContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        buffer.append(<span class="string">"Cache-Control:no-cache\n"</span>);</span><br><span class="line">        buffer.append(ipc.handleContent());</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类Main<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IPacketCreator ipc = <span class="keyword">new</span> PacketHTTPHeaderCreator(<span class="keyword">new</span> PacketHTMLHeaderCreator(<span class="keyword">new</span> PacketBodyCreator()));</span><br><span class="line">        System.out.println(ipc.handleContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/48666.jpg" alt=""></p><p>对于装饰者模式，另一个值得关注的地方是它的使用方法。在本例中，通过层层构造和组装装饰者与被装饰者到一个对象中，使其有机的结合在一起工作。</p><p>在本例中，共生成3个对象实例，PacketBodyCreator作为核心组件被首先 构造，其次是PacketHTMLHeaderCreator（将内容包装成HTML格式），最后是PacketHTTPHeaderCreator（添加HTTP头）。</p><p>在JDK的实现中，也有装饰者模式的实现。一个典型的例子就是OutputStream和InputStream的实现。以OutputStream为例，OutputStream提供的功能较弱，通过各种装饰器的增强，OutputStream可以被赋予强大的功能。</p><p>生成一个有缓冲功能的流对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"d:/test.txt"</span>)));</span><br></pre></td></tr></table></figure></p><p>生成一个没有缓冲功能的流对象<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DataOutputStream dos = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"d:/test.txt"</span>));</span><br></pre></td></tr></table></figure></p><p>第1种加入了性能组件BufferedOutputStream，第二种则没有。因此第1种拥有更好的性能。</p><p>在BufferedOutputStream中，并不是每次调用write方法都会向磁盘写入数据，而是将数据写入缓冲，只有缓冲满的时候才会调用FileOutputStream的write方法向磁盘写入，以此实现功能组件与性能组件的完美分离。</p><p>参考：《《Java程序性能优化-让你的Java程序更快、更稳定》(葛一宁等编著)》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>享元模式</title>
      <link href="/2017/09/14/flwweight-design/"/>
      <url>/2017/09/14/flwweight-design/</url>
      
        <content type="html"><![CDATA[<p>定义：<br>享元模式（Flyweight Pattern）主要用于减少创建对象的数量，以减少内存占用和提高性能。这种类型的设计模式属于结构型模式，它提供了减少对象数量从而改善应用所需的对象结构的方式。<br>享元模式尝试重用现有的同类对象，如果未找到匹配的对象，则创建新对象。</p><p>它与单例模式相似，最大区别在于单例模式一个类只有一个实例；享元模式一个类有多个实例。</p><p>来自微博<a href="http://weibo.com/1812166904/EtwURkuyJ?type=comment">Barret李靖</a>对享元模式的说明：<br>如何理解享元模式，“享”是共享的意思，“元”指的是元件，也就是小颗粒的东西，享元顾名思义便是共享小部件，很多系统或者程序包含大量对象，但是这些对象绝大多数都是差不多的，除了一些极个别的属性外。<br><a id="more"></a><br>在享元模式中有两个比较重要的关键词，内部变量和外部变量；内部变量是可以共享的属性集，而外部变量是对象之间的差异部分，通过相同+不同的方式组合诸多对象，可以有效地节省系统空间，降低内存大小。</p><p>这里有一个使用五子棋来说明的例子。<br><a href="http://blog.csdn.net/xu__cg/article/details/53054439">http://blog.csdn.net/xu__cg/article/details/53054439</a></p><p>其他参考：<br><a href="http://www.runoob.com/design-pattern/flyweight-pattern.html">http://www.runoob.com/design-pattern/flyweight-pattern.html</a><br><a href="http://blog.csdn.net/jason0539/article/details/22908915">http://blog.csdn.net/jason0539/article/details/22908915</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sublime-Text3使用</title>
      <link href="/2017/09/14/Sublime-Text3/"/>
      <url>/2017/09/14/Sublime-Text3/</url>
      
        <content type="html"><![CDATA[<p>Sublime Text是一款神奇的编辑器，号称程序员必备神器！。以下简称ST。<br>ST是一款收费软件，但可以免费无限制无限期的使用，只是偶尔会提示你。<br>ST的一些说明：<a href="http://www.iplaysoft.com/sublimetext.html">http://www.iplaysoft.com/sublimetext.html</a>.</p><h2 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h2><p>首先，从<a href="http://www.sublimetext.com/">Sublime Text官网</a>下载ST3。下载后直接双击安装即可。</p><h2 id="字体设置"><a href="#字体设置" class="headerlink" title="字体设置"></a>字体设置</h2><p>点击“Preferences-&gt;Settings”菜单，在用户设置中增加font_face，然后保存即可。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/62616641.jpg" alt=""><br><a id="more"></a><br>如上，我使用的字体是Monaco，字体大小是10号。效果看起来还不错。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/54158762.jpg" alt=""></p><h2 id="安装包管理器"><a href="#安装包管理器" class="headerlink" title="安装包管理器"></a>安装包管理器</h2><p>打开<a href="https://packagecontrol.io/installation">https://packagecontrol.io/installation</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/61959757.jpg" alt=""><br>复制红框中的代码，打开ST，选择菜单“View-&gt;Show Console”，然后在控制台粘贴刚刚复制的代码，然后回车，等待安装完成。<br>安装完成后，重启ST，在ST的“Preferences”菜单中可以看到“Package Control”。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/16986909.jpg" alt=""></p><p>后续安装插件，CTRL+SHIFT+P，输入install，回车，然后输入要安装的插件名称，回车就可以安装了。</p><h2 id="常用插件安装"><a href="#常用插件安装" class="headerlink" title="常用插件安装"></a>常用插件安装</h2><p>1、主题插件Boxy-Theme<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-14/66318573.jpg" alt=""><br>说明：这个插件我用绿色版的ST3在线安装时没找到。</p><p>2、Markdown Editing<br>Markdown编辑高亮插件。</p><p>3、OmniMarkupPreviewer<br>Markdown实时预览插件<br>参考：<a href="http://macplay.leanote.com/post/%E8%BF%91%E4%B9%8E%E5%AE%8C%E7%BE%8E%E7%9A%84-Markdown-%E5%86%99%E4%BD%9C%E4%BD%93%E9%AA%8C-Sublime-Text-3-OmniMarkupPreviewer">近乎完美的 Markdown 写作体验 - Sublime Text 3 + OmniMarkupPreviewer</a></p><p>4、BracketHighlighter<br>用于匹配括号，引号和html标签。对于很长的代码很有用。安装好之后，不需要设置插件会自动生效</p><p>5、Emmet<br>快速生成HTML代码段的插件，强大到无与伦比:可以超快速编写HTML/CSS/JS，当然这个插件还支持多种编译环境，如常见的：Eclipse/Aptana、Coda、Notepad++、Adobe Dreamweaver、TextMate等，web开发必备！！！。</p><h2 id="更多使用技巧"><a href="#更多使用技巧" class="headerlink" title="更多使用技巧"></a>更多使用技巧</h2><p>参考：<a href="https://www.jeffjade.com/2015/12/15/2015-04-17-toss-sublime-text/">如何优雅地使用Sublime Text</a>、<a href="http://blog.csdn.net/stilling2006/article/details/54376743">Sublime Text 3 全程详细图文原创教程（持续更新中。。。）</a></p><h2 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h2><p>1、404 error on preview … “buffer_id(29) is not valid (closed or unsupported file format)”<br>解决办法：<br><a href="http://blog.csdn.net/zhangyunfei_happy/article/details/54573435">http://blog.csdn.net/zhangyunfei_happy/article/details/54573435</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>代理模式</title>
      <link href="/2017/09/10/proxy-mode/"/>
      <url>/2017/09/10/proxy-mode/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>代理模式是一种常见的设计模式，它使用代理对象完成用户请求，屏蔽了用户对真实对象的访问。</p><p>在软件设计中，使用代理模式的意图也很多。比如因为安全原因，屏蔽客户端直接访问真实对象。或者在远程调用中，使用代理类来屏蔽远程方法调用的技术细节。或为了提升系统性能，将真实对象封装，达到延迟加载的目的。比如hibernate就使用了cglib来实现延迟加载。<br>这里使用代理模式实现延迟加载，提升系统性能和速度。</p><h2 id="不使用代理模式的直接调用"><a href="#不使用代理模式的直接调用" class="headerlink" title="不使用代理模式的直接调用"></a>不使用代理模式的直接调用</h2><p>这里定义一个IUserService接口类，提供一个request方法；UserService实现IUserService接口。Main为测试类。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">request</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IUserService ius = <span class="keyword">new</span> UserService();</span><br><span class="line">        String result = ius.request();</span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>下面定义一个UserServiceProxy来代理UserService，对外提供服务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceProxy</span> <span class="keyword">implements</span> <span class="title">IUserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> UserService us = <span class="keyword">null</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 延迟加载us的实例，在实际使用时初始化</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == us) &#123;</span><br><span class="line">            us = <span class="keyword">new</span> UserService();</span><br><span class="line">            System.out.println(<span class="string">"Created UserService."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> us.request();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通过代理类调用</span></span><br><span class="line">        IUserService ius = <span class="keyword">new</span> UserServiceProxy();</span><br><span class="line">        System.out.println(<span class="string">"Created proxy."</span>);</span><br><span class="line">        String result = ius.request();</span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>输出：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-10/8415170.jpg" alt=""><br>可以看到，在实际调用request()方法时才初始化UserService.<br>静态代理很大的一个问题：所有的代理类必须实现接口，现在是一个UserService，如果还有其他的XXService，每个XXServiceProxy都需要实现XXService接口，这是很麻烦的。</p><h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><p>上面看到了使用静态代理的一个大问题，我们可以通过JDK动态代理来实现。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * jdk动态代理。</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 真实对象</span></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdkDynamicProxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 调用真实对象的方法</span></span><br><span class="line">        Object result = method.invoke(target,args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取目标对象的代理对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),target.getClass().getInterfaces(),<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// JDK动态代理</span></span><br><span class="line">        <span class="comment">// 真实对象</span></span><br><span class="line">        IUserService ius = <span class="keyword">new</span> UserService();</span><br><span class="line">        <span class="comment">// 代理对象</span></span><br><span class="line">        IUserService us = (IUserService) <span class="keyword">new</span> JdkDynamicProxy(ius).getProxy();</span><br><span class="line">        String result = us.request();</span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>如上代码，可以代理任何接口。但它也有个问题，要代理的类必须实现接口。。如果不想实现接口，还要能够代理，可以使用cglib.</p><h2 id="cglib动态代理"><a href="#cglib动态代理" class="headerlink" title="cglib动态代理"></a>cglib动态代理</h2><p>cglib是针对类来实现代理的，他的原理是对指定的目标类生成一个子类，并覆盖其中方法实现增强，但因为采用的是继承，所以不能对final修饰的类进行代理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibProxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 通过代理类调用父类中的方法</span></span><br><span class="line">        <span class="keyword">return</span> methodProxy.invokeSuper(o,args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置需要创建之类的类</span></span><br><span class="line">        enhancer.setSuperclass(clazz);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过字节码结束创建之类实例</span></span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/10.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        CglibProxy cp = <span class="keyword">new</span> CglibProxy();</span><br><span class="line">        UserService ius = (UserService) cp.getProxy(UserService.class);</span><br><span class="line">        String result = ius.request();</span><br><span class="line">        System.out.println(<span class="string">"result:"</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>更多代理模式参考：<a href="http://blog.csdn.net/yakoo5/article/details/9099133/">http://blog.csdn.net/yakoo5/article/details/9099133/</a><br><a href="http://www.importnew.com/22015.html">http://www.importnew.com/22015.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper客户端api操作</title>
      <link href="/2017/09/09/zookeeper-client-api/"/>
      <url>/2017/09/09/zookeeper-client-api/</url>
      
        <content type="html"><![CDATA[<p>这里记录zookeeper java客户端api的使用。</p><p>客户端创建Zookeeper实例，然后调用这个类提供的方法与zookeeper服务器进行交互。<br>Zookeeper的构造函数有如下4种：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZooKeeper(connectString, sessionTimeout, watcher);</span><br><span class="line">ZooKeeper(connectString, sessionTimeout, watcher,canBeReadOnly);</span><br><span class="line">ZooKeeper(connectString, sessionTimeout, watcher, sessionId, sessionPasswd);</span><br><span class="line">ZooKeeper(connectString, sessionTimeout, watcher, sessionId, sessionPasswd, canBeReadOnly);</span><br></pre></td></tr></table></figure></p><p>参数说明：<br>connectString: 连接字符串 例如 “127.0.0.1:2181”<br>sessionTimeout: 会话超时时间 以毫秒为单位的整型值 在sessionTimeout时间内服务端与客户端没有有效的心跳检测 则会话失效<br>watcher: 默认的事件通知处理器<br>sessionId: 会话ID<br>sessionPasswd: 会话秘钥<br>canBeReadOnly: 是否是只读<br><a id="more"></a></p><p>String create(String path, byte[] data, List<ACL> acl,CreateMode createMode)<br>创建一个给定的目录节点 path, 并给它设置数据，CreateMode 标识有四种形式的目录节点，分别是 PERSISTENT：持久化目录节点，这个目录节点存储的数据不会丢失；PERSISTENT_SEQUENTIAL：顺序自动编号的目录节点，这种目录节点会根据当前已近存在的节点数自动加 1，然后返回给客户端已经成功创建的目录节点名；EPHEMERAL：临时目录节点，一旦创建这个节点的客户端与服务器端口也就是 session 超时，这种节点会被自动删除；EPHEMERAL_SEQUENTIAL：临时自动编号节点</p><p>Stat exists(String path, boolean watch)<br>判断某个 path 是否存在，并设置是否监控这个目录节点，这里的 watcher 是在创建 ZooKeeper 实例时指定的 watcher，exists方法还有一个重载方法，可以指定特定的watcher</p><p>Stat exists(String path,Watcher watcher)<br>重载方法，这里给某个目录节点设置特定的 watcher，Watcher 在 ZooKeeper 是一个核心功能，Watcher 可以监控目录节点的数据变化以及子目录的变化，一旦这些状态发生变化，服务器就会通知所有设置在这个目录节点上的 Watcher，从而每个客户端都很快知道它所关注的目录节点的状态发生变化，而做出相应的反应</p><p>void delete(String path, int version)<br>删除 path 对应的目录节点，version 为 -1 可以匹配任何版本，也就删除了这个目录节点所有数据</p><p>List<String>getChildren(String path, boolean watch)<br>获取指定 path 下的所有子目录节点，同样 getChildren方法也有一个重载方法可以设置特定的 watcher 监控子节点的状态</p><p>Stat setData(String path, byte[] data, int version)<br>给 path 设置数据，可以指定这个数据的版本号，如果 version 为 -1 怎可以匹配任何版本</p><p>byte[] getData(String path, boolean watch, Stat stat)<br>获取这个 path 对应的目录节点存储的数据，数据的版本等信息可以通过 stat 来指定，同时还可以设置是否监控这个目录节点数据的状态</p><p>void addAuthInfo(String scheme, byte[] auth)<br>客户端将自己的授权信息提交给服务器，服务器将根据这个授权信息验证客户端的访问权限。</p><p>Stat setACL(String path,List<ACL> acl, int version)<br>给某个目录节点重新设置访问权限，需要注意的是 Zookeeper 中的目录节点权限不具有传递性，父目录节点的权限不能传递给子目录节点。目录节点 ACL由两部分组成：perms 和 id。Perms 有 ALL、READ、WRITE、CREATE、DELETE、ADMIN 几种,而 id 标识了访问目录节点的身份列表，默认情况下有以下两种：ANYONE_ID_UNSAFE = new Id(“world”, “anyone”) 和 AUTH_IDS = new Id(“auth”, “”) 分别表示任何人都可以访问和创建者拥有访问权限。</p><p>List<ACL> getACL(String path,Stat stat)<br>获取某个目录节点的访问权限列表</p><p>下面通过一个配置JDBC的url、username、password，并从zookeeper读取的示例来说明<br>配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/8.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZkTest1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_CONNECTION_STR = <span class="string">"192.168.74.125:2181"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">30000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AUTH_TYPE = <span class="string">"digest"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AUTH_ID_PWD = <span class="string">"admin:123456"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_ROOT = <span class="string">"/dbConf"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_URL = ZK_ROOT + <span class="string">"/url"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_USERNAME = ZK_ROOT + <span class="string">"/username"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_PWD = ZK_ROOT + <span class="string">"/password"</span>;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZkTest1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        getZK();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ZooKeeper <span class="title">getZK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zk = <span class="keyword">new</span> ZooKeeper(ZK_CONNECTION_STR, SESSION_TIMEOUT, <span class="keyword">new</span> Watcher() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">                    System.out.println(watchedEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">while</span> (zk.getState() != ZooKeeper.States.CONNECTED) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> zk;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createNode</span><span class="params">(String path,<span class="keyword">byte</span>[] value,String idPassword)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 指定认证模式为digest</span></span><br><span class="line">        Id id = <span class="keyword">new</span> Id(AUTH_TYPE,idPassword);</span><br><span class="line">        <span class="comment">// 创建的节点有所有权限</span></span><br><span class="line">        ACL acl = <span class="keyword">new</span> ACL(ZooDefs.Perms.ALL,id);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            zk.create(path, value, Collections.singletonList(acl), CreateMode.PERSISTENT);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getNodeValue</span><span class="params">(String path,String idPassword)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 由于创建节点时指定了权限，所以这里必须设置权限才能查询</span></span><br><span class="line">            <span class="comment">// 注意：这里auth是不用加密的。</span></span><br><span class="line">            zk.addAuthInfo(AUTH_TYPE,AUTH_ID_PWD.getBytes());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(zk.getData(path,<span class="keyword">false</span>,<span class="keyword">null</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeeperException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeZK</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != zk) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                zk.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ZkTest1 zkTest1 = <span class="keyword">new</span> ZkTest1();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String idPassword = DigestAuthenticationProvider.generateDigest(AUTH_ID_PWD);</span><br><span class="line">            <span class="comment">// 创建根节点</span></span><br><span class="line">            zkTest1.createNode(ZK_ROOT,<span class="string">"abc"</span>.getBytes(),idPassword);</span><br><span class="line">            String rootValue = zkTest1.getNodeValue(ZK_ROOT,idPassword);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(rootValue)) &#123;</span><br><span class="line">                System.out.println(ZK_ROOT + <span class="string">"节点创建成功！value="</span> + rootValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建url节点</span></span><br><span class="line">            zkTest1.createNode(ZK_URL,<span class="string">"10.10.1.19"</span>.getBytes(),idPassword);</span><br><span class="line">            String urlValue = zkTest1.getNodeValue(ZK_URL,idPassword);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(urlValue)) &#123;</span><br><span class="line">                System.out.println(ZK_URL + <span class="string">"节点创建成功！value="</span> + urlValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建username节点</span></span><br><span class="line">            zkTest1.createNode(ZK_USERNAME,<span class="string">"root"</span>.getBytes(),idPassword);</span><br><span class="line">            String usernameValue = zkTest1.getNodeValue(ZK_USERNAME,idPassword);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(urlValue)) &#123;</span><br><span class="line">                System.out.println(ZK_USERNAME + <span class="string">"节点创建成功！value="</span> + usernameValue);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建password节点</span></span><br><span class="line">            zkTest1.createNode(ZK_PWD,<span class="string">"123456"</span>.getBytes(),idPassword);</span><br><span class="line">            String pwdValue = zkTest1.getNodeValue(ZK_PWD,idPassword);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isNotEmpty(pwdValue)) &#123;</span><br><span class="line">                System.out.println(ZK_PWD + <span class="string">"节点创建成功！value="</span> + pwdValue);</span><br><span class="line">            &#125;</span><br><span class="line">            zkTest1.closeZK();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>读取zookeeper配置的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2017/9/8.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZKTest2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_CONNECTION_STR = <span class="string">"192.168.74.125:2181"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> SESSION_TIMEOUT = <span class="number">30000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_ROOT = <span class="string">"/dbConf"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_URL_PATH = ZK_ROOT+<span class="string">"/url"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_USERNAME_PATH = ZK_ROOT+<span class="string">"/username"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ZK_PASSWD_PATH = ZK_ROOT+<span class="string">"/password"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AUTH_TYPE = <span class="string">"digest"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String AUTH_PASSWD = <span class="string">"admin:abc1"</span>;</span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> ZooKeeper zk = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ZooKeeper <span class="title">getZK</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        zk = <span class="keyword">new</span> ZooKeeper(ZK_CONNECTION_STR,SESSION_TIMEOUT,<span class="keyword">new</span> MyWatcher());</span><br><span class="line">        <span class="keyword">while</span> (zk.getState() != ZooKeeper.States.CONNECTED) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        zk.addAuthInfo(AUTH_TYPE,AUTH_PASSWD.getBytes());</span><br><span class="line">        <span class="keyword">return</span> zk;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getZKValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.url = <span class="keyword">new</span> String(zk.getData(ZK_URL_PATH,<span class="keyword">true</span>,<span class="keyword">null</span>));</span><br><span class="line">            <span class="keyword">this</span>.username = <span class="keyword">new</span> String(zk.getData(ZK_USERNAME_PATH,<span class="keyword">true</span>,<span class="keyword">null</span>));</span><br><span class="line">            <span class="keyword">this</span>.password = <span class="keyword">new</span> String(zk.getData(ZK_PASSWD_PATH,<span class="keyword">true</span>,<span class="keyword">null</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyWatcher</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent watchedEvent)</span> </span>&#123;</span><br><span class="line">            Event.EventType eventType = watchedEvent.getType();</span><br><span class="line">            <span class="keyword">if</span> (eventType == Event.EventType.None) &#123;</span><br><span class="line">                System.out.println(<span class="string">"服务器连接成功"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eventType == Event.EventType.NodeCreated) &#123;</span><br><span class="line">                System.out.println(<span class="string">"节点创建成功"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eventType == Event.EventType.NodeDataChanged) &#123;</span><br><span class="line">                System.out.println(<span class="string">"数据修改成功"</span>);</span><br><span class="line">                getZKValue();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eventType == Event.EventType.NodeDeleted) &#123;</span><br><span class="line">                System.out.println(<span class="string">"节点删除成功"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (eventType == Event.EventType.NodeChildrenChanged) &#123;</span><br><span class="line">                System.out.println(<span class="string">"子节点数据修改成功"</span>);</span><br><span class="line">                getZKValue();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUrl</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url = url;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException, IOException, NoSuchAlgorithmException </span>&#123;</span><br><span class="line">        ZKTest2 zkTest2 = <span class="keyword">new</span> ZKTest2();</span><br><span class="line">        ZooKeeper zk = zkTest2.getZK();</span><br><span class="line">        String auth = DigestAuthenticationProvider.generateDigest(AUTH_PASSWD);</span><br><span class="line">        System.out.println(<span class="string">"auth:"</span> +auth);</span><br><span class="line">        <span class="keyword">int</span> loopCount = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; loopCount) &#123;</span><br><span class="line">            zkTest2.getZKValue();</span><br><span class="line">            System.out.println(<span class="string">"url:"</span> + zkTest2.getUrl());</span><br><span class="line">            System.out.println(<span class="string">"username:"</span> + zkTest2.getUsername());</span><br><span class="line">            System.out.println(<span class="string">"password:"</span> + zkTest2.getPassword());</span><br><span class="line">            System.out.println(<span class="string">"--------------------------------------"</span>);</span><br><span class="line">            i++;</span><br><span class="line">            Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        zk.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>代码中，创建节点时使用的是digest认证，id和password为admin:123456，但读取时为admin:abc1.<br>这个时候运行程序是会出错的，如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-9/85939493.jpg" alt=""><br>提示没有权限，将读取配置类中id和password修改为与创建节点的一样（admin:123456），再次运行。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-9/45196239.jpg" alt=""></p><blockquote><p>创建节点时id与password是要经过加密的，即DigestAuthenticationProvider.generateDigest(AUTH_PASSWD);但是验证时不需要。<br>同时在zookeeper的客户端中执行命令创建节点时，使用明文密码时可以创建成功的，但没法验证成功。</p></blockquote><p>zookeeper客户端中，使用$ZOOKEEPER_HOME/bin/zkCli.sh -server zookeeper服务器IP:端口连接zookeeper服务器。<br>输入help查看所有命令：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-9/95678110.jpg" alt=""></p><p>zookeeper权限验证：<a href="http://blog.csdn.net/cainiaoxiaozhou/article/details/52954851">http://blog.csdn.net/cainiaoxiaozhou/article/details/52954851</a><br>zookeeper客户端api操作：<a href="https://www.2cto.com/kf/201610/558610.html">https://www.2cto.com/kf/201610/558610.html</a><br><a href="http://www.cnblogs.com/ggjucheng/p/3370359.html">http://www.cnblogs.com/ggjucheng/p/3370359.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper安装与配置</title>
      <link href="/2017/09/09/zookeeper-install-and-config/"/>
      <url>/2017/09/09/zookeeper-install-and-config/</url>
      
        <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现。<br>参考：<a href="http://blog.csdn.net/u013068377/article/details/52620647">http://blog.csdn.net/u013068377/article/details/52620647</a><br><a href="http://blog.csdn.net/xuxiuning/article/details/51218941">http://blog.csdn.net/xuxiuning/article/details/51218941</a><br>zookeeper官方文档：<a href="https://zookeeper.apache.org/doc/trunk/">https://zookeeper.apache.org/doc/trunk/</a><br>最好还是读官方文档，很详细。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>这里以Linux为例。<br>zookeeper官网：<a href="https://zookeeper.apache.org/">https://zookeeper.apache.org/</a><br>从官网下载最新稳定版本，这里测试版本为3.4.9.</p><p>下载后，解压缩<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xvf zookeeper-3.4.9.tar.gz</span><br></pre></td></tr></table></figure></p><p>注意：zookeeper运行需要依赖java环境，所以需要配置好java环境。<br><a id="more"></a></p><h2 id="单机配置"><a href="#单机配置" class="headerlink" title="单机配置"></a>单机配置</h2><p>在$ZOOKEEPER_HOME$/conf目录下，新建zoo.cfg文件。<br>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">dataDir=/var/zookeeper</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure></p><p>具体的配置参数的含义后面介绍。</p><p>配置完毕后，在$ZOOKEEPER_HOME$执行下面的命令启动zookeeper<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/zkServer.sh start &amp;</span><br></pre></td></tr></table></figure></p><h2 id="伪集群配置"><a href="#伪集群配置" class="headerlink" title="伪集群配置"></a>伪集群配置</h2><p>参考“集群配置”，伪集群实际上是在一台机器部署多个zookeeper实例来构建集群，因为是同一台机器，所以各个zookeeper实例的端口与dataDir不同。<br>配置参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000 </span><br><span class="line">dataDir=/var/zookeeper/ </span><br><span class="line">clientPort=2181 </span><br><span class="line">initLimit=5 </span><br><span class="line">syncLimit=2 </span><br><span class="line">server.1=localhost:2887:3887 </span><br><span class="line">server.2=localhost:2888:3888 </span><br><span class="line">server.3=localhost:2889:3889</span><br></pre></td></tr></table></figure></p><h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><p>为了获得可靠的zookeeper服务，实际使用应该部署zookeeper集群。只要多于半数的zookeeper服务OK，那么整个zookeeper服务也是OK的。<br>而且，部署时最好部署奇数台zookeeper服务。</p><p>在每个zookeeper实例的dataDir参数指定的目录中，创建一个名为myid的文件，文件的内容指定自身的id值。<br>假设部署3台zookeeper构成的集群，分别命名为server1,server2,server3，那么server1的myid的内容就是1，server2的myid的内容就是2，等等…<br>每个zookeeper的conf目录中，新建zoo.cfg，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000 </span><br><span class="line">dataDir=/var/zookeeper/ </span><br><span class="line">clientPort=2181 </span><br><span class="line">initLimit=5 </span><br><span class="line">syncLimit=2 </span><br><span class="line">server.1=server1:2888:3888 </span><br><span class="line">server.2=server2:2888:3888 </span><br><span class="line">server.3=server3:2888:3888</span><br></pre></td></tr></table></figure></p><p>server.id=host:port:port，指示了集群中所有zookeeper。第一个port是follower与leader通信的端口，第2个port是进行leader选举的端口。</p><h2 id="zookeeper配置参数"><a href="#zookeeper配置参数" class="headerlink" title="zookeeper配置参数"></a>zookeeper配置参数</h2><p>tickTime：心跳时间，为了确保连接存在的，以毫秒为单位，最小超时时间为2个心跳时间<br>initLimit：多少个心跳时间内，允许其他server连接并初始化数据，如果ZooKeeper管理的数据较大，则应相应增大这个值<br>clientPort：服务的监听端口<br>dataDir：用于存放内存数据库快照的文件夹，同时用于集群的myid文件也存在这个文件夹里（注意：一个配置文件只能包含一个dataDir字样，即使它被注释掉了。）<br>dataLogDir：用于单独设置transaction log的目录，transaction log分离可以避免和普通log还有快照的竞争<br>syncLimit：多少个tickTime内，允许follower同步，如果follower落后太多，则会被丢弃。</p><p>server.A=B：C：D：<br>A是一个数字,表示这个是第几号服务器,B是这个服务器的ip地址<br>C第一个端口用来集群成员的信息交换,表示的是这个服务器与集群中的Leader服务器交换信息的端口<br>D是在leader挂掉时专门用来进行选举leader所用</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>单例模式的实现方式</title>
      <link href="/2017/09/03/singleton/"/>
      <url>/2017/09/03/singleton/</url>
      
        <content type="html"><![CDATA[<h2 id="饿汉式"><a href="#饿汉式" class="headerlink" title="饿汉式"></a>饿汉式</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：必须是私有构造方法，防止不会被其他代码实例化。这种实现唯一的不足是不能实现延迟加载。<br><a id="more"></a></p><h2 id="懒汉式-不同步"><a href="#懒汉式-不同步" class="headerlink" title="懒汉式-不同步"></a>懒汉式-不同步</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：这种实现没有考虑多线程的情况，需要做同步处理，否则多线程会导致产生多个实例。</p><h2 id="懒汉式-同步"><a href="#懒汉式-同步" class="headerlink" title="懒汉式-同步"></a>懒汉式-同步</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton instance = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> Singleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：这种实现考虑了多线程的情况，但是由于做了同步，会导致性能较差（相对于饿汉式）。</p><h2 id="懒汉式改造"><a href="#懒汉式改造" class="headerlink" title="懒汉式改造"></a>懒汉式改造</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticSingleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">StaticSingleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> StaticSingleton instance = <span class="keyword">new</span> StaticSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> StaticSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在这种实现中，使用内部类来维护单例的实例。当StaticSingleton被实例化时，其内部类并不会实例化。当getInstance()方法被调用时，才会加载SingletonHolder，从而初始化instance。<br>同时，由于实例的建立，是在类加载时完成的，所以天生对多线程友好。getInstance()方法也不需要同步关键字。<br>因此，这种实现既做到了延迟加载，又不用使用同步关键字。</p><h2 id="使用枚举"><a href="#使用枚举" class="headerlink" title="使用枚举"></a>使用枚举</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleObject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> SingletonInstance &#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line">        <span class="keyword">private</span> SingleObject instance;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//JVM会保证此方法绝对只调用一次</span></span><br><span class="line">        SingletonInstance() &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> SingleObject();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SingleObject <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> instance;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleObject <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonInstance.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 测试100个线程获取单例实例对象是否是同一个。</span></span><br><span class="line">        IntStream.rangeClosed(<span class="number">1</span>,<span class="number">100</span>).forEach(i -&gt; <span class="keyword">new</span> Thread(<span class="string">"t-"</span>+i)&#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">"==&gt;"</span> + SingleObject.getInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="确保反序列化仍然得到单例对象"><a href="#确保反序列化仍然得到单例对象" class="headerlink" title="确保反序列化仍然得到单例对象"></a>确保反序列化仍然得到单例对象</h2><p>通常，使用上面的方式创建的单例已经能确保是唯一的实例。但仍然有例外情况生成多个实例。比如，通过反射机制，强行调用类的私有构造方法。或者对象序列化/反序列化。<br>实现序列化接口的单例类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerSingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SerSingleton instance = <span class="keyword">new</span> SerSingleton();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerSingleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SerSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>测试<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SerSingleton s1 = SerSingleton.getInstance();</span><br><span class="line"><span class="comment">// 将单例对象串行化到文件</span></span><br><span class="line">String filepath = <span class="string">"d:/SerSingleton.txt"</span>;</span><br><span class="line">ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(filepath));</span><br><span class="line">oos.writeObject(s1);</span><br><span class="line">oos.flush();</span><br><span class="line">oos.close();</span><br><span class="line">System.out.println(s1);</span><br><span class="line"><span class="comment">// 从文件读出原有的单例对象</span></span><br><span class="line">ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(filepath));</span><br><span class="line">SerSingleton s2 = (SerSingleton) ois.readObject();</span><br><span class="line">ois.close();</span><br><span class="line">System.out.println(s2);</span><br><span class="line">System.out.println(s1 == s2);</span><br></pre></td></tr></table></figure></p><p>测试结果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-3/2110772.jpg" alt=""><br>可以看到，经过反序列化后产生了不同的实例。</p><p>我们现在对SerSinglton增加一个readResolve()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerSingleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SerSingleton instance = <span class="keyword">new</span> SerSingleton();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SerSingleton</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SerSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123; <span class="comment">// 阻止生成新的实例，总是返回当前对象。</span></span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>再次测试：<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-3/79542677.jpg" alt=""><br>可以看到，经过反序列化后得到的仍然是同一个实例对象。<br>事实上，在实现了私有的readResolve()方法后，readObject已经形同虚设，它直接使用了readResolve()替换了原本的返回值，从而在形式上构造了单例。</p><p>实际使用建议使用静态内部类或枚举的方式，既能保证延迟初始化，又是线程安全的。</p><p>参考：《Java程序性能优化-让你的Java程序更快、更稳定》(葛一宁等编著)》</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>汽车后视镜调节</title>
      <link href="/2017/09/03/car-juge/"/>
      <url>/2017/09/03/car-juge/</url>
      
        <content type="html"><![CDATA[<center>汽车后视镜调整</center><h2 id="内后视镜"><a href="#内后视镜" class="headerlink" title="内后视镜"></a>内后视镜</h2><p>保证内后视镜看到后挡风玻璃的四角； </p><h2 id="外后视镜"><a href="#外后视镜" class="headerlink" title="外后视镜"></a>外后视镜</h2><p>倾角<br>    让车身占后视镜内1/4.左右都一样   </p><p>仰角<br>    左后视镜天地（路面和天空）各占1/2，右后视镜天占1/3，地占2/3。<br><a id="more"></a>    </p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 汽车 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决国产浏览器github提示不支持的问题</title>
      <link href="/2017/09/01/resolve-github-not-support-browser/"/>
      <url>/2017/09/01/resolve-github-not-support-browser/</url>
      
        <content type="html"><![CDATA[<p>像QQ、搜狗等国产浏览器访问Github时，会提示“现在不支持你的浏览器，请使用Chrome或Firefox”。</p><p>那么如何解决这个问题呢？</p><p>答案就是改浏览器的UserAgent为Chrome或Firefox的。</p><p>这里以搜狗浏览器为例。<br>这里用到一款插件“User-Agent Switcher”，是一个Chrome扩展。下载完毕后，直接双击User-Agent Switcher.crx文件，搜狗浏览器会提示你进行安装。<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-1/70991062.jpg" alt=""><br><a id="more"></a><br>可以看到自带有很多个UA（针对不同的系统和浏览器）<br><img src="http://omh46px9n.bkt.clouddn.com/17-9-1/45388284.jpg" alt=""><br>选择“选项”，可以添加自定义的UserAgent。如果发现选择了一个UA后还是不行，可以自定义。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>3大对象复制框架性能对比</title>
      <link href="/2017/08/31/three-object-copy-lib-compare/"/>
      <url>/2017/08/31/three-object-copy-lib-compare/</url>
      
        <content type="html"><![CDATA[<p>Apache common-utils的BeanUtils，Spring的BeanUtils，以及cglib的BeanCopier复制对象属性的性能对比。<br><a id="more"></a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cglib.beans.BeanCopier;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line">**</span><br><span class="line">* 测试apache BeanUtils和cglib的BeanCopier的性能对比。</span><br><span class="line">* <span class="meta">@author</span> j.tommy</span><br><span class="line">* <span class="meta">@date</span> <span class="number">2016</span>-<span class="number">09</span>-<span class="number">13</span> <span class="number">15</span>:<span class="number">20</span>.</span><br><span class="line">*/</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanCopyTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Teacher t = <span class="keyword">new</span> Teacher(<span class="number">1</span>,<span class="string">"admin"</span>);</span><br><span class="line">        Teacher t2 = <span class="keyword">new</span> Teacher();</span><br><span class="line">        testSpringBeanUtils(t);</span><br><span class="line">        testCommonUtils(t);</span><br><span class="line">        testCgLib(t);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testSpringBeanUtils</span><span class="params">(Teacher teacher)</span> </span>&#123;</span><br><span class="line">        Teacher t = <span class="keyword">new</span> Teacher();</span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>*<span class="number">10000</span>;i++) &#123;</span><br><span class="line">            org.springframework.beans.BeanUtils.copyProperties(t, teacher);</span><br><span class="line">        &#125;</span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Spring time spend:"</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testCommonUtils</span><span class="params">(Teacher teacher)</span> </span>&#123;</span><br><span class="line">        Teacher t = <span class="keyword">new</span> Teacher();</span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>*<span class="number">10000</span>;i++) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                BeanUtils.copyProperties(t,teacher);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"Common-utils time spend:"</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">testCgLib</span><span class="params">(Teacher teacher)</span> </span>&#123;</span><br><span class="line">        Teacher copy = <span class="keyword">new</span> Teacher();</span><br><span class="line">        BeanCopier bc = BeanCopier.create(Teacher.class,Teacher.class,<span class="keyword">false</span>);</span><br><span class="line">        Long start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">100</span>*<span class="number">10000</span>;i++) &#123;</span><br><span class="line">            bc.copy(teacher,copy,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Long end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">"CGlib time spend:"</span> +  (end-start));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Teacher</span><span class="params">(<span class="keyword">int</span> id, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/811255.jpg" alt=""></p><p>可以看出，common-utils的BeanUtils复制对象属性是最差的，最好的是CGLIB，统计结果都是复制100万次属性。<br>所以，在大量复制对象属性的场合，最好使用cglib的BeanCopier来做。</p><p>使用BeanCopier需要注意的事项：<br>1）目标类的getter方法不能比setter方法多；<br>这个是cglib的一个bug,它是读取所有的getter方法，然后调用相关的setter方法去注入属性，所以会触发空指针异常。<br>这个是在使用BeanCopier的create方法时发生的。<br>bug可以参考：<a href="https://sourceforge.net/p/cglib/bugs/32/">https://sourceforge.net/p/cglib/bugs/32/</a></p><p>2）使用时最好缓存BeanCopier，而不是每次使用的时候创建一个。具体类说就是使用一个静态的变量，而不是一个类成员变量。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jprofiler_监控远程linux服务器的tomcat进程</title>
      <link href="/2017/08/31/jprofiler-linux-tomcat-monitor/"/>
      <url>/2017/08/31/jprofiler-linux-tomcat-monitor/</url>
      
        <content type="html"><![CDATA[<h3 id="jprofiler-监控远程linux服务器的tomcat进程-实践"><a href="#jprofiler-监控远程linux服务器的tomcat进程-实践" class="headerlink" title="jprofiler_监控远程linux服务器的tomcat进程(实践)"></a>jprofiler_监控远程linux服务器的tomcat进程(实践)</h3><p>参考<a href="http://www.cnblogs.com/gossip/p/6090979.html">jprofiler_监控远程linux服务器的tomcat进程(实践)</a></p><p>需要注意的是：<br>1.Session–&gt;Integration Wizards–&gt;New Server Intergration，不是New Remote Integration.如下图<br><img src="http://i1.piimg.com/567571/46fa018329ba6a06.png" alt=""></p><p>2.执行./bin/startup_jprofile.sh后，不能ctrl+C，否则就将进程干掉了。<br><a id="more"></a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用AjaxAnywhere实现页面局部刷新</title>
      <link href="/2017/08/31/ajaxanywhere-usage/"/>
      <url>/2017/08/31/ajaxanywhere-usage/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>页面局部刷新是日常工作中使用的很多的功能，通常会借助jQuery的load/get/post/ajax方法，或者使用jquery.form.js的ajaxSubmit来提交表单。<br>使用传统的jQuery的load/get/post/Ajax方式组装表单，以及返回的响应内容太过麻烦，除了使用jquery.form.js，我们还可以使用AjaxAnywhere来实现页面局部的刷新。</p></blockquote><h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><p>1.添加maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.ajaxanywhere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ajaxanywhere<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2-rc2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2.在web.xml中配置aa过滤器：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--界面局部刷新--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AjaxAnywhere<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.ajaxanywhere.AAFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>AjaxAnywhere<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><p>3.测试页面：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: Administrator</span><br><span class="line">  Date: <span class="number">2017</span>/<span class="number">6</span>/<span class="number">1</span></span><br><span class="line">  Time: <span class="number">19</span>:<span class="number">10</span></span><br><span class="line">  To change <span class="keyword">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%<span class="meta">@include</span> file=<span class="string">"/WEB-INF/views/head.jsp"</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> language=<span class="string">"java"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;AjaxAnywhere使用&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form name=<span class="string">"myForm"</span> action=<span class="string">"$&#123;ctx&#125;/aa/test"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;table&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;label for="username"&gt;&lt;/label&gt;</span><br><span class="line">                &lt;input type=<span class="string">"text"</span> name=<span class="string">"username"</span> id=<span class="string">"username"</span>/&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">            &lt;td&gt;</span><br><span class="line">                &lt;button type="button" onclick="searchForm();"&gt;查询&lt;/button&gt;</span><br><span class="line">            &lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;aa:zone name=<span class="string">"refreshDataZone"</span>&gt;</span><br><span class="line">    &lt;table border=<span class="string">"1"</span> style=<span class="string">"border-collapse:collapse;"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;编号&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;姓名&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;年龄&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;性别&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;电话&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;住址&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">        &lt;c:forEach <span class="keyword">var</span>=<span class="string">"item"</span> varStatus=<span class="string">"j"</span> items=<span class="string">"$&#123;dataList&#125;"</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;$&#123;j.index+1&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;item.name&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;item.age&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;item.sex==1?"男":"女"&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;item.phone&#125;&lt;/td&gt;</span><br><span class="line">                &lt;td&gt;$&#123;item.address&#125;&lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &lt;/c:forEach&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/aa:zone&gt;</span><br><span class="line">&lt;script src="$&#123;ctx&#125;/js/jquery.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script src="$&#123;ctx&#125;/js/aa.js"&gt;&lt;/script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="function">function <span class="title">searchForm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> aa = <span class="keyword">new</span> AjaxAnywhere();</span><br><span class="line">        aa.formName = <span class="string">"myForm"</span>;</span><br><span class="line">        aa.getZonesToReload = function() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"refreshDataZone"</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        aa.submitAJAX();</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>head.jsp：<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> prefix=<span class="string">"c"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/fmt"</span> prefix=<span class="string">"fmt"</span>%&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> uri=<span class="string">"http://java.sun.com/jsp/jstl/functions"</span> prefix=<span class="string">"fn"</span> %&gt;</span><br><span class="line">&lt;%<span class="meta">@taglib</span> uri=<span class="string">"http://ajaxanywhere.sourceforge.net/"</span> prefix=<span class="string">"aa"</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    String path = request.getContextPath();</span><br><span class="line">    String basePath = request.getScheme() + <span class="string">"://"</span> + request.getServerName() + <span class="string">":"</span> + request.getServerPort() + path + <span class="string">"/"</span>;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;c:set <span class="keyword">var</span>=<span class="string">"ctx"</span> value=<span class="string">"&lt;%=path%&gt;"</span> /&gt;</span><br></pre></td></tr></table></figure></p><p>页面步骤：<br>1、  添加aa的标签引用；<br>2、  添加aa.js(ajaxAnywhere的js)<br>3、  在页面中使用<a href="aa:zone">aa:zone</a>指定需要刷新的区域。如上例<br>4、  点击查询的方法处理添加aa的处理。<br>formName:指定表单的名称；<br>重写aa.getZonesToReload方法，返回刷新区域的名称，<a href="aa:zone">aa:zone</a>中指定的名称。<br>最后一步调用aa.submitAJAX()；<br>aa会自动组装form表单的内容提交。  </p><p>后台代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/aa"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AjaxAnywhereController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">aaTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 准备测试数据</span></span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">15</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">15</span>;i++) &#123;</span><br><span class="line">            User user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setUserId(<span class="keyword">new</span> Long(i+<span class="number">1</span>));</span><br><span class="line">            user.setName(<span class="string">"测试用户"</span> + (i + <span class="number">1</span>));</span><br><span class="line">            user.setAge((<span class="keyword">short</span>) (Math.random() * <span class="number">100</span>));</span><br><span class="line">            user.setSex((<span class="keyword">short</span>) (Math.random() &lt; <span class="number">0.5</span> ? <span class="number">0</span> : <span class="number">1</span>));</span><br><span class="line">            user.setPhone(<span class="string">"138-8888-8888"</span>);</span><br><span class="line">            user.setAddress(<span class="string">"广东省深圳市福田区商业大厦A栋16楼"</span>);</span><br><span class="line">            users.add(user);</span><br><span class="line">        &#125;</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">"/aa/aaTest"</span>);</span><br><span class="line">        mv.addObject(<span class="string">"dataList"</span>,users);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>使用AjaxAnyWhere应该是实现页面局部刷新最简答的一种方式了。<br>传统的是直接方法一个页面，如果是Ajax请求后台需要做特殊处理，比如spring需要使用@ResponseBody来指定，前台也相应的需要修改。使用了AjaxAnyWhere后后台没有任何改动，页面仅仅需要添加几行代码就搞定了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>windows上使用Nginx+tomcat做负载均衡</title>
      <link href="/2017/08/31/windows-use-Nginx-tomcat-load-balance/"/>
      <url>/2017/08/31/windows-use-Nginx-tomcat-load-balance/</url>
      
        <content type="html"><![CDATA[<p>Nginx作为反向代理服务器，可以对Web服务器提供加速，并且具有负载均衡的功能。<br>参考：<a href="http://blog.csdn.net/cclovett/article/details/26377269">http://blog.csdn.net/cclovett/article/details/26377269</a></p><p>本例使用Nginx在2个Tomcat做负载均衡，并做了资源分离。即静态资源（js,css,图片）给nginx，JSP等请求分发给tomcat处理。<br>1）Nginx的安装和启动<br>这里使用的Nginx版本是1.8.0，从<a href="http://nginx.org/en/download.html下载Windows版本。">http://nginx.org/en/download.html下载Windows版本。</a><br>下载的文件很小，只有1.22M，下载完毕将文件解压到nginx-1.8.0。我这里的目录是d:/soft/nginx-1.8.0。</p><p>可以直接双击nginx.exe来启动，或进入nginx目录，执行start nginx启动。<br>使用nginx -s stop来关闭nginx。<br>启动nginx后，访问<a href="http://localhost，出现下面的页面即表示成功。">http://localhost，出现下面的页面即表示成功。</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/16495106.jpg" alt=""><br><a id="more"></a><br>2）Nginx负载均衡配置<br>主要是修改nginx.conf文件。<br>找到#gzip  on;一行，在下面增加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream local_tomcat &#123;</span><br><span class="line">    server 127.0.0.1:8081 weight=1;</span><br><span class="line">    server 127.0.0.1:8082 weight=1;</span><br><span class="line">    #ip_hash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>我们这里本地测试，tomcat端口分别为8081和8082.weight表示权重，默认为1.表示请求分发的比例。这里为1:1表示2个tomcat均衡的处理请求。<br>server部分配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  127.0.0.1;</span><br><span class="line"></span><br><span class="line">    #charset koi8-r;</span><br><span class="line"></span><br><span class="line">    #access_log  logs/host.access.log  main;</span><br><span class="line"></span><br><span class="line">    #error_page  404              /404.html;</span><br><span class="line"></span><br><span class="line">    # redirect server error pages to the static page /50x.html</span><br><span class="line">    #</span><br><span class="line">    error_page   500 502 503 504  /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root   html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #禁止访问WEB-INF目录下的文件</span><br><span class="line">    location ~ ^/(WEB-INF)/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #静态资源文件到下面的文件夹去取</span><br><span class="line">    location ~ \.(html|js|css|png|gif)$ &#123;  </span><br><span class="line">        root D:/soft/test/static; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    #其他的请求，如果jsp，或后台action请求交由tomcat处理</span><br><span class="line">    location / &#123;  </span><br><span class="line">       proxy_pass http://local_tomcat;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>listen:表示nginx监听的端口，默认是80.<br>比例我上面配置了2个tomcat，端口分别为8081和8082.单独访问某个tomcat的系统（比例8081）：<br><a href="http://127.0.0.1:8081/系统名。">http://127.0.0.1:8081/系统名。</a><br>上面配置了nginx监听80端口，接收到请求后，静态资源从d:/soft/test/static目录查，动态资源请求分发给2个tomcat处理。<br>这样访问<a href="http://127.0.0.1/系统名时就可以了。">http://127.0.0.1/系统名时就可以了。</a></p><p>server_name：表示监听到之后需要转到哪里去，这时我们直接转到本地，这时是直接到nginx文件夹内。<br>location：表示匹配的路径，这时配置了/表示所有请求都被匹配到这里<br>root：里面配置了root这时表示当匹配这个请求的路径时，将会在这个文件夹内寻找相应的文件，这里对我们之后的静态文件伺服很有用。<br>index：当没有指定主页时，默认会选择这个指定的文件，它可以有多个，并按顺序来加载，如果第一个不存在，则找第二个，依此类推。<br>下面的error_page是代表错误的页面，这里我们暂时不用，先不管它。</p><p>配置完成后，在命令行执行nginx -t来查看配置时候正确。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/52696956.jpg" alt=""></p><p>如果已经启动了nginx，没必要关闭后再打开。可以执行nginx -s reload来重新加载配置。</p><p>3）tomcat配置修改<br>上面已经说明了2个tomcat的端口是8081和8082.因此需要分别修改2个tomcat的server.xml，更改端口。<br>改这2个地方：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/25968642.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/94019341.jpg" alt=""></p><p>然后 将相同的打包文件分别复制到2个tomcat的webapp下。我的打包文件如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/46874820.jpg" alt=""></p><p>index.jsp中加了标识，方便区分是哪个tomcat的请求。<br>resources目录下是使用的资源文件。</p><p>4）静态资源文件处理<br>因为上面2）中配置了静态资源到d:/soft/test/static目录查，因此将打包文件中的resources文件夹复制到d:/soft/test/static目录下。</p><p>完毕之后启动2个tomcat，然后启动nginx。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/20131652.jpg" alt=""><br>刷新一下页面：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/81159058.jpg" alt=""></p><p>由此，可以看到负载均衡已经实现了。</p><p>下面测试一下静态资源文件的分离：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/75096011.jpg" alt=""><br>也是Ok的。<br>这里特别说一下，<br>比如<a href="http://127.0.0.1/helloweb/resources/js/jquery-loadmask-0.4/jquery.loadmask.css这个静态资源文件。">http://127.0.0.1/helloweb/resources/js/jquery-loadmask-0.4/jquery.loadmask.css这个静态资源文件。</a><br>在JSP中是helloweb/resources/js/jquery-loadmask-0.4/jquery.loadmask.css，那么nginx配置的静态资源文件查找的目录必须也要匹配上面的路径。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/71568263.jpg" alt=""></p>]]></content>
      
      
      
        <tags>
            
            <tag> tomcat </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>多个tomcat session共享</title>
      <link href="/2017/08/31/multi-tomcat-session-share/"/>
      <url>/2017/08/31/multi-tomcat-session-share/</url>
      
        <content type="html"><![CDATA[<p>这里使用的是tomcat的广播机制实现的。<br>这里使用Nginx+2台tomcat做测试，2台tomcat端口分别为8080和8081。</p><h2 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h2><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/76550356.jpg" alt=""><br><a id="more"></a></p><h2 id="tomcat修改"><a href="#tomcat修改" class="headerlink" title="tomcat修改"></a>tomcat修改</h2><p>tomcat1：<br>修改server.xml，找到&lt;Engine标签，增加属性jvmRoute=”tomcat1”，将&lt;Cluster放开。<br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/12610179.jpg" alt=""></p><p>tomcat2：<br>同样，只是将jvmRoute=”tomcat1”改成tomcat2。这个是方便标识session是哪台tomcat的。</p><p>另外，还需要修改应用的web.xml，增加<distributable></distributable>。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/53883647.jpg" alt=""></p><p>然后启动2个tomcat就可以了。<br>访问tomcat1：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/94337556.jpg" alt=""></p><p>访问tomcat2：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/2329351.jpg" alt=""><br>可以看到访问2个tomcat，session都是一样的。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tomcat </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在外部tomcat中运行spring boot应用</title>
      <link href="/2017/08/31/%E5%9C%A8%E5%A4%96%E9%83%A8tomcat%E4%B8%AD%E8%BF%90%E8%A1%8Cspring%20boot%E5%BA%94%E7%94%A8/"/>
      <url>/2017/08/31/%E5%9C%A8%E5%A4%96%E9%83%A8tomcat%E4%B8%AD%E8%BF%90%E8%A1%8Cspring%20boot%E5%BA%94%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p>默认，Springboot使用内嵌的tomcat来运行springboot应用。如果你想使用外部tomcat来运行，需要做一些修改。</p><h4 id="在pom-xml中将应用修改为war"><a href="#在pom-xml中将应用修改为war" class="headerlink" title="在pom.xml中将应用修改为war"></a>在pom.xml中将应用修改为war</h4><p>这个应该没什么疑问，默认springboot是当做一个jar来运行的。</p><h4 id="应用启动类修改"><a href="#应用启动类修改" class="headerlink" title="应用启动类修改"></a>应用启动类修改</h4><p>需要继承SpringBootServletInitializer，并重写configure方法。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.ybf.activity.web.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(Application.class);</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">statViewServlet</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        ServletRegistrationBean reg = <span class="keyword">new</span> ServletRegistrationBean();</span><br><span class="line">        reg.setServlet (<span class="keyword">new</span> StatViewServlet());</span><br><span class="line">        reg.addUrlMappings (<span class="string">"/druid/*"</span>);</span><br><span class="line">        <span class="keyword">return</span> reg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class,args);</span><br><span class="line">        logger.info(<span class="string">"Application [activity-web] started!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="添加spring-boot-starter-tomcat依赖。"><a href="#添加spring-boot-starter-tomcat依赖。" class="headerlink" title="添加spring-boot-starter-tomcat依赖。"></a>添加spring-boot-starter-tomcat依赖。</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="在项目的根目录执行mvn-clean-package-DskipTests-true"><a href="#在项目的根目录执行mvn-clean-package-DskipTests-true" class="headerlink" title="在项目的根目录执行mvn clean package -DskipTests=true"></a>在项目的根目录执行mvn clean package -DskipTests=true</h4><p>这样会自动处理模块间的依赖关系，并且会将该项目的每个模板都进行打包。</p><p>打包完毕后，将WAR丢到tomcat就可以跑了。  </p><h4 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h4><p>1.系统环境变量的JDK版本要和你的项目保持一致。  </p><blockquote><p>我就是因为不一致找了很久的原因。我的项目是JDK1.8，系统环境变量是JDK1.7，丢到tomcat日志只有logback初始化的打印，再没有其他信息，后面就提示已经启动。但访问controller之类的都是404.</p></blockquote><p>2.我的工程使用了mybatis，要打印SQL。在mybatis-config.xml中配置的logImpl位log4j。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>但我的依赖中没有引入log4j，导致报错。<br><code>Caused by: java.lang.NoClassDefFoundError: org/apache/log4j/Priority</code>.我的日志输出组件是logback，mybatis是不支持的，所以配置的STDOUT_LOGGING就OK了。但用idea集成的tomcat跑没问题。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在外部tomcat中运行spring boot应用</title>
      <link href="/2017/08/31/outter-tomcat-springboot/"/>
      <url>/2017/08/31/outter-tomcat-springboot/</url>
      
        <content type="html"><![CDATA[<p>默认，Springboot使用内嵌的tomcat来运行springboot应用。如果你想使用外部tomcat来运行，需要做一些修改。</p><h4 id="在pom-xml中将应用修改为war"><a href="#在pom-xml中将应用修改为war" class="headerlink" title="在pom.xml中将应用修改为war"></a>在pom.xml中将应用修改为war</h4><p>这个应该没什么疑问，默认springboot是当做一个jar来运行的。</p><h4 id="应用启动类修改"><a href="#应用启动类修改" class="headerlink" title="应用启动类修改"></a>应用启动类修改</h4><p>需要继承SpringBootServletInitializer，并重写configure方法。<br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.ybf.activity.web.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(Application.class);</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">statViewServlet</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        ServletRegistrationBean reg = <span class="keyword">new</span> ServletRegistrationBean();</span><br><span class="line">        reg.setServlet (<span class="keyword">new</span> StatViewServlet());</span><br><span class="line">        reg.addUrlMappings (<span class="string">"/druid/*"</span>);</span><br><span class="line">        <span class="keyword">return</span> reg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            SpringApplicationBuilder application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> application.sources(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class,args);</span><br><span class="line">        logger.info(<span class="string">"Application [activity-web] started!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="添加spring-boot-starter-tomcat依赖。"><a href="#添加spring-boot-starter-tomcat依赖。" class="headerlink" title="添加spring-boot-starter-tomcat依赖。"></a>添加spring-boot-starter-tomcat依赖。</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="在项目的根目录执行mvn-clean-package-DskipTests-true"><a href="#在项目的根目录执行mvn-clean-package-DskipTests-true" class="headerlink" title="在项目的根目录执行mvn clean package -DskipTests=true"></a>在项目的根目录执行mvn clean package -DskipTests=true</h4><p>这样会自动处理模块间的依赖关系，并且会将该项目的每个模板都进行打包。</p><p>打包完毕后，将WAR丢到tomcat就可以跑了。  </p><h4 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h4><p>1.系统环境变量的JDK版本要和你的项目保持一致。  </p><blockquote><p>我就是因为不一致找了很久的原因。我的项目是JDK1.8，系统环境变量是JDK1.7，丢到tomcat日志只有logback初始化的打印，再没有其他信息，后面就提示已经启动。但访问controller之类的都是404.</p></blockquote><p>2.我的工程使用了mybatis，要打印SQL。在mybatis-config.xml中配置的logImpl位log4j。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p><p>但我的依赖中没有引入log4j，导致报错。<br><code>Caused by: java.lang.NoClassDefFoundError: org/apache/log4j/Priority</code>.我的日志输出组件是logback，mybatis是不支持的，所以配置的STDOUT_LOGGING就OK了。但用idea集成的tomcat跑没问题。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> tomcat </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot日志配置+mybatis输出SQL</title>
      <link href="/2017/08/31/springboot-log-config-mybatis-print-SQL/"/>
      <url>/2017/08/31/springboot-log-config-mybatis-print-SQL/</url>
      
        <content type="html"><![CDATA[<p>这里以logback为例。</p><p>其实只需要在logback.xml中增加下面一行配置就而已了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"mapper所在的包名"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>下面贴一个完整的logback的配置：<br><a id="more"></a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- %m输出的信息,%p日志级别,%t线程名,%d日期,%c类的全名,,,, --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d %p (%file:%line\)- %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"baselog"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span>&gt;</span>log/base.log<span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>log/base.log.%d.%i<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- or whenever the file size reaches 64 MB --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>64 MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %d %p (%file:%line\)- %m%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.ybf"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"baselog"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.ybf.activity.web.mapper"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注：测试的spring boot版本为1.5.4.RELEASE.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot日志配置+mybatis输出SQL</title>
      <link href="/2017/08/31/spring%20boot%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE+mybatis%E8%BE%93%E5%87%BASQL/"/>
      <url>/2017/08/31/spring%20boot%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE+mybatis%E8%BE%93%E5%87%BASQL/</url>
      
        <content type="html"><![CDATA[<p>这里以logback为例。</p><p>其实只需要在logback.xml中增加下面一行配置就而已了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"mapper所在的包名"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span><span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>下面贴一个完整的logback的配置：<br><a id="more"></a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- %m输出的信息,%p日志级别,%t线程名,%d日期,%c类的全名,,,, --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d %p (%file:%line\)- %m%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>GBK<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"baselog"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span>&gt;</span>log/base.log<span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>log/base.log.%d.%i<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">timeBasedFileNamingAndTriggeringPolicy</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP"</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- or whenever the file size reaches 64 MB --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maxFileSize</span>&gt;</span>64 MB<span class="tag">&lt;/<span class="name">maxFileSize</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">timeBasedFileNamingAndTriggeringPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %d %p (%file:%line\)- %m%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">charset</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 此处设置字符集 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.ybf"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"baselog"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">"com.ybf.activity.web.mapper"</span> <span class="attr">level</span>=<span class="string">"DEBUG"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注：测试的spring boot版本为1.5.4.RELEASE.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分布式系统session共享方案</title>
      <link href="/2017/08/31/distribute-session-share/"/>
      <url>/2017/08/31/distribute-session-share/</url>
      
        <content type="html"><![CDATA[<p>分布式系统中，sessiong共享有很多的解决方案，其中托管到缓存中应该是最常用的方案之一，</p><p>Spring Session官方说明</p><blockquote><p>Spring Session provides an API and implementations for managing a user’s session information.</p></blockquote><h3 id="如何使用"><a href="#如何使用" class="headerlink" title="如何使用"></a>如何使用</h3><p>1、引入依赖<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2、Session配置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRedisHttpSession</span>(maxInactiveIntervalInSeconds = <span class="number">86400</span>*<span class="number">30</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SessionConfig</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>maxInactiveIntervalInSeconds: 设置Session失效时间，使用Redis Session之后，原SringBoot的server.session.timeout属性不再生效</p><p>好了，这样就配置好了，我们来测试一下<br><a id="more"></a><br>3、测试<br>添加测试方法获取sessionid<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/uid"</span>)</span><br><span class="line"><span class="function">String <span class="title">uid</span><span class="params">(HttpSession session)</span> </span>&#123;</span><br><span class="line">    UUID uid = (UUID) session.getAttribute(<span class="string">"uid"</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid == <span class="keyword">null</span>) &#123;</span><br><span class="line">        uid = UUID.randomUUID();</span><br><span class="line">    &#125;</span><br><span class="line">    session.setAttribute(<span class="string">"uid"</span>, uid);</span><br><span class="line">    <span class="keyword">return</span> session.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>登录redis 输入 keys ‘<em>sessions</em>‘<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">t&lt;spring:session:sessions:db031986-8ecc-48d6-b471-b137a3ed6bc4</span><br><span class="line">t(spring:session:expirations:1472976480000</span><br></pre></td></tr></table></figure></p><p>其中 1472976480000为失效时间，意思是这个时间后session失效，<code>db031986-8ecc-48d6-b471-b137a3ed6bc4</code> 为sessionId,登录<a href="http://localhost:8080/uid">http://localhost:8080/uid</a> 发现会一致，就说明session 已经在redis里面进行有效的管理了。</p><h3 id="如何在两台或者多台中共享session"><a href="#如何在两台或者多台中共享session" class="headerlink" title="如何在两台或者多台中共享session"></a>如何在两台或者多台中共享session</h3><p>其实就是按照上面的步骤在另一个项目中再次配置一次，启动后自动就进行了session共享。</p><p>参考：<a href="http://www.ityouknow.com/springboot/2016/03/06/springboot(%E4%B8%89)-Spring-Boot%E4%B8%ADRedis%E7%9A%84%E4%BD%BF%E7%94%A8.html">http://www.ityouknow.com/springboot/2016/03/06/springboot(%E4%B8%89)-Spring-Boot%E4%B8%ADRedis%E7%9A%84%E4%BD%BF%E7%94%A8.html</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成Redis</title>
      <link href="/2017/08/31/springboot%E9%9B%86%E6%88%90Redis/"/>
      <url>/2017/08/31/springboot%E9%9B%86%E6%88%90Redis/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Redis是目前使用的非常广泛的内存数据库，相比memcached，它支持更加丰富的数据类型。本来简要介绍在springboot中使用redis的方法。</p><h2 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a>如何使用？</h2><p>1、引入spring-boot-starter-redis<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2、在application.properties增加Redis的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用的数据库（0-15），默认为0</span><br><span class="line">spring.redis.database=0  </span><br><span class="line"># Redis服务器地址</span><br><span class="line">spring.redis.host=127.0.0.1</span><br><span class="line"># Redis服务器连接端口</span><br><span class="line">spring.redis.port=6379  </span><br><span class="line"># Redis服务器连接密码（默认为空）</span><br><span class="line">spring.redis.password=</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>3、使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/redis/&#123;key&#125;/&#123;value&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">redisTest</span><span class="params">(@PathVariable String key,@PathVariable String value)</span> </span>&#123;</span><br><span class="line">    String redisValue = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(redisValue)) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!redisValue.equals(value)) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"redis中已存在[key=%s,value=%s]的数据！"</span>,key,value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>随便写的一个例子。</p><p>4、Sentinel模式配置<br>上面的是单机的一个配置，如果是主从，参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#redis配置</span><br><span class="line">spring.redis.database=0</span><br><span class="line">spring.redis.password=system</span><br><span class="line">spring.redis.pool.max-idle=10</span><br><span class="line">spring.redis.pool.min-idle=0</span><br><span class="line">spring.redis.pool.max-active=10</span><br><span class="line">spring.redis.pool.max-wait=-1</span><br><span class="line">spring.redis.sentinel.master=mymaster</span><br><span class="line">spring.redis.sentinel.nodes=192.168.74.135:26379,192.168.74.136:26379</span><br></pre></td></tr></table></figure></p><p>5、redis的全部配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># REDIS (RedisProperties)</span><br><span class="line">spring.redis.cluster.max-redirects= # Maximum number of redirects to follow when executing commands across the cluster.</span><br><span class="line">spring.redis.cluster.nodes= # Comma-separated list of &quot;host:port&quot; pairs to bootstrap from.</span><br><span class="line">spring.redis.database=0 # Database index used by the connection factory.</span><br><span class="line">spring.redis.url= # Connection URL, will override host, port and password (user will be ignored), e.g. redis://user:password@example.com:6379</span><br><span class="line">spring.redis.host=localhost # Redis server host.</span><br><span class="line">spring.redis.password= # Login password of the redis server.</span><br><span class="line">spring.redis.ssl=false # Enable SSL support.</span><br><span class="line">spring.redis.pool.max-active=8 # Max number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.</span><br><span class="line">spring.redis.pool.max-idle=8 # Max number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.</span><br><span class="line">spring.redis.pool.max-wait=-1 # Maximum amount of time (in milliseconds) a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.</span><br><span class="line">spring.redis.pool.min-idle=0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.</span><br><span class="line">spring.redis.port=6379 # Redis server port.</span><br><span class="line">spring.redis.sentinel.master= # Name of Redis server.</span><br><span class="line">spring.redis.sentinel.nodes= # Comma-separated list of host:port pairs.</span><br><span class="line">spring.redis.timeout=0 # Connection timeout in milliseconds.</span><br></pre></td></tr></table></figure></p><p>6、使用redis自动缓存数据<br>可以把一些经常查询的数据放到redis缓存起来，不用每次都查询数据库。<br>a.增加一个redis的配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">redisKeyGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                sb.append(target.getClass().getName());</span><br><span class="line">                sb.append(method.getName());</span><br><span class="line">                <span class="keyword">for</span> (Object obj : params) &#123;</span><br><span class="line">                    sb.append(obj.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @SuppressWarnings(<span class="string">"rawtypes"</span>)</span> RedisTemplate redisTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">redisTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate(factory);</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>b.在需要缓存的service方法上加上注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value = <span class="string">"userCache"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> TUser <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userRepository.findOne(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样，就只有redis没有相应的Key的时候才会查询数据库。</p><p>我们看下redis：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-4/57679669.jpg" alt=""></p><p>图中，redis的key就是你的参数。<br>所以实际使用最好指定Cacheable的key，保证唯一。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot集成Redis</title>
      <link href="/2017/08/31/springboot-Redis/"/>
      <url>/2017/08/31/springboot-Redis/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Redis是目前使用的非常广泛的内存数据库，相比memcached，它支持更加丰富的数据类型。本来简要介绍在springboot中使用redis的方法。</p><h2 id="如何使用？"><a href="#如何使用？" class="headerlink" title="如何使用？"></a>如何使用？</h2><p>1、引入spring-boot-starter-redis<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>2、在application.properties增加Redis的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用的数据库（0-15），默认为0</span><br><span class="line">spring.redis.database=0  </span><br><span class="line"># Redis服务器地址</span><br><span class="line">spring.redis.host=127.0.0.1</span><br><span class="line"># Redis服务器连接端口</span><br><span class="line">spring.redis.port=6379  </span><br><span class="line"># Redis服务器连接密码（默认为空）</span><br><span class="line">spring.redis.password=</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>3、使用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> StringRedisTemplate stringRedisTemplate;</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/redis/&#123;key&#125;/&#123;value&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">redisTest</span><span class="params">(@PathVariable String key,@PathVariable String value)</span> </span>&#123;</span><br><span class="line">    String redisValue = stringRedisTemplate.opsForValue().get(key);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(redisValue)) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!redisValue.equals(value)) &#123;</span><br><span class="line">        stringRedisTemplate.opsForValue().set(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> String.format(<span class="string">"redis中已存在[key=%s,value=%s]的数据！"</span>,key,value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>随便写的一个例子。</p><p>4、Sentinel模式配置<br>上面的是单机的一个配置，如果是主从，参考：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#redis配置</span><br><span class="line">spring.redis.database=0</span><br><span class="line">spring.redis.password=system</span><br><span class="line">spring.redis.pool.max-idle=10</span><br><span class="line">spring.redis.pool.min-idle=0</span><br><span class="line">spring.redis.pool.max-active=10</span><br><span class="line">spring.redis.pool.max-wait=-1</span><br><span class="line">spring.redis.sentinel.master=mymaster</span><br><span class="line">spring.redis.sentinel.nodes=192.168.74.135:26379,192.168.74.136:26379</span><br></pre></td></tr></table></figure></p><p>5、redis的全部配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># REDIS (RedisProperties)</span><br><span class="line">spring.redis.cluster.max-redirects= # Maximum number of redirects to follow when executing commands across the cluster.</span><br><span class="line">spring.redis.cluster.nodes= # Comma-separated list of &quot;host:port&quot; pairs to bootstrap from.</span><br><span class="line">spring.redis.database=0 # Database index used by the connection factory.</span><br><span class="line">spring.redis.url= # Connection URL, will override host, port and password (user will be ignored), e.g. redis://user:password@example.com:6379</span><br><span class="line">spring.redis.host=localhost # Redis server host.</span><br><span class="line">spring.redis.password= # Login password of the redis server.</span><br><span class="line">spring.redis.ssl=false # Enable SSL support.</span><br><span class="line">spring.redis.pool.max-active=8 # Max number of connections that can be allocated by the pool at a given time. Use a negative value for no limit.</span><br><span class="line">spring.redis.pool.max-idle=8 # Max number of &quot;idle&quot; connections in the pool. Use a negative value to indicate an unlimited number of idle connections.</span><br><span class="line">spring.redis.pool.max-wait=-1 # Maximum amount of time (in milliseconds) a connection allocation should block before throwing an exception when the pool is exhausted. Use a negative value to block indefinitely.</span><br><span class="line">spring.redis.pool.min-idle=0 # Target for the minimum number of idle connections to maintain in the pool. This setting only has an effect if it is positive.</span><br><span class="line">spring.redis.port=6379 # Redis server port.</span><br><span class="line">spring.redis.sentinel.master= # Name of Redis server.</span><br><span class="line">spring.redis.sentinel.nodes= # Comma-separated list of host:port pairs.</span><br><span class="line">spring.redis.timeout=0 # Connection timeout in milliseconds.</span><br></pre></td></tr></table></figure></p><p>6、使用redis自动缓存数据<br>可以把一些经常查询的数据放到redis缓存起来，不用每次都查询数据库。<br>a.增加一个redis的配置类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">redisKeyGenerator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">                sb.append(target.getClass().getName());</span><br><span class="line">                sb.append(method.getName());</span><br><span class="line">                <span class="keyword">for</span> (Object obj : params) &#123;</span><br><span class="line">                    sb.append(obj.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @SuppressWarnings(<span class="string">"rawtypes"</span>)</span> RedisTemplate redisTemplate) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RedisCacheManager(redisTemplate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, String&gt; <span class="title">redisTemplate</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        StringRedisTemplate template = <span class="keyword">new</span> StringRedisTemplate(factory);</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>b.在需要缓存的service方法上加上注解：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value = <span class="string">"userCache"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> TUser <span class="title">findById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.userRepository.findOne(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这样，就只有redis没有相应的Key的时候才会查询数据库。</p><p>我们看下redis：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-4/57679669.jpg" alt=""></p><p>图中，redis的key就是你的参数。<br>所以实际使用最好指定Cacheable的key，保证唯一。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决使用maven生成项目很慢</title>
      <link href="/2017/08/31/resolve-maven-create-projects-too-low/"/>
      <url>/2017/08/31/resolve-maven-create-projects-too-low/</url>
      
        <content type="html"><![CDATA[<p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/88989230.jpg" alt=""><br>如上图标红部分，加上<code>archetypeCatalog=internal</code>，不加这个参数，在maven生成骨架的时候将会非常慢，有时候会直接卡住。</p><p>来自网上的解释：</p><blockquote><p>archetypeCatalog表示插件使用的archetype元数据，不加这个参数时默认为remote，local，即中央仓库archetype元数据，由于中央仓库的archetype太多了，所以导致很慢，指定internal来表示仅使用内部元数据。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Maven多环境配置打包和部署</title>
      <link href="/2017/08/31/maven-multi-env-package-deploy/"/>
      <url>/2017/08/31/maven-multi-env-package-deploy/</url>
      
        <content type="html"><![CDATA[<p>基本每个项目都会有开发环境（本地环境）、开发集成环境、测试环境、预发布环境、正式环境。<br>最少也有开发环境（本地环境）、测试环境、生产环境3个环境，每个环境的配置是不一样的，如果每次打包都手动修改配置文件，工作量大且容易出错。<br>所以这个时候就可以考虑使用maven的profiles来实现多环境配置的打包。<br><a id="more"></a><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 本地开发环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dev<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">profiles.active</span>&gt;</span>development<span class="tag">&lt;/<span class="name">profiles.active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 测试环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>test<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">profiles.active</span>&gt;</span>test<span class="tag">&lt;/<span class="name">profiles.active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>false<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 生产环境 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>prd<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">profiles.active</span>&gt;</span>production<span class="tag">&lt;/<span class="name">profiles.active</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>false<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>hhly-common-$&#123;project.version&#125;-$&#123;profiles.active&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span> <span class="comment">&lt;!--最终生成的文件名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 资源根目录排除各环境的配置，使用单独的资源目录来指定 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>test/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>production/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>development/*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/resources/$&#123;profiles.active&#125;<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 编译插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.7<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;outputDirectory&gt;/target/classes&lt;/outputDirectory&gt;</span></span><br><span class="line"><span class="comment">    &lt;testOutputDirectory&gt;/target/test-classes&lt;/testOutputDirectory&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>如上，默认开发环境的profile是active的，也就是你执行mvn:compile,mvn:install,mvn:package等都是使用的开发环境的配置文件。<br>如果要打其他环境，比如测试环境的包，可以这样mvn package -P test.<br>注意：每次打包前建议先执行clean，否则会使用之前打包的配置文件。mvn clean package -P test.</p><p>那如果要自动部署到tomcat，可以增加一个plugin.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat7-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">charset</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">charset</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>$&#123;deploy.url&#125;<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">server</span>&gt;</span>tomcat<span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">path</span>&gt;</span>$&#123;webname&#125;<span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">password</span>&gt;</span>tomcat<span class="tag">&lt;/<span class="name">password</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">update</span>&gt;</span>true<span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>profile这样配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 本地开发环境 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">id</span>&gt;</span>development<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles.active</span>&gt;</span>development<span class="tag">&lt;/<span class="name">profiles.active</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">deploy.url</span>&gt;</span>http://localhost:8080/manager/text<span class="tag">&lt;/<span class="name">deploy.url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">webname</span>&gt;</span>/basketball_manage<span class="tag">&lt;/<span class="name">webname</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>&lt;deploy.url&gt;中后面的/manager/text不能变，端口就看你打开了哪个tomcat。<br>执行mvn tomcat7:deploy 或者mvn tomcat7:redeploy部署到tomcat。<br>注意：执行部署命令前要将tomcat打开，这样就会将工程自动部署到tomcat。如上其他环境也一样，比如测试环境的tomcat，你在开发环境也是可以自动部署过去的。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用maven构建多模块工程</title>
      <link href="/2017/08/31/maven-multi-modules-project/"/>
      <url>/2017/08/31/maven-multi-modules-project/</url>
      
        <content type="html"><![CDATA[<h2 id="一、使用maven构建多模块工程"><a href="#一、使用maven构建多模块工程" class="headerlink" title="一、使用maven构建多模块工程"></a>一、使用maven构建多模块工程</h2><p>1、随便创建一个maven工程（quickstart/webapp）都可以，创建完毕后将pom.xml中type改为pom。如图：</p><packaging>pom</packaging><p>2、新建子模块，父模块为刚刚创建的maven工程。如图<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/9924070.jpg" alt=""><br>我这里创建了4个模块，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/85581956.jpg" alt=""><br><a id="more"></a><br>父工程的pom.xml如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/31441491.jpg" alt=""></p><h2 id="二、多模块合并打包"><a href="#二、多模块合并打包" class="headerlink" title="二、多模块合并打包"></a>二、多模块合并打包</h2><p>比如上面architecture1-customermgr和architecture1-goodsmgr位war类型，现在将这2个模块合并打包到architecture1-web中。<br>在architecture1-web的pom文件中增加2处：<br>1、增加2个模块的依赖<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/53348339.jpg" alt=""></p><p>注意：type=war</p><p>2、在build plugin中增加overlays<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/7224137.jpg" alt=""></p><p>3、执行父工程的maven install就可以生成了。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/26016877.jpg" alt=""></p><p>注意：如果多个war包存在路径相同且同名的文件，总的会覆盖分支的；如果总的没有，那么看合并的顺序，留下第一个的文件。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea远程连接Tomcat调试</title>
      <link href="/2017/08/31/idea-remote-tomcat-debug/"/>
      <url>/2017/08/31/idea-remote-tomcat-debug/</url>
      
        <content type="html"><![CDATA[<p>这里以Windows为例<br>1、Tomcat配置<br>a.打开catalina.bat，找到set JPDA_ADDRESS=8000，修改为其他端口，比如19876。<br>b.调试模式启动tomcat，cmd窗口执行catalina jpda start，启动后可以看到：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/97731033.jpg" alt=""><br><a id="more"></a><br>2、idea配置<br>新建一个new tomcat server,<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/1483133.jpg" alt=""><br>修改端口为tomcat中配置的端口，<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/25912781.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/16376328.jpg" alt=""></p><p>选择Type为Same file system，必须保证远程tomcat的代码与本地idea一致。</p><p>参考：<a href="http://blog.csdn.net/xlgen157387/article/details/50268457">http://blog.csdn.net/xlgen157387/article/details/50268457</a><br><a href="http://wenku.baidu.com/link?url=kR05WgbdIA-U7sNhxekUGx6fcOVYehpM46mQHXbMRxTUKozOoEm5RqM7BuzaPBYXux4TXjiUiWW28WCIzMo-924v9OCZLWgxqY8rUeoWs8q">http://wenku.baidu.com/link?url=kR05WgbdIA-U7sNhxekUGx6fcOVYehpM46mQHXbMRxTUKozOoEm5RqM7BuzaPBYXux4TXjiUiWW28WCIzMo-924v9OCZLWgxqY8rUeoWs8q</a></p><p>远程tomcat出现<br>Debugger failed to attach: handshake failed - connection prematurally closed错误的解决办法：<br><a href="http://blog.csdn.net/mingjie1212/article/details/52440608">http://blog.csdn.net/mingjie1212/article/details/52440608</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea提交SVN时忽略某些文件或文件夹</title>
      <link href="/2017/08/31/idea-svn-ignore/"/>
      <url>/2017/08/31/idea-svn-ignore/</url>
      
        <content type="html"><![CDATA[<p>在Changes试图中，可以看到默认只有一个Default change list。默认SVN提交时使用的就是Default组。<br><img src="/img/1564054770981.png" alt="1564054770981"></p><a id="more"></a><p>如果想忽略某个文件或文件夹，首先在Changes视图新建一个Changelist，比如截图中的ignore list。<br><img src="/img/1564054858461.png" alt="1564054858461"></p><p><img src="/img/1564054921952.png" alt="1564054921952"></p><p>然后再提交SVN时（如第一个图），将不提交SVN的文件Move到另外一个Changelist，如图：<br><img src="/img/1564054959739.png" alt="1564054959739"></p><p><img src="/img/1564054978575.png" alt="1564054978575"></p><p>这样Default视图就没有要忽略的文件了，就可以愉快的提交了。一些常见的需要忽略提交的文件：.iml,/target目录。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用ngrok将本地Web服务映射到外网</title>
      <link href="/2017/08/31/ngrok-intranet-to-network/"/>
      <url>/2017/08/31/ngrok-intranet-to-network/</url>
      
        <content type="html"><![CDATA[<p>一条命令解决的外网访问内网问题，本地WEB外网访问、本地开发微信、TCP端口转发。<br>官网地址：<a href="https://www.ngrok.cc/">https://www.ngrok.cc/</a></p><h2 id="第一步：开通隧道"><a href="#第一步：开通隧道" class="headerlink" title="第一步：开通隧道"></a>第一步：开通隧道</h2><p>平台登陆地址：<a href="http://www.ngrok.cc/login">http://www.ngrok.cc/login</a><br>登录进去后，点开通隧道，选择Y0.00/月。点立即购买<br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/30831372.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/43097250.jpg" alt=""><br>如上图，隧道名称随便填，前置域名为tommy，那么生成的域名就是tommy.ngrok.cc。<br><a id="more"></a><br>最后2项http验证用户名和密码，在你访问你本地的应用时，会提示你输入用户名和密码，就是这个。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/28649135.jpg" alt=""></p><p>这个是我之前开通的一个隧道，前置域名tommy.ngrok.cc。</p><h2 id="第二步：开启隧道"><a href="#第二步：开启隧道" class="headerlink" title="第二步：开启隧道"></a>第二步：开启隧道</h2><p>1）从官网下载相应平台的客户端，解压缩。<br>2）执行《Sunny-Ngrok启动工具.bat》输入客户端id即可<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/48005609.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/90065318.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/1945938.jpg" alt=""><br>如上图，127.0.0.1:8080已经映射到了<a href="http://tommy.ngrok.cc.ngrok.cc。">http://tommy.ngrok.cc.ngrok.cc。</a><br>所以如果你本地访问应用的URL是<a href="http://127.0.0.1:8080/MySpringMVC">http://127.0.0.1:8080/MySpringMVC</a>，那么现在使用<a href="http://tommy.ngrok.cc.ngrok.cc/MySpringMVC/">http://tommy.ngrok.cc.ngrok.cc/MySpringMVC/</a>也可以访问了，而且是外网也可以访问的。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fiddler抓取https请求，chrome提示证书无效的解决办法</title>
      <link href="/2017/08/31/Fiddler-chrome-ssl/"/>
      <url>/2017/08/31/Fiddler-chrome-ssl/</url>
      
        <content type="html"><![CDATA[<p>https相关的配置已经增加<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/74994403.jpg" alt=""></p><p>但用谷歌访问HTTPS网站，提示证书无效！</p><p>解决办法：右键，用管理员身份打开Fiddler就可以了。<br><a id="more"></a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Win10使用360WIFI抓手机APP网络请求</title>
      <link href="/2017/08/31/Win10-use-360WIFI-APP/"/>
      <url>/2017/08/31/Win10-use-360WIFI-APP/</url>
      
        <content type="html"><![CDATA[<p>下载Fiddler<br><a href="https://www.telerik.com/download/fiddler/fiddler4">https://www.telerik.com/download/fiddler/fiddler4</a><br>操作步骤：<br>1.打开Fiddler，Tools-Fiddler Options-Connections，勾选Allow remote computers to connect，端口为8888，保存选项后重启Fiddler；<br>2.在电脑上查看360wifi无线网卡IP地址，运行命令ipconfig /all，查看无线局域网适配器的IP信息，我的是172.27.35.1；<br>3.手机wifi中设置代理为步骤2中的IP地址，端口为步骤1中的端口8888；<br>4.打开应用开始愉快的抓包吧</p><p>其实上面的原理就是让手机和PC使用同一网络，并经过Fiddler的代理端口，拦截请求。</p><p>Win10需要注意：<br>1）启动Fiddler可能没有创建127.0.0.1:8888的代理，比如你使用了Chrome或Firefox浏览器，需要自行设置。<br>2）不论PC端还是手机端访问应用，Fiddler都没有显示请求。你可能需要关闭防火墙，且设置应用可使用本地代理网络运行。<br><a id="more"></a><br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/40039965.jpg" alt=""></p><p>在win8/win10，从应用商店下载的应用都是在沙箱运行的，没法使用本地代理网络。<br>在Fiddler中，有WinConfig，勾选需要使用本地代理网络的应用，点Save Changes保存设置，这样就可以了。</p><p>如果你之前已经安装过Fiddler，上面的试验都不成功，果断卸载重新安装吧。</p><p>如果要抓https请求：<br>在https选项中，勾选<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/50757110.jpg" alt=""></p><p>然后确定，重启Fiddler。</p><p>这里我以Firefox浏览器为例：<br>打开Firefox浏览器，输入127.0.0.1:8888，会显示根证书的下载地址，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/5855837.jpg" alt=""></p><p>点击该连接，设置为受信任的根证书，并且将Firefox代理中的https也勾选上，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/74492362.jpg" alt=""></p><p>对于IPhone，经过上面的设置后，可以捕捉http请求，如果要捕捉https请求，需要安装证书。<br>打开系统自带的浏览器（UC不行），访问127.0.0.1:8888，会出现根证书的下载地址，点击会提示你安装证书，安装后显示“已验证”就OK了。<br>如果显示未验证：<br>安装一个证书生成器，下载地址：<a href="http://www.enhanceie.com/dl/FiddlerCertMaker.exe">http://www.enhanceie.com/dl/FiddlerCertMaker.exe</a><br>然后重启Fiddler重新导出证书即可。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linux使用vi如何跳转到指定行</title>
      <link href="/2017/08/31/linux-use-vi-to-lines/"/>
      <url>/2017/08/31/linux-use-vi-to-lines/</url>
      
        <content type="html"><![CDATA[<h2 id="linux使用vi如何跳转到指定行"><a href="#linux使用vi如何跳转到指定行" class="headerlink" title="linux使用vi如何跳转到指定行"></a>linux使用vi如何跳转到指定行</h2><p>linux vi如何跳转到指定行，就一句话。<br>比如我想跳转到2012行，那么输入冒号，后面接2012，回车。如下面例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:2012</span><br></pre></td></tr></table></figure></p><p>就这简单。</p><p>linux vi如何显示行号：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:set number </span><br><span class="line">:set nonumber</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://www.gemingcao.com/archives/linux-vitiaozhuandaozhidinghang.html">linux使用vi如何跳转到指定行</a><br><a id="more"></a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>redis发布订阅示例</title>
      <link href="/2017/08/31/redis-pubsub/"/>
      <url>/2017/08/31/redis-pubsub/</url>
      
        <content type="html"><![CDATA[<p>在redis中可以同时订阅多个频道，有消息发布时redis会发出通知。jedis中提供了JedisPubSub抽象类来提供发布/订阅的机制，在实际应用中需要实现JedisPubSub类。<br><a id="more"></a></p><p>示例代码：</p><pre><code class="java"><span class="keyword">import</span> org.apache.log4j.Logger;<span class="keyword">import</span> org.springframework.context.ApplicationContext;<span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<span class="keyword">import</span> redis.clients.jedis.Jedis;<span class="keyword">import</span> redis.clients.jedis.JedisPubSub;<span class="keyword">import</span> redis.clients.jedis.JedisSentinelPool;<span class="keyword">import</span> java.io.BufferedReader;<span class="keyword">import</span> java.io.IOException;<span class="keyword">import</span> java.io.InputStreamReader; <span class="comment">/**</span><span class="comment">  * Redis发布订阅模式Test</span><span class="comment">  * <span class="doctag">@author</span> j.tommy</span><span class="comment">  * <span class="doctag">@date</span> 2016-09-07 10:46.</span><span class="comment">  */</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisPubSubTest</span> </span>{     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = Logger.getLogger(RedisPubSubTest.class);     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_NAME = <span class="string">"testChannel"</span>;     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Publisher</span> </span>{         <span class="keyword">private</span> Logger logger = Logger.getLogger(Publisher.class);         <span class="keyword">private</span> Jedis jedis;         <span class="function"><span class="keyword">public</span> <span class="title">Publisher</span><span class="params">(Jedis jedis)</span> </span>{             <span class="keyword">this</span>.jedis = jedis;         }         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{             logger.info(<span class="string">"Type your message (quit for terminate)"</span>);             <span class="keyword">try</span> {                 BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in));                 <span class="keyword">while</span> (<span class="keyword">true</span>) {                     String line = reader.readLine();                     <span class="keyword">if</span> (!<span class="string">"quit"</span>.equals(line)) {                         jedis.publish(RedisPubSubTest.CHANNEL_NAME, line);                     } <span class="keyword">else</span> {                         <span class="keyword">break</span>;                     }                 }             } <span class="keyword">catch</span> (IOException e) {                 logger.error(<span class="string">"IO failure while reading input, e"</span>);             }         }     }     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Subcriber</span> <span class="keyword">extends</span> <span class="title">JedisPubSub</span> </span>{         <span class="keyword">private</span> Logger logger = Logger.getLogger(Publisher.class);         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String channel, String message)</span> </span>{             logger.info(<span class="string">"Message received.Channel="</span> + channel + <span class="string">",message="</span> + message);         }         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPMessage</span><span class="params">(String s, String s1, String s2)</span> </span>{         }         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>{         }         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUnsubscribe</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>{         }         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPUnsubscribe</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>{         }         <span class="meta">@Override</span>         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPSubscribe</span><span class="params">(String s, <span class="keyword">int</span> i)</span> </span>{         }     }     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{         ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext_redis.xml"</span>);         JedisSentinelPool jedisSentinelPool = ac.getBean(JedisSentinelPool.class);         <span class="keyword">final</span> Jedis subcriberJedis = jedisSentinelPool.getResource();         <span class="comment">// 订阅频道</span>         <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {             <span class="meta">@Override</span>             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{                 <span class="keyword">try</span> {                     logger.info(<span class="string">"Subscribing to "</span> + CHANNEL_NAME + <span class="string">",this thread will be blocked."</span>);                     subcriberJedis.subscribe(<span class="keyword">new</span> Subcriber(),CHANNEL_NAME); <span class="comment">// 会一直阻塞在这一行</span>                     logger.info(<span class="string">"Subscribing ended. "</span>); <span class="comment">// 不会执行这一句。</span>                 } <span class="keyword">catch</span> (Exception e) {                     logger.error(<span class="string">"Subcribe channel failed."</span> ,e);                 }             }         }).start();         <span class="comment">// 发布信息</span>         Jedis publisherJedis = jedisSentinelPool.getResource();         <span class="keyword">new</span> Publisher(publisherJedis).start();     } }</code></pre><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/67870564.jpg" alt=""></p><p> 参考：<a href="http://outofmemory.cn/code-snippet/3866/redis-dingyue-publish-example">http://outofmemory.cn/code-snippet/3866/redis-dingyue-publish-example</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot定时任务</title>
      <link href="/2017/08/31/springboot-timetask/"/>
      <url>/2017/08/31/springboot-timetask/</url>
      
        <content type="html"><![CDATA[<p>springboot定时任务参考：<a href="http://spring.io/guides/gs/scheduling-tasks/">http://spring.io/guides/gs/scheduling-tasks/</a></p><p>创建一个springboot定时任务非常容易，2步完成：<br>1）在启动类（Application）中增加@EnableScheduling；<br>2）定时任务方法增加@Scheduled。<br><a id="more"></a></p><p>示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.coding.springboot.demo.task;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat;</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by j.tommy on 2015/11/2.</span></span><br><span class="line"><span class="comment"> * springboot定时任务，参考：http://spring.io/guides/gs/scheduling-tasks/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskDemo1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(TaskDemo1.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> DateFormat DATE_FORMAT = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd hh:mm:ss"</span>);</span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate = <span class="number">5000</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">task</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LOGGER.info(<span class="string">"现在时间是："</span> + DATE_FORMAT.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        <span class="comment">// 这里抛出一个异常，测试发现任务并不会终止。并不会影响下一次任务的执行</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">        <span class="comment">//        int i = 1/0;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Scheduled</span>(cron = <span class="string">"0/5 * * * * ?"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">task2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOGGER.info(<span class="string">"task2 executed."</span> + DATE_FORMAT.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring+redis sentinel主从切换</title>
      <link href="/2017/08/31/Spring-redis-sentinel-master-slave/"/>
      <url>/2017/08/31/Spring-redis-sentinel-master-slave/</url>
      
        <content type="html"><![CDATA[<p>Spring+redis sentinel 主从切换(failover)<br>redis sentinel配置参考：<a href="http://www.cnblogs.com/yjmyzz/p/redis-sentinel-sample.html">http://www.cnblogs.com/yjmyzz/p/redis-sentinel-sample.html</a><br>redis sentinel与spring的集成参考：<a href="http://www.cnblogs.com/yjmyzz/p/integrate-redis-with-spring.html">http://www.cnblogs.com/yjmyzz/p/integrate-redis-with-spring.html</a><br>redis对象的缓存也参考上面的文章。</p><h2 id="sentinel模式的spring文件配置"><a href="#sentinel模式的spring文件配置" class="headerlink" title="sentinel模式的spring文件配置"></a>sentinel模式的spring文件配置</h2><a id="more"></a> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:redis.properties"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"poolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxIdle&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxActive&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxWait&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.testOnBorrow&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisConnectionFactory"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usePool"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel.password&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database"</span> <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"sentinelConfiguration"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sentinelConfiguration"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisSentinelConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"master"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisNode"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel.master&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sentinels"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisNode"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel1.host&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel1.port&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.core.StringRedisTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jedisConnectionFactory"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis.properties:</span><br><span class="line">redis.maxIdle=5</span><br><span class="line">redis.maxActive=10</span><br><span class="line">redis.maxWait=1000</span><br><span class="line">redis.testOnBorrow=true</span><br><span class="line">redis.sentinel.master=mymaster</span><br><span class="line">redis.sentinel.password=system</span><br><span class="line">redis.sentinel1.host=192.168.10.237</span><br><span class="line">redis.sentinel1.port=26379</span><br></pre></td></tr></table></figure><p>注意：上面的端口是sentinel的端口，不是redis实例的端口。</p><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSentinelBySpring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext_redis_sentinel.xml"</span>);</span><br><span class="line">    StringRedisTemplate redisTemplate = ctx.getBean(StringRedisTemplate.class);</span><br><span class="line">    Collection&lt;RedisServer&gt; redisServers = redisTemplate.getConnectionFactory().getSentinelConnection().masters();</span><br><span class="line">    System.out.println(redisServers);</span><br><span class="line">    String key = <span class="string">"test"</span>;</span><br><span class="line">    String value = redisTemplate.opsForValue().get(key);</span><br><span class="line">    System.out.println(value);</span><br><span class="line">    redisServers = redisTemplate.getConnectionFactory().getSentinelConnection().masters();</span><br><span class="line">    System.out.println(redisServers);</span><br><span class="line">    redisTemplate.opsForValue().set(key,<span class="string">"New Master..."</span>);</span><br><span class="line">    value = redisTemplate.opsForValue().get(key);</span><br><span class="line">    System.out.println(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jedisConnFactory中配置的是master的ip和端口，端口不是sentinel的端口，是redis实例的端口（在redis.conf中配置的）。<br>redisSentinelConfiguration的sentinels属性配置的是哨兵，用于监控master，在确认master宕掉后根据一定的算法从哨兵中拿一个提升为master。</p><p>说下使用的Jar的版本：<br>spring:3.2.10.RELEASE<br>jedis:2.5.2<br>spring-data-redis:1.4.1.RELEASE<br>可能还依赖其他的一些jar，比如jackson。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring+redis sentinel主从切换</title>
      <link href="/2017/08/31/Spring+redis%20sentinel%20%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2/"/>
      <url>/2017/08/31/Spring+redis%20sentinel%20%E4%B8%BB%E4%BB%8E%E5%88%87%E6%8D%A2/</url>
      
        <content type="html"><![CDATA[<p>Spring+redis sentinel 主从切换(failover)<br>redis sentinel配置参考：<a href="http://www.cnblogs.com/yjmyzz/p/redis-sentinel-sample.html">http://www.cnblogs.com/yjmyzz/p/redis-sentinel-sample.html</a><br>redis sentinel与spring的集成参考：<a href="http://www.cnblogs.com/yjmyzz/p/integrate-redis-with-spring.html">http://www.cnblogs.com/yjmyzz/p/integrate-redis-with-spring.html</a><br>redis对象的缓存也参考上面的文章。</p><h2 id="sentinel模式的spring文件配置"><a href="#sentinel模式的spring文件配置" class="headerlink" title="sentinel模式的spring文件配置"></a>sentinel模式的spring文件配置</h2><a id="more"></a> <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"classpath:redis.properties"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"poolConfig"</span> <span class="attr">class</span>=<span class="string">"redis.clients.jedis.JedisPoolConfig"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdle"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxIdle&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxTotal"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxActive&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxWaitMillis"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.maxWait&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"testOnBorrow"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.testOnBorrow&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jedisConnectionFactory"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.jedis.JedisConnectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usePool"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel.password&#125;"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"10000"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"database"</span> <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">ref</span>=<span class="string">"sentinelConfiguration"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"1"</span> <span class="attr">ref</span>=<span class="string">"poolConfig"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"sentinelConfiguration"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisSentinelConfiguration"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"master"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisNode"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel.master&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sentinels"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.connection.RedisNode"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel1.host&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"$&#123;redis.sentinel1.port&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"> </span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"redisTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.data.redis.core.StringRedisTemplate"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jedisConnectionFactory"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="redis配置文件"><a href="#redis配置文件" class="headerlink" title="redis配置文件"></a>redis配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis.properties:</span><br><span class="line">redis.maxIdle=5</span><br><span class="line">redis.maxActive=10</span><br><span class="line">redis.maxWait=1000</span><br><span class="line">redis.testOnBorrow=true</span><br><span class="line">redis.sentinel.master=mymaster</span><br><span class="line">redis.sentinel.password=system</span><br><span class="line">redis.sentinel1.host=192.168.10.237</span><br><span class="line">redis.sentinel1.port=26379</span><br></pre></td></tr></table></figure><p>注意：上面的端口是sentinel的端口，不是redis实例的端口。</p><h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSentinelBySpring</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ApplicationContext ctx = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext_redis_sentinel.xml"</span>);</span><br><span class="line">    StringRedisTemplate redisTemplate = ctx.getBean(StringRedisTemplate.class);</span><br><span class="line">    Collection&lt;RedisServer&gt; redisServers = redisTemplate.getConnectionFactory().getSentinelConnection().masters();</span><br><span class="line">    System.out.println(redisServers);</span><br><span class="line">    String key = <span class="string">"test"</span>;</span><br><span class="line">    String value = redisTemplate.opsForValue().get(key);</span><br><span class="line">    System.out.println(value);</span><br><span class="line">    redisServers = redisTemplate.getConnectionFactory().getSentinelConnection().masters();</span><br><span class="line">    System.out.println(redisServers);</span><br><span class="line">    redisTemplate.opsForValue().set(key,<span class="string">"New Master..."</span>);</span><br><span class="line">    value = redisTemplate.opsForValue().get(key);</span><br><span class="line">    System.out.println(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jedisConnFactory中配置的是master的ip和端口，端口不是sentinel的端口，是redis实例的端口（在redis.conf中配置的）。<br>redisSentinelConfiguration的sentinels属性配置的是哨兵，用于监控master，在确认master宕掉后根据一定的算法从哨兵中拿一个提升为master。</p><p>说下使用的Jar的版本：<br>spring:3.2.10.RELEASE<br>jedis:2.5.2<br>spring-data-redis:1.4.1.RELEASE<br>可能还依赖其他的一些jar，比如jackson。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>activemq集群之master-slave+zookeeper</title>
      <link href="/2017/08/31/activemq-master-slave-zookeeper/"/>
      <url>/2017/08/31/activemq-master-slave-zookeeper/</url>
      
        <content type="html"><![CDATA[<blockquote><p>参考<a href="http://www.cnblogs.com/guozhen/p/6209973.html">ActiveMQ的集群方案对比及部署</a></p></blockquote><p><strong>本文使用的是activemq的master slave集群，俗称高可用，并没有考虑负载均衡。使用Zookeeper来管理各个broker.</strong></p><p>由于zookeeper选举原则是2N+1，所以至少要有3个broker。否则会提示“Not enough cluster members when using LevelDB replication”。这样就没法选择Master。</p><p>本文的例子是在Windows64位环境。</p><a id="more"></a><h2 id="zookeeper安装"><a href="#zookeeper安装" class="headerlink" title="zookeeper安装"></a>zookeeper安装</h2><p>下载就不说了，我下载的是zookeeper-3.3.6版本。下载下来后解压缩，然后在conf目录新建zoo.cfg文件，内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># The number of milliseconds of each tick</span><br><span class="line">tickTime=2000</span><br><span class="line"># The number of ticks that the initial </span><br><span class="line"># synchronization phase can take</span><br><span class="line">initLimit=10</span><br><span class="line"># The number of ticks that can pass between </span><br><span class="line"># sending a request and getting an acknowledgement</span><br><span class="line">syncLimit=5</span><br><span class="line"># the directory where the snapshot is stored.</span><br><span class="line">dataDir=D:/luckystar88/soft/zookeeper-3.3.6/zookeeper-3.3.6/data/1</span><br><span class="line"># the port at which the clients will connect</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure></p><p><strong>启动zookeeper</strong><br>执行$zookeeper_home$/bin下的zkServer.cmd即可。</p><h2 id="activemq安装"><a href="#activemq安装" class="headerlink" title="activemq安装"></a>activemq安装</h2><p>下载不多说，我这里使用的是apache-activemq-5.14.2版本。<br>解压缩，新建目录activemqtest，复制到该目录，并重命名为brokerA。<br><img src="http://p1.bqimg.com/567571/ed6ec565ec161726.png" alt=""></p><p>同样的，复制brokerA的副本，并重命名，得到brokerB,brokerC。这样就有3个broker。</p><h2 id="activemq各个broker配置"><a href="#activemq各个broker配置" class="headerlink" title="activemq各个broker配置"></a>activemq各个broker配置</h2><p><strong>brokerA的配置</strong><br>打开brokerA/conf下的activemq.xml文件。</p><blockquote><p>1.找到&lt;broker…，将brokerName设置为一个值，比如broker1.  </p></blockquote><blockquote><p>2.找到下面的代码，并注释掉。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">kahaDB</span> <span class="attr">directory</span>=<span class="string">"$&#123;activemq.data&#125;/kahadb"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>3.增加下面的代码<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">persistenceAdapter</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">replicatedLevelDB</span>     </span></span><br><span class="line"><span class="tag">      <span class="attr">directory</span>=<span class="string">"$&#123;activemq.data&#125;/leveldb"</span>    </span></span><br><span class="line"><span class="tag">      <span class="attr">replicas</span>=<span class="string">"3"</span>    </span></span><br><span class="line"><span class="tag">      <span class="attr">bind</span>=<span class="string">"tcp://0.0.0.0:0"</span>    </span></span><br><span class="line"><span class="tag">      <span class="attr">zkAddress</span>=<span class="string">"192.168.33.87:2181"</span>    </span></span><br><span class="line"><span class="tag">      <span class="attr">zkPassword</span>=<span class="string">""</span>    </span></span><br><span class="line"><span class="tag">      <span class="attr">hostname</span>=<span class="string">"192.168.33.87"</span>  </span></span><br><span class="line"><span class="tag">      <span class="attr">sync</span>=<span class="string">"local_disk"</span>  </span></span><br><span class="line"><span class="tag">      <span class="attr">zkPath</span>=<span class="string">"/activemq/leveldb-stores/group1"</span>   </span></span><br><span class="line"><span class="tag">    /&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">persistenceAdapter</span>&gt;</span></span><br></pre></td></tr></table></figure></p></blockquote><p>zkAddress的IP即为安装和打开zookeeper的电脑的IP，port即为zoo.cfg中配置的clientPort。</p><blockquote><p>4.修改transportConnector的端口为61616.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">transportConnectors</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transportConnector</span> <span class="attr">name</span>=<span class="string">"openwire"</span> <span class="attr">uri</span>=<span class="string">"tcp://192.168.33.87:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">transportConnectors</span>&gt;</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>5.修改jetty.xml中的端口为8161.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jettyPort"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.web.WebConsolePort"</span> <span class="attr">init-method</span>=<span class="string">"start"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- the default port number for the web console --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"host"</span> <span class="attr">value</span>=<span class="string">"0.0.0.0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"port"</span> <span class="attr">value</span>=<span class="string">"8161"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p></blockquote><p><strong>brokerB的配置</strong><br>修改同brokerA，但transportConnector的端口改为61617，jetty的端口改为8162.</p><p><strong>brokerC的配置</strong><br>修改同brokerA，但transportConnector的端口改为61618，jetty的端口改为8163.</p><h3 id="启动activemq集群"><a href="#启动activemq集群" class="headerlink" title="启动activemq集群"></a>启动activemq集群</h3><p>为了启动方便，我写了一个bat脚本，即activemqtest目录下的startCluster.bat。内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">d:</span><br><span class="line">cd luckystar88/soft/activemqtest</span><br><span class="line">cd brokerA/bin/win64</span><br><span class="line">start activemq.bat</span><br><span class="line"></span><br><span class="line">cd ../../../brokerB/bin/win64/</span><br><span class="line">start activemq.bat</span><br><span class="line"></span><br><span class="line">cd ../../../brokerC/bin/win64/</span><br><span class="line">start activemq.bat</span><br></pre></td></tr></table></figure></p><p>双击startCluster.bat，即可启动。（前提是zookeeper要先启动）<br><img src="http://p1.bpimg.com/567571/ea66b5df9dad8d6a.png" alt=""><br>如上图所示，其中一个broker成为了master，其他2个成为了slave。</p><h2 id="java-client连接activemq集群"><a href="#java-client连接activemq集群" class="headerlink" title="java client连接activemq集群"></a>java client连接activemq集群</h2><p>配置如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsFactory1_node1"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.pool.PooledConnectionFactory"</span>  <span class="attr">init-method</span>=<span class="string">"start"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">destroy-method</span>=<span class="string">"stop"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;property name="brokerURL" value="failover://(tcp://127.0.0.1:61616,tcp://127.0.0.1:61617,tcp://127.0.0.1:61618,tcp://192.168.10.237:61619,tcp://192.168.10.237:61620,tcp://192.168.10.237:61621)"&gt;&lt;/property&gt;--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span> <span class="attr">value</span>=<span class="string">"failover:(tcp://192.168.33.87:61616,tcp://192.168.33.87:61617,tcp://192.168.33.87:61618)"</span> &gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userName"</span> <span class="attr">value</span>=<span class="string">"admin"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"admin"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useAsyncSend"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"alwaysSessionAsync"</span> <span class="attr">value</span>=<span class="string">"false"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"optimizeAcknowledge"</span> <span class="attr">value</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"producerWindowSize"</span> <span class="attr">value</span>=<span class="string">"1024000"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnections"</span> <span class="attr">value</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"idleTimeout"</span> <span class="attr">value</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"expiryTimeout"</span> <span class="attr">value</span>=<span class="string">"600000"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>消息生产者可以每隔几秒钟发送一条数据到mq，消费者一直监听消息。<br>在发送几条数据后，关闭master的broker，可以发现还是可以继续发送信息，并不会出错。而且<a href="http://localhost:8161,http://localhost:8162,http://localhost:8163同一时间只有一个能打开。">http://localhost:8161,http://localhost:8162,http://localhost:8163同一时间只有一个能打开。</a></p><p><strong>注意事项</strong></p><p>3个broker的brokerName,zkPath等必须一致。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring结合activemq使用</title>
      <link href="/2017/08/31/spring-activemq/"/>
      <url>/2017/08/31/spring-activemq/</url>
      
        <content type="html"><![CDATA[<h3 id="spring结合activemq使用"><a href="#spring结合activemq使用" class="headerlink" title="spring结合activemq使用"></a>spring结合activemq使用</h3><p>依赖如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activemq-pool<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>xml-apis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xml-apis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.01<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><a id="more"></a><h3 id="发送和接收队列消息的配置："><a href="#发送和接收队列消息的配置：" class="headerlink" title="发送和接收队列消息的配置："></a>发送和接收队列消息的配置：</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsFactory"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.pool.PooledConnectionFactory"</span> <span class="attr">destroy-method</span>=<span class="string">"stop"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>tcp://192.168.10.65:61616<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnections"</span> <span class="attr">value</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jmsFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果使用jmsTemplate发送时不指定destination，则发送到默认的destination，即这里配置的--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultDestination"</span> <span class="attr">ref</span>=<span class="string">"destination"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.support.converter.SimpleMessageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"destination"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQQueue"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"spring-queue"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>发送和接收消息都是通过JmsTemplate类操作的。在JmsTemplate中有defaultDestination属性，表示默认的目的地，可以是队列也可以是Topic。当你配置了默认的destination后，在使用jmsTemplate发送消息不指定destination时就使用默认的destination。  </p><p>发送消息的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.MessageCreator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Message;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Session;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-04-06 17:59.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueSendTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsTemplate jmsTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"application*.xml"</span>);</span><br><span class="line">        QueueSendTest qst = ac.getBean(QueueSendTest.class);</span><br><span class="line">        qst.jmsTemplate.send(<span class="keyword">new</span> MessageCreator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</span><br><span class="line">                TextMessage msg = session.createTextMessage(<span class="string">"Spring msg ==="</span>);</span><br><span class="line">                <span class="keyword">return</span> msg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>接收消息的代码为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.core.JmsTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-04-06 18:02.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueRecvTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JmsTemplate jmsTemplate;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ApplicationContext ac = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"application*.xml"</span>);</span><br><span class="line">        QueueRecvTest qrt = ac.getBean(QueueRecvTest.class);</span><br><span class="line">        String msg = (String) qrt.jmsTemplate.receiveAndConvert();</span><br><span class="line">        System.out.println(<span class="string">"recv msg : "</span> + msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>先启动发送端，再启动接收端就可以接收到消息了。  </p><h3 id="发送和接收topic消息"><a href="#发送和接收topic消息" class="headerlink" title="发送和接收topic消息"></a>发送和接收topic消息</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsFactory"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.pool.PooledConnectionFactory"</span> <span class="attr">destroy-method</span>=<span class="string">"stop"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.ActiveMQConnectionFactory"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"brokerURL"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>tcp://192.168.10.65:61616<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxConnections"</span> <span class="attr">value</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsTemplate"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.core.JmsTemplate"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jmsFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--如果使用jmsTemplate发送时不指定destination，则发送到默认的destination，即这里配置的--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultDestination"</span> <span class="attr">ref</span>=<span class="string">"destinationTopic"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.support.converter.SimpleMessageConverter"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"destinationTopic"</span> <span class="attr">class</span>=<span class="string">"org.apache.activemq.command.ActiveMQTopic"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"spring-topic"</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jmsContainer"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"connectionFactory"</span> <span class="attr">ref</span>=<span class="string">"jmsFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"destination"</span> <span class="attr">ref</span>=<span class="string">"destinationTopic"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageListener"</span> <span class="attr">ref</span>=<span class="string">"messageListener"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"messageListener"</span> <span class="attr">class</span>=<span class="string">"com.hhly.jms.MyMessageListener"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><p>发送端的代码与队列一样。<br>接收端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Message;</span><br><span class="line"><span class="keyword">import</span> javax.jms.MessageListener;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2017-04-07 09:25.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message <span class="keyword">instanceof</span> TextMessage) &#123;</span><br><span class="line">            TextMessage tm = (TextMessage) message;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"接收到消息："</span> + tm.getText());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (JMSException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>启动发送端就可以了。</p><p>说明：  </p><ol><li>在JmsTemplate中配置了defaultDestination属性后，在发送时如果不指定destination将使用默认的。建议在发送时指定Destionation。<br>如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-4-7/15286607-file_1491529867099_167d1.png" alt=""></li><li>最佳实践<br><img src="http://omh46px9n.bkt.clouddn.com/17-4-7/4945873-file_1491530798315_4a18.png" alt=""></li><li>最好不要使用failover，使用failover在broker异常时会阻塞住。使用spring的DefaultMessageListenerContainer会自动重连，如图：<br><img src="http://omh46px9n.bkt.clouddn.com/17-4-7/1176236-file_1491546575125_62fb.png" alt="">。failover能够在你配置了多个activemq时自动选择可用的broker，但broker异常会导致线程阻塞。如果一定要使用failover，比如就配置了一个activemq，建议数据放到队列，同时队列设置一定的容量，有专门的线程从队列取数据放入mq。  </li><li>log4j日志级别不能配置error，否则spring和activemq的日志显示不了。</li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> activemq </tag>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ICEBOX使用示例</title>
      <link href="/2017/08/31/icebox-usage/"/>
      <url>/2017/08/31/icebox-usage/</url>
      
        <content type="html"><![CDATA[<h2 id="系统安装ice3-4-1，并配置环境变量；"><a href="#系统安装ice3-4-1，并配置环境变量；" class="headerlink" title="系统安装ice3.4.1，并配置环境变量；"></a>系统安装ice3.4.1，并配置环境变量；</h2><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/76200106.jpg" alt=""></p><h2 id="定义slice文件"><a href="#定义slice文件" class="headerlink" title="定义slice文件"></a>定义slice文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[[ <span class="string">"java:package:com.hhly.tel.ice"</span>]]</span><br><span class="line"><span class="keyword">module</span> book &#123;</span><br><span class="line">   <span class="class"><span class="keyword">interface</span> <span class="title">OnlineBook</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">bookTick</span><span class="params">(string name,<span class="keyword">double</span> price,string content)</span></span>;</span><br><span class="line">   &#125;;</span><br><span class="line">   </span><br><span class="line">   <span class="class"><span class="keyword">interface</span> <span class="title">SMSService</span> </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">void</span> <span class="title">sendSMS</span><span class="params">(string name,<span class="keyword">double</span> price,string content)</span></span>;</span><br><span class="line">   &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>这表示有2个接口，一个OnlineBook，一个SMSService，都位于com.hhly.tel.ice.book下面。<br><a id="more"></a></p><h2 id="生成JAVA类"><a href="#生成JAVA类" class="headerlink" title="生成JAVA类"></a>生成JAVA类</h2><p>使用slice2java xx.ice生成<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/55495195.jpg" alt=""></p><p>然后将生成的类复制到工程中<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/91603917.jpg" alt=""></p><p>上图中圈红的都是ice生成的类。</p><h2 id="实现我们自己的逻辑"><a href="#实现我们自己的逻辑" class="headerlink" title="实现我们自己的逻辑"></a>实现我们自己的逻辑</h2><p>如上图的service下面，是OnlineBook和SMSService的实现，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hhly.tel.ice.book.service;</span><br><span class="line"><span class="keyword">import</span> Ice.Communicator;</span><br><span class="line"><span class="keyword">import</span> Ice.Current;</span><br><span class="line"><span class="keyword">import</span> Ice.ObjectAdapter;</span><br><span class="line"><span class="keyword">import</span> IceBox.Service;</span><br><span class="line"><span class="keyword">import</span> com.hhly.tel.ice.book._OnlineBookDisp;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Author</span> j.tommy</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Date</span> 2016/6/19 0019 上午 4:08</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ICEBookService</span> <span class="keyword">extends</span> <span class="title">_OnlineBookDisp</span> <span class="keyword">implements</span> <span class="title">Service</span></span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = Logger.getLogger(ICEBookService.class);</span><br><span class="line"> <span class="keyword">private</span> ObjectAdapter _adapter;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bookTick</span><span class="params">(String name, <span class="keyword">double</span> price, String content, Current __current)</span> </span>&#123;</span><br><span class="line">     log.info(<span class="string">"Call bookTick()...params-&gt;[name="</span> + name + <span class="string">",price="</span> + price + <span class="string">",content="</span> + content + <span class="string">"]."</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String name, Communicator communicator, String[] strings)</span> </span>&#123;</span><br><span class="line">     <span class="comment">// 创建objectAdapter,这里和service同名</span></span><br><span class="line">     _adapter = communicator.createObjectAdapter(name);</span><br><span class="line">     <span class="comment">// 传Serant并激活</span></span><br><span class="line">     Ice.Object object = <span class="keyword">this</span>;</span><br><span class="line">     _adapter.add(object,communicator.stringToIdentity(name));</span><br><span class="line">     _adapter.activate();</span><br><span class="line">     log.info(name + <span class="string">" started."</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     log.info(<span class="keyword">this</span>._adapter.getName() + <span class="string">" stoped."</span>);</span><br><span class="line">     _adapter.destroy();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hhly.tel.ice.book.service;</span><br><span class="line"><span class="keyword">import</span> Ice.Communicator;</span><br><span class="line"><span class="keyword">import</span> Ice.Current;</span><br><span class="line"><span class="keyword">import</span> Ice.ObjectAdapter;</span><br><span class="line"><span class="keyword">import</span> IceBox.Service;</span><br><span class="line"><span class="keyword">import</span> com.hhly.tel.ice.book._SMSServiceDisp;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Author</span> j.tommy</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Date</span> 2016/6/19 0019 上午 4:08</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ICESMSService</span> <span class="keyword">extends</span> <span class="title">_SMSServiceDisp</span> <span class="keyword">implements</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = Logger.getLogger(ICESMSService.class);</span><br><span class="line">    <span class="keyword">private</span> ObjectAdapter _adapter;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(String name, Communicator communicator, String[] strings)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建objectAdapter,这里和service同名</span></span><br><span class="line">        _adapter = communicator.createObjectAdapter(name);</span><br><span class="line">        <span class="comment">// 传Serant并激活</span></span><br><span class="line">        Ice.Object object = <span class="keyword">this</span>;</span><br><span class="line">        _adapter.add(object,communicator.stringToIdentity(name));</span><br><span class="line">        _adapter.activate();</span><br><span class="line">        log.info(name + <span class="string">" started."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="keyword">this</span>._adapter.getName() + <span class="string">" stoped."</span>);</span><br><span class="line">        _adapter.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSMS</span><span class="params">(String name, <span class="keyword">double</span> price, String content, Current __current)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Call sendSMS()...params-&gt;[name="</span> + name + <span class="string">",price="</span> + price + <span class="string">",content="</span> + content + <span class="string">"]."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>icebox的配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">#server properties</span><br><span class="line"># icebox实例的名字</span><br><span class="line">IceBox.InstanceName=MyAppIceBox 1</span><br><span class="line"># =1表示所有的服务使用Icebox中的配置</span><br><span class="line">IceBox.InheritProperties=1</span><br><span class="line"># =1会在icebox启动完毕后打印MyAppIceBox 1 ready</span><br><span class="line">IceBox.PrintServicesReady=MyAppIceBox 1</span><br><span class="line">#IceBox的管理组件，使之能够被远程访问，默认关闭，下面将其绑定到本地9999端口</span><br><span class="line">IceBox.ServiceManager.Endpoints=tcp -p 8989 -h localhost</span><br><span class="line">#performance properties</span><br><span class="line">Ice.ThreadPool.Server.Size=4</span><br><span class="line">Ice.ThreadPool.Server.SizeMax=100</span><br><span class="line">Ice.ThreadPool.Server.SizeWarn=10</span><br><span class="line">Ice.ThreadPool.Client.Size=4</span><br><span class="line">Ice.ThreadPool.Client.SizeMax=100</span><br><span class="line">Ice.ThreadPool.Client.SizeWarn=40</span><br><span class="line">#for system stronger</span><br><span class="line">Ice.ACM.Client=300</span><br><span class="line">Ice.ACM.Server=300</span><br><span class="line">#log and trace</span><br><span class="line">#表明日志存放在日志文件中，否则会打印到控制台。</span><br><span class="line">#Ice.LogFile=iceserv.log</span><br><span class="line">Ice.PrintStackTraces=1</span><br><span class="line">Ice.Trace.Retry=2</span><br><span class="line">Ice.Trace.Network=2</span><br><span class="line">Ice.Trace.ThreadPool=1</span><br><span class="line">Ice.Trace.Locator=2</span><br><span class="line">Ice.Warn.Connections=1</span><br><span class="line">Ice.Warn.Dispatch=1</span><br><span class="line">Ice.Warn.Endpoints=1</span><br><span class="line">#service defined begin</span><br><span class="line">IceBox.Service.OnlineBook=com.hhly.tel.ice.book.service.ICEBookService prop1=1 prop2=2 prop3=3</span><br><span class="line">IceBox.Service.SMSService=com.hhly.tel.ice.book.service.ICESMSService</span><br><span class="line">OnlineBook.Endpoints=tcp -p 9000 -h localhost</span><br><span class="line">SMSService.Endpoints=tcp -p 9001 -h localhost</span><br><span class="line">#service defined end</span><br><span class="line">#server load order</span><br><span class="line">IceBox.LoadOrder=OnlineBook,SMSService</span><br><span class="line">#service share communicator</span><br><span class="line">IceBox.UseSharedCommunicator.OnlineBook=1</span><br><span class="line">IceBox.UseSharedCommunicator.SMSService=1</span><br></pre></td></tr></table></figure></p><p>IceBox.Service.name=entry_point [–key=value] [args]<br>各个参数的定义：<br>name定义了service的名字，如上面定了2个Service，一个OnlineBook,一个SMSService.<br>entry_point是service的完整类名<br>[–key=value]将会被作为property属性，用于构造该服务的communicator，用来更加精确的控制每个Ice服务的性能调优，这里也可以使用–Ice.Config=xxx.cfg的方式从具体的配置文件加载参数。<br>IceBox.InheritProperties=1，让所有的ice服务都使用IceBox的配置属性。<br>[args]作为参数传入start()方法的args参数，作为服务端启动初始化参数。</p><p>Ice.MessageSizeMax:做大消息包的字节数<br>Ice.Trace.Network=1，开启网络事件相关的日志追踪<br>Ice.Trace.ThreadPool=1，开启线程池事件的日志追踪<br>Ice.Trace.Locator=1，开启Locator对象的日志追踪</p><p>IceBox.UseShardedCommunicator.serviceName=1，实现服务本地调用的优化。如上面的OnlineBook和SMSService，都部署在同一个IceBox中，定义他们使用同一个Communicator对象，实现本地调用的优化。</p><p>IceBox.LoadOrder=serv1,serv2,serv3，指定服务的加载顺序，如上面的OnlineBook和SMSService。</p><h2 id="启动服务，并启动"><a href="#启动服务，并启动" class="headerlink" title="启动服务，并启动"></a>启动服务，并启动</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hhly.tel.ice.book.client;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> j.tommy</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2016/6/19 0019 上午 4:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">      IceBox.Server server = <span class="keyword">new</span> IceBox.Server();</span><br><span class="line">      server.main(<span class="keyword">new</span> String[]&#123;<span class="string">"--Ice.Config=icebox.properties"</span>&#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="编写客户端并启动"><a href="#编写客户端并启动" class="headerlink" title="编写客户端并启动"></a>编写客户端并启动</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hhly.tel.ice.book.client;</span><br><span class="line"><span class="keyword">import</span> com.hhly.tel.ice.book.*;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Author</span> j.tommy</span></span><br><span class="line"><span class="comment">* <span class="doctag">@Date</span> 2016/6/19 0019 上午 4:27</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 调用OnlineBook接口</span></span><br><span class="line">        bookTick(args);</span><br><span class="line">        <span class="comment">// 调用SMSService接口</span></span><br><span class="line">        sendSMS(args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bookTick</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> status = <span class="number">0</span>;</span><br><span class="line">        Ice.Communicator ic = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ic = Ice.Util.initialize(args);</span><br><span class="line">            Ice.ObjectPrx base = ic.stringToProxy(<span class="string">"OnlineBook:default -p 9000"</span>);</span><br><span class="line">            OnlineBookPrx onlineBookPrx = OnlineBookPrxHelper.checkedCast(base);</span><br><span class="line">            <span class="keyword">if</span> (onlineBookPrx == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid proxy"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            onlineBookPrx.bookTick(<span class="string">"ICE权威指南"</span>,<span class="number">59</span>,<span class="string">"这是一本介绍ICE的书籍。"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error error) &#123;</span><br><span class="line">            error.printStackTrace();</span><br><span class="line">            status = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ic.destroy();</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            System.exit(status);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendSMS</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> status = <span class="number">0</span>;</span><br><span class="line">        Ice.Communicator ic = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ic = Ice.Util.initialize(args);</span><br><span class="line">            Ice.ObjectPrx base = ic.stringToProxy(<span class="string">"SMSService:default -p 9001"</span>);</span><br><span class="line">            SMSServicePrx smsServicePrx = SMSServicePrxHelper.checkedCast(base);</span><br><span class="line">            <span class="keyword">if</span> (smsServicePrx == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid proxy"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            smsServicePrx.sendSMS(<span class="string">"ICE权威指南"</span>,<span class="number">59</span>,<span class="string">"这是一本介绍ICE的书籍。"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Error error) &#123;</span><br><span class="line">            error.printStackTrace();</span><br><span class="line">            status = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ic.destroy();</span><br><span class="line">            &#125;</span><br><span class="line">            System.exit(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ICE-Service之间的调用"><a href="#ICE-Service之间的调用" class="headerlink" title="ICE Service之间的调用"></a>ICE Service之间的调用</h2><p>ICESMSService的实现方法修改如下：</p><pre><code class="java"><span class="meta">@Override</span><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSMS</span><span class="params">(String name, <span class="keyword">double</span> price, String content, Current __current)</span> </span>{    <span class="keyword">if</span> (name.startsWith(<span class="string">"book"</span>)) {        Ice.ObjectPrx base = _adapter.getCommunicator().stringToProxy(<span class="string">"OnlineBook"</span>);        OnlineBookPrx onlineBookPrx = OnlineBookPrxHelper.checkedCast(base);        <span class="keyword">if</span> (<span class="keyword">null</span> != onlineBookPrx) {            onlineBookPrx.bookTick(name,price,content);            log.info(<span class="string">"通过短信购买图书！...params-&gt;[name="</span> + name + <span class="string">",price="</span> + price + <span class="string">",content="</span> + content + <span class="string">"]."</span>);        }         <span class="keyword">else</span> {             <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Can't find OnlinkBook Service."</span>);         }     }     <span class="keyword">else</span> {         log.info(<span class="string">"发送短信成功...params-&gt;[name="</span> + name + <span class="string">",price="</span> + price + <span class="string">",content="</span> + content + <span class="string">"]."</span>);     } }</code></pre><p>上面的代码表明：如果name以book开头，则内部调用OnlineBookService购买图书。否则就是发送短信。</p><p>试验：<br>客户端代码：</p><pre><code class="java"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendSMS</span><span class="params">(String name,<span class="keyword">double</span> price,String content,String[] args)</span> </span>{    <span class="keyword">int</span> status = <span class="number">0</span>;    Ice.Communicator ic = <span class="keyword">null</span>;    <span class="keyword">try</span> {        ic = Ice.Util.initialize(args);        Ice.ObjectPrx base = ic.stringToProxy(<span class="string">"SMSService:default -p 9001"</span>);        SMSServicePrx smsServicePrx = SMSServicePrxHelper.checkedCast(base);        <span class="keyword">if</span> (smsServicePrx == <span class="keyword">null</span>) {            <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">"Invalid proxy"</span>);         }         smsServicePrx.sendSMS(name,price,content);     } <span class="keyword">catch</span> (Error error) {         error.printStackTrace();         status = <span class="number">1</span>;     } <span class="keyword">finally</span> {         <span class="keyword">if</span> (ic != <span class="keyword">null</span>) {             ic.destroy();         }<span class="comment">//            System.exit(status);</span>     } }<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{    <span class="comment">// 调用OnlineBook接口</span>    bookTick(args);    System.out.println(<span class="string">"bookTick(args) Finished"</span>);    <span class="comment">// 调用SMSService接口</span>    sendSMS(<span class="string">"book ICE权威指南"</span>,<span class="number">59</span>,<span class="string">"这是一本介绍ICE的书籍。"</span>,args);    System.out.println(<span class="string">"sendSMS() Finished"</span>);    <span class="comment">// 在SMSService中调用OnlineBookService，演示ICE服务之间的调用</span>    sendSMS(<span class="string">"发送短信"</span>,<span class="number">59</span>,<span class="string">"这是一本介绍ICE的书籍。"</span>,args);     System.out.println(<span class="string">"Send Message Finished."</span>); }</code></pre>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>封装ICE客户端</title>
      <link href="/2017/08/31/package-ice-client/"/>
      <url>/2017/08/31/package-ice-client/</url>
      
        <content type="html"><![CDATA[<p>来自《ICE权威指南》一书中的Ice的一个工具类。<br><a id="more"></a></p><p>IceClientUtil.java:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lucky.interf.util;</span><br><span class="line"><span class="keyword">import</span> Ice.Communicator;</span><br><span class="line"><span class="keyword">import</span> Ice.ObjectPrx;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.ResourceBundle;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@Author</span> j.tommy</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@Date</span> 2016/7/3 0003 下午 9:50</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IceClientUtil</span> </span>&#123;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class, ObjectPrx&gt; cls2PrxMap = <span class="keyword">new</span> HashMap&lt;Class, ObjectPrx&gt;();</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Ice.Communicator ic = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastAccessTime = <span class="number">0L</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> MonitorThread monitorThread;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> idleTimeoutSeconds = <span class="number">300</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String locatorKey = <span class="string">"--Ice.Default.Locator"</span>;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> String iceLocator = <span class="keyword">null</span>;</span><br><span class="line"> <span class="comment">//    private static final String clientConfigFile = "iceconfig/iceclient.conf";</span></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 获取代理对象</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ObjectPrx <span class="title">getServicePrx</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">         ObjectPrx prx = cls2PrxMap.get(clazz);</span><br><span class="line">         <span class="keyword">if</span> (prx != <span class="keyword">null</span>) &#123;</span><br><span class="line">             lastAccessTime = System.currentTimeMillis();</span><br><span class="line">             <span class="keyword">return</span> prx;</span><br><span class="line">         &#125;</span><br><span class="line">         prx = createServicePrx(getIceCommunicator(),clazz);</span><br><span class="line">         cls2PrxMap.put(clazz,prx);</span><br><span class="line">         lastAccessTime = System.currentTimeMillis();</span><br><span class="line">         <span class="keyword">return</span> prx;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">// 创建守护线程，关闭长时间不使用的连接</span></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createMonitorThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         monitorThread = <span class="keyword">new</span> MonitorThread();</span><br><span class="line">         monitorThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">         monitorThread.start();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> Ice.<span class="function">Communicator <span class="title">getIceCommunicator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         <span class="keyword">if</span> (ic == <span class="keyword">null</span>) &#123;</span><br><span class="line">             <span class="keyword">synchronized</span> (IceClientUtil.class) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (ic == <span class="keyword">null</span>) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (iceLocator == <span class="keyword">null</span>) &#123;</span><br><span class="line">                         ResourceBundle rb = ResourceBundle.getBundle(<span class="string">"iceclient"</span>, Locale.ENGLISH);</span><br><span class="line">                         iceLocator = rb.getString(locatorKey);</span><br><span class="line">                         idleTimeoutSeconds = Integer.parseInt(rb.getString(<span class="string">"idleTimeoutSeconds"</span>));</span><br><span class="line">                         String[] initParams = <span class="keyword">new</span> String[]&#123;locatorKey + <span class="string">"="</span> + iceLocator&#125;;</span><br><span class="line">                         ic = Ice.Util.initialize(initParams);</span><br><span class="line">                         createMonitorThread();</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="comment">// 另外一种创建Ice.Communicator的方式</span></span><br><span class="line">                     <span class="comment">/*Ice.InitializationData initData = new InitializationData();</span></span><br><span class="line"><span class="comment">                     initData.properties = Ice.Util.createProperties();</span></span><br><span class="line"><span class="comment">                     initData.properties.load(clientConfigFile);</span></span><br><span class="line"><span class="comment">                     ic = Ice.Util.initialize(initData);*/</span></span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> ic;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 使用反射方式创建ice代理对象</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> ic</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> clazz</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ObjectPrx <span class="title">createServicePrx</span><span class="params">(Communicator ic, Class clazz)</span> </span>&#123;</span><br><span class="line">         ObjectPrx prx = <span class="keyword">null</span>;</span><br><span class="line">         String className = clazz.getName();</span><br><span class="line">         String serviceName = clazz.getSimpleName();</span><br><span class="line">         <span class="keyword">int</span> pos = serviceName.lastIndexOf(<span class="string">"Prx"</span>);</span><br><span class="line">         <span class="keyword">if</span> (pos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid ObjectPrx class,class name must end with Prx."</span>);</span><br><span class="line">         &#125;</span><br><span class="line">         String realServiceName = serviceName.substring(<span class="number">0</span>, pos);</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             Ice.ObjectPrx base = ic.stringToProxy(realServiceName);</span><br><span class="line">             prx = (ObjectPrx) Class.forName(className + <span class="string">"Helper"</span>).newInstance();</span><br><span class="line">             Method method = prx.getClass().getDeclaredMethod(<span class="string">"uncheckedCast"</span>,Ice.ObjectPrx.class);</span><br><span class="line">             prx = (ObjectPrx) method.invoke(prx,base);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">             e.printStackTrace();</span><br><span class="line">             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> prx;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MonitorThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">while</span> (!monitorThread.isInterrupted()) &#123;</span><br><span class="line">                 <span class="keyword">try</span> &#123;</span><br><span class="line">                     TimeUnit.SECONDS.sleep(<span class="number">5</span>);</span><br><span class="line">                     <span class="keyword">if</span> (lastAccessTime + idleTimeoutSeconds &lt; System.currentTimeMillis()) &#123;</span><br><span class="line">                         closeCommunicator(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeCommunicator</span><span class="params">(<span class="keyword">boolean</span> removeServicesCache)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (IceClientUtil.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                safeShutdown();</span><br><span class="line">                monitorThread.interrupt();</span><br><span class="line">                <span class="keyword">if</span> (removeServicesCache &amp;&amp; !cls2PrxMap.isEmpty()) &#123;</span><br><span class="line">                    cls2PrxMap.clear();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">safeShutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ic.shutdown();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ic.destroy();</span><br><span class="line">            ic = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>iceclient.properties文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--Ice.Default.Locator=DemoGrid/Locator:tcp -h 127.0.0.1 -p 4061:tcp -h 127.0.0.1 -p 4062</span><br><span class="line">idleTimeoutSeconds = 300</span><br></pre></td></tr></table></figure></p><p>调用：</p><pre><code class="java"><span class="keyword">import</span> com.lucky.interf.generated.CalcServiceIcePrx;<span class="keyword">import</span> com.lucky.interf.generated.MessageServiceIcePrx;<span class="keyword">import</span> com.lucky.interf.util.IceClientUtil;<span class="comment">/**</span><span class="comment"> * <span class="doctag">@Author</span> j.tommy</span><span class="comment"> * <span class="doctag">@Date</span> 2016/7/2 0002 下午 12:34</span><span class="comment"> */</span><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>{    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{         MessageServiceIcePrx msip = (MessageServiceIcePrx) IceClientUtil.getServicePrx(MessageServiceIcePrx.class);         String result = msip.sendMessage(<span class="string">"IceBox msg"</span>);         System.out.println(<span class="string">"result-&gt;"</span> + result);         CalcServiceIcePrx csip = (CalcServiceIcePrx) IceClientUtil.getServicePrx(CalcServiceIcePrx.class);         <span class="keyword">double</span> sum = csip.calc(<span class="number">0.999</span>, <span class="number">0.001</span>);         System.out.println(<span class="string">"sum-&gt;"</span> + sum);     } }</code></pre>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ice </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idea git操作</title>
      <link href="/2017/08/31/idea-git/"/>
      <url>/2017/08/31/idea-git/</url>
      
        <content type="html"><![CDATA[<p>这里以git@oschina举例说明。<br>git的pull就相当于svn的update，push就相当于commit。</p><a id="more"></a><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>虽然idea集成了git插件，但你仍然需要安装git（windows版本git for windows）。<br>然后在idea的Version Control中选择git.exe的位置。<br><img src="/img/idea-git-set-gitpath.png" alt=""></p><p>下面的例子已osc@git为例说明</p><h2 id="一、从git仓库checkout项目到idea"><a href="#一、从git仓库checkout项目到idea" class="headerlink" title="一、从git仓库checkout项目到idea"></a>一、从git仓库checkout项目到idea</h2><p>复制git仓库地址，然后idea中选择VCS-&gt;Check out from Version Control-&gt;Git<br><img src="/img/idea-checkout-from-git.png" alt=""><br>后面会提示你输入osc@git的用户名和密码，然后就可以checkout下来了。</p><h2 id="二、将idea中已有的项目分享到git-osc"><a href="#二、将idea中已有的项目分享到git-osc" class="headerlink" title="二、将idea中已有的项目分享到git@osc"></a>二、将idea中已有的项目分享到git@osc</h2><p>1  .在osc@git上创建一个仓库，比如：<br><a href="https://git.oschina.net/qincd/readimage.git">https://git.oschina.net/qincd/readimage.git</a><br>2  .idea操作<br>没有办法像SVN一样，直接将项目share到远程仓库。<br>需要使用命令行执行git命令。如下：<br>1）选择要share的项目，然后vcs-&gt;Import into Version Control-&gt;Create git repository<br><img src="/img/idea-git-share-porject-1.png" alt=""><br>然后选择你要share的项目。</p><p>2)打开命令行，切换到你要share的项目路径，执行下面的命令<br><img src="/img/idea-git-share-project-2.png" alt=""><br>执行完毕后，就将本地仓库和远程仓库建立了联系。</p><p>3）回到idea，执行git-&gt;add命令，然后commit and push就可以了，后面就可以愉快的执行pull/push操作了。<br><img src="/img/idea-git-share-project-3.png" alt=""><br>注意：<br>执行git的commit只是提交到本地仓库，需要再执行push命令才能提交到远程git仓库</p><p><img src="/img/idea-git-commit-and-push.png" alt=""></p><h2 id="提交代码到远程操作"><a href="#提交代码到远程操作" class="headerlink" title="提交代码到远程操作"></a>提交代码到远程操作</h2><p>1.执行add操作（右键Git–&gt;Add），将文件添加到版本控制；<br>2.执行commit操作（右键Git-&gt;Commit Directory/File），将文件提交到本地仓库；<br>3.执行push操作（这一步是将本地仓库的变更提交到远程仓库）。<br><img src="/img/idea-git-push.png" alt=""><br>如果在第2步，最后点的“Commit”按钮，那么可以通过右键-&gt;Git-&gt;Repository-&gt;Push来执行Push操作。</p><h2 id="从远程仓库更新代码"><a href="#从远程仓库更新代码" class="headerlink" title="从远程仓库更新代码"></a>从远程仓库更新代码</h2><p>右键Git-Repository-Pull即可。</p><p>注意：如果有多个分支，注意选择对应的分支更新。<br><img src="/img/idea-git-pull-choose-branch.png" alt=""></p><h2 id="查看提交历史记录"><a href="#查看提交历史记录" class="headerlink" title="查看提交历史记录"></a>查看提交历史记录</h2><p>右键Git-&gt;Show History。<br>注意：所有pull/push操作都是可以针对某个目录或文件的。</p><h2 id="git冲突解决"><a href="#git冲突解决" class="headerlink" title="git冲突解决"></a>git冲突解决</h2><p>如果本地修改了某个文件，此时从远程仓库更新会提示冲突。<br>解决方法有2种：<br>1.执行commit，然后push操作，这时会提示你有冲突（会弹出一个提示窗口，可以选择Merge），Merge即可；</p><p>2.如果代码未开发完，此时还不想提交。可以执行Git-&gt;Repository-Stash Changes（此操作会将你的本地变更保存起来）起一个名字，然后执行pull操作。<br>此时更新操作会成功，然后执行Git-&gt;Repository-Unstash Changes，选择刚刚Stash Changes起的名字，此时会提示代码有冲突。会弹出Merge窗口，执行Merge操作即可。</p><p>注意：执行此操作后Merge后的文件只是在本地，需要执行Git Commit&amp;Push来提交到远程仓库。</p><p>参考：<a href="https://blog.csdn.net/qq_33039699/article/details/82866785">https://blog.csdn.net/qq_33039699/article/details/82866785</a></p><h2 id="Checkout某个分支-Tag-某次提交"><a href="#Checkout某个分支-Tag-某次提交" class="headerlink" title="Checkout某个分支/Tag/某次提交"></a>Checkout某个分支/Tag/某次提交</h2><p><strong>1.checkout某个分支</strong><br>一般开发中都会有Master/Develop/feature/fix等等分支，checkout某个分支很简单。<br>在idea右下角显示的是当前的分支，点击当前显示的分支，然后选择当前项目的要切换的分支，选择Checkout即可。<br><img src="/img/idea-checkout-branch.png" alt=""></p><p><strong>2.checkout某个Tag</strong><br>在idea右下角显示的是当前的分支，点击当前显示的分支，然后点“Checkout Tag or Revision”，然后输入Tag即可。<br><img src="/img/git-checkout-tag.png" alt=""></p><p><strong>3.checkout某次提交</strong><br>a. Git-&gt;Show History，找到你想checkout的某次提交；<br>b. 右键，选择“Copy Revision Number”；<br><img src="/img/idea-git-copy-revision-number.png" alt=""><br>c. 点击在idea右下角的当前显示的分支，然后选择“Checkout Tag or Revision”，然后粘贴刚刚复制的Revision Number即可。</p><p>注意：如果已经checkout了某个分支，比如feature，你切换到其他分支，比如develop，此时想切到feature，那么选择的是“local branch”，然后点“checkout”。<br><img src="/img/git-checkout-exist-local-branch.png" alt=""></p><h2 id="合并分支"><a href="#合并分支" class="headerlink" title="合并分支"></a>合并分支</h2><p>比如我们在Develop分支开发，在上线后需要将Develop分支合并到Master分支。</p><p>1.checkout master分支；<br>2.点击要Merge的项目的Remote Branches，选择要合并的分支（这里是Develop），然后选择“Merge into current”。<br><img src="/img/idea-git-merge-branch.png" alt=""></p><h2 id="创建-搜索-删除Tag"><a href="#创建-搜索-删除Tag" class="headerlink" title="创建/搜索/删除Tag"></a>创建/搜索/删除Tag</h2><p><strong>创建Tag</strong><br>1.Git-&gt;Show History。<br>2.选择要打tag的某次提交，然后右键New Tag，然后输入Tag的名字。名字最好有意义，可以是版本号。这里只是测试，输入的名字为testtag2<br><img src="/img/idea-git-create-tag-1.png" alt=""><br>3.push到远程仓库。项目右键Git-&gt;Repository-Push。注意要勾选“Push Tags”，另外注意一下All和Current Branch的区别。<br><img src="/img/idea-git-create-tag-2.png" alt=""><br>All和Current Branch的区别：<br><img src="/img/idea-git-push-tags.png" alt=""><br>也就是说，如果你选择All，不属于当前选择分支的tag也会提交到远程仓库；如果你选择Current Branch，那么就只会提交当前分支的Tag。</p><p><strong>搜索Tag</strong><br>在Git-&gt;Show History中，点击查找按钮，然后输入Tag名字即可，回车后即跳转到创建Tag的某次提交记录。<br><img src="/img/idea-git-search-tags.png" alt=""></p><p><strong>删除Tag</strong><br>1.查找到Tag对应的提交记录；<br>2.右键-&gt;Tag xx-&gt;delete<br><img src="/img/idea-git-delete-tag.png" alt=""><br>3.在删除本地的Tag后，会有提示框，点击“Delete On Remote”来删除远程参考的Tag。<br><img src="/img/idea-git-delete-remote-tag.png" alt=""></p><h2 id="创建-删除分支"><a href="#创建-删除分支" class="headerlink" title="创建/删除分支"></a>创建/删除分支</h2><p><strong>创建分支</strong><br>1.Git-&gt;Show History。<br>2.选择要创建分支的某次提交记录。<br>3.右键New branch，然后输入名字。<br><img src="/img/idea-git-create-branch-1.png" alt=""></p><p>此时，分支只是在本地创建好了。修改代码，然后提交到远程仓库在远程参考创建分支。<br><img src="/img/idea-create-branch-2.png" alt=""></p><p><strong>删除分支</strong><br>1.Git-&gt;Show History。<br>2.搜索要删除的分支；<br>3.右键选择Branch XXX -&gt; Delete。此时idea询问是否删除远程的branch，选择是，这样远程参考的分支就删除了。<br><img src="/img/idea-git-delete-branch.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Web推送技术之comet4j使用</title>
      <link href="/2017/08/31/Web-push-comet4j/"/>
      <url>/2017/08/31/Web-push-comet4j/</url>
      
        <content type="html"><![CDATA[<h3 id="Web推送技术之comet4j使用"><a href="#Web推送技术之comet4j使用" class="headerlink" title="Web推送技术之comet4j使用"></a>Web推送技术之comet4j使用</h3><p>参考：<a href="http://blog.csdn.net/majian_1987/article/details/8489738">[comet4j开发指南]</a>、<a href="http://blog.csdn.net/majian_1987/article/details/8489661">[comet4j使用Demo]</a>、<a href="http://www.07net01.com/2016/01/1098211.html">[“服务器推”技术之使用HTTP长轮询的Comet]</a></p><p>JAR包为comet4j-tomcat7.jar，可以百度搜索，从CSDN下载。<br>还有一个js文件comet4j.js，同样可以从CSDN下载。<br>使用参考上面2篇文章就OK了，使用还比较简单。<br>comet4j-tomcat7.jar适用tomcat7和tomcat8.0.28，试验tomcat8.5.6报错了。  </p><blockquote><p>ClassNotFoundException: org.apache.catalina.comet.CometProcessor  </p></blockquote><p>在tomcat_home/lib目录中的catalinar.jar确实没有找到这个类，tomcat8.0.28版本是有的。<br><a id="more"></a><br><img src="http://omh46px9n.bkt.clouddn.com/17-3-10/28864116-file_1489131302675_1ec4.gif" alt=""><br>可以看到消息数量是在变化的，但Network标签并没有产生新的请求，总共就2个请求，一个是刚进入页面时对服务器建立连接，第二个连接则是通信的。也就是说，在建立连接后，一直用的同一个连接进行的通信。  </p><p>demo参见：云笔记IT Tchnology/性能优化/《Web推送技术之comet4j使用（实践）demo》<br>另外，源代码可以在<a href="https://git.oschina.net/">git@osc</a>查看。</p><p>websocket与comet4j性能对比：<a href="http://chenkangxian.iteye.com/blog/2268133">websocket与comet4j性能对比</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 推送技术 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring boot+mybatis分页配置</title>
      <link href="/2017/08/31/spring%20boot%20mybatis+%E5%88%86%E9%A1%B5%E9%85%8D%E7%BD%AE/"/>
      <url>/2017/08/31/spring%20boot%20mybatis+%E5%88%86%E9%A1%B5%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>mybatis和分页插件的依赖配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis分页插件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>application.yml配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">#mapper-locations: classpath:/mybatis/mysql/*Mapper.xml</span><br><span class="line">#type-aliases-package: com.ybf.activity.web.entity</span><br><span class="line">config-location: classpath:/mybatis/mybatis-config.xml</span><br><span class="line">check-config-location: true</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>mybatis-config.xml配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.ybf.activity.web.entity.Student"</span> <span class="attr">alias</span>=<span class="string">"Student"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis分页插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.github.pagehelper.PageHelper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dialect"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"offsetAsPageNum"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"rowBoundsWithCount"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pageSizeZero"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"reasonable"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportMethodsArguments"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"returnPageInfo"</span> <span class="attr">value</span>=<span class="string">"none"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis/mapper/mysql/StudentMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring启动类增加Mapper扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/7/6.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// Mapper扫描</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.ybf.activity.web.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(WebApplication.class);</span><br><span class="line">    <span class="comment">// 编码过滤器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Filter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"==========初始化编码过滤器================="</span>);</span><br><span class="line">        CharacterEncodingFilter filter = <span class="keyword">new</span> CharacterEncodingFilter();</span><br><span class="line">        filter.setEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        filter.setForceEncoding(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebApplication.class,args);</span><br><span class="line">        logger.info(<span class="string">"Application [activity-web] started!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Mapper接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span></span>&#123;</span><br><span class="line">    <span class="function">Student <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Student&gt; <span class="title">sel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>StudentMapper.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.ybf.activity.web.mapper.StudentMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"stuMap"</span> <span class="attr">type</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sumScore"</span> <span class="attr">column</span>=<span class="string">"score_sum"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"avgScore"</span> <span class="attr">column</span>=<span class="string">"score_avg"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getById"</span> <span class="attr">resultMap</span>=<span class="string">"stuMap"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM STUDENT a</span><br><span class="line">        WHERE ID = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"sel"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span> <span class="attr">resultMap</span>=<span class="string">"stuMap"</span>&gt;</span></span><br><span class="line">        select * from student a</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>用法：<br>在查询之前使用PageHelper.startPage()设置分页。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentMapper sm;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/student/page/&#123;pageNo&#125;"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">getStduentByPage</span><span class="params">(@PathVariable <span class="keyword">int</span> pageNo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pageNo &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            PageHelper.startPage(pageNo,<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> sm.selectByCondition();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注：测试的spring boot版本为1.5.4.RELEASE.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring boot+mybatis分页配置</title>
      <link href="/2017/08/31/spring-boot-mybatis-pagination/"/>
      <url>/2017/08/31/spring-boot-mybatis-pagination/</url>
      
        <content type="html"><![CDATA[<p>mybatis和分页插件的依赖配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mybatis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis分页插件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>application.yml配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mybatis:</span><br><span class="line">#mapper-locations: classpath:/mybatis/mysql/*Mapper.xml</span><br><span class="line">#type-aliases-package: com.ybf.activity.web.entity</span><br><span class="line">config-location: classpath:/mybatis/mybatis-config.xml</span><br><span class="line">check-config-location: true</span><br></pre></td></tr></table></figure></p><a id="more"></a><p>mybatis-config.xml配置：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">"logImpl"</span> <span class="attr">value</span>=<span class="string">"LOG4J"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">typeAlias</span> <span class="attr">type</span>=<span class="string">"com.ybf.activity.web.entity.Student"</span> <span class="attr">alias</span>=<span class="string">"Student"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--mybatis分页插件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">interceptor</span>=<span class="string">"com.github.pagehelper.PageHelper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dialect"</span> <span class="attr">value</span>=<span class="string">"mysql"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"offsetAsPageNum"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"rowBoundsWithCount"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"pageSizeZero"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"reasonable"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportMethodsArguments"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"returnPageInfo"</span> <span class="attr">value</span>=<span class="string">"none"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">"mybatis/mapper/mysql/StudentMapper.xml"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring启动类增加Mapper扫描：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/7/6.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// Mapper扫描</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.ybf.activity.web.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebApplication</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(WebApplication.class);</span><br><span class="line">    <span class="comment">// 编码过滤器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">Filter <span class="title">characterEncodingFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"==========初始化编码过滤器================="</span>);</span><br><span class="line">        CharacterEncodingFilter filter = <span class="keyword">new</span> CharacterEncodingFilter();</span><br><span class="line">        filter.setEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        filter.setForceEncoding(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> filter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WebApplication.class,args);</span><br><span class="line">        logger.info(<span class="string">"Application [activity-web] started!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Mapper接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span></span>&#123;</span><br><span class="line">    <span class="function">Student <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span></span>;</span><br><span class="line">    <span class="function">List&lt;Student&gt; <span class="title">sel</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>StudentMapper.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.ybf.activity.web.mapper.StudentMapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"stuMap"</span> <span class="attr">type</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"sumScore"</span> <span class="attr">column</span>=<span class="string">"score_sum"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"avgScore"</span> <span class="attr">column</span>=<span class="string">"score_avg"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"age"</span> <span class="attr">column</span>=<span class="string">"age"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getById"</span> <span class="attr">resultMap</span>=<span class="string">"stuMap"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM STUDENT a</span><br><span class="line">        WHERE ID = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"sel"</span> <span class="attr">resultType</span>=<span class="string">"Student"</span> <span class="attr">resultMap</span>=<span class="string">"stuMap"</span>&gt;</span></span><br><span class="line">        select * from student a</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>用法：<br>在查询之前使用PageHelper.startPage()设置分页。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentMapper sm;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/student/page/&#123;pageNo&#125;"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">getStduentByPage</span><span class="params">(@PathVariable <span class="keyword">int</span> pageNo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (pageNo &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            PageHelper.startPage(pageNo,<span class="number">3</span>);</span><br><span class="line">            <span class="keyword">return</span> sm.selectByCondition();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注：测试的spring boot版本为1.5.4.RELEASE.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
            <tag> mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot利用swagger构建api文档</title>
      <link href="/2017/08/31/springboot-use-swagger-to-build-api-docs/"/>
      <url>/2017/08/31/springboot-use-swagger-to-build-api-docs/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote><p>Swagger 是一款RESTFUL接口的文档在线自动生成+功能测试功能软件。本文简单介绍了在项目中集成swagger的方法和一些常见问题。如果想深入分析项目源码，了解更多内容，见参考资料。</p></blockquote><blockquote><p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。总体目标是使客户端和文件系统作为服务器以同样的速度来更新。文件的方法，参数和模型紧密集成到服务器端的代码，允许API来始终保持同步。Swagger 让部署管理和使用功能强大的API从未如此简单。</p></blockquote><h3 id="添加swagger依赖"><a href="#添加swagger依赖" class="headerlink" title="添加swagger依赖"></a>添加swagger依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="添加swagger配置"><a href="#添加swagger配置" class="headerlink" title="添加swagger配置"></a>添加swagger配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.ybf.activity.web.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"springboot利用swagger构建api文档"</span>)</span><br><span class="line">                .description(<span class="string">"简单优雅的restful风格，http://luckystar88.github.io/"</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">"http://luckystar88.github.io/"</span>)</span><br><span class="line">                .version(<span class="string">"1.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意spring boot的包结构，否则会导致配置无效。示例程序的包结构：<br>com.ybf.activity.web|<br>———————-|config<br>—————————–Swagger2.java<br>———————-Application.java  </p><h3 id="在接口方法上使用注解添加描述信息"><a href="#在接口方法上使用注解添加描述信息" class="headerlink" title="在接口方法上使用注解添加描述信息"></a>在接口方法上使用注解添加描述信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"用户某个用户的信息"</span>,notes = <span class="string">"根据用户id获取用户详细信息"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>,value = <span class="string">"用户id"</span>,required = <span class="keyword">true</span>,dataType = <span class="string">"int"</span>,paramType = <span class="string">"path"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student/&#123;id&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Student <span class="title">student</span><span class="params">(@PathVariable <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> studentMapper.getById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"获取用户信息（分页）"</span>,notes = <span class="string">"根据传入的页数获取用户信息"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name=<span class="string">"pageNo"</span>,value = <span class="string">"页数"</span>,required = <span class="keyword">true</span>,dataType = <span class="string">"int"</span>,paramType = <span class="string">"path"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student/page/&#123;pageNo&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">selectStudentByPage</span><span class="params">(@PathVariable <span class="keyword">int</span> pageNo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pageNo &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        PageHelper.startPage(pageNo,<span class="number">3</span>); <span class="comment">// 设置分页，参数1=页数，参数2=每页显示条数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> studentMapper.sel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认会对所有的方法生成API文档，如果某个方法不需要，可以添加@ApiIgnore。</p><p>启动SpringBoot程序，浏览器输入:<code>项目上下文路径/swagger-ui.html</code>就可以看到效果。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/71666664.jpg" alt=""></p><p>点击某个请求，可以查看详情：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/68950682.jpg" alt=""><br>输入参数，点击Try it out按钮可以查看响应。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/19827030.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>springboot利用swagger构建api文档</title>
      <link href="/2017/08/31/springboot%E5%88%A9%E7%94%A8swagger%E6%9E%84%E5%BB%BAapi%E6%96%87%E6%A1%A3/"/>
      <url>/2017/08/31/springboot%E5%88%A9%E7%94%A8swagger%E6%9E%84%E5%BB%BAapi%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><blockquote><p>Swagger 是一款RESTFUL接口的文档在线自动生成+功能测试功能软件。本文简单介绍了在项目中集成swagger的方法和一些常见问题。如果想深入分析项目源码，了解更多内容，见参考资料。</p></blockquote><blockquote><p>Swagger 是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。总体目标是使客户端和文件系统作为服务器以同样的速度来更新。文件的方法，参数和模型紧密集成到服务器端的代码，允许API来始终保持同步。Swagger 让部署管理和使用功能强大的API从未如此简单。</p></blockquote><h3 id="添加swagger依赖"><a href="#添加swagger依赖" class="headerlink" title="添加swagger依赖"></a>添加swagger依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="添加swagger配置"><a href="#添加swagger配置" class="headerlink" title="添加swagger配置"></a>添加swagger配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.ybf.activity.web.controller"</span>))</span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">"springboot利用swagger构建api文档"</span>)</span><br><span class="line">                .description(<span class="string">"简单优雅的restful风格，http://luckystar88.github.io/"</span>)</span><br><span class="line">                .termsOfServiceUrl(<span class="string">"http://luckystar88.github.io/"</span>)</span><br><span class="line">                .version(<span class="string">"1.0"</span>)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意spring boot的包结构，否则会导致配置无效。示例程序的包结构：<br>com.ybf.activity.web|<br>———————-|config<br>—————————–Swagger2.java<br>———————-Application.java  </p><h3 id="在接口方法上使用注解添加描述信息"><a href="#在接口方法上使用注解添加描述信息" class="headerlink" title="在接口方法上使用注解添加描述信息"></a>在接口方法上使用注解添加描述信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"用户某个用户的信息"</span>,notes = <span class="string">"根据用户id获取用户详细信息"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name = <span class="string">"id"</span>,value = <span class="string">"用户id"</span>,required = <span class="keyword">true</span>,dataType = <span class="string">"int"</span>,paramType = <span class="string">"path"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student/&#123;id&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Student <span class="title">student</span><span class="params">(@PathVariable <span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> studentMapper.getById(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ApiOperation</span>(value = <span class="string">"获取用户信息（分页）"</span>,notes = <span class="string">"根据传入的页数获取用户信息"</span>)</span><br><span class="line"><span class="meta">@ApiImplicitParam</span>(name=<span class="string">"pageNo"</span>,value = <span class="string">"页数"</span>,required = <span class="keyword">true</span>,dataType = <span class="string">"int"</span>,paramType = <span class="string">"path"</span>)</span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/student/page/&#123;pageNo&#125;"</span>,method = RequestMethod.GET)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">selectStudentByPage</span><span class="params">(@PathVariable <span class="keyword">int</span> pageNo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pageNo &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        PageHelper.startPage(pageNo,<span class="number">3</span>); <span class="comment">// 设置分页，参数1=页数，参数2=每页显示条数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> studentMapper.sel();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>默认会对所有的方法生成API文档，如果某个方法不需要，可以添加@ApiIgnore。</p><p>启动SpringBoot程序，浏览器输入:<code>项目上下文路径/swagger-ui.html</code>就可以看到效果。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/71666664.jpg" alt=""></p><p>点击某个请求，可以查看详情：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/68950682.jpg" alt=""><br>输入参数，点击Try it out按钮可以查看响应。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-12/19827030.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> springboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JS模板引擎art-template</title>
      <link href="/2017/08/31/JS-art-template/"/>
      <url>/2017/08/31/JS-art-template/</url>
      
        <content type="html"><![CDATA[<blockquote><p>art-template 是一个简约、超快的模板引擎。<br>它采用作用域预声明的技术来优化模板渲染速度，从而获得接近 JavaScript 极限的运行性能，并且同时支持 NodeJS 和浏览器。</p></blockquote><p>文档地址：<a href="https://aui.github.io/art-template/docs/index.html">https://aui.github.io/art-template/docs/index.html</a></p><p>gitHub地址：<br><a href="https://github.com/aui/art-template">https://github.com/aui/art-template</a></p><p>使用例子在github的example中有。<br><a id="more"></a></p><p>通常，在不借助模板引擎Ajax查询数据列表，需要自己手动拼写N多个tr和td。<br>比如：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="keyword">get</span>("$&#123;ctx&#125;/student/list<span class="string">",function(r) &#123;</span></span><br><span class="line"><span class="string">    if (r.returncode == 0) &#123;</span></span><br><span class="line"><span class="string">      if (r.data) &#123;</span></span><br><span class="line"><span class="string">        var t = $('#list tbody').empty();</span></span><br><span class="line"><span class="string">        for (var i=0;i&lt; r.data.length;i++) &#123;</span></span><br><span class="line"><span class="string">          var item = r.data[i];</span></span><br><span class="line"><span class="string">          var tr = "</span>&lt;tr&gt;<span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>"+ (i+1)+"<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>" + item.name + "<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>" + item.age + "<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>" + item.scoreSum+ "<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span>"+ item.scoreAvg + "<span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span>";</span></span><br><span class="line"><span class="xml">          t.append($(tr));</span></span><br><span class="line"><span class="xml">        &#125;</span></span><br><span class="line"><span class="xml">      &#125;</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">    else &#123;</span></span><br><span class="line"><span class="xml">      layer.alert(r.errmsg);</span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">&#125;);</span></span><br></pre></td></tr></table></figure></p><p>使用JS模板引起后：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> src=<span class="string">"$&#123;ctx&#125;/asset/js/art-template/template-web.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script id=<span class="string">"template"</span> type=<span class="string">"text/html"</span>&gt;</span><br><span class="line">    &#123;&#123;each data item index&#125;&#125;</span><br><span class="line">    &lt;tr&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123;index+<span class="number">1</span>&#125;&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">        &lt;td&gt;&#123;&#123;item['name']&#125;&#125;&lt;/</span>td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123;item[<span class="string">'age'</span>]&#125;&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">        &lt;td&gt;&#123;&#123;item['score_sum']&#125;&#125;&lt;/</span>td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123;item[<span class="string">'score_avg'</span>]&#125;&#125;&lt;<span class="regexp">/td&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>tr&gt;</span><br><span class="line">    &#123;&#123;/each&#125;&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 获取模板内容字符串</span></span><br><span class="line"><span class="regexp">var templateHtml = $('#template').html();</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 编译模板</span></span><br><span class="line"><span class="regexp">var render = template.compile(templateHtml);</span></span><br><span class="line"><span class="regexp">$('#queryAll').click(function () &#123;</span></span><br><span class="line"><span class="regexp">    $.get("$&#123;ctx&#125;/</span>student/list<span class="string">", function (r) &#123;</span></span><br><span class="line"><span class="string">        if (r.returncode == 0) &#123;</span></span><br><span class="line"><span class="string">            if (r.data) &#123;</span></span><br><span class="line"><span class="string">                // 渲染模板</span></span><br><span class="line"><span class="string">                var html = render(r);</span></span><br><span class="line"><span class="string">                $('#list tbody').html(html);</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        else &#123;</span></span><br><span class="line"><span class="string">            layer.alert(r.errmsg);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">&#125;);</span></span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Oracle存储过程导出结果到文本文件</title>
      <link href="/2017/08/30/Oracle-procedure-to-files/"/>
      <url>/2017/08/30/Oracle-procedure-to-files/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在存储过程中，我们经常会使用dbms_output来输出一些调试信息到控制台，方便查看。在使用PLSQL DEV的过程中，经常会遇到缓冲区太小的情况，如果你要显示的内容比较多的话。这个时候我们可以使用oracle提供的UTL_FILE包来实现将这些信息输出到一个文本文件中。</p><h2 id="操作说明"><a href="#操作说明" class="headerlink" title="操作说明"></a>操作说明</h2><h3 id="创建一个目录（需要管理员权限）"><a href="#创建一个目录（需要管理员权限）" class="headerlink" title="创建一个目录（需要管理员权限）"></a>创建一个目录（需要管理员权限）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">directory</span> MY_DIR <span class="keyword">as</span> <span class="string">'D:/MY_DIR/'</span>;</span><br></pre></td></tr></table></figure><p>注意：这里创建的目录是创建在oracle服务器上，在执行上述SQL后，需要手动建立相关目录，否则使用时会报错。<br><a id="more"></a></p><h3 id="授权给使用存储过程的用户"><a href="#授权给使用存储过程的用户" class="headerlink" title="授权给使用存储过程的用户"></a>授权给使用存储过程的用户</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">grant</span> <span class="keyword">read</span>,write <span class="keyword">on</span> <span class="keyword">directory</span> MY_DIR <span class="keyword">to</span> hhlydev;</span><br></pre></td></tr></table></figure><h3 id="存储过程中使用"><a href="#存储过程中使用" class="headerlink" title="存储过程中使用"></a>存储过程中使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> <span class="keyword">replace</span> <span class="keyword">procedure</span> p_file_test <span class="keyword">is</span></span><br><span class="line">    v_file            UTL_FILE.file_type;</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="comment">--打开文件</span></span><br><span class="line">    v_file := UTL_FILE.FOPEN(<span class="string">'MY_DIR'</span>, <span class="string">'test.txt'</span>, <span class="string">'w'</span>);</span><br><span class="line">    <span class="comment">--写入内容</span></span><br><span class="line">    UTL_FILE.put_line(v_file, '开始写入SQL脚本...');</span><br><span class="line">    UTL_FILE.put_line(export_handle, '脚本写入结束...');</span><br><span class="line">    <span class="comment">--最后关闭文件</span></span><br><span class="line">    UTL_FILE.FCLOSE(export_handle);</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数据库 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis安装+Sentinel模式配置</title>
      <link href="/2017/08/30/Redis-Sentinel/"/>
      <url>/2017/08/30/Redis-Sentinel/</url>
      
        <content type="html"><![CDATA[<p>系统：ubuntu</p><h2 id="一、安装redis"><a href="#一、安装redis" class="headerlink" title="一、安装redis"></a>一、安装redis</h2><p>tip:redis这里下载在usr/local/src/<br>安装到usr/local/redis目录</p><p>1)进入文件夹usr/local/src<br>cd /usr/local/src</p><p>2)下载redis2.8.9.tar.gz<br>wget <a href="http://download.redis.io/releases/redis-2.8.9.tar.gz">http://download.redis.io/releases/redis-2.8.9.tar.gz</a></p><p>3)解压缩<br>tar -zxvf redis-2.8.9.tar.gz<br><a id="more"></a><br>4)建立一个链接<br>ln -s redis-2.8.9 redis<br>这样使用cd redis就可以进入redis2.8.9这个文件夹了。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/97398837.jpg" alt=""><br>5)创建文件夹usr/local/redis<br>mkdir usr/local/redis</p><p>6)安装到usr/local/redis目录<br>make PREFIX=/usr/local/redis/ install</p><h2 id="二、sentinel模式配置"><a href="#二、sentinel模式配置" class="headerlink" title="二、sentinel模式配置"></a>二、sentinel模式配置</h2><p>说明配置：<br>有2台虚拟机，IP分别为192.168.25.129,192.168.25.130<br>192.168.25.129配置:<br>6379:主服务器<br>6380:从服务器</p><p>192.168.25.130配置：<br>6379:从服务器<br>6380:从服务器<br>也就是192.168.25.129的6379端口作为主服务器，其他几个作为从服务器。</p><p>2个redis实例分别有2个哨兵监控master。</p><p>在usr/local/src/redis中创建目录conf<br>将redis.conf和sentinel.conf复制进去。<br>mkdir conf<br>cp redis.conf ./conf<br>cp sentinel.conf ./conf</p><p>redis.conf重命名为redis6379.conf（或者上面复制的时候使用cp redis.conf ./conf/redis6379.conf）<br>mv redis.conf redis6379.conf</p><p>redis6379.conf改动如下：<br>只要修改如下几行<br>pidfile /var/run/redis_6379.pid<br>port 6379<br>logfile /var/log/redis_6379.log<br>dbfilename dump_6379.rdb<br>重新复制一份重命名为redis6380.conf，改动同redis6379.conf，将相应的6379改成6380即可。</p><p>sentinel.conf删除全部内容，粘贴如下内容：<br>port 26379<br>dir “/home/smith/log/redis/sentinels/26379”<br>sentinel monitor mymaster 192.168.25.12963791<br>sentinel down-after-milliseconds mymaster 30000<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000</p><p>192.168.25.130的配置同192.168.25.129。</p><p>部署：<br>1）启动192.168.25.129的6379端口；<br>redis-server ../conf/redis6379.conf</p><p>2）启动192.168.25.129的6380端口；<br>redis-server ../conf/redis6380.conf</p><p>3）将192.168.25.129的638端口作为从服务器；<br>redis-cli -p 6380 slaveof 192.168.25.1296379</p><p>4）启动哨兵监控master（在129执行）<br>redis-server ../conf/sentinel.conf –sentinel</p><p>5）启动192.168.25.130的6379端口；<br>redis-server ../conf/redis6379.conf</p><p>6）启动192.168.25.130的6380端口；<br>redis-server ../conf/redis6380.conf</p><p>6）将192.168.25.130的6379端口设置为从服务器；<br>redis-cli -p 6379 slaveof 192.168.25.1296379</p><p>7）将192.168.25.130的6380端口设置为从服务器；<br>redis-cli -p 6380 slaveof 192.168.25.1296379</p><p>8）启动哨兵监控master（在130执行）<br>redis-server ../conf/sentinel.conf –sentinel</p><p>查看master有几个从服务器<br>在master机器执行如下命令：<br>redis-cli -p 6379 info replication<br>显示如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/92424052.jpg" alt=""><br>可以看到有3个从服务器。<br>哨兵监控信息显示如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/11235169.jpg" alt=""><br>模拟master故障<br>在192.168.25.129执行：<br>redis-cli -p 6379 shutdown<br>哨兵会从从服务器中选择一台来作为主服务器。<br>原来的主服务器重新启动后，会被当做新服务器的从服务器，如下：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/41417269.jpg" alt=""><br>参考：<a href="http://my.oschina.net/guol/blog/182272">http://my.oschina.net/guol/blog/182272</a></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ELK搭建手册</title>
      <link href="/2017/08/30/ELK-use/"/>
      <url>/2017/08/30/ELK-use/</url>
      
        <content type="html"><![CDATA[<p>参考:<br><a href="https://my.oschina.net/itblog/blog/547250?p=2&amp;temp=1503478503046#blog-comments-list">https://my.oschina.net/itblog/blog/547250?p=2&amp;temp=1503478503046#blog-comments-list</a></p><p>head插件安装参考：<br><a href="https://wenku.baidu.com/view/1c61ece6162ded630b1c59eef8c75fbfc77d94e5.html">https://wenku.baidu.com/view/1c61ece6162ded630b1c59eef8c75fbfc77d94e5.html</a></p><p>说明：测试机器为192.168.74.125.</p><h2 id="下载软件"><a href="#下载软件" class="headerlink" title="下载软件"></a>下载软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">elasticsearch-5.5.0.tar.gz</span><br><span class="line">logstash-5.5.2.tar.gz</span><br><span class="line">kibana-5.5.0-linux-x86_64.tar.gz</span><br></pre></td></tr></table></figure><p>下载地址：<a href="https://www.elastic.co/downloads">https://www.elastic.co/downloads</a><br>下载速度较慢，可以使用香港网络下载。<br>软件下载的位置：/data/soft<br><a id="more"></a></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="1、安装并配置JAVA环境变量"><a href="#1、安装并配置JAVA环境变量" class="headerlink" title="1、安装并配置JAVA环境变量"></a>1、安装并配置JAVA环境变量</h3><h4 id="1、安装JDK"><a href="#1、安装JDK" class="headerlink" title="1、安装JDK"></a>1、安装JDK</h4><p>ES要求JDK版本至少1.8.<br>从oracle网站下载jdk-8u144-linux-x64.tar.gz。<br>下载完毕后，使用tar –zxvf jdk-8u144-linux-x64.tar.gz –C /usr/java，将JDK解压到/usr/java。<br>解压后得到：/usr/java/jdk1.8.0_144</p><h4 id="2、配置环境变量"><a href="#2、配置环境变量" class="headerlink" title="2、配置环境变量"></a>2、配置环境变量</h4><p><code>vi /etc/profile</code>，在文件末尾添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/java/jdk1.8.0_144</span><br><span class="line">export CLASSPATH=$&#123;JAVA_HOME&#125;/lib/dt.jar:$&#123;JAVA_HOME&#125;/lib/tools.jar</span><br><span class="line">export PATH=$&#123;PATH&#125;:$&#123;JAVA_HOME&#125;/bin</span><br></pre></td></tr></table></figure></p><p>然后:wq保存文件。</p><p>然后执行source /etc/profile使环境变量生效。<br>最后用<code>java –version</code>来验证一下。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/72442033.jpg" alt=""></p><h3 id="安装ElasticSearch"><a href="#安装ElasticSearch" class="headerlink" title="安装ElasticSearch"></a>安装ElasticSearch</h3><p>在/data/soft目录，执行tar –zxvf elasticsearch-5.5.0.tar.gz解压缩es。<br>    由于es不能使用root用户运行，所以这里创建用户组bd和用户bd，密码为test123456<br>    步骤如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">groupadd bd</span><br><span class="line">useradd bd</span><br><span class="line">passwd bd</span><br></pre></td></tr></table></figure></p><p>然后输入密码test123456<br>然后将/data/soft/elasticsearch-5.5.0的拥有者改为bd。<br>进入/data/soft，执行sudo chown -R bd:bd ./elasticsearch-5.5.0。</p><p>修改es的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cd $ES_HOME$/config，vi elasticsearch.yml打开配置文件。</span><br><span class="line">cluster.name: es-cluster</span><br><span class="line">path.data: /tmp/es/data</span><br><span class="line">path.logs: /tmp/es/logs</span><br><span class="line"># ----------------------------------- Memory -----------------------------------</span><br><span class="line">#</span><br><span class="line"># Lock the memory on startup:</span><br><span class="line">#</span><br><span class="line">bootstrap.memory_lock: false</span><br><span class="line">bootstrap.system_call_filter: false</span><br><span class="line"></span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line"></span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure></p><p>启动es<br><code>./bin/elasticsearch &amp;</code></p><p>在浏览器打开：<a href="http://192.168.74.125:9200/">http://192.168.74.125:9200/</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/40386725.jpg" alt=""><br>如果可以看到上图则es安装成功。</p><h3 id="安装head插件"><a href="#安装head插件" class="headerlink" title="安装head插件"></a>安装head插件</h3><p>Es5.0的head插件安装还是很麻烦的，具体可以参考：<br><a href="https://wenku.baidu.com/view/1c61ece6162ded630b1c59eef8c75fbfc77d94e5.html">https://wenku.baidu.com/view/1c61ece6162ded630b1c59eef8c75fbfc77d94e5.html</a></p><p>a.  安装git<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum –y install git</span><br></pre></td></tr></table></figure></p><p>安装完毕后，就可以下载Head的源代码了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git://github.com/mobz/elasticsearch-head.git</span><br></pre></td></tr></table></figure></p><p>注：这里我们仍然下载的/data/soft目录。</p><p>b.  安装node<br>由于head插件本质上还是一个nodejs工程，因此需要安装node，使用npm来安装依赖的包。<br>去官网下载nodejs，<a href="https://nodejs.org/en/download/">https://nodejs.org/en/download/</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/20009097.jpg" alt=""></p><p>下载下来的jar包是xz格式的，一般的linux可能不识别，还需要安装xz.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install xz</span><br></pre></td></tr></table></figure></p><p>然后解压nodejs的安装包:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xz -d node*.tar.xz </span><br><span class="line">tar -xvf node*.tar  -C /user/node</span><br></pre></td></tr></table></figure></p><p>解压完node的安装文件后，需要配置下环境变量,编辑/etc/profile，添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NODE_HOME=/usr/node/node-v6.11.2-linux-x64</span><br><span class="line">export PATH=$&#123;PATH&#125;:$&#123;NODE_HOME&#125;/bin</span><br></pre></td></tr></table></figure></p><p>别忘记立即执行以下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure></p><p>这个时候可以测试一下node是否生效：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/41604612.jpg" alt=""></p><p>注意：npm安装插件，经常受网络影响，无法下载<br>受网络影响建议安装cnpm（淘宝团队建立的中国镜像）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install cnpm -g --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure></p><p>c.  安装grunt<br>grunt是一个很方便的构建工具，可以进行打包压缩、测试、执行等等的工作，5.0里的head插件就是通过grunt启动的。因此需要安装一下grunt。<br>安装grunt-cli<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install –g grunt-cli</span><br></pre></td></tr></table></figure></p><p>安装完毕后，检查一下：</p><p>注意：如果安装报错，到/usr/node/ node-v6.11.2-linux-x64目录执行上述命令。  </p><p>d.  修改head源码<br>修改服务器监听地址：<br>目录：elasticsearch-head/Gruntfile.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">connect:</span><br><span class="line"> &#123;     server:</span><br><span class="line">    &#123;     options:</span><br><span class="line">      &#123;     </span><br><span class="line">        port:9100,</span><br><span class="line">        hostname: &apos;*&apos;, </span><br><span class="line">        base: &apos;.&apos;,                                                       </span><br><span class="line">        keepalive:true </span><br><span class="line">      &#125; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>增加hostname属性，设置为*</p><p>修改连接地址：<br>目录：elasticsearch-head/_site/app.js<br>修改head的连接地址:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.base_uri = this.config.base_uri || this.prefs.get(&quot;app-base_uri&quot;) || &quot;http://localhost:9200&quot;;</span><br></pre></td></tr></table></figure></p><p>把localhost修改成你es的服务器地址，如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.base_uri = this.config.base_uri || this.prefs.get(&quot;app-base_uri&quot;) || &quot;http://10.10.10.10:9200&quot;;</span><br></pre></td></tr></table></figure></p><p>e.  运行head插件<br>首先运行es。<br>然后在head目录中，执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install 下载以来的包</span><br></pre></td></tr></table></figure></p><p>最后，启动nodejs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grunt server</span><br></pre></td></tr></table></figure></p><p>这个时候访问192.168.74.125:9100就可以访问Head插件了。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/54650006.jpg" alt=""></p><h3 id="安装logstash"><a href="#安装logstash" class="headerlink" title="安装logstash"></a>安装logstash</h3><p>执行<code>tar –zxvf logstash-5.5.2.tar.gz</code>解压缩logstash。<br>进入config目录，新增log4j_to_es.conf文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /data/soft/logstash-5.5.2/config</span><br></pre></td></tr></table></figure></p><p>文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># For detail structure of this file</span><br><span class="line"># Set: https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html</span><br><span class="line">input &#123;</span><br><span class="line">  # For detail config for log4j as input,</span><br><span class="line">  # See: https://www.elastic.co/guide/en/logstash/current/plugins-inputs-log4j.html</span><br><span class="line">  log4j &#123;</span><br><span class="line">    mode =&gt; &quot;server&quot;</span><br><span class="line">    host =&gt; &quot;0.0.0.0&quot;</span><br><span class="line">    port =&gt; 4567</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line">  #Only matched data are send to output.</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">  # For detail config for elasticsearch as output,</span><br><span class="line">  # See: https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    action =&gt; &quot;index&quot;          #The operation on ES</span><br><span class="line">    hosts  =&gt; &quot;192.168.74.125:9200&quot;   #ElasticSearch host, can be array.</span><br><span class="line">    index  =&gt; &quot;applog&quot;         #The index to write data to.</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这里的配置说明可以参考：<a href="https://my.oschina.net/itblog/blog/547250?p=2&amp;temp=1503478503046#blog-comments-list">https://my.oschina.net/itblog/blog/547250?p=2&amp;temp=1503478503046#blog-comments-list</a></p><p>最后使用<code>./bin/logstash –f ./config/log4j_to_es.conf</code>来启动logstash。</p><p>接下来创建一个示例工程，演示使用将log4j日志输出到logstash。<br>新建一个elk-demo的maven工程，<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/51022829.jpg" alt=""></p><p>Maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>Log4j配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">log4j.rootLogger=INFO,console</span><br><span class="line"></span><br><span class="line"># for package com.tommy.elk, log would be sent to socket appender.</span><br><span class="line">log4j.logger.com.tommy.elk=DEBUG, socket</span><br><span class="line"></span><br><span class="line"># appender socket</span><br><span class="line">log4j.appender.socket=org.apache.log4j.net.SocketAppender</span><br><span class="line">log4j.appender.socket.Port=4567</span><br><span class="line">log4j.appender.socket.RemoteHost=192.168.74.125</span><br><span class="line">log4j.appender.socket.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.socket.layout.ConversionPattern=%d [%-5p] [%l] %m%n</span><br><span class="line">log4j.appender.socket.ReconnectionDelay=10000</span><br><span class="line"></span><br><span class="line"># appender console</span><br><span class="line">log4j.appender.console=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.console.target=System.out</span><br><span class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.console.layout.ConversionPattern=%d [%-5p] [%l] %m%n</span><br></pre></td></tr></table></figure></p><p>可以看到log4j中指定了一个appder为socket，配置了远程的host和端口，这个就是上面在logstash中配置的。</p><p>测试代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hello world!</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = Logger.getLogger(App.class);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">( String[] args )</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        LOGGER.info( <span class="string">"Hello World!"</span> );</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"测试消息 ["</span> + i + <span class="string">"]."</span>);</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>运行一下App.java，控制台输出了log4j日志。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/87296607.jpg" alt=""></p><p>我们刷新一下head插件，在索引TAB中可以看到<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/25427804.jpg" alt=""><br>在数据浏览TAB中可以看到日志信息，点击某一个可以看到详情<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/28493917.jpg" alt=""></p><h3 id="安装Kibana"><a href="#安装Kibana" class="headerlink" title="安装Kibana"></a>安装Kibana</h3><p>执行<code>tar –zxvf kibana-5.5.0-linux-x86_64.tar.gz</code>解压缩kibana。<br>然后进入config目录，编辑kibana配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd kibana-5.5.0-linux-x86_64</span><br><span class="line">vi ./config/kibana.yml</span><br></pre></td></tr></table></figure></p><p>修改下面几项：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server.port: 5601</span><br><span class="line">server.host: “192.168.74.125”</span><br><span class="line">elasticsearch.url: http://192.168.74.125:9200</span><br><span class="line">kibana.index: “.kibana”</span><br></pre></td></tr></table></figure></p><p>然后启动kinaba.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/kibana</span><br></pre></td></tr></table></figure></p><p>启动后用浏览器打开<a href="http://192.168.74.125:5601/">http://192.168.74.125:5601/</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/65402461.jpg" alt=""></p><p>为了后续使用Kibana，需要配置至少一个Index名字或者Pattern，它用于在分析时确定ES中的Index。这里我输入之前配置的Index名字applog，Kibana会自动加载该Index下doc的field，并自动选择合适的field用于图标中的时间字段：</p><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/19469596.jpg" alt=""><br>点击Create后，可以看到左侧增加了配置的Index名字：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/20176989.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/65489446.jpg" alt=""><br>可以在上面的输入框中输入内容搜索<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/84670838.jpg" alt=""></p><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><ol><li><p>java.lang.RuntimeException: can not run elasticsearch as root<br>使用非root用户执行。<br>创建用户组bd<br>groupadd bd<br>创建用户bd,属组bd<br>useradd bd -g bd<br>给用户bd设置密码<br>passwd bd<br>(密码为test123456)</p></li><li><p>已经在/etc/profile中修改了环境变量，将java环境变量设置为了1.8，使用source /etc/profile后root用户下已生效。<br>但切换到非root用户下，仍然显示的之前的java版本。<br>解决：<a href="http://blog.csdn.net/newtelcom/article/details/49967919">http://blog.csdn.net/newtelcom/article/details/49967919</a></p></li><li><p>启动es时，提示无权限<br>java.nio.file.AccessDeniedException: /data/soft/elasticsearch-5.5.0/config/elasticsearch.yml<br>解决：<br>改变elasticsearch文件夹所有者到当前用户<br>sudo chown -R 非root用户组:非root用户 elasticsearch<br>比如问题1中添加的用户组bd和用户bd.<br>sudo chown -R bd:bd elasticsearch</p></li><li><p>提示数据目录或日志目录无权限<br>java.nio.file.AccessDeniedException: /tmp/es/data/nodes<br>解决：参考3.将/tmp/es目录所有者设置为bd.<br>sudo chown -R bd:bd es</p></li><li><p>seccomp unavailable: requires kernel 3.5+ with CONFIG_SECCOMP and CONFIG_SECCOMP_FILTER compiled in<br>报了一大串错误，其实只是一个警告。<br>解决：使用心得linux版本，就不会出现此类问题了。</p></li><li><p>max file descriptors [4096] for elasticsearch process likely too low, increase to at least [65536]<br>max number of threads [1024] for user [lishang] likely too low, increase to at least [2048]<br>解决：切换到root用户，编辑limits.conf 添加类似如下内容<br>vi /etc/security/limits.conf<br>添加如下内容:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* soft nofile 65536</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 2048</span><br><span class="line">* hard nproc 4096</span><br></pre></td></tr></table></figure></li><li><p>max number of threads [1024] for user [lish] likely too low, increase to at least [2048]<br>解决：切换到root用户，进入limits.d目录下修改配置文件。<br>vi /etc/security/limits.d/90-nproc.conf<br>修改如下内容：<br><code>* soft nproc 1024</code><br>修改为<br><code>* soft nproc 2048</code></p></li><li><p>max virtual memory areas vm.max_map_count [65530] likely too low, increase to at least [262144]<br>解决：切换到root用户修改配置sysctl.conf<br>vi /etc/sysctl.conf<br>添加下面配置：<br>vm.max_map_count=655360<br>并执行命令：<br>sysctl -p<br>然后，重新启动elasticsearch，即可启动成功。</p></li><li><p>system call filters failed to install; check the logs and fix your configuration or disable system call filters at your own risk<br>问题原因：因为Centos6不支持SecComp，而ES默认bootstrap.system_call_filter为true进行检测，所以导致检测失败，失败后直接导致ES不能启动。<br>详见 ：<a href="https://github.com/elastic/elasticsearch/issues/22899">https://github.com/elastic/elasticsearch/issues/22899</a><br>解决方法：在elasticsearch.yml中配置bootstrap.system_call_filter为false，注意要在Memory下面:<br>bootstrap.memory_lock: false<br>bootstrap.system_call_filter: false</p></li><li><p>安装head插件后，head插件访问es提示跨域问题。<br>解决：<br>在$ES_HOME$/config/elasticsearch.yml中增加下面的配置：<br>//增加新的参数，这样head插件可以访问es<br>http.cors.enabled: true<br>http.cors.allow-origin: “*”</p></li><li><p>logstash5启动方式<br>./bin/logstash -f ./config/log4j_to_es.conf  </p></li><li><p>logstash错误：Cannot assign requested address<br>将配置文件中的host改成：0.0.0.0.<br>参考：<a href="https://stackoverflow.com/questions/30624467/connect-logstash-1-5-0-with-log4j-of-several-servers">https://stackoverflow.com/questions/30624467/connect-logstash-1-5-0-with-log4j-of-several-servers</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> elk </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java通过Cookie实现sso</title>
      <link href="/2017/08/30/java-cookie-sso/"/>
      <url>/2017/08/30/java-cookie-sso/</url>
      
        <content type="html"><![CDATA[<p>学习的慕课网视频，主要使用Cookie来处理的。  </p><p>sso的流程：<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/75628331.jpg" alt=""></p><a id="more"></a><h4 id="同域的情况："><a href="#同域的情况：" class="headerlink" title="同域的情况："></a>同域的情况：</h4><p><a href="http://www.aaa.com/demo1/main.action">http://www.aaa.com/demo1/main.action</a><br><a href="http://www.aaa.com/demo2/main.action">http://www.aaa.com/demo2/main.action</a><br>Cookie的设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"sso"</span>,<span class="string">"sso_login"</span>);</span><br><span class="line">cookie.setPath(<span class="string">"/"</span>)</span><br><span class="line">response.addCookie(cookie);</span><br></pre></td></tr></table></figure></p><h4 id="同父域："><a href="#同父域：" class="headerlink" title="同父域："></a>同父域：</h4><p><a href="http://www.aaa.xx.com/demo1/main.action">http://www.aaa.xx.com/demo1/main.action</a><br><a href="http://www.bbb.xx.com/demo2/main.action">http://www.bbb.xx.com/demo2/main.action</a><br>Cookie的设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"sso"</span>,<span class="string">"sso_login"</span>);</span><br><span class="line">cookie.setDomain(<span class="string">".xx.com"</span>); <span class="comment">// 设置父域可见</span></span><br><span class="line">cookie.setPath(<span class="string">"/"</span>);</span><br></pre></td></tr></table></figure></p><h4 id="跨域："><a href="#跨域：" class="headerlink" title="跨域："></a>跨域：</h4><p><a href="http://www.aaa.com/demo1/main.action">http://www.aaa.com/demo1/main.action</a><br><a href="http://www.bbb.com/demo2/main.action">http://www.bbb.com/demo2/main.action</a><br>在demo1和demo2工程都有addCookie方法，该方法的代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCookie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Cookie cookie = <span class="keyword">new</span> Cookie(<span class="string">"sso"</span>,<span class="string">"sso_login"</span>);</span><br><span class="line">    cookie.setsPath(<span class="string">"/"</span>);</span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>这个方法的作用就是向本域中写入cookie.</p><p>比如现在要访问demo1，会先跳转到sso server的登录页面，在sso server端登录成功后，会重定向到demo1，在demo1中有一个hiddenUrlList，url为上面demo1和demo2的addCookie：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hidenUrlList.ad(&quot;http://www.aaa.com/demo1/addCookie.action&quot;);</span><br><span class="line">hidenUrlList.ad(&quot;http://www.bbb.com/demo2/addCookie.action&quot;);</span><br></pre></td></tr></table></figure></p><p>在demo1向浏览器展示demo1/main.action时，通过一个隐藏的IFrame将hiddenUrlList中的url执行一次，将cookie写入到dmeo1和demo2.<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;c:forEach <span class="keyword">var</span>=<span class="string">"item"</span> items=<span class="string">"$&#123;hiddenUrlList&#125;"</span>&gt;</span><br><span class="line">&lt;iframe src=<span class="string">"$&#123;item&#125; width="</span><span class="number">0</span>px<span class="string">" height="</span><span class="number">0</span>px<span class="string">" style="</span>display:none<span class="string">" /&gt;</span></span><br><span class="line"><span class="string">&lt;/c:forEach&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="SSO登录校验逻辑"><a href="#SSO登录校验逻辑" class="headerlink" title="SSO登录校验逻辑"></a>SSO登录校验逻辑</h4><p>1、 校验是否Cookie有sso;<br>2、 校验cookie名为sso的cookie是否合法。即cookie的value是否是设置的值。<br>实际使用需要考虑cookie的安全性，以及有效期。</p><p>本地测试，可以设置hosts文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1 www.aaa.com</span><br><span class="line">127.0.0.1 www.bbb.com</span><br><span class="line">127.0.0.1 www.xx.com</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> 单点登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CAS自定义登录页面</title>
      <link href="/2017/08/30/CAS-custom-login-page/"/>
      <url>/2017/08/30/CAS-custom-login-page/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="http://www.imooc.com/article/3720">http://www.imooc.com/article/3720</a><br>不过参考链接中介绍的并不详细，这里具体说明一下。</p><p>/css/下复制cas.css，并重命名为nebula.css.<br>文件内容不变，将<code>#container</code>改成如下：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#container</span> &#123;  <span class="attribute">position</span>: fixed;</span><br><span class="line">  <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">left</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">width</span>:<span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">50%</span>;</span><br><span class="line">  <span class="attribute">-webkit-transform</span>: <span class="built_in">translateX</span>(-50%) <span class="built_in">translateY</span>(-50%);</span><br><span class="line">  <span class="attribute">-moz-transform</span>: <span class="built_in">translateX</span>(-50%) <span class="built_in">translateY</span>(-50%);</span><br><span class="line">  <span class="attribute">-ms-transform</span>: <span class="built_in">translateX</span>(-50%) <span class="built_in">translateY</span>(-50%);</span><br><span class="line">  <span class="attribute">transform</span>: <span class="built_in">translateX</span>(-50%) <span class="built_in">translateY</span>(-50%); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>因为后面会把页眉和页脚的一些东西，包括右侧的banner删除，所以这里的CSS是让内容居中显示。<br><a id="more"></a></p><p><code>/WEB-INF/classes</code>下复制<code>cas_views.properties</code>，并重命名为<code>nebula_views.properties</code>.<br>并增加下面的内容（默认是空的）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nebulaLoginView.(class)=org.springframework.web.servlet.view.JstlView</span><br><span class="line">nebulaLoginView.url=/WEB-INF/view/jsp/nebula/ui/casLoginView.jsp</span><br><span class="line">nebulaIndexView.(class)=org.springframework.web.servlet.view.JstlView</span><br><span class="line">nebulaIndexView.url=/WEB-INF/view/jsp/nebula/ui/casIndexView.jsp</span><br></pre></td></tr></table></figure></p><p><code>/WEB-INF/classes</code>下复制<code>cas-theme-default.properties</code>，并重命名为<code>nebula-theme.properties</code>.<br>并修改js和css的路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">standard.custom.css.file=/css/nebula.css</span><br><span class="line">cas.javascript.file=/js/cas.js</span><br></pre></td></tr></table></figure></p><p><code>/WEB-INF/view/jsp</code>下新增文件夹nebula/ui，将<code>/WEB-INF/view/jsp/default/ui</code>下的<code>casLoginView.jsp</code>，<code>casGenericSuccessView.jsp</code>，<code>includes</code>复制到<code>/nebula/ui</code>，并重命名为<code>nebulaLoginView.jsp</code>和<code>nebulaIndexView.jsp</code>.  </p><p>将<code>/WEB-INF/view/jsp/nebula/ui/nebulaLoginView.jsp</code>中无关的东西都删除，只保留登录的form相关，这个可以慢慢删除调试。<code>nebulaIndexView</code>是登录成功后显示的页面,内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; isELIgnored=&quot;false&quot; %&gt;</span><br><span class="line">&lt;div&gt;你好，你在CAS Server已登录成功！&lt;a href=&quot;logout&quot;&gt;退出&lt;/a&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure></p><p><code>/WEB-INF/webflow/login</code>下复制<code>login-webflow.xml</code>，并重命名为<code>nebula-login-webflow.xml</code>。<br>将<code>viewLoginForm</code>中的<code>casLoginView</code>修改为<code>nebulaLoginView</code>.<br>将<code>viewGenericLoginSuccess</code>中的view改为<code>nebulaIndexView</code>.<br><code>/WEB-INF/webflow/login</code>下复制<code>logout-webflow.xml</code>，并重命名为<code>nebula-logout-webflow.xml</code>。</p><p>修改<code>/WEB-INF/cas.properties</code>，将<code>cas.themeResolver.defaultThemeName</code>改成<code>nebula-theme</code>.</p><p><code>/WEB-INF/cas-servlet.xml</code>文件修改：</p><ol><li>viewResolver中<code>cas_views</code>改成<code>nebula_views</code>.</li><li>internalViewResolver中defaultViewsPathPrefix改成<code>/WEB-INF/view/jsp/nebula/ui/</code>.</li><li>loginFlowRegistry中，将value改成：<code>/login/nebula-login-webflow.xml</code>.</li><li>logoutFlowRegistry中，将value改成：<code>/logout/nebula-logout-webflow.xml</code>.</li></ol><p>最后的效果：<br>登录的界面：<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/43145484-file_1495081069165_1b8b.png" alt=""></p><p>登录成功的界面：<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/5600562-file_1495081103378_e8fa.png" alt=""></p><h2 id="问题："><a href="#问题：" class="headerlink" title="问题："></a>问题：</h2><p>1、  CAS做了国际化，不过默认是英文的，如果想使用中文显示，可以<code>/WEB-INF/classes</code>下<code>messages.properties</code>重命名为<code>messages_en.properties</code>。同时，将<code>messages_zh_CN.properties</code>重命名为<code>messages.properties</code>.  </p><p>2、  页面显示乱码的问题。<br>在JSP页面中增加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; isELIgnored=&quot;false&quot; %&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      
        <tags>
            
            <tag> 单点登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CAS使用</title>
      <link href="/2017/08/30/CAS-use/"/>
      <url>/2017/08/30/CAS-use/</url>
      
        <content type="html"><![CDATA[<p>CAS的官方网址是： <a href="https://www.apereo.org/projects/cas">https://www.apereo.org/projects/cas</a><br>工程代码网址：<a href="https://github.com/Jasig/cas">https://github.com/Jasig/cas</a></p><p>使用参考：<a href="http://www.imooc.com/article/3576">http://www.imooc.com/article/3576</a></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>1.未认证授权的服务<br>不允许使用CAS来认证您访问的目标应用。<br>解决办法：在/cas-server/WEB-INF/classes/services/HTTPSandIMAPS-10000001.json文件中添加对Http的支持。默认只支持https/imaps.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> &quot;@class&quot; : &quot;org.jasig.cas.services.RegexRegisteredService&quot;,</span><br><span class="line">&quot;serviceId&quot; : &quot;^(http|https|imaps)://.*&quot;,</span><br></pre></td></tr></table></figure></p><a id="more"></a>]]></content>
      
      
      
        <tags>
            
            <tag> 单点登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cas多系统集成统一认证</title>
      <link href="/2017/08/30/cas-multi-system/"/>
      <url>/2017/08/30/cas-multi-system/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="http://blog.csdn.net/lifetragedy/article/details/43817903">http://blog.csdn.net/lifetragedy/article/details/43817903</a>  </p><p>这里有2个ssoclient工程，代码一样，只是端口不一样。<br>一个端口为8080，一个为8888，cas server的端口为8899.<br>ssoclient使用的springmvc+spring.<br>拿其中一个ssoclient的代码说明。<br><a id="more"></a></p><p>maven依赖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"> &lt;properties&gt;</span><br><span class="line">    &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;</span><br><span class="line">    &lt;spring.version&gt;4.3.1.RELEASE&lt;/spring.version&gt;</span><br><span class="line">    &lt;jackson.version&gt;2.5.0&lt;/jackson.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.jasig.cas.client&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;cas-client-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.3.3&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-beans&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-context&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-tx&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-webmvc&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.17&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;servlet-api&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.0-alpha-1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;$&#123;jackson.version&#125;&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-io&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-io&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.4&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;commons-fileupload&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-fileupload&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;1.2.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure></p><p>spring-core.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">            http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">            http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">            http://www.springframework.org/schema/context/spring-context-4.1.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--自动扫描含有@Service将其注入为bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.tommy"</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>spring-mvc.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">"http://www.springframework.org/schema/mvc"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span> <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context-4.1.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc-4.1.xsd"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 自动扫描controller包下的所有类，如果@Controller注入为bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.tommy.sso.controller"</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 避免IE执行AJAX时,返回JSON出现下载文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"mappingJacksonHttpMessageConverter"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"supportedMediaTypes"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>text/html;charset=UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 启动Spring MVC的注解功能，完成请求和注解POJO的映射 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.mvc.annotation.AnnotationMethodHandlerAdapter"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"messageConverters"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- json转换器 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"mappingJacksonHttpMessageConverter"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 对模型视图名称的解析，即在模型视图名称添加前后缀 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span></span></span><br><span class="line"><span class="tag">            <span class="attr">class</span>=<span class="string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"viewClass"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">value</span>=<span class="string">"org.springframework.web.servlet.view.JstlView"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"prefix"</span> <span class="attr">value</span>=<span class="string">"/views"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suffix"</span> <span class="attr">value</span>=<span class="string">".jsp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置多文件上传 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"multipartResolver"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">class</span>=<span class="string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"defaultEncoding"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxUploadSize"</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 上传文件大小限制为31M，31*1024*1024 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>32505856<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxInMemorySize"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>4096<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>web.xml:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns</span>=<span class="string">"http://java.sun.com/xml/ns/javaee"</span> <span class="attr">xmlns:web</span>=<span class="string">"http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span> <span class="attr">id</span>=<span class="string">"WebApp_ID"</span> <span class="attr">version</span>=<span class="string">"2.5"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>cas-sample-site2<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>index.htm<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>default.html<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>default.htm<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>default.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:spring-core.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 防止spring内存溢出监听器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.util.IntrospectorCleanupListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutHttpSessionListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.session.SingleSignOutFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Single Sign Out Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.validation.Cas20ProxyReceivingTicketValidationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerUrlPrefix<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.cas.com:8899/cas/<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.ssoclient.com:8080/<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>useSession<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>redirectAfterValidation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Validation Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.authentication.AuthenticationFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>casServerLoginUrl<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.cas.com:8899/cas/login<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>serverName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>http://www.ssoclient.com:8080/<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.jasig.cas.client.util.HttpServletRequestWrapperFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CAS HttpServletRequest Wrapper Filter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>spring mvc servlet<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>rest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span></span><br><span class="line">                /WEB-INF/spring-mvc.xml</span><br><span class="line">            <span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>rest<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：web.xml中cas相关的listener和filter的顺序，不一致可能导致登录或退出有问题。</p><p>IndexController.java:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/5/17.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/index.do"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">showIndex</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;</span><br><span class="line">        Principal principal = request.getUserPrincipal();</span><br><span class="line">        request.getSession().setAttribute(<span class="string">"user"</span>, principal.getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"/index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>/view/index.jsp:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">"text/html;charset=UTF-8"</span> isELIgnored=<span class="string">"false"</span> %&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"c"</span></span><br><span class="line">           uri=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">$&#123;user&#125;, 你好啊！ &lt;a href="http://www.ssoclient.com:8888/ssoclient/index.do"&gt;访问ssoclient1&lt;/a&gt;&amp;nbsp;&lt;a href="http://www.cas.com:8899/cas/logout"&gt;登出&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>这里2个ssoclient工程在不同的tomcat中，分别部署后。  </p><ol><li>访问<a href="http://www.ssoclient.com:8888/ssoclient/index.do会跳转到cas">http://www.ssoclient.com:8888/ssoclient/index.do会跳转到cas</a> server的登录页面。<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/52917568-file_1495099508879_161ad.png" alt=""></li><li>访问<a href="http://www.ssoclient.com:8080/ssoclient/index.do会跳转到cas">http://www.ssoclient.com:8080/ssoclient/index.do会跳转到cas</a> server的登录页面。<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/92646017-file_1495099544929_1b13.png" alt=""></li><li>在任意一个ssoclient执行登录操作（比如8888的ssoclient），登录成功后。<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/45254271-file_1495099609491_fb58.png" alt=""><br>访问8080的ssoclient<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/56403892-file_1495099653530_8450.png" alt=""><br>会发现直接就可以访问，达到登录一个系统，其他系统不用再登录的目的。</li></ol><ol start="4"><li>在任意一个ssoclient执行退出操作（比如8888的ssoclient），执行后。<br>8888的ssoclient<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/94496574-file_1495099764188_a0f3.png" alt=""><br>刷新8080的ssoclient<br><img src="http://omh46px9n.bkt.clouddn.com/17-5-18/92646017-file_1495099544929_1b13.png" alt=""><br>会发现会跳转到cas server的登录页面。达到任意一个系统退出，其他系统自动退出的目的。</li></ol><p>注意：<br>如果有client的工程与cas server部署在一个tomcat，这个client是不会因为另外一个client执行logout而退出的。<br>注意浏览器缓存，退出操作。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 单点登录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Aop+注解实现日志记录</title>
      <link href="/2017/08/30/SpringAop-autowire-log/"/>
      <url>/2017/08/30/SpringAop-autowire-log/</url>
      
        <content type="html"><![CDATA[<p>系统业务操作日志记录是每个系统必不可少的一部分，但通常的做法是在每个需要记录日志的地方，调用添加日志的Service方法，这样做主要是显的麻烦。<br>我们可以使用Spring AOP结合注解来实现这一功能。</p><p>1、首先定义一个注解类，如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(value = ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SysLog &#123;</span><br><span class="line">    <span class="function">String <span class="title">module</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    <span class="function">String <span class="title">desc</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>注解类有2个属性，module是操作的模块，desc为具体记录的日志信息。<br><a id="more"></a><br>2、定义切面类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.reflect.MethodSignature;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2017/6/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(LogAspect.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timeStart;</span><br><span class="line">    <span class="meta">@Before</span>(value = <span class="string">"execution(* aop.service..*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doBefore</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        timeStart = System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After</span>(value = <span class="string">"execution(* aop.service..*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfter</span><span class="params">(JoinPoint joinPoint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> timeEnd = System.currentTimeMillis();</span><br><span class="line">        logger.info(<span class="string">"方法："</span> + joinPoint.getTarget().getClass().getSimpleName()+<span class="string">"."</span>+joinPoint.getSignature().getName() + <span class="string">"执行结束。耗时："</span> + (timeEnd-timeStart)+<span class="string">"ms."</span>);</span><br><span class="line">        Method proxyMethod = ((MethodSignature)(joinPoint.getSignature())).getMethod();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Method sourceMethod = joinPoint.getTarget().getClass().getMethod(proxyMethod.getName(), proxyMethod.getParameterTypes());</span><br><span class="line">            SysLog sysLog = sourceMethod.getAnnotation(SysLog.class);</span><br><span class="line">            <span class="keyword">if</span> (sysLog != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String <span class="keyword">module</span> = sysLog.<span class="keyword">module</span>();</span><br><span class="line">                String desc = sysLog.desc();</span><br><span class="line">                <span class="comment">// 这里获取登陆用户信息</span></span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 1.获取request信息</span></span><br><span class="line"><span class="comment">                 * 2.根据request获取session</span></span><br><span class="line"><span class="comment">                 * 3.从session中取出登录用户信息</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                RequestAttributes ra = RequestContextHolder.getRequestAttributes();</span><br><span class="line">                ServletRequestAttributes sra = (ServletRequestAttributes)ra;</span><br><span class="line">                HttpServletRequest request = sra.getRequest();</span><br><span class="line">                HttpSession session = request.getSession();</span><br><span class="line">                <span class="comment">// 从session中获取用户信息</span></span><br><span class="line">                String loginInfo = (String) session.getAttribute(<span class="string">"username"</span>);</span><br><span class="line">                String username = <span class="string">"admin"</span>;</span><br><span class="line">                logger.info(username + <span class="string">"在["</span> + <span class="keyword">module</span> + <span class="string">"]"</span> + desc);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3、spring配置文件加入：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aspectEventLog"</span> <span class="attr">class</span>=<span class="string">"aop.LogAspect"</span> /&gt;</span></span><br></pre></td></tr></table></figure></p><p>4、maven依赖：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjrt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>$&#123;spring.groupId&#125;<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>5、测试service：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="keyword">module</span> = SysConstant.MODULE_USER_MGR,desc = <span class="string">"添加用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"执行了test()方法,username="</span> + username);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep((<span class="keyword">long</span>) (Math.random()*<span class="number">3000L</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>执行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行了test()方法</span><br><span class="line">12:39:30,355  INFO main aop.LogAspect:33 - 方法：TestService.test执行结束。耗时：1601ms.</span><br><span class="line">12:39:30,356  INFO main aop.LogAspect:44 - admin在[系统管理]添加用户</span><br></pre></td></tr></table></figure></p><p>最后说明一下，这种事没法很具体的，比如某个人添加了某个用户，这种级别做不到。<br>上面拿到httpservletrequest后当然可以拿到所有的请求参数，如果要更具体，就需要在每个请求上携带特定的参数。  </p><p>比如用户AA添加了用户BB，BB就得放到固定名字的参数中。如果不用注解，就是把模块名和具体的日志信息都放到request中，在切面中从request获取，不过这样就比较麻烦了。  </p><p>如果只是需要具体到模块，并记录IP之类的，上面的就可以满足了。</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线接口文档管理工具（小幺鸡）使用说明</title>
      <link href="/2017/08/30/%E5%9C%A8%E7%BA%BF%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%EF%BC%88%E5%B0%8F%E5%B9%BA%E9%B8%A1%EF%BC%89%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/"/>
      <url>/2017/08/30/%E5%9C%A8%E7%BA%BF%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%EF%BC%88%E5%B0%8F%E5%B9%BA%E9%B8%A1%EF%BC%89%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E/</url>
      
        <content type="html"><![CDATA[<p>小幺鸡的地址：<a href="http://www.xiaoyaoji.cn/">http://www.xiaoyaoji.cn/</a>  </p><p>几大看点：  </p><ol><li>在线接口测试；</li><li>可视化编辑与分享；</li><li>代码开源。可以离线部署。  </li></ol><p>下面简单介绍下怎么离线安装与使用。  </p><h3 id="1-下载与安装"><a href="#1-下载与安装" class="headerlink" title="1.下载与安装"></a>1.下载与安装</h3><p>代码在：<a href="http://git.oschina.net/zhoujingjie/apiManager">http://git.oschina.net/zhoujingjie/apiManager</a>  </p><ol><li>从<a href="http://git.oschina.net/zhoujingjie/apiManager/releases下载最新版本。">http://git.oschina.net/zhoujingjie/apiManager/releases下载最新版本。</a></li><li>解压到tomcat_home/webapps/ROOT目录下</li><li>新建MYSQL数据库-编码格式utf8mb4格式，INNODB引擎。</li><li>导入sql - SQL文件在doc目录下</li><li>修改tomcat_home/webapps/ROOT/WEB-INF/classes/config.properties 的数据库与其他信息</li><li>启动tomcat，使用chrome浏览器访问<a href="http://localhost:8080">http://localhost:8080</a><a id="more"></a></li></ol><h3 id="2-基本使用"><a href="#2-基本使用" class="headerlink" title="2.基本使用"></a>2.基本使用</h3><p>在tomcat中运行起来后，点击首页中的“立即使用”按钮。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/29365450.jpg" alt=""><br>这个时候会跳转到登陆页面，没有账号就点一下“免费注册”注册一个账号，然后登陆。  </p><p>登陆进去后，首先创建一个项目。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/11709858.jpg" alt=""></p><p>默认有一个文档，我们点击重命名<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/77459662.jpg" alt="">改成文档说明。  </p><p>这个就是接口文档的一个简要介绍。示例：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/64636534.jpg" alt=""></p><p>假如现在要添加一个用户登录的接口，那第一步先创建一个文件夹（用户信息接口）<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/88335243.jpg" alt=""></p><p>然后在这个文件夹下面创建一个http接口：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/31634409.jpg" alt=""></p><p>示例：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/85928458.jpg" alt=""></p><p>然后点一下右上角的保存，然后点预览文档看下效果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/43464966.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/21915942.jpg" alt=""><br>在下面填入相关参数，点“立即运行”就可以调试接口了。</p><h3 id="3-多环境支持"><a href="#3-多环境支持" class="headerlink" title="3.多环境支持"></a>3.多环境支持</h3><p>不同的环境，接口的地址不同。我们可以在全局设置中添加环境变量。<br>进入某个项目后，点击上面的“编辑文档”，然后点“全局设置”，然后点“环境变量”。<br>比如这里配置了2个不同的host和port<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/36878765.jpg" alt=""></p><p>在接口地址中，使用$变量名$就可以了。<br>比如：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/99731849.jpg" alt=""></p><p>在演示的地方，可以切换不同的环境：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/99272332.jpg" alt=""></p><p>问题：</p><ol><li>提示跨域错误<br> 解决参考：<a href="http://www.xiaoyaoji.cn/help.html">http://www.xiaoyaoji.cn/help.html</a></li></ol><p>注：这里的版本为xiaoyaoji-2.0.1.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线接口文档管理工具（小幺鸡）使用说明</title>
      <link href="/2017/08/30/api-docs-xiaoyaoji/"/>
      <url>/2017/08/30/api-docs-xiaoyaoji/</url>
      
        <content type="html"><![CDATA[<p>小幺鸡的地址：<a href="http://www.xiaoyaoji.cn/">http://www.xiaoyaoji.cn/</a>  </p><p>几大看点：  </p><ol><li>在线接口测试；</li><li>可视化编辑与分享；</li><li>代码开源。可以离线部署。  </li></ol><p>下面简单介绍下怎么离线安装与使用。  </p><h3 id="1-下载与安装"><a href="#1-下载与安装" class="headerlink" title="1.下载与安装"></a>1.下载与安装</h3><p>代码在：<a href="http://git.oschina.net/zhoujingjie/apiManager">http://git.oschina.net/zhoujingjie/apiManager</a>  </p><ol><li>从<a href="http://git.oschina.net/zhoujingjie/apiManager/releases下载最新版本。">http://git.oschina.net/zhoujingjie/apiManager/releases下载最新版本。</a></li><li>解压到tomcat_home/webapps/ROOT目录下</li><li>新建MYSQL数据库-编码格式utf8mb4格式，INNODB引擎。</li><li>导入sql - SQL文件在doc目录下</li><li>修改tomcat_home/webapps/ROOT/WEB-INF/classes/config.properties 的数据库与其他信息</li><li>启动tomcat，使用chrome浏览器访问<a href="http://localhost:8080">http://localhost:8080</a><a id="more"></a></li></ol><h3 id="2-基本使用"><a href="#2-基本使用" class="headerlink" title="2.基本使用"></a>2.基本使用</h3><p>在tomcat中运行起来后，点击首页中的“立即使用”按钮。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/29365450.jpg" alt=""><br>这个时候会跳转到登陆页面，没有账号就点一下“免费注册”注册一个账号，然后登陆。  </p><p>登陆进去后，首先创建一个项目。<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/11709858.jpg" alt=""></p><p>默认有一个文档，我们点击重命名<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/77459662.jpg" alt="">改成文档说明。  </p><p>这个就是接口文档的一个简要介绍。示例：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/64636534.jpg" alt=""></p><p>假如现在要添加一个用户登录的接口，那第一步先创建一个文件夹（用户信息接口）<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/88335243.jpg" alt=""></p><p>然后在这个文件夹下面创建一个http接口：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/31634409.jpg" alt=""></p><p>示例：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/85928458.jpg" alt=""></p><p>然后点一下右上角的保存，然后点预览文档看下效果：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/43464966.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/21915942.jpg" alt=""><br>在下面填入相关参数，点“立即运行”就可以调试接口了。</p><h3 id="3-多环境支持"><a href="#3-多环境支持" class="headerlink" title="3.多环境支持"></a>3.多环境支持</h3><p>不同的环境，接口的地址不同。我们可以在全局设置中添加环境变量。<br>进入某个项目后，点击上面的“编辑文档”，然后点“全局设置”，然后点“环境变量”。<br>比如这里配置了2个不同的host和port<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/36878765.jpg" alt=""></p><p>在接口地址中，使用$变量名$就可以了。<br>比如：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/99731849.jpg" alt=""></p><p>在演示的地方，可以切换不同的环境：<br><img src="http://omh46px9n.bkt.clouddn.com/17-7-19/99272332.jpg" alt=""></p><p>问题：</p><ol><li>提示跨域错误<br> 解决参考：<a href="http://www.xiaoyaoji.cn/help.html">http://www.xiaoyaoji.cn/help.html</a></li></ol><p>注：这里的版本为xiaoyaoji-2.0.1.</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 项目管理 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录密码思路</title>
      <link href="/2017/08/30/remember-password/"/>
      <url>/2017/08/30/remember-password/</url>
      
        <content type="html"><![CDATA[<p>通常记住密码之后的作用就是用户此次会话失效后，下次登录网站用户直接处于会话活动状态，不必输入用户名密码重新登录，一个很好的用户体验但是处理不好也会存在用户信息泄露的问题。</p><p>1、建一张表用来存储md5(username+md5(user_agent))，这个值也就是存储在客户端cookie中的。</p><p>表结构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`j_user_tokens`</span> (  </span><br><span class="line"><span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,  </span><br><span class="line"><span class="string">`user_id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,  </span><br><span class="line"><span class="string">`user_agent`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,  <span class="comment">--user_agent MD5值  </span></span><br><span class="line"><span class="string">`token`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,  <span class="comment">--md5(username+md5(user_agent))  `type` varchar(100) DEFAULT NULL,  </span></span><br><span class="line"><span class="string">`created`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,  </span><br><span class="line"><span class="string">`expires`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>, <span class="comment">--过期时间，也就是记住密码多久  PRIMARY KEY (`id`),  </span></span><br><span class="line"><span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uniq_token`</span> (<span class="string">`token`</span>),  </span><br><span class="line"><span class="keyword">KEY</span> <span class="string">`fk_user_id`</span> (<span class="string">`user_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br></pre></td></tr></table></figure></p><p>2、用户在某次选择”记住密码“登录时，在登录成功后将目前的信息作为一条新纪录都写入到j_user_tokens中，同时也要将token值写入到cookie名为autologin中。<br><a id="more"></a><br>3、用户关闭浏览器或此次session会话失效后；用户再次访问网站时，网站检测获取当前用户对象时首先在session中找寻，其次会进入记住密码机制查找；那么服务器获取到autologin值以及user_agent的值在j_user_tokens中检索匹配，如找到记录则检测是否已过期，过期则提示登录，未过期则获取user_id从而得到user对象，如未匹配到记录则直接提示登录。</p><p>这样的处理好处就是，避免将用户个人信息写入到不安全的cookie中去，不必采用username+password进行验证的方式。</p><p>注意：<br>这种存储方式避免了存储用户名和密码等关键信息到cookie，但如果获取了用户的cookie，并且使用和用户浏览器一样的userAgent来提交，会导致验证通过。</p><p>用户在登录界面选择了“记住密码”，那么登录成功后，关闭浏览器，后续在有效期内再次进入系统无需登录；如果用户在登录系统后，选择了退出系统，则后面再次进入系统需要登录；修改密码，也需要再次登录。</p><p>目前的这种设计仍然需要考虑cookie被劫持的情况</p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 架构设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ajax请求遇到session失效问题</title>
      <link href="/2017/08/30/Ajax-session/"/>
      <url>/2017/08/30/Ajax-session/</url>
      
        <content type="html"><![CDATA[<p>现在很多菜单的内容都是通过Ajax加载来呈现的，那么如果遇到session失效，该证明处理呢？</p><p>其实方法不难，Ajax请求的请求头X-Requested-With的值为XMLHttpRequest。后台通过request获取到这个请求头，就知道是普通的http请求还是Ajax请求。如果是Ajax请求，那么可以添加一个响应头，然后页面上Ajax完成时，获取请求头，判断做相应处理就可以了。<br><a id="more"></a></p><p>后端：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ajax请求，session超时处理。添加header，页面Ajax设置全局complete处理方法，如果发现请求头包含session timeout，则跳转到登陆页面</span></span><br><span class="line">String requestType = httpRequest.getHeader(<span class="string">"X-Requested-With"</span>);</span><br><span class="line"><span class="keyword">if</span>(StringUtils.isNotBlank(requestType) &amp;&amp; requestType.equalsIgnoreCase(<span class="string">"XMLHttpRequest"</span>))&#123;</span><br><span class="line">    httpResponse.setHeader(<span class="string">"sessionstatus"</span>, <span class="string">"timeout"</span>);</span><br><span class="line">    httpResponse.sendError(<span class="number">518</span>, <span class="string">"session timeout."</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 普通http请求，直接跳转到登陆页面</span></span><br><span class="line">((HttpServletResponse) servletResponse).sendRedirect(((HttpServletRequest) servletRequest).getContextPath() + <span class="string">"/user/toLogin"</span>);</span><br><span class="line">如上面的代码，在Ajax请求时，添加一个响应头sessionstatus，值为timeout。</span><br></pre></td></tr></table></figure></p><p>前端：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 设置未来(全局)的AJAX请求默认选项</span></span><br><span class="line"><span class="comment">* 主要设置了AJAX请求遇到Session过期的情况</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">$.ajaxSetup(&#123;</span><br><span class="line">     type: <span class="string">'POST'</span>,</span><br><span class="line">     complete: <span class="function"><span class="keyword">function</span>(<span class="params">xhr,status</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">var</span> sessionStatus = xhr.getResponseHeader(<span class="string">'sessionstatus'</span>);</span><br><span class="line">     <span class="keyword">if</span>(sessionStatus == <span class="string">'timeout'</span>) &#123;</span><br><span class="line">        layer.confirm(<span class="string">'由于您长时间没有操作, session已过期, 请重新登录.'</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="built_in">window</span>.location.href = <span class="string">"$&#123;ctx&#125;/"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>百度云盘下载提速</title>
      <link href="/2017/08/30/baiduyun-speedup/"/>
      <url>/2017/08/30/baiduyun-speedup/</url>
      
        <content type="html"><![CDATA[<p>正常情况下，在百度云盘下载文件速度只有几百KB，这是因为百度对下载速度做了限制。<br>如何突破百度的速度限制呢？</p><p>这里使用一款名为Internet Download Manager的软件来实现。<br>百度搜索下载，安装（如果你安装了chrome浏览器，会自动给你安装插件）。<br>安装后打开IDM，会提示你在chrome浏览器的扩展程序里面把IDM的文件访问权限和隐藏模式运行打开。<br>然后重启浏览器，进入pan.baidu.com，下载一个比较大的文件，这是IDM会自动检测到要下载的文件链接，然后点开始下载就可以了。<br><a id="more"></a><br>如下图，可以看到速度是3.5M/s。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/49857232.jpg" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>导入铃声到IPhone</title>
      <link href="/2017/08/30/import-sings-to-iPhone/"/>
      <url>/2017/08/30/import-sings-to-iPhone/</url>
      
        <content type="html"><![CDATA[<p>导入到iPhone的铃声格式是m4r，且40s内。<br>所以如果是其他格式的音乐文件，需要先转成m4r格式。</p><p>1，使用酷狗音乐的制作铃声功能建音乐件裁剪成40s内。<br>2，通过itools将铃声转换并导入iPhone。<br><a id="more"></a></p>]]></content>
      
      
      <categories>
          
          <category> 人文 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 工具 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用hexo+github搭建个人博客</title>
      <link href="/2017/08/26/hexo-github-personal-blog/"/>
      <url>/2017/08/26/hexo-github-personal-blog/</url>
      
        <content type="html"><![CDATA[<p>hexo+github搭建个人博客</p><p>参考：<br><a href="http://www.cnblogs.com/dantefung/p/d8c48ba8030bcab7cfc364d423186fee.html">http://www.cnblogs.com/dantefung/p/d8c48ba8030bcab7cfc364d423186fee.html</a>  </p><h3 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h3><p>问题1：执行npm install时或安装hexo时很久没反应。<br>解决：<br>受网络影响建议安装cnpm（淘宝团队建立的中国镜像）<br>npm install cnpm -g –registry=<a href="https://registry.npm.taobao.org">https://registry.npm.taobao.org</a><br>后面可以使用cnpm来替代npm.<br><a id="more"></a><br>错误2：fatal: could not read Username for ‘<a href="https://github.com&#39;">https://github.com&#39;</a>: No error<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-26/25091116.jpg" alt=""><br>解决：<br>修改_config.yml中的部署配置：<br><!--more--><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Deployment</span><br><span class="line">## Docs: https://hexo.io/docs/deployment.html</span><br><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: git@github.com:luckystar88/luckystar88.github.io.git</span><br></pre></td></tr></table></figure></p><p>错误3：Please make sure you have the correct access rights<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-26/18925.jpg" alt=""><br>解决：<br>参考：<a href="http://blog.csdn.net/u014343528/article/details/48787221">http://blog.csdn.net/u014343528/article/details/48787221</a><br>在git Bash中，输入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;username&quot; (注：username为你git上的用户名)</span><br></pre></td></tr></table></figure></p><p>后面一直回车，直到结束。  </p><p>参考：<br><a href="http://blog.csdn.net/binyao02123202/article/details/20130891">http://blog.csdn.net/binyao02123202/article/details/20130891</a><br>打开生成的id_rsa.pub文件，复制公钥到github的ssh key。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-26/43905479.jpg" alt=""><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-26/71412724.jpg" alt=""></p><p>配置完毕后，使用下面的命令测试一下SSH Key<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -T git@github.com</span><br></pre></td></tr></table></figure></p><p>后面你使用<code>hexo d</code>直接就提交到github仓库中了。</p><h3 id="更多配置"><a href="#更多配置" class="headerlink" title="更多配置"></a>更多配置</h3><p>hexo站点域名配置：<a href="http://www.cnblogs.com/penglei-it/p/hexo_domain_name.html">http://www.cnblogs.com/penglei-it/p/hexo_domain_name.html</a></p><p>hexo提交搜索引起：<a href="http://www.cnblogs.com/tengj/p/5357879.html">http://www.cnblogs.com/tengj/p/5357879.html</a></p><p>hexo主题next优化： <a href="http://blog.csdn.net/mynamelijun/article/details/52196184">http://blog.csdn.net/mynamelijun/article/details/52196184</a></p><p>Hexo添加不蒜子和LeanCloud统计无标题文章:<a href="http://www.jianshu.com/p/702a7aec4d00">http://www.jianshu.com/p/702a7aec4d00</a><br>注意：LeanCloud中Web安全域名要配置正确，否则可能会导致403禁止访问。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/20074557.jpg" alt=""><br>next主题使用帮助：<a href="http://theme-next.iissnan.com/getting-started.html">http://theme-next.iissnan.com/getting-started.html</a></p><h3 id="加入站点内容搜索功能"><a href="#加入站点内容搜索功能" class="headerlink" title="加入站点内容搜索功能:"></a>加入站点内容搜索功能:</h3><p>本站点使用的是Local Search。加入站点内容搜索功能步骤如下：</p><p>安装hexo-generator-searchdb<br>$ npm install hexo-generator-searchdb –save<br>注意：安装时应在站点根目录下</p><p>然后将next主题配置文件中的搜索enable设置为true即可。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/45453439.jpg" alt=""></p><h3 id="使用友言评论"><a href="#使用友言评论" class="headerlink" title="使用友言评论"></a>使用友言评论</h3><p>友言官网：<a href="http://www.uyan.cc/">http://www.uyan.cc/</a><br>进入官网，注册，登陆，获取代码。你需要记下来的是代码中uid=”***”的值，等下要用到。这一步很简单。 </p><p>修改主题中的youyan_uid为上面的uid即可。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/77606245.jpg" alt=""></p><h3 id="加入百度统计"><a href="#加入百度统计" class="headerlink" title="加入百度统计"></a>加入百度统计</h3><p>到<a href="https://tongji.baidu.com注册，并添加域名后，复制代码中的问号后面的一串id。">https://tongji.baidu.com注册，并添加域名后，复制代码中的问号后面的一串id。</a><br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/72231015.jpg" alt=""></p><p>修改主题中的baidu_analytics为上面复制的id。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-30/1936862.jpg" alt=""></p><h3 id="菜单与logo设置"><a href="#菜单与logo设置" class="headerlink" title="菜单与logo设置"></a>菜单与logo设置</h3><p>在next主题的_config.yml中，找到menu:配置<br>菜单项的配置：<code>技术: /categories/tech || th-list</code><br>冒号前是菜单项的名字，||前是路径，后面是logo。logo的名字可以在<a href="http://fontawesome.dashgame.com/查看。">http://fontawesome.dashgame.com/查看。</a></p><h3 id="将博客文章、配置与主题设置备份到osc"><a href="#将博客文章、配置与主题设置备份到osc" class="headerlink" title="将博客文章、配置与主题设置备份到osc"></a>将博客文章、配置与主题设置备份到osc</h3><p>我的博客文章发布在github，备份在osc。<br>这里说一下怎么将博客文章、配置与主题备份到osc。<br>在博客目录执行<code>git init</code>命令初始化博客与git关联。<br>在博客跟目录执行<code>git remote add origin https://xxx.git</code>(osc上的git路径)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git pull origin master // 拉取更新</span><br><span class="line">git add . // 添加本地文件</span><br><span class="line">git commit // 提交到本地</span><br><span class="line">git push origin master // 提交到远程分支</span><br></pre></td></tr></table></figure></p><p>但是，这个时候发现主题没有提交上去。<br>到hexo-theme-next中查看已经存在.git文件夹，删除它。<br>（如果你直接在hexo-theme-next执行<code>git add /git commit</code>会提示<code>modified:   hexo-theme-next (modified content, untracked content)</code>）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git rm -rf --cached themes/hexo-theme-next/</span><br><span class="line">git add themes/hexo-theme-next/*</span><br><span class="line">git commit</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure></p><p>搞定。</p><p>后面添加新的文章，只需要在博客根目录执行下面的命令即可：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &apos;注释信息&apos;</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure></p><p>参考：<a href="http://www.cnblogs.com/wanqieddy/p/4210767.html">http://www.cnblogs.com/wanqieddy/p/4210767.html</a><br><a href="http://www.cnblogs.com/super-d2/p/3341864.html">http://www.cnblogs.com/super-d2/p/3341864.html</a></p><h3 id="写文章用到的图片处理"><a href="#写文章用到的图片处理" class="headerlink" title="写文章用到的图片处理"></a>写文章用到的图片处理</h3><p>使用markdown写文章有一个问题就是图片只支持链接，不能粘贴。我这里使用的是“极简图床”提供的服务，支持上传图片、拖拽、粘贴图片，可以生成外链地址，并可以直接以markdown复制。<br>我这里绑定了七牛云，可以使用10G的免费空间。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/8149063.jpg" alt=""></p><h3 id="Hexo博客收录百度、谷歌、360-基于Next主题"><a href="#Hexo博客收录百度、谷歌、360-基于Next主题" class="headerlink" title="Hexo博客收录百度、谷歌、360-基于Next主题"></a>Hexo博客收录百度、谷歌、360-基于Next主题</h3><p>分别注册，并添加站点。选择“HTML标签验证”，然后复制<meta/>标签的content内容。<br>在next主题的配置文件中，添加<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/5077441.jpg" alt=""><br>然后使用hexo g,hexo d重新生成文章，并发布。然后在百度/谷歌/360的站长平台点击“验证”。</p><h3 id="去掉底部的“由Hexo强力驱动”"><a href="#去掉底部的“由Hexo强力驱动”" class="headerlink" title="去掉底部的“由Hexo强力驱动”"></a>去掉底部的“由Hexo强力驱动”</h3><p><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/5696103.jpg" alt=""><br>修改\themes\hexo-theme-next\layout_partials\footer.swig，去掉文件最后下面截图中的部分。<br><img src="http://omh46px9n.bkt.clouddn.com/17-8-31/18041034.jpg" alt=""></p><h3 id="博客首页文章只显示摘要部分"><a href="#博客首页文章只显示摘要部分" class="headerlink" title="博客首页文章只显示摘要部分"></a>博客首页文章只显示摘要部分</h3><p>默认首页显示5篇文章，且显示的是全部的内容，导致首页内容太多。<br>解决方法有2种：<br>1.在next主题的_config.yml文件中，找到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">auto_excerpt:</span><br><span class="line">  enable: false</span><br><span class="line">  length: 150</span><br></pre></td></tr></table></figure></p><p>将enable改成true，length即为摘要显示的长度。<br>不过这样有个缺陷，会导致本来该一起显示的内容可能会被分开。</p><p>2.文章中使用<code>&lt;!-- more --&gt;</code><br>可以在文章显示摘要结束的部分增加<code>&lt;!-- more --&gt;</code>来标识。<code>&lt;!-- more --&gt;</code>之前的内容即为要显示的摘要部分。</p><p>Next中推荐的是第2种，这样可以自主控制摘要部分。</p><h3 id="github-pages开启https支持"><a href="#github-pages开启https支持" class="headerlink" title="github pages开启https支持"></a>github pages开启https支持</h3><p>参考：<a href="https://likfe.com/2018/05/03/github-pages-custom-domains-support-https/">https://likfe.com/2018/05/03/github-pages-custom-domains-support-https/</a></p><h2 id="使用hexo-theme-bubuzou主题"><a href="#使用hexo-theme-bubuzou主题" class="headerlink" title="使用hexo-theme-bubuzou主题"></a>使用hexo-theme-bubuzou主题</h2><p>目前在用的主题是hexo-theme-bubuzou，使用比较简单，使用参考<a href="https://github.com/Bulandent/hexo-theme-bubuzou">https://github.com/Bulandent/hexo-theme-bubuzou</a>。<br>更新于2017.11</p><h3 id="使用hexo-s命令不成功"><a href="#使用hexo-s命令不成功" class="headerlink" title="使用hexo s命令不成功"></a>使用hexo s命令不成功</h3><p>提示如下：<br><img src="/img/hexo_command_error.png" alt=""><br>但是hexo g命令是成功的。</p><p>PS：需要执行<code>npm install hexo-server --save</code>，然后再执行hexo s即可。</p><p>可能还缺少其他的组件，使用<code>npm audit fix</code>来查看缺少的组件，然后依次安装。<br><img src="/img/npm_audit_fix.png" alt=""></p>]]></content>
      
      
      <categories>
          
          <category> 技术 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
